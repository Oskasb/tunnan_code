/*
 * Copyright (c) 2012 Brandon Jones
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

define("application/EventList",[],function(){var e=function(){};return{LOAD_PROGRESS:{type:"LOAD_PROGRESS",eArgs:{started:0,completed:0,errors:0,id:""}},LOADING_COMPLETED:{type:"LOADING_COMPLETED",eArgs:{started:0,completed:0,errors:0}},LOAD_3D:{type:"LOAD_3D",eArgs:{}},UN_LOAD_3D:{type:"UN_LOAD_3D",eArgs:{callback:e}},GOO_TICK:{type:"GOO_TICK",eArgs:{tpf:0}},LOAD_JSON:{type:"LOAD_JSON",eArgs:{callback:function(){},url:""}},LOAD_GOO_PROJECT:{type:"LOAD_GOO_PROJECT",eArgs:{callback:function(){},folder:"",projectPath:"",entityIds:[]}},LOAD_UI_TEMPLATE:{type:"LOAD_UI_TEMPLATE",eArgs:{templateId:"",callback:e}},UNLOAD_UI_TEMPLATE:{type:"UNLOAD_UI_TEMPLATE",eArgs:{templateId:"",callback:e}},CLIENT_SETUP_OK:{type:"CLIENT_SETUP_OK",eArgs:{}},REGISTER_SPRITE:{type:"REGISTER_SPRITE",eArgs:{elementId:""}},GOT_GAME_CONFIGURATION:{type:"GOT_GAME_CONFIGURATION",eArgs:{gameConfig:{}}},MENU_NAVIGATE:{type:"MENU_NAVIGATE",eArgs:{destination:"",elementId:""}},RENDER_TICK:{type:"RENDER_TICK",eArgs:{frameTime:0,lastFrameDuration:0}},POST_UPDATE:{type:"POST_UPDATE",eArgs:{}},WINDOW_RESIZED:{type:"WINDOW_RESIZED",eArgs:{}},SEQUENCE_CALLBACK:{type:"SEQUENCE_CALLBACK",eArgs:{callback:function(){},wait:0}},ANALYTICS_EVENT:{type:"ANALYTICS_EVENT",eArgs:{category:"",action:"",labels:"",value:0}},SET_ELEMENT_TEXT:{type:"SET_ELEMENT_TEXT",eArgs:{elementId:"",data:{},propertyId:""}},LAYOUT_LINES:{type:"LAYOUT_LINES",eArgs:{elementId:"",data:{}}},LAYOUT_RADIO_BUTTONS:{type:"LAYOUT_RADIO_BUTTONS",eArgs:{elementId:"",data:{},property:"",onClick:function(){}}},SET_SETTING_INDEX:{type:"SET_SETTING_INDEX",eArgs:{elementId:"",settingId:"",properties:{}}},ENABLE_SETTING_VALUE:{type:"ENABLE_SETTING_VALUE",eArgs:{settingId:"",values:{}}},REGISTER_SETTING:{type:"REGISTER_SETTING",eArgs:{elementId:"",settingId:"",properties:{}}},PAUSE_UPDATES:{type:"PAUSE_UPDATES",eArgs:{}},UNPAUSE_UPDATES:{type:"UNPAUSE_UPDATES",eArgs:{}},FETCH_TIME:{type:"FETCH_TIME",eArgs:{callback:function(){}}},CLIENT_READY:{type:"CLIENT_READY",eArgs:{}},ENINGE_READY:{type:"ENINGE_READY",eArgs:{goo:{}}},LOADING_ENDED:{type:"LOADING_ENDED",eArgs:{}},RESTART_GAME_BOARD:{type:"RESTART_GAME_BOARD",eArgs:{}},OPEN_UI_PAGE:{type:"OPEN_UI_PAGE",eArgs:{page:"",parentId:""}},CLOSE_OVERLAY:{type:"CLOSE_OVERLAY",eArgs:{elementId:""}},TEST_EVENT:{type:"TEST_EVENT",eArgs:{msg:""}},START_POINTER_DRAG:{type:"START_POINTER_DRAG",eArgs:{xy:[]}},STOP_POINTER_DRAG:{type:"STOP_POINTER_DRAG",eArgs:{xy:[]}},START_CAMERA_DRAG:{type:"START_CAMERA_DRAG",eArgs:{xy:[]}},STOP_CAMERA_DRAG:{type:"STOP_CAMERA_DRAG",eArgs:{}},FETCH_DRAG_DELTA:{type:"FETCH_DRAG_DELTA",eArgs:{callback:function(){},xy:[]}},CLEAR_ALL_VALUE_ELEMENTS:{type:"CLEAR_ALL_VALUE_ELEMENTS",eArgs:{}},REGISTER_STATE_LIGHT:{type:"REGISTER_STATE_LIGHT",eArgs:{elementId:"",control:""}},REGISTER_STATE_LEVER:{type:"REGISTER_STATE_LEVER",eArgs:{elementId:"",control:""}},REGISTER_STATE_VALUE:{type:"REGISTER_STATE_VALUE",eArgs:{elementId:"",value:""}},REGISTER_STATE_LEVER_TARGET:{type:"REGISTER_STATE_LEVER_TARGET",eArgs:{elementId:"",control:""}},REGISTER_STATE_AXIS:{type:"REGISTER_STATE_AXIS",eArgs:{elementId:"",control:"",axis:""}},PLAYER_VALUE_UPDATE:{type:"PLAYER_VALUE_UPDATE",eArgs:{value:"",amount:0}},STICK_INPUT:{type:"STICK_INPUT",eArgs:{xy:[]}},MOUSE_ACTION:{type:"MOUSE_ACTION",eArgs:{action:[],xy:[]}},MOUSE_WHEEL_UPDATE:{type:"MOUSE_WHEEL_UPDATE",eArgs:{delta:0}},MOUSE_POSITION_UPDATE:{type:"MOUSE_POSITION_UPDATE",eArgs:{xy:[]}},ADD_KEYBINDINGS:{type:"ADD_KEYBINDINGS",eArgs:{bindings:{}}},CLEAR_KEYBINDINGS:{type:"CLEAR_KEYBINDINGS",eArgs:{bindings:{}}},UPDATE_KEYBINDING:{type:"UPDATE_KEYBINDING",eArgs:{control:"",value:0}},POP_SPHERE:{type:"POP_SPHERE",eArgs:{}},USE_NEAREST_ENTITY:{type:"USE_NEAREST_ENTITY",eArgs:{}},EXIT_CONTROLLED_ENTITY:{type:"EXIT_CONTROLLED_ENTITY",eArgs:{callback:e}},PILOT_VEHICLE:{type:"PILOT_VEHICLE",eArgs:{pilot:{},vehicle:{},callback:e}},SET_PLAYER_CONTROLLED_ENTITY:{type:"SET_PLAYER_CONTROLLED_ENTITY",eArgs:{entity:[],callback:e}},PLAYER_MOVE_TO_POINT:{type:"PLAYER_MOVE_TO_POINT",eArgs:{pos:[]}},PLAYER_MOVEMENT_INPUT:{type:"PLAYER_MOVEMENT_INPUT",eArgs:{movestate:"",turnSpeed:0}},PLAYER_CONTROL_EVENT:{type:"PLAYER_CONTROL_EVENT",eArgs:{control:"",value:0}},SETTING_CONTROL_EVENT:{type:"SETTING_CONTROL_EVENT",eArgs:{setting:"",value:0}},INIT_PLAYER_CONTROL_STATE:{type:"INIT_PLAYER_CONTROL_STATE",eArgs:{control:"",controlState:0}},PLAYER_CONTROL_STATE_UPDATE:{type:"PLAYER_CONTROL_STATE_UPDATE",eArgs:{control:"",currentState:0}},SET_CAMERA_TARGET:{type:"SET_CAMERA_TARGET",eArgs:{spatial:{},geometry:{},controlScript:""}},SET_CAMERA_ANALOGS:{type:"SET_CAMERA_ANALOGS",eArgs:{rotX:0,rotY:0,rotZ:0}},SPAWN_PHYSICAL:{type:"SPAWN_PHYSICAL",eArgs:{pos:[],callback:function(){}}},UPDATE_ENTITY_SPATIAL:{type:"UPDATE_PLAYER_SPATIAL",eArgs:{entityId:"",spatial:{}}},START_SCENARIO_ID:{type:"START_SCENARIO_ID",eArgs:{scenarioId:""}},SCENARIO_SELECTED:{type:"SCENARIO_SELECTED",eArgs:{scenario:{}}},SCENARIO_LOADED:{type:"SCENARIO_LOADED",eArgs:{callback:e}},EXIT_SCENARIO:{type:"EXIT_SCENARIO",eArgs:{}},ADD_GAME_ENTITY:{type:"ADD_GAME_ENTITY",eArgs:{entityId:"",type:"",callback:function(){}}},FETCH_LEVEL_ENTITY:{type:"FETCH_LEVEL_ENTITY",eArgs:{entityId:"",type:"",pos:[],callback:function(){}}},DAMAGE_ENTITY:{type:"DAMAGE_ENTITY",eArgs:{entity:{},damage:0}},REMOVE_GAME_ENTITY:{type:"REMOVE_GAME_ENTITY",eArgs:{entityId:"",callback:function(){}}},LOAD_GOO_MESH:{type:"LOAD_GOO_MESH",eArgs:{modelUrl:"",callback:function(){}}},LOAD_GOO_SKELETON:{type:"LOAD_GOO_SKELETON",eArgs:{skeletonUrl:"",callback:function(){}}},LOAD_GOO_MATERIAL:{type:"LOAD_GOO_MATERIAL",eArgs:{materialUrl:"",callback:function(){}}},LOAD_GOO_TEXTURE:{type:"LOAD_GOO_TEXTURE",eArgs:{textureUrl:"",callback:function(){}}},LOAD_GOO_SHADER:{type:"LOAD_GOO_SHADER",eArgs:{shaderFiles:{},shaderId:"",callback:function(){}}},REGISTER_GOO_MESH:{type:"REGISTER_GOO_MESH",eArgs:{url:"",mesh:""}},REGISTER_GOO_SKELETON:{type:"REGISTER_GOO_SKELETON",eArgs:{url:"",skeleton:""}},REGISTER_GOO_MATERIAL:{type:"REGISTER_GOO_MATERIAL",eArgs:{url:"",material:""}},REGISTER_GOO_TEXTURE:{type:"REGISTER_GOO_TEXTURE",eArgs:{url:"",texture:{}}},REGISTER_GOO_SHADER:{type:"REGISTER_GOO_SHADER",eArgs:{shaderId:"",type:"",data:""}},BUILD_GOO_GAMEPIECE:{type:"BUILD_GOO_GAMEPIECE",eArgs:{projPath:"",modelPath:"",callback:function(){}}},BUILD_GOO_PRIMITIVE:{type:"BUILD_GOO_PRIMITIVE",eArgs:{parentGooEntity:{},shape:"",pos:{},rot:{},size:{},color:[],callback:function(){}}},BUILD_GOO_PARTICLES:{type:"BUILD_GOO_PARTICLES",eArgs:{parentGooEntity:{},systemParams:{},emitFunctions:{},callback:function(){}}},SET_ENVIRONMENT:{type:"SET_ENVIRONMENT",eArgs:{fogColor:[],sunLight:[],ambientLight:[],sunDir:[],skyColor:[],fogDistance:[]}},SET_EFFECT_PARAMETER:{type:"SET_EFFECT_PARAMETER",eArgs:{effect:"",parameter:"",value:0}},SPLASH_WATER:{type:"SPLASH_WATER",eArgs:{pos:[],count:0,dir:[]}},FLASH_SHOCKWAVE:{type:"FLASH_SHOCKWAVE",eArgs:{pos:[],count:0,dir:[]}},FLASH_SPARKS:{type:"FLASH_SPARKS",eArgs:{pos:[],count:0,dir:[]}},PUFF_BLACK_SMOKE:{type:"PUFF_BLACK_SMOKE",eArgs:{pos:[],count:0,dir:[]}},PUFF_WHITE_SMOKE:{type:"PUFF_WHITE_SMOKE",eArgs:{pos:[],count:0,dir:[]}},PUFF_SMALL_WHITE:{type:"PUFF_SMALL_WHITE",eArgs:{pos:[],count:0,dir:[]}},PUFF_RAPID_WHITE:{type:"PUFF_RAPID_WHITE",eArgs:{pos:[],count:0,dir:[]}},PUFF_CLOUD_VAPOR:{type:"PUFF_CLOUD_VAPOR",eArgs:{pos:[],count:0,dir:[]}},ACROBATIC_SMOKE:{type:"ACROBATIC_SMOKE",eArgs:{pos:[],count:0,dir:[]}},FLASH_MUZZLE_FIRE:{type:"FLASH_MUZZLE_FIRE",eArgs:{pos:[],count:0,dir:[]}},SPLASH_RINGLET:{type:"SPLASH_RINGLET",eArgs:{pos:[],count:0,dir:[]}},SPLASH_FOAM:{type:"SPLASH_FOAM",eArgs:{pos:[],count:0,dir:[]}},LOAD_MODEL_URL:{type:"LOAD_MODEL_URL",eArgs:{modelUrl:"",callback:function(){}}},ACTIVATE_GOO_ENTITY:{type:"ACTIVATE_GOO_ENTITY",eArgs:{gooEntity:{},gameEntity:{}}},REGISTER_ACTIVE_ENTITY:{type:"REGISTER_ACTIVE_ENTITY",eArgs:{entity:{}}},UPDATE_ACTIVE_ENTITIES:{type:"UPDATE_ACTIVE_ENTITIES",eArgs:{frameTime:0}},UPDATE_GAMEPIECE_EFFECTS:{type:"UPDATE_GAMEPIECE_EFFECTS",eArgs:{tpf:0}},UPDATE_ENVIRONMENT:{type:"UPDATE_ENVIRONMENT",eArgs:{envVars:{}}},SPAWN_CLOUDS:{type:"SPAWN_CLOUDS",eArgs:{pos:[],size:[],intensity:0}},SLIDE_OVERLAY_UP:{type:"SLIDE_OVERLAY_UP",eArgs:{elementId:""}},SLIDE_OVERLAY_IN:{type:"SLIDE_OVERLAY_IN",eArgs:{elementId:""}},FETCH_SOUND:{type:"FETCH_SOUND",eArgs:{soundData:{},callback:e}},FETCH_BUFFER:{type:"FETCH_BUFFER",eArgs:{soundData:{},callback:e}},STOP_SOUND:{type:"STOP_SOUND",eArgs:{playId:""}},ONESHOT_SOUND:{type:"ONESHOT_SOUND",eArgs:{soundData:{}}},START_SOUND_LOOP:{type:"START_SOUND_LOOP",eArgs:{soundData:{},loopId:"",callback:function(){}}},STOP_SOUND_LOOP:{type:"STOP_SOUND_LOOP",eArgs:{loopId:""}},SEND_SOUND_TO_REVERB:{type:"SEND_SOUND_TO_REVERB",eArgs:{node:{}}},SEND_SOUND_TO_LISTENER:{type:"SEND_SOUND_TO_LISTENER",eArgs:{node:{}}},SEND_SOUND_TO_MASTER:{type:"SEND_SOUND_TO_MASTER",eArgs:{node:{}}},SEND_SOUND_TO_DESTINATION:{type:"SEND_SOUND_TO_DESTINATION",eArgs:{node:{}}},MOVE_AUDIO_LISTENER:{type:"MOVE_AUDIO_LISTENER",eArgs:{pos:[],rot:[],vel:[]}},REGISTER_AUDIO_CONTEXT:{type:"REGISTER_AUDIO_CONTEXT",eArgs:{context:{},model:""}},MIX_CHANNEL_VALUE:{type:"MIX_CHANNEL_VALUE",eArgs:{channelId:"",valueId:"",amount:0}},ONESHOT_AMBIENT_SOUND:{type:"ONESHOT_AMBIENT_SOUND",eArgs:{soundData:{},pos:[],vel:[],dir:[]}},LOOP_AMBIENT_SOUND:{type:"LOOP_AMBIENT_SOUND",eArgs:{soundData:{},playId:"",callback:e}},UPDATE_FEEDBACK_VALUE:{type:"UPDATE_FEEDBACK_VALUE",eArgs:{elementId:"",number:0,text:""}},BROADCAST_VIDEO:{type:"BROADCAST_VIDEO",eArgs:{source:"",channel:""}},PLAY_PARTICLE:{type:"PLAY_PARTICLE",eArgs:{effectType:"",duration:0}},CONFIGURE_CONTROLLER:{type:"CONFIGURE_CONTROLLER",eArgs:{controllerType:""}},OCULUS_RIFT_QUATERNION:{type:"OCULUS_RIFT_QUATERNION",eArgs:{quat:{}}}}}),define("game/GameConfiguration",[],function(){return{GAME_IDENTITY:{title:"Tunnan & Friends",tagLine:"Early test version for you to fly"},WORLD_PROPERTIES:{gravity:[0,-9.81,0],newton:9.81,speedOfSound:340.29},PLAYER_INIT:{startSpatial:{pos:[342,18.2,2880],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0]},landingStrip:{pos:[2861,15,2388]},approach:{pos:[650,620,1e3]},stratosphere:{pos:[-1050,35690,3e3]},battle:{pos:[2750,820,2310]}},AERODYNAMICS:{airMassDensity:1.229,densityPerMeter:8e-5,kelvinsAtSeaLevel:288,kelvinDropByMeterUp:.0065,seaLevelPressure:1.01,gasConstant:8.3,airMolarMass:.0289644},RENDER_SETUP:{targetFPS:60,physicsFPS:100},GAME_SETTINGS:{soundDisable:{values:[0,1],loadIndex:1}},INTRO:{containerId:"intro",stages:[{id:"intro_1",time:2e3},{id:"intro_2",time:1e3},{id:"intro_3",time:1e3}]},MIX_TRACKS:{game:{id:"Game",spatial:!0,settingGain:"sound_game",settingFxSend:"sound_fx_game"},ambient:{id:"Ambient",spatial:!1,settingGain:"sound_ambient",settingFxSend:"sound_fx_ambient"},ui:{id:"UI",spatial:!1,settingGain:"sound_ui",settingFxSend:"sound_fx_ui"},music:{id:"Music",spatial:!1,settingGain:"sound_music",settingFxSend:"sound_fx_music"}},PRELOAD_IMAGES:[],PRELOAD_GOO_MATERIALS:{},PRELOAD_GOO_MESHES:{},GOO_PROJECTS:{tunnan:{folder:"tunnan_f",projectPath:"bundles",entityIds:{tunnan:"tunnan_f"}},human:{folder:"pilot_animated",projectPath:"bundles",entityIds:{pilot:"pilot_bind_AO"}},tomcat:{folder:"tomcat",projectPath:"bundles",entityIds:{tomcat_skinned:"TomcatSkinned"}},environment:{folder:"environment",projectPath:"bundles",entityIds:{skybox:"Default Environment",effects:"Post effects"}},carrier:{folder:"carrier",projectPath:"bundles",entityIds:{carrier:"carrier"}},car_pv_9031:{refFile:"pv_9031.bundle",projectPath:"bundles",pv_9031:"pv_9031"},cougar_f9f:{refFile:"cougar_f9f.bundle",projectPath:"bundles",cougar_f9f:"cougar_f9f"},stratofortress:{refFile:"stratofortress.bundle",projectPath:"bundles",b_52:"b_52"},draken:{refFile:"draken.bundle",projectPath:"bundles",draken:"draken"},tre_kronor:{refFile:"tre_kronor.bundle",projectPath:"bundles",tre_kronor:"tre_kronor"},battleship:{refFile:"battleship.bundle",projectPath:"bundles",battleship:"battleship_skinned"},nature:{folder:"nature",projectPath:"bundles",entityIds:{tree_leafy:"tree_leafy_30m",tree_40:"tree_leafy_40m",tree_leafy_small:"tree_leafy_small",rock_mossy:"rock_mossy",rock_plain:"rock_plain",rock_tiny:"rock_tiny"}},houses:{refFile:"houses.bundle",projectPath:"bundles",hangar_building:"hangar_building",seventeen_big_floors:"17_big_floors",seventeen_floor:"17_floors",ten_floors:"10_floors",cube_22:"cube_22",air_tower:"air_tower",cottage:"cottage"},targets:{refFile:"targets.bundle",projectPath:"bundles",ground_flat:"ground_flat",house_box_3:"house_box_3"},house_t:{refFile:"house_T.bundle",projectPath:"bundles",house_t:"house_T"},air_base:{refFile:"air_base.bundle",projectPath:"bundles",base:"base",roof:"roof",lockers:"lockers",lamps:"lamps"},hilltop_base:{refFile:"hilltop_base.bundle",projectPath:"bundles",base:"hilltop_base",roof:"hilltop_roof",lamps:"hilltop_lights",lamps_inner:"hilltop_lights_inner"},harbor:{refFile:"harbor.bundle",projectPath:"bundles",base:"harbor_base"},elevator:{refFile:"elevator.bundle",projectPath:"bundles",base:"elevator_base",roof:"elevator_roof"},top_base:{refFile:"top_base.bundle",projectPath:"bundles",base:"top_base",roof:"top_base_roof"},tv_screen:{refFile:"tv_monitors.bundle",projectPath:"bundles",tv:"tv_crt",tv_2:"tv_2",tv_3:"tv_3"},monitor_console:{refFile:"monitor_console.bundle",projectPath:"bundles",monitor_console:"monitor_console"},armaments:{refFile:"armaments.bundle",projectPath:"bundles",bomb_200kg:"bomb_200kg",rocket_7cm:"rocket_7cm",rocket_18cm:"rocket_18cm"},bullet_20:{refFile:"project.project",projectPath:"bullet_project",piecePath:"bullet_red"}},VIDEOS:{sources:{hsi:{funnyCat:"resources/video/funny_cat_352x240.mp4",cuteCat:"resources/video/cute_cat_320x240.mp4",angryCat:"resources/video/angry_cat_screams_at_enemy_cat_640x360.mp4"},vdi:{tunnanPromo:"resources/video/tunnan_short.mp4",marineAd:"resources/video/united_states_marine_corps_640x480.mp4",jetEngine:"resources/video/jet_engine_-_cinema_4d_animation_640x360.mp4"},hud:{memorial:"resources/video/the_collings_foundation_vietnam_memorial_flight.__f-4_phantom_a-4_skyhawk_uh-1_huey_480x240.mp4",dayTrap:"resources/video/day_trap_aboard_the_jfk_640x480.mp4",carrierOps:"resources/video/aircraft_carrier_operation_640x360.mp4"},cats:{funnyCat:"resources/video/funny_cat_352x240.mp4",cuteCat:"resources/video/cute_cat_320x240.mp4",angryCat:"resources/video/angry_cat_screams_at_enemy_cat_640x360.mp4"},promos:{tunnanPromo:"resources/video/tunnan_short.mp4",marineAd:"resources/video/united_states_marine_corps_640x480.mp4",jetEngine:"resources/video/jet_engine_-_cinema_4d_animation_640x360.mp4"},military:{memorial:"resources/video/the_collings_foundation_vietnam_memorial_flight.__f-4_phantom_a-4_skyhawk_uh-1_huey_480x240.mp4",dayTrap:"resources/video/day_trap_aboard_the_jfk_640x480.mp4",carrierOps:"resources/video/aircraft_carrier_operation_640x360.mp4"},history:{strangelove:"resources/video/dr._strangelove_-_ending_640x384.mp4",submarine:"resources/video/submarine_480x272.mp4",bomber:"bomber_480x270.mp4"},animals:{alaska:"resources/video/alaska_mammals_tour_640x350.mp4",frogYear:"resources/video/year_of_the_frog_campaign_568x320.mp4",unFrog:"resources/video/un_frog_640x272.mp4"},planes:{blackbird:"resources/video/sr-71_blackbird_-_the_worlds_fastest_and_highest_flying_aircraft_(jet)_-_youtube_640x480.mp4"},doge:{moonLaunch:"shopdoge.com-_dogecoin_moon_launch_hd__________much_trust_must_doge_640x358"}},channels:{vdi:"vdi",cats:"cats",animals:"animals",promos:"promos",military:"military",history:"history",planes:"planes"}},PRELOAD_GOO_TEXTURES:{splash_particle:"images/particles/splash.png",shockwave_particle:"images/particles/shockwave.png",fieldring_particle:"images/particles/fieldring.png",spark_particle:"images/particles/spark.png",dot_particle:"images/particles/dot.png",foam_particle:"images/particles/water_foam.png",smoke_particle:"images/particles/smoke.png"},PRELOAD_GOO_SHADERS:{},KEY_BINDINGS:{plane:{cannons:["1",32],throttleUp:["R",107],throttleDown:["F",109],pitchUp:["S",40],pitchDown:["W",38],rollLeft:["A",37],rollRight:["D",39],yawLeft:["Q"],yawRight:["E"],canopy:["C"],gears:["G"],breaksOn:["B"],breaksOff:["V"],flapsDown:["X"],flapsUp:["Z"],eject:["P"],trimPitchUp:["K"],trimPitchDown:["I"],trimRollLeft:["J"],trimRollRight:["L"],trimYawLeft:["U"],trimYawRight:["O"]},car:{breaksOn:["B","X"],breaksOff:["V","Q"],throttleUp:["W",107],throttleDown:["S",109],yawLeft:["A",37],yawRight:["D",39]},move:{forward:["W",38],back:["S",40],turnleft:["A",37],turnright:["D",39],strafeModifier:["-"],jump:[" ","E"]},carrier:{}}}}),define("sound/SoundList",["game/GameConfiguration"],function(e){var t=e.MIX_TRACKS;return{UI_HOVER:{folder:"ui",file:"blipp1",gain:.48,track:t.ui,options:{preload:!0}},UI_ACTIVE:{folder:"ui",file:"blipp2",gain:.46,track:t.ui,options:{preload:!0}},UI_CLICK:{folder:"ui",file:"blipp3",gain:.95,track:t.ui,options:{preload:!0}},UI_OUT:{folder:"ui",file:"blipp4",gain:.25,track:t.ui,options:{preload:!0}},SEATOWN_AMB:{folder:"ambient",file:"seatown_birds",gain:1.45,track:t.game,options:{preload:!0}},DARK_SUSPENS:{folder:"ambient",file:"dark_suspens",gain:.85,track:t.game,options:{preload:!0}},CANNON_20_0:{folder:"shots",file:"cannon_0",gain:1.11,track:t.game,options:{preload:!0,refDist:18,rolloff:1.1}},CANNON_20_1:{folder:"shots",file:"cannon_1",gain:1.11,track:t.game,options:{preload:!0,refDist:18,rolloff:1.1}},CANNON_20_2:{folder:"shots",file:"cannon_2",gain:1.11,track:t.game,options:{preload:!0,refDist:18,rolloff:1.1}},CANNON_20_3:{folder:"shots",file:"cannon_3",gain:1.11,track:t.game,options:{preload:!0,refDist:18,rolloff:1.1}},MAIN_GUN_0:{folder:"shots",file:"main_gun_1",gain:.68,track:t.game,options:{preload:!0,refDist:39,rolloff:.3}},MAIN_GUN_1:{folder:"shots",file:"main_gun_2",gain:.78,track:t.game,options:{preload:!0,refDist:39,rolloff:.3}},MAIN_GUN_2:{folder:"shots",file:"main_gun_3",gain:.98,track:t.game,options:{preload:!0,refDist:39,rolloff:.3}},AAA_0:{folder:"shots",file:"aaa_1",gain:.38,track:t.game,options:{preload:!0,refDist:26,rolloff:.5}},AAA_1:{folder:"shots",file:"aaa_2",gain:.54,track:t.game,options:{preload:!0,refDist:26,rolloff:.5}},AAA_2:{folder:"shots",file:"aaa_3",gain:.68,track:t.game,options:{preload:!0,refDist:26,rolloff:.5}},BULLET_HIT_0:{folder:"hits",file:"cannon_hit_0",gain:.55,track:t.game,options:{preload:!0,refDist:15,rolloff:.1}},BULLET_HIT_1:{folder:"hits",file:"cannon_hit_1",gain:.55,track:t.game,options:{preload:!0,refDist:15,rolloff:.1}},BULLET_HIT_2:{folder:"hits",file:"cannon_hit_2",gain:.55,track:t.game,options:{preload:!0,refDist:25,rolloff:.3}},BULLET_HIT_3:{folder:"hits",file:"cannon_hit_3",gain:.55,track:t.game,options:{preload:!0,refDist:45,rolloff:.5}},MAIN_HIT_0:{folder:"hits",file:"main_hit_0",gain:.58,track:t.game,options:{preload:!0,refDist:36,rolloff:.6}},MAIN_HIT_1:{folder:"hits",file:"main_hit_1",gain:.74,track:t.game,options:{preload:!0,refDist:36,rolloff:.6}},MAIN_HIT_2:{folder:"hits",file:"main_hit_2",gain:.98,track:t.game,options:{preload:!0,refDist:36,rolloff:.6}},AAA_HIT_0:{folder:"hits",file:"aaa_hit_0",gain:.22,track:t.game,options:{preload:!0,refDist:26,rolloff:.6}},AAA_HIT_1:{folder:"hits",file:"aaa_hit_1",gain:.32,track:t.game,options:{preload:!0,refDist:26,rolloff:.6}},AAA_HIT_2:{folder:"hits",file:"aaa_hit_2",gain:.42,track:t.game,options:{preload:!0,refDist:26,rolloff:.6}},SPLASH_0:{folder:"water",file:"splash_0",gain:.41,track:t.game,options:{preload:!0,refDist:6,rolloff:.1}},SPLASH_1:{folder:"water",file:"splash_1",gain:.41,track:t.game,options:{preload:!0,refDist:9,rolloff:.2}},SPLASH_2:{folder:"water",file:"splash_2",gain:.41,track:t.game,options:{preload:!0,refDist:18,rolloff:.4}},SPLASH_3:{folder:"water",file:"splash_3",gain:.41,track:t.game,options:{preload:!0,refDist:26,rolloff:.6}},ENGINE_START:{folder:"jet",file:"jet_start",gain:.5,track:t.game,options:{preload:!0,refDist:32,rolloff:.6}},ENGINE_STOP:{folder:"jet",file:"jetbase_start",gain:1,track:t.game,options:{preload:!0,refDist:22,rolloff:.2}},ENGINE_ON:{folder:"jet",file:"jet_idle",gain:1,track:t.game,options:{preload:!0,refDist:22,rolloff:.3}},ENGINE_GAS:{folder:"jet",file:"jet_wide",gain:1,track:t.game,options:{preload:!0,refDist:12,rolloff:.2}},ENGINE_TONE:{folder:"jet",file:"base_quint",gain:1,track:t.game,options:{preload:!0,refDist:32,rolloff:.7}},STEP_ROAD_1:{folder:"steps",file:"road_step_1",gain:5.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},STEP_ROAD_2:{folder:"steps",file:"road_step_2",gain:5.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},STEP_ROAD_3:{folder:"steps",file:"road_step_3",gain:5.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},STEP_ROAD_4:{folder:"steps",file:"road_step_4",gain:5.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},STEP_GRAVEL_1:{folder:"steps",file:"gravel_step_1",gain:10.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},STEP_GRAVEL_2:{folder:"steps",file:"gravel_step_2",gain:10.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},STEP_GRAVEL_3:{folder:"steps",file:"gravel_step_3",gain:10.46,track:t.ambient,options:{preload:!1,refDist:4,rolloff:.84}},FOUNTAIN_LOOP:{folder:"water",file:"fountain",gain:1,track:t.game,options:{preload:!1,refDist:4,rolloff:.44}},FX_VERB:{folder:"fx",file:"AmbMix",gain:1,track:t.ambient,options:{preload:!0,refDist:4,rolloff:.04}}}}),define("application/EventManager",["application/EventList","sound/SoundList"],function(e,t){var n=document.createElement("div"),r={},i=function(e){this.name="EventArgumentException",this.message=e};i.prototype=Error.prototype;var s=function(){return e},o=function(){return t};2;var u=function(e,t){e||console.log("NO EVENT",e);for(index in t)if(typeof e.eArgs[index]!=typeof t[index])throw new i("Invalid event arguments, "+e.type+" does not match type for supplied argument: "+index)},a=function(e,t){return u(e,t),new CustomEvent(e.type,{detail:{arguments:t},bubbles:!1,cancelable:!1})},f=function(e){return e.detail.arguments},l=function(e,t){n.dispatchEvent(a(e,t))},c=function(e,t){r[e.type]=t,n.addEventListener(e.type,t)},h=function(e){n.removeEventListener(e.type,r[e.type],null),delete r[e.type]},p=function(e){alert("test msg:"+f(e).msg)};return{removeListener:h,registerListener:c,eventArgs:f,fireEvent:l,list:s,sound:o}});var _gaq=_gaq||[];define("application/AnalyticsWrapper",["application/EventManager"],function(e){var t=0,n={count:0,controls:{}},r=function(e,t,n,r){if(r==undefined)return;console.log("TRACK:",[e,t,n,r]),_gaq.push(["_trackEvent",e,t,n,r])},i=function(i){var s=e.eventArgs(i);if(s.value==undefined)return;if(s.value!=1)return;n.count+=1,n.controls[s.control]||(n.controls[s.control]=0),n.controls[s.control]+=1,n.count>=20&&(t+=1,r("PLAYER_CONTROL",JSON.stringify(n.controls),""+t,n.count),n={count:0,controls:{}})},s=function(t){var n=t.type,i=e.eventArgs(t),s="";for(var o in i)s+=o+" "+i[o]+" ";r("USER ACTION",n,s,1)},o=function(t){var n=e.eventArgs(t);r(n.category,n.action,n.labels,n.value)};e.registerListener(e.list().ANALYTICS_EVENT,o),e.registerListener(e.list().LOADING_COMPLETED,s),e.registerListener(e.list().PLAYER_CONTROL_EVENT,i)}),define("goo/entities/Bus",[],function(){function e(){this.trie={name:"",listeners:[],children:new Map}}function t(e,t){var n=e.indexOf(t);n!==-1&&(e[n]=null)}return e.prototype.emit=function(e,t,n){n=!!n,typeof e=="string"&&(e=[e]);for(var r=0;r<e.length;r++)this._emitToSingle(e[r],t,n);return this},e.prototype.getLastMessageOn=function(e){var t=this._getNode(e);if(t)return t.latestData},e.prototype._getNode=function(e,t){var n=this.trie,r=e.split(".");for(var i=0;i<r.length;i++){var s=r[i];if(n.children.has(s))n=n.children.get(s);else{if(!t)return;var o={listeners:[],children:new Map};n.children.set(s,o),n=o}}return n},e.prototype._emitToSingle=function(e,t,n){var r=this._getNode(e,n);r&&(this._emitToAll(r,t),n&&(r.latestData=t))},e.prototype._emitToAll=function(e,t){for(var n=0;n<e.listeners.length;n++){var r=e.listeners[n];r?r(t):(e.listeners.splice(n,1),n--)}e.children.forEach(function(e){this._emitToAll(e,t)}.bind(this))},e.prototype.addListener=function(e,t,n){n=!!n;var r=this.trie,i=e.split(".");for(var s=0;s<i.length;s++){var o=i[s];if(r.children.has(o))r=r.children.get(o);else{var u={listeners:[],children:new Map};r.children.set(o,u),r=u}}return r.listeners.indexOf(t)===-1&&(r.listeners.push(t),n&&r.latestData&&t(r.latestData)),this},e.prototype.removeListener=function(e,n){var r=this._getNode(e);return r&&t(r.listeners,n),this},e.prototype.removeAllOnChannel=function(e){var t=this._getNode(e);return t&&(t.listeners=[]),this},e.prototype.removeChannelAndChildren=function(e){var t=e.split(".");if(t.length>1){var n=t.pop(),r=t.join("."),i=this._getNode(r);i.children.delete(n)}else this.trie.children.delete(e);return this},e.prototype._removeListener=function(e,n){t(e.listeners,n),e.children.forEach(function(e){this._removeListener(e,n)}.bind(this))},e.prototype.removeListenerFromAllChannels=function(e){return this._removeListener(this.trie,e),this},e.prototype.clear=function(){this.trie={name:"",listeners:[],children:new Map}},e}),define("goo/entities/SystemBus",["goo/entities/Bus"],function(e){return new e}),define("io/Requests",{utils:{LOAD_TEMPLATE:"LOAD_TEMPLATE",LOAD_CONTEXT_SOUND:"LOAD_CONTEXT_SOUND",LOAD_JSON:"LOAD_JSON"},game:{GAME_INIT:"GAME_INIT"}}),define("io/Receive",["application/EventManager","io/Requests"],function(e,t){var n=function(e,t){if(!e)return;t.action&&s(JSON.parse(e),t),t.util&&i(e,t)},r=function(e){try{var t=JSON.parse(e)}catch(n){return!1}return t},i=function(e,n){switch(n.util){case t.utils.LOAD_JSON:n.responseCallback(r(e));break;case t.utils.LOAD_TEMPLATE:templateRepository.storeTemplate(e,n.params);break;case t.utils.LOAD_CONTEXT_SOUND:n.params.callback(n.params.sound,e);break;default:alert("Unhandled response from utility packet")}},s=function(n,r){switch(r.action){case t.game.GAME_INIT:e.fireEvent(e.list().GOT_GAME_CONFIGURATION,{gameConfig:n});break;default:alert("Unhandled game response from action packet")}};return{handleResponse:n}}),define("io/XhrWrapper",["io/Receive"],function(e){var t=0,n={},r=function(){return t+=1,"requestId_"+t},i=function(e,t,n){e.packetId=r(),s(e,t,n)},s=function(t,r,i){var s=t.packetId,o="",u=new XMLHttpRequest;u.packet=t;var a=!0;u.open(t.type,t.url,a),t.responseType&&(u.responseType=t.responseType),t.contentType=="application/json"&&(o=JSON.stringify(t.body),u.setRequestHeader("Content-Type",t.contentType)),t.contentType=="application/x-www-form-urlencoded"&&(o=t.params,u.setRequestHeader("Content-Type",t.contentType)),t.auth&&u.setRequestHeader("Authorization",t.auth.header),u.onreadystatechange=function(){u.readyState==4&&e.handleResponse(u.response,u.packet)},u.onError=function(){alert("XHR Error! "+u.packet.packetId)},u.send(o),n[s]=u};return{sendRequest:i}}),define("io/Send",["game/GameConfiguration","application/EventManager","io/Requests","io/XhrWrapper"],function(e,t,n,r){var i,s=function(e){i=e},o=function(){return i},u=function(){return n.game},a=function(e,t){var i=p(n.utils.LOAD_JSON,{url:e});i.responseCallback=t,r.sendRequest(i)},f=function(e,t){var n=p(e,t);r.sendRequest(n)},l=function(e,t){return"&"+e+"="+t},c=function(t,n){var i=h(t,n);if(!i)return;i.url=e.CONNECTION.configuration.url,r.sendRequest(i)},h=function(t,r){var i;switch(t){case n.game.GAME_BET:console.log("Send Data: ",r);var s=e.CONNECTION.serverMap.gameId+"="+e.CONNECTION.configuration.gameId;s+=l(e.CONNECTION.serverMap.authToken,e.CONNECTION.configuration.authToken),s+=l(e.CONNECTION.serverMap.actionName,e.CONNECTION.serverMap.spin),s+=l("betsize",""+r.betsize),s+=l("coinvalue",r.coinvalue),s+=l("sessionid",r.sessionId),i={type:"POST",contentType:"application/x-www-form-urlencoded",params:s};break;case n.game.GAME_INIT:var s=e.CONNECTION.serverMap.gameId+"="+e.CONNECTION.configuration.gameId;s+=l(e.CONNECTION.serverMap.authToken,e.CONNECTION.configuration.authToken),s+=l(e.CONNECTION.serverMap.actionName,e.CONNECTION.serverMap.launch),i={type:"POST",contentType:"application/x-www-form-urlencoded",params:s};break;case n.game.BET_CONFIRMED:var s=e.CONNECTION.serverMap.gameId+"="+e.CONNECTION.configuration.gameId;s+=l(e.CONNECTION.serverMap.authToken,e.CONNECTION.configuration.authToken),s+=l(e.CONNECTION.serverMap.actionName,e.CONNECTION.serverMap.confirm),s+=l("sessionid",s.sessionId),i={type:"POST",contentType:"application/x-www-form-urlencoded",params:s}}return i.action=t,i.params=s,i},p=function(e,t){var r=t.url;switch(e){case n.utils.LOAD_JSON:var i={responseType:"application/json",type:"GET",url:r};break;case n.utils.LOAD_TEMPLATE:var i={type:"GET",url:r};break;case n.utils.LOAD_CONTEXT_SOUND:var i={responseType:"arraybuffer",type:"GET",url:r}}return i.util=e,i.params=t,i},d=function(e){a(t.eventArgs(e).url,t.eventArgs(e).callback)};return t.registerListener(t.list().LOAD_JSON,d),{setRestParams:s,gameAction:u,gameRequest:c,utilRequest:f}}),define("sound/SourceFactory",["io/Requests","io/Send","application/EventManager"],function(e,t,n){var r=window.resourcePath+"sounds/",i,s,o,u=function(){return i},a=function(){if(!Audio in window)return alert("Browser does not support sounds."),"";var e=new Audio,t=!!e.canPlayType&&e.canPlayType("audio/ogg")!=="",n=!!e.canPlayType&&e.canPlayType("audio/mp3")!=="";return n&&(i="mp3"),t&&(i="ogg"),i||alert("Browser can not play the sounds needed for this game."),i},f=function(){var e=["AudioContext","webkitAudioContext","Audio"];for(var t=0;t<e.length;t++)if(e[t]in window)return s=e[t],s;return""},l=function(){i=a(),s=f();if(!s)return;if(s!="Audio")return o=new window[s],console.log("Audio Model: ",s,o),n.fireEvent(n.list().REGISTER_AUDIO_CONTEXT,{context:o,model:s}),typeof o.createGain!="function"&&(o.createGain=o.createGainNode),o;console.error("This browser does not support the Web Audio Api. Will run with limited sounds.")},c=function(e){var t=e,n=1,r=function(e){n=e},i=function(e){e.stop(0)},s=function(e){r(e)},u=function(){var e=o.createBufferSource();return e.buffer=t,e},a=function(e){var i=o.createGain();return e.buffer=t,e.connect(i),i.gain.value=n,r=function(e){i.gain.value=e},i},f=function(e,t){e.loop=t,e.start(0)};return{getSource:u,wire:a,play:f,pause:i,setGain:s}},h=function(e){var t=1,n=function(e){e.pause()},r=function(e){t=e},i=function(n){var r=e.cloneNode(!1);r.volume=t,r.loop=n,r.play();var i=function(){r=null};return r.addEventListener("pause",i,!1),r};return{play:i,pause:n,setGain:r}},p=function(n,r,i,s){var u=function(e,t){var n=function(){i(0,0,1,s),console.error("Decode Error: ",e,t)};o.decodeAudioData(t,function(t){e.source=new c(t),console.log("Sound Loaded: ",e,s,r,t),i(0,1,0,s)},n)};t.utilRequest(e.utils.LOAD_CONTEXT_SOUND,{url:r,sound:n,callback:u})},d=function(e,t,n){var r={play:function(){},setGain:function(){},pause:function(){}};e.source=r,t(0,1,0,n)},v=function(e,t,n){if(!s){d(e,t,n);return}var u=r+e.folder+"/"+e.file+"."+i;if(o){p(e,u,t,n);return}if(s=="Audio"){var a=new Audio([u]),f=function(){t(0,1,0,n)};a.addEventListener("canplaythrough",f,!1),e.source=h(a)}};return{runSourceFactoryConfig:l,addSourceToSound:v}}),define("load/TrackProgress",["application/EventManager"],function(e){var t=0,n=0,r=0,i=[],s=[],o=[],u=[],a,f,l,c,h=function(e){l=domUtils.getElementById("progress_label"),f=domUtils.getElementById("progress_bar"),a=domUtils.getElementById("file_feedback"),t=0,n=0,r=0,i=[],s=[],o=[],u=[],f.style.width="0%",domUtils.setElementHtml(l,"0%"),c=domUtils.getElementById("loading_screen"),domUtils.setElementHtml("load_title",e.title),domUtils.setElementHtml("load_tagline",e.tagLine),domUtils.quickShowElement(c)},p=function(){var t=function(){};e.fireEvent(e.list().LOADING_ENDED,{}),e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:t,wait:e.anim().LOAD_HIDE.time*800})},d=function(e,t){return 100*(t/e)},v=function(e,r,i,s){return;var o,c,h},m=function(){console.log("Track Progress - Loading Completed"),e.fireEvent(e.list().LOADING_COMPLETED,{started:t,completed:n,errors:r})},g=function(e,a,f,l){function h(){clearTimeout(c),c=setTimeout(function(){m()},100)}t+=e,n+=a,r+=f,l&&(e&&(i.push(l),u.push(l)),a&&(s.push(l),u.splice(u.indexOf(l),1)),f&&o.push(l)),v(t,n,r,l);var c;t==n+r&&h()},y=function(){return{started:t,finished:n,errors:r,remaining:u,load:i,done:s,error:o}},b=function(t){var n=e.eventArgs(t);g(n.started,n.completed,n.errors,n.id)};return e.registerListener(e.list().LOAD_PROGRESS,b),{showLoadingScreen:h,removeLoadingScreen:p,loadingProgress:g,getLoadedCount:y}}),define("sound/SoundLoader",["sound/SoundList","sound/SourceFactory","load/TrackProgress"],function(e,t,n){var r,i=function(e,t,r,i){n.loadingProgress(0,1,0,i)},s=function(){r=t.runSourceFactoryConfig()},o=function(){console.log("Load Sound List: ",e);for(var r in e){var s=function(e,t,n){n&&console.log("Sound Loading Error")};e[r].options.preload?(n.loadingProgress(1,0,0,e[r].file),s=i):console.log("Not preloading: ",e[r].file),t.addSourceToSound(e[r],s,e[r].file)}},u=function(){return r};return{initSoundSystem:s,loadSoundList:o,getPlayerContext:u}}),define("application/DeviceHandler",["application/EventManager"],function(e){function t(){var e=navigator.appName,t=navigator.userAgent,n,r=t.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return r&&(n=t.match(/version\/([\.\d]+)/i))!=null&&(r[2]=n[1]),r=r?[r[1],r[2]]:[e,navigator.appVersion,"-?"],r[0]}function n(){var e=navigator.appName,t=navigator.userAgent,n,r=t.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return r&&(n=t.match(/version\/([\.\d]+)/i))!=null&&(r[2]=n[1]),r=r?[r[1],r[2]]:[e,navigator.appVersion,"-?"],r[1]}function s(){if(t()=="Chrome")return!0;if(t()=="Firefox")return!1}var r=function(){window.scrollTo(0,0)},i=function(){document.ontouchmove=function(e){e.preventDefault()}};return{handleClientSetupDone:i,getBrowser:t,hasPowerSound:s,getVersion:n}}),define("application/Settings",["application/EventManager","goo/entities/SystemBus"],function(e,t){var n={zeroToOne:[[0,0],[1,1]],oneToZero:[[0,1],[1,0]],zeroToOneExp:[[0,0],[.25,.1],[.5,.25],[.75,.5],[1,1]],quickFadeOut:[[0,1],[.9,1],[1,0]],quickFadeIn:[[0,0],[.2,1],[1,1]],centerStep:[[0,0],[.45,0],[.55,1],[1,1]],quickInOut:[[0,0],[.1,1],[.9,1],[1,0]],posToNeg:[[0,1],[1,-1]],negToPos:[[0,-1],[1,1]],zeroOneZero:[[0,0],[.5,1],[1,0]],oneZeroOne:[[0,1],[.5,0],[1,1]],growShrink:[[0,1],[.5,0],[1,-2]]},r=function(e,t,r,i,s){this.name=e,this.value=t,this.curve=s||n.zeroToOne,this.processedValue,typeof this.value!="number"&&(this.value=1),this.min=r||0,this.max=i||1,this.changedCallbacks=[],this.processValue()};r.prototype.getInterpolatedInCurveAboveIndex=function(e,t,n){return t[n][1]+(e-t[n][0])/(t[n+1][0]-t[n][0])*(t[n+1][1]-t[n][1])},r.prototype.valueFromCurve=function(e,t){for(var n=0;n<t.length;n++){if(!t[n+1])return 0;if(t[n+1][0]>=e)return this.getInterpolatedInCurveAboveIndex(e,t,n)}return t[n-1][1]},r.prototype.setValue=function(e){e>this.max?e=this.max:e<this.min&&(e=this.min),this.value!=e&&(this.value=e,this.processValue(),this.onStateChange(this.processedValue))},r.prototype.processValue=function(){this.processedValue=Math.round(100*(this.min+this.valueFromCurve(this.value/this.max,this.curve)*(this.max-this.min)))/100},r.prototype.getValue=function(){return this.value},r.prototype.getProcessedValue=function(){return this.processedValue},r.prototype.addOnChangeCallback=function(e){this.changedCallbacks.push(e)},r.prototype.onStateChange=function(e){t.emit("message_to_gui",{channel:"system_channel",message:["Setting Change",this.name+": "+this.processedValue]});for(var n=0;n<this.changedCallbacks.length;n++)this.changedCallbacks[n](e)};var i={sound_master:new r("Master Sound Level",1,0,1,n.zeroToOneExp),sound_ambient:new r("Ambient Sound Level",.7,0,1,n.zeroToOneExp),sound_fx_ambient:new r("Ambient FX Send",0,0,1,n.zeroToOneExp),sound_game:new r("Game Sound Level",.7,0,1,n.zeroToOneExp),sound_fx_game:new r("Game FX Send",.7,0,1,n.zeroToOneExp),sound_ui:new r("UI Sound Level",.3,0,1,n.zeroToOneExp),sound_fx_ui:new r("UI FX Send",1,0,1,n.zeroToOneExp),sound_music:new r("Music Level",.7,0,1,n.zeroToOneExp),sound_fx_music:new r("Music FX Senf",0,0,1,n.zeroToOneExp),display_pixel_scale:new r("Pixel Scale",1,.5,4,n.zeroToOneExp),environemnt_time_scale:new r("Environment Time Scale",.05,0,1,n.zeroToOneExp),environemnt_time_of_day:new r("Environment Time Of Day",.3,0,1,n.zeroToOne)},s=function(){};s.getAllSettings=function(){return i},s.getSetting=function(e){return i[e]};var o=function(t){i[e.eventArgs(t).setting].setValue(e.eventArgs(t).value)};return e.registerListener(e.list().SETTING_CONTROL_EVENT,o),s}),define("sound/MasterTrack",["application/EventManager"],function(e){var t,n=function(e){t=e},r=function(e){e.connect(t.destination)},i=function(n){var r=e.eventArgs(n).node;r.connect(t.destination)},s=function(n){var r=e.eventArgs(n).node;r.connect(t.destination)},o=function(n){var r=e.eventArgs(n).node;r.connect(t.destination)},u=function(n){var r=e.eventArgs(n).pos,i=e.eventArgs(n).vel,s=e.eventArgs(n).rot;t.listener.setPosition(r[0],r[1],r[2]),t.listener.setOrientation(s[0],s[1],s[2],0,1,0),t.listener.setVelocity(i[0],i[1],i[2])};return e.registerListener(e.list().SEND_SOUND_TO_LISTENER,i),e.registerListener(e.list().SEND_SOUND_TO_MASTER,s),e.registerListener(e.list().SEND_SOUND_TO_DESTINATION,o),e.registerListener(e.list().MOVE_AUDIO_LISTENER,u),{setContext:n,connectTrack:r}}),define("sound/EffectTrack",["application/EventManager","application/DeviceHandler"],function(e,t){var n,r,i,s=t.hasPowerSound(),o=function(e){n=e,r=n.createGain(),s?(i=n.createConvolver(),r.connect(i)):r.connect(n.destination),r.gain.value=.5},u=function(e){i.buffer=e,i.connect(n.destination)},a=function(){var t=function(e){u(e)};e.fireEvent(e.list().FETCH_BUFFER,{soundData:e.sound().FX_VERB,callback:t})},f=function(e){e.connect(r)},l=function(t){var n=e.eventArgs(t).node;n.connect(r)},c=function(){s&&a()};return s&&e.registerListener(e.list().SEND_SOUND_TO_REVERB,l),{setContext:o,setupFxTrack:c,connectTrackToFx:f}}),define("sound/MixTrack",["application/EventManager","sound/MasterTrack","sound/EffectTrack"],function(e,t,n){var r=function(e,t,n,r,i){this.channelId=e,this.is3dSource=t,this.context=i,this.fxSend=r.getProcessedValue(),this.fxConnected=!1,this.auxSendGain,this.channelGain=1,this.tuneLevel=n.getProcessedValue(),this.wireTrack(),this.defaultMix(),this.settingGain=n,this.settingFxSend=r;var s=function(){this.tuneGain()}.bind(this),o=function(e){this.tuneFxSend(e)}.bind(this);this.settingGain.addOnChangeCallback(s),this.settingFxSend.addOnChangeCallback(o),s(),o()};return r.prototype.wireTrack=function(){this.gainNode=this.context.createGain(),this.filterNode=this.context.createBiquadFilter(),this.filterNode.connect(this.gainNode),t.connectTrack(this.gainNode),this.setupFxSend()},r.prototype.setupFxSend=function(){this.auxSendGain=this.context.createGain(),this.gainNode.connect(this.auxSendGain),this.connectFxSend()},r.prototype.connectFxSend=function(){this.auxSendGain.gain.value=this.fxSend,this.fxSend?(this.fxConnected||(console.log("Connect to FX: ",this.channelId),n.connectTrackToFx(this.auxSendGain)),this.fxConnected=!0):(this.fxConnected&&(console.log("Disconnect FX: ",this.channelId),this.auxSendGain.disconnect()),this.fxConnected=!1)},r.prototype.defaultMix=function(){this.setFilterQValue(1e-5,0),this.setFilterFreqValue(2e4,0)},r.prototype.addSourceNode=function(e){e.connect(this.filterNode)},r.prototype.setTrackGain=function(e,t){t||(t=.5),this.gainNode.gain.linearRampToValueAtTime(e,this.context.currentTime+t)},r.prototype.setFilterQValue=function(e,t){t||(t=.5),this.filterNode.Q.linearRampToValueAtTime(e,t+this.context.currentTime)},r.prototype.getFilterQValue=function(){return this.filterNode.Q.value},r.prototype.setFilterFreqValue=function(e,t){t||(t=.5),this.filterNode.frequency.linearRampToValueAtTime(e,t+this.context.currentTime)},r.prototype.getFilterFreqValue=function(){return this.filterNode.frequency.value},r.prototype.tuneFilterQ=function(e){this.setFilterQValue(1*e,1e-4)},r.prototype.tuneFilterFreq=function(e){this.setFilterFreqValue(2e4*e,.01)},r.prototype.tuneGain=function(){this.setTrackGain(this.channelGain*this.settingGain.getProcessedValue(),.01)},r.prototype.tuneFxSend=function(){this.fxSend=this.settingFxSend.getProcessedValue(),this.connectFxSend()},r.prototype.setChannelGain=function(e){this.channelGain=e,this.tuneGain(1)},r.prototype.getChannelGain=function(){return this.channelGain},r}),define("sound/ChannelMixer",["game/GameConfiguration","application/EventManager","application/Settings","sound/MasterTrack","sound/EffectTrack","sound/MixTrack"],function(e,t,n,r,i,s){var o={},u=e.MIX_TRACKS,a=function(){return u},f=function(e){return o[e].mixTrack},l=function(){return o},c=function(e,t,r,i,u){var a=n.getSetting(r),f=n.getSetting(i),l=new s(e,t,a,f,u);o[e]=l},h=function(e){for(var t in u)c(u[t].id,u[t].spatial,u[t].settingGain,u[t].settingFxSend,e)},p=function(e){i.setContext(e),r.setContext(e),h(e)},d=function(e,t){o[e.track.id].addSourceNode(t.gainNode)},v=function(e){var n=t.eventArgs(e).channelId,r=t.eventArgs(e).valueId,i=t.eventArgs(e).amount;o[n][r](i)},m=function(e,t){o[t].addSourceNode(e)};return t.registerListener(t.list().MIX_CHANNEL_VALUE,v),{getTracks:a,connectNodeToChannel:m,addSoundToChannel:d,setupMixChannels:p,getChannels:l}}),define("sound/SoundPlayer",["application/EventManager","application/DeviceHandler","sound/ChannelMixer"],function(e,t,n){var r={},i={},s={},o=[0,0,0],u,a=[],f=90,l=0,c=t.hasPowerSound(),h="HRTF",p=function(e,t){var n=u.createPanner();return n.rolloffFactor=t,n.panningModel=h,n.coneInnerAngle=360,n.coneOuterAngle=360,n.refDistance=e,n},d=function(){for(var e=0;e<f;e++)a[e]=p(10,.5);console.log("PANNER POOL:",a)},v=function(e,t,i,o){e.source.setGain(e.gain);var u=e.source.getSource(),a=e.source.wire(u),f={playId:t,source:e.source,sourceNode:u,gainNode:a};o?r[t]=f:t&&(s[t]=f),n.addSoundToChannel(e,f),e.source.play(u,o),typeof i=="function"&&i(f)},m=function(e,t){if(typeof e.source.getSource!="function")return;var n=e.source.getSource(),r={source:e.source,sourceNode:n,data:e};t(r)},g=function(e,t){if(typeof e.source.getSource!="function")return;var n=e.source.getSource().buffer;t(n)},y=function(e){var t=r[e].source;t.pause(r[e].sourceNode),delete r[e]},b=function(e){var t=s[e].source;t.pause(s[e].sourceNode),delete s[e]},w=function(t){var n=e.eventArgs(t).soundData,r=e.eventArgs(t).playId,i=e.eventArgs(t).callback;v(n,r,i,!1)},E=function(t){var n=e.eventArgs(t).soundData,r=e.eventArgs(t).loopId,i=e.eventArgs(t).callback;v(n,r,i,!0)},S=function(t){var n=e.eventArgs(t).loopId;y(n)},x=function(t){var n=e.eventArgs(t).playId;b(n)},T=function(t){var n=e.eventArgs(t).soundData,r=e.eventArgs(t).callback;m(n,r)},N=function(t){u=e.eventArgs(t).context,c||d(),n.setupMixChannels(u)},C=function(t){var n=e.eventArgs(t).soundData,r=e.eventArgs(t).callback;g(n,r)},k=function(e){var t=Math.abs(Math.abs(e[0])-Math.abs(o[0]))+Math.abs(Math.abs(e[1])-Math.abs(o[1]))+Math.abs(Math.abs(e[2])-Math.abs(o[2]));return t},L=function(e,t){if(c)return p(e,t);var n=l+1;n>=f&&(n=0);var r=a[n];return r.disconnect(),r},A=function(t){var r=e.eventArgs(t).soundData,i=e.eventArgs(t).pos,s=e.eventArgs(t).vel,o=e.eventArgs(t).dir,a=k(i);if(a>1e4)return;var f=L(r.options.refDist,r.options.rolloff),l=u.createGain();f.setPosition(i[0],i[1],i[2]),s||(s=[0,0,0]),f.setVelocity(s[0],s[1],s[2]),f.setOrientation(o[0],o[1],o[2]);var c=function(e){l.gain.value=1,e.sourceNode.connect(l),l.connect(f),n.connectNodeToChannel(f,n.getTracks().game.id),e.sourceNode.start(0)};m(r,c)},O=function(t){var i=e.eventArgs(t).soundData,s=e.eventArgs(t).playId,o=e.eventArgs(t).callback,a=L(i.options.refDist,i.options.rolloff),f=u.createGain(),l=function(e){f.gain.value=1,e.sourceNode.connect(f),e.sourceNode.loop=!0,f.connect(a),n.connectNodeToChannel(a,n.getTracks().game.id),e.panner=a,e.gainNode=f,e.playId=s,o(e),e.sourceNode.start(0),r[s]=e};m(i,l)},M=function(t){var n=e.eventArgs(t).pos,r=e.eventArgs(t).vel;o=n};e.registerListener(e.list().REGISTER_AUDIO_CONTEXT,N),e.registerListener(e.list().FETCH_SOUND,T),e.registerListener(e.list().FETCH_BUFFER,C),e.registerListener(e.list().STOP_SOUND,x),e.registerListener(e.list().ONESHOT_SOUND,w),e.registerListener(e.list().ONESHOT_AMBIENT_SOUND,A),e.registerListener(e.list().LOOP_AMBIENT_SOUND,O),e.registerListener(e.list().START_SOUND_LOOP,E),e.registerListener(e.list().STOP_SOUND_LOOP,S),e.registerListener(e.list().MOVE_AUDIO_LISTENER,M)}),define("sound/SoundManager",["sound/SoundLoader","sound/SoundPlayer","application/EventManager","sound/EffectTrack"],function(e,t,n,r){var i="soundDisable",s,o=function(){console.log("Load Sounds"),s||(f(),s=!0)},u=function(){r.setupFxTrack()},a=function(){console.log("Init sound system",window.AudioContext),e.initSoundSystem()},f=function(){e.loadSoundList()},l=function(e){var t=n.eventArgs(e),r=t.settingId;r==i&&o()};window.performance||(window.performance={}),performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var c=function(e){var t=n.eventArgs(e).callback;t(performance.now())};return n.registerListener(n.list().FETCH_TIME,c),n.registerListener(n.list().SET_SETTING_INDEX,l),{loadSounds:o,initSounds:a,initFx:u}}),define("game/ships/BoatData",function(){}),define("game/ModelDefinitions",["game/GameConfiguration"],function(e){var t={smoke:{blending:"CustomBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},fire:{blending:"CustomBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneFactor"}};return{BULLETS:{cannon:{fire:{mesh:e.PRELOAD_GOO_MESHES.bullet_20,material:e.PRELOAD_GOO_MATERIALS.fire,textures:{DIFFUSE_MAP:e.PRELOAD_GOO_TEXTURES.machinery_diffuse,EMISSIVE_MAP:e.PRELOAD_GOO_TEXTURES.machinery_diffuse},shaderId:"uberShader"}}},GOO_PROJECTS:e.GOO_PROJECTS,GOO_MODELS:{nevada:{metal:{mesh:e.PRELOAD_GOO_MESHES.nevada_metal,material:e.PRELOAD_GOO_MATERIALS.metal,textures:{DIFFUSE_MAP:e.PRELOAD_GOO_TEXTURES.machinery_diffuse,SPECULAR_MAP:e.PRELOAD_GOO_TEXTURES.machinery_spec},shaderId:"uberShader"}}},GOO_PARTICLES:{smokestack:{name:"smokestack",blendState:t.smoke,targetSpace:null,textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:8,minLifetime:3,maxLifetime:21}],timeline:[{timeOffset:0,spin:0,mass:1,size:5.1,color:[0,0,0,.15]},{timeOffset:.2,size:25,color:[0,0,0,.05]},{timeOffset:.4,size:44.2,color:[0,0,0,.03]},{timeOffset:.3,size:70.5,color:[0,0,0,0]}]},jet_smoke:{name:"jet_smoke",blendState:t.smoke,targetSpace:null,textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:45,minLifetime:1,maxLifetime:9,posOffset:[0,-0.22,-4.5]}],timeline:[{timeOffset:0,spin:0,mass:1,size:.2,color:[.25,.12,.11,.08]},{timeOffset:.05,size:1,color:[.1,.1,.1,.03]},{timeOffset:.3,size:8.2,color:[0,0,0,.02]},{timeOffset:.3,size:22.5,color:[0,0,0,0]}]},tomcat_jet:{name:"tomcat_jet",blendState:t.fire,targetSpace:"parent",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.dot_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:1400,minLifetime:.03,maxLifetime:.07}],timeline:[{timeOffset:0,mass:1,size:.7,color:[.5,.5,.6,.38]},{timeOffset:.3,size:.95,color:[.4,.3,.3,.12]},{timeOffset:.2,size:.35,color:[.6,.6,.3,.04]},{timeOffset:.3,size:1.57,color:[1,.6,.1,.03]},{timeOffset:.2,size:.85,color:[1,.3,0,0]}]},basic_jet:{name:"basic_jet",blendState:t.fire,targetSpace:"parent",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.dot_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:600,minLifetime:.06,maxLifetime:.14},{totalParticlesToSpawn:-1,releaseRatePerSecond:600,minLifetime:.04,maxLifetime:.08}],timeline:[{timeOffset:0,spin:0,mass:1,size:.3,color:[.1,.3,1,.04]},{timeOffset:.2,size:.35,color:[.2,.5,.9,.18]},{timeOffset:.2,size:.45,color:[.6,.6,.5,.06]},{timeOffset:.3,size:.47,color:[1,.4,0,.02]},{timeOffset:.2,size:.75,color:[1,.3,0,0]}]},black_puff:{name:"black_puff",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:50,minLifetime:4.8,maxLifetime:12.8}],timeline:[{timeOffset:0,spin:0,mass:1,size:4.1,color:[1,1,1,0]},{timeOffset:.02,size:8,color:[.3,.3,.3,.27]},{timeOffset:.3,size:34.2,color:[0,0,0,.12]},{timeOffset:.7,size:50.5,color:[.2,.2,.2,0]}]},cloud_puff:{name:"cloud_puff",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:10,minLifetime:7,maxLifetime:15}],timeline:[{timeOffset:0,spin:0,mass:1,size:1245,color:[.98,.98,.98,0]},{timeOffset:.15,size:1355,color:[.98,.98,.98,.21]},{timeOffset:.5,size:1475,color:[.96,.96,.96,.28]},{timeOffset:.34,size:1594,color:[.95,.95,.95,0]}]},acrobatic_puff:{name:"acrobatic_puff",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:120,minLifetime:15,maxLifetime:22}],timeline:[{timeOffset:0,spin:0,mass:1,size:.65,color:[1,1,1,.02]},{timeOffset:.02,size:2.5,color:[.94,.94,.94,.18]},{timeOffset:.1,size:9,color:[.9,.9,.9,.05]},{timeOffset:.6,size:34,color:[.85,.85,.85,.02]},{timeOffset:.2,size:124,color:[.85,.85,.85,0]}]},small_puff:{name:"small_puff",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:120,minLifetime:.4,maxLifetime:1.5}],timeline:[{timeOffset:0,spin:0,mass:1,size:.25,color:[1,1,1,.11]},{timeOffset:.15,size:1.2,color:[.99,.99,.99,.14]},{timeOffset:.3,size:2.5,color:[.97,.97,.97,.07]},{timeOffset:.5,size:7,color:[.95,.95,.95,0]}]},rapid_puff:{name:"rapid_puff",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:1420,minLifetime:.04,maxLifetime:.13}],timeline:[{timeOffset:0,spin:0,mass:1,size:.85,color:[1,1,1,.51]},{timeOffset:.3,size:2.2,color:[1,1,1,.27]},{timeOffset:.5,size:5,color:[1,1,1,0]}]},white_puff:{name:"white_puff",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:150,minLifetime:1.8,maxLifetime:3.8}],timeline:[{timeOffset:0,spin:0,mass:1,size:5.66,color:[.3,.3,.3,0]},{timeOffset:.3,size:8,color:[.7,.7,.7,.13]},{timeOffset:.9,size:64.2,color:[.95,.95,.95,0]}]},water_splash:{name:"water_splash",blendState:t.smoke,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.splash_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:150,minLifetime:.8,maxLifetime:2.1}],timeline:[{timeOffset:.01,spin:.1,mass:1,size:.06,color:[.95,.95,1,.6]},{timeOffset:.3,spin:-0.1,size:7.22,color:[.85,.9,1,.48]},{timeOffset:.6,spin:0,size:16.2,color:[1,1,1,0]}]},spark_flash:{name:"spark_flash",blendState:t.fire,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.spark_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:55,minLifetime:.21,maxLifetime:.46}],timeline:[{timeOffset:.01,spin:53.1,mass:1,size:.06,color:[.55,.65,1,.9]},{timeOffset:.6,spin:0,size:12.22,color:[.85,.8,.9,.28]},{timeOffset:.4,spin:0,size:18.2,color:[1,1,1,0]}]},shockwave_hit:{name:"shockwave_hit",blendState:t.fire,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.shockwave_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:55,minLifetime:.26,maxLifetime:.46}],timeline:[{timeOffset:.01,spin:.1,mass:1,size:8,color:[.95,.95,1,.4]},{timeOffset:.15,spin:-0.1,size:.22,color:[.95,.9,.5,.6]},{timeOffset:.85,spin:0,size:28.2,color:[1,.8,.4,0]}]},muzzle_flash:{name:"muzzle_flash",blendState:t.fire,targetSpace:"null",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.dot_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:150,minLifetime:.28,maxLifetime:.66}],timeline:[{timeOffset:.01,spin:.1,mass:1,size:2,color:[.95,.5,.4,.6]},{timeOffset:.3,spin:-0.1,size:12.22,color:[.85,.5,.1,.48]},{timeOffset:.6,spin:0,size:8,color:[1,.3,0,0]}]},muzzle_flame:{name:"muzzle_flame",blendState:t.fire,targetSpace:"parent",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.dot_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:200,minLifetime:.04,maxLifetime:.08}],timeline:[{timeOffset:0,spin:0,mass:1,size:.06,color:[.7,.6,.9,.44]},{timeOffset:.4,size:.62,color:[1,.9,.6,.18]},{timeOffset:.6,size:.2,color:[.6,.3,.01,0]}]},muzzle_smoke:{name:"muzzle_smoke",blendState:t.smoke,targetSpace:"parent",textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.smoke_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:50,minLifetime:.19,maxLifetime:.55}],timeline:[{timeOffset:0,spin:0,mass:1,size:.36,color:[.3,.3,.3,.3]},{timeOffset:.4,size:.92,color:[.5,.5,.5,.18]},{timeOffset:.6,size:2.2,color:[0,0,0,0]}]},water_ringlet:{name:"water_ringlet",blendState:t.smoke,targetSpace:"null",billboard:{bbx:[1,0,0],bby:[0,0,1]},textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.fieldring_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:20,minLifetime:52,maxLifetime:88}],timeline:[{timeOffset:0,spin:.1,mass:1,size:12,color:[.85,.95,1,0]},{timeOffset:.03,spin:.1,mass:1,size:18,color:[.85,.85,.9,.1]},{timeOffset:.3,spin:-0.1,size:80,color:[.75,.9,1,.03]},{timeOffset:.6,spin:0,size:250,color:[.4,.7,1,0]}]},water_foam:{name:"water_foam",blendState:t.smoke,targetSpace:"null",billboard:{bbx:[1,0,0],bby:[0,0,1]},textures:{PARTICLE_TX:e.PRELOAD_GOO_TEXTURES.foam_particle},emitters:[{totalParticlesToSpawn:-1,releaseRatePerSecond:20,minLifetime:22,maxLifetime:88}],timeline:[{timeOffset:0,spin:.1,mass:1,size:15,color:[.85,.95,1,0]},{timeOffset:.2,spin:.1,mass:1,size:15,color:[1,1,1,.5]},{timeOffset:.3,spin:-0.1,size:25,color:[1,1,1,.23]},{timeOffset:.6,spin:0,size:57,color:[1,1,1,0]}]}}}}),define("game/weapons/WeaponData",["game/ModelDefinitions"],function(e){return{BOMB_200:{modelPath:e.GOO_PROJECTS.armaments.bomb_200kg,damageEffects:[{kinetic:{points:5}},{fire:{intensity:.2,size:9}}],onHitSounds:["BULLET_HIT_0","BULLET_HIT_1","BULLET_HIT_2","BULLET_HIT_3"],lifeTime:6e4,onHitEffects:{FLASH_SPARKS:{count:1},FLASH_SHOCKWAVE:{count:1},PUFF_BLACK_SMOKE:{count:2},PUFF_WHITE_SMOKE:{count:1}}},BULLET_20:{modelPath:e.GOO_PROJECTS.bullet_20.piecePath,damageEffects:[{kinetic:{points:5}},{fire:{intensity:.2,size:9}}],onHitSounds:["BULLET_HIT_0","BULLET_HIT_1","BULLET_HIT_2","BULLET_HIT_3"],lifeTime:5e3,onHitEffects:[{id:"metal_sparks",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}}]},BULLET_AAA:{modelPath:e.GOO_PROJECTS.bullet_20.piecePath,damageEffects:[{kinetic:{points:20}},{fire:{intensity:.5,size:16}}],onHitSounds:["AAA_HIT_0","AAA_HIT_1","AAA_HIT_2"],lifeTime:14e3,onHitEffects:[{id:"metal_sparks",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}},{id:"explosion_fire",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}}]},BULLET_MAIN:{modelPath:e.GOO_PROJECTS.bullet_20.piecePath,damageEffects:[{kinetic:{points:100}},{fire:{intensity:.7,size:20}}],onHitSounds:["MAIN_HIT_0","MAIN_HIT_1","MAIN_HIT_2"],lifeTime:38e3,onHitEffects:[{id:"metal_sparks",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}},{id:"explosion_fire",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}}]},TURRET_CANNONS:{main_gun_16:{name:"Main Gun 16",caliber:250,barrelLength:25,exitVelocity:230,rateOfFire:.07,onFireSounds:["MAIN_GUN_0","MAIN_GUN_1","MAIN_GUN_2"],onFireEffects:[{id:"explosion_fire",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}},{id:"explosion_fire",effectData:{size:5e4,alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}}],lifetime:92e3},midship_80:{name:"Midship Gun 8",caliber:80,barrelLength:10,exitVelocity:380,rateOfFire:2.3,onFireSounds:["AAA_0","AAA_1","AAA_2"],onFireEffects:[{id:"explosion_fire",effectData:{size:200,growth:8e3,lifespan:2,alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}},{id:"explosion_fire",effectData:{alphaCurve:[[0,1],[.7,.9],[1,0]],growthCurve:[[0,1.2],[.3,1],[1,1.6]]}}],lifetime:7e3}},CANNONS:{hispano_20:{name:"Hispano 20",caliber:20,exitVelocity:720,rateOfFire:4,onFireSounds:["CANNON_20_0","CANNON_20_1","CANNON_20_2","CANNON_20_3"],flameEffect:e.GOO_PARTICLES.muzzle_flame,smokeEffect:e.GOO_PARTICLES.muzzle_smoke,lifetime:7e3},vulcan_20:{name:"Vulcan 20",caliber:20,exitVelocity:1120,rateOfFire:20,onFireSounds:["CANNON_20_0","CANNON_20_1","CANNON_20_2","CANNON_20_3"],flameEffect:e.GOO_PARTICLES.muzzle_flame,smokeEffect:e.GOO_PARTICLES.muzzle_smoke,lifetime:7e3}}}}),define("game/cars/CarData",["game/GameConfiguration","game/ModelDefinitions","game/weapons/WeaponData"],function(e,t,n){return{PV_9031:{modelPath:"pv_9031",dimensions:{massEmpty:845,massMax:2375,weightDistribution:[1.2,.6,1.2],length:4,pilotSeatPos:[0,.9,1.72],wingspan:2.23,height:1.75},keyBindings:e.KEY_BINDINGS.car,uiPages:[],wings:{body:{pos:[0,1,0],size:[2.6,1.19,4.8],rot:[0,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[4.5,0,0],formDragCoeff:10.21}},gooProjectUrl:e.GOO_PROJECTS.car_pv_9031.projectPath,piecePath:e.GOO_PROJECTS.car_pv_9031.pv_9031,uiPage:"UI_CAR",instruments:{},measurements:{},surfaces:{rudder:{inputBehavior:{release:1,speed:.1},controls:{rudder:{right_f_susp:.2,left_f_susp:-0.2,steer:4.7}},speed:.02}},systems:{drive:{inputBehavior:{type:"toggle",speed:1},controls:{doors:{},stands:{}},wheels:{right_f_wheel:{control:"rudder",radius:.3,pos:[-0.9,-0.84,2.1],breakMax:1251,drag:5,suspension:{boneId:"right_f_susp",range:.25,axis:[0,0,1],stiffness:7850}},left_f_wheel:{control:"rudder",radius:.3,pos:[.9,-0.84,2.1],breakMax:1251,drag:5,suspension:{boneId:"left_f_susp",range:.25,axis:[0,0,1],stiffness:7850}},wheel_right:{control:null,radius:.3,pos:[-0.9,-0.84,-2.1],breakMax:1251,drag:5,suspension:{boneId:"right_suspend",range:.25,axis:[0,0,1],stiffness:7850}},wheel_left:{control:null,radius:.3,pos:[.9,-0.84,-2.1],breakMax:1251,drag:5,suspension:{boneId:"left_suspend",range:.25,axis:[0,0,1],stiffness:7850}}},speed:.01},breaks:{inputBehavior:{type:"slide",speed:.1},controls:{breaks:{}},speed:.01},engines:{inputBehavior:{type:"slide",speed:.1},controls:{throttle:{}},mounts:[{maxThrust:27e3,jet_flame:t.GOO_PARTICLES.basic_jet,posOffset:[0,1,-1]}],speed:.005}}}}}),define("game/piece/TargetData",["game/GameConfiguration"],function(e){return{TV_CRT:{dimensions:{massEmpty:2,massMax:3,mobRadius:1.05},screens:{meshData:[{meshEntityName:"tv_crt/entities/screen.entity"}],displays:{tv_crt:{mapcoords:[125,94,250,180],instruments:{tv_crt_video:{script:"VideoPlayer",meshIndex:0,txcoords:[125,94,250,180],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.hud}}}}},hitPoints:5,physicalShapes:[{partId:"bullseye",posOffset:[0,.5,0],radius:2}],physicalRadius:2,gooProject:e.GOO_PROJECTS.tv_screen,piecePath:e.GOO_PROJECTS.tv_screen.tv},MONITOR_CONSOLE:{dimensions:{massEmpty:2,massMax:3,mobRadius:1.05},screens:{meshData:[{meshEntityName:"monitor_console/entities/console_screens.entity"}],displays:{console_main:{mapcoords:[127,94,254,190],instruments:{console_main_video:{script:"VideoPlayer",meshIndex:0,txcoords:[127,94,254,190],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.animals}}},console_right:{mapcoords:[383,95,254,190],instruments:{console_right_video:{script:"VideoPlayer",meshIndex:0,txcoords:[383,95,254,190],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.promos}}},console_left:{mapcoords:[85,248,170,105],instruments:{console_left_video:{script:"VideoPlayer",meshIndex:0,txcoords:[85,248,170,105],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.cats}}},console_top_1:{mapcoords:[256,248,170,105],instruments:{console_top_1_video:{script:"VideoPlayer",meshIndex:0,txcoords:[256,248,170,105],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.history}}},console_top_2:{mapcoords:[427,248,170,105],instruments:{console_top_2_video:{script:"VideoPlayer",meshIndex:0,txcoords:[427,248,170,105],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.military}}},console_left_3:{mapcoords:[85,358,170,105],instruments:{console_top_3_video:{script:"VideoPlayer",meshIndex:0,txcoords:[85,358,170,105],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.planes}}},console_top_4:{mapcoords:[254,358,170,105],instruments:{console_top_4_video:{script:"VideoPlayer",meshIndex:0,txcoords:[254,355,170,105],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.vdi}}},console_top_5:{mapcoords:[425,358,170,105],instruments:{console_top_5_video:{script:"VideoPlayer",meshIndex:0,txcoords:[425,358,170,105],sources:{video:[0,0,240,180]},channel:e.VIDEOS.channels.hud}}}}},hitPoints:5,physicalShapes:[{partId:"bullseye",posOffset:[0,.5,0],radius:2}],physicalRadius:8,gooProject:e.GOO_PROJECTS.monitor_console,piecePath:e.GOO_PROJECTS.monitor_console.monitor_console},GROUND_FLAT:{dimensions:{massEmpty:845,massMax:2375,mobRadius:1},hitPoints:5,physicalShapes:[{partId:"bullseye",posOffset:[0,3,0],radius:6},{partId:"edge",posOffset:[10,2,10],radius:8},{partId:"edge",posOffset:[-10,2,10],radius:8},{partId:"edge",posOffset:[10,2,-10],radius:8},{partId:"edge",posOffset:[-10,2,-10],radius:8},{partId:"edge",posOffset:[0,2,10],radius:8},{partId:"edge",posOffset:[-10,2,0],radius:8},{partId:"edge",posOffset:[10,2,0],radius:8},{partId:"edge",posOffset:[0,2,-10],radius:8}],physicalRadius:130,gooProject:e.GOO_PROJECTS.targets,piecePath:e.GOO_PROJECTS.targets.ground_flat},HOUSE_BOX_30:{dimensions:{massEmpty:845,massMax:2375,mobRadius:1},hitPoints:3e3,physicalShapes:[{partId:"bullseye",posOffset:[0,15,0],radius:14},{partId:"edge",posOffset:[16,7,16],radius:18},{partId:"edge",posOffset:[-16,7,16],radius:18},{partId:"edge",posOffset:[16,7,-16],radius:18},{partId:"edge",posOffset:[-16,7,-16],radius:18},{partId:"edge",posOffset:[0,7,16],radius:18},{partId:"edge",posOffset:[-16,7,0],radius:18},{partId:"edge",posOffset:[16,7,0],radius:18},{partId:"edge",posOffset:[0,7,-16],radius:18},{partId:"edge",posOffset:[16,16,16],radius:18},{partId:"edge",posOffset:[-16,16,16],radius:18},{partId:"edge",posOffset:[16,16,-16],radius:18},{partId:"edge",posOffset:[-16,16,-16],radius:18},{partId:"edge",posOffset:[0,16,16],radius:18},{partId:"edge",posOffset:[-16,16,0],radius:18},{partId:"edge",posOffset:[16,16,0],radius:18},{partId:"edge",posOffset:[0,16,-16],radius:18}],physicalRadius:180,gooProject:e.GOO_PROJECTS.targets,piecePath:e.GOO_PROJECTS.targets.house_box_3}}}),define("game/planes/tunnan/TunnanSystems",["game/ModelDefinitions","game/weapons/WeaponData"],function(e,t){return{SYSTEMS:{auto_trim:{pieceInput:{auto_trim:{value:0,controlState:0}},inputBehavior:{type:"toggle",speed:1},speed:1},gears:{pieceInput:{gears:{value:0,controlState:0},doors:{value:0,controlState:0}},inputBehavior:{type:"toggle",speed:1},controls:{doors:{door_nose_r:[-1.4,0,0],door_nose_l:[1.4,0,0],door_left:[.8,0,0],door_right:[-0.8,0,0]},stands:{nose_gear:[-1.5,0,0],gear_right:[1.8,0,0],gear_left:[-1.8,0,0],right_suspend:[-0.6,0,0],left_suspend:[.6,0,0]}},wheels:{wheel_nose:{control:"rudder",radius:.3,pos:[0,-1.5,3.4],axis:[1,0,0],breakMax:155.02,drag:5,suspension:{boneId:"nose_suspend",range:.31,axis:[0,0,-1],stiffness:22550}},wheel_right:{control:null,radius:-0.5,pos:[-0.9,-1.43,-0.17],breakMax:2225,drag:5,suspension:{boneId:"right_suspend",range:.31,axis:[0,1,0],stiffness:75e3}},wheel_left:{control:null,radius:.5,pos:[.9,-1.43,-0.17],breakMax:2225,drag:5,suspension:{boneId:"left_suspend",range:.31,axis:[0,-1,0],stiffness:75e3}},wheel_rear:{control:null,radius:.3,pos:[0,-1.1,-4.4],breakMax:1555.02,drag:5,suspension:{boneId:null,range:.31,axis:[0,0,-1],stiffness:14550}}},speed:.01},breaks:{pieceInput:{breaks:{value:0,controlState:0}},inputBehavior:{type:"slide",speed:.1},controls:{},speed:.01},canopy:{pieceInput:{canopy:{value:0,controlState:0}},inputBehavior:{type:"toggle",speed:1},controls:{xform:"slide",doors:{canopy:[-0.7,0,-0.09]}},speed:.01},seat:{pieceInput:{eject:{value:0,controlState:0}},inputBehavior:{type:"button",speed:1},type:"ejection",controls:{seats:{seat:[-2.15,0,-0.5]}},speed:.4},engines:{pieceInput:{throttle:{value:0,controlState:0}},inputBehavior:{type:"slide",speed:.02,inputAnim:{bone:"throttle",rot:[-1,0,0]}},controls:{throttle:{throttle:.8}},mounts:[{maxThrust:27e3,afterBurner:22e3,jet_flame:e.GOO_PARTICLES.basic_jet,jet_smoke:e.GOO_PARTICLES.jet_smoke,posOffset:[0,-0.3,-4]}],speed:8e-4},weapons:{pieceInput:{cannons:{value:0,controlState:0}},inputBehavior:{type:"button",speed:1},controls:{cannons:{bones:[{trigger:.3}]}},cannons:[{data:t.CANNONS.hispano_20,bulletData:t.BULLET_20,posOffset:[.44,-0.54,3.6]},{data:t.CANNONS.hispano_20,bulletData:t.BULLET_20,posOffset:[.32,-0.75,3.35]},{data:t.CANNONS.hispano_20,bulletData:t.BULLET_20,posOffset:[-0.32,-0.75,3.35]},{data:t.CANNONS.hispano_20,bulletData:t.BULLET_20,posOffset:[-0.44,-0.54,3.6]}],speed:2}}}}),define("game/planes/tunnan/TunnanInstruments",[],function(){var e={climb:[[-1e3,-10],[-18,-9],[-5,-5],[5,5],[18,9],[1e3,10]]};return{INSTRUMENTS:{horizon:{boneName:"horizon",sample:"rotVec",axisAmp:[[2,.0025],[1,0],[2,-0.021]]},gyro_roll:{boneName:"gyro_horizon",sample:"rollAng",axisAmp:1},gyro_horizon:{boneName:"gyro_roll",sample:"rotVec",axisAmp:[[2,0],[1,0],[2,-0.032]]},engine_rpm:{boneName:"engine_rpm",sample:"rpm",axisAmp:-Math.PI*1.8},exhaust_temp:{boneName:"exhaust_temp",sample:"temp",axisAmp:-Math.PI*90.45},accelerometer:{boneName:"accelerometer",sample:"g",axisAmp:-5},turn_quality:{boneName:"turn_quality",sample:"acc",axisAmp:[[0,0],[0,7.25],[0,0]]},roll_indicator:{boneName:"roll_indicator",sample:"rollAng",axisAmp:-1},gyro_compass:{boneName:"gyro_compass",sample:"xyHeading",axisAmp:1},mag_compass:{boneName:"mag_compass",sample:"xyHeading",axisAmp:-1},gyro_steer:{boneName:"gyro_steer",sample:"xyHeading",axisAmp:1.4},climb_indicator:{boneName:"climb_indicator",sample:"climbRate",curve:e.climb,axisAmp:-0.315},speed_indicator:{boneName:"speed_indicator",sample:"speed",axisAmp:-3.14*.006},alt_outer:{boneName:"alt_outer",sample:"altitude",axisAmp:-0.00314},alt_inner:{boneName:"alt_inner",sample:"altitude",axisAmp:-3.14*1e-4}}}}),define("game/planes/tunnan/TunnanSurfaces",[],function(){return{SURFACES:{elevator:{inputBehavior:{release:1,speed:.1,inputAnim:{bone:"stick",rot:[.4,.5,0]}},controls:{elevator:{elevator:.6}},speed:.2},aeilrons:{inputBehavior:{release:1,speed:.1},controls:{aeilrons:{aeilron_right:-0.5,aeilron_left:-0.5}},speed:.2},rudder:{inputBehavior:{release:1,speed:.1},controls:{rudder:{rudder:.8,pedal_left:-0.7,pedal_right:-0.7}},speed:.2},flaps:{inputBehavior:{release:0,speed:.1},controls:{flaps:{flap_right:-1.1,flap_left:1.1}},speed:.005},breaks:{inputBehavior:{release:0,speed:.1},controls:{breaks:{airbreak_right:-0.65,airbreak_left:.65}},speed:.02}}}}),define("game/planes/tunnan/TunnanOnScreenInput",[],function(){var e={elevator:{xMin:47,yMin:65,xMax:53,yMax:85,axis:1,max:1,min:-1,factor:.7,name:"Elevator",label:"Pitch"},aeilrons:{xMin:41,yMin:71,xMax:59,yMax:79,axis:0,max:1,min:-1,factor:1,name:"Aeilrons",label:"Roll"},rudder:{xMin:42,yMin:85,xMax:58,yMax:88,axis:0,max:1,min:-1,factor:1,name:"Rudder",label:"Yaw"}},t={trim_elevator:{xMin:58,yMin:67,xMax:63,yMax:87,axis:1,max:.5,min:-0.5,factor:.3,name:"Pitch",label:"Trim"},trim_aeilrons:{xMin:52,yMin:73,xMax:69,yMax:81,axis:0,max:.5,min:-0.5,factor:.3,name:"Roll",label:"Trim"},trim_rudder:{xMin:55,yMin:87,xMax:66,yMax:90,axis:0,max:.5,min:-0.5,factor:.3,name:"Yaw",label:"Trim"}},n={throttle:{xMin:27,yMin:62,xMax:33,yMax:73,axis:1,max:1,min:0,factor:1,name:"Engines",label:"Throttle"},flaps:{xMin:21,yMin:62,xMax:26,yMax:73,axis:1,max:1,min:0,factor:1,name:"Flaps",label:"Angle"},breaks:{xMin:15,yMin:62,xMax:20,yMax:73,axis:1,max:1,min:0,factor:1,name:"Brake",label:"State"}},r={gears:{xMin:18,yMin:52,xMax:23,yMax:63,axis:1,max:1,min:0,factor:80,name:"Gear",label:"State"},canopy:{xMin:12,yMin:52,xMax:17,yMax:63,axis:1,max:1,min:0,factor:80,name:"Canopy",label:"State"}},i=function(){this.data=[{closed:{xMin:41,yMin:92,xMax:52,yMax:96,name:"Steering"},active:{xMin:39,yMin:60,xMax:61,yMax:96,name:"Steering"},name:"Steering",controls:e},{closed:{xMin:57,yMin:91,xMax:65,yMax:95,name:"Trim"},active:{xMin:50,yMin:62,xMax:72,yMax:95,name:"Trim"},name:"Trim",controls:t},{closed:{xMin:26,yMin:74,xMax:33,yMax:78,name:"Flight"},active:{xMin:5,yMin:59,xMax:34,yMax:79,name:"Flight"},name:"Flight",controls:n},{closed:{xMin:16,yMin:64,xMax:23,yMax:68,name:"Landing"},active:{xMin:5,yMin:49,xMax:24,yMax:69,name:"Landing"},name:"Landing",controls:r}]};return i}),define("game/world/Curves",[],function(){var e={wing:[[-30,0],[-3.15,0],[-2.65,.7],[-2.3,.9],[-2.1,.85],[-1.67,0],[-1.1,-0.75],[-1,-0.8],[-0.65,-0.5],[-0.5,-0.4],[-0.4,-0.5],[-0.3,-0.7],[-0.01,-0.004],[0,0],[.01,.004],[.3,.7],[.4,.5],[.45,.8],[.5,.5],[.65,.7],[1,.9],[1.1,.85],[1.67,0],[2.1,-0.75],[2.3,-0.8],[2.65,-0.5],[3.15,0],[30,0]],stab:[[-30,0],[-3.15,0],[-2.65,.7],[-2.3,.9],[-2.1,.85],[-1.67,0],[-1.1,-0.75],[-1,-0.8],[-0.6,-0.5],[-0.4,-0.5],[-0.3,-0.8],[-0.2,-0.3],[-0.01,-0.013],[0,0],[.01,.013],[.2,.3],[.3,.8],[.4,.5],[.6,.5],[1,.8],[1.1,.75],[1.67,0],[2.1,-0.75],[2.3,-0.8],[2.65,-0.5],[3.15,0],[30,0]],cone:[[-30,0],[-3.15,0],[-2.65,.7],[-2.3,.9],[-2.1,.85],[-1.67,0],[-1.1,-0.75],[-1,-0.8],[-0.6,-0.5],[-0.4,-0.3],[-0.3,-0.1],[-0.01,-0.033],[0,0],[.01,.033],[.3,.1],[.4,.3],[.6,.5],[1,.8],[1.1,.75],[1.67,0],[2.1,-0.75],[2.3,-0.8],[2.65,-0.5],[3.15,0],[30,0]],rudder:[[-30,0],[-3.14,0],[-3,.01],[-2.65,.1],[-2.3,.8],[-2.1,.85],[-1.67,0],[-1.1,-0.75],[-1,-1],[-0.6,-0.8],[-0.3,-0.5],[-0.01,-0.013],[0,0],[.01,.013],[.3,.5],[.6,.8],[1,1],[1.1,.75],[1.67,0],[2.1,-0.75],[2.3,-0.8],[2.65,-0.1],[3.1,0],[3.14,0],[30,0]]};return{WINGS:e}}),define("game/planes/tunnan/TunnanWings",["game/world/Curves"],function(e){var t=.09,n=8,r=15,i=20;return{WINGS:{controls:{elevator:{value:0,controlState:0},aeilrons:{value:0,controlState:0},rudder:{value:0,controlState:0},trim_elevator:{value:0,controlState:0},trim_aeilrons:{value:0,controlState:0},trim_rudder:{value:0,controlState:0},flaps:{value:0,controlState:0},wing_smoke:{value:0,controlState:0},reset_trim:{value:0,controlState:0},debug_mechanics:{value:0,controlState:0}},shapes:{fuselageFore:{pos:[0,-0.2,3],size:[1.3,1.3,2],rot:[.02,0,0],stallAngle:[.5,1,1],liftCurve:e.WINGS.cone,stallLiftCoeff:[4.5,0,0],formDragCoeff:.02},fuselageSkid:{pos:[0,-1.2,0],size:[.2,.1,3],rot:[0,0,0],stallAngle:[1.3,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,r,0],formDragCoeff:t},vert_lift:{pos:[0,0,-0.2],size:[2,.2,4],rot:[0,0,-Math.PI/2],stallAngle:[1.3,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,r,0],formDragCoeff:t},fuselageCore:{pos:[0,-0.3,0],size:[1.5,1.5,1.9],rot:[0,0,0],stallAngle:[.5,1,1],liftCurve:e.WINGS.cone,stallLiftCoeff:[3.5,0,0],formDragCoeff:.02},fuselageAft:{pos:[0,-0.1,-2.3],size:[1.5,1.5,1.9],rot:[.03,0,0],stallAngle:[.5,1,1],liftCurve:e.WINGS.cone,stallLiftCoeff:[2.5,0,0],formDragCoeff:.01},mainInnerRight:{pos:[1.3,.24,.41],size:[2.5,.2,2.2],rot:[.004,.55,0],stallAngle:[.5,.5,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:.01},mainInnerLeft:{pos:[-1.3,.24,.41],size:[2.5,.2,2.2],rot:[.004,-0.55,0],stallAngle:[.5,.5,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:.01},mainOuterRight:{pos:[5,.2,-0.6],size:[3.5,.15,1.7],rot:[.002,.49,0],stallAngle:[.65,.3,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:.01},mainOuterLeft:{pos:[-5,.2,-0.6],size:[3.5,.15,1.7],rot:[.002,-0.49,0],stallAngle:[.65,.3,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:.01},flapRight:{controls:{flaps:[-1.1,0,0]},pos:[1.6,.265,-0.05],size:[1.8,.2,1.2],rot:[0,.2,0],stallAngle:[1.5,.7,.2],liftCurve:e.WINGS.rudder,stallLiftCoeff:[i,0,0],formDragCoeff:.1},flapLeft:{controls:{flaps:[-1.1,0,0]},pos:[-1.6,.265,-0.05],size:[1.8,.2,1.2],rot:[0,-0.2,0],stallAngle:[1.5,.7,.2],liftCurve:e.WINGS.rudder,stallLiftCoeff:[i,0,0],formDragCoeff:.1},aeilronRight:{controls:{aeilrons:[.7,0,0]},pos:[4,.15,-1.8],size:[3,.2,.5],rot:[0,.2,0],stallAngle:[.8,.4,.2],liftCurve:e.WINGS.rudder,stallLiftCoeff:[i,0,0],formDragCoeff:.002},aeilronLeft:{controls:{aeilrons:[-0.7,0,0]},pos:[-4,.15,-1.8],size:[3,.2,.5],rot:[0,-0.2,0],stallAngle:[.8,.4,.2],liftCurve:e.WINGS.rudder,stallLiftCoeff:[i,0,0],formDragCoeff:.002},tailplaneR:{pos:[.9,1.1,-5.5],size:[2,.2,.7],rot:[-0.1,.55,0],stallAngle:[1.3,.5,.4],liftCurve:e.WINGS.stab,stallLiftCoeff:[r,0,0],formDragCoeff:.01},tailplaneL:{pos:[-0.9,1.1,-5.5],size:[2,.2,.7],rot:[-0.1,-0.55,0],stallAngle:[1.3,.5,.4],liftCurve:e.WINGS.stab,stallLiftCoeff:[r,0,0],formDragCoeff:.01},elevator:{controls:{elevator:[.7,0,0]},pos:[0,1.1,-6.3],size:[4,.2,.9],rot:[0,0,0],stallAngle:[1.5,.4,.3],liftCurve:e.WINGS.rudder,stallLiftCoeff:[r,0,0],formDragCoeff:.001},rudder:{controls:{rudder:[-0.8,0,0]},pos:[0,1.6,-6],size:[1.4,.2,.8],rot:[0,0,-Math.PI/2],stallAngle:[1.15,.5,1],liftCurve:e.WINGS.rudder,stallLiftCoeff:[0,r,0],formDragCoeff:.01},stabiliser:{pos:[0,1.1,-5],size:[2,.2,1.5],rot:[0,0,-Math.PI/2],stallAngle:[1.3,.4,1],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,r,0],formDragCoeff:.01},break_up:{controls:{breaks:[1.5,0,0]},pos:[0,-0.5,-1.1],size:[2,.2,1],rot:[0,0,0],stallAngle:[1.9,1,1],liftCurve:e.WINGS.rudder,stallLiftCoeff:[r,0,0],formDragCoeff:.001},break_down:{controls:{breaks:[-1.5,0,0]},pos:[0,-0.5,-1.1],size:[2,.2,1],rot:[0,0,0],stallAngle:[1.9,1,1],liftCurve:e.WINGS.rudder,stallLiftCoeff:[r,0,0],formDragCoeff:.001}}}}}),define("game/planes/tunnan/TunnanLights",[],function(){return{LIGHTS:{meshData:[],feedback:{},systems:{}}}}),define("game/planes/tunnan/TunnanScreens",["game/GameConfiguration"],function(e){return{SCREENS:{meshData:[],displays:{}}}}),define("game/planes/tunnan/TunnanData",["game/planes/tunnan/TunnanSystems","game/planes/tunnan/TunnanInstruments","game/planes/tunnan/TunnanSurfaces","game/planes/tunnan/TunnanOnScreenInput","game/planes/tunnan/TunnanWings","game/planes/tunnan/TunnanLights","game/planes/tunnan/TunnanScreens","game/GameConfiguration","game/ModelDefinitions","game/weapons/WeaponData"],function(e,t,n,r,i,s,o,u,a,f){return{TUNNAN:{modelPath:u.GOO_PROJECTS.tunnan.entityIds.tunnan,dimensions:{massEmpty:4845,massMax:8375,weightDistribution:[2,2,2],length:11,wingspan:10.23,pilotSeatPos:[0,.14,1.82],wingAngle:.2,height:3.75},hitPoints:300,physicalShapes:[{partId:"fuselage",posOffset:[0,0,0],radius:5},{partId:"fuselage",posOffset:[0,0,4],radius:5},{partId:"fuselage",posOffset:[0,0,-4],radius:5},{partId:"wing",posOffset:[4,0,-4],radius:5},{partId:"wing",posOffset:[-4,0,-4],radius:5}],physicalRadius:30,keyBindings:u.KEY_BINDINGS.plane,gooProjectUrl:u.GOO_PROJECTS.tunnan.projectPath,gooProject:u.GOO_PROJECTS.tunnan,piecePath:u.GOO_PROJECTS.tunnan.tunnan,contrail_effect:a.GOO_PARTICLES.wing_smoke,uiPages:[],wing_smoke:[[-5.8,0,-2],[5.8,0,-2]],onScreenInput:new r,instruments:t.INSTRUMENTS,measurements:{throttle:1,speed:1,altitude:1,airflowx:1,airflowy:1,airflowz:1,gForce:1},wings:i.WINGS,surfaces:n.SURFACES,systems:e.SYSTEMS}}}),define("game/planes/tomcat/TomcatInstruments",[],function(){var e={climb:[[-1e3,-10],[-18,-9],[-5,-5],[5,5],[18,9],[1e3,10]],speed:[[-1e3,0],[0,0],[500,2],[1e3,2]],acc:[[-4,-1],[0,0],[9,2]],alt:[[-1e3,0],[0,0],[12e3,3],[5e4,4]],ground:[[-1e3,0],[0,0],[100,.6],[250,.9],[400,1.2],[1e3,1.5],[2e3,1.8],[5e3,2.1],[5e4,2.5]]};return{INSTRUMENTS:{horizon:{sample:"rotVec",axisAmp:[[2,.0025],[1,0],[2,-0.021]]},roll_indicator:{sample:"rollAng",axisAmp:-1},gyro_compass:{boneName:"compass_2",sample:"xyHeading",axisAmp:1},turn_quality:{boneName:"turn_quality",sample:"acc",axisAmp:[[0,30],[0,0],[0,0]]},accelerometer:{boneName:"acceleration",sample:"g",axisAmp:-1},climb_indicator:{boneName:"climb",sample:"climbRate",curve:e.climb,axisAmp:-0.315},aoa_indicator:{axisAmp:1},sample:"aoa",ground_alt:{boneName:"ground_alt",sample:"altitude",curve:e.ground,axisAmp:-1},altimeter:{boneName:"altimeter",sample:"altitude",curve:e.alt,axisAmp:-1},ground_speed:{sample:"speed",axisAmp:-3.14},speed_indicator:{boneName:"airspeed",sample:"speed",curve:e.speed,axisAmp:-3.14},gyro_roll:{boneName:"gyro_roll",sample:"rollAng",axisAmp:-1},gyro_pitch:{boneName:"gyro_pitch",sample:"pitch",axisAmp:1}}}}),define("game/planes/tomcat/TomcatSystems",["game/ModelDefinitions","game/weapons/WeaponData"],function(e,t){return{SYSTEMS:{auto_trim:{pieceInput:{auto_trim:{value:0,controlState:0}},inputBehavior:{type:"toggle",speed:1},speed:1},gears:{pieceInput:{gears:{value:0,controlState:0},doors:{value:0,controlState:0}},inputBehavior:{type:"toggle",speed:1},controls:{lights:["wheels"],doors:{door_nose_r:[-1.9,0,0],door_nose_l:[1.9,0,0],door_main_l:[1.3,0,0],door_main_r:[-1.3,0,0],door_rear_l:[1.2,0,0],door_rear_r:[-1.2,0,0],door_inner_l:[-1.5,0,0],door_inner_r:[1.5,0,0]},stands:{gear_nose:[-1.66,0,0],gear_r:[-1.66,0,0],gear_l:[1.66,0,0],gear_susp_l:[1.5,0,0],gear_susp_r:[-1.5,0,0]}},wheels:{nose_wheel:{control:"rudder",radius:-0.4,pos:[0,-1.71,5.9],axis:[1,0,0],breakMax:755.02,drag:5,suspension:{boneId:"nose_susp",range:.41,axis:[0,0,10],stiffness:32550}},wheel_r:{control:null,radius:-0.5,pos:[-2.6,-1.7,-1.07],breakMax:5225,drag:5,suspension:{boneId:"gear_susp_r",range:.41,axis:[0,0,10],stiffness:115e3}},wheel_l:{control:null,radius:.5,pos:[2.6,-1.7,-1.07],breakMax:5225,drag:5,suspension:{boneId:"gear_susp_l",range:.41,axis:[0,0,10],stiffness:115e3}}},speed:.01},hook:{pieceInput:{hook:{value:0,controlState:0}},inputBehavior:{type:"slide",speed:.1},lights:["hook"],controls:{},speed:.01},breaks:{pieceInput:{breaks:{value:0,controlState:0}},inputBehavior:{type:"slide",speed:.1},lights:["brakes"],controls:{},speed:.01},canopy:{pieceInput:{canopy:{value:0,controlState:0}},inputBehavior:{type:"toggle",speed:1},controls:{xform:"rotate",doors:{canopy:[-0.45,0,0]}},speed:.01},seat:{pieceInput:{eject:{value:0,controlState:0}},inputBehavior:{type:"button",speed:1},type:"ejection",controls:{seats:{seat:[-2.15,0,-0.5]}},speed:.4},engines:{pieceInput:{throttle:{value:0,controlState:0}},inputBehavior:{type:"slide",speed:.02,inputAnim:{bone:"throttle_r",rot:[-1,0,0]}},controls:{throttle:{throttle:.8}},mounts:[{maxThrust:77e3,afterBurner:42e3,nozzle:"nozzle_l",flame_light:"engine_l",jet_flame:e.GOO_PARTICLES.tomcat_jet,jet_smoke:e.GOO_PARTICLES.jet_smoke,posOffset:[-1.47,.3,-8],rot:[0,.08,0]},{maxThrust:77e3,afterBurner:42e3,nozzle:"nozzle_r",flame_light:"engine_r",jet_flame:e.GOO_PARTICLES.tomcat_jet,jet_smoke:e.GOO_PARTICLES.jet_smoke,posOffset:[1.47,.3,-8],rot:[0,-0.08,0]}],speed:8e-4},weapons:{pieceInput:{cannons:{value:0,controlState:0}},inputBehavior:{type:"button",speed:6},controls:{cannons:{lights:["hot_trig"]}},cannons:[{data:t.CANNONS.vulcan_20,bulletData:t.BULLET_20,posOffset:[.71,.23,8]}],speed:1}}}}),define("game/planes/tomcat/TomcatSurfaces",[],function(){return{SURFACES:{elevator:{inputBehavior:{release:1,speed:.01},controls:{elevator:{stab_inner_r:-0.5,stab_inner_l:.5,stick_pitch:.15}},speed:.05},aeilrons:{inputBehavior:{release:1,speed:.01},controls:{aeilrons:{stab_outer_r:.6,stab_outer_l:.6,stick_roll:-0.15},spoiler:{spoiler_r:1.5,spoiler_l:-1.5}},speed:.05},rudder:{inputBehavior:{release:1,speed:.01},controls:{rudder:{rudder_l:-0.8,rudder_r:-0.8,pedal_l:.5,pedal_r:.5}},speed:.05},flaps:{inputBehavior:{release:0,speed:.1},controls:{flaps:{slat_r:-0.5,slat_l:.5,flap_r:.8,flap_l:-0.8,flaps_lever:.6}},speed:.008},breaks:{inputBehavior:{release:0,speed:.1},controls:{breaks:{break_top:-1.25,break_bottom:1.05}},speed:.01},gears:{inputBehavior:{release:0,speed:.1},controls:{gears:{}},speed:.1},wing_sweep:{inputBehavior:{release:0,speed:.08},lights:["wing_sweep"],controls:{wing_sweep:{pivot_r:-0.84,pivot_l:.84,canard_r:.3,canard_l:-0.3}},speed:.003}}}}),define("game/planes/tomcat/TomcatOnScreenInput",[],function(){var e={elevator:{xMin:72,yMin:85,xMax:76,yMax:95,axis:1,max:1,min:-1,factor:.7,name:"Steer",label:""},aeilrons:{xMin:69,yMin:88,xMax:79,yMax:92,axis:0,max:1,min:-1,factor:1,name:"",label:""},rudder:{xMin:71,yMin:95,xMax:77,yMax:97,axis:0,max:1,min:-1,factor:1,name:"",label:""},trim_elevator:{xMin:83,yMin:87,xMax:85,yMax:95,axis:1,max:.5,min:-0.5,factor:.3,name:"Trim",label:""},trim_aeilrons:{xMin:80,yMin:90,xMax:88,yMax:92,axis:0,max:.5,min:-0.5,factor:.3,name:"",label:""},trim_rudder:{xMin:81,yMin:95,xMax:87,yMax:96,axis:0,max:.5,min:-0.5,factor:.3,name:"",label:""}},t={elevator:{xMin:47,yMin:65,xMax:53,yMax:85,axis:1,max:1,min:-1,factor:.7,name:"Elevator",label:"Pitch"},aeilrons:{xMin:41,yMin:71,xMax:59,yMax:79,axis:0,max:1,min:-1,factor:1,name:"Aeilrons",label:"Roll"},rudder:{xMin:42,yMin:85,xMax:58,yMax:88,axis:0,max:1,min:-1,factor:1,name:"Rudder",label:"Yaw"}},n={trim_elevator:{xMin:58,yMin:67,xMax:63,yMax:87,axis:1,max:.5,min:-0.5,factor:.3,name:"Pitch",label:"Trim"},trim_aeilrons:{xMin:52,yMin:73,xMax:69,yMax:81,axis:0,max:.5,min:-0.5,factor:.3,name:"Roll",label:"Trim"},trim_rudder:{xMin:55,yMin:87,xMax:66,yMax:90,axis:0,max:.5,min:-0.5,factor:.3,name:"Yaw",label:"Trim"}},r={throttle:{xMin:27,yMin:62,xMax:33,yMax:70,axis:1,max:1,min:0,factor:1,name:"Engines",label:"Throttle"},flaps:{xMin:21,yMin:62,xMax:26,yMax:72,axis:1,max:1,min:0,factor:1,name:"Flaps",label:"Angle"},breaks:{xMin:15,yMin:62,xMax:20,yMax:72,axis:1,max:1,min:0,factor:1,name:"Brake",label:"State"},wing_sweep:{xMin:7,yMin:65,xMax:14,yMax:71,axis:1,max:1,min:0,factor:1,name:"Wing",label:"Sweep"},wing_smoke:{xMin:29,yMin:76,xMax:33,yMax:78,axis:2,max:1,min:0,factor:100,name:"Smoke",label:""},debug_mechanics:{xMin:6,yMin:76,xMax:10,yMax:78,axis:2,max:1,min:0,factor:1,name:"Debug",label:""}},i={gears:{xMin:18,yMin:52,xMax:23,yMax:63,axis:2,max:1,min:0,factor:80,name:"Gear",label:"State"},hook:{xMin:12,yMin:52,xMax:17,yMax:63,axis:2,max:0,min:-1,factor:80,name:"Hook",label:"State"},canopy:{xMin:7,yMin:55,xMax:11,yMax:66,axis:2,max:1,min:0,factor:80,name:"Canopy",label:"State"}},s={formation_lights:{xMin:90,yMin:68,xMax:93,yMax:73,axis:1,max:1,min:.1,factor:1,name:"Form",label:"Light"},formation_mode:{xMin:90,yMin:62,xMax:93,yMax:65,axis:0,max:1,min:-1,factor:1,name:"Mode",label:""},position_lights:{xMin:85,yMin:68,xMax:88,yMax:73,axis:1,max:1,min:.1,factor:1,name:"Pos",label:"Light"},position_mode:{xMin:85,yMin:62,xMax:88,yMax:65,axis:0,max:1,min:-1,factor:1,name:"Mode",label:""},collision_lights:{xMin:80,yMin:68,xMax:83,yMax:73,axis:1,max:1,min:.1,factor:1,name:"Coll",label:"Light"},collision_mode:{xMin:80,yMin:62,xMax:83,yMax:65,axis:0,max:1,min:-1,factor:1,name:"Mode",label:""},taxi_lights:{xMin:75,yMin:68,xMax:78,yMax:73,axis:1,max:1,min:.1,factor:1,name:"Taxi",label:"Light"},taxi_mode:{xMin:75,yMin:62,xMax:78,yMax:65,axis:0,max:1,min:-1,factor:1,name:"Mode",label:""}},o={screen_intensity:{xMin:86,yMin:38,xMax:90,yMax:50,axis:1,max:.9,min:0,factor:1,name:"Master",label:"Brt"},hud_intensity:{xMin:82,yMin:40,xMax:85,yMax:50,axis:1,max:.9,min:0,factor:1,name:"Hud",label:"Brt"},hdd_intensity:{xMin:78,yMin:40,xMax:81,yMax:50,axis:1,max:.9,min:0,factor:1,name:"HDD",label:"Brt"},cockpit_lights:{xMin:91,yMin:42,xMax:94,yMax:50,axis:1,max:1,min:0,factor:1,name:"Inst",label:"Light"},cockpit_mode:{xMin:91,yMin:37,xMax:94,yMax:40,axis:0,max:1,min:-1,factor:1,name:"Mode",label:""}},u=function(){this.guiMainStateId="tomcat_controls",this.widgets=[{controls:e}],this.menus=[{closed:{name:"Steering",xMin:41,yMin:92,xMax:49,yMax:96},active:{name:"Steering",xMin:39,yMin:62,xMax:61,yMax:95},controls:t},{closed:{name:"Trim",xMin:57,yMin:91,xMax:65,yMax:95},active:{name:"Trim",xMin:50,yMin:62,xMax:72,yMax:95},controls:n},{closed:{name:"Flight",xMin:14,yMin:74,xMax:21,yMax:78},active:{name:"Flight",xMin:5,yMin:59,xMax:34,yMax:79},controls:r},{closed:{name:"Landing",xMin:13,yMin:64,xMax:21,yMax:68},active:{name:"Landing",xMin:5,yMin:49,xMax:24,yMax:69},controls:i},{closed:{name:"Lights",xMin:82,yMin:55,xMax:90,yMax:59},active:{name:"Lights",xMin:73,yMin:54,xMax:95,yMax:75},controls:s},{closed:{name:"Cockpit",xMin:82,yMin:50,xMax:91,yMax:54},active:{name:"Cockpit",xMin:76,yMin:34,xMax:96,yMax:55},controls:o}]};return u}),define("game/planes/tomcat/TomcatWings",["game/world/Curves"],function(e){var t=.06,n=.1,r=8,i=18,s=20;return{WINGS:{controls:{elevator:{value:0,controlState:0},aeilrons:{value:0,controlState:0},rudder:{value:0,controlState:0},trim_elevator:{value:0,controlState:0},trim_aeilrons:{value:0,controlState:0},trim_rudder:{value:0,controlState:0},flaps:{value:0,controlState:0},breaks:{value:0,controlState:0},auto_trim:{value:0,controlState:0},wing_smoke:{value:0,controlState:0},wing_sweep:{value:0,controlState:0},reset_trim:{value:0,controlState:0},debug_mechanics:{value:0,controlState:0}},shapes:{fuselageMid:{pos:[0,.6,0],size:[3.4,.4,6.1],rot:[.003,0,0],stallAngle:[1.3,1,1],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:t},fuselageTip:{pos:[0,-0.4,7.8],size:[1.2,.6,4.8],rot:[0,0,0],stallAngle:[1.4,1,1],liftCurve:e.WINGS.cone,stallLiftCoeff:[.5,0,0],formDragCoeff:t},fuselageForeR:{pos:[1.5,.5,3.1],size:[2.6,.1,2.5],rot:[.001,0,0],stallAngle:[.9,1,1],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:t},fuselageForeL:{pos:[-1.5,.5,3.1],size:[2.6,.1,2.5],rot:[.001,0,0],stallAngle:[.9,1,1],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:t},fuselageAft:{pos:[0,.2,-4.1],size:[3.2,.4,4],rot:[.001,0,0],stallAngle:[.8,1,1],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:t},mainInnerRight:{controls:{wing_sweep:[-0.01,-0.3,0]},pos:[2.4,.9,.7],size:[2.3,.05,3.2],rot:[-0.005,.35,0],stallAngle:[.55,.3,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[i,0,0],formDragCoeff:t},mainInnerLeft:{controls:{wing_sweep:[-0.01,.3,0]},pos:[-2.4,.9,.7],size:[2.3,.05,3.2],rot:[-0.005,-0.35,0],stallAngle:[.55,.3,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[i,0,0],formDragCoeff:t},mainRight:{controls:{wing_sweep:[.1,1.1,0]},pos:[4.4,.6,-0.9],size:[7.5,.1,3.8],rot:[-0.1,.35,0],stallAngle:[.55,.3,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[i,0,0],formDragCoeff:t},mainLeft:{controls:{wing_sweep:[.1,-1.1,0]},pos:[-4.4,.6,-0.9],size:[7.5,.1,3.8],rot:[-0.1,-0.35,0],stallAngle:[.55,.3,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[i,0,0],formDragCoeff:t},flapRight:{controls:{flaps:[-0.5,0,0]},pos:[2.5,.9,-1.2],size:[3.8,.05,2.8],rot:[0,.1,0],stallAngle:[1.2,.7,.2],liftCurve:e.WINGS.rudder,stallLiftCoeff:[s,0,0],formDragCoeff:t},flapLeft:{controls:{flaps:[-0.5,0,0]},pos:[-2.5,.9,-1.2],size:[3.8,.05,2.8],rot:[0,-0.1,0],stallAngle:[1.2,.7,.2],liftCurve:e.WINGS.rudder,stallLiftCoeff:[s,0,0],formDragCoeff:t},aeilronRight:{controls:{aeilrons:[.5,0,0],elevator:[.5,0,0]},pos:[4,.15,-7.2],size:[3,.1,2.8],rot:[0,.4,0],stallAngle:[.9,.4,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:t},aeilronLeft:{controls:{aeilrons:[-0.5,0,0],elevator:[.5,0,0]},pos:[-4,.15,-7.2],size:[3,.1,2.8],rot:[0,-0.4,0],stallAngle:[.9,.4,.2],liftCurve:e.WINGS.wing,stallLiftCoeff:[r,0,0],formDragCoeff:t},break_up:{controls:{breaks:[.8,0,0]},pos:[0,.6,-6.1],size:[2,.15,2],rot:[0,0,0],stallAngle:[1.9,1,1],liftCurve:e.WINGS.rudder,stallLiftCoeff:[i,0,0],formDragCoeff:t},break_down:{controls:{breaks:[-0.8,0,0]},pos:[0,-0.6,-6.1],size:[2,.15,2],rot:[0,0,0],stallAngle:[1.9,1,1],liftCurve:e.WINGS.rudder,stallLiftCoeff:[i,0,0],formDragCoeff:t},rudder_r:{controls:{rudder:[-0.4,0,0]},pos:[1.8,2.2,-7.9],size:[2.5,.14,.6],rot:[0,0,-Math.PI/2],stallAngle:[1.2,0,0],liftCurve:e.WINGS.rudder,stallLiftCoeff:[0,i,0],formDragCoeff:t},rudder_l:{controls:{rudder:[-0.4,0,0]},pos:[-1.8,2.2,-7.9],size:[2.5,.14,.6],rot:[0,0,-Math.PI/2],stallAngle:[1.2,0,0],liftCurve:e.WINGS.rudder,stallLiftCoeff:[0,i,0],formDragCoeff:t},vert_stab_R:{pos:[1.8,1.8,-6.7],size:[3.2,.1,2.1],rot:[0,0,-Math.PI/2],stallAngle:[1,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,i,0],formDragCoeff:t},vert_stab_L:{pos:[-1.8,1.8,-6.7],size:[3.2,.1,2.1],rot:[0,0,-Math.PI/2],stallAngle:[1,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,i,0],formDragCoeff:t},vert_skid_R:{pos:[1.5,-0.8,-0.01],size:[.1,.1,1.3],rot:[0,0,-Math.PI/2],stallAngle:[1,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,n,0],formDragCoeff:t},vert_skid_L:{pos:[-1.5,-0.8,-0.01],size:[.1,.1,1.3],rot:[0,0,-Math.PI/2],stallAngle:[1,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,n,0],formDragCoeff:t},vert_lift:{pos:[0,-0.1,-0.2],size:[1.4,.1,8],rot:[0,0,-Math.PI/2],stallAngle:[.7,0,0],liftCurve:e.WINGS.stab,stallLiftCoeff:[0,i,0],formDragCoeff:t}}}}}),define("game/planes/tomcat/TomcatLights",[],function(){return{LIGHTS:{meshData:[{meshEntityName:"lights"}],feedback:{off:[0,301,4,4]},patterns:[[1],[0,0,0,0,0,.5,1,1,1,.5,0,0,0,0,0,.5,1,1,1,.5,0],[0,0,0,0,.1,1,.3,.1,0,0,.1,1,.3,.1,0,0,0,0]],controls:{collision_mode:{value:-0.5,controlState:0},collision_lights:{value:.7,controlState:0},taxi_mode:{value:-1,controlState:0},taxi_lights:{value:1,controlState:0},position_mode:{value:.3,controlState:0},position_lights:{value:.7,controlState:0},formation_mode:{value:-1,controlState:0},formation_lights:{value:.4,controlState:0},cockpit_mode:{value:-0.9,controlState:0},cockpit_lights:{value:.95,controlState:0}},systems:{formation:{formation:{meshData:0,txcoords:[44,286,39,12]}},position:{wing_r:{meshData:0,txcoords:[25,301,9,8]},glove_l:{meshData:0,txcoords:[15,310,9,8]},wing_l:{meshData:0,txcoords:[25,310,9,8]},glove_r:{meshData:0,txcoords:[15,301,9,8]},rear_l:{meshData:0,txcoords:[45,301,9,8]}},collision:{collision_l:{meshData:0,txcoords:[35,310,9,8]},coll_low_r:{meshData:0,txcoords:[5,301,9,8]},rear_r:{meshData:0,txcoords:[65,301,9,8]},coll_low_l:{meshData:0,txcoords:[5,310,9,8]}},taxi:{nose:{meshData:0,txcoords:[45,310,9,8]}},cockpit:{seam_lock:{meshData:0,txcoords:[0,0,82,15]},collision:{meshData:0,txcoords:[0,16,82,15]},hot_trig:{meshData:0,txcoords:[0,35,82,15]},r_fire:{meshData:0,txcoords:[0,53,65,17]},l_fire:{meshData:0,txcoords:[0,73,65,17]},adl_ac:{meshData:0,txcoords:[0,92,78,14]},landing_chk:{meshData:0,txcoords:[0,106,78,15]},acl_ready:{meshData:0,txcoords:[0,123,78,15]},ap_cflr:{meshData:0,txcoords:[0,138,78,16]},cmd_control:{meshData:0,txcoords:[0,155,78,16]},ten_seconds:{meshData:0,txcoords:[0,171,78,14]},tilt:{meshData:0,txcoords:[0,186,78,14]},voice:{meshData:0,txcoords:[0,202,78,14]},blank1:{meshData:0,txcoords:[0,217,78,14]},blank2:{meshData:0,txcoords:[0,232,78,14]},ap_hef:{meshData:0,txcoords:[0,247,78,15]},wave_off:{meshData:0,txcoords:[81,92,78,14]},wing_sweep:{meshData:0,txcoords:[81,106,78,15]},reduce_speed:{meshData:0,txcoords:[81,123,78,15]},blank3:{meshData:0,txcoords:[81,138,78,16]},alt_low:{meshData:0,txcoords:[81,155,78,16]},hig_rate:{meshData:0,txcoords:[160,60,78,14]},low_rate:{meshData:0,txcoords:[160,80,41,16]},cool_on:{meshData:0,txcoords:[160,100,41,16]},cool_off:{meshData:0,txcoords:[160,120,41,16]},msl_prep_on:{meshData:0,txcoords:[160,140,41,16]},msl_prep_off:{meshData:0,txcoords:[160,160,41,16]},norm:{meshData:0,txcoords:[160,211,42,16]},brsit:{meshData:0,txcoords:[160,231,42,16]},ecm_1:{meshData:0,txcoords:[204,59,20,11]},ecm_2:{meshData:0,txcoords:[204,72,20,11]},ecm_3:{meshData:0,txcoords:[204,84,20,11]},master_caution:{meshData:0,txcoords:[222,66,88,18]},wheels:{meshData:0,txcoords:[222,116,56,20]},brakes:{meshData:0,txcoords:[222,138,56,20]},acls_ap:{meshData:0,txcoords:[222,162,56,20]},nws_enga:{meshData:0,txcoords:[222,187,56,20]},auto_throt:{meshData:0,txcoords:[222,211,56,20]},aoa_ind_top:{meshData:0,txcoords:[281,113,20,22]},aoa_ind_mid:{meshData:0,txcoords:[281,136,20,22]},aoa_ind_low:{meshData:0,txcoords:[281,160,20,22]},pitch_1:{meshData:0,txcoords:[332,120,45,12]},roll_1:{meshData:0,txcoords:[377,120,45,12]},yaw_op:{meshData:0,txcoords:[422,120,45,12]},xx_1:{meshData:0,txcoords:[467,120,45,12]},pitch_2:{meshData:0,txcoords:[332,132,45,12]},roll_2:{meshData:0,txcoords:[377,132,45,12]},yaw_out:{meshData:0,txcoords:[422,132,45,12]},xx_2:{meshData:0,txcoords:[467,132,45,12]},x_2:{meshData:0,txcoords:[332,144,45,12]},y_2:{meshData:0,txcoords:[377,144,45,12]},z_2:{meshData:0,txcoords:[422,144,45,12]},yy_1:{meshData:0,txcoords:[467,144,45,12]},x_1:{meshData:0,txcoords:[332,156,45,12]},y_1:{meshData:0,txcoords:[377,156,45,12]},z_1:{meshData:0,txcoords:[422,156,45,12]},yy_2:{meshData:0,txcoords:[467,156,45,12]},xx_12:{meshData:0,txcoords:[332,167,45,11]},yy_12:{meshData:0,txcoords:[377,167,45,11]},zz_12:{meshData:0,txcoords:[422,167,45,11]},yx_12:{meshData:0,txcoords:[467,167,45,11]},xx_22:{meshData:0,txcoords:[332,178,45,12]},yy_22:{meshData:0,txcoords:[377,178,45,12]},zz_22:{meshData:0,txcoords:[422,178,45,12]},yx_22:{meshData:0,txcoords:[467,178,45,12]},xx_33:{meshData:0,txcoords:[332,190,45,12]},yy_33:{meshData:0,txcoords:[377,190,45,12]},zz_33:{meshData:0,txcoords:[422,190,45,12]},yx_33:{meshData:0,txcoords:[467,190,45,12]},xx_44:{meshData:0,txcoords:[332,202,45,12]},yy_44:{meshData:0,txcoords:[377,202,45,12]},zz_44:{meshData:0,txcoords:[422,202,45,12]},yx_44:{meshData:0,txcoords:[467,202,45,12]},xx_55:{meshData:0,txcoords:[332,214,45,12]},yy_55:{meshData:0,txcoords:[377,214,45,12]},zz_55:{meshData:0,txcoords:[422,214,45,12]},yx_55:{meshData:0,txcoords:[467,214,45,12]},xx_66:{meshData:0,txcoords:[218,0,45,12]},yy_66:{meshData:0,txcoords:[263,0,45,12]},zz_66:{meshData:0,txcoords:[308,0,45,12]},yx_66:{meshData:0,txcoords:[353,0,45,12]},xx_77:{meshData:0,txcoords:[218,12,45,12]},yy_77:{meshData:0,txcoords:[263,12,45,12]},zz_77:{meshData:0,txcoords:[308,12,45,12]},yx_77:{meshData:0,txcoords:[353,12,45,12]},xx_88:{meshData:0,txcoords:[218,24,45,12]},yy_88:{meshData:0,txcoords:[263,24,45,12]},zz_88:{meshData:0,txcoords:[308,24,45,12]},yx_88:{meshData:0,txcoords:[353,24,45,12]},xx_99:{meshData:0,txcoords:[218,36,45,12]},yy_99:{meshData:0,txcoords:[263,36,45,12]},zz_99:{meshData:0,txcoords:[308,36,45,12]},yx_99:{meshData:0,txcoords:[353,36,45,12]}},engines:{engine_l:{meshData:0,txcoords:[6,319,19,15]},engine_r:{meshData:0,txcoords:[16,319,19,15]}}}}}}),define("game/planes/tomcat/TomcatScreens",["game/GameConfiguration"],function(e){return{SCREENS:{meshData:[{meshEntityName:"lights"}],displays:{vdi:{mapcoords:[414,418,230,226],instruments:{vdi_video:{script:"VideoPlayer",meshIndex:0,txcoords:[414,418,230,226],sources:{video:[0,0,256,128]},channel:e.VIDEOS.channels.vdi},vdi_horizon:{script:"VdiLadder",meshIndex:0,txcoords:[414,418,230,226],sources:{up:[428,30,60,6],down:[428,75,60,6],origin:[442,42,32,7],o_line:[315,418,20,1],flat:[345,417,140,3]}},vdi_compass:{script:"CompassTape",meshIndex:0,lines:7,txcoords:[411,350,197,187],sources:{dots:[480,0,32,6],0:[397,0,7,11],1:[405,0,7,11],2:[413,0,7,11],3:[421,0,7,11],4:[429,0,7,11],5:[437,0,7,11],6:[445,0,7,11],7:[453,0,7,11],8:[461,0,7,11],9:[469,0,7,11]}}}},hsi:{mapcoords:[137,416,162,198],instruments:{hsi_video:{script:"VideoPlayer",meshIndex:0,txcoords:[137,416,162,198],sources:{video:[0,0,256,128]},channel:e.VIDEOS.channels.hsi},hsi_rotation:{script:"HsiRotation",meshIndex:0,txcoords:[137,416,162,198],sources:{circles:[94,369,90,90]}},hsi_compass:{script:"CompassTape",meshIndex:0,lines:7,txcoords:[139,335,161,27],sources:{dots:[480,0,32,6],0:[397,0,7,11],1:[405,0,7,11],2:[413,0,7,11],3:[421,0,7,11],4:[429,0,7,11],5:[437,0,7,11],6:[445,0,7,11],7:[453,0,7,11],8:[461,0,7,11],9:[469,0,7,11]}}}},hud:{mapcoords:[452,59,121,119],instruments:{hud_video:{script:"VideoPlayer",meshIndex:0,txcoords:[452,59,121,119],sources:{video:[0,0,256,128]},channel:e.VIDEOS.channels.hud},hud_horizon:{script:"HudLadder",meshIndex:0,txcoords:[452,59,121,119],sources:{flat:[428,54,60,5],up:[428,31,60,5],down:[428,75,60,5],origin:[440,42,36,5]}},hud_compass:{script:"CompassTape",meshIndex:0,lines:5,txcoords:[452,17,121,110],sources:{dots:[480,0,32,6],0:[397,0,7,11],1:[405,0,7,11],2:[413,0,7,11],3:[421,0,7,11],4:[429,0,7,11],5:[437,0,7,11],6:[445,0,7,11],7:[453,0,7,11],8:[461,0,7,11],9:[469,0,7,11]}},hud_altimeter:{script:"ScreenDigits",sourceValue:"altimeter",meshIndex:0,txcoords:[412,105,114,110],sources:{0:[397,0,7,11],1:[405,0,7,11],2:[413,0,7,11],3:[421,0,7,11],4:[429,0,7,11],5:[437,0,7,11],6:[445,0,7,11],7:[453,0,7,11],8:[461,0,7,11],9:[469,0,7,11]}},hud_speed:{script:"ScreenDigits",sourceValue:"ground_speed",meshIndex:0,txcoords:[412,116,114,110],sources:{0:[397,0,7,11],1:[405,0,7,11],2:[413,0,7,11],3:[421,0,7,11],4:[429,0,7,11],5:[437,0,7,11],6:[445,0,7,11],7:[453,0,7,11],8:[461,0,7,11],9:[469,0,7,11]}},climb_rate:{script:"RulerGauge",sourceValue:"climb_indicator",meshIndex:0,scaleFactor:2,xOffset:10,txcoords:[408,54,15,50],sources:{ruler:[407,29,15,50],arrow:[422,51,4,7]}},aoa_z:{meshIndex:0,script:"RulerGauge",sourceValue:"aoa_indicator",scaleFactor:160,xOffset:-10,txcoords:[502,54,8,48],sources:{ruler:[496,34,8,44],arrow:[491,50,4,8]}}}}}}}}),define("game/planes/tomcat/TomcatData",["game/planes/tomcat/TomcatInstruments","game/planes/tomcat/TomcatSystems","game/planes/tomcat/TomcatSurfaces","game/planes/tomcat/TomcatOnScreenInput","game/planes/tomcat/TomcatWings","game/planes/tomcat/TomcatLights","game/planes/tomcat/TomcatScreens","game/GameConfiguration","game/ModelDefinitions"],function(e,t,n,r,i,s,o,u,a){return{TOMCAT:{modelPath:u.GOO_PROJECTS.tomcat.entityIds.tomcat_skinned,gooProjectUrl:u.GOO_PROJECTS.tomcat.projectPath,configs:{dataKeys:["tomcat_control_surface_data","tomcat_instruments_data","tomcat_wings_data","tomcat_control_systems_data","tomcat_screen_systems_data","tomcat_light_mapping_data","tomcat_systems_data"],display_settings:"display_settings",instruments:"instruments",light_systems:"light_systems",control_settings:"control_settings",control_surfaces:"control_surfaces",piece_systems:"piece_systems",wing_shapes:"wing_shapes"},dimensions:{massEmpty:14845,massMax:28375,weightDistribution:[6,2,7],length:19,wingspan:18.23,pilotSeatPos:[0,.85,6.52],wingAngle:.2,height:5.75},hitPoints:300,physicalShapes:[{partId:"fuselage",posOffset:[0,0,0],radius:5},{partId:"fuselage",posOffset:[0,0,4],radius:5},{partId:"fuselage",posOffset:[0,0,-4],radius:5},{partId:"wing",posOffset:[4,0,-4],radius:5},{partId:"wing",posOffset:[-4,0,-4],radius:5}],physicalRadius:30,keyBindings:u.KEY_BINDINGS.plane,onScreenInput:{guiMainStateId:"tomcat_controls"},wing_smoke:[[-5.8,0,-2],[5.8,0,-2]]}}}),define("game/planes/PlaneData",["game/planes/tunnan/TunnanData","game/planes/tomcat/TomcatData","game/GameConfiguration","game/ModelDefinitions","game/weapons/WeaponData"],function(e,t,n,r,i){return{TOMCAT:t.TOMCAT,TUNNAN:e.TUNNAN,DRAKEN:{modelPath:"draken",dimensions:{massEmpty:7245,massMax:11875,weightDistribution:[2,2,3],length:15.3,wingspan:9.43,pilotSeatPos:[0,-0.1,4.52],wingAngle:.2,height:3.9},hitPoints:300,physicalShapes:[{partId:"fuselage",posOffset:[0,0,0],radius:5},{partId:"fuselage",posOffset:[0,0,4],radius:5},{partId:"fuselage",posOffset:[0,0,-4],radius:5},{partId:"wing",posOffset:[4,0,-4],radius:5},{partId:"wing",posOffset:[-4,0,-4],radius:5}],physicalRadius:30,keyBindings:n.KEY_BINDINGS.plane,gooProjectUrl:n.GOO_PROJECTS.draken.projectPath,piecePath:n.GOO_PROJECTS.draken.draken,contrail_effect:r.GOO_PARTICLES.wing_smoke,uiPages:["UI_TUNNAN","UI_AIR_PARAMS","UI_BOTTOM_BAR"],wing_smoke:[[-4.5,-0.2,-2],[4.5,-0.2,-2]],instruments:{},measurements:{throttle:1,speed:1,altitude:1,airflowx:1,airflowy:1,airflowz:1,gForce:1},wings:{fuselageFore:{pos:[0,-0.2,2],size:[1.2,1.2,1.2],rot:[.02,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[4.5,0,0],formDragCoeff:.05},fuselageMid:{pos:[0,-0.2,0],size:[.7,.01,3],rot:[.05,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[4.5,0,0],formDragCoeff:.1},fuselageCore:{pos:[0,-0.2,0],size:[1.4,1.4,1.4],rot:[0,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[3.5,0,0],formDragCoeff:.05},fuselageAft:{pos:[0,-0.2,-1.5],size:[.6,.6,.6],rot:[.03,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[2.5,0,0],formDragCoeff:.05},mainInnerFore:{pos:[0,.24,.41],size:[3.7,.1,8.6],rot:[.004,0,0],stallAngle:[.4,.5,.2],stallLiftCoeff:[35,0,0],formDragCoeff:.001},mainOuterRight:{pos:[4,.2,-2.8],size:[3.1,.05,1.8],rot:[.002,.72,0],stallAngle:[.45,.3,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.001},mainOuterLeft:{pos:[-4,.2,-2.8],size:[3.1,.05,1.8],rot:[.002,-0.72,0],stallAngle:[.45,.3,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.001},aeilronRight:{controls:{aeilrons:[.3,0,0]},pos:[3,.15,-4.2],size:[3,.05,.6],rot:[0,.1,0],stallAngle:[.4,.4,.2],stallLiftCoeff:[12,0,0],formDragCoeff:.002},aeilronLeft:{controls:{aeilrons:[-0.3,0,0]},pos:[-3,.15,-4.3],size:[3,.05,.6],rot:[0,-0.1,0],stallAngle:[.4,.4,.2],stallLiftCoeff:[12,0,0],formDragCoeff:.002},elevator:{controls:{elevator:[.8,0,0]},pos:[0,.2,-4.5],size:[3.6,.04,1],rot:[0,0,0],stallAngle:[1.5,.4,.3],stallLiftCoeff:[12,0,0],formDragCoeff:.001},rudder:{controls:{rudder:[-0.4,0,0]},pos:[0,1.9,-4.3],size:[1.6,.01,.8],rot:[0,0,-Math.PI/2],stallAngle:[1.45,.5,1],stallLiftCoeff:[8,0,0],formDragCoeff:.01}},surfaces:{elevator:{inputBehavior:{release:1,speed:.1},controls:{elevator:{flap_r:-0.5,flap_l:.5},aeilrons:{aeilron_r:-0.5,aeilron_l:.5}},speed:.03},aeilrons:{inputBehavior:{release:1,speed:.1},controls:{aeilrons:{aeilron_r:.5,aeilron_l:.5},elevator:{flap_r:.5,flap_l:.5}},speed:.03},rudder:{inputBehavior:{release:1,speed:.1},controls:{rudder:{rudder:-0.8}},speed:.02}},systems:{auto_trim:{inputBehavior:{type:"toggle",speed:1},speed:1},gears:{inputBehavior:{type:"toggle",speed:1},controls:{doors:{door_nose_r:[-2.7,0,0],door_nose_l:[2.7,0,0],door_l:[1.4,0,0],door_r:[-1.4,0,0],door_l_inner:[-1.4,0,0],door_r_inner:[1.4,0,0]},stands:{gear_nose:[1.4,0,0],gear_r:[1.3,0,0],gear_l:[-1.3,0,0]}},wheels:{wheel_nose:{control:"rudder",radius:.3,pos:[0,-1.28,3],breakMax:555.02,drag:5,suspension:{boneId:"susp_nose",range:.12,axis:[0,1,0],stiffness:22550}},wheel_r:{control:null,radius:-0.5,pos:[-1.9,-1.02,-0.5],breakMax:9525.05,drag:5,suspension:{boneId:"susp_r",range:.12,axis:[0,1,0],stiffness:75e3}},wheel_l:{control:null,radius:.5,pos:[1.9,-1.02,-0.5],breakMax:9525.05,drag:5,suspension:{boneId:"susp_l",range:.12,axis:[0,-1,0],stiffness:75e3}}},speed:.01},breaks:{inputBehavior:{type:"slide",speed:.1},controls:{},speed:.01},canopy:{inputBehavior:{type:"toggle",speed:1},controls:{xform:"rotate",doors:{canopy:[1.05,0,0]}},speed:.01},seat:{inputBehavior:{type:"button",speed:1},type:"ejection",controls:{seats:{}},speed:.4},engines:{inputBehavior:{type:"slide",speed:.1},controls:{throttle:{}},mounts:[{maxThrust:73e3,jet_flame:r.GOO_PARTICLES.basic_jet,jet_smoke:r.GOO_PARTICLES.jet_smoke,posOffset:[0,.2,-6]}],speed:.005},weapons:{inputBehavior:{type:"button",speed:1},controls:{cannons:{}},cannons:[{data:i.CANNONS.hispano_20,bulletData:i.BULLET_20,posOffset:[1.65,.27,1.8]},{data:i.CANNONS.hispano_20,bulletData:i.BULLET_20,posOffset:[-1.65,.27,1.8]}],speed:2}}},COUGAR:{modelPath:"cougar_f9f",dimensions:{massEmpty:7845,massMax:11375,weightDistribution:[2,2,3],length:12,wingspan:11.23,pilotSeatPos:[0,.1,2.22],wingAngle:.2,height:3.75},hitPoints:300,physicalShapes:[{partId:"fuselage",posOffset:[0,0,0],radius:5},{partId:"fuselage",posOffset:[0,0,4],radius:5},{partId:"fuselage",posOffset:[0,0,-4],radius:5},{partId:"wing",posOffset:[4,0,-4],radius:5},{partId:"wing",posOffset:[-4,0,-4],radius:5}],physicalRadius:30,keyBindings:n.KEY_BINDINGS.plane,gooProjectUrl:n.GOO_PROJECTS.cougar_f9f.projectPath,piecePath:n.GOO_PROJECTS.cougar_f9f.cougar_f9f,contrail_effect:r.GOO_PARTICLES.wing_smoke,uiPages:["UI_TUNNAN","UI_AIR_PARAMS","UI_BOTTOM_BAR"],wing_smoke:[[-5.8,-0.5,-3],[5.8,-0.5,-3]],instruments:{},measurements:{throttle:1,speed:1,altitude:1,airflowx:1,airflowy:1,airflowz:1,gForce:1},wings:{fuselageFore:{pos:[0,-0.2,2],size:[1.2,1.2,1.2],rot:[.02,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[4.5,0,0],formDragCoeff:.05},fuselageMid:{pos:[0,-0.2,0],size:[.7,.01,3],rot:[.05,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[4.5,0,0],formDragCoeff:.1},fuselageCore:{pos:[0,-0.2,0],size:[1.4,1.4,1.4],rot:[0,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[3.5,0,0],formDragCoeff:.05},fuselageAft:{pos:[0,-0.2,-1.5],size:[.6,.6,.6],rot:[.03,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[2.5,0,0],formDragCoeff:.05},mainInnerRight:{pos:[1.3,.24,.41],size:[2.7,.1,2.6],rot:[.004,.65,0],stallAngle:[.5,.5,.2],stallLiftCoeff:[75,0,0],formDragCoeff:.001},mainInnerLeft:{pos:[-1.3,.24,.41],size:[2.7,.05,2.6],rot:[.004,-0.65,0],stallAngle:[.5,.5,.2],stallLiftCoeff:[75,0,0],formDragCoeff:.001},mainOuterRight:{pos:[4,.2,-0.8],size:[3.8,.05,1.8],rot:[.002,.62,0],stallAngle:[.45,.3,.2],stallLiftCoeff:[52,0,0],formDragCoeff:.001},mainOuterLeft:{pos:[-4,.2,-0.8],size:[3.8,.05,1.8],rot:[.002,-0.62,0],stallAngle:[.45,.3,.2],stallLiftCoeff:[52,0,0],formDragCoeff:.001},flapRight:{controls:{flaps:[-1.1,0,0]},pos:[1.6,.265,-0.05],size:[1.8,.1,1.4],rot:[0,.5,0],stallAngle:[1.2,.7,.2],stallLiftCoeff:[27,0,0],formDragCoeff:.002},flapLeft:{controls:{flaps:[-1.1,0,0]},pos:[-1.6,.265,-0.05],size:[1.8,.05,1.4],rot:[0,-0.5,0],stallAngle:[1.2,.7,.2],stallLiftCoeff:[27,0,0],formDragCoeff:.002},aeilronRight:{controls:{aeilrons:[.3,0,0]},pos:[3,.15,-1.8],size:[3,.05,.5],rot:[0,.5,0],stallAngle:[.4,.4,.2],stallLiftCoeff:[32,0,0],formDragCoeff:.002},aeilronLeft:{controls:{aeilrons:[-0.3,0,0]},pos:[-3,.15,-1.8],size:[3,.05,.5],rot:[0,-0.5,0],stallAngle:[.4,.4,.2],stallLiftCoeff:[32,0,0],formDragCoeff:.002},elevator:{controls:{elevator:[.8,0,0]},pos:[0,1.1,-5.8],size:[4,.04,1.2],rot:[0,0,0],stallAngle:[1.5,.4,.3],stallLiftCoeff:[28,0,0],formDragCoeff:.001},rudder:{controls:{rudder:[-0.4,0,0]},pos:[0,1.9,-6.3],size:[1.6,.01,.8],rot:[0,0,-Math.PI/2],stallAngle:[1.45,.5,1],stallLiftCoeff:[45,0,0],formDragCoeff:.01},stabiliser:{pos:[0,1.3,-5.3],size:[2.2,.1,1.1],rot:[0,0,-Math.PI/2],stallAngle:[.7,.4,1],stallLiftCoeff:[6,0,0],formDragCoeff:.01}},surfaces:{elevator:{inputBehavior:{release:1,speed:.1},controls:{elevator:{elevator:.6}},speed:.03},aeilrons:{inputBehavior:{release:1,speed:.1},controls:{aeilrons:{aeilron_r:.5,aeilron_l:.5}},speed:.03},rudder:{inputBehavior:{release:1,speed:.1},controls:{rudder:{rudder:-0.8}},speed:.02},flaps:{inputBehavior:{release:0,speed:.1},controls:{flaps:{flap_r:1.1,flap_l:-1.1}},speed:.005}},systems:{auto_trim:{inputBehavior:{type:"toggle",speed:1},speed:1},gears:{inputBehavior:{type:"toggle",speed:1},controls:{doors:{door_nose_r:[-1.4,0,0],door_nose_l:[1.4,0,0],door_l:[-1.1,0,0],door_r:[1.1,0,0]},stands:{gear_nose:[-1.5,0,0],gear_right:[-1,0,0],gear_left:[1,0,0]}},wheels:{wheel_nose:{control:"rudder",radius:.3,pos:[0,-1.4,3.4],breakMax:1555.02,drag:5,suspension:{boneId:"susp_nose",range:.11,axis:[0,-1,0],stiffness:14550}},wheel_r:{control:null,radius:-0.5,pos:[-1.4,-1.33,-0.17],breakMax:3025.05,drag:5,suspension:{boneId:"susp_right",range:.11,axis:[0,-1,0],stiffness:85e3}},wheel_l:{control:null,radius:.5,pos:[1.4,-1.33,-0.17],breakMax:3025.05,drag:5,suspension:{boneId:"susp_left",range:.11,axis:[0,1,0],stiffness:85e3}}},speed:.01},breaks:{inputBehavior:{type:"slide",speed:.1},controls:{},speed:.01},canopy:{inputBehavior:{type:"toggle",speed:1},controls:{xform:"slide",doors:{canopy:[-0.05,.85,0]}},speed:.01},seat:{inputBehavior:{type:"button",speed:1},type:"ejection",controls:{seats:{seat:[-2.15,0,-0.5]}},speed:.4},engines:{inputBehavior:{type:"slide",speed:.1},controls:{throttle:{throttle:.8}},mounts:[{maxThrust:57e3,jet_flame:r.GOO_PARTICLES.basic_jet,jet_smoke:r.GOO_PARTICLES.jet_smoke,posOffset:[0,-0.1,-4]}],speed:.005},weapons:{inputBehavior:{type:"button",speed:1},controls:{cannons:{}},cannons:[{data:i.CANNONS.hispano_20,bulletData:i.BULLET_20,posOffset:[.44,-0.54,3.6]},{data:i.CANNONS.hispano_20,bulletData:i.BULLET_20,posOffset:[.32,-0.75,3.35]},{data:i.CANNONS.hispano_20,bulletData:i.BULLET_20,posOffset:[-0.32,-0.75,3.35]},{data:i.CANNONS.hispano_20,bulletData:i.BULLET_20,posOffset:[-0.44,-0.54,3.6]}],speed:2}}},B52:{modelPath:"b_52",dimensions:{massEmpty:115845,massMax:231375,weightDistribution:[21,21,21],length:47,wingspan:56.23,pilotSeatPos:[0,.9,18.72],wingAngle:.2,height:3.75},hitPoints:300,physicalShapes:[{partId:"fuselage",posOffset:[0,0,15],radius:5},{partId:"fuselage",posOffset:[0,0,7],radius:5},{partId:"fuselage",posOffset:[0,0,0],radius:5},{partId:"fuselage",posOffset:[0,0,-7],radius:5},{partId:"fuselage",posOffset:[0,0,-15],radius:5},{partId:"fuselage",posOffset:[0,0,-22],radius:5},{partId:"fuselage",posOffset:[0,0,-29],radius:5},{partId:"engine",posOffset:[19,-1.5,-2.5],radius:5},{partId:"engine",posOffset:[-19,-1.5,-2.5],radius:5},{partId:"engine",posOffset:[11,-1.5,4.5],radius:5},{partId:"engine",posOffset:[-11,-1.5,4.5],radius:5},{partId:"wing",posOffset:[12,.5,-2],radius:5},{partId:"wing",posOffset:[-12,.5,-2],radius:5},{partId:"wing",posOffset:[25,-1,-10.5],radius:5},{partId:"wing",posOffset:[-25,-1,-10.5],radius:5}],physicalRadius:50,keyBindings:n.KEY_BINDINGS.plane,gooProjectUrl:n.GOO_PROJECTS.stratofortress.projectPath,piecePath:n.GOO_PROJECTS.stratofortress.b_52,uiPages:["UI_TUNNAN","UI_AIR_PARAMS","UI_BOTTOM_BAR"],wing_smoke:[[-19,-2,-5],[19,-2,-5],[-10.5,-1.4,1.5],[10.5,-1.4,1.5]],instruments:{},measurements:{throttle:1,speed:1,altitude:1,airflowx:1,airflowy:1,airflowz:1,gForce:1},wings:{fuselageMid:{pos:[0,-0.9,2],size:[9,9,45],rot:[0,0,0],stallAngle:[.5,1,1],stallLiftCoeff:[5.5,0,0],formDragCoeff:.3},mainInnerRight:{pos:[12.3,.24,-0.41],size:[26,1,8],rot:[.02,.6,0],stallAngle:[.5,0,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.4},mainInnerLeft:{pos:[-12.3,.24,-0.41],size:[26,1,8],rot:[.02,-0.6,0],stallAngle:[.5,0,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.4},mainOuterRight:{pos:[27,.2,-11.8],size:[5.8,1.7,7],rot:[0,0,0],stallAngle:[.45,.3,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.6},mainOuterLeft:{pos:[-27,.2,-11.8],size:[5.8,1.7,7],rot:[0,0,0],stallAngle:[.45,.3,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.6},flapRight:{controls:{flaps:[-1.1,0,0]},pos:[15.6,.5,.05],size:[12.8,.1,4.4],rot:[0,0,0],stallAngle:[1.2,.7,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.2},flapLeft:{controls:{flaps:[-1.1,0,0]},pos:[-15.6,.5,.05],size:[12.8,.1,4.4],rot:[0,0,0],stallAngle:[1.2,.7,.2],stallLiftCoeff:[42,0,0],formDragCoeff:.2},aeilronRight:{controls:{aeilrons:[.3,0,0]},pos:[18,.15,-8.8],size:[8,.05,1.5],rot:[0,0,0],stallAngle:[.4,.4,.2],stallLiftCoeff:[5,0,0],formDragCoeff:.002},aeilronLeft:{controls:{aeilrons:[-0.3,0,0]},pos:[-18,.15,-8.8],size:[8,.05,1.5],rot:[0,0,0],stallAngle:[.4,.4,.2],stallLiftCoeff:[5,0,0],formDragCoeff:.002},tailplane:{pos:[0,1.1,-20.8],size:[14,.4,4.2],rot:[-0.04,0,0],stallAngle:[1.5,.4,.3],stallLiftCoeff:[42,0,0],formDragCoeff:.001},elevator:{controls:{elevator:[.8,0,0]},pos:[0,1.1,-22.8],size:[14,.04,1.2],rot:[0,0,0],stallAngle:[1.5,.4,.3],stallLiftCoeff:[32,0,0],formDragCoeff:.001},rudder:{controls:{rudder:[-0.4,0,0]},pos:[0,3.9,-23.3],size:[5,.01,1],rot:[0,0,-Math.PI/2],stallAngle:[1.45,.5,1],stallLiftCoeff:[22,0,0],formDragCoeff:.01},stabiliser:{pos:[0,1.3,-15.3],size:[5.2,.1,4.1],rot:[0,0,-Math.PI/2],stallAngle:[.7,.4,1],stallLiftCoeff:[22,0,0],formDragCoeff:.01}},surfaces:{elevator:{inputBehavior:{release:1,speed:.1},controls:{elevator:{elevator_r:-0.6,elevator_l:.6}},speed:.03},aeilrons:{inputBehavior:{release:1,speed:.1},controls:{aeilrons:{aeilron_r:.5,aeilron_l:.5}},speed:.03},rudder:{inputBehavior:{release:1,speed:.1},controls:{rudder:{rudder:-0.8}},speed:.02},flaps:{inputBehavior:{release:0,speed:.1},controls:{flaps:{flap_r_in:1.1,flap_l_in:-1.1,flap_r_out:1.1,flap_l_out:-1.1}},speed:.005}},systems:{auto_trim:{inputBehavior:{type:"toggle",speed:1},speed:1},engines:{inputBehavior:{type:"slide",speed:.1},controls:{throttle:{throttle:.8}},mounts:[{maxThrust:15e4,jet_flame:r.GOO_PARTICLES.basic_jet,jet_smoke:r.GOO_PARTICLES.jet_smoke,posOffset:[-19,-1.4,-5]},{maxThrust:15e4,jet_flame:r.GOO_PARTICLES.basic_jet,jet_smoke:r.GOO_PARTICLES.jet_smoke,posOffset:[19,-1.4,-5]},{maxThrust:15e4,jet_flame:r.GOO_PARTICLES.basic_jet,jet_smoke:r.GOO_PARTICLES.jet_smoke,posOffset:[-10.5,-1,1.5]},{maxThrust:15e4,jet_flame:r.GOO_PARTICLES.basic_jet,jet_smoke:r.GOO_PARTICLES.jet_smoke,posOffset:[10.5,-1,1.5]}],speed:.005}}},BLACKBIRD:{modelPath:"blackbird",dimensions:{massEmpty:30845,massMax:58375,weightDistribution:[2,2,2],length:11,wingspan:10.23,wingAngle:.2,height:3.75},forcePoints:{weight:[0,0,0],thrust:[0,-0.5,-5],wingLiftLeft:[3,1,-2],wingLiftRight:[-3,2,-2],elevatorLift:[0,2,-7.5],rudderYaw:[0,3,-7]},wings:{fuselage:{pos:[0,-0.04,5.1],size:[1.7,1.5,29],rot:[0,0,0],stallAngle:[.6,1,1],stallLiftCoeff:[.01,0,0],formDragCoeff:2e-4},fuselageWing:{pos:[0,-0.04,6.1],size:[3.2,.02,29],rot:[.0031,0,0],stallAngle:[.6,1,1],stallLiftCoeff:[4,0,0],formDragCoeff:.001},mainInnerRight:{pos:[3.1,-0.24,-1.41],size:[13.5,.02,4.6],rot:[.004,1.02,0],stallAngle:[.3,.5,.2],stallLiftCoeff:[12,0,0],formDragCoeff:.001},mainInnerLeft:{pos:[-3.1,-0.24,-1.41],size:[13.5,.02,4.6],rot:[.004,-1.02,0],stallAngle:[.3,.5,.2],stallLiftCoeff:[12,0,0],formDragCoeff:.001},mainEngineRight:{pos:[4.4,.2,-2],size:[1.9,1.9,11.4],rot:[.002,0,0],stallAngle:[.15,.3,.2],stallLiftCoeff:[1,0,0],formDragCoeff:.001},mainEngineLeft:{pos:[-4.4,.2,-2],size:[1.9,1.9,11.4],rot:[.002,0,0],stallAngle:[.15,.3,.2],stallLiftCoeff:[1,0,0],formDragCoeff:.001},flapRight:{controls:{elevator:[.08,0,0]},pos:[2.3,-0.15,-8.3],size:[2.4,.05,1.5],rot:[.005,-0.4,0],stallAngle:[.6,.7,.2],stallLiftCoeff:[8,0,0],formDragCoeff:.001},flapLeft:{controls:{elevator:[.08,0,0]},pos:[-2.3,-0.15,-8.3],size:[2.4,.05,1.5],rot:[.005,.4,0],stallAngle:[.6,.7,.2],stallLiftCoeff:[8,0,0],formDragCoeff:.001},aeilronRight:{controls:{aeilrons:[.1,0,0]},pos:[7,-0.15,-7.2],size:[3.3,.05,1],rot:[0,-0.4,0],stallAngle:[.6,.4,.2],stallLiftCoeff:[6,0,0],formDragCoeff:.001},aeilronLeft:{controls:{aeilrons:[-0.1,0,0]},pos:[-7,-0.15,-7.2],size:[3.3,.05,1],rot:[0,.4,0],stallAngle:[.6,.4,.2],stallLiftCoeff:[6,0,0],formDragCoeff:.001},rudderR:{controls:{rudder:[.1,0,0]},pos:[3.8,2.7,-6.8],size:[2.4,.1,3.8],rot:[0,0,0-Math.PI/2],stallAngle:[.4,.5,1],stallLiftCoeff:[12,0,0],formDragCoeff:.001},rudderL:{controls:{rudder:[.1,0,0]},pos:[-3.8,2.7,-6.8],size:[2.4,.1,3.8],rot:[0,0,0+Math.PI/2],stallAngle:[.4,.4,1],stallLiftCoeff:[4,0,0],formDragCoeff:.001}},modelDefinition:r.GOO_MODELS.tunnan,uiPage:"UI_TUNNAN",elevator:{inputBehavior:{type:"slide",speed:.1},controls:{elevator:{elevator:.6}},speed:.1},aeilrons:{inputBehavior:{type:"slide",speed:.1},controls:{aeilrons:{rightAeilron:.8,leftAeilron:.8}},speed:.07},rudder:{inputBehavior:{type:"slide",speed:.1},controls:{rudder:{rudder:-0.7}},speed:.06},flaps:{inputBehavior:{type:"toggle",speed:1},controls:{flaps:{rightFlap:1.1,leftFlap:-1.1}},speed:.01},gears:{inputBehavior:{type:"toggle",speed:1},controls:{doors:{noseGearDoorRight:-1.4,noseGearDoorLeft:1.4,leftGearDoor:1.2,rightGearDoor:-1.2},stands:{noseGear:-1.4,rightGear:-2,leftGear:2}},wheels:{noseWheel:-0.8,rightWheel:1,leftWheel:-1},speed:.01},canopy:{inputBehavior:{type:"button",speed:1},type:"slide",controls:{doors:{canopy:[-0.15,0,-0.8]}},speed:.01},seat:{inputBehavior:{type:"button",speed:1},type:"ejection",controls:{seats:{seat:[-2.15,0,-0.5]}},speed:.4},engines:{inputBehavior:{type:"slide",speed:.1},modelDefinition:r.GOO_PARTICLES.wing_smoke,controls:{jet:{flame:1}},mounts:[{maxThrust:6e5}],speed:.01},boneMap:{canopy:"bone4",noseGearRoot:"bone14",noseGear:"bone15",noseWheel:"bone16",noseGearDoorRight:"bone17",noseGearDoorLeft:"bone18",rightAeilron:"bone19",rightFlap:"bone20",leftFlap:"bone21",leftAeilron:"bone22",seat:"bone23",elevator:"bone30",rudder:"bone29",rightGearRoot:"bone6",rightGear:"bone7",rightWheel:"bone8",rightGearDoor:"bone9",leftGearRoot:"bone10",leftGearDoor:"bone11",leftGear:"bone12",leftWheel:"bone13"}}}}),define("game/characters/CharacterData",["game/GameConfiguration","game/ModelDefinitions","game/weapons/WeaponData"],function(e,t,n){var r={movement:{idle:"idle",turnLeft:"turnLeft",turnRight:"turnRight",strafeRight:"strafeRight",strafeLeft:"strafeLeft",forward:"forward",back:"back",halfStrafeRight:"halfStrafeRight",halfStrafeLeft:"halfStrafeLeft",backRight:"backRight",backLeft:"backLeft",jumpState:"jumpState"},seated:{pilotSit:"pilotSit",sit:"sit"}};return{ANIM_STATES:r,PILOT:{modelPath:e.GOO_PROJECTS.human.entityIds.pilot,dimensions:{massEmpty:2,height:1.75,mobRadius:.7,weightDistribution:[1,1,1]},hitPoints:300,physicalShapes:[{partId:"body",posOffset:[0,1,0],radius:1}],physicalRadius:5,keyBindings:"move",uiPages:[],wings:{body:{pos:[0,2,0],size:[.6,1.9,.6],rot:[0,0,0],stallAngle:[1,1,1],stallLiftCoeff:[1,1,1],formDragCoeff:.21}},gooProject:e.GOO_PROJECTS.human,piecePath:e.GOO_PROJECTS.human.pilot,instruments:{},measurements:{},animations:{moveStates:{idle:"idle",forward:"run",back:"backwards",backLeft:"back_left",backRight:"back_right",turnLeft:"turn_left",turnRight:"turn_right",strafeLeft:"strafe_left",strafeRight:"strafe_right",halfStrafeLeft:"half_strafe_left",halfStrafeRight:"half_strafe_right",jumpState:"jumpstate"},seated:{pilotSit:"pilot_sit",sit:"sit"}}}}}),define("game/world/ZoneData",[],function(){var e={big_1_1:"big_1_1",big_2_1:"big_2_1",ocean:"Open Ocean",carrier_takeoff:"Ocean Takeoff",start:"Runway Island",cove:"Cove",peak:"Peak Island"};return{ZONE_ID_LIST:e,FREEFLIGHT_ZONES:{ocean:{id:e.ocean,width:15e3,depth:15e3,height:800,pos:[0,0,0],clouds:{intensity:1},playerSpawn:{plane:{pos:[-1342,620,3280],vel:[0,1e-4,-1],rot:[0,Math.PI*0+9,0],state:0},human:{pos:[-1e3,25.75,0],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1}}},carrier_takeoff:{id:e.carrier_takeoff,width:15e3,depth:15e3,height:800,pos:[0,0,0],clouds:{intensity:1},playerSpawn:{plane:{pos:[-200,29,500],vel:[0,1e-4,.08],rot:[0,0,0],state:1},human:{pos:[-200,31,500],vel:[0,0,.001],rot:[0,0,0],state:1},carrier:{pos:[-100,0,300],vel:[0,0,.08],rot:[0,0,0]}}}},TERRAIN_ZONES:{big_1_1:{id:e.big_1_1,width:5e3,depth:5e3,height:4e3,pos:[5e3,-1e3,5500],heightData:"resources/heightmap/hf_large.png",texture1:"resources/heightmap/tx_large.jpg",tree_spread:1400,clouds:{intensity:0},playerSpawn:{plane:{pos:[2885,218.2,2652],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1},human:{pos:[2840,218.5,2528],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1},car:{pos:[2868,218.2,2372],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1}}},big_2_1:{id:e.big_2_1,width:25e3,depth:25e3,height:4e3,pos:[0,-300,-17500],heightData:"resources/heightmap/hf_large.png",texture1:"resources/heightmap/tx_large.png",tree_spread:3400,clouds:{intensity:0},playerSpawn:{plane:{pos:[2885,218.2,2652],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1},human:{pos:[2840,218.5,2528],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1},car:{pos:[2868,218.2,2372],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1}}},start:{id:e.start,width:5e3,depth:5e3,height:890,pos:[0,-200,0],heightData:window.resourcePath+"/heightmap/128_hf.png",texture1:window.resourcePath+"/heightmap/tx_start.png",tree_spread:600,clouds:{intensity:0},playerSpawn:{plane:{pos:[-3200,29,3500],vel:[0,1e-4,.08],rot:[0,0,0],state:1},human:{pos:[-3200,31,3500],vel:[0,0,.001],rot:[0,0,0],state:1},carrier:{pos:[-3100,0,3300],vel:[0,0,.08],rot:[0,0,0]}}},cove:{id:e.cove,width:5e3,depth:5e3,height:650,pos:[-7500,-137,500],heightData:"tunnan_resources/heightmap/hf_cove.png",texture1:"tunnan_resources/heightmap/tx_cove.png",tree_spread:750,clouds:{intensity:0},playerSpawn:{plane:{pos:[2885,218.2,2652],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1},human:{pos:[2840,218.5,2528],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1},car:{pos:[2868,218.2,2372],vel:[0,0,.001],rot:[0,Math.PI*.5,0],state:1}}},peak:{id:e.peak,width:5e3,depth:5e3,height:950,pos:[-5128,-350,-5128],heightData:"resources/heightmap/hf_small.png",texture1:"resources/heightmap/tx_small.png",tree_spread:650,clouds:{intensity:.3}}},SPAWN_POINTS:{pilot_runway:{humans:{PILOT:[{pos:[2824,218.2,2370],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0]}]}},air_patrol:{planes:{B52:[{pos:[3700,5e3,4300],vel:[1.04,0,-0.51],rot:[0,0,0],state:2}]}},battleship_assault:{boats:{BATTLESHIP:[{pos:[5700,0,1300],vel:[-0.02,0,-0.08],rot:[0,0,0]},{pos:[6700,0,4300],vel:[-0.02,0,-0.08],rot:[0,0,0]}],TRE_KRONOR:[{pos:[4811,0,3235],vel:[-0.07,0,.1],rot:[0,0,0]},{pos:[6811,0,-1235],vel:[-0.07,0,.1],rot:[0,0,0]},{pos:[8811,0,5235],vel:[-0.07,0,.1],rot:[0,0,0]}]}},carrier_takeoff:{boats:{BATTLESHIP_NEVADA:[{pos:[600,0,790],vel:[0,0,.08],rot:[0,0,0]},{pos:[-3700,0,3300],vel:[-0.02,0,-0.08],rot:[0,0,0]}],TRE_KRONOR:[{pos:[1200,0,-710],vel:[0,0,.08],rot:[0,0,0]},{pos:[4811,0,3235],vel:[-0.07,0,.1],rot:[0,0,0]},{pos:[-2811,0,-1235],vel:[-0.07,0,.1],rot:[0,0,0]}]}},carrier:{boats:{CARRIER:[{pos:[4850,0,2700],vel:[0,0,.08],rot:[0,0,0]}]}},ocean:{boats:{CARRIER:[{pos:[-1e3,0,0],vel:[0,0,.08],rot:[0,0,0]}]}},cougar:{planes:{COUGAR:[{pos:[2855,218.2,2390],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0],state:1}]}},draken:{planes:{DRAKEN:[{pos:[2855,218.2,2390],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0],state:1}]}},tunnan:{planes:{TUNNAN:[{pos:[2870,215.75,2515],vel:[0,1e-6,0],rot:[0,Math.PI,0],state:1}]}},tomcat:{planes:{TOMCAT:[{pos:[2840,215.75,2445],vel:[0,1e-6,0],rot:[0,Math.PI*.7,0],state:1}]}},air_base:{targets:{MONITOR_CONSOLE:[{pos:[2826.5,214,2534],vel:[0,1e-4,0],rot:[0,3.14,0],state:1},{pos:[2835.5,214,2534],vel:[0,1e-4,0],rot:[0,3.14,0],state:1},{pos:[2844.5,214,2534],vel:[0,1e-4,0],rot:[0,3.14,0],state:1},{pos:[2836,214,2506.5],vel:[0,1e-4,0],rot:[0,0,0],state:1}]}},practice_range:{targets:{GROUND_FLAT:[{pos:[1250,339.5,1185],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1340,339.5,1185],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1250,339.5,1255],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1340,339.5,1255],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1020,339.5,1315],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1420,339.5,1395],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1020,339.5,1415],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1420,339.5,1495],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1020,339.5,1515],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1420,339.5,1595],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1120,339.5,1315],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1320,339.5,1395],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1120,339.5,1415],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1320,339.5,1495],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1120,339.5,1515],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1},{pos:[1320,339.5,1595],vel:[0,1e-4,0],rot:[0,Math.PI,0],state:1}],HOUSE_BOX_30:[{pos:[1260,339.5,3330],vel:[0,1e-4,0],rot:[0,Math.PI*1.1,0],state:1},{pos:[1350,339.5,3410],vel:[0,1e-4,0],rot:[0,Math.PI*1.2,0],state:1},{pos:[1250,339.5,3510],vel:[0,1e-4,0],rot:[0,Math.PI*1.1,0],state:1},{pos:[1135,339.5,3505],vel:[0,1e-4,0],rot:[0,Math.PI*1.1,0],state:1},{pos:[1170,339.5,3400],vel:[0,1e-4,0],rot:[0,Math.PI*1.2,0],state:1},{pos:[1040,339.5,3480],vel:[0,1e-4,0],rot:[0,Math.PI*1.02,0],state:1},{pos:[1025,339.5,3585],vel:[0,1e-4,0],rot:[0,Math.PI*1.1,0],state:1},{pos:[950,339.5,3445],vel:[0,1e-4,0],rot:[0,Math.PI*1.03,0],state:1},{pos:[925,339.5,3545],vel:[0,1e-4,0],rot:[0,Math.PI*1.06,0],state:1}]}},start:{planes:{COUGAR:[{pos:[2865,218.2,2410],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0],state:1}],DRAKEN:[{pos:[2868,218.2,2466],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0],state:1}]},cars:{PV_9031:[{pos:[2832,218.2,2370],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0]}]}}}}}),define("data_pipeline/DataPipelineMessageHandler",["goo/entities/SystemBus"],function(e){var t;require(["data_pipeline/data/ConfigCache"],function(e){t=e});var n=0,r=0,i=function(e){var t=[];if(typeof e=="array")for(var n=0;n<e.length;n++)t.push(e[n]);else t.push(e);return t},s=function(e,t){var n=i(t);n.push(r),n.push(e),r+=1,u("data_error_channel",n,50)},o=function(t,n){var r=i(n);r.push(t),u("data_error_update_channel",r,300),e.emit("message_to_gui",{channel:"alert_channel",message:"Data Update Error"})},u=function(t,n,r){setTimeout(function(){e.emit("message_to_gui",{channel:t,message:n})},r)},a=function(e){n+=1,u("data_update_channel",e+" "+n,500)},f=function(e){u("data_validation_update_channel",e,500)},l=function(e){u("data_validation_error_channel",e,500)},c=function(){t.pipelineReady(!0)};return{notifyWorkerReady:c,handleWorkerError:s,handleErrorUpdate:o,handleDataUpdated:a,handleValidationPass:f,handleValidationError:l}}),define("data_pipeline/DataWorker",["data_pipeline/DataPipelineMessageHandler"],function(e){var t={},n=new Worker("./js/submodules/data_pipeline/src/worker/WorkerMain.js");n.onmessage=function(n){n.data[0]=="ready"&&e.notifyWorkerReady(),n.data[0]=="ok"&&(t[n.data[1]][0](n.data[1],n.data[2]),e.handleDataUpdated(n.data[1])),n.data[0]=="fail"&&e.handleWorkerError(n.data[1],n.data[2]),n.data[0]=="error_resolved"&&e.handleErrorUpdate(n.data[1],n.data[2]),n.data[0]=="error_unchanged"&&e.handleErrorUpdate(n.data[1],n.data[2]),n.data[0]=="error_changed"&&e.handleErrorUpdate(n.data[1],n.data[2])};var r=function(e,r,i){t[e]=[r,i],n.postMessage(["json",e])},i=function(e,r,i){t[e]=[r,i],n.postMessage(["svg",e])},s=function(e,r,i){t[e]=[r,i],n.postMessage(["bin",e])};return{fetchJsonData:r,fetchSvgData:i,fetchBinaryData:s}}),define("data_pipeline/pipes/JsonPipe",["data_pipeline/DataWorker"],function(e){var t=.2,n=t,r={},i=0,s=[],o={},u={polling:{enabled:!0,frequency:5}},a=function(){};return a.registerPollCallback=function(e,t){o[e]=t,s.push(e)},a.storeConfig=function(e,t,n){r[e]=t,n(e,t)},a.loadJsonFromUrl=function(t,n,r){var i=function(e,t){a.storeConfig(t,e,n),a.registerPollCallback(t,n)},s=function(e,t){i(JSON.parse(t),e)},o=function(e){r("Worker fail: "+e)};e.fetchJsonData(t,s,o)},a.tickJsonPipe=function(e){if(!u.polling.enabled)return;t=1/u.polling.frequency,n-=s.length*e/(s.length+1);if(n<0){i+=1,i>=s.length&&(i=0);var r=function(e){console.error("Json Polling failed",e)};a.loadJsonFromUrl(s[i],o[s[i]],r,!1),n=t}},a.setJsonPipeOpts=function(e){u=e},a}),define("data_pipeline/pipes/SvgPipe",["data_pipeline/DataWorker"],function(e){var t=1,n=t,r={},i=0,s=[],o={},u={polling:{enabled:!0,frequency:1}},a=function(){};return a.registerPollCallback=function(e,t){o[e]=t,s.push(e)},a.storeData=function(e,t,n){r[e]=t,n(e,t)},a.loadSvg=function(t,n,r){var i=function(e,t){a.storeData(t,e,n),a.registerPollCallback(t,n)},s=function(e,t){i(t,e)},o=function(e){console.error("Worker error: ",e)};e.fetchSvgData(t,s,o)},a.tickSvgPipe=function(e){if(!u.polling.enabled)return;t=1/u.polling.frequency,n-=s.length*e/(s.length+1);if(n<0){i+=1,i>=s.length&&(i=0);var r=function(e){console.error("Svg Polling failed",e)};a.loadSvg(s[i],o[s[i]],r,!1),n=t}},a.setSvgPipeOpts=function(e){u=e},a}),define("data_pipeline/pipes/ImagePipe",["data_pipeline/DataWorker"],function(e){var t=1,n=t,r={},i=0,s=[],o={},u={polling:{enabled:!0,frequency:1}},a=function(){};return a.registerPollCallback=function(e,t){o[e]=t,s.push(e)},a.storeData=function(e,t,n){r[e]=t,n(e,t)},a.loadImage=function(t,n,r){var i=function(e,t){a.storeData(t,e,n),a.registerPollCallback(t,n)},s=function(e,t){i(t,e)},o=function(e){console.error("Worker error: ",e)};e.fetchBinaryData(t,s,o)},a.tickImagePipe=function(e){if(!u.polling.enabled)return;t=1/u.polling.frequency,n-=s.length*e/(s.length+1);if(n<0){i+=1,i>=s.length&&(i=0);var r=function(e){console.error("Image Polling failed",e)};a.loadImage(s[i],o[s[i]],r,!1),n=t}},a.setImagePipeOpts=function(e){u=e},a}),define("goo/util/rsvp",["exports"],function(e){function v(e,n){t.async(function(){e.trigger("promise:resolved",{detail:n}),e.isResolved=!0,e.resolvedValue=n})}function m(e,n){t.async(function(){e.trigger("promise:failed",{detail:n}),e.isRejected=!0,e.rejectedValue=n})}function g(e){var t,n=[],r=new h,i=e.length;i===0&&r.resolve([]);var s=function(e,t){n[e]=t,--i===0&&r.resolve(n)},o=function(e){return function(t){s(e,t)}},u=function(e){r.reject(e)};for(t=0;t<i;t++)e[t].then(o(t),u);return r}function y(e,n){t[e]=n}var t={},n=typeof window!="undefined"?window:{},r=n.MutationObserver||n.WebKitMutationObserver,i=window.process;if(typeof i!="undefined"&&{}.toString.call(i)==="[object process]")t.async=function(e,t){i.nextTick(function(){e.call(t)})};else if(r){var s=[],o=new r(function(){var e=s.slice();s=[],e.forEach(function(e){var t=e[0],n=e[1];t.call(n)})}),u=document.createElement("div");o.observe(u,{attributes:!0}),window.addEventListener("unload",function(){o.disconnect(),o=null}),t.async=function(e,t){s.push([e,t]),u.setAttribute("drainQueue","drainQueue")}}else t.async=function(e,t){setTimeout(function(){e.call(t)},1)};var a=function(e,t){this.type=e;for(var n in t){if(!t.hasOwnProperty(n))continue;this[n]=t[n]}},f=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n][0]===t)return n;return-1},l=function(e){var t=e._promiseCallbacks;return t||(t=e._promiseCallbacks={}),t},c={mixin:function(e){return e.on=this.on,e.off=this.off,e.trigger=this.trigger,e},on:function(e,t,n){var r=l(this),i,s;e=e.split(/\s+/),n=n||this;while(s=e.shift())i=r[s],i||(i=r[s]=[]),f(i,t)===-1&&i.push([t,n])},off:function(e,t){var n=l(this),r,i,s;e=e.split(/\s+/);while(i=e.shift()){if(!t){n[i]=[];continue}r=n[i],s=f(r,t),s!==-1&&r.splice(s,1)}},trigger:function(e,t){var n=l(this),r,i,s,o,u;if(r=n[e])for(var f=0,c=r.length;f<c;f++)i=r[f],s=i[0],o=i[1],typeof t!="object"&&(t={detail:t}),u=new a(e,t),s.call(o,u)}},h=function(){this.on("promise:resolved",function(e){this.trigger("success",{detail:e.detail})},this),this.on("promise:failed",function(e){this.trigger("error",{detail:e.detail})},this)},p=function(){},d=function(e,t,n,r){var i=typeof n=="function",s,o,u,a;if(i)try{s=n(r.detail),u=!0}catch(f){a=!0,o=f}else s=r.detail,u=!0;s&&typeof s.then=="function"?s.then(function(e){t.resolve(e)},function(e){t.reject(e)}):i&&u?t.resolve(s):a?t.reject(o):t[e](s)};h.prototype={then:function(e,n){var r=new h;return this.isResolved&&t.async(function(){d("resolve",r,e,{detail:this.resolvedValue})},this),this.isRejected&&t.async(function(){d("reject",r,n,{detail:this.rejectedValue})},this),this.on("promise:resolved",function(t){d("resolve",r,e,t)}),this.on("promise:failed",function(e){d("reject",r,n,e)}),r},resolve:function(e){v(this,e),this.resolve=p,this.reject=p},reject:function(e){m(this,e),this.resolve=p,this.reject=p}},c.mixin(h.prototype),e.Promise=h,e.Event=a,e.EventTarget=c,e.all=g,e.configure=y}),define("goo/util/PromiseUtil",["goo/util/rsvp"],function(e){function t(){}t.createPromise=function(t){var n=new e.Promise;return t(function(e){n.resolve(e)},function(e){n.reject(e)}),n},t.resolve=function(t){var n=new e.Promise;return n.resolve(t),n},t.reject=function(t){var n=new e.Promise;return n.reject(t),n};var n=!1;return t.createDummyPromise=function(t,r){n||(n=!0,console.warn("PromiseUtil.createDummyPromise is deprecated; please consider using PromiseUtil.resolve/reject instead"));var i=new e.Promise;return r?i.reject(r):i.resolve(t),i},t.optimisticAll=function(t){var n=0,r=t.length,i=[],s=new e.Promise;if(r>0)for(var o=0;o<r;o++)(function(e){t[e].then(function(t){i[e]=t,n++,n===r&&s.resolve(i)},function(t){i[e]=t,n++,n===r&&s.resolve(i)})})(o);else s.resolve(i);return s},t.defer=function(t,n){var r,i,s;return s=new e.Promise,n.apply?(r=new e.Promise,i=r.then(function(){return n()}),setTimeout(function(){r.resolve()},t),i):(setTimeout(function(){s.resolve(n)},t),s)},t}),define("goo/loaders/handlers/ConfigHandler",["goo/util/rsvp","goo/util/PromiseUtil"],function(e,t){function n(e,t,n,r){this.world=e,this.getConfig=t,this.updateObject=n,this.loadObject=r,this._objects=new Map,this._loading=new Map}return n.prototype._create=function(){return{}},n.prototype._remove=function(e){this._objects.delete(e)},n.prototype._prepare=function(e){},n.prototype._load=function(e,t){return this.loadObject(e,t)},n.prototype.load=function(e,n){var r=e.substr(e.lastIndexOf(".")+1);if(r!==this.constructor._type)throw new Error("Trying to load type"+r+" with handler for "+this._type);if(this._loading.has(e))return this._loading.get(e);if(this._objects.has(e)&&!n.reload)return t.resolve(this._objects.get(e));var i=this.getConfig(e,n).then(function(t){return this.update(e,t,n)}.bind(this)).then(function(t){return this._loading.delete(e),t}.bind(this)).then(null,function(t){throw this._loading.delete(e),t}.bind(this));return this._loading.set(e,i),i},n.prototype.clear=function(){var t=[];return this._objects.forEach(function(e,n){t.push(this.update(n,null,{}))}.bind(this)),this._objects.clear(),this._loading.clear(),e.all(t)},n.prototype.update=function(e,t,n){var r=this._update(e,t,n).then(function(t){return this._loading.delete(e),t}.bind(this));return this._loading.set(e,r),r},n.prototype._update=function(e,n,r){return n?(this._objects.has(e)||this._objects.set(e,this._create()),this._prepare(n),t.resolve(this._objects.get(e))):(this._remove(e,r),t.resolve())},n.handlerClasses={},n.getHandler=function(e){return n.handlerClasses[e]},n._registerClass=function(e,t){return t._type=e,n.handlerClasses[e]=t},n}),define("goo/loaders/handlers/ComponentHandler",["goo/util/PromiseUtil"],function(e){function t(e,t,n,r){this.world=e,this.getConfig=t,this.updateObject=n,this.loadObject=r}return t.prototype._prepare=function(){},t.prototype._create=function(){throw new Error("ComponentHandler._create is abstract, use ComponentHandler.getHandler(type)")},t.prototype._remove=function(e){e.clearComponent(this._type)},t.prototype._load=function(e,t){return this.loadObject(e,t)},t.prototype.update=function(t,n){if(!t)return e.reject("Entity is missing");if(!n)return this._remove(t),e.resolve();var r=t.getComponent(this._type);return r||(r=this._create(),t.setComponent(r)),this._prepare(n),e.resolve(r)},t.handlerClasses={},t.getHandler=function(e){return t.handlerClasses[e]},t._registerClass=function(e,n){t.handlerClasses[e]=n},t}),define("goo/math/MathUtils",[],function(){function e(){}return e.DEG_TO_RAD=Math.PI/180,e.RAD_TO_DEG=180/Math.PI,e.HALF_PI=.5*Math.PI,e.TWO_PI=2*Math.PI,e.EPSILON=1e-5,e.radFromDeg=function(t){return t*e.DEG_TO_RAD},e.degFromRad=function(t){return t*e.RAD_TO_DEG},e.lerp=function(e,t,n){return t===n?t:t+(n-t)*e},e.clamp=function(e,t,n){return t<n?e<t?t:e>n?n:e:e<n?n:e>t?t:e},e.radialClamp=function(t,n,r){var i=(n+r)/2+(r>n?Math.PI:0),s=e.moduloPositive(t-i,e.TWO_PI),o=e.moduloPositive(n-i,e.TWO_PI),u=e.moduloPositive(r-i,e.TWO_PI);return t<0&&n>0?n-=e.TWO_PI:t>0&&n<0&&(n+=e.TWO_PI),t>e.TWO_PI&&r<e.TWO_PI&&(r+=e.TWO_PI),s<o?n:s>u?r:t},e.moduloPositive=function(e,t){var n=e%t;return n+=n<0?t:0,n},e.scurve3=function(e){return(-2*e+3)*e*e},e.scurve5=function(e){return((6*e-15)*e+10)*e*e*e},e.sphericalToCartesian=function(e,t,n,r){var i=e*Math.cos(n);r.x=i*Math.cos(t),r.y=e*Math.sin(n),r.z=i*Math.sin(t)},e.cartesianToSpherical=function(e,t,n,r){var i=Math.sqrt(e*e+n*n);r.x=Math.sqrt(e*e+t*t+n*n),r.y=Math.atan2(n,e),r.z=Math.atan2(t,i)},e.getTriangleNormal=function(e,t,n,r,i,s,o,u,a){var f=r-e,l=i-t,c=s-n,h=o-e,p=u-t,d=a-n,v=l*d-c*p,m=c*h-f*d,g=f*p-l*h;return[v,m,g]},e.isPowerOfTwo=function(e){return(e&e-1)===0},e.nearestHigherPowerOfTwo=function(e){return Math.floor(Math.pow(2,Math.ceil(Math.log(e)/Math.log(2))))},e.closeTo=function(e,t,n){return n=typeof n!="undefined"?n:.001,Math.abs(e-t)<=n},e.sign=function(e){return e<0?-1:e>0?1:0},e.triangleArea=function(e,t,n){return Math.abs(e.x*t.y+t.x*n.y+n.x*e.y-t.y*n.x-n.y*e.x-e.y*t.x)/2},e.barycentricInterpolation=function(t,n,r,i){var s=e.triangleArea(n,r,i),o=e.triangleArea(t,r,i),u=e.triangleArea(t,n,i),a=s+o+u;if(!a){if(i[0]===t[0]&&i[2]===t[2])return t;if(i[0]===n[0]&&i[2]===n[2])return n;if(i[0]===r[0]&&i[2]===r[2])return r}return i.z=(s*t.z+o*n.z+u*r.z)/a,i},e.smoothstep=function(t,n,r){return r=e.clamp((r-t)/(n-t),0,1),r*r*(3-2*r)},e.randomSeed=1337,e.fastRandom=function(){return e.randomSeed=(e.randomSeed*9301+49297)%233280,e.randomSeed/233280},e}),define("goo/math/Vector",["goo/math/MathUtils"],function(e){function t(e){this.data=new Float64Array(e)}return t.setupAliases=function(e,t){t.forEach(function(t,n){t.forEach(function(t){Object.defineProperty(e,t,{get:function(){return this.data[n]},set:function(e){this.data[n]=e;if(isNaN(this.data[n]))throw new Error("Tried setting NaN to vector component "+t)}})}),Object.defineProperty(e,n,{get:function(){return this.data[n]},set:function(e){this.data[n]=e;if(isNaN(this.data[n]))throw new Error("Tried setting NaN to vector component "+n)}})})},t.prototype.checkIntegrity=function(){for(var e=0;e<this.data.length;e++)if(isNaN(this.data[e]))throw new Error("Vector contains NaN at index "+e)},t.addPostCheck=function(e,t){var n=e[t];e[t]=function(){var e=n.apply(this,arguments);if(typeof e=="number"&&isNaN(e))throw new Error("Vector method "+t+" returned NaN");return this.checkIntegrity(),e}},t.addPostChecks=function(e,n){n.forEach(t.addPostCheck.bind(null,e))},t.add=function(e,n,r){var i=e.data||e,s=n.data||n,o=i.length;r||(r=new t(o));for(var u=0;u<o;u++)r.data[u]=i[u]+s[u];return r},t.prototype.add=function(e){return t.add(this,e,this)},t.sub=function(e,n,r){var i=e.data||e,s=n.data||n,o=i.length;r||(r=new t(o));for(var u=0;u<o;u++)r.data[u]=i[u]-s[u];return r},t.prototype.sub=function(e){return t.sub(this,e,this)},t.mul=function(e,n,r){var i=e.data||e,s=n.data||n,o=i.length;r||(r=new t(o));for(var u=0;u<o;u++)r.data[u]=i[u]*s[u];return r},t.prototype.mul=function(e){return t.mul(this,e,this)},t.div=function(e,n,r){var i=e.data||e,s=n.data||n,o=i.length;r||(r=new t(o));for(var u=0;u<o;u++)r.data[u]=i[u]/s[u];return r},t.prototype.div=function(e){return t.div(this,e,this)},t.copy=function(e,n){var r=e.data.length;return n||(n=new t(r)),n.data.set(e.data),n},t.prototype.copy=function(e){return this.data.set(e.data),this},t.dot=function(e,t){var n=e.data||e,r=t.data||t,i=n.length,s=0;for(var o=0;o<i;o++)s+=n[o]*r[o];return s},t.prototype.dot=function(e){return t.dot(this,e)},t.apply=function(e,n,r){var i=e.rows,s=e.cols,o=n.data.length;r||(r=new t(i));if(r===n)return t.copy(t.apply(e,n),r);for(var u=0;u<s;u++){var a=u*i;for(var f=0;f<i;f++){var l=0;for(var c=0;c<o;c++)l+=e.data[c*e.rows+f]*n.data[c];r.data[a+f]=l}}return r},t.prototype.apply=function(e){return t.apply(e,this,this)},t.equals=function(t,n){var r=t.data.length;if(r!==n.data.length)return!1;for(var i=0;i<r;i++)if(!(Math.abs(t.data[i]-n.data[i])<=e.EPSILON))return!1;return!0},t.prototype.equals=function(e){return t.equals(this,e)},t.distanceSquared=function(e,n){return t.sub(e,n).lengthSquared()},t.prototype.distanceSquared=function(e){return t.sub(this,e).lengthSquared()},t.distance=function(e,n){return t.sub(e,n).length()},t.prototype.distance=function(e){return t.sub(this,e).length()},t.prototype.lengthSquared=function(){return t.dot(this,this)},t.prototype.length=function(){return Math.sqrt(t.dot(this,this))},t.prototype.scale=function(e){for(var t=this.data.length-1;t>=0;t--)this.data[t]*=e;return this},t.prototype.invert=function(){for(var e=0;e<this.data.length;e++)this.data[e]=0-this.data[e];return this},t.prototype.normalize=function(){var t=this.length(),n=this.data.length;if(t<e.EPSILON)for(var r=0;r<n;r++)this.data[r]=0;else{t=1/t;for(var r=0;r<n;r++)this.data[r]*=t}return this},t.prototype.clone=function(){return t.copy(this)},t.prototype.set=function(){if(arguments.length===1&&typeof arguments[0]=="object")if(arguments[0]instanceof t)this.copy(arguments[0]);else for(var e=0;e<arguments[0].length;e++)this.data[e]=arguments[0][e];else for(var e=0;e<arguments.length;e++)this.data[e]=arguments[e];return this},t.prototype.toString=function(){var e="";e+="[";for(var t=0;t<this.data.length;t++)e+=this.data[t],e+=t!==this.data.length-1?", ":"";return e+="]",e},t}),define("goo/math/Vector2",["goo/math/Vector"],function(e){function t(){e.call(this,2),arguments.length!==0&&e.prototype.set.apply(this,arguments),Object.seal(this)}function r(e,t){var n=!1;return function(){return n||(n=!0,console.warn(t)),e.apply(this,arguments)}}t.prototype=Object.create(e.prototype),t.prototype.constructor=t,e.setupAliases(t.prototype,[["x","u","s"],["y","v","t"]]),t.ZERO=new t(0,0),t.ONE=new t(1,1),t.UNIT_X=new t(1,0),t.UNIT_Y=new t(0,1);var n=new t;return t.add=function(e,n,r){typeof e=="number"&&(e=[e,e]),typeof n=="number"&&(n=[n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]+s[0],r.data[1]=i[1]+s[1],r},t.prototype.add=function(e){return t.add(this,e,this)},t.sub=function(e,n,r){typeof e=="number"&&(e=[e,e]),typeof n=="number"&&(n=[n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]-s[0],r.data[1]=i[1]-s[1],r},t.prototype.sub=function(e){return t.sub(this,e,this)},t.mul=function(e,n,r){typeof e=="number"&&(e=[e,e]),typeof n=="number"&&(n=[n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]*s[0],r.data[1]=i[1]*s[1],r},t.prototype.mul=function(e){return t.mul(this,e,this)},t.div=function(e,n,r){typeof e=="number"&&(e=[e,e]),typeof n=="number"&&(n=[n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]/s[0],r.data[1]=i[1]/s[1],r},t.prototype.div=function(e){return t.div(this,e,this)},t.dot=function(e,t){typeof e=="number"&&(e=[e,e]),typeof t=="number"&&(t=[t,t]);var n=e.data||e,r=t.data||t;return n[0]*r[0]+n[1]*r[1]},t.prototype.dot=function(e){return t.dot(this,e)},t.prototype.dotVector=function(e){var t=this.data,n=e.data;return t[0]*n[0]+t[1]*n[1]},t.prototype.reflect=function(e){return n.copy(e),n.scale(2*this.dot(e)),this.subVector(n),this},t.prototype.setDirect=function(e,t){return this.data[0]=e,this.data[1]=t,this},t.prototype.setd=r(t.prototype.setDirect,".setd is deprecated; please use .setDirect instead"),t.prototype.setArray=function(e){return this.data[0]=e[0],this.data[1]=e[1],this},t.prototype.seta=r(t.prototype.setArray,".seta is deprecated; please use .setArray instead"),t.prototype.setVector=function(e){return this.data[0]=e.data[0],this.data[1]=e.data[1],this},t.prototype.setv=r(t.prototype.setVector,".setv is deprecated; please use .setVector instead"),t.prototype.addDirect=function(e,t){return this.data[0]+=e,this.data[1]+=t,this},t.prototype.addVector=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this},t.prototype.mulDirect=function(e,t){return this.data[0]*=e,this.data[1]*=t,this},t.prototype.mulVector=function(e){return this.data[0]*=e.data[0],this.data[1]*=e.data[1],this},t.prototype.subDirect=function(e,t){return this.data[0]-=e,this.data[1]-=t,this},t.prototype.subVector=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this},t.prototype.scale=function(e){return this.data[0]*=e,this.data[1]*=e,this},t.prototype.clone=function(){return(new t).copy(this)},t.prototype.copy=t.prototype.setVector,e.addPostChecks(t.prototype,["add","sub","mul","div","invert","dot","dotVector","reflect","setDirect","setArray","setVector","addDirect","addVector","subDirect","subVector","mulDirect","mulVector","scale"]),t}),define("goo/renderer/Texture",["goo/math/Vector2","goo/util/PromiseUtil"],function(e,t){function n(n,r,i,s){this.glTexture=null,r=r||{},this.wrapS=r.wrapS||"Repeat",this.wrapT=r.wrapT||"Repeat",this.magFilter=r.magFilter||"Bilinear",this.minFilter=r.minFilter||"Trilinear",this.anisotropy=r.anisotropy!==undefined?r.anisotropy:1,this.format=r.format||"RGBA",this.type=r.type||"UnsignedByte",this.variant="2D",this.offset=new e(r.offset||[0,0]),this.repeat=new e(r.repeat||[1,1]),this.lodBias=0,this.generateMipmaps=r.generateMipmaps!==undefined?r.generateMipmaps:!0,this.premultiplyAlpha=r.premultiplyAlpha!==undefined?r.premultiplyAlpha:!1,this.unpackAlignment=r.unpackAlignment!==undefined?r.unpackAlignment:1,this.flipY=r.flipY!==undefined?r.flipY:!0,this.hasBorder=!1,this.needsUpdate=!1,this.updateCallback=null,this.readyCallback=null,this._originalImage=null,this._originalWidth=0,this._originalHeight=0,this.image=null,n&&this.setImage(n,i,s,r),this.loadImage=t.resolve.bind(null,this),this.textureRecord={},Object.seal(this)}return n.prototype.checkDataReady=function(){return this.image&&(this.image.dataReady||this.image instanceof HTMLImageElement)||this.readyCallback!==null&&this.readyCallback()},n.prototype.checkNeedsUpdate=function(){return this.needsUpdate||this.updateCallback!==null&&this.updateCallback()},n.prototype.setNeedsUpdate=function(){this.needsUpdate=!0},n.prototype.setImage=function(e,t,n,r){this._originalImage=e,this.image=e;var i=e instanceof Array?e[0]:e;if(i instanceof Uint8Array||i instanceof Uint8ClampedArray||i instanceof Uint16Array||i instanceof Float32Array){t=t||e.width,n=n||e.height;if(t===undefined||n===undefined)throw new Error("Data textures need width and height");this.image={data:e,width:t,height:n,isData:!0,dataReady:!0},i instanceof Uint8Array||i instanceof Uint8ClampedArray?this.type="UnsignedByte":i instanceof Uint16Array?(this.type="UnsignedShort565",this.format=r.format||"RGB"):i instanceof Float32Array&&(this.type="Float",this.format=r.format||"RGBA")}else e instanceof Array&&(this.image={data:e}),i instanceof HTMLCanvasElement&&(this.image.dataReady=!0);this.setNeedsUpdate(),this._originalWidth=t,this._originalHeight=n},n.prototype.destroy=function(e){e.deleteTexture(this.glTexture),this.glTexture=null},n.prototype.getSizeInMemory=function(){var e;if(!this.image)return 0;var t=this.image.width||this.image.length,n=this.image.height||1;e=t*n;if(this.format==="Luminance"||this.format==="Alpha")e*=1;else if(this.format==="Lumin`anceAlpha")e*=2;else if(this.format==="RGB")e*=3;else if(this.format==="RGBA")e*=4;else if(this.format==="PrecompressedDXT1")e*=.5;else if(this.format==="PrecompressedDXT1A")e*=4/6;else if(this.format==="PrecompressedDXT3"||this.format==="PrecompressedDXT5")e*=1;return this.generateMipmaps&&(e=Math.ceil(e*4/3)),e},n.prototype.clone=function(){var e={wrapS:this.wrapS,wrapT:this.wrapT,magFilter:this.magFilter,minFilter:this.minFilter,anisotropy:this.anisotropy,format:this.format,type:this.type,offset:this.offset,repeat:this.repeat,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment,flipY:this.flipY},t=new n(this._originalImage,e,this._originalWidth,this._originalHeight);return t.variant=this.variant,t.lodBias=this.lodBias,t.hasBorder=this.hasBorder,t},n.CUBE_FACES=["PositiveX","NegativeX","PositiveY","NegativeY","PositiveZ","NegativeZ"],n}),define("goo/renderer/Capabilities",[],function(){function e(){}return e.init=function(t){e.CompressedTextureS3TC=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),e.TextureFloat=t.getExtension("OES_texture_float"),e.TextureFloatLinear=t.getExtension("OES_texture_float_linear"),e.TextureHalfFloat=t.getExtension("OES_texture_half_float"),e.TextureHalfFloatLinear=t.getExtension("OES_texture_half_float_linear"),e.StandardDerivatives=t.getExtension("OES_standard_derivatives"),e.TextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),e.DepthTexture=t.getExtension("WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture"),e.ElementIndexUInt=t.getExtension("OES_element_index_uint"),e.InstancedArrays=t.getExtension("ANGLE_instanced_arrays"),e.BlendMinmax=t.getExtension("EXT_blend_minmax"),e.FragDepth=t.getExtension("EXT_frag_depth"),e.ShaderTextureLod=t.getExtension("EXT_shader_texture_lod"),e.VertexArrayObject=t.getExtension("OES_vertex_array_object"),e.DrawBuffers=t.getExtension("WEBGL_draw_buffers"),e.maxTexureSize=t.getParameter(t.MAX_TEXTURE_SIZE),e.maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),e.maxRenderbufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),e.maxViewPortDims=t.getParameter(t.MAX_VIEWPORT_DIMS),e.maxAnisotropy=e.TextureFilterAnisotropic?t.getParameter(e.TextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,e.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),e.maxFragmentTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),e.maxCombinedTextureUnits=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),e.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),e.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),e.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),e.maxVaryingVectors=t.getParameter(t.MAX_VARYING_VECTORS),e.aliasedPointSizeRange=t.getParameter(t.ALIASED_POINT_SIZE_RANGE),e.aliasedLineWidthRange=t.getParameter(t.ALIASED_LINE_WIDTH_RANGE),e.samples=t.getParameter(t.SAMPLES),e.sampleBuffers=t.getParameter(t.SAMPLE_BUFFERS),e.depthBits=t.getParameter(t.DEPTH_BITS),e.stencilBits=t.getParameter(t.STENCIL_BITS),e.subpixelBits=t.getParameter(t.SUBPIXEL_BITS),e.supportedExtensionsList=t.getSupportedExtensions(),e.renderer=t.getParameter(t.RENDERER),e.vendor=t.getParameter(t.VENDOR),e.version=t.getParameter(t.VERSION),e.shadingLanguageVersion=t.getParameter(t.SHADING_LANGUAGE_VERSION),e.vertexShaderHighpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),e.vertexShaderMediumpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),e.vertexShaderLowpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_FLOAT),e.fragmentShaderHighpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),e.fragmentShaderMediumpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),e.fragmentShaderLowpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),e.vertexShaderHighpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_INT),e.vertexShaderMediumpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_INT),e.vertexShaderLowpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_INT),e.fragmentShaderHighpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_INT),e.fragmentShaderMediumpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_INT),e.fragmentShaderLowpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_INT)},e.getCapabilitiesString=function(){var t=[],n=function(e){return e&&e.buffer instanceof ArrayBuffer&&e.byteLength!==undefined};for(var r in e){var i=e[r];if(i instanceof Function||typeof i=="object"&&!(i instanceof Array||n(i)))continue;var s="";if(n(i)){s+="[";for(var o=0;o<i.length;o++)s+=i[o],o<i.length-1&&(s+=",");s+="]"}else s=i;t.push(r+": "+s)}return t.join("\n")},e}),define("goo/loaders/dds/DdsUtils",["goo/renderer/Capabilities"],function(e){function t(){}return t.isSupported=function(){return!!e.CompressedTextureS3TC},t.shiftCount=function(e){if(e===0)return 0;var t=0;while((e&1)===0){e>>=1,t++;if(t>32)throw"invalid mask!"}return t},t.isSet=function(e,t){return(e&t)===t},t.getIntFromString=function(e){var n=[];for(var r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return t.getIntFromBytes(n)},t.getIntFromBytes=function(e){var t=0;return t|=(e[0]&255)<<0,e.length>1&&(t|=(e[1]&255)<<8),e.length>2&&(t|=(e[2]&255)<<16),e.length>3&&(t|=(e[3]&255)<<24),t},t.getComponents=function(e){switch(e){case"Alpha":return 1;case"RGB":return 3;case"RGBA":return 4;case"Luminance":return 1;case"LuminanceAlpha":return 2;case"PrecompressedDXT1":return 1;case"PrecompressedDXT1A":return 1;case"PrecompressedDXT3":return 2;case"PrecompressedDXT5":return 2}return 0},t.flipDXT=function(e,n,r,i){var s=new Uint8Array(e.length),o=n+3>>2,u=r+3>>2,a=t.getComponents(i)*8;for(var f=0;f<u;f++){var l=u-f-1;for(var c=0;c<o;c++){var h=(l*o+c)*a,p=(f*o+c)*a;switch(i){case"PrecompressedDXT1":case"PrecompressedDXT1A":s[h+0]=e[p+0],s[h+1]=e[p+1],s[h+2]=e[p+2],s[h+3]=e[p+3],s[h+4]=e[p+7],s[h+5]=e[p+6],s[h+6]=e[p+5],s[h+7]=e[p+4];break;case"PrecompressedDXT3":s[h+0]=e[p+6],s[h+1]=e[p+7],s[h+2]=e[p+4],s[h+3]=e[p+5],s[h+4]=e[p+2],s[h+5]=e[p+3],s[h+6]=e[p+0],s[h+7]=e[p+1],s[h+8]=e[p+8],s[h+9]=e[p+9],s[h+10]=e[p+10],s[h+11]=e[p+11],s[h+12]=e[p+15],s[h+13]=e[p+14],s[h+14]=e[p+13],s[h+15]=e[p+12];break;case"PrecompressedDXT5":s[h+0]=e[p+0],s[h+1]=e[p+1],t.getBytesFromUInt24(s,h+5,t.flipUInt24(t.getUInt24(e,p+2))),t.getBytesFromUInt24(s,h+2,t.flipUInt24(t.getUInt24(e,p+5))),s[h+8]=e[p+8],s[h+9]=e[p+9],s[h+10]=e[p+10],s[h+11]=e[p+11],s[h+12]=e[p+15],s[h+13]=e[p+14],s[h+14]=e[p+13],s[h+15]=e[p+12]}}}return s},t.getUInt24=function(e,t){var n=0;return n|=(e[t+0]&255)<<0,n|=(e[t+1]&255)<<8,n|=(e[t+2]&255)<<16,n},t.getBytesFromUInt24=function(e,t,n){e[t+0]=n&255,e[t+1]=(n&65280)>>8,e[t+2]=(n&16711680)>>16},t.ThreeBitMask=7,t.flipUInt24=function(e){var n=[];for(var r=0;r<2;r++)n.push([0,0,0,0]);n[0][0]=e&t.ThreeBitMask,e>>=3,n[0][1]=e&t.ThreeBitMask,e>>=3,n[0][2]=e&t.ThreeBitMask,e>>=3,n[0][3]=e&t.ThreeBitMask,e>>=3,n[1][0]=e&t.ThreeBitMask,e>>=3,n[1][1]=e&t.ThreeBitMask,e>>=3,n[1][2]=e&t.ThreeBitMask,e>>=3,n[1][3]=e&t.ThreeBitMask;var i=0;return i|=n[1][0]<<0,i|=n[1][1]<<3,i|=n[1][2]<<6,i|=n[1][3]<<9,i|=n[0][0]<<12,i|=n[0][1]<<15,i|=n[0][2]<<18,i|=n[0][3]<<21,i},t}),define("goo/loaders/dds/DdsLoader",["goo/loaders/dds/DdsUtils","goo/renderer/Capabilities"],function(e,t){function n(){this.dwSize=0,this.dwFlags=0,this.dwFourCC=0,this.dwRGBBitCount=0,this.dwRBitMask=0,this.dwGBitMask=0,this.dwBBitMask=0,this.dwABitMask=0}function r(){this.dwSize=0,this.dwFlags=0,this.dwHeight=0,this.dwWidth=0,this.dwLinearSize=0,this.dwDepth=0,this.dwMipMapCount=0,this.dwAlphaBitDepth=0,this.dwReserved1=[],this.ddpf=null,this.dwCaps=0,this.dwCaps2=0,this.dwCaps3=0,this.dwCaps4=0,this.dwTextureStage=0}function i(){this.flipVertically=!1,this.bpp=0,this.header=null,this.headerDX10=null,this.mipmapByteSizes=[]}function s(){}return n.HEADER_OFFSET=19,n.DDPF_ALPHAPIXELS=1,n.DDPF_ALPHA=2,n.DDPF_FOURCC=4,n.DDPF_RGB=64,n.DDPF_YUV=512,n.DDPF_LUMINANCE=131072,n.read=function(e){var t=new n;t.dwSize=e[n.HEADER_OFFSET+0];if(t.dwSize!==32)throw"invalid pixel format size: "+t.dwSize;return t.dwFlags=e[n.HEADER_OFFSET+1],t.dwFourCC=e[n.HEADER_OFFSET+2],t.dwRGBBitCount=e[n.HEADER_OFFSET+3],t.dwRBitMask=e[n.HEADER_OFFSET+4],t.dwGBitMask=e[n.HEADER_OFFSET+5],t.dwBBitMask=e[n.HEADER_OFFSET+6],t.dwABitMask=e[n.HEADER_OFFSET+7],t},r.DDSD_CAPS=1,r.DDSD_HEIGHT=2,r.DDSD_WIDTH=4,r.DDSD_PITCH=8,r.DDSD_PIXELFORMAT=4096,r.DDSD_MIPMAPCOUNT=131072,r.DDSD_LINEARSIZE=524288,r.DDSD_DEPTH=8388608,r.DDSCAPS_COMPLEX=8,r.DDSCAPS_MIPMAP=4194304,r.DDSCAPS_TEXTURE=4096,r.DDSCAPS2_CUBEMAP=512,r.DDSCAPS2_CUBEMAP_POSITIVEX=1024,r.DDSCAPS2_CUBEMAP_NEGATIVEX=2048,r.DDSCAPS2_CUBEMAP_POSITIVEY=4096,r.DDSCAPS2_CUBEMAP_NEGATIVEY=8192,r.DDSCAPS2_CUBEMAP_POSITIVEZ=16384,r.DDSCAPS2_CUBEMAP_NEGATIVEZ=32768,r.DDSCAPS2_VOLUME=2097152,r.read=function(t){var i=new r;i.dwSize=t[1];if(i.dwSize!==124)throw"invalid dds header size: "+i.dwSize;i.dwFlags=t[2],i.dwHeight=t[3],i.dwWidth=t[4],i.dwLinearSize=t[5],i.dwDepth=t[6],i.dwMipMapCount=t[7],i.dwAlphaBitDepth=t[8];for(var s=0;s<i.dwReserved1.length;s++)i.dwReserved1[s]=t[9+s];i.ddpf=n.read(t),i.dwCaps=t[27],i.dwCaps2=t[28],i.dwCaps3=t[29],i.dwCaps4=t[30],i.dwTextureStage=t[31];var o=1+Math.ceil(Math.log(Math.max(i.dwHeight,i.dwWidth))/Math.log(2));return e.isSet(i.dwCaps,r.DDSCAPS_MIPMAP)?e.isSet(i.dwFlags,r.DDSD_MIPMAPCOUNT)?i.dwMipMapCount!==o&&console.warn("Got "+i.dwMipMapCount+" mipmaps, expected "+o):i.dwMipMapCount=o:i.dwMipMapCount=1,i},i.prototype.calcMipmapSizes=function(e){var t=this.header.dwWidth,n=this.header.dwHeight,r=0;for(var i=0;i<this.header.dwMipMapCount;i++)r=e?~~((t+3)/4)*~~((n+3)/4)*this.bpp*2:~~(t*n*this.bpp/8),this.mipmapByteSizes.push(~~((r+3)/4)*4),t=~~(t/2)>1?~~(t/2):1,n=~~(n/2)>1?~~(n/2):1},s.updateDepth=function(t,n){if(e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP)){var i=0;e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP_POSITIVEX)&&i++,e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP_NEGATIVEX)&&i++,e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP_POSITIVEY)&&i++,e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP_NEGATIVEY)&&i++,e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP_POSITIVEZ)&&i++,e.isSet(n.header.dwCaps2,r.DDSCAPS2_CUBEMAP_NEGATIVEZ)&&i++;if(i!==6)throw new Error("Cubemaps without all faces defined are not currently supported.");t.depth=i}else t.depth=n.header.dwDepth>0?n.header.dwDepth:1},s.readDXT=function(t,n,r,i){i.image.isCompressed=!0;if(!r.flipVertically)return new Uint8Array(t.buffer,t.byteOffset+0,n);var s=r.header.dwWidth,o=r.header.dwHeight,u=new Uint8Array(n),a=0;for(var f=0;f<r.header.dwMipMapCount;f++){var l=t.subarray(a,a+r.mipmapByteSizes[f]),c=e.flipDXT(l,s,o,i.format);u.set(c,a),a+=c.length,s=~~(s/2)>1?~~(s/2):1,o=~~(o/2)>1?~~(o/2):1}return u},s.readUncompressed=function(t,n,r,i,s,o,u,a){var f=e.shiftCount(u.header.ddpf.dwRBitMask),l=e.shiftCount(u.header.ddpf.dwGBitMask),c=e.shiftCount(u.header.ddpf.dwBBitMask),h=e.shiftCount(u.header.ddpf.dwABitMask),p=~~(u.header.ddpf.dwRGBBitCount/8),d=e.getComponents(a.format)*1,v=new Uint8Array(n),m=u.header.dwWidth,g=u.header.dwHeight,y=0,b=0,w=0,E=[];for(w=0;w<p;w++)E.push(0);for(var S=0;S<u.header.dwMipMapCount;S++){for(var x=0;x<g;x++)for(var T=0;T<m;T++){for(w=0;w<p;w++)E[w]=t[b++];w=e.getIntFromBytes(E);var N=(w&u.header.ddpf.dwRBitMask)>>f,C=(w&u.header.ddpf.dwGBitMask)>>l,k=(w&u.header.ddpf.dwBBitMask)>>c,L=(w&u.header.ddpf.dwABitMask)>>h;s?v[y++]=L:i?(v[y++]=N,o&&(v[y++]=L)):r&&(v[y++]=N,v[y++]=C,v[y++]=k,o&&(v[y++]=L))}y+=m*g*d,m=~~(m/2)>1?~~(m/2):1,g=~~(g/2)>1?~~(g/2):1}return v},s.populate=function(t,r,i){var o=r.header.ddpf.dwFlags,u=e.isSet(o,n.DDPF_FOURCC),a=e.isSet(o,n.DDPF_RGB),f=e.isSet(o,n.DDPF_ALPHAPIXELS),l=e.isSet(o,n.DDPF_LUMINANCE),c=e.isSet(o,n.DDPF_ALPHA);t.type="UnsignedByte";if(u){var h=r.header.ddpf.dwFourCC;if(h===e.getIntFromString("DXT1"))r.bpp=4,t.format="PrecompressedDXT1A";else if(h===e.getIntFromString("DXT3"))r.bpp=8,t.format="PrecompressedDXT3";else{if(h!==e.getIntFromString("DXT5"))throw h===e.getIntFromString("DX10")?new Error("dxt10 LATC formats not supported currently: "+r.headerDX10.dxgiFormat):h===e.getIntFromString("DXT2")?"DXT2 is not supported.":h===e.getIntFromString("DXT4")?"DXT4 is not supported.":"unsupported compressed dds format found ("+h+")";r.bpp=8,t.format="PrecompressedDXT5"}}else{r.bpp=r.header.ddpf.dwRGBBitCount;if(a)f?t.format="RGBA":t.format="RGB";else{if(!l&&!f)throw new Error("unsupported uncompressed dds format found.");l&&f?t.format="LuminanceAlpha":l?t.format="Luminance":c&&(t.format="Alpha")}}r.calcMipmapSizes(u),t.image.mipmapSizes=r.mipmapByteSizes;var p=0;for(var d=0;d<r.mipmapByteSizes.length;d++)p+=r.mipmapByteSizes[d];var v=[];for(var d=0;d<t.image.depth;d++)u?v.push(s.readDXT(i,p,r,t)):(a||l||c)&&v.push(s.readUncompressed(i,p,a,l,c,f,r,t));t.image.data=t.image.depth===1?v[0]:v,t.image.useArrays=!0},s.prototype.load=function(t,n,o,u,a){var f=new Int32Array(t,u+0,32),l=f[0];if(l!==e.getIntFromString("DDS "))throw"Not a dds file.";var c=new i;c.flipVertically=o,c.header=r.read(f),c.headerDX10=c.header.ddpf.dwFourCC===e.getIntFromString("DX10")?r.read(Int32Array.create(t,u+128,5)):null;var h=n.image;if(typeof h=="undefined"||h===null)h={},n.image=h;h.width=c.header.dwWidth,h.height=c.header.dwHeight,s.updateDepth(h,c);var p=128+(c.headerDX10?20:0);s.populate(n,c,new Uint8Array(t,u+p,a-p));if(!c.mipmapByteSizes||c.mipmapByteSizes.length<2)n.minFilter="BilinearNoMipMaps";h.bpp=c.bpp,h.dataReady=!0,h.isData=!0,n.needsUpdate=!0},s.prototype.isSupported=function(){return!!t.CompressedTextureS3TC},s.prototype.toString=function(){return"DdsLoader"},s}),define("goo/loaders/crunch/CrunchLoader",["goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils","goo/renderer/Capabilities"],function(e,t,n){function r(){}return r.cCRNFmtDXT1=0,r.cCRNFmtDXT3=1,r.cCRNFmtDXT5=2,r.prototype.arrayBufferCopy=function(e,t,n,r){var i=n/4,s=r%4,o=new Uint32Array(e.buffer,0,(r-s)/4),u=new Uint32Array(t.buffer),a;for(a=0;a<o.length;a++)u[i+a]=o[a];for(a=r-s;a<r;a++)t[n+a]=e[a]},r.prototype.load=function(e,n,i){if(typeof window.CrunchModule=="undefined"){console.warn("Crunch library not loaded! Include a script tag pointing to lib/crunch/crunch.js in your html-file.");return}var s=window.CrunchModule,o=new Uint8Array(e),u=e.byteLength,a=s._malloc(u),f,l,c,h,p,d,v,m;this.arrayBufferCopy(o,s.HEAPU8,a,u),f=s._crn_get_dxt_format(a,u);var g;switch(f){case r.cCRNFmtDXT1:n.format="PrecompressedDXT1A",g=4;break;case r.cCRNFmtDXT3:n.format="PrecompressedDXT3",g=8;break;case r.cCRNFmtDXT5:n.format="PrecompressedDXT5",g=8;break;default:return console.error("Unsupported image format"),0}h=s._crn_get_width(a,u),p=s._crn_get_height(a,u),d=s._crn_get_levels(a,u),c=s._crn_get_uncompressed_size(a,u,0),l=s._malloc(c);var y=n.image;if(typeof y=="undefined"||y===null)y={},n.image=y;y.width=h,y.height=p,y.depth=1;var b=[];n.image.mipmapSizes=[];for(m=0;m<d;++m)m&&(c=s._crn_get_uncompressed_size(a,u,m)),s._crn_decompress(a,u,l,c,m),v=new Uint8Array(s.HEAPU8.buffer,l,c),i&&(v=t.flipDXT(v,h,p,n.format)),b.push(v),n.image.mipmapSizes.push(c),h*=.5,p*=.5;n.image.data=b,n.image.useArrays=!0,n.type="UnsignedByte",n.image.isCompressed=!0,d<=1&&(n.minFilter="BilinearNoMipMaps"),y.bpp=g,y.dataReady=!0,y.isData=!0,n.needsUpdate=!0,s._free(a),s._free(l)},r.prototype.dxtToRgb565=function(e,t,n,r){var i=new Uint16Array(4),s=new Uint16Array(n*r),o=0,u=0,a=0,f=0,l=0,c=0,h=0,p=0,d=0,v=n/4,m=r/4;for(var g=0;g<m;g++)for(var y=0;y<v;y++)a=t+4*(g*v+y),i[0]=e[a],i[1]=e[a+1],f=i[0]&31,l=i[0]&2016,c=i[0]&63488,h=i[1]&31,p=i[1]&2016,d=i[1]&63488,i[2]=5*f+3*h>>3|5*l+3*p>>3&2016|5*c+3*d>>3&63488,i[3]=5*h+3*f>>3|5*p+3*l>>3&2016|5*d+3*c>>3&63488,o=e[a+2],u=g*4*n+y*4,s[u]=i[o&3],s[u+1]=i[o>>2&3],s[u+2]=i[o>>4&3],s[u+3]=i[o>>6&3],u+=n,s[u]=i[o>>8&3],s[u+1]=i[o>>10&3],s[u+2]=i[o>>12&3],s[u+3]=i[o>>14],o=e[a+3],u+=n,s[u]=i[o&3],s[u+1]=i[o>>2&3],s[u+2]=i[o>>4&3],s[u+3]=i[o>>6&3],u+=n,s[u]=i[o>>8&3],s[u+1]=i[o>>10&3],s[u+2]=i[o>>12&3],s[u+3]=i[o>>14];return s},r.prototype.isSupported=function(){return!!n.CompressedTextureS3TC},r.prototype.toString=function(){return"CrunchLoader"},r}),define("goo/loaders/tga/TgaLoader",[],function(){function e(){this.header=null,this.offset=0,this.use_rle=!1,this.use_pal=!1,this.use_rgb=!1,this.use_grey=!1}return e.TYPE_NO_DATA=0,e.TYPE_INDEXED=1,e.TYPE_RGB=2,e.TYPE_GREY=3,e.TYPE_RLE_INDEXED=9,e.TYPE_RLE_RGB=10,e.TYPE_RLE_GREY=11,e.ORIGIN_MASK=48,e.ORIGIN_SHIFT=4,e.ORIGIN_BL=0,e.ORIGIN_BR=1,e.ORIGIN_UL=2,e.ORIGIN_UR=3,e.prototype.load=function(e,t){this.loadData(new Uint8Array(e));var n=this.getCanvas();t.setImage(n,n.width,n.height),n.dataReady=!0,t.needsUpdate=!0},e.prototype.loadData=function(t){if(t.length<19)throw new Error("Targa::load() - Not enough data to contain header.");this.offset=0,this.header={id_length:t[this.offset++],colormap_type:t[this.offset++],image_type:t[this.offset++],colormap_index:t[this.offset++]|t[this.offset++]<<8,colormap_length:t[this.offset++]|t[this.offset++]<<8,colormap_size:t[this.offset++],origin:[t[this.offset++]|t[this.offset++]<<8,t[this.offset++]|t[this.offset++]<<8],width:t[this.offset++]|t[this.offset++]<<8,height:t[this.offset++]|t[this.offset++]<<8,pixel_size:t[this.offset++],flags:t[this.offset++]},this.checkHeader();if(this.header.id_length+this.offset>t.length)throw new Error("Targa::load() - No data ?");this.offset+=this.header.id_length;switch(this.header.image_type){case e.TYPE_RLE_INDEXED:this.use_rle=!0;break;case e.TYPE_INDEXED:this.use_pal=!0;break;case e.TYPE_RLE_RGB:this.use_rle=!0;break;case e.TYPE_RGB:this.use_rgb=!0;break;case e.TYPE_RLE_GREY:this.use_rle=!0;break;case e.TYPE_GREY:this.use_grey=!0}this.parse(t)},e.prototype.checkHeader=function(){switch(this.header.image_type){case e.TYPE_INDEXED:case e.TYPE_RLE_INDEXED:if(this.header.colormap_length>256||this.header.colormap_size!==24||this.header.colormap_type!==1)throw new Error("Targa::checkHeader() - Invalid type colormap data for indexed type");break;case e.TYPE_RGB:case e.TYPE_GREY:case e.TYPE_RLE_RGB:case e.TYPE_RLE_GREY:if(this.header.colormap_type)throw new Error("Targa::checkHeader() - Invalid type colormap data for colormap type");break;case e.TYPE_NO_DATA:throw new Error("Targa::checkHeader() - No data on this TGA file");default:throw new Error("Targa::checkHeader() - Invalid type '"+this.header.image_type+"'")}if(this.header.width<=0||this.header.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(this.header.pixel_size!==8&&this.header.pixel_size!==16&&this.header.pixel_size!==24&&this.header.pixel_size!==32)throw new Error("Targa::checkHeader() - Invalid pixel size '"+this.header.pixel_size+"'")},e.prototype.parse=function(e){var t,n,r,i,s;t=this.header,n=t.flags&15,i=t.pixel_size>>3,s=t.width*t.height*i,this.use_pal&&(this.palettes=e.subarray(this.offset,this.offset+=t.colormap_length*i));if(this.use_rle){r=new Uint8Array(s);var o,u,a,f=0,l=new Uint8Array(i);while(f<s){o=e[this.offset++],u=(o&127)+1;if(o&128){for(a=0;a<i;++a)l[a]=e[this.offset++];for(a=0;a<u;++a)r.set(l,f+a*i);f+=i*u}else{u*=i;for(a=0;a<u;++a)r[f+a]=e[this.offset++];f+=u}}}else r=e.subarray(this.offset,this.offset+=this.use_pal?t.width*t.height:s);this.image=r},e.prototype.getImageData=function(t){var n=this.header.width,r=this.header.height,i,s,o,u,a,f,l,c;c=t||{width:n,height:r,data:new Uint8Array(n*r*4)};switch((this.header.flags&e.ORIGIN_MASK)>>e.ORIGIN_SHIFT){default:case e.ORIGIN_UL:i=0,o=1,f=n,s=0,u=1,a=r;break;case e.ORIGIN_BL:i=0,o=1,f=n,s=r-1,u=-1,a=-1;break;case e.ORIGIN_UR:i=n-1,o=-1,f=-1,s=0,u=1,a=r;break;case e.ORIGIN_BR:i=n-1,o=-1,f=-1,s=r-1,u=-1,a=-1}return l="getImageData"+(this.use_grey?"Grey":"")+this.header.pixel_size+"bits",this[l](c.data,s,u,a,i,o,f),c},e.prototype.getCanvas=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=t.createImageData(this.header.width,this.header.height);return e.width=this.header.width,e.height=this.header.height,t.putImageData(this.getImageData(n),0,0),e},e.prototype.getDataURL=function(e){return this.getCanvas().toDataURL(e||"image/png")},e.prototype.getImageData8bits=function(e,t,n,r,i,s,o){var u=this.image,a=this.palettes,f=this.header.width,l,c=0,h,p;for(p=t;p!==r;p+=n)for(h=i;h!==o;h+=s,c++)l=u[c],e[(h+f*p)*4+3]=255,e[(h+f*p)*4+2]=a[l*3+0],e[(h+f*p)*4+1]=a[l*3+1],e[(h+f*p)*4+0]=a[l*3+2];return e},e.prototype.getImageData16bits=function(e,t,n,r,i,s,o){var u=this.image,a=this.header.width,f,l=0,c,h;for(h=t;h!==r;h+=n)for(c=i;c!==o;c+=s,l+=2)f=u[l+0]+(u[l+1]<<8),e[(c+a*h)*4+0]=(f&31744)>>7,e[(c+a*h)*4+1]=(f&992)>>2,e[(c+a*h)*4+2]=(f&31)>>3,e[(c+a*h)*4+3]=f&32768?0:255;return e},e.prototype.getImageData24bits=function(e,t,n,r,i,s,o){var u=this.image,a=this.header.width,f=0,l,c;for(c=t;c!==r;c+=n)for(l=i;l!==o;l+=s,f+=3)e[(l+a*c)*4+3]=255,e[(l+a*c)*4+2]=u[f+0],e[(l+a*c)*4+1]=u[f+1],e[(l+a*c)*4+0]=u[f+2];return e},e.prototype.getImageData32bits=function(e,t,n,r,i,s,o){var u=this.image,a=this.header.width,f=0,l,c;for(c=t;c!==r;c+=n)for(l=i;l!==o;l+=s,f+=4)e[(l+a*c)*4+2]=u[f+0],e[(l+a*c)*4+1]=u[f+1],e[(l+a*c)*4+0]=u[f+2],e[(l+a*c)*4+3]=u[f+3];return e},e.prototype.getImageDataGrey8bits=function(e,t,n,r,i,s,o){var u=this.image,a=this.header.width,f,l=0,c,h;for(h=t;h!==r;h+=n)for(c=i;c!==o;c+=s,l++)f=u[l],e[(c+a*h)*4+0]=f,e[(c+a*h)*4+1]=f,e[(c+a*h)*4+2]=f,e[(c+a*h)*4+3]=255;return e},e.prototype.getImageDataGrey16bits=function(e,t,n,r,i,s,o){var u=this.image,a=this.header.width,f=0,l,c;for(c=t;c!==r;c+=n)for(l=i;l!==o;l+=s,f+=2)e[(l+a*c)*4+0]=u[f+0],e[(l+a*c)*4+1]=u[f+0],e[(l+a*c)*4+2]=u[f+0],e[(l+a*c)*4+3]=u[f+1];return e},e.prototype.isSupported=function(){return!0},e.prototype.toString=function(){return"TgaLoader"},e}),define("goo/util/ObjectUtil",[],function(){var e={},t=Array.prototype,n=t.slice,r=t.forEach;e.defaults=function(e){return i(n.call(arguments,1),function(t){if(t)for(var n in t)if(typeof e[n]=="undefined"||e[n]===null)e[n]=t[n]}),e},e.extend=function(e){return i(n.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},e.isObject=function(e){return e===Object(e)},e.clone=function(t){return e.isObject(t)?Array.isArray(t)?t.slice():e.extend({},t):t};var i=e.each=e.forEach=function(e,t,n,i){if(typeof e=="undefined"||e===null)return;if(r&&e.forEach===r)e.forEach(t,n);else if(e.length===+e.length)for(var s=0,o=e.length;s<o;s++)t.call(n,e[s],s,e);else{var u=Object.keys(e);i!==undefined&&u.sort(function(t,n){return e[t][i]-e[n][i]});for(var s=0,a=u.length;s<a;s++)t.call(n,e[u[s]],u[s],e)}};return e.deepClone=function(t){if(t===null||typeof t!="object")return t;if(Object.prototype.toString.call(t.buffer)==="[object ArrayBuffer]")return new t.constructor(t);if(t instanceof Array)return t.map(e.deepClone);if(t.nodeType&&typeof t.cloneNode=="function")return t.cloneNode(!0);var n={},r=Object.keys(t);for(var i=0;i<r.length;i++){var s=r[i];n[s]=e.deepClone(t[s])}return n},e.shallowSelectiveClone=function(e,t){var n={};return t.forEach(function(t){n[t]=e[t]}),n},e.cloneMap=function(e){var t=new Map;return e.forEach(function(e,n){t.set(n,e)}),t},e.cloneSet=function(e){var t=new Set;return e.forEach(function(e){t.add(e)}),t},e}),define("goo/renderer/RendererUtils",["goo/util/ObjectUtil"],function(e){function t(){}function n(e,t,n){var r=document.createElement("canvas");r.width=t,r.height=n;var i=r.getContext("2d"),s=i.createImageData(t,n);return s.data.set(e),i.putImageData(s,0,0),r}return t.getByteSize=function(e){switch(e){case"Byte":return 1;case"UnsignedByte":return 1;case"Short":return 2;case"UnsignedShort":return 2;case"Int":return 4;case"HalfFloat":return 2;case"Float":return 4;case"Double":return 8;default:throw"Unknown type: "+e}},t.checkGLError=function(e){var t=e.getError(),n=!1;while(t!==e.NO_ERROR){n=!0;if(t===e.INVALID_ENUM)console.error("An unacceptable value is specified for an enumerated argument. The offending command is ignored and has no other side effect than to set the error flag.");else if(t===e.INVALID_VALUE)console.error("A numeric argument is out of range. The offending command is ignored and has no other side effect than to set the error flag.");else if(t===e.INVALID_OPERATION)console.error("The specified operation is not allowed in the current state. The offending command is ignored and has no other side effect than to set the error flag.");else if(t===e.FRAMEBUFFER_COMPLETE)console.error("The command is trying to render to or read from the framebuffer while the currently bound framebuffer is not framebuffer complete (i.e. the return value from glCheckFramebufferStatus is not GL_FRAMEBUFFER_COMPLETE). The offending command is ignored and has no other side effect than to set the error flag.");else if(t===e.OUT_OF_MEMORY)throw"There is not enough memory left to execute the command. The state of the GL is undefined, except for the state of the error flags, after this error is recorded.";t=e.getError()}if(n)throw"Stopping due to error"},t.isPowerOfTwo=function(e){return(e&e-1)===0},t.nearestPowerOfTwo=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))},t.clone=e.deepClone,t._blankImages={},t.getBlankImage=function(e,n,r,i,s,o){var u=t.nearestPowerOfTwo(r),a=t.nearestPowerOfTwo(i);u=Math.min(u,s),a=Math.min(a,s);var f=n.length===4?"rgba("+Number(n[0]*255).toFixed(0)+","+Number(n[1]*255).toFixed(0)+","+Number(n[2]*255).toFixed(0)+","+Number(n[3]).toFixed(2)+")":"rgb("+Number(n[0]*255).toFixed(0)+","+Number(n[1]*255).toFixed(0)+","+Number(n[2]*255).toFixed(0)+")",l=f+u+"x"+a,c=t._blankImages[l];if(!c){c=document.createElement("canvas"),c.width=u,c.height=a;var h=c.getContext("2d");h.beginPath(),h.rect(0,0,u,a),h.fillStyle=f,h.fill(),t._blankImages[l]=c}o===undefined?e.image=c:(e.image.isData=!1,e.image.data[o]=c)},t.scaleImage=function(e,r,i,s,o,u){var a=t.nearestPowerOfTwo(i),f=t.nearestPowerOfTwo(s);a=Math.min(a,o),f=Math.min(f,o);if(r.width!==a||r.height!==f){var l=document.createElement("canvas");l.width=a,l.height=f,r.getAttribute&&l.setAttribute("data-ref",r.getAttribute("data-ref"));var c=l.getContext("2d");r.data?c.drawImage(n(r.data,r.width,r.height),0,0,r.width,r.height,0,0,a,f):c.drawImage(r,0,0,r.width,r.height,0,0,a,f),l.dataReady=!0,l.src=r.src,l.originalWidth=i,l.originalHeight=s,u===undefined?e.image=l:e.image.data[u]=l}},t}),define("goo/renderer/Util",["goo/renderer/RendererUtils"],function(e){return e}),define("goo/util/CanvasUtils",["goo/util/PromiseUtil"],function(e){function t(){}return t.loadCanvasFromPath=function(e,t){var n={};arguments.length===3&&(n=arguments[1],t=arguments[2]);var r=new Image;r.onerror=function(){console.error("Failed to load svg!"),t()},r.src=e;var i=document.createElement("canvas"),s=i.getContext("2d");r.onload=function(){if(r.width===0&&r.height===0)return t();n.width=n.width?n.width:r.width,n.height=n.height?n.height:r.height,n.sourceX=n.sourceX?n.sourceX:0,n.sourceY=n.sourceY?n.sourceY:0,n.sourceWidth=n.sourceWidth?n.sourceWidth:r.width,n.sourceHeight=n.sourceHeight?n.sourceHeight:r.height,n.destX=n.destX?n.destX:0,n.destY=n.destY?n.destY:0,n.destWidth=n.destWidth?n.destWidth:n.width,n.destHeight=n.destHeight?n.destHeight:n.height;if(n.resizeToFit){var e=n.sourceWidth/n.sourceHeight;e>1?(n.destHeight=n.destWidth/e,n.destY=(n.height-n.destHeight)*.5):e<1&&(n.destWidth=n.destHeight*e,n.destX=(n.width-n.destWidth)*.5)}i.width=n.width,i.height=n.height,s.drawImage(r,n.sourceX,n.sourceY,n.sourceWidth,n.sourceHeight,n.destX,n.destY,n.destWidth,n.destHeight),t(i)}},t.renderSvgToCanvas=function(e,n,r){var i=window.URL||window.webkitURL||window,s="data:image/svg+xml;base64,"+btoa(e);t.loadCanvasFromPath(s,n,r)},t.getMatrixFromCanvas=function(e){var t=e.getContext("2d"),n=function(n,r){return n<0||n>e.width||r<0||r>e.height?0:t.getImageData(n,r,1,1).data[0]/255},r=[];for(var i=0;i<e.width;i++){r.push([]);for(var s=0;s<e.height;s++)r[i].push(n(i,e.height-(s+1)))}return r},t.svgDataToImage=function(t){var n=window.URL||window.webkitURL||window,r=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),i=new Image;return i.src=n.createObjectURL(r),e.createPromise(function(e,t){i.onload=function(){e(i)},i.onerror=function(){t("Could not load SVG image.")}})},t}),define("goo/util/StringUtil",[],function(){function e(){}e.endsWith=function(e,t){return e.indexOf(t,e.length-t.length)!==-1},e.startsWith=function(e,t){return e.indexOf(t)===0},e.capitalize=function(e){return e.charAt(0).toUpperCase()+e.substring(1)},e.uncapitalize=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},e.createUniqueId=function(e){var t=Date.now(),n="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+Math.random()*16)%16|0;return e==="x"?n.toString(16):(n&3|8).toString(16)});return e===undefined?n:n+"."+e},e.getUntil=function(e,t){var n=e.indexOf(t);return n===-1?e:e.slice(0,n)},e.getAfterLast=function(e,t){var n=e.lastIndexOf(t);return n===-1?e:e.slice(n+t.length,e.length)},e.getFrom=function(e,t){var n=e.indexOf(t);return n===-1?"":e.slice(n+t.length,e.length)},e.getIndexedName=function(e,t,n){n||(n="_");var r=new RegExp(e+"("+n+"\\d+)?"),i,s=0;for(i in t){var o=t[i],u=r.exec(o);if(u)if(u.length>1&&u[1]){var a=parseInt(u[1].substring(n.length),10);a>=s&&(s=a+1)}else s=1}return e+n+s},e.getUniqueName=function(t,n,r){return n.indexOf(t)===-1?t:e.getIndexedName(t,n,r)},e.toAscii=function(e){return e.replace(/([^\x00-\x7F])/g,"x")},e.hashCode=function(e){var t=0;if(e.length===0)return t;for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);t=(t<<5)-t+r,t&=t}return btoa(t).replace("/","_").replace("+","-")};var t=Date.now();e.getUniqueId=function(){t++;var n=Array.prototype.slice.call(arguments,0).join("");return e.hashCode(t+""+n)},e.escapeHtmlEntities=function(e){var t=document.createElement("div");t.appendChild(document.createTextNode(e));var n={34:"quot"};return t.innerHTML.replace(/[\u00A0-\u2666\"\']/g,function(e){var t=n[e.charCodeAt(0)];return"&"+(t||"#"+e.charCodeAt(0))+";"})};var n=new RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([\\w\\d\\-\\u0100-\\uffff.%]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$");return e.parseURL=function(e){var t=e.match(n);return{scheme:t[1],user_info:t[2],domain:t[3],port:t[4],path:t[5],query_data:t[6],fragment:t[7]}},e}),define("goo/loaders/handlers/TextureHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Texture","goo/loaders/dds/DdsLoader","goo/loaders/crunch/CrunchLoader","goo/loaders/tga/TgaLoader","goo/util/rsvp","goo/util/PromiseUtil","goo/renderer/Util","goo/util/ObjectUtil","goo/util/CanvasUtils","goo/util/StringUtil","goo/entities/SystemBus"],function(e,t,n,r,i,s,o,u,a,f,l,c){function h(){e.apply(this,arguments),c.addListener("playStateChanged",function(e){this._objects.forEach(function(t){if(t.image&&t.image.play&&t.image.pause){var n=t.image;e==="play"?n.play():e==="stop"?(n.pause(),n.currentTime=0):e==="pause"&&n.pause()}})}.bind(this))}return h.prototype=Object.create(e.prototype),h.prototype.constructor=h,e._registerClass("texture",h),h.minFilters=["NearestNeighborNoMipMaps","NearestNeighborNearestMipMap","NearestNeighborLinearMipMap","BilinearNoMipMaps","BilinearNearestMipMap","Trilinear"],h.magFilters=["NearestNeighbor","Bilinear"],h.loaders={dds:n,crn:r,tga:i},h.WHITE=new Uint8Array([255,255,255,255]),h.BLACK=new Uint8Array([0,0,0,255]),h.prototype._prepare=function(e){a.defaults(e,{wrapS:"Repeat",wrapT:"Repeat",magFilter:"Bilinear",minFilter:"Trilinear",anisotropy:1,offset:[0,0],repeat:[1,1],flipY:!0,lodBias:0,loop:!0})},h.prototype._remove=function(e){var t=this._objects.get(e);t&&this.world.gooRunner&&t.destroy(this.world.gooRunner.renderer.context),this._objects.delete(e)},h.prototype._create=function(){return new t},h.prototype._loadWebSupportedImage=function(e,t,n){return this.loadObject(t.imageRef,n).then(function(t){return e.image!==t&&e.setImage(t),e})},h.prototype._loadSpecialImage=function(e,t,n,r){var i=h.loaders[n],s=t.imageRef;return e.a=s,this.loadObject(s).then(function(n){if(n&&n.preloaded)return a.extend(e.image,n.image),e.format=n.format,e.setNeedsUpdate(),e;var r=new i;return r.load(n,e,t.flipY,0,n.byteLength),e})},h.prototype._loadVideo=function(e,t,n){return this.loadObject(t.imageRef,n).then(function(r){r.width=r.videoWidth,r.height=r.videoHeight,r.loop=t.loop!==undefined?t.loop:!0;if(!u.isPowerOfTwo(r.width)||!u.isPowerOfTwo(r.height))e.generateMipmaps=!1,e.minFilter="BilinearNoMipMaps";return e.setImage(r),e.updateCallback=function(){return!r.paused},t.autoPlay!==!1&&!n.editMode?r.play():(r.pause(),r.currentTime=0),e})},h.prototype._loadImage=function(e,t,n){var r=t.imageRef,i=l.parseURL(r).path,s=i.substr(i.lastIndexOf(".")+1).toLowerCase();return h.loaders[s]?this._loadSpecialImage(e,t,s,n):["jpg","jpeg","png","gif"].indexOf(s)!==-1?this._loadWebSupportedImage(e,t,n):["mp4","ogv","webm"].indexOf(s)!==-1?this._loadVideo(e,t,n):o.reject(new Error("Unknown image type: "+s))},h.prototype._update=function(t,n,r){var i=this;return e.prototype._update.call(this,t,n,r).then(function(e){if(!e)return;var t;return e.wrapS=n.wrapS,e.wrapT=n.wrapT,h.magFilters.indexOf(n.magFilter)!==-1&&(e.magFilter=n.magFilter),h.minFilters.indexOf(n.minFilter)!==-1&&(e.minFilter=n.minFilter),e.anisotropy=Math.max(n.anisotropy,1),e.offset.setArray(n.offset),e.repeat.setArray(n.repeat),e.lodBias=n.lodBias,e.flipY!==n.flipY&&(e.flipY=n.flipY,e.setNeedsUpdate()),e.generateMipmaps!==n.generateMipmaps&&(e.generateMipmaps=n.generateMipmaps!==!1,e.setNeedsUpdate()),e.updateCallback=null,n.imageRef?n.lazy?(e.loadImage=function(){return i._loadImage(e,n,r)},t=e):t=i._loadImage(e,n,r):n.svgData?t=o.createPromise(function(t,r){f.renderSvgToCanvas(n.svgData,{},function(n){n?(e.setImage(n),t(e)):r("could not render svg to canvas")})}):t=e,r&&r.texture&&r.texture.dontwait?e:t})},h}),define("goo/util/Ajax",["goo/loaders/handlers/TextureHandler","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/util/StringUtil","goo/util/rsvp"],function(e,t,n,r,i){function s(e,t){e&&(this._rootPath=e,e.slice(-1)!=="/"&&(this._rootPath+="/")),this.options=t||{},this._cache={}}function o(e,t){for(var n=0;n<t.length;n++)e[t[n]]=!0;return e}return s.prototype.prefill=function(e,t){t?this._cache=e:n.extend(this._cache,e)},s.prototype.clear=function(){this._cache={}},s.prototype.get=function(e){e=e||{};var n=e.url||"",r="GET",i=new XMLHttpRequest;return i.open(r,n,!0),e.responseType&&(i.responseType=e.responseType),t.createPromise(function(e,t){var n=function(){i.readyState===4&&(i.status>=200&&i.status<=299?(i.removeEventListener("readystatechange",n),e(i)):(i.removeEventListener("readystatechange",n),t(i.statusText)))};i.addEventListener("readystatechange",n),i.send()})},s.ARRAY_BUFFER="arraybuffer",s.crossOrigin=!1,s.prototype.load=function(e,n){function f(e,t){return e&&s.types[t]&&s.types[t][e]}var o=this,u=r.parseURL(e).path,a=u.substr(u.lastIndexOf(".")+1).toLowerCase();e||t.reject("Path was undefined");if(e.indexOf(s.ENGINE_SHADER_PREFIX)===0)return t.resolve();if(this._cache[e]&&!n)return f(a,"bundle")&&this.prefill(this._cache[e],n),this._cache[e]instanceof i.Promise?this._cache[e]:t.resolve(this._cache[e]);var l=this._rootPath?this._rootPath+e:e;if(f(a,"image"))return this._cache[e]=this._loadImage(l);if(f(a,"video")){var c={mp4:"video/mp4",ogv:"video/ogg",webm:"video/webm"};return this._cache[e]=this._loadVideo(l,c[a])}if(f(a,"audio"))return this._cache[e]=this._loadAudio(l);var h={url:l};return f(a,"binary")&&(h.responseType=s.ARRAY_BUFFER),this._cache[e]=this.get(h).then(function(e){if(f(a,"bundle")){var t=JSON.parse(e.response);return o.prefill(t,n),t}return f(a,"json")?JSON.parse(e.response):e.response}).then(null,function(t){throw new Error("Could not load data from "+e+", "+t)})},s.prototype.update=function(e,n){return this._cache[e]=n,t.resolve(n)},s.prototype._loadImage=function(e){window.URL=window.URL||window.webkitURL;var n=new Image;return s.crossOrigin&&(n.crossOrigin="anonymous"),t.createPromise(function(t,r){var i=function(){n.dataReady=!0,window.URL&&window.URL.revokeObjectURL!==undefined&&window.URL.revokeObjectURL(n.src),n.removeEventListener("load",i),n.removeEventListener("error",s),t(n)},s=function(o){n.removeEventListener("load",i),n.removeEventListener("error",s),r("Could not load image from "+e+", "+o)};n.addEventListener("load",i,!1),n.addEventListener("error",s,!1),n.src=e})},s.prototype._loadVideo=function(e,n){var r=document.createElement("video");s.crossOrigin&&(r.crossOrigin="anonymous");var i=t.createPromise(function(t,n){r.addEventListener("canplay",function(){r.dataReady=!0,t(r)},!1),r.addEventListener("error",function(t){n("Could not load video from "+e+", "+t)},!1)}),o={url:e,responseType:s.ARRAY_BUFFER};return this.get(o).then(function(e){var t=new Blob([e.response],{type:n}),i=window.URL.createObjectURL(t);r.src=i}),i},s.prototype._loadAudio=function(e){var t={url:e,responseType:s.ARRAY_BUFFER};return this.get(t).then(function(e){return e.response}).then(null,function(t){throw new Error("Could not load data from "+e+", "+t)})},s.ENGINE_SHADER_PREFIX="GOO_ENGINE_SHADERS/",s.types={text:{vert:!0,frag:!0},json:{shader:!0,script:!0,entity:!0,material:!0,scene:!0,mesh:!0,texture:!0,skeleton:!0,animation:!0,clip:!0,bundle:!0,project:!0,machine:!0,posteffects:!0,animstate:!0,sound:!0,environment:!0,skybox:!0},image:{jpg:!0,jpeg:!0,png:!0,gif:!0},video:{mp4:!0,ogv:!0,webm:!0},binary:o({dat:!0,bin:!0},Object.keys(e.loaders)),audio:{mp3:!0,wav:!0,ogg:!0},bundle:{bundle:!0}},s.types.asset=o({},Object.keys(s.types.image).concat(Object.keys(s.types.binary))),s}),define("goo/util/ArrayUtil",[],function(){var e={};return e.getTypedArray=function(e,t){var n=t[0],r=t[1],i=t[2];if(i==="float32")return new Float32Array(e,n,r);if(i==="uint8")return new Uint8Array(e,n,r);if(i==="uint16")return new Uint16Array(e,n,r);if(i==="uint32")return new Uint32Array(e,n,r);throw new Error("Binary format "+i+" is not supported")},e.remove=function(e,t,n){var r=-1;if(typeof n=="function"){for(var i=0;i<e.length;i++)if(n(e[i],t)){r=i;break}}else r=e.indexOf(t);r>-1&&e.splice(r,1)},e.find=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n];return null},e.fromKeys=function(e){var t=[];return e.forEach(function(e,n){t.push(n)}),t},e.fromValues=function(e){var t=[];return e.forEach(function(e){t.push(e)}),t},e}),define("goo/renderer/BufferUtils",["goo/renderer/Capabilities"],function(e){function t(){}function n(){var e=["Trident","MSIE","Firefox","Safari","Chrome","Opera"],n=navigator.userAgent,r=e.length-1;for(r;r>-1&&n.indexOf(e[r])===-1;r--);t.browserType=e[r]}return t.createIndexBuffer=function(n,r){var i;if(r<=256)t.browserType==="Trident"?i=new Uint16Array(n):i=new Uint8Array(n);else if(r<=65536)i=new Uint16Array(n);else{if(!e.ElementIndexUInt)throw new Error("Maximum number of vertices is 65536. Got: "+r);i=new Uint32Array(n)}return i},n(),t.cloneTypedArray=function(e){return new e.constructor(e)},t}),define("goo/renderer/BufferData",["goo/renderer/BufferUtils"],function(e){function t(e,t){this.data=e,this.target=t,this.glBuffer=null,this._dataUsage="StaticDraw",this._dataNeedsRefresh=!1,Object.seal(this)}return t.prototype.setDataUsage=function(e){this._dataUsage=e},t.prototype.setDataNeedsRefresh=function(){this._dataNeedsRefresh=!0},t.prototype.destroy=function(e){e.deleteBuffer(this.glBuffer),this.glBuffer=null},t.prototype.copy=function(e){if(this.data instanceof ArrayBuffer){var t=new Uint8Array(e.data),n=new Uint8Array(this.data);n.set(t)}else this.data.set(e.data);return this.target=e.target,this.glBuffer=null,this._dataUsage=e._dataUsage,this._dataNeedsRefresh=!1,this},t.prototype.clone=function(){var n;this.data instanceof ArrayBuffer?n=this.data.slice(0):n=e.cloneTypedArray(this.data);var r=new t(n,this.target);return r._dataUsage=this._dataUsage,r._dataNeedsRefresh=!1,r},t}),define("goo/math/Vector3",["goo/math/Vector"],function(e){function t(){e.call(this,3),arguments.length!==0&&e.prototype.set.apply(this,arguments),Object.seal(this)}function r(e,t){var n=!1;return function(){return n||(n=!0,console.warn(t)),e.apply(this,arguments)}}t.prototype=Object.create(e.prototype),t.prototype.constructor=t,e.setupAliases(t.prototype,[["x","u","r"],["y","v","g"],["z","w","b"]]),t.ZERO=new t(0,0,0),t.ONE=new t(1,1,1),t.UNIT_X=new t(1,0,0),t.UNIT_Y=new t(0,1,0),t.UNIT_Z=new t(0,0,1);var n=new t;return t.add=function(e,n,r){typeof e=="number"&&(e=[e,e,e]),typeof n=="number"&&(n=[n,n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]+s[0],r.data[1]=i[1]+s[1],r.data[2]=i[2]+s[2],r},t.addv=r(function(e,n,r){return r||(r=new t),r.data[0]=e.data[0]+n.data[0],r.data[1]=e.data[1]+n.data[1],r.data[2]=e.data[2]+n.data[2],r},"The static method .addv is deprecated; please use the instance method .addVector instead"),t.prototype.add=function(e){return t.add(this,e,this)},t.sub=function(e,n,r){typeof e=="number"&&(e=[e,e,e]),typeof n=="number"&&(n=[n,n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]-s[0],r.data[1]=i[1]-s[1],r.data[2]=i[2]-s[2],r},t.subv=r(function(e,n,r){return r||(r=new t),r.data[0]=e.data[0]-n.data[0],r.data[1]=e.data[1]-n.data[1],r.data[2]=e.data[2]-n.data[2],r},"The static method .subv is deprecated; please use the instance method .subVector instead"),t.prototype.sub=function(e){return t.sub(this,e,this)},t.prototype.invert=function(){return this.data[0]=0-this.data[0],this.data[1]=0-this.data[1],this.data[2]=0-this.data[2],this},t.mul=function(e,n,r){r||(r=new t);if(typeof e=="number"){var i=n.data||n;r.data[0]=e*i[0],r.data[1]=e*i[1],r.data[2]=e*i[2]}else if(typeof n=="number"){var s=e.data||e;r.data[0]=s[0]*n,r.data[1]=s[1]*n,r.data[2]=s[2]*n}else{var s=e.data||e,i=n.data||n;r.data[0]=s[0]*i[0],r.data[1]=s[1]*i[1],r.data[2]=s[2]*i[2]}return r},t.prototype.mul=function(e){return t.mul(this,e,this)},t.div=function(e,n,r){r||(r=new t);if(typeof e=="number"){var i=n.data||n;r.data[0]=e/i[0],r.data[1]=e/i[1],r.data[2]=e/i[2]}else if(typeof n=="number"){var s=1/n,o=e.data||e;r.data[0]=o[0]*s,r.data[1]=o[1]*s,r.data[2]=o[2]*s}else{var o=e.data||e,i=n.data||n;r.data[0]=o[0]/i[0],r.data[1]=o[1]/i[1],r.data[2]=o[2]/i[2]}return r},t.prototype.div=function(e){return t.div(this,e,this)},t.dot=function(e,t){typeof e=="number"&&(e=[e,e,e]),typeof t=="number"&&(t=[t,t,t]);var n=e.data||e,r=t.data||t;return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]},t.prototype.dot=function(e){return t.dot(this,e)},t.dotv=r(function(e,t){var n=e.data,r=t.data;return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]},"The static method .dotv is deprecated; please use the instance method .dotVector instead"),t.prototype.dotVector=function(e){var t=this.data,n=e.data;return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},t.cross=function(e,n,r){r||(r=new t);var i=e.data||e,s=n.data||n,o=s[2]*i[1]-s[1]*i[2],u=s[0]*i[2]-s[2]*i[0],a=s[1]*i[0]-s[0]*i[1];return r.data[0]=o,r.data[1]=u,r.data[2]=a,r},t.prototype.cross=function(e){return t.cross(this,e,this)},t.prototype.lerp=function(e,t){return this.data[0]=(1-t)*this.data[0]+t*e.data[0],this.data[1]=(1-t)*this.data[1]+t*e.data[1],this.data[2]=(1-t)*this.data[2]+t*e.data[2],this},t.prototype.reflect=function(e){return n.copy(e),n.scale(2*this.dot(e)),this.subVector(n),this},t.prototype.setDirect=function(e,t,n){return this.data[0]=e,this.data[1]=t,this.data[2]=n,this},t.prototype.setd=r(t.prototype.setDirect,".setd is deprecated; please use .setDirect instead"),t.prototype.setArray=function(e){return this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this},t.prototype.seta=r(t.prototype.setArray,".seta is deprecated; please use .setArray instead"),t.prototype.setVector=function(e){return this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this},t.prototype.setv=r(t.prototype.setVector,".setv is deprecated; please use .setVector instead"),t.prototype.addDirect=function(e,t,n){return this.data[0]+=e,this.data[1]+=t,this.data[2]+=n,this},t.prototype.add_d=r(t.prototype.addDirect,".add_d is deprecated; please use .addDirect instead"),t.prototype.addVector=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this},t.prototype.addv=r(t.prototype.addVector,".addv is deprecated; please use .addVector instead"),t.prototype.mulDirect=function(e,t,n){return this.data[0]*=e,this.data[1]*=t,this.data[2]*=n,this},t.prototype.muld=r(t.prototype.mulDirect,".muld is deprecated; please use .mulDirect instead"),t.prototype.mulVector=function(e){return this.data[0]*=e.data[0],this.data[1]*=e.data[1],this.data[2]*=e.data[2],this},t.prototype.mulv=r(t.prototype.mulVector,".mulv is deprecated; please use .mulVector instead"),t.prototype.subDirect=function(e,t,n){return this.data[0]-=e,this.data[1]-=t,this.data[2]-=n,this},t.prototype.sub_d=r(t.prototype.subDirect,".sub_d is deprecated; please use .subDirect instead"),t.prototype.subVector=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this},t.prototype.subv=r(t.prototype.subVector,".subv is deprecated; please use .subVector instead"),t.prototype.scale=function(e){return this.data[0]*=e,this.data[1]*=e,this.data[2]*=e,this},t.prototype.lengthSquared=function(){return this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]},t.prototype.length=function(){return Math.sqrt(this.lengthSquared())},t.prototype.normalize=function(){var e=this.length();return e<1e-7?(this.data[0]=0,this.data[1]=0,this.data[2]=0):(e=1/e,this.data[0]*=e,this.data[1]*=e,this.data[2]*=e),this},t.distanceSquared=function(e,t){var n=e.data[0]-t.data[0],r=e.data[1]-t.data[1],i=e.data[2]-t.data[2];return n*n+r*r+i*i},t.distance=function(e,n){return Math.sqrt(t.distanceSquared(e,n))},t.prototype.distanceSquared=function(e){return t.distanceSquared(this,e)},t.prototype.distance=function(e){return t.distance(this,e)},t.prototype.clone=function(){return(new t).copy(this)},t.prototype.copy=t.prototype.setVector,e.addPostChecks(t.prototype,["add","sub","mul","div","invert","dot","dotVector","cross","lerp","reflect","setDirect","setArray","setVector","addDirect","addVector","subDirect","subVector","mulDirect","mulVector","scale","lengthSquared","length","normalize","distanceSquared","distance"]),t}),define("goo/math/Vector4",["goo/math/Vector"],function(e){function t(){e.call(this,4),arguments.length!==0&&e.prototype.set.apply(this,arguments),Object.seal(this)}function n(e,t){var n=!1;return function(){return n||(n=!0,console.warn(t)),e.apply(this,arguments)}}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,e.setupAliases(t.prototype,[["x","r"],["y","g"],["z","b"],["w","a"]]),t.ZERO=new t(0,0,0,0),t.ONE=new t(1,1,1,1),t.UNIT_X=new t(1,0,0,0),t.UNIT_Y=new t(0,1,0,0),t.UNIT_Z=new t(0,0,1,0),t.UNIT_W=new t(0,0,0,1),t.add=function(e,n,r){typeof e=="number"&&(e=[e,e,e,e]),typeof n=="number"&&(n=[n,n,n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]+s[0],r.data[1]=i[1]+s[1],r.data[2]=i[2]+s[2],r.data[3]=i[3]+s[3],r},t.prototype.add=function(e){return t.add(this,e,this)},t.sub=function(e,n,r){typeof e=="number"&&(e=[e,e,e,e]),typeof n=="number"&&(n=[n,n,n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]-s[0],r.data[1]=i[1]-s[1],r.data[2]=i[2]-s[2],r.data[3]=i[3]-s[3],r},t.prototype.sub=function(e){return t.sub(this,e,this)},t.mul=function(e,n,r){typeof e=="number"&&(e=[e,e,e,e]),typeof n=="number"&&(n=[n,n,n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]*s[0],r.data[1]=i[1]*s[1],r.data[2]=i[2]*s[2],r.data[3]=i[3]*s[3],r},t.prototype.mul=function(e){return t.mul(this,e,this)},t.div=function(e,n,r){typeof e=="number"&&(e=[e,e,e,e]),typeof n=="number"&&(n=[n,n,n,n]),r||(r=new t);var i=e.data||e,s=n.data||n;return r.data[0]=i[0]/s[0],r.data[1]=i[1]/s[1],r.data[2]=i[2]/s[2],r.data[3]=i[3]/s[3],r},t.prototype.div=function(e){return t.div(this,e,this)},t.dot=function(e,t){typeof e=="number"&&(e=[e,e,e,e]),typeof t=="number"&&(t=[t,t,t,t]);var n=e.data||e,r=t.data||t;return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]+n[3]*r[3]},t.prototype.dot=function(e){return t.dot(this,e)},t.prototype.dotVector=function(e){var t=this.data,n=e.data;return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},t.prototype.lerp=function(e,t){return this.x=(1-t)*this.x+t*e.x,this.y=(1-t)*this.y+t*e.y,this.z=(1-t)*this.z+t*e.z,this.w=(1-t)*this.w+t*e.w,this},t.prototype.setDirect=function(e,t,n,r){return this.data[0]=e,this.data[1]=t,this.data[2]=n,this.data[3]=r,this},t.prototype.setd=n(t.prototype.setDirect,".setd is deprecated; please use .setDirect instead"),t.prototype.setArray=function(e){return this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this},t.prototype.seta=n(t.prototype.setArray,".seta is deprecated; please use .setArray instead"),t.prototype.setVector=function(e){return this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[3]=e.data[3],this},t.prototype.setv=n(t.prototype.setVector,".setv is deprecated; please use .setVector instead"),t.prototype.addDirect=function(e,t,n,r){return this.data[0]+=e,this.data[1]+=t,this.data[2]+=n,this.data[3]+=r,this},t.prototype.addVector=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this},t.prototype.mulDirect=function(e,t,n,r){return this.data[0]*=e,this.data[1]*=t,this.data[2]*=n,this.data[3]*=r,this},t.prototype.mulVector=function(e){return this.data[0]*=e.data[0],this.data[1]*=e.data[1],this.data[2]*=e.data[2],this.data[3]*=e.data[3],this},t.prototype.subDirect=function(e,t,n,r){return this.data[0]-=e,this.data[1]-=t,this.data[2]-=n,this.data[3]-=r,this},t.prototype.subVector=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this},t.prototype.scale=function(e){return this.data[0]*=e,this.data[1]*=e,this.data[2]*=e,this.data[3]*=e,this},t.prototype.clone=function(){return(new t).copy(this)},t.prototype.copy=t.prototype.setVector,e.addPostChecks(t.prototype,["add","sub","mul","div","dot","dotVector","lerp","setDirect","setArray","setVector","addDirect","addVector","subDirect","subVector","mulDirect","mulVector","scale"]),t}),define("goo/renderer/MeshData",["goo/renderer/BufferData","goo/renderer/Util","goo/renderer/BufferUtils","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o){function a(e,t,n){this.attributeMap=e,this.vertexCount=this._vertexCountStore=t!==undefined?t:0,this.indexCount=n!==undefined?n:0,this.primitiveCounts=[0],this.vertexData=null,this.indexData=null,this.dataViews={},this.indexLengths=null,this.indexModes=["Triangles"],this.type=a.MESH,this.paletteMap=undefined,this.weightsPerVertex=undefined,this.boundingBox=undefined,this.store=undefined,this.wireframeData=undefined,this.flatMeshData=undefined,this._attributeDataNeedsRefresh=!1,this._dirtyAttributeNames=new Set,this.rebuildData(this.vertexCount,this.indexCount),Object.seal(this)}function d(e){var t={};for(var n=0;n<e.length;n++){var r=e[n];if(p[r]===undefined)throw new Error("No default attribute named: "+r);t[r]=o.deepClone(p[r])}return t}var u=window.Uint8ClampedArray;a.MESH=0,a.SKINMESH=1,a.prototype.rebuildData=function(e,t,n){var r={},i=null;if(n){var s=Object.keys(this.attributeMap);for(var o=0;o<s.length;o++){var u=s[o],a=this.dataViews[u];a&&(r[u]=a)}this.indexData&&(i=this.indexData.data)}this.rebuildVertexData(e),this.rebuildIndexData(t);if(n){var s=Object.keys(this.attributeMap);for(var o=0;o<s.length;o++){var u=s[o],f=r[u];f&&this.dataViews[u].set(f)}i&&this.indexData.data.set(i)}},a.prototype.rebuildVertexData=function(n){isNaN(n)||(this.vertexCount=n,this._vertexCountStore=this.vertexCount);if(this.vertexCount>0){var r=0,i=Object.keys(this.attributeMap);for(var s=0;s<i.length;s++){var o=this.attributeMap[i[s]];r+=t.getByteSize(o.type)*o.count}this.vertexData=new e(new ArrayBuffer(r*this.vertexCount),"ArrayBuffer"),this.generateAttributeData()}},a.prototype.rebuildIndexData=function(t){t!==undefined&&(this.indexCount=t);if(this.indexCount>0){var r=n.createIndexBuffer(this.indexCount,this.vertexCount);this.indexData=new e(r,"ElementArrayBuffer")}},a.prototype.setVertexDataUpdated=function(){this.vertexData._dataNeedsRefresh=!0},a.prototype.setAttributeDataUpdated=function(e){this._dirtyAttributeNames.add(e),this._attributeDataNeedsRefresh=!0},a.prototype.getSectionCount=function(){return this.indexLengths?this.indexLengths.length:1},a.prototype.getPrimitiveCount=function(e){return e>=0&&e<this.primitiveCounts.length?this.primitiveCounts[e]:0},a.prototype.getPrimitiveVertices=function(e,t,n){var r=this.getPrimitiveCount(t);if(e>=r||e<0)throw new Error("Invalid primitiveIndex '"+e+"'.  Count is "+r);var s=this.indexModes[t],o=a.getVertexCount(s),u=n||[];u.length=o;var f=this.getAttributeBuffer(a.POSITION);for(var l=0;l<o;l++){u[l]||(u[l]=new i);if(this.getIndexBuffer()){var c=this.getIndexBuffer()[this.getVertexIndex(e,l,t)];u[l].x=f[c*3+0],u[l].y=f[c*3+1],u[l].z=f[c*3+2]}else{var c=this.getVertexIndex(e,l,t);u[l].x=f[c*3+0],u[l].y=f[c*3+1],u[l].z=f[c*3+2]}}return u},a.prototype.getVertexIndex=function(e,t,n){var r=0;for(var i=0;i<n;i++)r+=this.indexLengths[i];switch(this.indexModes[n]){case"Triangles":r+=e*3+t;break;case"TriangleStrip":r+=e+t;break;case"TriangleFan":t===0?r+=0:r+=e+t;break;case"Points":r+=e;break;case"Lines":r+=e*2+t;break;case"LineStrip":case"LineLoop":r+=e+t;break;default:return a.logger.warning("unimplemented index mode: "+this.indexModes[n]),-1}return r},a.prototype.getTotalPrimitiveCount=function(){var e=0;for(var t=0,n=this.primitiveCounts.length;t<n;t++)e+=this.primitiveCounts[t];return e},a.prototype.updatePrimitiveCounts=function(){var e=this.indexData?this.indexData.data.length:this.vertexCount,t=this.getSectionCount();this.primitiveCounts.length!==t&&(this.primitiveCounts=[]);for(var n=0;n<t;n++){var r=this.indexLengths?this.indexLengths[n]:e,i=a.getPrimitiveCount(this.indexModes[n],r);this.primitiveCounts[n]=i}},a.getPrimitiveCount=function(e,t){switch(e){case"Triangles":return t/3;case"TriangleFan":case"TriangleStrip":return t-2;case"Lines":return t/2;case"LineStrip":return t-1;case"LineLoop":return t;case"Points":return t}throw new Error("unimplemented index mode: "+e)},a.getVertexCount=function(e){switch(e){case"Triangles":case"TriangleFan":case"TriangleStrip":return 3;case"Lines":case"LineStrip":case"LineLoop":return 2;case"Points":return 1}throw new Error("unimplemented index mode: "+e)};var f={Byte:Int8Array,UnsignedByte:Uint8Array,UnsignedByteClamped:u,Short:Int16Array,UnsignedShort:Uint16Array,Int:Int32Array,UnsignedInt:Uint32Array,Float:Float32Array};a.prototype.generateAttributeData=function(){var e=this.vertexData.data,n,r=0;for(var i in this.attributeMap){var s=this.attributeMap[i];s.offset=r;var o=this.vertexCount*s.count;r+=o*t.getByteSize(s.type);var u=f[s.type];if(!u)throw new Error("Unsupported DataType: "+s.type);n=new u(e,s.offset,o),this.dataViews[i]=n,s.hashKey=s.count+"_"+s.type+"_"+s.stride+"_"+s.offset+"_"+s.normalized}},a.prototype.makeInterleavedData=function(){var n=0,r=0;for(var i in this.attributeMap){var s=this.attributeMap[i];s.offset=n,n+=s.count*t.getByteSize(s.type)}var o=new e(new ArrayBuffer(n*this.vertexCount),this.vertexData.target);o._dataUsage=this.vertexData._dataUsage,o._dataNeedsRefresh=!0;var u=new DataView(o.data);for(var i in this.attributeMap){var a=this.dataViews[i],s=this.attributeMap[i];s.stride=n;var r=s.offset,f=s.count,l=t.getByteSize(s.type),c=this.getDataMethod(s.type),h=u[c];for(var p=0;p<this.vertexCount;p++)for(var d=0;d<f;d++)h.apply(u,[r+n*p+d*l,a[p*f+d],!0])}this.vertexData=o},a.prototype.getDataMethod=function(e){switch(e){case"Byte":return"setInt8";case"UnsignedByte":return"setUInt8";case"Short":return"setInt16";case"UnsignedShort":return"setUInt16";case"Int":return"setInt32";case"HalfFloat":return"setInt16";case"Float":return"setFloat32"}},a.prototype.getAttributeBuffer=function(e){return this.dataViews[e]},a.prototype.getIndexData=function(){return this.indexData},a.prototype.getIndexBuffer=function(){return this.indexData!==null?this.indexData.data:null},a.prototype.getIndexLengths=function(){return this.indexLengths},a.prototype.getIndexModes=function(){return this.indexModes},a.prototype.resetVertexCount=function(){this.vertexCount=this._vertexCountStore},a.prototype.applyTransform=function(e,t){var n=new i,r=this.getAttributeBuffer(e),s=r.length;if(e===a.POSITION)for(var o=0;o<s;o+=3)n.setDirect(r[o+0],r[o+1],r[o+2]),t.matrix.applyPostPoint(n),r[o+0]=n[0],r[o+1]=n[1],r[o+2]=n[2];else if(e===a.NORMAL)for(var o=0;o<s;o+=3)n.setDirect(r[o+0],r[o+1],r[o+2]),t.rotation.applyPost(n),r[o+0]=n[0],r[o+1]=n[1],r[o+2]=n[2];else if(e===a.TANGENT)for(var o=0;o<s;o+=3)n.setDirect(r[o+0],r[o+1],r[o+2]),t.rotation.applyPost(n),r[o+0]=n[0],r[o+1]=n[1],r[o+2]=n[2];return this},a.prototype.applyFunction=function(e,t){var n,o,u=this.getAttributeBuffer(e),a=u.length,f=this.attributeMap[e].count;switch(f){case 1:for(var l=0;l<a;l++)u[l]=t(u[l]);break;case 2:n=new r;for(var l=0;l<a;l+=2)n.setDirect(u[l+0],u[l+1]),o=t(n),u[l+0]=o[0],u[l+1]=o[1];break;case 3:n=new i;for(var l=0;l<a;l+=3)n.setDirect(u[l+0],u[l+1],u[l+2]),o=t(n),u[l+0]=o[0],u[l+1]=o[1],u[l+2]=o[2];break;case 4:n=new s;for(var l=0;l<a;l+=4)n.setDirect(u[l+0],u[l+1],u[l+2],u[l+3]),o=t(n),u[l+0]=o[0],u[l+1]=o[1],u[l+2]=o[2],u[l+3]=o[3]}return this},a.prototype.getNormalsMeshData=function(e){if(this.getAttributeBuffer("POSITION")===undefined)return;if(this.getAttributeBuffer("NORMAL")===undefined)return;e=e!==undefined?e:1;var t=[],n=[],r=this.dataViews.POSITION.length/3;for(var i=0;i<r;i++)t.push(this.dataViews.POSITION[i*3+0],this.dataViews.POSITION[i*3+1],this.dataViews.POSITION[i*3+2],this.dataViews.POSITION[i*3+0]+this.dataViews.NORMAL[i*3+0]*e,this.dataViews.POSITION[i*3+1]+this.dataViews.NORMAL[i*3+1]*e,this.dataViews.POSITION[i*3+2]+this.dataViews.NORMAL[i*3+2]*e);for(var i=0;i<r*2;i+=2)n.push(i,i+1);var s=new a(a.defaultMap([a.POSITION]),t.length,n.length);return s.getAttributeBuffer(a.POSITION).set(t),s.getIndexBuffer().set(n),s.indexModes[0]="Lines",s},a.prototype.buildWireframeData=function(){var e=o.deepClone(this.attributeMap),t=new a(e,this.vertexCount,0);t.indexModes[0]="Lines";var n=this.getIndexBuffer(),r;n?r=function(e,t,r){return n[this.getVertexIndex(e,t,r)]}.bind(this):r=function(e,t,n){return this.getVertexIndex(e,t,n)}.bind(this);var i=[],s=0;this.updatePrimitiveCounts();for(var u=0;u<this.getSectionCount();u++){var f=this.indexModes[u],l=this.getPrimitiveCount(u);for(var c=0;c<l;c++)switch(f){case"Triangles":case"TriangleFan":case"TriangleStrip":var h=r(c,0,u),p=r(c,1,u),d=r(c,2,u);i[s+0]=h,i[s+1]=p,i[s+2]=p,i[s+3]=d,i[s+4]=d,i[s+5]=h,s+=6;break;case"Lines":case"LineStrip":var h=r(c,0,u),p=r(c,1,u);i[s+0]=h,i[s+1]=p,s+=2;break;case"LineLoop":var h=r(c,0,u),p=r(c,1,u);c===l-1&&(p=r(0,0,u)),i[s+0]=h,i[s+1]=p,s+=2;break;case"Points":}}if(s>0){t.rebuildIndexData(s);for(var v in e)t.getAttributeBuffer(v).set(this.getAttributeBuffer(v));t.getIndexBuffer().set(i)}return t.paletteMap=this.paletteMap,t.weightsPerVertex=this.weightsPerVertex,t};var l=new i,c=new i,h=new i;a.prototype.buildFlatMeshData=function(){var e=this.getIndexBuffer();if(e===null)return console.debug("No indices, probably a point mesh"),this;var t=o.deepClone(this.attributeMap),n={};for(var r in t)n[r]={oldBuffer:this.getAttributeBuffer(r),values:[]};var i=0;this.updatePrimitiveCounts();for(var s=0;s<this.getSectionCount();s++){var u=this.indexModes[s],f=this.getPrimitiveCount(s),p=!1;for(var d=0;d<f;d++)switch(u){case"TriangleStrip":p=d%2===1?!0:!1;case"Triangles":case"TriangleFan":var v=e[this.getVertexIndex(d,0,s)],m=e[this.getVertexIndex(d,1,s)],g=e[this.getVertexIndex(d,2,s)];if(p){var y=g;g=m,m=y}for(var r in n){if(r===a.NORMAL)continue;var b=t[r].count;for(var w=0;w<b;w++)n[r].values[i*b+w]=n[r].oldBuffer[v*b+w],n[r].values[(i+1)*b+w]=n[r].oldBuffer[m*b+w],n[r].values[(i+2)*b+w]=n[r].oldBuffer[g*b+w];r===a.POSITION&&(l.setDirect(n[r].values[i*3],n[r].values[i*3+1],n[r].values[i*3+2]),c.setDirect(n[r].values[(i+1)*3],n[r].values[(i+1)*3+1],n[r].values[(i+1)*3+2]),h.setDirect(n[r].values[(i+2)*3],n[r].values[(i+2)*3+1],n[r].values[(i+2)*3+2]),c.subVector(l),h.subVector(l),c.cross(h).normalize(),n[a.NORMAL]&&(n[a.NORMAL].values[i*3]=c.data[0],n[a.NORMAL].values[i*3+1]=c.data[1],n[a.NORMAL].values[i*3+2]=c.data[2],n[a.NORMAL].values[(i+1)*3]=c.data[0],n[a.NORMAL].values[(i+1)*3+1]=c.data[1],n[a.NORMAL].values[(i+1)*3+2]=c.data[2],n[a.NORMAL].values[(i+2)*3]=c.data[0],n[a.NORMAL].values[(i+2)*3+1]=c.data[1],n[a.NORMAL].values[(i+2)*3+2]=c.data[2]))}i+=3}}if(i===0)return console.warn("Could not build flat data"),this;var E=new a(t,i);for(var r in n)E.getAttributeBuffer(r).set(n[r].values);return E.paletteMap=this.paletteMap,E.weightsPerVertex=this.weightsPerVertex,E},a.prototype.destroy=function(e){this.vertexData&&this.vertexData.destroy(e),this.indexData&&this.indexData.destroy(e)},a.prototype.clone=function(){var e=o.deepClone(this.attributeMap),t=new a(e,this.vertexCount,this.indexCount);return t.primitiveCounts=this.primitiveCounts.slice(0),t.vertexData.copy(this.vertexData),t.indexData.copy(this.indexData),t.indexLengths=Array.isArray(this.indexLengths)?this.indexLengths.slice(0):this.indexLengths,t.indexModes=this.indexModes.slice(0),t.type=this.type,this.paletteMap&&(t.paletteMap=this.paletteMap.slice(0)),t.weightsPerVertex=this.weightsPerVertex,t},a.POSITION="POSITION",a.NORMAL="NORMAL",a.COLOR="COLOR",a.TANGENT="TANGENT",a.TEXCOORD0="TEXCOORD0",a.TEXCOORD1="TEXCOORD1",a.TEXCOORD2="TEXCOORD2",a.TEXCOORD3="TEXCOORD3",a.WEIGHTS="WEIGHTS",a.JOINTIDS="JOINTIDS",a.createAttribute=function(e,t,n){return{count:e,type:t,stride:0,offset:0,normalized:n!==undefined?n:!1}};var p={POSITION:a.createAttribute(3,"Float"),NORMAL:a.createAttribute(3,"Float"),COLOR:a.createAttribute(4,"Float"),TANGENT:a.createAttribute(4,"Float"),TEXCOORD0:a.createAttribute(2,"Float"),TEXCOORD1:a.createAttribute(2,"Float"),TEXCOORD2:a.createAttribute(2,"Float"),TEXCOORD3:a.createAttribute(2,"Float"),WEIGHTS:a.createAttribute(4,"Float"),JOINTIDS:a.createAttribute(4,"Float")};return a.defaultMap=function(e){return e===undefined?d(Object.keys(p)):d(e)},a}),define("goo/shapes/Box",["goo/renderer/MeshData","goo/util/ObjectUtil"],function(e,t){function n(t,r,i,s,o,u){if(arguments.length===1&&arguments[0]instanceof Object){var a=arguments[0];t=a.width,r=a.height,i=a.length,s=a.tileX,o=a.tileY,u=a.textureMode}this.xExtent=t!==undefined?t*.5:.5,this.yExtent=r!==undefined?r*.5:.5,this.zExtent=i!==undefined?i*.5:.5,this.tileX=s||1,this.tileY=o||1,typeof u=="string"&&(u=n.TextureModes[u]),this.textureMode=u!==undefined?u:n.TextureModes.Uniform;var f=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]);e.call(this,f,24,36),this.rebuild()}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.rebuild=function(){function f(e){for(var t=0;t<e.length;t++){var n=e[t]*3;a.push(u[n]),a.push(u[n+1]),a.push(u[n+2])}}function h(){for(var e=0;e<l.length/3;e++)for(var t=0;t<4;t++){var n=e*3;c.push(l[n]),c.push(l[n+1]),c.push(l[n+2])}}var t=this.xExtent,r=this.yExtent,i=this.zExtent,s=this.tileX,o=this.tileY,u=[-t,-r,-i,t,-r,-i,t,r,-i,-t,r,-i,t,-r,i,-t,-r,i,t,r,i,-t,r,i],a=[];f([0,1,2,3,1,4,6,2,4,5,7,6,5,0,3,7,2,6,7,3,0,5,4,1]),this.getAttributeBuffer(e.POSITION).set(a);var l=[0,0,-1,1,0,0,0,0,1,-1,0,0,0,1,0,0,-1,0],c=[];h(),this.getAttributeBuffer(e.NORMAL).set(c);var p=[];if(this.textureMode===n.TextureModes.Uniform)for(var d=0;d<6;d++)p.push(s),p.push(0),p.push(0),p.push(0),p.push(0),p.push(o),p.push(s),p.push(o);else p.push(1,1/3,.75,1/3,.75,2/3,1,2/3),p.push(.75,1/3,.5,1/3,.5,2/3,.75,2/3),p.push(.5,1/3,.25,1/3,.25,2/3,.5,2/3),p.push(.25,1/3,0,1/3,0,2/3,.25,2/3),p.push(.5,1,.5,2/3,.25,2/3,.25,1),p.push(.25,0,.25,1/3,.5,1/3,.5,0);return this.getAttributeBuffer(e.TEXCOORD0).set(p),this.getIndexBuffer().set([2,1,0,3,2,0,6,5,4,7,6,4,10,9,8,11,10,8,14,13,12,15,14,12,18,17,16,19,18,16,22,21,20,23,22,20]),this},n.prototype.clone=function(){var e=t.shallowSelectiveClone(this,["tileX","tileY","textureMode"]);return e.width=this.xExtent*2,e.height=this.yExtent*2,e.length=this.zExtent*2,new n(e)},n.TextureModes={Uniform:"Uniform",Unfolded:"Unfolded"},n}),define("goo/shapes/Quad",["goo/renderer/MeshData","goo/util/ObjectUtil"],function(e,t){function n(t,n,r,i){if(arguments.length===1&&arguments[0]instanceof Object){var s=arguments[0];t=s.width,n=s.height,r=s.tileX,i=s.tileY}this.xExtent=t!==undefined?t*.5:.5,this.yExtent=n!==undefined?n*.5:.5,this.tileX=r||1,this.tileY=i||1;var o=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]);e.call(this,o,4,6),this.rebuild()}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.rebuild=function(){var t=this.xExtent,n=this.yExtent,r=this.tileX,i=this.tileY;return this.getAttributeBuffer(e.POSITION).set([-t,-n,0,-t,n,0,t,n,0,t,-n,0]),this.getAttributeBuffer(e.NORMAL).set([0,0,1,0,0,1,0,0,1,0,0,1]),this.getAttributeBuffer(e.TEXCOORD0).set([0,0,0,i,r,i,r,0]),this.getIndexBuffer().set([0,3,1,1,3,2]),this},n.prototype.clone=function(){var e=t.shallowSelectiveClone(this,["xExtent","yExtent","tileX","tileY"]);return new n(e)},n}),define("goo/shapes/Sphere",["goo/renderer/MeshData","goo/math/Vector3","goo/math/MathUtils","goo/util/ObjectUtil"],function(e,t,n,r){function i(t,n,r,s){if(arguments.length===1&&arguments[0]instanceof Object){var o=arguments[0];t=o.zSamples,n=o.radialSamples,r=o.radius,s=o.textureMode}this.zSamples=(t!==undefined?t:8)+1,this.radialSamples=n!==undefined?n:8,this.radius=r!==undefined?r:.5,typeof s=="string"&&(s=i.TextureModes[s]),this.textureMode=s!==undefined?s:i.TextureModes.Polar,this.viewInside=!1;var u=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]),a=this.textureMode===i.TextureModes.Chromeball?this.zSamples+1:this.zSamples;this._useSharedPoleVertices=this.textureMode!==i.TextureModes.Projected&&this.textureMode!==i.TextureModes.Linear;var f=this._useSharedPoleVertices?2:0,l=(a-f)*(this.radialSamples+1)+f,c=6*(a-2)*this.radialSamples;e.call(this,u,l,c),this.rebuild()}function s(e,t,n){e[n*3+0]=e[t*3+0],e[n*3+1]=e[t*3+1],e[n*3+2]=e[t*3+2]}return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.rebuild=function(){var r=this.getAttributeBuffer(e.POSITION),o=this.getAttributeBuffer(e.NORMAL),u=this.getAttributeBuffer(e.TEXCOORD0),a=this.getIndexBuffer(),f=1/this.radialSamples,l=2/(this.zSamples-1),c=[],h=[];for(var p=0;p<this.radialSamples;p++){var d=n.TWO_PI*f*p;h[p]=Math.cos(d),c[p]=Math.sin(d)}c[this.radialSamples]=c[0],h[this.radialSamples]=h[0];var v=0,m=this.zSamples;this._useSharedPoleVertices&&(v=1,m=this.zSamples-1);var g=0,y=new t,b=new t,w=new t;for(var E=v;E<m;E++){var S=n.HALF_PI*(-1+l*E),x=Math.sin(S),T=this.radius*x,N=b.set(0,0,0);N.z+=T;var C=Math.sqrt(Math.abs(this.radius*this.radius-T*T)),k,L=g;for(var p=0;p<this.radialSamples;p++){var A=p*f,O=w.set(h[p],c[p],0);t.mul(O,C,y),r[g*3+0]=N.x+y.x,r[g*3+1]=N.y+y.y,r[g*3+2]=N.z+y.z,k=y.set(r[g*3+0],r[g*3+1],r[g*3+2]),k.normalize(),this.viewInside?(o[g*3+0]=-k.x,o[g*3+1]=-k.y,o[g*3+2]=-k.z):(o[g*3+0]=k.x,o[g*3+1]=k.y,o[g*3+2]=k.z);var M=0;!this._useSharedPoleVertices&&(E===v||E===m-1)&&(M=.5*f);if(this.textureMode===i.TextureModes.Linear)u[g*2+0]=A+M,u[g*2+1]=.5*(x+1);else if(this.textureMode===i.TextureModes.Projected)u[g*2+0]=A+M,u[g*2+1]=(n.HALF_PI+Math.asin(x))/Math.PI;else if(this.textureMode===i.TextureModes.Polar){var _=(n.HALF_PI-Math.abs(S))/Math.PI,D=_*h[p]+.5,P=_*c[p]+.5;u[g*2+0]=D,u[g*2+1]=P}else if(this.textureMode===i.TextureModes.Chromeball){var _=Math.sin((n.HALF_PI+S)/2);_/=2;var D=_*h[p]+.5,P=_*c[p]+.5;u[g*2+0]=D,u[g*2+1]=P}g++}s(r,L,g),s(o,L,g);if(this.textureMode===i.TextureModes.Linear)u[g*2+0]=1,u[g*2+1]=.5*(x+1);else if(this.textureMode===i.TextureModes.Projected)u[g*2+0]=1,u[g*2+1]=(n.HALF_PI+Math.asin(x))/Math.PI;else if(this.textureMode===i.TextureModes.Polar){var _=(n.HALF_PI-Math.abs(S))/Math.PI;u[g*2+0]=_+.5,u[g*2+1]=.5}else if(this.textureMode===i.TextureModes.Chromeball){var _=Math.sin((n.HALF_PI+S)/2);_/=2,u[g*2+0]=_+.5,u[g*2+1]=.5}g++}if(this.textureMode===i.TextureModes.Chromeball){var H=n.HALF_PI-.001,B=this.radius*Math.sin(H),j=Math.sqrt(Math.abs(this.radius*this.radius-B*B)),L=g;for(var p=0;p<this.radialSamples;p++){r[g*3+0]=j*h[p],r[g*3+1]=j*c[p],r[g*3+2]=B;var k=y.set(r[g*3+0],r[g*3+1],r[g*3+2]);k.normalize(),this.viewInside?(o[g*3+0]=-k.x,o[g*3+1]=-k.y,o[g*3+2]=-k.z):(o[g*3+0]=k.x,o[g*3+1]=k.y,o[g*3+2]=k.z);var _=Math.sin((n.HALF_PI+H)/2);_/=2;var D=_*h[p]+.5,P=_*c[p]+.5;u[g*2+0]=D,u[g*2+1]=P,g++}s(r,L,g),s(o,L,g);var _=Math.sin((n.HALF_PI+H)/2);_/=2,u[g*2+0]=_+.5,u[g*2+1]=.5,g++}this._useSharedPoleVertices&&(r[g*3+0]=0,r[g*3+1]=0,r[g*3+2]=-this.radius,this.viewInside?(o[g*3+0]=0,o[g*3+1]=0,o[g*3+2]=1):(o[g*3+0]=0,o[g*3+1]=0,o[g*3+2]=-1),this.textureMode===i.TextureModes.Polar||this.textureMode===i.TextureModes.Chromeball?(u[g*2+0]=.5,u[g*2+1]=.5):(u[g*2+0]=.5,u[g*2+1]=0),g++,r[g*3+0]=0,r[g*3+1]=0,r[g*3+2]=this.radius,this.viewInside?(o[g*3+0]=0,o[g*3+1]=0,o[g*3+2]=-1):(o[g*3+0]=0,o[g*3+1]=0,o[g*3+2]=1),this.textureMode===i.TextureModes.Polar?(u[g*2+0]=.5,u[g*2+1]=.5):this.textureMode===i.TextureModes.Chromeball?(u[g*2+0]=1,u[g*2+1]=-0.5):(u[g*2+0]=.5,u[g*2+1]=1));var F=0,I=this.textureMode===i.TextureModes.Chromeball?this.zSamples+1:this.zSamples,q=0;this._useSharedPoleVertices||(q=this.radialSamples+1);for(var E=0;E<I-3;E++){var R=q,U=R+1;q+=this.radialSamples+1;var z=q,W=z+1;for(var g=0;g<this.radialSamples;g++)this.viewInside?(a[F++]=R++,a[F++]=z,a[F++]=U,a[F++]=U++,a[F++]=z++,a[F++]=W++):(a[F++]=R++,a[F++]=U,a[F++]=z,a[F++]=U++,a[F++]=W++,a[F++]=z++)}for(var g=0;g<this.radialSamples;g++){var R,U,z;this._useSharedPoleVertices?(R=g,U=this.vertexCount-2,z=g+1):(R=g,U=g+this.radialSamples+2,z=g+this.radialSamples+1),this.viewInside?(a[F++]=R,a[F++]=z,a[F++]=U):(a[F++]=R,a[F++]=U,a[F++]=z)}var X=(m-v-1)*(this.radialSamples+1);for(var g=0;g<this.radialSamples;g++){var R,U,z;this._useSharedPoleVertices?(R=g+X,U=g+1+X,z=this.vertexCount-1):(R=g+X-this.radialSamples-1,U=g+X-this.radialSamples,z=g+X),this.viewInside?(a[F++]=R,a[F++]=z,a[F++]=U):(a[F++]=R,a[F++]=U,a[F++]=z)}return this},i.prototype.clone=function(){var e=r.shallowSelectiveClone(this,["zSamples","radialSamples","radius","textureMode"]);return new i(e)},i.TextureModes={Linear:"Linear",Projected:"Projected",Polar:"Polar",Chromeball:"Chromeball"},i}),define("goo/shapes/Cylinder",["goo/renderer/MeshData","goo/math/Vector3","goo/util/ObjectUtil"],function(e,t,n){function r(t,n,r,i){if(arguments.length===1&&arguments[0]instanceof Object){var s=arguments[0];t=s.radialSamples,n=s.radiusTop,r=s.radiusBottom,i=s.height}this.radialSamples=t||8,this.radiusTop=typeof n=="undefined"?.5:n,this.radiusBottom=typeof r=="undefined"?this.radiusTop:r,this.height=typeof i=="undefined"?1:i,this.radius=this.radiusTop;var o=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]);e.call(this,o,this.radialSamples*4+2+2,this.radialSamples*3*4),this.indexModes=["Triangles"],this.rebuild()}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.rebuild=function(){var n=[],r=[],i=[],s=[],o=this.height,u=o/2,a=this.radiusTop,f=this.radiusBottom,l=this.radialSamples,c=Math.PI*2/l,h=1/l,p=l*4+2+2-1,d=new t,v=0;o&&(v=Math.tan((f-a)/o));for(var m=0,g=0,y=0;m<l;m++,g+=c,y+=h){var b=Math.cos(g),w=Math.sin(g),E=b*a,S=w*a,x=b*f,T=w*f;n.push(E,S,u,x,T,-u,E,S,u,x,T,-u),d.setDirect(b,w,v),d.normalize(),r.push(0,0,1,0,0,-1,d.x,d.y,d.z,d.x,d.y,d.z),i.push(b/4+.25,w/4+.75,b/4+.25,w/4+.25,.5,y,1,y)}n.push(a,0,u,f,0,-u),r.push(1,0,0,1,0,0),i.push(.5,1,1,1);for(var m=0;m<l-1;m++)s.push(p,m*4+0,m*4+4,m*4+1,p-1,m*4+5,m*4+4+2,m*4+2,m*4+4+3,m*4+2,m*4+3,m*4+4+3);return s.push(p,m*4+0,0,m*4+1,p-1,1,m*4+4,m*4+2,m*4+5,m*4+2,m*4+3,m*4+5),n.push(0,0,-u,0,0,u),r.push(0,0,-0.5,0,0,.5),i.push(.25,.25,.25,.75),this.getAttributeBuffer(e.POSITION).set(n),this.getAttributeBuffer(e.NORMAL).set(r),this.getAttributeBuffer(e.TEXCOORD0).set(i),this.getIndexBuffer().set(s),this},r.prototype.clone=function(){var e=n.shallowSelectiveClone(this,["radialSamples","radiusTop","radiusBottom","height"]);return new r(e)},r}),define("goo/shapes/Torus",["goo/renderer/MeshData","goo/math/Vector3","goo/math/MathUtils","goo/util/ObjectUtil"],function(e,t,n,r){function i(t,n,r,i){if(arguments.length===1&&arguments[0]instanceof Object){var s=arguments[0];t=s.circleSamples,n=s.radialSamples,r=s.tubeRadius,i=s.centerRadius}this.circleSamples=t!==undefined?t:8,this.radialSamples=n!==undefined?n:8,this.tubeRadius=r!==undefined?r:1,this.centerRadius=i!==undefined?i:2,this.viewInside=!1;var o=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]),u=(this.circleSamples+1)*(this.radialSamples+1),a=6*this.circleSamples*this.radialSamples;e.call(this,o,u,a),this.rebuild()}function s(e,t,n){e[n*3+0]=e[t*3+0],e[n*3+1]=e[t*3+1],e[n*3+2]=e[t*3+2]}function o(e,t,n){e[n*2+0]=e[t*2+0],e[n*2+1]=e[t*2+1]}return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.rebuild=function(){var r=this.getAttributeBuffer(e.POSITION),i=this.getAttributeBuffer(e.NORMAL),u=this.getAttributeBuffer(e.TEXCOORD0),a=this.getIndexBuffer(),f=1/this.circleSamples,l=1/this.radialSamples,c=0,h=new t,p=new t,d=new t;for(var v=0;v<this.circleSamples;v++){var m=v*f,g=n.TWO_PI*m,y=Math.cos(g),b=Math.sin(g);h.set(y,b,0),t.mul(h,this.centerRadius,p);var w=c;for(var E=0;E<this.radialSamples;E++){var S=E*l,x=n.TWO_PI*S,T=Math.cos(x),N=Math.sin(x);d.copy(h).mul(T),d.z=d.z+N,d.normalize(),this.viewInside?(i[c*3+0]=-d.x,i[c*3+1]=-d.y,i[c*3+2]=-d.z):(i[c*3+0]=d.x,i[c*3+1]=d.y,i[c*3+2]=d.z),d.mul(this.tubeRadius).add(p),r[c*3+0]=d.x,r[c*3+1]=d.y,r[c*3+2]=d.z,u[c*2+0]=S,u[c*2+1]=m,c++}s(r,w,c),s(i,w,c),u[c*2+0]=1,u[c*2+1]=m,c++}for(var C=0;C<=this.radialSamples;C++,c++)s(r,C,c),s(i,C,c),o(u,C,c),u[c*2+1]=1;var k=0,L=0;for(var v=0;v<this.circleSamples;v++){var A=L,O=A+1;L+=this.radialSamples+1;var M=L,_=M+1;for(c=0;c<this.radialSamples;c++)this.viewInside?(a[k++]=A++,a[k++]=O,a[k++]=M,a[k++]=O++,a[k++]=_++,a[k++]=M++):(a[k++]=A++,a[k++]=M,a[k++]=O,a[k++]=O++,a[k++]=M++,a[k++]=_++)}return this},i.prototype.clone=function(){var e=r.shallowSelectiveClone(this,["circleSamples","radialSamples","tubeRadius","centerRadius"]);return new i(e)},i}),define("goo/shapes/Disk",["goo/renderer/MeshData","goo/util/ObjectUtil"],function(e,t){function n(t,n,r){if(arguments.length===1&&arguments[0]instanceof Object){var i=arguments[0];t=i.nSegments,n=i.radius,r=i.pointiness}this.nSegments=t||8,this.radius=n||1,this.pointiness=r||0;var s=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]);e.call(this,s,this.nSegments+1,this.nSegments*3),this.indexModes=["Triangles"],this.rebuild()}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.rebuild=function(){var t=[],n=[],r=[],i=[],s=Math.atan2(this.radius,this.pointiness),o=Math.PI*2/this.nSegments;for(var u=0,a=0;u<this.nSegments;u++,a+=o)t.push(Math.cos(a)*this.radius,Math.sin(a)*this.radius,0),n.push(Math.cos(a)*Math.cos(s),Math.sin(a)*Math.cos(s),Math.sin(s)),r.push(Math.cos(a)*.5+.5,Math.sin(a)*.5+.5),i.push(this.nSegments,u,(u+1)%this.nSegments);return t.push(0,0,this.pointiness),n.push(0,0,1),r.push(.5,.5),this.getAttributeBuffer(e.POSITION).set(t),this.getAttributeBuffer(e.NORMAL).set(n),this.getAttributeBuffer(e.TEXCOORD0).set(r),this.getIndexBuffer().set(i),this},n.prototype.clone=function(){var e=t.shallowSelectiveClone(this,["nSegments","radius","pointiness"]);return new n(e)},n}),define("goo/shapes/Cone",["goo/renderer/MeshData","goo/util/ObjectUtil"],function(e,t){function n(t,n,r){if(arguments.length===1&&arguments[0]instanceof Object){var i=arguments[0];t=i.radialSamples,n=i.radius,r=i.height}this.radialSamples=t||8,this.radius=n||1,this.height=typeof r=="undefined"?2:r;var s=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]);e.call(this,s,this.radialSamples*3+this.radialSamples+1,this.radialSamples*3*2),this.indexModes=["Triangles"],this.rebuild()}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.rebuild=function(){var t=[],n=[],r=[],i=[],s=Math.atan2(this.radius,this.height),o=Math.PI*2/this.radialSamples,u=1/this.radialSamples;for(var a=0,f=0,l=0;a<this.radialSamples;a++,f+=o,l+=u)t.push(0,0,this.height,Math.cos(f)*this.radius,Math.sin(f)*this.radius,0,Math.cos(f+o)*this.radius,Math.sin(f+o)*this.radius,0),n.push(0,0,1,Math.cos(f)*Math.cos(s),Math.sin(f)*Math.cos(s),Math.sin(s),Math.cos(f+o)*Math.cos(s),Math.sin(f+o)*Math.cos(s),Math.sin(s)),r.push(l+u/2,1,l,.5,l+u,.5),i.push(a*3+0,a*3+1,a*3+2);var c=a*3+0;t.push(0,0,0),n.push(0,0,-1),r.push(.25,.25);for(var a=1,f=0;a<=this.radialSamples-1;a++,f+=o)t.push(Math.cos(f)*this.radius,Math.sin(f)*this.radius,0),n.push(0,0,-1),r.push(Math.cos(f)*.25+.25,Math.sin(f)*.25+.25),i.push(c+a,c,c+a+1);return t.push(Math.cos(f)*this.radius,Math.sin(f)*this.radius,0),n.push(0,0,-1),r.push(Math.cos(f)*.25+.25,Math.sin(f)*.25+.25),i.push(c+this.radialSamples,c,c+1),this.getAttributeBuffer(e.POSITION).set(t),this.getAttributeBuffer(e.NORMAL).set(n),this.getAttributeBuffer(e.TEXCOORD0).set(r),this.getIndexBuffer().set(i),this},n.prototype.clone=function(){var e=t.shallowSelectiveClone(this,["radialSamples","radius","height"]);return new n(e)},n}),define("goo/util/ShapeCreatorMemoized",["goo/shapes/Box","goo/shapes/Quad","goo/shapes/Sphere","goo/shapes/Cylinder","goo/shapes/Torus","goo/shapes/Disk","goo/shapes/Cone"],function(e,t,n,r,i,s,o){function u(){}function f(e,t){var n=Object.keys(t),r=n.map(function(e){return e+""+t[e]}).join("");return e+r}function l(e,t,n){var r=f(e,t);if(a[r])return a[r];var i=n();return a[r]=i,i}var a={};return u.createQuad=function(e,n){var r=1,i=1,s=1,o=1;return!n||r!==n.xExtent||i!==n.yExtent||s!==n.tileX||o!==n.tileY?l("quad",{},function(){return new t(r,i,s,o)}):n},u.createBox=function(t,n){t=t||{},t.textureMode=t.textureMode||"Uniform";var r=1,i=1,s=1,o=1,u=1;return!n||r!==n.xExtent||i!==n.yExtent||s!==n.zExtent||o!==n.tileX||u!==n.tileY||t.textureMode!==n.textureMode.name?l("box",t,function(){return new e(r,i,s,o,u,t.textureMode)}):n},u.createSphere=function(e,t){return e=e||{},e.zSamples=e.zSamples||8,e.radialSamples=e.radialSamples||8,e.textureMode=e.textureMode||"Projected",e.radius=e.radius||1,!t||e.zSamples!==t.zSamples-1||e.radialSamples!==t.radialSamples||e.textureMode!==t.textureMode.name||e.radius!==t.radius?l("sphere",e,function(){return new n(e.zSamples,e.radialSamples,e.radius,e.textureMode)}):t},u.createCylinder=function(e,t){return e=e||{},e.radialSamples=e.radialSamples||8,e.radius=e.radius||1,!t||e.radialSamples!==t.radialSamples||e.radius!==t.radius?l("cylinder",e,function(){return new r(e.radialSamples,e.radius)}):t},u.createTorus=function(e,t){return e=e||{},e.radialSamples=e.radialSamples||8,e.circleSamples=e.circleSamples||12,e.tubeRadius=e.tubeRadius||.2,e.centerRadius=e.centerRadius||1,!t||e.radialSamples!==t._radialSamples||e.circleSamples!==t._circleSamples||e.tubeRadius!==t._tubeRadius||e.centerRadius!==t._centerRadius?new i(e.circleSamples,e.radialSamples,e.tubeRadius,e.centerRadius):t},u.createDisk=function(e,t){return e=e||{},e.radialSamples=e.radialSamples||8,e.pointiness=typeof e.pointiness=="undefined"?0:e.pointiness,e.radius=e.radius||1,!t||e.radialSamples!==t.nSegments||e.pointiness!==t.pointiness||e.radius!==t.radius?e.pointiness===Math.floor(e.pointiness)?l("disk",e,function(){return new s(e.radialSamples,e.radius,e.pointiness)}):new s(e.radialSamples,e.radius,e.pointiness):t},u.createCone=function(e,t){return e=e||{},e.radialSamples=e.radialSamples||8,e.height=typeof e.height=="undefined"?0:e.height,e.radius=e.radius||1,!t||e.radialSamples!==t.radialSamples||e.height!==t.height||e.radius!==t.radius?e.height===Math.floor(e.height)?l("cone",e,function(){return new o(e.radialSamples,e.radius,e.height)}):new o(e.radialSamples,e.radius,e.height):t},u.clearCache=function(e){var t=Object.keys(a);for(var n=0;n<t[n];n++){var r=t[n],i=a[r];e&&i.destroy(e),delete a[r]}},u}),define("goo/entities/Selection",[],function(){function e(){this.stack=[];if(arguments.length===1){var n=arguments[0];n instanceof e?n.top&&this.stack.push(n.top):Array.isArray(n)?this.stack.push(n):this.stack.push([n])}else arguments.length>1&&this.stack.push(Array.prototype.slice.call(arguments,0));this.stack.length>0&&(this.stack[0]=t(this.stack[0])),this.top=this.stack.length===0?null:this.stack[0]}function t(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n];e.lastIndexOf(r)===n&&t.push(r)}return t}function n(){if(arguments.length===1){var t=arguments[0];return t instanceof e?t.top?t.top:[]:Array.isArray(t)?t:[t]}return arguments.length>1?Array.prototype.slice.call(arguments,0):[]}return e.EMPTY=new e,e.prototype.contains=function(e){return this.top===null?!1:this.top.indexOf(e)!==-1},e.prototype.size=function(){return this.top===null?0:this.top.length},e.prototype.each=function(e){if(this.top===null)return this;for(var t=0;t<this.top.length;t++)if(e(this.top[t],t)===!1)break;return this},e.prototype.forEach=e.prototype.each,e.prototype.filter=function(e){if(this.top===null)return this;var t=this.top.filter(e);return this.stack.push(t),this.top=t,this},e.prototype.map=function(e){if(this.top===null)return this;var t=this.top.map(e);return this.stack.push(t),this.top=t,this},e.prototype.flatMap=function(e){if(this.top===null)return this;var t=this.top.map(e),n=t.reduce(function(e,t){return e.concat(t)},[]);return this.stack.push(n),this.top=n,this},e.prototype.reduce=function(e,t){if(this.top===null)return this;var n=[this.top.reduce(e,t)];return this.stack.push(n),this.top=n,this},e.prototype.and=function(){if(this.top===null)return this;var e=n.apply(null,arguments),r=this.top.concat(e);return r=t(r),this.stack.push(r),this.top=r,this},e.prototype.intersects=function(e){if(this.top===null)return this;var e=n.apply(null,arguments),t=[],r,i;e.length>this.top.length?(r=this.top,i=e):(r=e,i=this.top);for(var s=0;s<r.length;s++){var o=r[s];i.indexOf(o)!==-1&&t.push(o)}return this.stack.push(t),this.top=t,this},e.prototype.without=function(){if(this.top===null)return this;var e=n.apply(null,arguments),t=[];for(var r=0;r<this.top.length;r++){var i=this.top[r];e.indexOf(i)===-1&&t.push(i)}return this.stack.push(t),this.top=t,this},e.prototype.andSelf=function(){if(this.top===null)return this;if(this.stack.length<=1)return this;var e=this.stack[this.stack.length-2],n=e.concat(this.top);return n=t(n),this.stack.push(n),this.top=n,this},e.prototype.end=function(){return this.top===null?this:(this.stack.pop(),this.stack.length===0?this.top=null:this.top=this.stack[this.stack.length-1],this)},e.prototype.first=function(){return this.top===null?null:this.top[0]},e.prototype.clone=function(){var t=new e;return t.top=this.top,t.stack=this.stack.concat([]),t},e.prototype.get=function(e){return typeof e!="number"?this.top===null?[]:this.top.concat([]):e<0?this.top===null?undefined:this.top[this.top.length+e]:this.top===null?undefined:this.top[e]},e.prototype.toArray=function(){return this.top===null?[]:this.top.concat([])},e}),define("goo/entities/EntitySelection",["goo/entities/Selection"],function(e){function t(){e.apply(this,arguments)}function n(){if(arguments.length===1){var e=arguments[0];return e instanceof t?e.top?e.top:[]:Array.isArray(e)?e:[e]}return arguments.length>1?Array.prototype.slice.call(arguments,0):[]}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.and=function(){if(this.top===null)return this;var e,t=n.apply(null,arguments),r,i;t.length>this.top.length?(r=this.top,i=t):(r=t,i=this.top);var s=[];for(var o=0;o<i.length;o++){var u=i[o].id;s[u]=!0}e=i.concat([]);for(var o=0;o<r.length;o++)s[r[o].id]||e.push(r[o]);return this.stack.push(e),this.top=e,this},t.prototype.intersects=function(){if(this.top===null)return this;var e,t=n.apply(null,arguments),r,i;t.length>this.top.length?(r=this.top,i=t):(r=t,i=this.top);var s=[];for(var o=0;o<i.length;o++){var u=i[o].id;s[u]=!0}e=[];for(var o=0;o<r.length;o++)s[r[o].id]&&e.push(r[o]);return this.stack.push(e),this.top=e,this},t.prototype.without=function(){if(this.top===null)return this;var e,t=n.apply(null,arguments),r=[];for(var i=0;i<t.length;i++){var s=t[i].id;r[s]=!0}e=[];for(var i=0;i<this.top.length;i++)r[this.top[i].id]||e.push(this.top[i]);return this.stack.push(e),this.top=e,this},t.prototype.andSelf=function(){if(this.top===null)return this;if(this.stack.length<=1)return this;var e=this.stack[this.stack.length-2];return this.and.apply(this,e)},t.prototype.parent=function(){if(this.top===null)return this;var e=[],t=this.top.filter(function(t){return t.transformComponent.parent?e[t.transformComponent.parent.entity.id]?!1:(e[t.transformComponent.parent.entity.id]=!0,!0):!1}).map(function(e){return e.transformComponent.parent.entity});return this.stack.push(t),this.top=t,this},t.prototype.children=function(){if(this.top===null)return this;var e=this.top.map(function(e){return e.transformComponent.children.map(function(e){return e.entity})}),t=e.reduce(function(e,t){return e.concat(t)},[]);return this.stack.push(t),this.top=t,this},t.installMethod=function(e,n,r){t.prototype[n]=function(){if(this.top===null)return this;for(var t=0;t<this.top.length;t++){var n=this.top[t];n.hasComponent(r)&&e.apply(n,arguments)}return this}},t}),define("goo/entities/components/Component",["goo/entities/EntitySelection"],function(e){function t(){this.enabled=!0,this.installedAPI=new Set}return t.prototype.applyAPI=function(e){var t=this.api;if(!t)return;var n=Object.keys(t);for(var r=0;r<n.length;r++){var i=n[r];typeof e[i]=="undefined"?(e[i]=t[i],this.installedAPI.add(i)):console.warn("Could not install method "+i+" of "+this.type+" as it is already taken")}},t.prototype.removeAPI=function(e){this.installedAPI.forEach(function(t){delete e[t]})},t.applyEntitySelectionAPI=function(t,n){if(!t)return;var r=Object.keys(t);for(var i=0;i<r.length;i++){var s=r[i];typeof e[s]=="undefined"?e.installMethod(t[s],s,n):console.warn("Could not install method "+s+" on EntitySelection as it is already taken")}},t}),define("goo/math/Matrix",["goo/math/MathUtils"],function(e){function t(e,t){this.rows=e||0,this.cols=t||0,this.data=new Float64Array(this.rows*this.cols),this.data32=new Float32Array(this.rows*this.cols)}return t.setupAliases=function(e,t){t.forEach(function(t,n){t.forEach(function(t){Object.defineProperty(e,t,{get:function(){return this.data[n]},set:function(e){this.data[n]=e;if(isNaN(this.data[n]))throw new Error("Tried setting NaN to matrix component "+t)}})}),Object.defineProperty(e,n,{get:function(){return this.data[n]},set:function(e){this.data[n]=e;if(isNaN(this.data[n]))throw new Error("Tried setting NaN to matrix component "+n)}})})},t.prototype.checkIntegrity=function(){for(var e=0;e<this.data.length;e++)if(isNaN(this.data[e]))throw new Error("Matrix contains NaN at index "+e)},t.addPostCheck=function(e,t){var n=e[t];e[t]=function(){var e=n.apply(this,arguments);if(typeof e=="number"&&isNaN(e))throw new Error("Matrix method "+t+" returned NaN");return this.checkIntegrity(),e}},t.addPostChecks=function(e,n){n.forEach(t.addPostCheck.bind(null,e))},t.add=function(e,n,r){var i=e.rows,s=e.cols;r||(r=new t(i,s));if(n instanceof t)for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]+n.data[o];else for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]+n;return r},t.prototype.add=function(e){return t.add(this,e,this)},t.sub=function(e,n,r){var i=e.rows,s=e.cols;r||(r=new t(i,s));if(n instanceof t)for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]-n.data[o];else for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]-n;return r},t.prototype.sub=function(e){return t.sub(this,e,this)},t.mul=function(e,n,r){var i=e.rows,s=e.cols;r||(r=new t(i,s));if(n instanceof t)for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]*n.data[o];else for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]*n;return r},t.prototype.mul=function(e){return t.mul(this,e,this)},t.div=function(e,n,r){var i=e.rows,s=e.cols;r||(r=new t(i,s));if(n instanceof t)for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]/n.data[o];else{n=1/n;for(var o=0;o<e.data.length;o++)r.data[o]=e.data[o]*n}return r},t.prototype.div=function(e){return t.div(this,e,this)},t.combine=function(e,n,r){var i=e.rows,s=n.cols,o=e.cols=n.rows;r||(r=new t(i,s));if(r===e||r===n)return t.copy(t.combine(e,n),r);for(var u=0;u<s;u++){var a=u*i;for(var f=0;f<i;f++){var l=0;for(var c=0;c<o;c++)l+=e.data[c*e.rows+f]*n.data[u*n.rows+c];r.data[a+f]=l}}return r},t.prototype.combine=function(e){return t.combine(this,e,this)},t.transpose=function(e,n){var r=e.cols,i=e.rows;n||(n=new t(r,i));if(n===e)return t.copy(t.transpose(e),n);for(var s=0;s<i;s++){var o=s*r;for(var u=0;u<r;u++)n.data[o+u]=e.data[u*i+s]}return n},t.prototype.transpose=function(){return t.transpose(this,this)},t.copy=function(e,n){var r=e.rows,i=e.cols;return n||(n=new t(r,i)),n.data.set(e.data),n},t.prototype.copy=function(e){return t.copy(e,this)},t.equals=function(t,n){if(t.rows!==n.rows||t.cols!==n.cols)return!1;for(var r=0;r<t.data.length;r++)if(!(Math.abs(t.data[r]-n.data[r])<=e.EPSILON))return!1;return!0},t.prototype.equals=function(e){return t.equals(this,e)},t.prototype.isOrthogonal=function(){for(var t=0;t<this.cols;t++)for(var n=t+1;n<this.cols;n++){var r=t*this.rows,i=n*this.rows,s=0;for(var o=0;o<this.rows;o++)s+=this.data[r+o]*this.data[i+o];if(Math.abs(s)>e.EPSILON)return!1}return!0},t.prototype.isNormal=function(){for(var t=0;t<this.cols;t++){var n=t*this.rows,r=0;for(var i=0;i<this.rows;i++)r+=this.data[n+i]*this.data[n+i];if(Math.abs(r-1)>e.EPSILON)return!1}return!0},t.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},t.prototype.clone=function(){return t.copy(this)},t.prototype.set=function(){if(arguments.length===1&&typeof arguments[0]=="object")if(arguments[0]instanceof t)this.copy(arguments[0]);else for(var e=0;e<arguments[0].length;e++)this.data[e]=arguments[0][e];else for(var e=0;e<arguments.length;e++)this.data[e]=arguments[e];return this},t.prototype.toString=function(){var e="";for(var t=0;t<this.cols;t++){var n=t*this.rows;e+="[";for(var r=0;r<this.rows;r++)e+=this.data[n+r],e+=r!==this.rows-1?", ":"";e+=t!==this.cols-1?"], ":"]"}return e},t}),define("goo/math/Matrix4x4",["goo/math/MathUtils","goo/math/Matrix"],function(e,t){function n(){t.call(this,4,4),arguments.length===0?(this.data[0]=1,this.data[5]=1,this.data[10]=1,this.data[15]=1):t.prototype.set.apply(this,arguments),Object.seal(this)}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,t.setupAliases(n.prototype,[["e00"],["e10"],["e20"],["e30"],["e01"],["e11"],["e21"],["e31"],["e02"],["e12"],["e22"],["e32"],["e03"],["e13"],["e23"],["e33"]]),n.IDENTITY=new n(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),n.add=function(e,t,r){return r||(r=new n),t instanceof n?(r.e00=e.e00+t.e00,r.e10=e.e10+t.e10,r.e20=e.e20+t.e20,r.e30=e.e30+t.e30,r.e01=e.e01+t.e01,r.e11=e.e11+t.e11,r.e21=e.e21+t.e21,r.e31=e.e31+t.e31,r.e02=e.e02+t.e02,r.e12=e.e12+t.e12,r.e22=e.e22+t.e22,r.e32=e.e32+t.e32,r.e03=e.e03+t.e03,r.e13=e.e13+t.e13,r.e23=e.e23+t.e23,r.e33=e.e33+t.e33):(r.e00=e.e00+t,r.e10=e.e10+t,r.e20=e.e20+t,r.e30=e.e30+t,r.e01=e.e01+t,r.e11=e.e11+t,r.e21=e.e21+t,r.e31=e.e31+t,r.e02=e.e02+t,r.e12=e.e12+t,r.e22=e.e22+t,r.e32=e.e32+t,r.e03=e.e03+t,r.e13=e.e13+t,r.e23=e.e23+t,r.e33=e.e33+t),r},n.prototype.add=function(e){return n.add(this,e,this)},n.sub=function(e,t,r){return r||(r=new n),t instanceof n?(r.e00=e.e00-t.e00,r.e10=e.e10-t.e10,r.e20=e.e20-t.e20,r.e30=e.e30-t.e30,r.e01=e.e01-t.e01,r.e11=e.e11-t.e11,r.e21=e.e21-t.e21,r.e31=e.e31-t.e31,r.e02=e.e02-t.e02,r.e12=e.e12-t.e12,r.e22=e.e22-t.e22,r.e32=e.e32-t.e32,r.e03=e.e03-t.e03,r.e13=e.e13-t.e13,r.e23=e.e23-t.e23,r.e33=e.e33-t.e33):(r.e00=e.e00-t,r.e10=e.e10-t,r.e20=e.e20-t,r.e30=e.e30-t,r.e01=e.e01-t,r.e11=e.e11-t,r.e21=e.e21-t,r.e31=e.e31-t,r.e02=e.e02-t,r.e12=e.e12-t,r.e22=e.e22-t,r.e32=e.e32-t,r.e03=e.e03-t,r.e13=e.e13-t,r.e23=e.e23-t,r.e33=e.e33-t),r},n.prototype.sub=function(e){return n.sub(this,e,this)},n.mul=function(e,t,r){return r||(r=new n),t instanceof n?(r.e00=e.e00*t.e00,r.e10=e.e10*t.e10,r.e20=e.e20*t.e20,r.e30=e.e30*t.e30,r.e01=e.e01*t.e01,r.e11=e.e11*t.e11,r.e21=e.e21*t.e21,r.e31=e.e31*t.e31,r.e02=e.e02*t.e02,r.e12=e.e12*t.e12,r.e22=e.e22*t.e22,r.e32=e.e32*t.e32,r.e03=e.e03*t.e03,r.e13=e.e13*t.e13,r.e23=e.e23*t.e23,r.e33=e.e33*t.e33):(r.e00=e.e00*t,r.e10=e.e10*t,r.e20=e.e20*t,r.e30=e.e30*t,r.e01=e.e01*t,r.e11=e.e11*t,r.e21=e.e21*t,r.e31=e.e31*t,r.e02=e.e02*t,r.e12=e.e12*t,r.e22=e.e22*t,r.e32=e.e32*t,r.e03=e.e03*t,r.e13=e.e13*t,r.e23=e.e23*t,r.e33=e.e33*t),r},n.prototype.mul=function(e){return n.mul(this,e,this)},n.div=function(e,t,r){return r||(r=new n),t instanceof n?(r.e00=e.e00/t.e00,r.e10=e.e10/t.e10,r.e20=e.e20/t.e20,r.e30=e.e30/t.e30,r.e01=e.e01/t.e01,r.e11=e.e11/t.e11,r.e21=e.e21/t.e21,r.e31=e.e31/t.e31,r.e02=e.e02/t.e02,r.e12=e.e12/t.e12,r.e22=e.e22/t.e22,r.e32=e.e32/t.e32,r.e03=e.e03/t.e03,r.e13=e.e13/t.e13,r.e23=e.e23/t.e23,r.e33=e.e33/t.e33):(t=1/t,r.e00=e.e00*t,r.e10=e.e10*t,r.e20=e.e20*t,r.e30=e.e30*t,r.e01=e.e01*t,r.e11=e.e11*t,r.e21=e.e21*t,r.e31=e.e31*t,r.e02=e.e02*t,r.e12=e.e12*t,r.e22=e.e22*t,r.e32=e.e32*t,r.e03=e.e03*t,r.e13=e.e13*t,r.e23=e.e23*t,r.e33=e.e33*t),r},n.prototype.div=function(e){return n.div(this,e,this)},n.combine=function(e,t,r){r||(r=new n);var i=e.data,s=i[0],o=i[4],u=i[8],a=i[12],f=i[1],l=i[5],c=i[9],h=i[13],p=i[2],d=i[6],v=i[10],m=i[14],g=i[3],y=i[7],b=i[11],w=i[15],E=t.data,S=E[0],x=E[4],T=E[8],N=E[12],C=E[1],k=E[5],L=E[9],A=E[13],O=E[2],M=E[6],_=E[10],D=E[14],P=E[3],H=E[7],B=E[11],j=E[15],F=r.data;return F[0]=s*S+o*C+u*O+a*P,F[4]=s*x+o*k+u*M+a*H,F[8]=s*T+o*L+u*_+a*B,F[12]=s*N+o*A+u*D+a*j,F[1]=f*S+l*C+c*O+h*P,F[5]=f*x+l*k+c*M+h*H,F[9]=f*T+l*L+c*_+h*B,F[13]=f*N+l*A+c*D+h*j,F[2]=p*S+d*C+v*O+m*P,F[6]=p*x+d*k+v*M+m*H,F[10]=p*T+d*L+v*_+m*B,F[14]=p*N+d*A+v*D+m*j,F[3]=g*S+y*C+b*O+w*P,F[7]=g*x+y*k+b*M+w*H,F[11]=g*T+y*L+b*_+w*B,F[15]=g*N+y*A+b*D+w*j,r},n.prototype.combine=function(e){return n.combine(this,e,this)},n.transpose=function(e,t){t||(t=new n);var r=e.data,i=t.data;if(t===e){var s=r[4],o=r[8],u=r[12],a=r[9],f=r[13],l=r[14];return i[4]=r[1],i[8]=r[2],i[12]=r[3],i[9]=r[6],i[13]=r[7],i[14]=r[11],i[1]=s,i[2]=o,i[3]=u,i[6]=a,i[7]=f,i[11]=l,t}return i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15],t},n.prototype.transpose=function(){return n.transpose(this,this)},n.invert=function(e,r){r||(r=new n);if(r===e)return t.copy(n.invert(e),r);var i=e.determinant();if(!i)return r;var s=e.data,o=r.data;return i=1/i,o[0]=(s[5]*(s[10]*s[15]-s[14]*s[11])-s[9]*(s[6]*s[15]-s[14]*s[7])+s[13]*(s[6]*s[11]-s[10]*s[7]))*i,o[1]=(s[1]*(s[14]*s[11]-s[10]*s[15])-s[9]*(s[14]*s[3]-s[2]*s[15])+s[13]*(s[10]*s[3]-s[2]*s[11]))*i,o[2]=(s[1]*(s[6]*s[15]-s[14]*s[7])-s[5]*(s[2]*s[15]-s[14]*s[3])+s[13]*(s[2]*s[7]-s[6]*s[3]))*i,o[3]=(s[1]*(s[10]*s[7]-s[6]*s[11])-s[5]*(s[10]*s[3]-s[2]*s[11])+s[9]*(s[6]*s[3]-s[2]*s[7]))*i,o[4]=(s[4]*(s[14]*s[11]-s[10]*s[15])-s[8]*(s[14]*s[7]-s[6]*s[15])+s[12]*(s[10]*s[7]-s[6]*s[11]))*i,o[5]=(s[0]*(s[10]*s[15]-s[14]*s[11])-s[8]*(s[2]*s[15]-s[14]*s[3])+s[12]*(s[2]*s[11]-s[10]*s[3]))*i,o[6]=(s[0]*(s[14]*s[7]-s[6]*s[15])-s[4]*(s[14]*s[3]-s[2]*s[15])+s[12]*(s[6]*s[3]-s[2]*s[7]))*i,o[7]=(s[0]*(s[6]*s[11]-s[10]*s[7])-s[4]*(s[2]*s[11]-s[10]*s[3])+s[8]*(s[2]*s[7]-s[6]*s[3]))*i,o[8]=(s[4]*(s[9]*s[15]-s[13]*s[11])-s[8]*(s[5]*s[15]-s[13]*s[7])+s[12]*(s[5]*s[11]-s[9]*s[7]))*i,o[9]=(s[0]*(s[13]*s[11]-s[9]*s[15])-s[8]*(s[13]*s[3]-s[1]*s[15])+s[12]*(s[9]*s[3]-s[1]*s[11]))*i,o[10]=(s[0]*(s[5]*s[15]-s[13]*s[7])-s[4]*(s[1]*s[15]-s[13]*s[3])+s[12]*(s[1]*s[7]-s[5]*s[3]))*i,o[11]=(s[0]*(s[9]*s[7]-s[5]*s[11])-s[4]*(s[9]*s[3]-s[1]*s[11])+s[8]*(s[5]*s[3]-s[1]*s[7]))*i,o[12]=(s[4]*(s[13]*s[10]-s[9]*s[14])-s[8]*(s[13]*s[6]-s[5]*s[14])+s[12]*(s[9]*s[6]-s[5]*s[10]))*i,o[13]=(s[0]*(s[9]*s[14]-s[13]*s[10])-s[8]*(s[1]*s[14]-s[13]*s[2])+s[12]*(s[1]*s[10]-s[9]*s[2]))*i,o[14]=(s[0]*(s[13]*s[6]-s[5]*s[14])-s[4]*(s[13]*s[2]-s[1]*s[14])+s[12]*(s[5]*s[2]-s[1]*s[6]))*i,o[15]=(s[0]*(s[5]*s[10]-s[9]*s[6])-s[4]*(s[1]*s[10]-s[9]*s[2])+s[8]*(s[1]*s[6]-s[5]*s[2]))*i,r},n.prototype.invert=function(){return n.invert(this,this)},n.prototype.isOrthogonal=function(){var t;return t=this.e00*this.e01+this.e10*this.e11+this.e20*this.e21+this.e30*this.e31,Math.abs(t)>e.EPSILON?!1:(t=this.e00*this.e02+this.e10*this.e12+this.e20*this.e22+this.e30*this.e32,Math.abs(t)>e.EPSILON?!1:(t=this.e00*this.e03+this.e10*this.e13+this.e20*this.e23+this.e30*this.e33,Math.abs(t)>e.EPSILON?!1:(t=this.e01*this.e02+this.e11*this.e12+this.e21*this.e22+this.e31*this.e32,Math.abs(t)>e.EPSILON?!1:(t=this.e01*this.e03+this.e11*this.e13+this.e21*this.e23+this.e31*this.e33,Math.abs(t)>e.EPSILON?!1:(t=this.e02*this.e03+this.e12*this.e13+this.e22*this.e23+this.e32*this.e33,Math.abs(t)>e.EPSILON?!1:!0)))))},n.prototype.isNormal=function(){var t;return t=this.e00*this.e00+this.e10*this.e10+this.e20*this.e20+this.e30*this.e30,Math.abs(t-1)>e.EPSILON?!1:(t=this.e01*this.e01+this.e11*this.e11+this.e21*this.e21+this.e31*this.e31,Math.abs(t-1)>e.EPSILON?!1:(t=this.e02*this.e02+this.e12*this.e12+this.e22*this.e22+this.e32*this.e32,Math.abs(t-1)>e.EPSILON?!1:(t=this.e03*this.e03+this.e13*this.e13+this.e23*this.e23+this.e33*this.e33,Math.abs(t-1)>e.EPSILON?!1:!0)))},n.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},n.prototype.determinant=function(){var e=this.data,t=e[5]*e[10]*e[15]+e[9]*e[14]*e[7]+e[13]*e[6]*e[11]-e[13]*e[10]*e[7]-e[9]*e[6]*e[15]-e[5]*e[14]*e[11],n=e[1]*e[10]*e[15]+e[9]*e[14]*e[3]+e[13]*e[2]*e[11]-e[13]*e[10]*e[3]-e[9]*e[2]*e[15]-e[1]*e[14]*e[11],r=e[1]*e[6]*e[15]+e[5]*e[14]*e[3]+e[13]*e[2]*e[7]-e[13]*e[6]*e[3]-e[5]*e[2]*e[15]-e[1]*e[14]*e[7],i=e[1]*e[6]*e[11]+e[5]*e[10]*e[3]+e[9]*e[2]*e[7]-e[9]*e[6]*e[3]-e[5]*e[2]*e[11]-e[1]*e[10]*e[7];return e[0]*t-e[4]*n+e[8]*r-e[12]*i},n.prototype.setIdentity=function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},n.prototype.setRotationFromVector=function(e){var t=Math.sin(e.x),n=Math.cos(e.x),r=Math.sin(e.y),i=Math.cos(e.y),s=Math.sin(e.z),o=Math.cos(e.z);return this.e00=o*i,this.e10=s*i,this.e20=0-r,this.e01=o*r*t-s*n,this.e11=s*r*t+o*n,this.e21=i*t,this.e02=o*r*n+s*t,this.e12=s*r*n-o*t,this.e22=i*n,this},n.prototype.setRotationFromQuaternion=function(e){var t=e.lengthSquared();t=t>0?2/t:0;var n=e.x*t,r=e.y*t,i=e.z*t,s=e.w*n,o=e.w*r,u=e.w*i,a=e.x*n,f=e.x*r,l=e.x*i,c=e.y*r,h=e.y*i,p=e.z*i;return this.e00=1-c-p,this.e10=f+u,this.e20=l-o,this.e01=f-u,this.e11=1-a-p,this.e21=h+s,this.e02=l+o,this.e12=h-s,this.e22=1-a-c,this},n.prototype.setTranslation=function(e){return this.e03=e.x,this.e13=e.y,this.e23=e.z,this},n.prototype.getTranslation=function(e){return e.x=this.data[12],e.y=this.data[13],e.z=this.data[14],this},n.prototype.getRotation=function(e){var t=this.data;return e.set(t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]),this},n.prototype.getScale=function(e){var t=Math.sqrt(e.setDirect(this.data[0],this.data[4],this.data[8]).lengthSquared()),n=Math.sqrt(e.setDirect(this.data[1],this.data[5],this.data[9]).lengthSquared()),r=Math.sqrt(e.setDirect(this.data[2],this.data[6],this.data[10]).lengthSquared());return e.x=t,e.y=n,e.z=r,this},n.prototype.setScale=function(e){return this.e00*=e.x,this.e10*=e.y,this.e20*=e.z,this.e01*=e.x,this.e11*=e.y,this.e21*=e.z,this.e02*=e.x,this.e12*=e.y,this.e22*=e.z,this},n.prototype.applyPre=function(e){var t=e.data[0],n=e.data[1],r=e.data[2],i=e.data[3],s=this.data;return e.data[0]=s[0]*t+s[1]*n+s[2]*r+s[3]*i,e.data[1]=s[4]*t+s[5]*n+s[6]*r+s[7]*i,e.data[2]=s[8]*t+s[9]*n+s[10]*r+s[11]*i,e.data[3]=s[12]*t+s[13]*n+s[14]*r+s[15]*i,e},n.prototype.applyPost=function(e){var t=e.data[0],n=e.data[1],r=e.data[2],i=e.data[3],s=this.data;return e.data[0]=s[0]*t+s[4]*n+s[8]*r+s[12]*i,e.data[1]=s[1]*t+s[5]*n+s[9]*r+s[13]*i,e.data[2]=s[2]*t+s[6]*n+s[10]*r+s[14]*i,e.data[3]=s[3]*t+s[7]*n+s[11]*r+s[15]*i,e},n.prototype.applyPostPoint=function(e){var t=e.data[0],n=e.data[1],r=e.data[2],i=this.data;return e.data[0]=i[0]*t+i[4]*n+i[8]*r+i[12],e.data[1]=i[1]*t+i[5]*n+i[9]*r+i[13],e.data[2]=i[2]*t+i[6]*n+i[10]*r+i[14],e},n.prototype.applyPostVector=function(e){var t=e.x,n=e.y,r=e.z,i=this.data;return e.x=i[0]*t+i[4]*n+i[8]*r,e.y=i[1]*t+i[5]*n+i[9]*r,e.z=i[2]*t+i[6]*n+i[10]*r,e},n.prototype.copy=function(e){var t=this.data,n=e.data;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this},n.prototype.clone=function(){return(new n).copy(this)},t.addPostChecks(n.prototype,["add","sub","mul","div","combine","transpose","invert","isOrthogonal","determinant","applyPre","copy"]),n}),define("goo/math/Plane",["goo/math/Vector3"],function(e){function t(t,n){this.normal=t?t.clone():e.UNIT_Y.clone(),this.constant=isNaN(n)?0:n,Object.seal(this)}t.XZ=new t(e.UNIT_Y,0),t.XY=new t(e.UNIT_Z,0),t.YZ=new t(e.UNIT_X,0),t.prototype.pseudoDistance=function(e){return this.normal.dot(e)-this.constant},t.prototype.setPlanePoints=function(e,t,n){return this.normal.setVector(t).subVector(e),this.normal.cross([n.x-e.x,n.y-e.y,n.z-e.z]).normalize(),this.constant=this.normal.dot(e),this},t.prototype.reflectVector=function(t,n){var r=n;typeof r=="undefined"&&(r=new e);var i=this.normal.dot(t)*2;return r.set(t).sub([this.normal.x*i,this.normal.y*i,this.normal.z*i]),r};var n=new e;return t.prototype.rayIntersect=function(t,r,i,s){s=typeof s=="undefined"?1e-7:s,r=r||new e;var o=t.direction.dotVector(this.normal);if(Math.abs(o)<s)return i||console.warn("Ray parallell with plane"),null;var u=this.constant,a=n.setVector(this.normal).scale(u).subVector(t.origin).dotVector(this.normal),f=a/o;return r.setVector(t.direction).scale(f).addVector(t.origin)},t.prototype.copy=function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},t.prototype.clone=function(){return new t(this.normal.clone(),this.constant)},t}),define("goo/math/Ray",["goo/math/Vector3","goo/math/MathUtils"],function(e,t){function n(t,n){this.origin=t?t.clone():new e,this.direction=n?n.clone():e.UNIT_Z.clone(),Object.seal(this)}var r=new e,i=new e,s=new e,o=new e;return n.prototype.intersects=function(e,t,n){return e.length===3?this.intersectsTriangle(e[0],e[1],e[2],t,n):e.length===4?this.intersectsTriangle(e[0],e[1],e[2],t,n)||this.intersectsTriangle(e[0],e[2],e[3],t,n):!1},n.prototype.intersectsTriangle=function(n,u,a,f,l){var c=r.setVector(this.origin).subVector(n),h=i.setVector(u).subVector(n),p=s.setVector(a).subVector(n),d=o.setVector(h).cross(p),v=this.direction.dot(d),m;if(v>t.EPSILON)m=1;else{if(!(v<-t.EPSILON))return!1;m=-1,v=-v}var g=m*this.direction.dot(e.cross(c,p,p)),y=!1;if(g>=0){var b=m*this.direction.dot(h.cross(c));if(b>=0&&g+b<=v){var w=-m*c.dot(d);if(w>=0){if(!l)return!0;var E=1/v,S=w*E;if(!f)l.setVector(this.origin).addDirect(this.direction.x*S,this.direction.y*S,this.direction.z*S);else{var x=g*E,T=b*E;l.setDirect(S,x,T)}y=!0}}}return y},n.prototype.getDistanceToPrimitive=function(e){var t=r;return this.intersects(e,!1,t)?this.origin.distance(t.x,t.y,t.z):Infinity},n.prototype.intersectsPlane=function(e,t){var n=e.normal,r=n.dot(this.direction);if(Math.abs(r)<1e-5)return!1;var i=-n.dot(this.origin)+e.constant,s=i/r;return s<1e-5?!1:(t&&t.setVector(this.direction).scale(s).addVector(this.origin),!0)},n.prototype.distanceSquared=function(e,t){var n=r;n.setVector(e).subVector(this.origin);var i=this.direction.dot(n);return i>0?(n.setVector(this.direction).scale(i),n.addVector(this.origin)):n.setVector(this.origin),t&&t.setVector(n),n.subVector(e),n.lengthSquared()},n.prototype.copy=function(e){this.origin.copy(e.origin),this.direction.copy(e.direction)},n.prototype.clone=function(){return new n(this.origin.clone(),this.direction.clone())},n}),define("goo/renderer/bounds/BoundingVolume",["goo/math/Vector3"],function(e){function t(t){this.center=new e,t&&this.center.setVector(t),this.min=new e(Infinity,Infinity,Infinity),this.max=new e(-Infinity,-Infinity,-Infinity)}return t.prototype.copy=function(e){return this.center.copy(e.center),this.min.copy(e.min),this.min.copy(e.min),this},t.Outside=0,t.Inside=1,t.Intersects=2,t}),define("goo/renderer/bounds/BoundingSphere",["goo/math/Vector3","goo/math/MathUtils","goo/renderer/bounds/BoundingVolume","goo/renderer/MeshData"],function(e,t,n,r){function i(e,t){n.call(this,e),this.radius=t!==undefined?t:1,Object.seal(this)}var s=new e;i.prototype=Object.create(n.prototype),i.prototype.constructor=i,i.prototype.computeFromPoints=function(e){var t=this.min,n=this.max,r=s;t.setDirect(Infinity,Infinity,Infinity),n.setDirect(-Infinity,-Infinity,-Infinity);var i,o,u;for(var a=0;a<e.length;a+=3)i=e[a+0],o=e[a+1],u=e[a+2],t.data[0]=i<t.data[0]?i:t.data[0],t.data[1]=o<t.data[1]?o:t.data[1],t.data[2]=u<t.data[2]?u:t.data[2],n.data[0]=i>n.data[0]?i:n.data[0],n.data[1]=o>n.data[1]?o:n.data[1],n.data[2]=u>n.data[2]?u:n.data[2];var f=n.addVector(t).div(2),l=0,c;for(var a=0;a<e.length;a+=3)r.setDirect(e[a],e[a+1],e[a+2]),c=r.subVector(f).lengthSquared(),c>l&&(l=c);this.radius=Math.sqrt(l),this.center.setVector(f)},function(){var t=new e;i.prototype.containsPoint=function(e){return t.setVector(e).subVector(this.center).lengthSquared()<=Math.pow(this.radius,2)}}(),i.prototype.computeFromPrimitives=function(t,n,i,s,o){if(o-s<=0)return;var u=[],a=[],f=r.getVertexCount(t.indexModes[n]),l=0;for(var c=s;c<o;c++){a=t.getPrimitiveVertices(i[c],n,a);for(var h=0;h<f;h++)u[l++]=(new e).set(a[h])}this.averagePoints(u)},i.prototype.averagePoints=function(t){this.center.set(t[0]);for(var n=1;n<t.length;n++)this.center.add(t[n]);var r=1/t.length;this.center.scale(r);var i=0;for(var n=0;n<t.length;n++){var o=e.sub(t[n],this.center,s),u=o.lengthSquared();u>i&&(i=u)}this.radius=Math.sqrt(i)+1e-5},i.prototype.transform=function(e,t){t===null&&(t=new i),e.applyForward(this.center,t.center);var n=e.scale;return t.radius=Math.abs(this._maxAxis(n)*this.radius),t},i.prototype.whichSide=function(e){var t=e.normal.data,r=this.center.data,i=t[0]*r[0]+t[1]*r[1]+t[2]*r[2]-e.constant;return i<-this.radius?n.Inside:i>this.radius?n.Outside:n.Intersects},i.prototype._pseudoDistance=function(e,t){return e.normal.x*t.x+e.normal.y*t.y+e.normal.z*t.z-e.constant},i.prototype._maxAxis=function(e){return Math.max(Math.abs(e.x),Math.max(Math.abs(e.y),Math.abs(e.z)))},i.prototype.toString=function(){var e=Math.round(this.center.x*10)/10,t=Math.round(this.center.y*10)/10,n=Math.round(this.center.z*10)/10,r=Math.round(this.radius*10)/10;return"["+e+","+t+","+n+"]"+" - "+r},i.prototype.intersects=function(e){return e.intersectsSphere(this)},i.prototype.intersectsBoundingBox=function(e){e.min.x=e.center.x-e.xExtent,e.min.y=e.center.y-e.yExtent,e.min.z=e.center.z-e.zExtent,e.max.x=e.center.x+e.xExtent,e.max.y=e.center.y+e.yExtent,e.max.z=e.center.z+e.zExtent;var t=Math.pow(this.radius,2),n=0;return this.center.x<e.min.x?n+=Math.pow(this.center.x-e.min.x,2):this.center.x>e.max.x&&(n+=Math.pow(this.center.x-e.max.x,2)),this.center.y<e.min.y?n+=Math.pow(this.center.y-e.min.y,2):this.center.y>e.max.y&&(n+=Math.pow(this.center.y-e.max.y,2)),this.center.z<e.min.z?n+=Math.pow(this.center.z-e.min.z,2):this.center.z>e.max.z&&(n+=Math.pow(this.center.z-e.max.z,2)),n<=t},i.prototype.intersectsSphere=function(e){var t=s.setVector(this.center).subVector(e.center),n=this.radius+e.radius;return t.dot(t)<=n*n},i.prototype.intersectsRay=function(t){if(!this.center)return!1;var n=(new e).copy(t.origin).sub(this.center),r=n.dot(n)-this.radius*this.radius;if(r<=0)return!0;var i=t.direction.dot(n);return i>=0?!1:i*i>=r},i.prototype.intersectsRayWhere=function(t){var n=(new e).copy(t.origin).sub(this.center),r=n.dot(n)-this.radius*this.radius,i,s,o;if(r<=0){i=t.direction.dot(n),s=i*i-r,o=Math.sqrt(s);var u=[o-i],a=[(new e).copy(t.direction).scale(u[0]).add(t.origin)];return{distances:u,points:a}}i=t.direction.dot(n);if(i>=0)return null;s=i*i-r;if(s<0)return null;if(s>=1e-5){o=Math.sqrt(s);var u=[-i-o,-i+o],a=[(new e).copy(t.direction).scale(u[0]).add(t.origin),(new e).copy(t.direction).scale(u[1]).add(t.origin)];return{distances:u,points:a}}var u=[-i],a=[(new e).copy(t.direction).scale(u[0]).add(t.origin)];return{distances:u,points:a}},i.prototype.merge=function(e){if(e instanceof i)return this.mergeSphere(e.center,e.radius,this);var t=s.setDirect(e.xExtent,e.yExtent,e.zExtent).length();return this.mergeSphere(e.center,t,this)},i.prototype.mergeSphere=function(e,n,r){r||(r=new i);var o=s.setVector(e).subVector(this.center),u=o.lengthSquared(),a=n-this.radius,f=a*a;if(f>=u)return a<=0?(r.center.setVector(this.center),r.radius=this.radius,r):(r.center.setVector(e),r.radius=n,r);var l=Math.sqrt(u),c=r.center;if(l>t.EPSILON){var h=(l+a)/(2*l);c.addVector(o.scale(h))}return r.radius=.5*(l+this.radius+n),r},i.prototype.copy=function(e){return n.prototype.copy.call(this,e),this.radius=e.radius,this};var o=!1;return i.prototype.clone=function(){return arguments.length>0&&!o&&(o=!0,console.warn('BoundingSphere::clone no longer takes an optional "store" parameter; please use BoundingSphere::copy instead')),new i(this.center,this.radius)},i}),define("goo/renderer/bounds/BoundingBox",["goo/math/Vector3","goo/renderer/bounds/BoundingVolume","goo/renderer/bounds/BoundingSphere","goo/math/MathUtils"],function(e,t,n,r){function i(e,n,r,i){t.call(this,e),this.xExtent=n!==undefined?n:1,this.yExtent=r!==undefined?r:1,this.zExtent=i!==undefined?i:1,Object.seal(this)}var s=new e,o=new e,u=new e,a=[];for(var f=0;f<8;f++)a.push(new e);i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.computeFromPoints=function(e){var t=this.min,n=this.max,r=u;t.setDirect(e[0],e[1],e[2]),n.setDirect(e[0],e[1],e[2]);var i,s,o;for(var a=3;a<e.length;a+=3)i=e[a+0],s=e[a+1],o=e[a+2],t.data[0]=i<t.data[0]?i:t.data[0],t.data[1]=s<t.data[1]?s:t.data[1],t.data[2]=o<t.data[2]?o:t.data[2],n.data[0]=i>n.data[0]?i:n.data[0],n.data[1]=s>n.data[1]?s:n.data[1],n.data[2]=o>n.data[2]?o:n.data[2];r.setVector(n).subVector(t).scale(.5),this.xExtent=r.data[0],this.yExtent=r.data[1],this.zExtent=r.data[2],this.center.setVector(n).addVector(t).scale(.5)},i.prototype.containsPoint=function(e){var t=this.center,n=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return n>=-this.xExtent&&n<=this.xExtent&&r>=-this.yExtent&&r<=this.yExtent&&i>=-this.zExtent&&i<=this.zExtent};var l=[];i.prototype.computeFromPrimitives=function(e,t,n,r,u){if(u-r<=0)return;var a=s.set(Infinity,Infinity,Infinity),f=o.set(-Infinity,-Infinity,-Infinity),c=l;c.length=0;for(var h=r;h<u;h++){c=e.getPrimitiveVertices(n[h],t,c);for(var p=0;p<c.length;p++)i.checkMinMax(a,f,c[p])}this.center.copy(a.add(f)),this.center.scale(.5),this.xExtent=f.x-this.center.x,this.yExtent=f.y-this.center.y,this.zExtent=f.z-this.center.z},i.checkMinMax=function(e,t,n){n.x<e.x&&(e.x=n.x),n.x>t.x&&(t.x=n.x),n.y<e.y&&(e.y=n.y),n.y>t.y&&(t.y=n.y),n.z<e.z&&(e.z=n.z),n.z>t.z&&(t.z=n.z)},i.prototype.transform=function(e,t){t===null&&(t=new i);var n=a;this.getCorners(n);for(var r=0;r<8;r++)e.matrix.applyPostPoint(n[r]);var s=n[0].data[0],o=n[0].data[1],u=n[0].data[2],f=s,l=o,c=u;for(var r=1;r<8;r++){var h=n[r].data[0],p=n[r].data[1],d=n[r].data[2];s=Math.min(s,h),o=Math.min(o,p),u=Math.min(u,d),f=Math.max(f,h),l=Math.max(l,p),c=Math.max(c,d)}var v=(f+s)*.5,m=(l+o)*.5,g=(c+u)*.5;return t.center.setDirect(v,m,g),t.xExtent=f-v,t.yExtent=l-m,t.zExtent=c-g,t},i.prototype.getCorners=function(e){var t=this.xExtent,n=this.yExtent,r=this.zExtent,i=this.center.data;return e[0].setDirect(i[0]+t,i[1]+n,i[2]+r),e[1].setDirect(i[0]+t,i[1]+n,i[2]-r),e[2].setDirect(i[0]+t,i[1]-n,i[2]+r),e[3].setDirect(i[0]+t,i[1]-n,i[2]-r),e[4].setDirect(i[0]-t,i[1]+n,i[2]+r),e[5].setDirect(i[0]-t,i[1]+n,i[2]-r),e[6].setDirect(i[0]-t,i[1]-n,i[2]+r),e[7].setDirect(i[0]-t,i[1]-n,i[2]-r),e},i.prototype.whichSide=function(e){var n=e.normal.data,r=this.center.data,i=Math.abs(this.xExtent*n[0])+Math.abs(this.yExtent*n[1])+Math.abs(this.zExtent*n[2]),s=n[0]*r[0]+n[1]*r[1]+n[2]*r[2]-e.constant;return s<-i?t.Inside:s>i?t.Outside:t.Intersects},i.prototype._pseudoDistance=function(e,t){var n=e.normal.data,r=t.data;return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]-e.constant},i.prototype._maxAxis=function(e){return Math.max(Math.abs(e.x),Math.max(Math.abs(e.y),Math.abs(e.z)))},i.prototype.toString=function(){var e=Math.round(this.center.x*10)/10,t=Math.round(this.center.y*10)/10,n=Math.round(this.center.z*10)/10;return"["+e+","+t+","+n+"]"+" - "+"["+this.xExtent+","+this.yExtent+","+this.zExtent+"]"},i.prototype.intersects=function(e){return e.intersectsBoundingBox(this)},i.prototype.intersectsBoundingBox=function(e){return this.center.x+this.xExtent<e.center.x-e.xExtent||this.center.x-this.xExtent>e.center.x+e.xExtent?!1:this.center.y+this.yExtent<e.center.y-e.yExtent||this.center.y-this.yExtent>e.center.y+e.yExtent?!1:this.center.z+this.zExtent<e.center.z-e.zExtent||this.center.z-this.zExtent>e.center.z+e.zExtent?!1:!0},i.prototype.intersectsSphere=function(e){this.min.x=this.center.x-this.xExtent,this.min.y=this.center.y-this.yExtent,this.min.z=this.center.z-this.zExtent,this.max.x=this.center.x+this.xExtent,this.max.y=this.center.y+this.yExtent,this.max.z=this.center.z+this.zExtent;var t=Math.pow(e.radius,2),n=0;return e.center.x<this.min.x?n+=Math.pow(e.center.x-this.min.x,2):e.center.x>this.max.x&&(n+=Math.pow(e.center.x-this.max.x,2)),e.center.y<this.min.y?n+=Math.pow(e.center.y-this.min.y,2):e.center.y>this.max.y&&(n+=Math.pow(e.center.y-this.max.y,2)),e.center.z<this.min.z?n+=Math.pow(e.center.z-this.min.z,2):e.center.z>this.max.z&&(n+=Math.pow(e.center.z-this.max.z,2)),n<=t},i.prototype.testStaticAABBAABB=function(t,n){var r=this,i=t,s={mtvDistance:1e10,mtvAxis:new e};return this.testAxisStatic(e.UNIT_X,r.center.x-r.xExtent,r.center.x+r.xExtent,i.center.x-i.xExtent,i.center.x+i.xExtent,s)?this.testAxisStatic(e.UNIT_Y,r.center.y-r.yExtent,r.center.y+r.yExtent,i.center.y-i.yExtent,i.center.y+i.yExtent,s)?this.testAxisStatic(e.UNIT_Z,r.center.z-r.zExtent,r.center.z+r.zExtent,i.center.z-i.zExtent,i.center.z+i.zExtent,s)?(n&&(n.isIntersecting=!0,n.normal=s.mtvAxis,n.penetration=Math.sqrt(s.mtvDistance)*1.001),!0):!1:!1:!1},i.prototype.testAxisStatic=function(t,n,r,i,s,o){var u=e.dot(t,t);if(u<1e-6)return!0;var a=s-n,f=r-i;if(a<=0||f<=0)return!1;var l=a<f?a:-f,c=(new e).copy(t).scale(l/u),h=e.dot(c,c);return h<o.mtvDistance&&(o.mtvDistance=h,o.mtvAxis=t),!0},i.prototype.intersectsRay=function(e){if(isNaN(this.center.x)||isNaN(this.center.y)||isNaN(this.center.z))return!1;var t=s.setVector(e.origin).subVector(this.center),n=e.direction,o=[0,Infinity],u=this.xExtent;u<r.ZERO_TOLERANCE&&u>=0&&(u=r.ZERO_TOLERANCE);var a=this.yExtent;a<r.ZERO_TOLERANCE&&a>=0&&(a=r.ZERO_TOLERANCE);var f=this.zExtent;f<r.ZERO_TOLERANCE&&f>=0&&(f=r.ZERO_TOLERANCE);var l=i.clip(n.data[0],-t.data[0]-u,o)&&i.clip(-n.data[0],t.data[0]-u,o)&&i.clip(n.data[1],-t.data[1]-a,o)&&i.clip(-n.data[1],t.data[1]-a,o)&&i.clip(n.data[2],-t.data[2]-f,o)&&i.clip(-n.data[2],t.data[2]-f,o);return!l||o[0]===0&&o[1]===Infinity?!1:!0},i.prototype.intersectsRayWhere=function(t){if(isNaN(this.center.x)||isNaN(this.center.y)||isNaN(this.center.z))return null;var n=e.sub(t.origin,this.center,s),o=t.direction,u=[0,Infinity],a=this.xExtent;a<r.ZERO_TOLERANCE&&a>=0&&(a=r.ZERO_TOLERANCE);var f=this.yExtent;f<r.ZERO_TOLERANCE&&f>=0&&(f=r.ZERO_TOLERANCE);var l=this.zExtent;l<r.ZERO_TOLERANCE&&l>=0&&(l=r.ZERO_TOLERANCE);var c=i.clip(o.data[0],-n.data[0]-a,u)&&i.clip(-o.data[0],n.data[0]-a,u)&&i.clip(o.data[1],-n.data[1]-f,u)&&i.clip(-o.data[1],n.data[1]-f,u)&&i.clip(o.data[2],-n.data[2]-l,u)&&i.clip(-o.data[2],n.data[2]-l,u);if(c&&(u[0]!==0||u[1]!==Infinity)){if(u[1]>u[0]){var h=u,p=[(new e(t.direction)).scale(h[0]).add(t.origin),(new e(t.direction)).scale(h[1]).add(t.origin)];return{distances:h,points:p}}var h=[u[0]],p=[(new e(t.direction)).scale(h[0]).add(t.origin)];return{distances:h,points:p}}return null},i.clip=function(e,t,n){return e>0?t>e*n[1]?!1:(t>e*n[0]&&(n[0]=t/e),!0):e<0?t>e*n[0]?!1:(t>e*n[1]&&(n[1]=t/e),!0):t<=0},i.prototype.merge=function(e){return e instanceof i?this.mergeBox(e.center,e.xExtent,e.yExtent,e.zExtent,this):e instanceof n?this.mergeBox(e.center,e.radius,e.radius,e.radius,this):this},i.prototype.mergeBox=function(e,t,n,r,u){u||(u=new i);var a=s,f=o;return a.x=this.center.x-this.xExtent,a.x>e.x-t&&(a.x=e.x-t),a.y=this.center.y-this.yExtent,a.y>e.y-n&&(a.y=e.y-n),a.z=this.center.z-this.zExtent,a.z>e.z-r&&(a.z=e.z-r),f.x=this.center.x+this.xExtent,f.x<e.x+t&&(f.x=e.x+t),f.y=this.center.y+this.yExtent,f.y<e.y+n&&(f.y=e.y+n),f.z=this.center.z+this.zExtent,f.z<e.z+r&&(f.z=e.z+r),u.center.set(f).addVector(a).scale(.5),u.xExtent=f.x-u.center.x,u.yExtent=f.y-u.center.y,u.zExtent=f.z-u.center.z,u},i.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.xExtent=e.xExtent,this.yExtent=e.yExtent,this.zExtent=e.zExtent,this};var c=!1;return i.prototype.clone=function(){return arguments.length>0&&!c&&(c=!0,console.warn('BoundingBox::clone no longer takes an optional "store" parameter; please use BoundingBox::copy instead')),new i(this.center,this.xExtent,this.yExtent,this.zExtent)},i}),define("goo/renderer/Camera",["goo/math/Vector3","goo/math/Vector4","goo/math/Matrix4x4","goo/math/Plane","goo/math/MathUtils","goo/math/Ray","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume"],function(e,t,n,r,i,s,o,u,a){function f(i,s,o,u){i=typeof i!="undefined"?i:45,s=typeof s!="undefined"?s:1,o=typeof o!="undefined"?o:1,u=typeof u!="undefined"?u:1e3,this.translation=new e(0,0,0),this._left=new e(-1,0,0),this._up=new e(0,1,0),this._direction=new e(0,0,-1),this._frustumNear=this.near=1,this._frustumFar=this.far=2,this._frustumLeft=this.left=-0.5,this._frustumRight=this.right=.5,this._frustumTop=this.top=.5,this._frustumBottom=this.bottom=-0.5,this._coeffLeft=[],this._coeffRight=[],this._coeffBottom=[],this._coeffTop=[],this._viewPortLeft=0,this._viewPortRight=1,this._viewPortTop=1,this._viewPortBottom=0,this._worldPlane=[];for(var a=0;a<f.FRUSTUM_PLANES;a++)this._worldPlane[a]=new r;this.projectionMode=f.Perspective,this.lockedRatio=!1,this.aspect=s,this._updateMVMatrix=!0,this._updateInverseMVMatrix=!0,this._updatePMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVPMatrix=!0,this.modelView=new n,this.modelViewInverse=new n,this.projection=new n,this.modelViewProjection=new n,this.modelViewProjectionInverse=new n,this._planeState=0,this._clipPlane=new t,this._qCalc=new t,this._corners=[];for(var a=0;a<8;a++)this._corners.push(new e);this._extents=new e,this.vNearPlaneCenter=new e,this.vFarPlaneCenter=new e,this.calcLeft=new e,this.calcUp=new e,this.changedProperties=!0,this.setFrustumPerspective(i,s,o,u),this.onFrameChange(),Object.seal(this)}var l=new e;return f.LEFT_PLANE=0,f.RIGHT_PLANE=1,f.BOTTOM_PLANE=2,f.TOP_PLANE=3,f.FAR_PLANE=4,f.NEAR_PLANE=5,f.FRUSTUM_PLANES=6,f.Perspective=0,f.Parallel=1,f.Custom=2,f.Outside=0,f.Inside=1,f.Intersects=2,f.prototype.normalize=function(){this._left.normalize(),this._up.normalize(),this._direction.normalize(),this.onFrameChange()},f.prototype.setProjectionMode=function(e){this.projectionMode=e,this.update()},f.prototype.setFrustumPerspective=function(e,t,n,r){e!==undefined&&e!==null&&(this.fov=e),t!==undefined&&t!==null&&(this.aspect=t),n!==undefined&&n!==null&&(this.near=n),r!==undefined&&r!==null&&(this.far=r);if(this.fov!==undefined){var s=Math.tan(this.fov*i.DEG_TO_RAD*.5)*this.near,o=s*this.aspect;this._frustumLeft=-o,this._frustumRight=o,this._frustumBottom=-s,this._frustumTop=s,this._frustumNear=this.near,this._frustumFar=this.far,this.onFrustumChange()}},f.prototype.setFrustum=function(e,t,n,r,i,s,o){e!==undefined&&e!==null&&(this.near=e),t!==undefined&&t!==null&&(this.far=t),n!==undefined&&n!==null&&(this.left=n),r!==undefined&&r!==null&&(this.right=r),i!==undefined&&i!==null&&(this.top=i),s!==undefined&&s!==null&&(this.bottom=s),o!==undefined&&o!==null&&(this.aspect=o),this._frustumNear=this.near,this._frustumFar=this.far,this._frustumLeft=this.left*this.aspect,this._frustumRight=this.right*this.aspect,this._frustumTop=this.top,this._frustumBottom=this.bottom,this.onFrustumChange()},f.prototype.copy=function(e){return this.translation.setVector(e.translation),this._left.setVector(e._left),this._up.setVector(e._up),this._direction.setVector(e._direction),this.fov=e.fov,this.aspect=e.aspect,this.near=e.near,this.far=e.far,this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this._frustumLeft=e._frustumLeft,this._frustumRight=e._frustumRight,this._frustumBottom=e._frustumBottom,this._frustumTop=e._frustumTop,this._frustumNear=e._frustumNear,this._frustumFar=e._frustumFar,this.projectionMode=e.projectionMode,this.onFrustumChange(),this.onFrameChange(),this},f.prototype.setFrame=function(e,t,n,r){this._left.setVector(t),this._up.setVector(n),this._direction.setVector(r),this.translation.setVector(e),this.onFrameChange()},f.prototype.lookAt=function(t,n){l.setVector(t).subVector(this.translation).normalize();if(l.equals(this._direction))return;this._direction.setVector(l),this._up.setVector(n).normalize(),this._up.equals(e.ZERO)&&this._up.setVector(e.UNIT_Y),this._left.setVector(this._up).cross(this._direction).normalize(),this._left.equals(e.ZERO)&&(this._direction.x!==0?this._left.setDirect(this._direction.y,-this._direction.x,0):this._left.setDirect(0,this._direction.z,-this._direction.y)),this._up.setVector(this._direction).cross(this._left).normalize(),this.onFrameChange()},f.prototype.update=function(){this.onFrustumChange(),this.onFrameChange()},f.prototype.contains=function(e){if(!e)return f.Inside;var t=f.Inside;for(var n=f.FRUSTUM_PLANES-1;n>=0;n--)switch(e.whichSide(this._worldPlane[n])){case a.Inside:return f.Outside;case a.Outside:break;case a.Intersects:t=f.Intersects}return t},f.prototype.onFrustumChange=function(){if(this.projectionMode===f.Perspective){var e=this._frustumNear*this._frustumNear,t=this._frustumLeft*this._frustumLeft,n=this._frustumRight*this._frustumRight,r=this._frustumBottom*this._frustumBottom,i=this._frustumTop*this._frustumTop,s=1/Math.sqrt(e+t);this._coeffLeft[0]=-this._frustumNear*s,this._coeffLeft[1]=-this._frustumLeft*s,s=1/Math.sqrt(e+n),this._coeffRight[0]=this._frustumNear*s,this._coeffRight[1]=this._frustumRight*s,s=1/Math.sqrt(e+r),this._coeffBottom[0]=this._frustumNear*s,this._coeffBottom[1]=-this._frustumBottom*s,s=1/Math.sqrt(e+i),this._coeffTop[0]=-this._frustumNear*s,this._coeffTop[1]=this._frustumTop*s}else this.projectionMode===f.Parallel&&(this._frustumRight>this._frustumLeft?(this._coeffLeft[0]=-1,this._coeffLeft[1]=0,this._coeffRight[0]=1,this._coeffRight[1]=0):(this._coeffLeft[0]=1,this._coeffLeft[1]=0,this._coeffRight[0]=-1,this._coeffRight[1]=0),this._frustumTop>this._frustumBottom?(this._coeffBottom[0]=-1,this._coeffBottom[1]=0,this._coeffTop[0]=1,this._coeffTop[1]=0):(this._coeffBottom[0]=1,this._coeffBottom[1]=0,this._coeffTop[0]=-1,this._coeffTop[1]=0));this._updatePMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVMatrix=!0,this._updateInverseMVPMatrix=!0,this.changedProperties=!0},f.prototype.onFrameChange=function(){var e;e=this._worldPlane[f.LEFT_PLANE],e.normal.x=this._left.x*this._coeffLeft[0]+this._direction.x*this._coeffLeft[1],e.normal.y=this._left.y*this._coeffLeft[0]+this._direction.y*this._coeffLeft[1],e.normal.z=this._left.z*this._coeffLeft[0]+this._direction.z*this._coeffLeft[1],e.constant=this.translation.dotVector(e.normal),e=this._worldPlane[f.RIGHT_PLANE],e.normal.x=this._left.x*this._coeffRight[0]+this._direction.x*this._coeffRight[1],e.normal.y=this._left.y*this._coeffRight[0]+this._direction.y*this._coeffRight[1],e.normal.z=this._left.z*this._coeffRight[0]+this._direction.z*this._coeffRight[1],e.constant=this.translation.dotVector(e.normal),e=this._worldPlane[f.BOTTOM_PLANE],e.normal.x=this._up.x*this._coeffBottom[0]+this._direction.x*this._coeffBottom[1],e.normal.y=this._up.y*this._coeffBottom[0]+this._direction.y*this._coeffBottom[1],e.normal.z=this._up.z*this._coeffBottom[0]+this._direction.z*this._coeffBottom[1],e.constant=this.translation.dotVector(e.normal),e=this._worldPlane[f.TOP_PLANE],e.normal.x=this._up.x*this._coeffTop[0]+this._direction.x*this._coeffTop[1],e.normal.y=this._up.y*this._coeffTop[0]+this._direction.y*this._coeffTop[1],e.normal.z=this._up.z*this._coeffTop[0]+this._direction.z*this._coeffTop[1],e.constant=this.translation.dotVector(e.normal),this.projectionMode===f.Parallel&&(this._frustumRight>this._frustumLeft?(this._worldPlane[f.LEFT_PLANE].constant+=this._frustumLeft,this._worldPlane[f.RIGHT_PLANE].constant-=this._frustumRight):(this._worldPlane[f.LEFT_PLANE].constant-=this._frustumLeft,this._worldPlane[f.RIGHT_PLANE].constant+=this._frustumRight),this._frustumBottom>this._frustumTop?(this._worldPlane[f.TOP_PLANE].constant+=this._frustumTop,this._worldPlane[f.BOTTOM_PLANE].constant-=this._frustumBottom):(this._worldPlane[f.TOP_PLANE].constant-=this._frustumTop,this._worldPlane[f.BOTTOM_PLANE].constant+=this._frustumBottom));var t=this._direction.dot(this.translation);e=this._worldPlane[f.FAR_PLANE],e.normal.x=-this._direction.x,e.normal.y=-this._direction.y,e.normal.z=-this._direction.z,e.constant=-(t+this._frustumFar),e=this._worldPlane[f.NEAR_PLANE],e.normal.x=this._direction.x,e.normal.y=this._direction.y,e.normal.z=this._direction.z,e.constant=t+this._frustumNear,this._updateMVMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVMatrix=!0,this._updateInverseMVPMatrix=!0},f.prototype.updateProjectionMatrix=function(){if(this.projectionMode===f.Parallel){this.projection.setIdentity();var e=this.projection.data;e[0]=2/(this._frustumRight-this._frustumLeft),e[5]=2/(this._frustumTop-this._frustumBottom),e[10]=-2/(this._frustumFar-this._frustumNear),e[12]=-(this._frustumRight+this._frustumLeft)/(this._frustumRight-this._frustumLeft),e[13]=-(this._frustumTop+this._frustumBottom)/(this._frustumTop-this._frustumBottom),e[14]=-(this._frustumFar+this._frustumNear)/(this._frustumFar-this._frustumNear)}else if(this.projectionMode===f.Perspective){this.projection.setIdentity();var e=this.projection.data;e[0]=2*this._frustumNear/(this._frustumRight-this._frustumLeft),e[5]=2*this._frustumNear/(this._frustumTop-this._frustumBottom),e[8]=(this._frustumRight+this._frustumLeft)/(this._frustumRight-this._frustumLeft),e[9]=(this._frustumTop+this._frustumBottom)/(this._frustumTop-this._frustumBottom),e[10]=-(this._frustumFar+this._frustumNear)/(this._frustumFar-this._frustumNear),e[11]=-1,e[14]=-(2*this._frustumFar*this._frustumNear)/(this._frustumFar-this._frustumNear),e[15]=0}},f.prototype.updateModelViewMatrix=function(){this.modelView.setIdentity();var e=this.modelView.data;e[0]=-this._left.x,e[4]=-this._left.y,e[8]=-this._left.z,e[1]=this._up.x,e[5]=this._up.y,e[9]=this._up.z,e[2]=-this._direction.x,e[6]=-this._direction.y,e[10]=-this._direction.z,e[12]=this._left.dot(this.translation),e[13]=-this._up.dot(this.translation),e[14]=this._direction.dot(this.translation)},f.prototype.getPickRay=function(e,t,n,r,i){return i||(i=new s),this.getWorldCoordinates(e,t,n,r,0,i.origin),this.getWorldCoordinates(e,t,n,r,.3,i.direction).subVector(i.origin).normalize(),i},f.prototype.getWorldPosition=function(e,t,n,r,i,s){return this.projectionMode===f.Parallel?i=(i-this.near)/(this.far-this.near):i=this.far/(this.far-this.near)+this.far*this.near/(this.near-this.far)/i,this.getWorldCoordinates(e,t,n,r,i,s)},f.prototype.getWorldCoordinates=function(n,r,i,s,o,u){u||(u=new e),this.checkInverseModelViewProjection();var a=new t,f=(n/i-this._viewPortLeft)/(this._viewPortRight-this._viewPortLeft)*2-1,l=((s-r)/s-this._viewPortBottom)/(this._viewPortTop-this._viewPortBottom)*2-1;return a.setDirect(f,l,o*2-1,1),this.modelViewProjectionInverse.applyPost(a),a.scale(1/a.w),u.x=a.x,u.y=a.y,u.z=a.z,u},f.prototype.getScreenCoordinates=function(e,t,n,r){return r=this.getNormalizedDeviceCoordinates(e,r),r.x=(r.x+1)*(this._viewPortRight-this._viewPortLeft)/2*t,r.y=(1-r.y)*(this._viewPortTop-this._viewPortBottom)/2*n,r.z=(r.z+1)/2,r},f.prototype.getFrustumCoordinates=function(e,t){return t=this.getNormalizedDeviceCoordinates(e,t),t.x=(t.x+1)*(this._frustumRight-this._frustumLeft)/2+this._frustumLeft,t.y=(t.y+1)*(this._frustumTop-this._frustumBottom)/2+this._frustumBottom,t.z=(t.z+1)*(this._frustumFar-this._frustumNear)/2+this._frustumNear,t},f.prototype.getNormalizedDeviceCoordinates=function(n,r){r||(r=new e),this.checkModelViewProjection();var i=new t;return i.setDirect(n.x,n.y,n.z,1),this.modelViewProjection.applyPost(i),i.mul(1/i.w),r.x=i.x,r.y=i.y,r.z=i.z,r},f.prototype.checkModelView=function(){this._updateMVMatrix&&(this.updateModelViewMatrix(),this._updateMVMatrix=!1)},f.prototype.checkProjection=function(){this._updatePMatrix&&(this.updateProjectionMatrix(),this._updatePMatrix=!1)},f.prototype.checkModelViewProjection=function(){this._updateMVPMatrix&&(this.checkModelView(),this.checkProjection(),this.modelViewProjection.copy(this.getProjectionMatrix()).combine(this.getViewMatrix()),this._updateMVPMatrix=!1)},f.prototype.checkInverseModelView=function(){this._updateInverseMVMatrix&&(this.checkModelView(),n.invert(this.modelView,this.modelViewInverse),this._updateInverseMVMatrix=!1)},f.prototype.checkInverseModelViewProjection=function(){this._updateInverseMVPMatrix&&(this.checkModelViewProjection(),n.invert(this.modelViewProjection,this.modelViewProjectionInverse),this._updateInverseMVPMatrix=!1)},f.prototype.getViewMatrix=function(){return this.checkModelView(),this.modelView},f.prototype.getProjectionMatrix=function(){return this.checkProjection(),this.projection},f.prototype.getViewProjectionMatrix=function(){return this.checkModelViewProjection(),this.modelViewProjection},f.prototype.getViewInverseMatrix=function(){return this.checkInverseModelView(),this.modelViewInverse},f.prototype.getViewProjectionInverseMatrix=function(){return this.checkInverseModelViewProjection(),this.modelViewProjectionInverse},f.prototype.pack=function(e){var n=e.center,r=this._corners,i=this._extents;for(var s=0;s<r.length;s++)r[s].set(n);e instanceof o?i.setDirect(e.xExtent,e.yExtent,e.zExtent):e instanceof u&&i.setDirect(e.radius,e.radius,e.radius),r[0].addDirect(i.x,i.y,i.z),r[1].addDirect(i.x,-i.y,i.z),r[2].addDirect(i.x,i.y,-i.z),r[3].addDirect(i.x,-i.y,-i.z),r[4].addDirect(-i.x,i.y,i.z),r[5].addDirect(-i.x,-i.y,i.z),r[6].addDirect(-i.x,i.y,-i.z),r[7].addDirect(-i.x,-i.y,-i.z);var a=this.getViewMatrix(),f=Number.MAX_VALUE,l=-Number.MAX_VALUE,c=new t;for(var s=0;s<r.length;s++)c.setDirect(r[s].x,r[s].y,r[s].z,1),a.applyPre(c),f=Math.min(-c.z,f),l=Math.max(-c.z,l);f=Math.min(Math.max(this._frustumNear,f),this._frustumFar),l=Math.max(f,Math.min(this._frustumFar,l));var h=f/this._frustumNear;this._frustumLeft=this._frustumLeft*h,this._frustumRight=this._frustumRight*h,this._frustumTop=this._frustumTop*h,this._frustumBottom=this._frustumBottom*h,this._frustumNear=f,this._frustumFar=l},f.prototype.calculateFrustumCorners=function(e,t){e=e!==undefined?e:this._frustumNear,t=t!==undefined?t:this._frustumFar;var n=(this._frustumTop-this._frustumBottom)*e*.5/this._frustumNear,r=(this._frustumRight-this._frustumLeft)*e*.5/this._frustumNear,i=(this._frustumTop-this._frustumBottom)*t*.5/this._frustumNear,s=(this._frustumRight-this._frustumLeft)*t*.5/this._frustumNear;this.projectionMode===f.Parallel&&(n=(this._frustumTop-this._frustumBottom)*.5,r=(this._frustumRight-this._frustumLeft)*.5,i=(this._frustumTop-this._frustumBottom)*.5,s=(this._frustumRight-this._frustumLeft)*.5);var o=this.vNearPlaneCenter,u=this.vFarPlaneCenter,a=this.calcLeft;a.setVector(this._direction).scale(e),o.setVector(this.translation).addVector(a),a.setVector(this._direction).scale(t),u.setVector(this.translation).addVector(a);var l=this.calcLeft,c=this.calcUp;return l.setVector(this._left).scale(r),c.setVector(this._up).scale(n),this._corners[0].setVector(o).subVector(l).subVector(c),this._corners[1].setVector(o).addVector(l).subVector(c),this._corners[2].setVector(o).addVector(l).addVector(c),this._corners[3].setVector(o).subVector(l).addVector(c),l.setVector(this._left).scale(s),c.setVector(this._up).scale(i),this._corners[4].setVector(u).subVector(l).subVector(c),this._corners[5].setVector(u).addVector(l).subVector(c),this._corners[6].setVector(u).addVector(l).addVector(c),this._corners[7].setVector(u).subVector(l).addVector(c),this._corners},f.prototype.setToObliqueMatrix=function(e){var n=this._clipPlane.setVector(e);n.w=0,this.getViewMatrix().applyPost(n),n.w=this.translation.y*e.y-e.w,this._updatePMatrix=!0;var r=this.getProjectionMatrix();this._qCalc.setDirect((i.sign(n.x)+r[8])/r[0],(i.sign(n.y)+r[9])/r[5],-1,(1+r[10])/r[14]),n.mul(2/t.dot(n,this._qCalc)),r[2]=n.x,r[6]=n.y,r[10]=n.z+1,r[14]=n.w,this._updateMVPMatrix=!0,this._updateInverseMVPMatrix=!0},f.prototype.clone=function(){var e=new f(this.fov,this.aspect,this.near,this.far);return e.copy(this),e},f}),define("goo/entities/components/CameraComponent",["goo/entities/components/Component","goo/math/Vector3","goo/renderer/Camera","goo/entities/SystemBus"],function(e,t,n,r){function i(n){e.apply(this,arguments),this.type="CameraComponent",this.camera=n,this.leftVec=new t(-1,0,0),this.upVec=new t(0,1,0),this.dirVec=new t(0,0,-1),Object.seal(this)}return i.type="CameraComponent",i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.api={setAsMainCamera:function(){return r.emit("goo.setCurrentCamera",{camera:this.cameraComponent.camera,entity:this}),this}},i.prototype.setUpVector=function(e){e===0?(this.leftVec.setDirect(0,-1,0),this.upVec.setDirect(1,0,0),this.dirVec.setDirect(0,0,-1)):e===2?(this.leftVec.setDirect(-1,0,0),this.upVec.setDirect(0,0,1),this.dirVec.setDirect(0,-1,0)):(this.leftVec.setDirect(-1,0,0),this.upVec.setDirect(0,1,0),this.dirVec.setDirect(0,0,-1))},i.prototype.updateCamera=function(e){this.camera._left.setVector(this.leftVec),e.rotation.applyPost(this.camera._left),this.camera._up.setVector(this.upVec),e.rotation.applyPost(this.camera._up),this.camera._direction.setVector(this.dirVec),e.rotation.applyPost(this.camera._direction),e.matrix.getTranslation(this.camera.translation),this.camera.onFrameChange()},i.prototype.copy=function(e){return this.camera.copy(e.camera),this.leftVec.copy(e.leftVec),this.upVec.copy(e.upVec),this.dirVec.copy(e.dirVec),this},i.prototype.clone=function(){var e=new i(this.camera.clone());return e.leftVec.copy(this.leftVec),e.upVec.copy(this.upVec),e.dirVec.copy(this.dirVec),e},i.applyOnEntity=function(e,t){if(e instanceof n){var r=new i(e);return t.setComponent(r),!0}},i}),define("goo/loaders/handlers/CameraComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/CameraComponent","goo/renderer/Camera","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s){function o(){e.apply(this,arguments),this._type="CameraComponent"}return o.prototype=Object.create(e.prototype),e._registerClass("camera",o),o.prototype.constructor=o,o.prototype._prepare=function(e){s.defaults(e,{near:1,far:1e4,projectionMode:"Perspective",aspect:1,lockedRatio:!1}),e.projectionMode==="Perspective"&&e.fov===undefined&&(e.fov=45),e.projectionMode==="Parallel"&&e.size===undefined&&(e.size=100),e.projectionMode!=="Perspective"&&e.projectionMode!=="Parallel"&&(e.projectionMode="Perspective")},o.prototype._create=function(){var e=new n(45,1,1,1e3),r=new t(e);return r},o.prototype.update=function(t,r,i){return e.prototype.update.call(this,t,r,i).then(function(e){if(!e)return;e.camera.setProjectionMode(n[r.projectionMode]),e.camera.lockedRatio=!1;if(r.projectionMode==="Perspective")e.camera.setFrustumPerspective(r.fov,null,r.near,r.far);else{var t=r.size;e.camera.setFrustum(r.near,r.far,-t,t,t,-t,null),e.camera.size=t}return e})},o}),define("goo/loaders/handlers/EntityHandler",["goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/ComponentHandler","goo/util/rsvp","goo/util/StringUtil","goo/util/PromiseUtil"],function(e,t,n,r,i){function s(){e.apply(this,arguments),this._componentHandlers={}}function o(e,t){e._tags.clear();if(!t)return;for(var n in t)e.setTag(n)}function u(e,t){e._attributes.clear();if(!t)return;for(var n in t)e.setAttribute(n,t[n])}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,e._registerClass("entity",s),s.prototype._create=function(){return this.world.createEntity()},s.prototype._remove=function(e){var t=this._objects.get(e),r=this;if(t){var i=[],s=t._components.slice(0);for(var o=0;o<s.length;o++){var u=this._getComponentType(s[o]),a=this._updateComponent(t,u,null);a instanceof n.Promise&&i.push(a)}return n.all(i).then(function(){t.removeFromWorld(),r._objects.delete(e)})}},s.prototype._update=function(t,n,r){var s=this;return e.prototype._update.call(this,t,n,r).then(function(e){if(!e)return;e.id=t,e.name=n.name,e.static=!!n.static,o(e,n.tags),u(e,n.attributes);var a=[];for(var f in n.components)if(n.components[f]){var l=s._updateComponent(e,f,n.components[f],r);l?a.push(l):console.error("Error handling component "+f)}var c=e._components;for(var h=0;h<c.length;h++){var f=s._getComponentType(c[h]);n.components[f]||s._updateComponent(e,f,null,r)}return i.optimisticAll(a).then(function(){return n.hidden?e.hide():e.show(),e})})},s.prototype._updateComponent=function(e,t,n,r){var i=this._getHandler(t);if(!i)return null;var s=i.update(e,n,r);return!s||!s.then?null:s},s.prototype._getComponentType=function(e){var t=e.type;return t=t.slice(0,t.lastIndexOf("Component")),t=r.uncapitalize(t),t==="howler"&&(t="sound"),t},s.prototype._getHandler=function(e){if(!this._componentHandlers[e]){var n=t.getHandler(e);n&&(this._componentHandlers[e]=new n(this.world,this.getConfig,this.updateObject,this.loadObject))}return this._componentHandlers[e]},s}),define("goo/renderer/light/Light",["goo/math/Vector3"],function(e){function t(t){this.translation=new e,this.color=t?t.clone():new e(1,1,1),this.intensity=1,this.specularIntensity=1,this.shadowCaster=!1,this.lightCookie=null,this.shadowSettings={size:100,near:1,far:1e3,resolution:[512,512],upVector:e.UNIT_Y.clone(),darkness:1,shadowType:"VSM"},this.changedProperties=!1,this.changedColor=!1}return t.prototype.destroy=function(e){var t=this.shadowSettings;t.shadowData&&(t.shadowData.shadowTarget&&t.shadowData.shadowTarget.destroy(e.context),t.shadowData.shadowTargetDown&&t.shadowData.shadowTargetDown.destroy(e.context),t.shadowData.shadowBlurred&&t.shadowData.shadowBlurred.destroy(e.context)),delete t.shadowData},t.prototype.invalidateHandles=function(e){var t=this.shadowSettings;t.shadowData&&(t.shadowData.shadowTarget&&e.invalidateRenderTarget(t.shadowData.shadowTarget),t.shadowData.shadowTargetDown&&e.invalidateRenderTarget(t.shadowData.shadowTargetDown),t.shadowData.shadowBlurred&&e.invalidateRenderTarget(t.shadowData.shadowBlurred))},t.prototype.copy=function(e){return this.translation.copy(e.translation),this.color.copy(e.color),this.intensity=e.intensity,this.specularIntensity=e.specularIntensity,this.shadowCaster=e.shadowCaster,e.lightCookie&&(this.lightCookie=e.lightCookie.clone()),this.shadowSettings.size=e.shadowSettings.size,this.shadowSettings.near=e.shadowSettings.near,this.shadowSettings.far=e.shadowSettings.far,this.shadowSettings.resolution[0]=e.shadowSettings.resolution[0],this.shadowSettings.resolution[1]=e.shadowSettings.resolution[1],this.shadowSettings.upVector.copy(e.shadowSettings.upVector),this.shadowSettings.darkness=e.shadowSettings.darkness,this.shadowSettings.shadowType=e.shadowSettings.shadowType,this.changedProperties=e.changedProperties,this.changedColor=e.changedColor,this},t}),define("goo/entities/components/LightComponent",["goo/entities/components/Component","goo/renderer/light/Light"],function(e,t){function n(t){e.apply(this,arguments),this.type="LightComponent",this.light=t,this.hidden=!1,Object.seal(this)}return n.type="LightComponent",n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.updateLight=function(e){this.light.update(e)},n.prototype.copy=function(e){return this.light.copy(e),this.hidden=e.hidden,this},n.prototype.clone=function(){var e=new n(this.light.clone());return e.hidden=this.hidden,e},n.applyOnEntity=function(e,r){if(e instanceof t){var i=new n(e);return r.setComponent(i),!0}},n}),define("goo/renderer/light/PointLight",["goo/renderer/light/Light"],function(e){function t(t){e.call(this,t),this.range=1e3,Object.seal(this)}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.update=function(e){e.matrix.getTranslation(this.translation)},t.prototype.copy=function(t){return e.prototype.copy.call(this,t),this.range=t.range,this},t.prototype.clone=function(){var e=new t(this.color.clone());return e.copy(this),e},t}),define("goo/renderer/light/SpotLight",["goo/math/Vector3","goo/renderer/light/Light"],function(e,t){function n(n){t.call(this,n),this.direction=new e,this.range=1e3,this.angle=45,this.penumbra=null,this.exponent=16,Object.seal(this)}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.update=function(e){e.matrix.getTranslation(this.translation),this.direction.setDirect(0,0,-1),e.matrix.applyPostVector(this.direction)},n.prototype.copy=function(e){return t.prototype.copy.call(this,e),e.direction.copy(this.direction),this.range=e.range,this.angle=e.angle,this.penumbra=e.penumbra,this.exponent=e.exponent,this},n.prototype.clone=function(){var e=new n(this.color.clone());return e.copy(this),e},n}),define("goo/renderer/light/DirectionalLight",["goo/math/Vector3","goo/renderer/light/Light"],function(e,t){function n(n){t.call(this,n),this.direction=new e,Object.seal(this)}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.update=function(e){e.matrix.getTranslation(this.translation),this.direction.setDirect(0,0,-1),e.matrix.applyPostVector(this.direction)},n.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.direction.copy(e.direction),this},n.prototype.clone=function(){var e=new n(this.color.clone());return e.copy(this),e},n}),define("goo/loaders/handlers/LightComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/LightComponent","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/light/DirectionalLight","goo/math/Vector","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o,u,a){function f(){e.apply(this,arguments),this._type="LightComponent"}f.prototype=Object.create(e.prototype),f.prototype.constructor=f,e._registerClass("light",f);var l,c=function(){if(l===undefined){var e=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);l=!e}return l};return f.prototype._prepare=function(e){a.defaults(e,{direction:[0,0,0],color:[1,1,1],shadowCaster:!1,lightCookie:null}),e.type!=="DirectionalLight"&&(e.range=e.range!==undefined?e.range:1e3);if(e.shadowCaster&&c()){e.shadowSettings=e.shadowSettings||{},a.defaults(e.shadowSettings,{shadowType:"Basic",near:1,far:1e3,resolution:[512,512],darkness:.5});var t=e.shadowSettings;t.projection==="Parallel"?t.size=t.size!==undefined?t.size:400:t.fov=t.fov!==undefined?t.fov:55}},f.prototype._create=function(){return new t},f.prototype.update=function(t,o,u){var f=this,l={SpotLight:r,DirectionalLight:i,PointLight:n};return e.prototype.update.call(this,t,o,u).then(function(e){if(!e)return;var t=e.light;if(!t||l[o.type]!==t.constructor)t=new l[o.type],e.light=t;for(var n in o){var r=o[n];if(t.hasOwnProperty(n))if(n==="shadowSettings")for(var n in r){var i=r[n];t.shadowSettings[n]instanceof s?t.shadowSettings[n].set(i):t.shadowSettings[n]=a.clone(i)}else t[n]instanceof s?t[n].set(r):t[n]=a.clone(r)}if(o.type==="PointLight"||!c())t.shadowCaster=!1;if(o.lightCookie&&o.type!=="PointLight"){var h=o.lightCookie;return!h||!h.textureRef||h.enabled===!1?(t.lightCookie=null,e):f._load(h.textureRef,u).then(function(n){return t.lightCookie=n,e})}return t.lightCookie=null,e})},f}),define("goo/renderer/ShaderCall",[],function(){function e(e,t,n){this.context=e,this.location=t,this.location.value=undefined;if(n)switch(n){case"float":this.call=this.uniform1f;break;case"bool":case"int":case"integer":case"sampler2D":case"sampler3D":case"samplerCube":this.call=this.uniform1i;break;case"floatarray":this.call=this.uniform1fv;break;case"intarray":case"samplerArray":this.call=this.uniform1iv;break;case"ivec2":this.call=this.uniform2iv;break;case"ivec3":this.call=this.uniform3iv;break;case"ivec4":this.call=this.uniform4iv;break;case"vec2":this.call=this.uniform2fv;break;case"vec3":this.call=this.uniform3fv;break;case"vec4":this.call=this.uniform4fv;break;case"mat2":this.call=this.uniformMatrix2fv;break;case"mat3":this.call=this.uniformMatrix3fv;break;case"mat4":this.call=this.uniformMatrix4fv;break;default:throw"Uniform type not handled: "+n}}function t(e,t){var n=e.length;while(n--)if(e[n]!==t[n])return!1;return!0}return e.prototype.uniform1f=function(e){var t=this.location.value;if(t===e)return;this.context.uniform1f(this.location,e),this.location.value=e},e.prototype.uniform1fv=function(e){var n=this.location.value;if(n!==undefined&&t(e,n))return;this.context.uniform1fv(this.location,e),this.location.value=e.slice()},e.prototype.uniform1i=function(e){var t=this.location.value;if(t===e)return;this.context.uniform1i(this.location,e),this.location.value=e},e.prototype.uniform1iv=function(e){var n=this.location.value;if(n!==undefined&&t(e,n))return;this.context.uniform1iv(this.location,e),this.location.value=e.slice()},e.prototype.uniform2f=function(e,t){var n=this.location.value;if(n!==undefined&&n[0]===e&&n[1]===t)return;this.context.uniform2f(this.location,e,t),this.location.value=[e,t]},e.prototype.uniform2fv=function(e){var n=this.location.value;if(n!==undefined){if(t(e,n))return}else n=this.location.value=new Float64Array(e.length);this.context.uniform2fv(this.location,e);var r=e.length;while(r--)n[r]=e[r]},e.prototype.uniform2i=function(e,t){var n=this.location.value;if(n!==undefined&&n[0]===e&&n[1]===t)return;this.context.uniform2i(this.location,e,t),this.location.value=[e,t]},e.prototype.uniform2iv=function(e){var n=this.location.value;if(n!==undefined&&t(e,n))return;this.context.uniform2iv(this.location,e),this.location.value=e.slice()},e.prototype.uniform3f=function(e,t,n){var r=this.location.value;if(r!==undefined){if(r[0]===e&&r[1]===t&&r[2]===n)return}else r=this.location.value=[];this.context.uniform3f(this.location,e,t,n),r[0]=e,r[1]=t,r[2]=n},e.prototype.uniform3fv=function(e){var n=this.location.value;if(n!==undefined){if(t(e,n))return}else n=this.location.value=new Float64Array(e.length);this.context.uniform3fv(this.location,e);var r=e.length;while(r--)n[r]=e[r]},e.prototype.uniform3i=function(e,t,n){var r=this.location.value;if(r!==undefined&&r[0]===e&&r[1]===t&&r[2]===n)return;this.context.uniform3i(this.location,e,t,n),this.location.value=[e,t,n]},e.prototype.uniform3iv=function(e){var n=this.location.value;if(n!==undefined&&t(e,n))return;this.context.uniform3iv(this.location,e),this.location.value=e.slice()},e.prototype.uniform4f=function(e,t,n,r){var i=this.location.value;if(i!==undefined&&i[0]===e&&i[1]===t&&i[2]===n&&i[3]===r)return;this.context.uniform4f(this.location,e,t,n,r),this.location.value=[e,t,n,r]},e.prototype.uniform4fv=function(e){var n=this.location.value;if(n!==undefined){if(t(e,n))return}else n=this.location.value=new Float64Array(e.length);this.context.uniform4fv(this.location,e);var r=e.length;while(r--)n[r]=e[r]},e.prototype.uniform4i=function(e,t,n,r){var i=this.location.value;if(i!==undefined&&i[0]===e&&i[1]===t&&i[2]===n&&i[3]===r)return;this.context.uniform4i(this.location,e,t,n,r),this.location.value=[e,t,n,r]},e.prototype.uniform4iv=function(e){var n=this.location.value;if(n!==undefined&&t(e,n))return;this.context.uniform4iv(this.location,e),this.location.value=e.slice()},e.prototype.uniformMatrix2fv=function(e,n){n=n===!0;if(!e.data){var r=e,i=this.location.value;if(i!==undefined){if(t(r,i))return}else i=this.location.value=new Float64Array(r.length);this.context.uniformMatrix2fv(this.location,n,r);var s=r.length;while(s--)i[s]=r[s];return}var i=this.location.value;if(i!==undefined){var o=t(i.data,e.data);if(o)return;i.copy(e)}else this.location.value=e.clone();this.context.uniformMatrix2fv(this.location,n,e.data)},e.prototype.uniformMatrix3fv=function(e,n){n=n===!0;if(!e.data){var r=e,i=this.location.value;if(i!==undefined){if(t(r,i))return}else i=this.location.value=new Float64Array(r.length);this.context.uniformMatrix3fv(this.location,n,r);var s=r.length;while(s--)i[s]=r[s];return}var i=this.location.value;if(i!==undefined){var o=t(i.data,e.data);if(o)return;i.copy(e)}else this.location.value=e.clone();for(var u=0;u<e.data.length;u++)e.data32[u]=e.data[u];this.context.uniformMatrix3fv(this.location,n,e.data32)},e.prototype.uniformMatrix4fv=function(e,n){n=n===!0;if(!e.data){var r=e,i=this.location.value;if(i!==undefined){if(t(r,i))return}else i=this.location.value=new Float64Array(r.length);this.context.uniformMatrix4fv(this.location,n,r);var s=r.length;while(s--)i[s]=r[s];return}var i=this.location.value;if(i!==undefined){var o=t(i.data,e.data);if(o)return;i.copy(e)}else this.location.value=e.clone();for(var u=0;u<e.data.length;u++)e.data32[u]=e.data[u];this.context.uniformMatrix4fv(this.location,n,e.data32)},e}),define("goo/math/Matrix3x3",["goo/math/MathUtils","goo/math/Matrix","goo/math/Vector3"],function(e,t,n){function r(){t.call(this,3,3),arguments.length===0?(this.data[0]=1,this.data[4]=1,this.data[8]=1):t.prototype.set.apply(this,arguments),Object.seal(this)}return r._tempX=new n,r._tempY=new n,r._tempZ=new n,r.prototype=Object.create(t.prototype),r.prototype.constructor=r,t.setupAliases(r.prototype,[["e00"],["e10"],["e20"],["e01"],["e11"],["e21"],["e02"],["e12"],["e22"]]),r.IDENTITY=new r(1,0,0,0,1,0,0,0,1),r.add=function(e,t,n){n||(n=new r);var i=n.data,s=e.data;if(t instanceof r){var o=t.data;i[0]=s[0]+o[0],i[1]=s[1]+o[1],i[2]=s[2]+o[2],i[3]=s[3]+o[3],i[4]=s[4]+o[4],i[5]=s[5]+o[5],i[6]=s[6]+o[6],i[7]=s[7]+o[7],i[8]=s[8]+o[8]}else i[0]=s[0]+t,i[1]=s[1]+t,i[2]=s[2]+t,i[3]=s[3]+t,i[4]=s[4]+t,i[5]=s[5]+t,i[6]=s[6]+t,i[7]=s[7]+t,i[8]=s[8]+t;return n},r.prototype.add=function(e){return r.add(this,e,this)},r.sub=function(e,t,n){n||(n=new r);var i=n.data,s=e.data;if(t instanceof r){var o=t.data;i[0]=s[0]-o[0],i[1]=s[1]-o[1],i[2]=s[2]-o[2],i[3]=s[3]-o[3],i[4]=s[4]-o[4],i[5]=s[5]-o[5],i[6]=s[6]-o[6],i[7]=s[7]-o[7],i[8]=s[8]-o[8]}else i[0]=s[0]-t,i[1]=s[1]-t,i[2]=s[2]-t,i[3]=s[3]-t,i[4]=s[4]-t,i[5]=s[5]-t,i[6]=s[6]-t,i[7]=s[7]-t,i[8]=s[8]-t;return n},r.prototype.sub=function(e){return r.sub(this,e,this)},r.mul=function(e,t,n){n||(n=new r);var i=n.data,s=e.data;if(t instanceof r){var o=t.data;i[0]=s[0]*o[0],i[1]=s[1]*o[1],i[2]=s[2]*o[2],i[3]=s[3]*o[3],i[4]=s[4]*o[4],i[5]=s[5]*o[5],i[6]=s[6]*o[6],i[7]=s[7]*o[7],i[8]=s[8]*o[8]}else i[0]=s[0]*t,i[1]=s[1]*t,i[2]=s[2]*t,i[3]=s[3]*t,i[4]=s[4]*t,i[5]=s[5]*t,i[6]=s[6]*t,i[7]=s[7]*t,i[8]=s[8]*t;return n},r.prototype.mul=function(e){return r.mul(this,e,this)},r.div=function(e,t,n){n||(n=new r);var i=n.data,s=e.data;if(t instanceof r){var o=t.data;i[0]=s[0]/o[0],i[1]=s[1]/o[1],i[2]=s[2]/o[2],i[3]=s[3]/o[3],i[4]=s[4]/o[4],i[5]=s[5]/o[5],i[6]=s[6]/o[6],i[7]=s[7]/o[7],i[8]=s[8]/o[8]}else i[0]=s[0]/t,i[1]=s[1]/t,i[2]=s[2]/t,i[3]=s[3]/t,i[4]=s[4]/t,i[5]=s[5]/t,i[6]=s[6]/t,i[7]=s[7]/t,i[8]=s[8]/t;return n},r.prototype.div=function(e){return r.div(this,e,this)},r.combine=function(e,t,n){n||(n=new r);var i=e.data,s=i[0],o=i[3],u=i[6],a=i[1],f=i[4],l=i[7],c=i[2],h=i[5],p=i[8],d=t.data,v=d[0],m=d[3],g=d[6],y=d[1],b=d[4],w=d[7],E=d[2],S=d[5],x=d[8],T=n.data;return T[0]=s*v+o*y+u*E,T[3]=s*m+o*b+u*S,T[6]=s*g+o*w+u*x,T[1]=a*v+f*y+l*E,T[4]=a*m+f*b+l*S,T[7]=a*g+f*w+l*x,T[2]=c*v+h*y+p*E,T[5]=c*m+h*b+p*S,T[8]=c*g+h*w+p*x,n},r.prototype.combine=function(e){return r.combine(this,e,this)},r.transpose=function(e,t){t||(t=new r);var n=e.data,i=t.data;if(t===e){var s=n[3],o=n[6],u=n[7];return i[3]=n[1],i[6]=n[2],i[7]=n[5],i[1]=s,i[2]=o,i[5]=u,t}return i[0]=n[0],i[1]=n[3],i[2]=n[6],i[3]=n[1],i[4]=n[4],i[5]=n[7],i[6]=n[2],i[7]=n[5],i[8]=n[8],t},r.prototype.transpose=function(){return r.transpose(this,this)},r.invert=function(n,i){i||(i=new r);if(i===n)return t.copy(r.invert(n),i);var s=n.determinant();if(Math.abs(s)<e.EPSILON)return i;s=1/s;var o=i.data,u=n.data;return o[0]=(u[4]*u[8]-u[7]*u[5])*s,o[1]=(u[7]*u[2]-u[1]*u[8])*s,o[2]=(u[1]*u[5]-u[4]*u[2])*s,o[3]=(u[6]*u[5]-u[3]*u[8])*s,o[4]=(u[0]*u[8]-u[6]*u[2])*s,o[5]=(u[3]*u[2]-u[0]*u[5])*s,o[6]=(u[3]*u[7]-u[6]*u[4])*s,o[7]=(u[6]*u[1]-u[0]*u[7])*s,o[8]=(u[0]*u[4]-u[3]*u[1])*s,i},r.prototype.invert=function(){return r.invert(this,this)},r.prototype.isOrthogonal=function(){var t=this.data,n=t[0]*t[3]+t[1]*t[4]+t[2]*t[5];return Math.abs(n)>e.EPSILON?!1:(n=t[0]*t[6]+t[1]*t[7]+t[2]*t[8],Math.abs(n)>e.EPSILON?!1:(n=t[3]*t[6]+t[4]*t[7]+t[5]*t[8],Math.abs(n)>e.EPSILON?!1:!0))},r.prototype.isNormal=function(){var t=this.data,n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];return Math.abs(n-1)>e.EPSILON?!1:(n=t[3]*t[3]+t[4]*t[4]+t[5]*t[5],Math.abs(n-1)>e.EPSILON?!1:(n=t[6]*t[6]+t[7]*t[7]+t[8]*t[8],Math.abs(n-1)>e.EPSILON?!1:!0))},r.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},r.prototype.determinant=function(){var e=this.data;return e[0]*(e[4]*e[8]-e[7]*e[5])-e[3]*(e[1]*e[8]-e[7]*e[2])+e[6]*(e[1]*e[5]-e[4]*e[2])},r.prototype.setIdentity=function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},r.prototype.applyPost=function(e){var t=e.data,n=this.data,r=t[0],i=t[1],s=t[2];return t[0]=n[0]*r+n[3]*i+n[6]*s,t[1]=n[1]*r+n[4]*i+n[7]*s,t[2]=n[2]*r+n[5]*i+n[8]*s,e},r.prototype.applyPre=function(e){var t=e.data,n=this.data,r=t[0],i=t[1],s=t[2];return t[0]=n[0]*r+n[1]*i+n[2]*s,t[1]=n[3]*r+n[4]*i+n[5]*s,t[2]=n[6]*r+n[7]*i+n[8]*s,e},r.prototype.multiplyDiagonalPost=function(e,t){var n=e.data[0],r=e.data[1],i=e.data[2],s=this.data,o=t.data;return o[0]=n*s[0],o[1]=n*s[1],o[2]=n*s[2],o[3]=r*s[3],o[4]=r*s[4],o[5]=r*s[5],o[6]=i*s[6],o[7]=i*s[7],o[8]=i*s[8],t},r.prototype.fromAngles=function(e,t,n){var r=Math.cos(e),i=Math.sin(e),s=Math.cos(t),o=Math.sin(t),u=Math.cos(n),a=Math.sin(n),f=this.data;return f[0]=s*u,f[3]=o*i-s*a*r,f[6]=s*a*i+o*r,f[1]=a,f[4]=u*r,f[7]=-u*i,f[2]=-o*u,f[5]=o*a*r+s*i,f[8]=-o*a*i+s*r,this},r.prototype.rotateX=function(e,t){t=t||this;var n=this.data,r=t.data,i=Math.sin(e),s=Math.cos(e),o=n[3],u=n[4],a=n[5],f=n[6],l=n[7],c=n[8];return n!==r&&(r[0]=n[0],r[1]=n[1],r[2]=n[2]),r[3]=o*s+f*i,r[4]=u*s+l*i,r[5]=a*s+c*i,r[6]=f*s-o*i,r[7]=l*s-u*i,r[8]=c*s-a*i,t},r.prototype.rotateY=function(e,t){t=t||this;var n=this.data,r=t.data,i=Math.sin(e),s=Math.cos(e),o=n[0],u=n[1],a=n[2],f=n[6],l=n[7],c=n[8];return n!==r&&(r[3]=n[3],r[4]=n[4],r[5]=n[5]),r[0]=o*s-f*i,r[1]=u*s-l*i,r[2]=a*s-c*i,r[6]=o*i+f*s,r[7]=u*i+l*s,r[8]=a*i+c*s,t},r.prototype.rotateZ=function(e,t){t=t||this;var n=this.data,r=t.data,i=Math.sin(e),s=Math.cos(e),o=n[0],u=n[1],a=n[2],f=n[3],l=n[4],c=n[5];return n!==r&&(r[6]=n[6],r[7]=n[7],r[8]=n[8]),r[0]=o*s+f*i,r[1]=u*s+l*i,r[2]=a*s+c*i,r[3]=f*s-o*i,r[4]=l*s-u*i,r[5]=c*s-a*i,t},r.prototype.toAngles=function(t){var r=t;r||(r=new n);var i=this.data,s=r.data;return i[3]>1-e.EPSILON?(s[1]=Math.atan2(i[2],i[8]),s[2]=Math.PI/2,s[0]=0):i[3]<-1+e.EPSILON?(s[1]=Math.atan2(i[2],i[8]),s[2]=-Math.PI/2,s[0]=0):(s[1]=Math.atan2(-i[2],i[0]),s[0]=Math.atan2(-i[7],i[4]),s[2]=Math.asin(i[1])),r},r.prototype.fromAngleNormalAxis=function(e,t,n,r){var i=Math.cos(e),s=Math.sin(e),o=1-i,u=t*t,a=n*n,f=r*r,l=t*n*o,c=t*r*o,h=n*r*o,p=t*s,d=n*s,v=r*s,m=this.data;return m[0]=u*o+i,m[3]=l-v,m[6]=c+d,m[1]=l+v,m[4]=a*o+i,m[7]=h-p,m[2]=c-d,m[5]=h+p,m[8]=f*o+i,this},r.prototype.lookAt=function(e,t){var i=r._tempX,s=r._tempY,o=r._tempZ;o.setVector(e).normalize().scale(-1),i.setVector(t).cross(o).normalize(),i.equals(n.ZERO)&&(o.data[0]!==0?i.setDirect(o.data[1],-o.data[0],0):i.setDirect(0,o.data[2],-o.data[1])),s.setVector(o).cross(i);var u=this.data;return u[0]=i.data[0],u[1]=i.data[1],u[2]=i.data[2],u[3]=s.data[0],u[4]=s.data[1],u[5]=s.data[2],u[6]=o.data[0],u[7]=o.data[1],u[8]=o.data[2],this},r.prototype.copyQuaternion=function(e){return e.toRotationMatrix(this)},r.prototype.copy=function(e){var t=this.data,n=e.data;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this},r.prototype.clone=function(){return(new r).copy(this)},t.addPostChecks(r.prototype,["add","sub","mul","div","combine","transpose","invert","isOrthogonal","determinant","applyPost","applyPre","fromAngles","rotateX","rotateY","rotateZ","fromAngleNormalAxis","lookAt","copyQuaternion","copy"]),r}),define("goo/entities/Entity",["goo/entities/components/Component","goo/util/StringUtil"],function(e,t){function n(e,r,i){this._world=e,this._components=[],this.id=i!==undefined?i:t.createUniqueId("entity"),this._index=n.entityCount,this._tags=new Set,this._attributes=new Map,this.name=r!==undefined?r:"Entity_"+this._index,this.skip=!1,this.hidden=!1,this._hidden=!1,this.static=!1,n.entityCount++}function r(e){return e.charAt(0).toLowerCase()+e.substr(1)}return n.prototype.set=function(){for(var t=0;t<arguments.length;t++){var n=arguments[t];if(n instanceof e)this.setComponent(n);else{if(!this._world)return this;var r=this._world._components;for(var i=0;i<r.length;i++){var s=r[i],o=s.applyOnEntity(n,this);if(o)break}}}return this},n.prototype.addToWorld=function(e){return this._world.addEntity(this,e),this},n.prototype.removeFromWorld=function(e){return this._world.removeEntity(this,e),this},n.prototype.setComponent=function(e){return this.hasComponent(e.type)?this:(this._components.push(e),this[r(e.type)]=e,e.attached&&e.attached(this),e.applyAPI(this),this._world&&this._world.entityManager.containsEntity(this)&&this._world.changedEntity(this,e,"addedComponent"),this)},n.prototype.hasComponent=function(e){var t=r(e);return!!this[t]},n.prototype.getComponent=function(e){var t=r(e);return this[t]},n.prototype.clearComponent=function(e){var t=r(e),n=this[t];if(!!n&&this._components.indexOf(n)>-1){n.detached&&n.detached(this),n.removeAPI(this);var i=this._components.indexOf(n);this._components.splice(i,1),delete this[t],this._world&&this._world.entityManager.containsEntity(this)&&this._world.changedEntity(this,n,"removedComponent")}return this},n.prototype.setTag=function(e){return this._tags.add(e),this},n.prototype.hasTag=function(e){return this._tags.has(e)},n.prototype.clearTag=function(e){return this._tags.delete(e),this},n.prototype.setAttribute=function(e,t){return this._attributes.set(e,t),this},n.prototype.hasAttribute=function(e){return this._attributes.has(e)},n.prototype.getAttribute=function(e){return this._attributes.get(e)},n.prototype.clearAttribute=function(e){return this._attributes.delete(e),this},n.prototype.toString=function(){return this.name},n.entityCount=0,n}),define("goo/entities/managers/Manager",[],function(){function e(){this.installedAPI={}}return e.prototype.applyAPI=function(e){var t=this.api;for(var n in t)typeof e[n]=="undefined"?(e[n]=t[n],this.installedAPI[n]=!0):console.warn("Could not install method "+n+" of "+this.type+" as it is already taken")},e}),define("goo/entities/managers/EntityManager",["goo/entities/managers/Manager","goo/entities/EntitySelection"],function(e,t){function n(){e.call(this),this.type="EntityManager",this._entitiesById=new Map,this._entitiesByIndex=new Map,this._entityCount=0,this.api={id:function(){var e=n.prototype.getEntityById.apply(this,arguments);return new t(e)}.bind(this),name:function(e){var n=this.getEntities();return new t(n.filter(function(t){return t.name===e}))}.bind(this)}}return n.prototype=Object.create(e.prototype),n.prototype.added=function(e){this.containsEntity(e)||(this._entitiesById.set(e.id,e),this._entitiesByIndex.set(e._index,e),this._entityCount++)},n.prototype.removed=function(e){this.containsEntity(e)&&(this._entitiesById.delete(e.id),this._entitiesByIndex.delete(e._index),this._entityCount--)},n.prototype.containsEntity=function(e){return this._entitiesByIndex.has(e._index)},n.prototype.getEntityById=function(e){return this._entitiesById.get(e)},n.prototype.getEntityByIndex=function(e){return this._entitiesByIndex.get(e)},n.prototype.getEntityByName=function(e){if(this._entityCount<=0)return;var t;return this._entitiesByIndex.forEach(function(n){n.name===e&&(t=n)}),t},n.prototype.size=function(){return this._entityCount},n.prototype.getEntities=function(){var e=[];return this._entitiesByIndex.forEach(function(t){e.push(t)}),e},n.prototype.getTopEntities=function(){var e=[];return this._entitiesByIndex.forEach(function(t){(!t.transformComponent||!t.transformComponent.parent)&&e.push(t)}),e},n.prototype.clear=function(){this._entitiesById.clear(),this._entitiesByIndex.clear(),this._entityCount=0},n}),define("goo/math/Transform",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/math/MathUtils"],function(e,t,n,r){function i(){this.matrix=new n,this.normalMatrix=new t,this.translation=new e,this.rotation=new t,this.scale=new e(1,1,1),Object.seal(this)}var s=new e,o=new e,u=new t;return i.combine=function(e,n,r){return r=r||new i,s.setVector(n.translation),e.rotation.applyPost(s),s.mulVector(e.scale),s.addVector(e.translation),o.setVector(n.scale),o.mulVector(e.scale),t.combine(e.rotation,n.rotation,u),r.rotation.copy(u),r.scale.setVector(o),r.translation.setVector(s),r.update(),r},i.prototype.combine=function(e){return i.combine(this,e,this)},i.prototype.multiply=function(e,r){for(var i=0;i<e.matrix.data.length;i++)e.matrix.data[i]*=1e-4,r.matrix.data[i]*=1e-4;n.combine(e.matrix,r.matrix,this.matrix);for(var i=0;i<e.matrix.data.length;i++)e.matrix.data[i]*=1e4,r.matrix.data[i]*=1e4,this.matrix.data[i]*=1e8;u.data.set(e.rotation.data),this.rotation.data.set(r.rotation.data),t.combine(u,this.rotation,this.rotation),this.translation.setVector(r.translation),this.translation.mulVector(e.scale),u.applyPost(this.translation).addVector(e.translation),s.setVector(e.scale).mulVector(r.scale),this.scale.setVector(s)},i.prototype.setIdentity=function(){this.matrix.setIdentity(),this.translation.setVector(e.ZERO),this.rotation.setIdentity(),this.scale.setVector(e.ONE)},i.prototype.applyForward=function(e,t){return t.setVector(e),this.matrix.applyPostPoint(t),t},i.prototype.applyForwardVector=function(e,t){return t.copy(e),t.setDirect(t.x*this.scale.x,t.y*this.scale.y,t.z*this.scale.z),this.rotation.applyPost(t),t},i.prototype.update=function(){var e=this.matrix.data,t=this.rotation.data,n=this.scale.data,r=this.translation.data;e[0]=n[0]*t[0],e[1]=n[0]*t[1],e[2]=n[0]*t[2],e[3]=0,e[4]=n[1]*t[3],e[5]=n[1]*t[4],e[6]=n[1]*t[5],e[7]=0,e[8]=n[2]*t[6],e[9]=n[2]*t[7],e[10]=n[2]*t[8],e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1},i.prototype.updateNormalMatrix=function(){var e=this.normalMatrix.data,n=this.matrix.data;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[4],e[4]=n[5],e[5]=n[6],e[6]=n[8],e[7]=n[9],e[8]=n[10];var r=this.scale.data;if(r[0]!==r[1]||r[0]!==r[2])t.invert(this.normalMatrix,u),t.transpose(u,this.normalMatrix)},i.prototype.copy=function(e){this.matrix.copy(e.matrix),this.translation.setVector(e.translation),this.rotation.copy(e.rotation),this.scale.setVector(e.scale)},i.prototype.setRotationXYZ=function(e,t,n){this.rotation.fromAngles(e,t,n)},i.prototype.lookAt=function(t,n){n||(n=e.UNIT_Y),s.setVector(t).subVector(this.translation),s.lengthSquared()>r.EPSILON&&(s.normalize(),this.rotation.lookAt(s,n))},i.prototype.invert=function(t){var n=t;n||(n=new i),n.matrix.copy(this.matrix),n.matrix.invert();var r=n.rotation.copy(this.rotation);return r.transpose(),n.scale.setVector(e.ONE).div(this.scale),n.translation.copy(this.translation).invert().mulVector(n.scale),n.rotation.applyPost(n.translation),n},i.prototype.toString=function(){return""+this.matrix},i.prototype.clone=function(){var e=new i;return e.matrix.copy(this.matrix),e.normalMatrix.copy(this.normalMatrix),e.translation.copy(this.translation),e.rotation.copy(this.rotation),e.scale.copy(this.scale),e},i}),define("goo/entities/components/TransformComponent",["goo/math/Transform","goo/math/Vector3","goo/entities/components/Component","goo/entities/EntitySelection","goo/math/Matrix4x4","goo/math/Vector"],function(e,t,n,r,i,s){function o(){n.apply(this,arguments),this.type="TransformComponent",this.entity=null,this.parent=null,this.children=[],this.transform=new e,this.worldTransform=new e,this._dirty=!0,this._updated=!1,Object.seal(this)}o.type="TransformComponent",o.prototype=Object.create(n.prototype),o.prototype.constructor=o,o.prototype.api={setTranslation:function(){return o.prototype.setTranslation.apply(this.transformComponent,arguments),this},setRotation:function(){return o.prototype.setRotation.apply(this.transformComponent,arguments),this},setScale:function(){return o.prototype.setScale.apply(this.transformComponent,arguments),this},lookAt:function(){return o.prototype.lookAt.apply(this.transformComponent,arguments),this},move:function(){return o.prototype.move.apply(this.transformComponent,arguments),this},getTranslation:function(){return o.prototype.getTranslation.apply(this.transformComponent,arguments)},getRotation:function(){return o.prototype.getRotation.apply(this.transformComponent,arguments)},getScale:function(){return o.prototype.getScale.apply(this.transformComponent,arguments)},addTranslation:function(){return o.prototype.addTranslation.apply(this.transformComponent,arguments),this},addRotation:function(){return o.prototype.addRotation.apply(this.transformComponent,arguments),this},attachChild:function(e,t){return this.transformComponent.attachChild(e.transformComponent,t),this},detachChild:function(e,t){return this.transformComponent.detachChild(e.transformComponent,t),this},children:function(){return(new r(this)).children()},parent:function(){return(new r(this)).parent()},traverse:function(e,t){t=t!==undefined?t:0;if(e(this,t)!==!1)for(var n=0;n<this.transformComponent.children.length;n++){var r=this.transformComponent.children[n].entity;r.traverse(e,t+1)}return this},traverseUp:function(e){var t=this.transformComponent;while(e(t.entity)!==!1&&t.parent)t=t.parent;return this},hide:function(){return this._hidden=!0,this.traverse(function(e){for(var t=0;t<e._components.length;t++){var n=e._components[t];typeof n.hidden=="boolean"&&(n.hidden=!0)}}),this},show:function(){this._hidden=!1;var e=this;while(e.transformComponent.parent){e=e.transformComponent.parent.entity;if(e._hidden){for(var t=0;t<this._components.length;t++){var n=this._components[t];typeof n.hidden=="boolean"&&(n.hidden=!0)}return this}}return this.traverse(function(e){if(e._hidden)return!1;for(var t=0;t<e._components.length;t++){var n=e._components[t];typeof n.hidden=="boolean"&&(n.hidden=e._hidden)}}),this},isVisiblyHidden:function(){var e=this;if(e._hidden)return!0;while(e.transformComponent.parent){e=e.transformComponent.parent.entity;if(e._hidden)return!0}return!1},isHidden:function(){return this._hidden}},o.entitySelectionAPI={setTranslation:o.prototype.api.setTranslation,setRotation:o.prototype.api.setRotation,setScale:o.prototype.api.setScale,lookAt:o.prototype.api.lookAt,move:o.prototype.api.move,addTranslation:o.prototype.api.addTranslation,addRotation:o.prototype.api.addRotation,hide:o.prototype.api.hide,show:o.prototype.api.show};var u=new t;return o.prototype.getTranslation=function(){return this.transform.translation},o.prototype.setTranslation=function(){return s.prototype.set.apply(this.transform.translation,arguments),this._dirty=!0,this},o.prototype.getScale=function(){return this.transform.scale},o.prototype.setScale=function(){return s.prototype.set.apply(this.transform.scale,arguments),this._dirty=!0,this},o.prototype.addTranslation=function(){return arguments.length===3?this.transform.translation.add(arguments):this.transform.translation.add(arguments[0]),this._dirty=!0,this},o.prototype.getRotation=function(e){return e=e||new t,this.transform.rotation.toAngles(e)},o.prototype.addRotation=function(){this.getRotation(u);if(arguments.length===1&&typeof arguments[0]=="object"){var e=arguments[0];e instanceof t?this.transform.rotation.fromAngles(u.x+e.x,u.y+e.y,u.z+e.z):e.length===3&&this.transform.rotation.fromAngles(u.x+e[0],u.y+e[1],u.z+e[2])}else this.transform.rotation.fromAngles(u.x+arguments[0],u.y+arguments[1],u.z+arguments[2]);return this._dirty=!0,this},o.prototype.setRotation=function(){if(arguments.length===1&&typeof arguments[0]=="object"){var e=arguments[0];e instanceof t?this.transform.rotation.fromAngles(e.x,e.y,e.z):e.length===3&&this.transform.rotation.fromAngles(e[0],e[1],e[2])}else this.transform.rotation.fromAngles(arguments[0],arguments[1],arguments[2]);return this._dirty=!0,this},o.prototype.lookAt=function(e,n){return arguments.length===3?this.transform.lookAt(new t(arguments[0],arguments[1],arguments[2])):(Array.isArray(e)&&(e=new t(e)),Array.isArray(n)&&(n=new t(n)),this.transform.lookAt(e,n)),this._dirty=!0,this},o.prototype.move=function(){var e=new t,n=new t;return function(){return e.set.apply(e,arguments),this.transform.applyForwardVector(e,n),this.addTranslation(n),this}}(),o.prototype.setUpdated=function(){this._dirty=!0},o.prototype.attached=function(e){this.entity=e},o.prototype.detached=function(){this.entity=undefined},o.prototype.attachChild=function(e,t){var n=this;while(n){if(n===e){console.warn("attachChild: An object can't be added as a descendant of itself.");return}n=n.parent}e.parent&&e.parent.detachChild(e),t&&(e.updateTransform(),this.updateTransform(),this.updateWorldTransform(),e.transform.multiply(this.worldTransform.invert(),e.transform)),e.parent=this,this.children.push(e)},o.prototype.detachChild=function(e,t){if(e===this){console.warn("attachChild: An object can't be removed from itself.");return}t&&e.transform.copy(e.worldTransform);var n=this.children.indexOf(e);n!==-1&&(e.parent=null,this.children.splice(n,1))},o.prototype.updateTransform=function(){this.transform.update()},o.prototype.updateWorldTransform=function(){this.parent?this.worldTransform.multiply(this.parent.worldTransform,this.transform):this.worldTransform.copy(this.transform),this.worldTransform.updateNormalMatrix(),this._dirty=!1,this._updated=!0},o.applyOnEntity=function(n,r){var i=r.transformComponent;i||(i=new o);var s=!1;Array.isArray(n)&&n.length===3?(i.transform.translation.setDirect(n[0],n[1],n[2]),s=!0):n instanceof t?(i.transform.translation.setDirect(n.data[0],n.data[1],n.data[2]),s=!0):typeof n=="object"&&typeof n.x!="undefined"&&typeof n.y!="undefined"&&typeof n.z!="undefined"?(i.transform.translation.setDirect(n.x,n.y,n.z),s=!0):n instanceof e&&(i.transform=n,s=!0);if(s)return i.setUpdated(),r.setComponent(i),!0},o}),define("goo/entities/systems/System",[],function(){function e(e,t){this.type=e,this.interests=t,this._activeEntities=[],this.passive=!1,this.priority=0}function t(e){return e.charAt(0).toLowerCase()+e.substr(1)}return e.prototype.added=function(e){this._check(e)},e.prototype.changed=function(e){this._check(e)},e.prototype.removed=function(e){var t=this._activeEntities.indexOf(e);t!==-1&&(this._activeEntities.splice(t,1),this.deleted&&this.deleted(e))},e.prototype.cleanup=function(){if(this.deleted)for(var e=0;e<this._activeEntities.length;e++){var t=this._activeEntities[e];this.deleted(t)}},e.prototype._check=function(e){if(this.interests&&this.interests.length===0)return;var n=this.interests===null;if(!n&&this.interests.length<=e._components.length){n=!0;for(var r=0;r<this.interests.length;r++){var i=t(this.interests[r]);if(!e[i]){n=!1;break}}}var s=this._activeEntities.indexOf(e);n&&s===-1?(this._activeEntities.push(e),this.inserted&&this.inserted(e)):!n&&s!==-1&&(this._activeEntities.splice(s,1),this.deleted&&this.deleted(e))},e.prototype._process=function(e){this.process&&this.process(this._activeEntities,e)},e.prototype.clear=function(){this._activeEntities=[]},e}),define("goo/entities/World",["goo/entities/Entity","goo/entities/managers/EntityManager","goo/entities/components/TransformComponent","goo/entities/managers/Manager","goo/entities/systems/System","goo/entities/components/Component","goo/entities/EntitySelection"],function(e,t,n,r,i,s,o){function u(e){this.gooRunner=e,this._managers=[],this._systems=[],this._addedEntities=[],this._changedEntities=[],this._removedEntities=[],this.by={},this._installDefaultSelectors(),this.entityManager=new t,this.setManager(this.entityManager),this.time=0,this.tpf=1,this._components=[]}return u.time=0,u.tpf=1,u.prototype._installDefaultSelectors=function(){this.by.system=function(e){var t=this.getSystem(e);return new o(t._activeEntities)}.bind(this),this.by.component=function(e){var t=this.entityManager.getEntities();return new o(t.filter(function(t){return t.hasComponent(e)}))}.bind(this),this.by.tag=function(e){var t=this.entityManager.getEntities();return new o(t.filter(function(t){return t.hasTag(e)}))}.bind(this),this.by.attribute=function(e){var t=this.entityManager.getEntities();return new o(t.filter(function(t){return t.hasAttribute(e)}))}.bind(this)},u.prototype.add=function(){for(var t=0;t<arguments.length;t++){var n=arguments[t];n instanceof e?this.addEntity(n):n instanceof r?this.setManager(n):n instanceof i?this.setSystem(n):n instanceof s&&this.registerComponent(n)}return this},u.prototype.registerComponent=function(e){return this._components.indexOf(e)===-1&&(this._components.push(e),s.applyEntitySelectionAPI(e.entitySelectionAPI,e.type)),this},u.prototype.setManager=function(e){return this._managers.push(e),e.applyAPI(this.by),this},u.prototype.getManager=function(e){for(var t=0;t<this._managers.length;t++){var n=this._managers[t];if(n.type===e)return n}},u.prototype.setSystem=function(e){var t=e.priority;for(var n=0;n<this._systems.length;n++)if(this._systems[n].priority>t)break;return this._systems.splice(n,0,e),this},u.prototype.getSystem=function(e){for(var t=0;t<this._systems.length;t++){var n=this._systems[t];if(n.type===e)return n}},u.prototype.clearSystem=function(e){for(var t=0;t<this._systems.length;t++){var n=this._systems[t];n.type===e&&(n.cleanup&&n.cleanup(),this._systems.splice(t,1))}return this},u.prototype.createEntity=function(){var t=new e(this);for(var r=0;r<arguments.length;r++)typeof arguments[r]=="string"?t.name=arguments[r]:t.set(arguments[r]);return t.transformComponent||t.setComponent(new n),t},u.prototype.getEntities=function(){return this.entityManager.getEntities()},u.prototype.addEntity=function(e,t){this._addedEntities.indexOf(e)===-1&&this._addedEntities.push(e);if(e.transformComponent&&(t===undefined||t===!0)){var n=e.transformComponent.children;for(var r=0;r<n.length;r++)this.addEntity(n[r].entity,t)}for(var r=0;r<this._managers.length;r++){var i=this._managers[r];i.added(e)}return this},u.prototype.removeEntity=function(e,t){this._removedEntities.indexOf(e)===-1&&this._removedEntities.push(e);var n=e.transformComponent;n.parent&&(n.parent.detachChild(n),n.parent=null);if(t===!1){var r=n.children;for(var i=0;i<r.length;i++)r[i].parent=null;n.children=[]}else{var r=n.children;for(var i=0;i<r.length;i++)this._recursiveRemoval(r[i].entity,t)}for(var i=0;i<this._managers.length;i++){var s=this._managers[i];s.removed(e)}return this},u.prototype._recursiveRemoval=function(e,t){this._removedEntities.indexOf(e)===-1&&this._removedEntities.push(e);for(var n=0;n<this._managers.length;n++){var r=this._managers[n];r.removed(e)}if(e.transformComponent&&(t===undefined||t===!0)){var i=e.transformComponent.children;for(var n=0;n<i.length;n++)this._recursiveRemoval(i[n].entity,t)}},u.prototype.changedEntity=function(e,t,n){var r={entity:e};t!==undefined&&(r.component=t),n!==undefined&&(r.eventType=n),this._changedEntities.push(r)},u.prototype.processEntityChanges=function(){this._check(this._addedEntities,function(e,t){e.added&&e.added(t);if(e.addedComponent)for(var n=0;n<t._components.length;n++)e.addedComponent(t,t._components[n])}),this._check(this._changedEntities,function(e,t){e.changed&&e.changed(t.entity),t.eventType!==undefined&&e[t.eventType]&&e[t.eventType](t.entity,t.component)}),this._check(this._removedEntities,function(e,t){e.removed&&e.removed(t);if(e.removedComponent)for(var n=0;n<t._components.length;n++)e.removedComponent(t,t._components[n])})},u.prototype.process=function(){this.processEntityChanges();for(var e=0;e<this._systems.length;e++){var t=this._systems[e];t.passive||t._process(this.tpf)}},u.prototype._check=function(e,t){for(var n=0;n<e.length;n++){var r=e[n];for(var i=0;i<this._systems.length;i++){var s=this._systems[i];t(s,r)}}e.length=0},u.prototype.clear=function(){for(var e=0;e<this._systems.length;e++){var t=this._systems[e];t.clear&&t.clear()}this._systems=[];var n=this.entityManager.getEntities();for(var e=0;e<n.length;e++){var r=n[e];r._world=null}this.entityManager.clear(),this._addedEntities=[],this._changedEntities=[],this._removedEntities=[],this.gooRunner=null},u}),define("goo/renderer/RenderQueue",["goo/math/Vector3"],function(e){function t(){this.opaqueSorter=function(e,t){var n=e.meshRendererComponent.materials[0].shader,r=t.meshRendererComponent.materials[0].shader;return n===null||r===null?0:n.defineKey===r.defineKey?e.meshRendererComponent._renderDistance-t.meshRendererComponent._renderDistance:r.defineKey<n.defineKey?-1:r.defineKey>n.defineKey?1:0},this.transparentSorter=function(e,t){return t.meshRendererComponent._renderDistance-e.meshRendererComponent._renderDistance},this.bucketSorter=function(e,t){return e-t}}var n=[],r=new e;return t.prototype.sort=function(e,i){var s=0,o={};n.length=0;for(var u=0,a=e.length;u<a;u++){var f=e[u],l=f.meshRendererComponent;if(!l||l.materials.length===0){e[s]=f,s++;continue}var c=l.materials[0].getRenderQueue(),h=0,p=l.worldBound;p!==null?h=r.setVector(i.translation).subVector(p.center).lengthSquared():f.transformComponent&&(h=r.setVector(i.translation).subVector(f.transformComponent.worldTransform.translation).lengthSquared()),l._renderDistance=h;var d=o[c];d||(d=[],o[c]=d,n.push(c)),d.push(f)}n.length>1&&n.sort(this.bucketSorter);for(var v=0,a=n.length;v<a;v++){var m=n[v],d=o[m];m>=0&&(m<t.TRANSPARENT?d.sort(this.opaqueSorter):d.sort(this.transparentSorter));for(var u=0,g=d.length;u<g;u++)e[s]=d[u],s++}},t.BACKGROUND=0,t.OPAQUE=1e3,t.TRANSPARENT=2e3,t.OVERLAY=3e3,t}),define("goo/renderer/Shader",["goo/renderer/ShaderCall","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/entities/World","goo/renderer/RenderQueue","goo/util/ObjectUtil","goo/entities/SystemBus"],function(e,t,n,r,i,s,o){function a(e,t){if(!t.vshader||!t.fshader)throw new Error("Missing shader sources for shader: "+e);this.originalShaderDefinition=t,this.shaderDefinition=t,this.origVertexSource=t.vshader,this.origFragmentSource=t.fshader,this.name=e,this.shaderProgram=null,this.vertexShader=null,this.fragmentShader=null,this.renderer=null,this.attributeMapping={},this.attributeIndexMapping={},this.uniformMapping={},this.uniformCallMapping={},this.textureSlots=[],this.textureSlotsNaming={},this.textureIndex=0,this.currentCallbacks={},this.overridePrecision=t.precision||null,this.processors=t.processors,this.builder=t.builder,this.defines=t.defines||{},this.attributes=t.attributes||{},this.uniforms=t.uniforms||{},this.defineKey=t.defineKey||"",this.defineKeyDirty=!0,this.frameStart=!0,this.attributeKeys=null,this.matchedUniforms=[],this.renderQueue=i.OPAQUE,a.cache.has(t)?this._id=a.cache.get(t):(this._id=a.cache.size,a.cache.set(t,this._id)),this.errorOnce=!1,this.vertexSource=typeof this.origVertexSource=="function"?this.origVertexSource():this.origVertexSource,this.fragmentSource=typeof this.origFragmentSource=="function"?this.origFragmentSource():this.origFragmentSource,Object.seal(this)}function p(e){var i=new n,s=new n;e[a.PROJECTION_MATRIX]=function(e,t){var n=t.camera.getProjectionMatrix();e.uniformMatrix4fv(n)},e[a.VIEW_MATRIX]=function(e,t){i.copy(t.camera.getViewMatrix()),i.e03=0,i.e13=0,i.e23=0,e.uniformMatrix4fv(i)},e[a.WORLD_MATRIX]=function(e,t){var r=t.transform!==undefined?t.transform.matrix:n.IDENTITY;i.copy(r),i.e03-=t.camera.translation.x,i.e13-=t.camera.translation.y,i.e23-=t.camera.translation.z,e.uniformMatrix4fv(i)},e[a.NORMAL_MATRIX]=function(e,n){var r=n.transform!==undefined?n.transform.normalMatrix:t.IDENTITY;e.uniformMatrix3fv(r)},e[a.VIEW_INVERSE_MATRIX]=function(e,t){i.copy(t.camera.getViewInverseMatrix()),i.e03=0,i.e13=0,i.e23=0,e.uniformMatrix4fv(i)},e[a.VIEW_PROJECTION_MATRIX]=function(e,t){i.copy(t.camera.getViewMatrix()),i.e03=0,i.e13=0,i.e23=0,s.copy(t.camera.getProjectionMatrix()).combine(i),e.uniformMatrix4fv(s)},e[a.VIEW_PROJECTION_INVERSE_MATRIX]=function(e,t){e.uniformMatrix4fv(t.camera.getViewProjectionInverseMatrix())};for(var o=0;o<16;o++)e[a["TEXTURE"+o]]=function(e){return function(t){t.uniform1i(e)}}(o);for(var o=0;o<8;o++)e[a["LIGHT"+o]]=function(e){return function(t,n){var r=n.lights[e];r!==undefined?t.uniform3f(r.translation.data[0],r.translation.data[1],r.translation.data[2]):t.uniform3f(-20,20,20)}}(o);e[a.LIGHTCOUNT]=function(e,t){e.uniform1i(t.lights.length)},e[a.CAMERA]=function(e,t){e.uniform3f(0,0,0)},e[a.CAMERA_TRANSLATION]=function(e,t){var n=t.camera.translation;e.uniform3f(n.data[0],n.data[1],n.data[2])},e[a.CAMERA_FOV]=function(e,t){e.uniform1f(t.camera.fov)},e[a.NEAR_PLANE]=function(e,t){e.uniform1f(t.camera.near)},e[a.FAR_PLANE]=function(e,t){e.uniform1f(t.camera.far)},e[a.MAIN_NEAR_PLANE]=function(e,t){e.uniform1f(t.mainCamera.near)},e[a.MAIN_FAR_PLANE]=function(e,t){e.uniform1f(t.mainCamera.far)},e[a.MAIN_DEPTH_SCALE]=function(e,t){e.uniform1f(1/(t.mainCamera.far-t.mainCamera.near))},e[a.AMBIENT]=function(e,t){var n=t.material.materialState!==undefined?t.material.materialState.ambient:a.DEFAULT_AMBIENT;e.uniform4fv(n)},e[a.EMISSIVE]=function(e,t){var n=t.material.materialState!==undefined?t.material.materialState.emissive:a.DEFAULT_EMISSIVE;e.uniform4fv(n)},e[a.DIFFUSE]=function(e,t){var n=t.material.materialState!==undefined?t.material.materialState.diffuse:a.DEFAULT_DIFFUSE;e.uniform4fv(n)},e[a.SPECULAR]=function(e,t){var n=a.DEFAULT_SPECULAR;t.material.materialState!==undefined&&(n=t.material.materialState.specular,n[3]=Math.max(t.material.materialState.shininess,1)),e.uniform4fv(n)},e[a.SPECULAR_POWER]=function(e,t){var n=t.material.materialState!==undefined?t.material.materialState.shininess:a.DEFAULT_SHININESS;n=Math.max(n,1),e.uniform1f(n)},e[a.TIME]=function(e){e.uniform1f(r.time)},e[a.TPF]=function(e){e.uniform1f(r.tpf)},e[a.RESOLUTION]=function(e,t){e.uniform2f(t.renderer.viewportWidth,t.renderer.viewportHeight)}}var u=window.WebGLRenderingContext;a.cache=new Map,a.prototype.clone=function(){return new a(this.name,s.deepClone({precision:this.precision,processors:this.processors,builder:this.builder,defines:this.defines,attributes:this.attributes,uniforms:this.uniforms,vshader:this.origVertexSource,fshader:this.origFragmentSource,defineKey:this.defineKey}))},a.prototype.cloneOriginal=function(){return new a(this.name,this.originalShaderDefinition)},a.prototype.precompile=function(e){this.shaderProgram===null&&(this._investigateShaders(),this.addDefines(this.defines),this.addPrecision(this.overridePrecision||e.shaderPrecision),this.compile(e))};var f=/\b(attribute|uniform)\s+(float|int|bool|vec2|vec3|vec4|mat2|mat3|mat4|sampler2D|sampler3D|samplerCube)\s+(\w+)(\s*\[\s*\w+\s*\])*;/g;a.prototype.compileProgram=function(e){this.shaderProgram===null&&(this._investigateShaders(),this.addDefines(this.defines),this.addPrecision(this.overridePrecision||e.shaderPrecision),this.compile(e))},a.prototype.activateProgram=function(e,t){if(e.usedProgram!==this.shaderProgram)return t.useProgram(this.shaderProgram),e.usedProgram=this.shaderProgram,!0},a.prototype.bindAttributeKey=function(e,t,n,r){var i=n[this.attributes[r]];if(!i)return;var s=this.attributeIndexMapping[r];if(s===undefined)return;e.newlyEnabledAttributes[s]=!0,t.bindVertexAttribute(s,i)},a.prototype.bindAttributes=function(e,t,n){if(this.attributes)for(var r=0,i=this.attributeKeys.length;r<i;r++)this.bindAttributeKey(e,t,n,this.attributeKeys[r])},a.prototype.disableAttributes=function(e,t){for(var n=0,r=e.enabledAttributes.length;n<r;n++){var i=e.enabledAttributes[n],s=e.newlyEnabledAttributes[n];!s&&i&&(t.disableVertexAttribArray(n),e.enabledAttributes[n]=!1)}},a.prototype.enableAttributes=function(e,t){for(var n=0,r=e.newlyEnabledAttributes.length;n<r;n++){var i=e.enabledAttributes[n],s=e.newlyEnabledAttributes[n];s&&!i&&(t.enableVertexAttribArray(n),e.enabledAttributes[n]=!0)}},a.prototype.matchUniforms=function(e){var t=this.matchedUniforms;if(t){this.textureIndex=0;for(var n=0,r=t.length;n<r;n++)this._bindUniform(t[n],e)}},a.prototype.apply=function(e,t){var n=t.context,r=t.rendererRecord;this.compileProgram(t),this.activateProgram(r,n),r.newlyEnabledAttributes.length=0,this.bindAttributes(r,t,e.meshData.attributeMap),this.disableAttributes(r,n),this.enableAttributes(r,n),this.matchUniforms(e)},a.prototype.defineValue=function(e,t){var n=e.material.uniforms[t];return n===undefined&&(n=this.uniforms[t]),n},a.prototype.mapSlot=function(e,t,n){var r=e.material.getTexture(n.mapping);r instanceof Array?this.arrayType(t,n,r):(n.index=this.textureIndex,t.call(this.textureIndex++))},a.prototype.arrayType=function(e,t,n){var r=[];t.index=[];for(var i=0;i<n.length;i++)t.index.push(this.textureIndex),r.push(this.textureIndex++);e.call(r)},a.prototype.stringType=function(e,t,n){var r=this.currentCallbacks[t];if(r)r(n,e);else{var i=this.textureSlotsNaming[t];i!==undefined&&this.mapSlot(e,n,i)}},a.prototype.callMapping=function(e,t,n){var r=this.defineValue(e,t),i=typeof r;if(i==="string")this.stringType(e,t,n,r);else{var s=i==="function"?r(e):r;n.call(s)}},a.prototype._bindUniform=function(e,t){var n=this.uniformCallMapping[e];if(n===undefined)return;this.callMapping(t,e,n)},a.prototype.setDefine=function(e,t){this.defineKeyDirty=this.defineKeyDirty||this.defines[e]!==t,this.defines[e]=t},a.prototype.removeDefine=function(e){this.defineKeyDirty=this.defineKeyDirty||this.defines[e]!==undefined,this.defines[e]=undefined},a.prototype.hasDefine=function(e){return this.defines[e]!==!1&&this.defines[e]!==undefined},a.prototype.startFrame=function(){this.frameStart=!0},a.prototype.endFrame=function(){this.frameStart=!1},a.prototype.updateProcessors=function(e){if(this.processors)for(var t=0;t<this.processors.length;t++)this.processors[t](this,e)},a.prototype.getDefineKey=function(e){if(this.defineKeyDirty){var t="Key:"+this.name,n=Object.keys(this.defines);for(var r=0,i=n.length;r<i;r++){var s=n[r],o=this.defines[s];if(o===undefined||o===!1)continue;var u=e.indexOf(s);u===-1&&(e.push(s),u=e.length),t+="_"+u+":"+o}this.defineKey=t,this.defineKeyDirty=!1}return this.defineKey},a.prototype.rebuild=function(){this.shaderProgram=null,this.attributeMapping={},this.attributeIndexMapping={},this.uniformMapping={},this.uniformCallMapping={},this.currentCallbacks={},this.attributeKeys=null,this.vertexSource=typeof this.origVertexSource=="function"?this.origVertexSource():this.origVertexSource,this.fragmentSource=typeof this.origFragmentSource=="function"?this.origFragmentSource():this.origFragmentSource,this.defineKeyDirty=!0},a.prototype._investigateShaders=function(){this.textureSlots=[],this.textureSlotsNaming={},a.investigateShader(this.vertexSource,this),a.investigateShader(this.fragmentSource,this)},a.investigateShader=function(e,t){f.lastIndex=0;var n=f.exec(e);while(n!==null){var r={format:n[2]},i=n[1],s=n[3],o=n[4];o&&(r.format==="float"?r.format="floatarray":r.format==="int"?r.format="intarray":r.format.indexOf("sampler")===0&&(r.format="samplerArray"));if("attribute"===i)t.attributeMapping[s]=r;else{if(r.format.indexOf("sampler")===0){var u={format:r.format,name:s,mapping:t.uniforms[s],index:t.textureSlots.length};t.textureSlots.push(u),t.textureSlotsNaming[u.name]=u}t.uniformMapping[s]=r}n=f.exec(e)}},a.prototype.compile=function(t){var n=t.context;this.renderer=t,this.vertexShader=this._getShader(n,u.VERTEX_SHADER,this.vertexSource),this.fragmentShader=this._getShader(n,u.FRAGMENT_SHADER,this.fragmentSource),(this.vertexShader===null||this.fragmentShader===null)&&console.error("Shader error - no shaders"),this.shaderProgram=n.createProgram();var r=n.getError();if(this.shaderProgram===null||r!==u.NO_ERROR)console.error("Shader error: "+r+" [shader: "+this.name+"]"),o.emit("goo.shader.error");n.attachShader(this.shaderProgram,this.vertexShader),n.attachShader(this.shaderProgram,this.fragmentShader),n.linkProgram(this.shaderProgram);if(!n.getProgramParameter(this.shaderProgram,u.LINK_STATUS)){var i=n.getProgramInfoLog(this.shaderProgram);console.error("Could not initialise shaders: "+i),o.emit("goo.shader.error",i)}for(var s in this.attributeMapping){var a=n.getAttribLocation(this.shaderProgram,s);if(a===-1)continue;this.attributeIndexMapping[s]=a}for(var s in this.uniformMapping){var f=n.getUniformLocation(this.shaderProgram,s);if(f===null){var l=this.textureSlots.length;for(var c=0;c<l;c++){var h=this.textureSlots[c];if(h.name===s){this.textureSlots.splice(c,1),delete this.textureSlotsNaming[h.name];for(;c<l-1;c++)this.textureSlots[c].index--;break}}continue}this.uniformCallMapping[s]=new e(n,f,this.uniformMapping[s].format)}this.attributes&&(this.attributeKeys=Object.keys(this.attributes));if(this.uniforms){if(this.uniforms.$link){var p=this.uniforms.$link instanceof Array?this.uniforms.$link:[this.uniforms.$link];for(var c=0;c<p.length;c++){var d=p[c];for(var s in d)this.uniforms[s]=d[s]}delete this.uniforms.$link}this.matchedUniforms=[];for(var v in this.uniforms){var m=this.uniformCallMapping[v];m!==undefined&&this.matchedUniforms.push(v);var g=this.uniforms[v];this.defaultCallbacks[g]&&(this.currentCallbacks[v]=this.defaultCallbacks[g])}}};var l=/\b\d+:(\d+):\s(.+)\b/g,c=/\((\d+),\s*\d+\):\s(.+)/g;a.prototype._getShader=function(e,t,n){var r=e.createShader(t);e.shaderSource(r,n),e.compileShader(r);if(!e.getShaderParameter(r,u.COMPILE_STATUS)){var i=e.getShaderInfoLog(r),s=t===u.VERTEX_SHADER?"VertexShader":"FragmentShader";l.lastIndex=0;var o=l.exec(i);o===null&&(o=c.exec(i));if(o!==null)while(o!==null){var a=n.split("\n"),f=o[1],h=o[2];console.error("Error in "+s+" - ["+this.name+"]["+this._id+"] at line "+f+":"),console.error("	Error: "+h),console.error("	Source: "+a[f-1]),o=l.exec(i)}else console.error("Error in "+s+" - ["+this.name+"]["+this._id+"] "+i);return null}return r};var h=/\bprecision\s+(lowp|mediump|highp)\s+(float|int);/g;a.prototype.addPrecision=function(e){h.lastIndex=0;var t=h.exec(this.vertexSource);t===null&&(this.vertexSource="precision "+e+" float;"+"\n"+this.vertexSource),h.lastIndex=0;var n=h.exec(this.fragmentSource);n===null&&(this.fragmentSource="precision "+e+" float;"+"\n"+this.fragmentSource)},a.prototype.addDefines=function(e){if(!e)return;var t=this.generateDefines(e);this.vertexSource=t+"\n"+this.vertexSource,this.fragmentSource=t+"\n"+this.fragmentSource},a.prototype.generateDefines=function(e){var t=[];for(var n in e){var r=e[n];if(r===!1||r===undefined)continue;var i="#define "+n+" "+r;t.push(i)}return t.join("\n")},a.prototype.getShaderDefinition=function(){return{vshader:this.vertexSource,fshader:this.fragmentSource,defines:this.defines,attributes:this.attributes,uniforms:this.uniforms}},a.prototype.destroy=function(){this.shaderProgram&&(this.renderer.context.deleteProgram(this.shaderProgram),this.shaderProgram=null),this.vertexShader&&(this.renderer.context.deleteShader(this.vertexShader),this.vertexShader=null),this.fragmentShader&&(this.renderer.context.deleteShader(this.fragmentShader),this.fragmentShader=null),this.renderer=null},a.prototype.toString=function(){return this.name},a.PROJECTION_MATRIX="PROJECTION_MATRIX",a.VIEW_MATRIX="VIEW_MATRIX",a.VIEW_INVERSE_MATRIX="VIEW_INVERSE_MATRIX",a.VIEW_PROJECTION_MATRIX="VIEW_PROJECTION_MATRIX",a.VIEW_PROJECTION_INVERSE_MATRIX="VIEW_PROJECTION_INVERSE_MATRIX",a.WORLD_MATRIX="WORLD_MATRIX",a.NORMAL_MATRIX="NORMAL_MATRIX";for(var d=0;d<8;d++)a["LIGHT"+d]="LIGHT"+d;return a.CAMERA="CAMERA",a.CAMERA_TRANSLATION="CAMERA_TRANSLATION",a.CAMERA_FOV="CAMERA_FOV",a.AMBIENT="AMBIENT",a.EMISSIVE="EMISSIVE",a.DIFFUSE="DIFFUSE",a.SPECULAR="SPECULAR",a.SPECULAR_POWER="SPECULAR_POWER",a.NEAR_PLANE="NEAR_PLANE",a.FAR_PLANE="FAR_PLANE",a.MAIN_NEAR_PLANE="NEAR_PLANE",a.MAIN_FAR_PLANE="FAR_PLANE",a.MAIN_DEPTH_SCALE="DEPTH_SCALE",a.TIME="TIME",a.TPF="TPF",a.RESOLUTION="RESOLUTION",a.DIFFUSE_MAP="DIFFUSE_MAP",a.NORMAL_MAP="NORMAL_MAP",a.SPECULAR_MAP="SPECULAR_MAP",a.LIGHT_MAP="LIGHT_MAP",a.SHADOW_MAP="SHADOW_MAP",a.AO_MAP="AO_MAP",a.EMISSIVE_MAP="EMISSIVE_MAP",a.DEPTH_MAP="DEPTH_MAP",a.DEFAULT_AMBIENT=[.1,.1,.1,1],a.DEFAULT_EMISSIVE=[0,0,0,0],a.DEFAULT_DIFFUSE=[.8,.8,.8,1],a.DEFAULT_SPECULAR=[.6,.6,.6,64],a.DEFAULT_SHININESS=64,a.prototype.defaultCallbacks={},p(a.prototype.defaultCallbacks),a}),define("goo/renderer/Material",["goo/renderer/Shader","goo/util/ObjectUtil"],function(e,t){function n(e,t){this.id=null,this.name="Default Material",this.shader=null,typeof arguments[0]=="string"?this.name=arguments[0]:arguments[0]&&arguments[0].vshader&&arguments[0].fshader&&(this.shader=n.createShader(arguments[0])),arguments[1]&&arguments[1].vshader&&arguments[1].fshader?this.shader=n.createShader(arguments[1]):typeof arguments[1]=="string"&&(this.name=arguments[1]),this.uniforms={},this._textureMaps={},this.cullState={enabled:!0,cullFace:"Back",frontFace:"CCW"},this.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},this.depthState={enabled:!0,write:!0},this.offsetState={enabled:!1,factor:1,units:1},this.dualTransparency=!1,this.wireframe=!1,this.flat=!1,this.renderQueue=null,this.fullOverride=!1,this.errorOnce=!1,Object.seal(this)}return n.prototype.setTexture=function(e,t){this._textureMaps[e]=t},n.prototype.getTexture=function(e){return this._textureMaps[e]},n.prototype.removeTexture=function(e){delete this._textureMaps[e]},n.prototype.getTextures=function(){var e=[];for(var t in this._textureMaps)e.push(this._textureMaps[t]);return e},n.prototype.getTextureEntries=function(){return this._textureMaps},n.prototype.getRenderQueue=function(){return this.renderQueue!==null?this.renderQueue:this.shader!==null?this.shader.renderQueue:1e3},n.prototype.setRenderQueue=function(e){this.renderQueue=e},n.prototype.clone=function(e){e=e||{};var r=new n(this.name);r.id=this.id,r.name=this.name,r.shader=this.shader.clone(),e.shareUniforms?r.uniforms=this.uniforms:r.uniforms=t.clone(this.uniforms);if(e.shareTextures){var i=Object.keys(this._textureMaps);for(var s=0;s<i.length;s++){var o=i[s];r._textureMaps[o]=this._textureMaps[o]}}else{var i=Object.keys(this._textureMaps);for(var s=0;s<i.length;s++){var o=i[s];r._textureMaps[o]=this._textureMaps[o].clone()}}return r.cullState.enabled=this.cullState.enabled,r.cullState.cullFace=this.cullState.cullFace,r.cullState.frontFace=this.cullState.frontFace,r.blendState.blending=this.blendState.blending,r.blendState.blendEquation=this.blendState.blendEquation,r.blendState.blendSrc=this.blendState.blendSrc,r.blendState.blendDst=this.blendState.blendDst,r.depthState.enabled=this.depthState.enabled,r.depthState.write=this.depthState.write,r.offsetState.enabled=this.offsetState.enabled,r.offsetState.factor=this.offsetState.factor,r.offsetState.units=this.offsetState.units,r.dualTransparency=this.dualTransparency,r.wireframe=this.wireframe,r.flat=this.flat,r.renderQueue=this.renderQueue,r.fullOverride=this.fullOverride,r.errorOnce=this.errorOnce,r},n.createShader=function(t,n){var r=new e(n||null,t);return r.name===null&&(r.name="DefaultShader"+r._id),r},n.clearShaderCache=function(){},n.createEmptyMaterial=function(e,t){var r=new n(t||"Empty Material");return r.empty(),e?r.shader=n.createShader(e):r.shader=undefined,r},n.prototype.empty=function(){this.cullState={},this.blendState={},this.depthState={},this.offsetState={},this.wireframe=undefined,this.renderQueue=undefined,this.flat=undefined,this._textureMaps={},this.shader=undefined,this.uniforms={}},n}),define("goo/renderer/shaders/ShaderFragment",[],function(){function e(){}e.noisecommon=["vec4 mod289(vec4 x) {","return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 mod289(vec3 x) {","return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","return mod289(((x*34.0)+1.0)*x);","}","vec4 permute(vec4 x) {","return mod289(((x*34.0)+1.0)*x);","}"].join("\n"),e.noise2d=[e.noisecommon,"float snoise(vec2 v) {","const vec4 C = vec4(0.211324865405187,  (3.0-sqrt(3.0))/6.0","0.366025403784439,  0.5*(sqrt(3.0)-1.0)","-0.577350269189626,  -1.0 + 2.0 * C.x","0.024390243902439); 1.0 / 41.0","vec2 i  = floor(v + dot(v, C.yy) );","vec2 x0 = v -   i + dot(i, C.xx);","vec2 i1;","//i1.x = step( x0.y, x0.x ); x0.x > x0.y ? 1.0 : 0.0","//i1.y = 1.0 - i1.x;","i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);","// x0 = x0 - 0.0 + 0.0 * C.xx ;","// x1 = x0 - i1 + 1.0 * C.xx ;","// x2 = x0 - 1.0 + 2.0 * C.xx ;","vec4 x12 = x0.xyxy + C.xxzz;","x12.xy -= i1;","i = mod289(i); Avoid truncation effects in permutation","vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))","+ i.x + vec3(0.0, i1.x, 1.0 ));","vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);","m = m*m ;","m = m*m ;","vec3 x = 2.0 * fract(p * C.www) - 1.0;","vec3 h = abs(x) - 0.5;","vec3 ox = floor(x + 0.5);","vec3 a0 = x - ox;","m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );","vec3 g;","g.x  = a0.x  * x0.x  + h.x  * x0.y;","g.yz = a0.yz * x12.xz + h.yz * x12.yw;","return 130.0 * dot(m, g);","}"].join("\n"),e.noise3d=[e.noisecommon,"vec4 taylorInvSqrt(vec4 r) {","return 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;","const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);","vec3 i  = floor(v + dot(v, C.yyy) );","vec3 x0 =   v - i + dot(i, C.xxx) ;","vec3 g = step(x0.yzx, x0.xyz);","vec3 l = 1.0 - g;","vec3 i1 = min( g.xyz, l.zxy );","vec3 i2 = max( g.xyz, l.zxy );","vec3 x1 = x0 - i1 + C.xxx;","vec3 x2 = x0 - i2 + C.yyy; 2.0*C.x = 1/3 = C.y","vec3 x3 = x0 - D.yyy;      -1.0+3.0*C.x = -0.5 = -D.y","i = mod289(i); ","vec4 p = permute( permute( permute( ","i.z + vec4(0.0, i1.z, i2.z, 1.0 ))","+ i.y + vec4(0.0, i1.y, i2.y, 1.0 )) ","+ i.x + vec4(0.0, i1.x, i2.x, 1.0 ));","float n_ = 0.142857142857; 1.0/7.0","vec3  ns = n_ * D.wyz - D.xzx;","vec4 j = p - 49.0 * floor(p * ns.z * ns.z);   mod(p,7*7)","vec4 x_ = floor(j * ns.z);","vec4 y_ = floor(j - 7.0 * x_ );    mod(j,N)","vec4 x = x_ *ns.x + ns.yyyy;","vec4 y = y_ *ns.x + ns.yyyy;","vec4 h = 1.0 - abs(x) - abs(y);","vec4 b0 = vec4( x.xy, y.xy );","vec4 b1 = vec4( x.zw, y.zw );","vec4 s0 = floor(b0)*2.0 + 1.0;","vec4 s1 = floor(b1)*2.0 + 1.0;","vec4 sh = -step(h, vec4(0.0));","vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;","vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;","vec3 p0 = vec3(a0.xy,h.x);","vec3 p1 = vec3(a0.zw,h.y);","vec3 p2 = vec3(a1.xy,h.z);","vec3 p3 = vec3(a1.zw,h.w);","vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));","p0 *= norm.x;","p1 *= norm.y;","p2 *= norm.z;","p3 *= norm.w;","vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);","m = m * m;","return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );","}"].join("\n");var t=["float shift_right (float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left (float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last (float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits (float num, float from, float to) {","from = floor(from + 0.5); to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}"].join("\n");return e.methods={packDepth:["vec4 packDepth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}"].join("\n"),unpackDepth:["float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}"].join("\n"),packFloat:[t,"vec4 packFloat (float val) {","if (val == 0.0) return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}"].join("\n"),unpackFloat:[t,"float unpackFloat (vec4 val) {","val = val * vec4(255.0);","float sign = - shift_right(val.w, 7.0) * 2.0 + 1.0;","float mantissa = ","val.x +","shift_left(val.y, 8.0) +","shift_left(extract_bits(val.z, 0.0, 7.0), 16.0);"," mantissa = mantissa / 8388608.0 + 1.0;","float exponent = ","shift_left(extract_bits(val.w, 0.0, 7.0), 1.0) +","shift_right(val.z, 7.0) - 127.0;","return sign * mantissa * exp2(exponent);","}"].join("\n"),packDepth16:["vec2 packDepth16( const in float depth ) {","const vec2 bias = vec2(1.0 / 255.0, 0.0);","vec2 res = vec2(depth, fract(depth * 255.0));","return res - (res.yy * bias);","}"].join("\n"),unpackDepth16:["float unpackDepth16( const in vec2 rg_depth ) {","return rg_depth.x + (rg_depth.y / 255.0);","}"].join("\n"),hsv:["vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c){","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}"].join("\n")},e.blendmodes=["#define BlendLinearDodgef				BlendAddf","#define BlendLinearBurnf				BlendSubstractf","#define BlendAddf(base, blend)			min(base + blend, 1.0)","#define BlendSubstractf(base, blend)	max(base + blend - 1.0, 0.0)","#define BlendLightenf(base, blend)		max(blend, base)","#define BlendDarkenf(base, blend)		min(blend, base)","#define BlendLinearLightf(base, blend)	(blend < 0.5 ? BlendLinearBurnf(base, (2.0 * blend)) : BlendLinearDodgef(base, (2.0 * (blend - 0.5))))","#define BlendScreenf(base, blend)		(1.0 - ((1.0 - base) * (1.0 - blend)))","#define BlendOverlayf(base, blend)		(base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))","#define BlendSoftLightf(base, blend)	((blend < 0.5) ? (2.0 * base * blend + base * base * (1.0 - 2.0 * blend)) : (sqrt(base) * (2.0 * blend - 1.0) + 2.0 * base * (1.0 - blend)))","#define BlendColorDodgef(base, blend)	((blend == 1.0) ? blend : min(base / (1.0 - blend), 1.0))","#define BlendColorBurnf(base, blend)	((blend == 0.0) ? blend : max((1.0 - ((1.0 - base) / blend)), 0.0))","#define BlendVividLightf(base, blend)	((blend < 0.5) ? BlendColorBurnf(base, (2.0 * blend)) : BlendColorDodgef(base, (2.0 * (blend - 0.5))))","#define BlendPinLightf(base, blend)	((blend < 0.5) ? BlendDarkenf(base, (2.0 * blend)) : BlendLightenf(base, (2.0 *(blend - 0.5))))","#define BlendHardMixf(base, blend)		((BlendVividLightf(base, blend) < 0.5) ? 0.0 : 1.0)","#define BlendReflectf(base, blend)		((blend == 1.0) ? blend : min(base * base / (1.0 - blend), 1.0))","#define Blend(base, blend, funcf)		vec3(funcf(base.r, blend.r), funcf(base.g, blend.g), funcf(base.b, blend.b))","#define BlendNormal(base, blend)		(blend)","#define BlendLighten					BlendLightenf","#define BlendDarken					BlendDarkenf","#define BlendMultiply(base, blend)		(base * blend)","#define BlendAverage(base, blend)		((base + blend) / 2.0)","#define BlendAdd(base, blend)			min(base + blend, vec3(1.0))","#define BlendSubstract(base, blend)	max(base + blend - vec3(1.0), vec3(0.0))","#define BlendDifference(base, blend)	abs(base - blend)","#define BlendNegation(base, blend)		(vec3(1.0) - abs(vec3(1.0) - base - blend))","#define BlendExclusion(base, blend)	(base + blend - 2.0 * base * blend)","#define BlendScreen(base, blend)		Blend(base, blend, BlendScreenf)","#define BlendOverlay(base, blend)		Blend(base, blend, BlendOverlayf)","#define BlendSoftLight(base, blend)	Blend(base, blend, BlendSoftLightf)","#define BlendHardLight(base, blend)	BlendOverlay(blend, base)","#define BlendColorDodge(base, blend)	Blend(base, blend, BlendColorDodgef)","#define BlendColorBurn(base, blend)	Blend(base, blend, BlendColorBurnf)","#define BlendLinearDodge				BlendAdd","#define BlendLinearBurn				BlendSubstract","#define BlendLinearLight(base, blend)	Blend(base, blend, BlendLinearLightf)","#define BlendVividLight(base, blend)	Blend(base, blend, BlendVividLightf)","#define BlendPinLight(base, blend)		Blend(base, blend, BlendPinLightf)","#define BlendHardMix(base, blend)		Blend(base, blend, BlendHardMixf)","#define BlendReflect(base, blend)		Blend(base, blend, BlendReflectf)","#define BlendGlow(base, blend)			BlendReflect(blend, base)","#define BlendPhoenix(base, blend)		(min(base, blend) - max(base, blend) + vec3(1.0))","#define GammaCorrection(color, gamma)											pow(color, vec3(1.0 / gamma))","#define LevelsControlInputRange(color, minInput, maxInput)						min(max(color - vec3(minInput), vec3(0.0)) / (vec3(maxInput) - vec3(minInput)), vec3(1.0))","#define LevelsControlInput(color, minInput, gamma, maxInput)					GammaCorrection(LevelsControlInputRange(color, minInput, maxInput), gamma)","#define LevelsControlOutputRange(color, minOutput, maxOutput)					mix(vec3(minOutput), vec3(maxOutput), color)","#define LevelsControl(color, minInput, gamma, maxInput, minOutput, maxOutput)	LevelsControlOutputRange(LevelsControlInput(color, minInput, gamma, maxInput), minOutput, maxOutput)"].join("\n"),e}),define("goo/util/TangentGenerator",["goo/math/Vector2","goo/math/Vector3","goo/renderer/MeshData"],function(e,t,n){function r(){}return r.addTangentBuffer=function(r,i){function d(t){var n=[];for(var r=0;r<t.length;r+=2)n.push(new e(t[r+0],t[r+1]));return n}function v(e){var n=[];for(var r=0;r<e.length;r+=3)n.push(new t(e[r+0],e[r+1],e[r+2]));return n}i=i||0;var s=r.getAttributeBuffer(n.POSITION);if(!s)return;var o=r.getAttributeBuffer(n.NORMAL);if(!o)return;var u=r.getAttributeBuffer("TEXCOORD"+i);!u&&i!==0&&(u=r.getAttributeBuffer(n.TEXCOORD0));if(!u)return;var a=r.getIndexBuffer();if(!a)return;var f=r.vertexCount,l=r.indexCount/3,c=[],h=[];for(var p=0;p<f;p++)c[p]=new t,h[p]=new t;var m=v(s),g=v(o),y=d(u);for(var b=0;b<l;b++){var w=a[b*3],E=a[b*3+1],S=a[b*3+2],x=m[w],T=m[E],N=m[S],C=y[w],k=y[E],L=y[S],A=T.x-x.x,O=N.x-x.x,M=T.y-x.y,_=N.y-x.y,D=T.z-x.z,P=N.z-x.z,H=k.x-C.x,B=L.x-C.x,j=k.y-C.y,F=L.y-C.y,I=1/(H*F-B*j);if(isFinite(I)===!1)continue;var q=new t((F*A-j*O)*I,(F*M-j*_)*I,(F*D-j*P)*I),R=new t((H*O-B*A)*I,(H*_-B*M)*I,(H*P-B*D)*I);c[w].add(q),c[E].add(q),c[S].add(q),h[w].add(R),h[E].add(R),h[S].add(R)}r.attributeMap[n.TANGENT]=n.createAttribute(4,"Float"),r.rebuildData(r.vertexCount,r.indexCount,!0);var U=r.getAttributeBuffer(n.TANGENT),z=new t,W=new t;for(var b=0;b<f;b++){var X=g[b],V=c[b],$=X.dot(V);z.copy(V).sub(W.copy(X).mul($)).normalize(),U[b*4+0]=z.x,U[b*4+1]=z.y,U[b*4+2]=z.z,$=z.copy(X).cross(V).dot(h[b]);var J=$<0?-1:1;U[b*4+3]=J}return U},r}),define("goo/renderer/shaders/ShaderBuilder",["goo/renderer/MeshData","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight","goo/renderer/Texture","goo/math/MathUtils","goo/util/TangentGenerator"],function(e,t,n,r,i,s,o){function u(){}var a=new n;a.translation.setDirect(10,10,10),a.direction.setDirect(1,1,1).normalize(),u.defaultLight=a,u.SKYBOX=null,u.SKYSPHERE=null,u.ENVIRONMENT_TYPE=0,u.GLOBAL_AMBIENT=[0,0,0],u.CLEAR_COLOR=[.3,.3,.3,1],u.USE_FOG=!1,u.FOG_SETTINGS=[0,1e4],u.FOG_COLOR=[1,1,1],u.uber={defines:function(e,t){var n=Object.keys(t);for(var r=0,i=n.length;r<i;r++)e.setDefine(n[r],!0)},txMaps:function(e,t){var n=Object.keys(t);for(var r=0,i=n.length;r<i;r++){var s=n[r];if(t[s]===undefined||t[s]===null)continue;if(s==="SHADOW_MAP")continue;e.setDefine(s,!0)}},reflectivity:function(e,t){t.uniforms.reflectivity||t.uniforms.refractivity?e.setDefine("REFLECTIVE",!0):e.removeDefine("REFLECTIVE"),e.setDefine("REFLECTION_TYPE",t.uniforms.reflectionType!==undefined?t.uniforms.reflectionType:0)},sky:function(e,t){t.getTexture("LOCAL_ENVIRONMENT")?(t.setTexture("ENVIRONMENT_SPHERE",t.getTexture("LOCAL_ENVIRONMENT")),e.setDefine("ENVIRONMENT_TYPE",0),t.getTexture("ENVIRONMENT_CUBE")&&t.removeTexture("ENVIRONMENT_CUBE")):(u.SKYBOX&&(t.uniforms.reflectivity||t.uniforms.refractivity)?t.setTexture("ENVIRONMENT_CUBE",u.SKYBOX):t.getTexture("ENVIRONMENT_CUBE")&&t.removeTexture("ENVIRONMENT_CUBE"),u.SKYSPHERE&&(t.uniforms.reflectivity||t.uniforms.refractivity)?(t.setTexture("ENVIRONMENT_SPHERE",u.SKYSPHERE),e.setDefine("ENVIRONMENT_TYPE",u.ENVIRONMENT_TYPE)):t.getTexture("ENVIRONMENT_SPHERE")&&t.removeTexture("ENVIRONMENT_SPHERE"))},uniforms:function(e,t){if(t.DIFFUSE_MAP){var n=t.DIFFUSE_MAP.offset,r=t.DIFFUSE_MAP.repeat;e.uniforms.offsetRepeat[0]=n.data[0],e.uniforms.offsetRepeat[1]=n.data[1],e.uniforms.offsetRepeat[2]=r.data[0],e.uniforms.offsetRepeat[3]=r.data[1],e.uniforms.lodBias=t.DIFFUSE_MAP.lodBias}else e.uniforms.offsetRepeat[0]=0,e.uniforms.offsetRepeat[1]=0,e.uniforms.offsetRepeat[2]=1,e.uniforms.offsetRepeat[3]=1,e.uniforms.lodBias=0},attributes:function(e,t,n){var r=Object.keys(e.defines);for(var i=0,s=r.length;i<s;i++){var o=r[i];if(o==="SHADOW_TYPE"||o==="JOINT_COUNT"||o==="WEIGHTS"||o==="PHYSICALLY_BASED_SHADING"||o==="ENVIRONMENT_TYPE"||o==="REFLECTIVE"||o==="DISCARD"||o==="OPACITY"||o==="FOG"||o==="REFLECTION_TYPE"||o==="SKIP_SPECULAR"||o==="LIGHT"||o==="COOKIE"||o==="TRANSPARENCY_BW"||o==="WRAP_AROUND")continue;!t[o]&&!n[o]&&e.removeDefine(o)}},discard:function(e,t){t.uniforms.discardThreshold>=0?e.setDefine("DISCARD",!0):e.removeDefine("DISCARD")},opacity:function(e,t){var n=t.uniforms.opacity;n!==undefined&&n<1?e.setDefine("OPACITY",!0):e.removeDefine("OPACITY"),t.uniforms.useBWTransparency===!0?e.setDefine("TRANSPARENCY_BW",!0):e.removeDefine("TRANSPARENCY_BW")},fog:function(e){u.USE_FOG?(e.setDefine("FOG",!0),e.uniforms.fogSettings=u.FOG_SETTINGS,e.uniforms.fogColor=u.FOG_COLOR):e.removeDefine("FOG")},normalTangents:function(t,n){t.hasDefine("NORMAL")&&t.hasDefine("NORMAL_MAP")&&!n.meshData.getAttributeBuffer(e.TANGENT)&&o.addTangentBuffer(n.meshData)},processor:function(e,t){var n=t.meshData.attributeMap,r=t.material,i=r._textureMaps;e.uniforms.clearColor=u.CLEAR_COLOR,u.uber.reflectivity(e,r),u.uber.sky(e,r),u.uber.defines(e,n),u.uber.txMaps(e,i),u.uber.uniforms(e,i),u.uber.attributes(e,n,i),u.uber.discard(e,r),u.uber.opacity(e,r),u.uber.fog(e),e.setDefine("SKIP_SPECULAR",!0),u.uber.normalTangents(e,t)}};var f=[];return u.light={pointLight:function(e,t,n){var r=t.pointLights=t.pointLights||[],i=n*8,s=e.translation.data;r[i+0]=s[0],r[i+1]=s[1],r[i+2]=s[2],r[i+3]=e.range;var o=e.color.data;r[i+4]=o[0]*e.intensity,r[i+5]=o[1]*e.intensity,r[i+6]=o[2]*e.intensity,r[i+7]=e.specularIntensity,f.push("P")},directionalLight:function(e,t,n){var r=t.directionalLights=t.directionalLights||[],i=n*8,s=e.direction.data;r[i+0]=s[0],r[i+1]=s[1],r[i+2]=s[2],r[i+3]=0;var o=e.color.data;r[i+4]=o[0]*e.intensity,r[i+5]=o[1]*e.intensity,r[i+6]=o[2]*e.intensity,r[i+7]=e.specularIntensity,f.push("D")},spotLight:function(e,t,n){var r=t.spotLights=t.spotLights||[],i=n*16;r[i+0]=e.translation.data[0],r[i+1]=e.translation.data[1],r[i+2]=e.translation.data[2],r[i+3]=e.range,r[i+4]=e.color.data[0]*e.intensity,r[i+5]=e.color.data[1]*e.intensity,r[i+6]=e.color.data[2]*e.intensity,r[i+7]=e.specularIntensity,r[i+8]=e.direction.data[0],r[i+9]=e.direction.data[1],r[i+10]=e.direction.data[2],r[i+11]=0,r[i+12]=Math.cos(e.angle*s.DEG_TO_RAD/2),r[i+13]=e.penumbra!==undefined?Math.sin(e.penumbra*s.DEG_TO_RAD/4):0,r[i+14]=0,r[i+15]=0,f.push("S")},shadows:function(e,t,n,r,s,o){var u=e.lightCookie instanceof i;if((u||e.shadowCaster&&s.renderable.meshRendererComponent&&s.renderable.meshRendererComponent.receiveShadows)&&e.shadowSettings.shadowData){var a=e.shadowSettings.shadowData;if(e.shadowCaster){t["shadowMaps"+n]="SHADOW_MAP"+n,s.material.setTexture("SHADOW_MAP"+n,a.shadowResult);var l=t.shadowData=t.shadowData||[],c=o*8,h=a.lightCamera.translation.data;l[c+0]=h[0],l[c+1]=h[1],l[c+2]=h[2],l[c+3]=0,l[c+4]=a.cameraScale,l[c+5]=e.shadowSettings.darkness,e.shadowSettings.shadowType==="PCF"?(l[c+6]=e.shadowSettings.resolution[0],l[c+7]=e.shadowSettings.resolution[1]):(l[c+6]=0,l[c+7]=0),o++,f.push("H",e.shadowSettings.shadowType==="PCF"?1:e.shadowSettings.shadowType==="VSM"?2:0)}u?(t["lightCookie"+n]="LIGHT_COOKIE"+n,s.material.setTexture("LIGHT_COOKIE"+n,e.lightCookie),f.push("C"),r.setDefine("COOKIE",!0)):r.removeDefine("COOKIE"),t["shadowLightMatrices"+n]=a.vpm}return o},processor:function(e,s){var o=e.uniforms;o.totalAmbient=o.totalAmbient||[.1,.1,.1],s.material.uniforms.totalAmbient=s.material.uniforms.totalAmbient||[.1,.1,.1];var a=s.material.uniforms.materialAmbient||o.materialAmbient||[.1,.1,.1,1],l=s.material.uniforms.totalAmbient;s.material.multiplyAmbient?(l[0]=a[0]*u.GLOBAL_AMBIENT[0],l[1]=a[1]*u.GLOBAL_AMBIENT[1],l[2]=a[2]*u.GLOBAL_AMBIENT[2]):(l[0]=a[0]+u.GLOBAL_AMBIENT[0],l[1]=a[1]+u.GLOBAL_AMBIENT[1],l[2]=a[2]+u.GLOBAL_AMBIENT[2]);if(!e.frameStart){var c=s.lights;for(var h=0;h<c.length;h++){var p=c[h],d=p.lightCookie instanceof i;if((d||p.shadowCaster&&s.renderable.meshRendererComponent&&s.renderable.meshRendererComponent.receiveShadows)&&p.shadowSettings.shadowData){var v=p.shadowSettings.shadowData;p.shadowCaster&&s.material.setTexture("SHADOW_MAP"+h,v.shadowResult),d&&s.material.setTexture("LIGHT_COOKIE"+h,p.lightCookie)}}return}o.materialEmissive=o.materialEmissive||"EMISSIVE",o.materialDiffuse=o.materialDiffuse||"DIFFUSE",o.materialSpecular=o.materialSpecular||"SPECULAR";var m=0,g=0,y=0,b=0,c=s.lights;if(c.length>0){for(var h=0;h<c.length;h++){var p=c[h];p instanceof t?(u.light.pointLight(p,o,m),m++):p instanceof n?(u.light.directionalLight(p,o,g),g++):p instanceof r&&(u.light.spotLight(p,o,y),y++),b=u.light.shadows(p,o,h,e,s,b)}var w=f.join("");e.setDefine("LIGHT",w),f.length=0}else e.removeDefine("LIGHT")},builder:function(e,s){var o=[],a=[],f=[],l=[];o.push("const mat4 ScaleMatrix = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),f.push("uniform vec3 totalAmbient;","uniform vec4 materialEmissive;","uniform vec4 materialDiffuse;","uniform vec4 materialSpecular;","uniform vec2 wrapSettings;","float ChebychevInequality(in vec2 moments, in float t) {","if ( t <= moments.x ) return 1.0;","float variance = moments.y - (moments.x * moments.x);","variance = max(variance, 0.02);","float d = t - moments.x;","return variance / (variance + d * d);","}"),l.push("#if defined(SPECULAR_MAP) && defined(TEXCOORD0)","float specularStrength = texture2D(specularMap, texCoord0).x;","#else","float specularStrength = 1.0;","#endif","vec3 totalDiffuse = vec3(0.0);","vec3 totalSpecular = vec3(0.0);");var c=s.lights;if(c.length>0){l.push("vec3 normalizedViewPosition = normalize(viewPosition);");var h=0,p=0,d=0,v=0;for(var m=0;m<c.length;m++){var g=c[m];g instanceof t?h++:g instanceof n?p++:g instanceof r&&d++;var y=g.lightCookie instanceof i;(y||g.shadowCaster&&s.renderable.meshRendererComponent&&s.renderable.meshRendererComponent.receiveShadows)&&v++}h>0&&f.push("uniform vec4 pointLights["+h*2+"];"),p>0&&f.push("uniform vec4 directionalLights["+p*2+"];"),d>0&&f.push("uniform vec4 spotLights["+d*4+"];"),v>0&&f.push("uniform vec4 shadowData["+v*2+"];"),h=0,p=0,d=0,v=0;for(var m=0;m<c.length;m++){var g=c[m];l.push("{","float shadow = 1.0;");var y=g.lightCookie instanceof i;if(y||g.shadowCaster&&s.renderable.meshRendererComponent&&s.renderable.meshRendererComponent.receiveShadows)o.push("uniform mat4 shadowLightMatrices"+m+";","varying vec4 shadowLightDepths"+m+";"),a.push("shadowLightDepths"+m+" = ScaleMatrix * shadowLightMatrices"+m+" * worldPos;"),g.shadowCaster&&(f.push("uniform sampler2D shadowMaps"+m+";"),l.push("vec3 shadowLightPositions"+m+" = shadowData["+(v*2+0)+"].xyz;","float cameraScales"+m+" = shadowData["+(v*2+1)+"].x;","float shadowDarkness"+m+" = shadowData["+(v*2+1)+"].y;")),y&&f.push("uniform sampler2D lightCookie"+m+";"),f.push("varying vec4 shadowLightDepths"+m+";"),g.shadowCaster&&g.shadowSettings.shadowType==="PCF"&&l.push("vec2 shadowMapSizes"+m+" = shadowData["+(v*2+1)+"].zw;"),l.push("vec3 depth = shadowLightDepths"+m+".xyz / shadowLightDepths"+m+".w;"),g.shadowCaster&&(v++,l.push("depth.z = length(vWorldPos.xyz - shadowLightPositions"+m+") * cameraScales"+m+";","if (depth.x >= 0.0 && depth.x <= 1.0 && depth.y >= 0.0 && depth.y <= 1.0 && shadowLightDepths"+m+".z >= 0.0 && depth.z <= 1.0) {"),g.shadowSettings.shadowType==="PCF"?l.push("depth.z *= 0.96;","float shadowPcf = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSizes"+m+".x;","float yPixelOffset = 1.0 / shadowMapSizes"+m+".y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","float fDepth = 0.0;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(dx0, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(0.0, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(dx1, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(dx0, 0.0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth =  texture2D(shadowMaps"+m+", depth.xy).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(dx1, 0.0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(dx0, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(0.0, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+m+", depth.xy + vec2(dx1, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","shadow = mix(1.0, 1.0 - shadowPcf, shadowDarkness"+m+");"):g.shadowSettings.shadowType==="VSM"?l.push("vec4 texel = texture2D(shadowMaps"+m+", depth.xy);","vec2 moments = vec2(texel.x, texel.y);","shadow = ChebychevInequality(moments, depth.z);","shadow = pow(shadow, shadowDarkness"+m+" * 8.0);"):l.push("depth.z *= 0.96;","float shadowDepth = texture2D(shadowMaps"+m+", depth.xy).x;","if ( depth.z > shadowDepth ) shadow = 1.0 - shadowDarkness"+m+";"),l.push("}","shadow = clamp(shadow, 0.0, 1.0);"));g instanceof t?(l.push("vec4 pointLight"+m+" = pointLights["+(h*2+0)+"];","vec4 pointLightColor"+m+" = pointLights["+(h*2+1)+"];"),l.push("vec3 lVector = normalize(pointLight"+m+".xyz - vWorldPos.xyz);","float lDistance = 1.0 - min((length(pointLight"+m+".xyz - vWorldPos.xyz) / pointLight"+m+".w), 1.0);","float dotProduct = dot(N, lVector);","float pointDiffuseWeightFull = max(dotProduct, 0.0);","float pointDiffuseWeightHalf = max(mix(dotProduct, 1.0, wrapSettings.x), 0.0);","vec3 pointDiffuseWeight = mix(vec3(pointDiffuseWeightFull), vec3(pointDiffuseWeightHalf), wrapSettings.y);","totalDiffuse += materialDiffuse.rgb * pointLightColor"+m+".rgb * pointDiffuseWeight * lDistance * shadow;","vec3 pointHalfVector = normalize(lVector + normalizedViewPosition);","float pointDotNormalHalf = max(dot(N, pointHalfVector), 0.0);","float pointSpecularWeight = pointLightColor"+m+".a * specularStrength * max(pow(pointDotNormalHalf, materialSpecular.a), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecular.a + 2.0001 ) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(lVector, pointHalfVector), 5.0);","totalSpecular += schlick * pointLightColor"+m+".rgb * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization * shadow;","#else","totalSpecular += materialSpecular.rgb * pointLightColor"+m+".rgb * pointSpecularWeight * pointDiffuseWeight * lDistance * shadow;","#endif"),h++):g instanceof n?(l.push("vec3 directionalLightDirection"+m+" = directionalLights["+(p*2+0)+"].xyz;","vec4 directionalLightColor"+m+" = directionalLights["+(p*2+1)+"];"),l.push("vec3 dirVector = normalize(-directionalLightDirection"+m+");","float dotProduct = dot(N, dirVector);","float dirDiffuseWeightFull = max(dotProduct, 0.0);","float dirDiffuseWeightHalf = max(mix(dotProduct, 1.0, wrapSettings.x), 0.0);","vec3 dirDiffuseWeight = mix(vec3(dirDiffuseWeightFull), vec3(dirDiffuseWeightHalf), wrapSettings.y);","vec3 cookie = vec3(1.0);"),y&&l.push("vec4 cookieTex = texture2D(lightCookie"+m+", depth.xy);","cookie = cookieTex.rgb * cookieTex.a;"),l.push("totalDiffuse += materialDiffuse.rgb * directionalLightColor"+m+".rgb * dirDiffuseWeight * shadow * cookie;","vec3 dirHalfVector = normalize(dirVector + normalizedViewPosition);","float dirDotNormalHalf = max(dot(N, dirHalfVector), 0.0);","float dirSpecularWeight = directionalLightColor"+m+".a * specularStrength * max(pow(dirDotNormalHalf, materialSpecular.a), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecular.a + 2.0001) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(dirVector, dirHalfVector), 5.0);","totalSpecular += schlick * directionalLightColor"+m+".rgb * dirSpecularWeight * dirDiffuseWeight * specularNormalization * shadow * cookie;","#else","totalSpecular += materialSpecular.rgb * directionalLightColor"+m+".rgb * dirSpecularWeight * dirDiffuseWeight * shadow * cookie;","#endif"),p++):g instanceof r&&(l.push("vec4 spotLight"+m+" = spotLights["+(d*4+0)+"];","vec4 spotLightColor"+m+" = spotLights["+(d*4+1)+"];","vec3 spotLightDirection"+m+" = spotLights["+(d*4+2)+"].xyz;","float spotLightAngle"+m+" = spotLights["+(d*4+3)+"].x;","float spotLightPenumbra"+m+" = spotLights["+(d*4+3)+"].y;"),l.push("vec3 lVector = normalize(spotLight"+m+".xyz - vWorldPos.xyz);","float lDistance = 1.0 - min((length(spotLight"+m+".xyz - vWorldPos.xyz) / spotLight"+m+".w), 1.0);","float spotEffect = dot(normalize(-spotLightDirection"+m+"), lVector);","if (spotEffect > spotLightAngle"+m+") {","if (spotLightPenumbra"+m+" > 0.0) {","spotEffect = (spotEffect - spotLightAngle"+m+") / spotLightPenumbra"+m+";","spotEffect = clamp(spotEffect, 0.0, 1.0);","} else {","spotEffect = 1.0;","}","float dotProduct = dot(N, lVector);","float spotDiffuseWeightFull = max(dotProduct, 0.0);","float spotDiffuseWeightHalf = max(mix(dotProduct, 1.0, wrapSettings.x), 0.0);","vec3 spotDiffuseWeight = mix(vec3(spotDiffuseWeightFull), vec3(spotDiffuseWeightHalf), wrapSettings.y);","vec3 cookie = vec3(1.0);"),y&&l.push("cookie = texture2D(lightCookie"+m+", depth.xy).rgb;"),l.push("totalDiffuse += materialDiffuse.rgb * spotLightColor"+m+".rgb * spotDiffuseWeight * lDistance * spotEffect * shadow * cookie;","vec3 spotHalfVector = normalize(lVector + normalizedViewPosition);","float spotDotNormalHalf = max(dot(N, spotHalfVector), 0.0);","float spotSpecularWeight = spotLightColor"+m+".a * specularStrength * max(pow(spotDotNormalHalf, materialSpecular.a), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecular.a + 2.0001) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(lVector, spotHalfVector), 5.0);","totalSpecular += schlick * spotLightColor"+m+".rgb * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect * shadow * cookie;","#else","totalSpecular += materialSpecular.rgb * spotLightColor"+m+".rgb * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect * shadow * cookie;","#endif","}"),d++),l.push("}")}}l.push("#if defined(EMISSIVE_MAP) && defined(TEXCOORD0)","vec3 emissive = vec3(0.0);","#else","vec3 emissive = materialEmissive.rgb;","#endif","#ifdef SKIP_SPECULAR","final_color.xyz = final_color.xyz * (emissive + totalDiffuse + totalAmbient);","#else","final_color.xyz = final_color.xyz * (emissive + totalDiffuse + totalAmbient) + totalSpecular;","#endif","#if defined(EMISSIVE_MAP) && defined(TEXCOORD0)","final_color.rgb += texture2D(emissiveMap, texCoord0).rgb * materialEmissive.rgb;","#endif"),u.light.prevertex=o.join("\n"),u.light.vertex=a.join("\n"),u.light.prefragment=f.join("\n"),u.light.fragment=l.join("\n")}},u.animation={processor:function(e,t){var n=t.currentPose;n?(e.uniforms.jointPalette||(e.uniforms.jointPalette=u.animation.jointPalette),e.setDefine("JOINT_COUNT",Math.max(t.meshData.paletteMap.length*3,80))):e.removeDefine("JOINT_COUNT")},jointPalette:function(e){var t=e.meshData,n=e.currentPose;if(n){var r=n._matrixPalette,i=t.store;i||(i=new Float32Array(t.paletteMap.length*12),t.store=i);var s;for(var o=0;o<t.paletteMap.length;o++){s=r[t.paletteMap[o]];for(var a=0;a<12;a++)i[o*12+a]=s.data[u.animation.order[a]]}return i}},order:[0,4,8,12,1,5,9,13,2,6,10,14],prevertex:["#ifdef JOINTIDS","attribute vec4 vertexJointIDs;","#endif","#ifdef WEIGHTS","attribute vec4 vertexWeights;","#endif","#ifdef JOINT_COUNT","uniform vec4 jointPalette[JOINT_COUNT];","#endif"].join("\n"),vertex:["#if defined(JOINT_COUNT) && defined(WEIGHTS) && defined(JOINTIDS)","int x = 3*int(vertexJointIDs.x);","int y = 3*int(vertexJointIDs.y);","int z = 3*int(vertexJointIDs.z);","int w = 3*int(vertexJointIDs.w);","mat4 mat = mat4(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);","mat += mat4(","	jointPalette[x+0].x, jointPalette[x+1].x, jointPalette[x+2].x, 0,","	jointPalette[x+0].y, jointPalette[x+1].y, jointPalette[x+2].y, 0,","	jointPalette[x+0].z, jointPalette[x+1].z, jointPalette[x+2].z, 0,","	jointPalette[x+0].w, jointPalette[x+1].w, jointPalette[x+2].w, 1",") * vertexWeights.x;","mat += mat4(","	jointPalette[y+0].x, jointPalette[y+1].x, jointPalette[y+2].x, 0,","	jointPalette[y+0].y, jointPalette[y+1].y, jointPalette[y+2].y, 0,","	jointPalette[y+0].z, jointPalette[y+1].z, jointPalette[y+2].z, 0,","	jointPalette[y+0].w, jointPalette[y+1].w, jointPalette[y+2].w, 1",") * vertexWeights.y;","mat += mat4(","	jointPalette[z+0].x, jointPalette[z+1].x, jointPalette[z+2].x, 0,","	jointPalette[z+0].y, jointPalette[z+1].y, jointPalette[z+2].y, 0,","	jointPalette[z+0].z, jointPalette[z+1].z, jointPalette[z+2].z, 0,","	jointPalette[z+0].w, jointPalette[z+1].w, jointPalette[z+2].w, 1",") * vertexWeights.z;","mat += mat4(","	jointPalette[w+0].x, jointPalette[w+1].x, jointPalette[w+2].x, 0,","	jointPalette[w+0].y, jointPalette[w+1].y, jointPalette[w+2].y, 0,","	jointPalette[w+0].z, jointPalette[w+1].z, jointPalette[w+2].z, 0,","	jointPalette[w+0].w, jointPalette[w+1].w, jointPalette[w+2].w, 1",") * vertexWeights.w;","wMatrix = wMatrix * mat / mat[3][3];","#ifdef NORMAL","nMatrix = nMatrix * mat3(mat) / mat[3][3];","#endif","#endif"].join("\n")},u}),define("goo/renderer/shaders/ShaderLib",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderBuilder"],function(e,t,n,r){function i(){}return i.uber={processors:[r.uber.processor,r.light.processor,r.animation.processor],attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL,vertexTangent:e.TANGENT,vertexColor:e.COLOR,vertexUV0:e.TEXCOORD0,vertexUV1:e.TEXCOORD1,vertexJointIDs:e.JOINTIDS,vertexWeights:e.WEIGHTS},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,normalMatrix:t.NORMAL_MATRIX,cameraPosition:t.CAMERA,diffuseMap:t.DIFFUSE_MAP,offsetRepeat:[0,0,1,1],normalMap:t.NORMAL_MAP,normalMultiplier:1,specularMap:t.SPECULAR_MAP,emissiveMap:t.EMISSIVE_MAP,aoMap:t.AO_MAP,lightMap:t.LIGHT_MAP,environmentCube:"ENVIRONMENT_CUBE",environmentSphere:"ENVIRONMENT_SPHERE",reflectionMap:"REFLECTION_MAP",transparencyMap:"TRANSPARENCY_MAP",opacity:1,reflectivity:0,refractivity:0,etaRatio:-0.5,fresnel:0,discardThreshold:-0.01,fogSettings:[0,1e4],fogColor:[1,1,1],shadowDarkness:.5,vertexColorAmount:1,lodBias:0,wrapSettings:[.5,0]},builder:function(e,t){r.light.builder(e,t)},vshader:function(){return["attribute vec3 vertexPosition;","#ifdef NORMAL","attribute vec3 vertexNormal;","#endif","#ifdef TANGENT","attribute vec4 vertexTangent;","#endif","#ifdef COLOR","attribute vec4 vertexColor;","#endif","#ifdef TEXCOORD0","attribute vec2 vertexUV0;","uniform vec4 offsetRepeat;","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","attribute vec2 vertexUV1;","varying vec2 texCoord1;","#endif","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","#endif",r.light.prevertex,r.animation.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;","#ifdef NORMAL","mat3 nMatrix = normalMatrix;","#endif",r.animation.vertex,"vec4 worldPos = wMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;","viewPosition = cameraPosition - worldPos.xyz;","#ifdef NORMAL","	normal = normalize(nMatrix * vertexNormal);","#endif","#ifdef TANGENT","	tangent = normalize(nMatrix * vertexTangent.xyz);","	binormal = cross(normal, tangent) * vec3(vertexTangent.w);","#endif","#ifdef COLOR","	color = vertexColor;","#endif","#ifdef TEXCOORD0","	texCoord0 = vertexUV0 * offsetRepeat.zw + offsetRepeat.xy;","#endif","#ifdef TEXCOORD1","	texCoord1 = vertexUV1;","#endif",r.light.vertex,"}"].join("\n")},fshader:function(){return["uniform float lodBias;","#ifdef DIFFUSE_MAP","uniform sampler2D diffuseMap;","#endif","#ifdef NORMAL_MAP","uniform sampler2D normalMap;","uniform float normalMultiplier;","#endif","#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#endif","#ifdef EMISSIVE_MAP","uniform sampler2D emissiveMap;","#endif","#ifdef AO_MAP","uniform sampler2D aoMap;","#endif","#ifdef LIGHT_MAP","uniform sampler2D lightMap;","#endif","#ifdef TRANSPARENCY_MAP","uniform sampler2D transparencyMap;","#endif","#ifdef REFLECTIVE","#ifdef ENVIRONMENT_CUBE","uniform samplerCube environmentCube;","#elif defined(ENVIRONMENT_SPHERE)","uniform sampler2D environmentSphere;","#endif","uniform vec4 clearColor;","uniform float reflectivity;","uniform float fresnel;","uniform float refractivity;","uniform float etaRatio;","#ifdef REFLECTION_MAP","uniform sampler2D reflectionMap;","#endif","#endif","#ifdef OPACITY","uniform float opacity;","#endif","#ifdef DISCARD","uniform float discardThreshold;","#endif","#ifdef FOG","uniform vec2 fogSettings;","uniform vec3 fogColor;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","uniform float vertexColorAmount;","#endif","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","varying vec2 texCoord1;","#endif","#define M_PI 3.14159265358979323846264338328",r.light.prefragment,"void main(void)","{","vec4 final_color = vec4(1.0);","#if defined(DIFFUSE_MAP) && defined(TEXCOORD0)","final_color *= texture2D(diffuseMap, texCoord0, lodBias);","#endif","#ifdef COLOR","final_color *= mix(vec4(1.0), color, vertexColorAmount);","#endif","#if defined(TRANSPARENCY_MAP) && defined(TEXCOORD0)","#ifdef TRANSPARENCY_BW","final_color.a = texture2D(transparencyMap, texCoord0).r;","#else","final_color.a = texture2D(transparencyMap, texCoord0).a;","#endif","#endif","#ifdef OPACITY","final_color.a *= opacity;","#endif","#ifdef DISCARD","if (final_color.a < discardThreshold) discard;","#endif","#ifdef AO_MAP","#ifdef TEXCOORD1","final_color.rgb *= texture2D(aoMap, texCoord1).rgb;","#elif defined(TEXCOORD0)","final_color.rgb *= texture2D(aoMap, texCoord0).rgb;","#endif","#endif","#ifdef LIGHT_MAP","#ifdef TEXCOORD1","final_color.rgb *= texture2D(lightMap, texCoord1).rgb * 2.0 - 0.5;","#elif defined(TEXCOORD0)","final_color.rgb *= texture2D(lightMap, texCoord0).rgb * 2.0 - 0.5;","#endif","#else","vec3 N = vec3(0.0, 1.0, 0.0);","#if defined(NORMAL)","N = normalize(normal);","#endif","#if defined(TANGENT) && defined(NORMAL_MAP) && defined(TEXCOORD0)","mat3 tangentToWorld = mat3(tangent, binormal, normal);","vec3 tangentNormal = texture2D(normalMap, texCoord0, lodBias).xyz * vec3(2.0) - vec3(1.0);","tangentNormal.xy *= normalMultiplier;","vec3 worldNormal = (tangentToWorld * tangentNormal);","N = normalize(worldNormal);","#endif",r.light.fragment,"#endif","#ifdef REFLECTIVE","if (refractivity > 0.0) {","vec4 environment = vec4(0.0);","#ifdef ENVIRONMENT_CUBE","vec3 refractionVector = refract(normalize(viewPosition), N, etaRatio);","refractionVector.x = -refractionVector.x;","environment = textureCube(environmentCube, refractionVector);","#elif defined(ENVIRONMENT_SPHERE)","vec3 refractionVector = refract(normalize(viewPosition), N, etaRatio);","refractionVector = -refractionVector;","float xx = (atan(refractionVector.z, refractionVector.x) + M_PI) / (2.0 * M_PI);","float yy = refractionVector.y * 0.5 + 0.5;","environment = texture2D(environmentSphere, vec2(xx, yy));","#endif","environment.rgb = mix(clearColor.rgb, environment.rgb, environment.a);","final_color.rgb = mix(final_color.rgb, environment.rgb, refractivity);","}","if (reflectivity > 0.0) {","vec4 environment = vec4(0.0);","#ifdef ENVIRONMENT_CUBE","vec3 reflectionVector = reflect(normalize(viewPosition), N);","reflectionVector.yz = -reflectionVector.yz;","environment = textureCube(environmentCube, reflectionVector);","#elif defined(ENVIRONMENT_SPHERE)","vec3 reflectionVector = reflect(normalize(viewPosition), N);","float xx = (atan(reflectionVector.z, reflectionVector.x) + M_PI) / (2.0 * M_PI);","float yy = reflectionVector.y * 0.5 + 0.5;","environment = texture2D(environmentSphere, vec2(xx, yy));","#endif","environment.rgb = mix(clearColor.rgb, environment.rgb, environment.a);","float reflectionAmount = reflectivity;","#if defined(REFLECTION_MAP) && defined(TEXCOORD0)","reflectionAmount *= texture2D(reflectionMap, texCoord0).r;","#endif","float fresnelVal = pow(1.0 - abs(dot(normalize(viewPosition), N)), fresnel * 4.0);","reflectionAmount *= fresnelVal;","#if REFLECTION_TYPE == 0","final_color.rgb = mix(final_color.rgb, environment.rgb, reflectionAmount);","#elif REFLECTION_TYPE == 1","final_color.rgb += environment.rgb * reflectionAmount;","#endif","final_color.a = min(final_color.a + reflectionAmount, 1.0);","}","#endif","#ifndef LIGHT_MAP","final_color.rgb += totalSpecular;","final_color.a = min(final_color.a + length(totalSpecular) / 3.0, 1.0);","#endif","#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","gl_FragColor = final_color;","}"].join("\n")}},i.screenCopy={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{diffuseMap:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},i.copy={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,opacity:1,diffuseMap:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = vec4(texture2D(diffuseMap, texCoord0).rgb, opacity);","}"].join("\n")},i.copyPure={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,opacity:1,diffuseMap:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","vec4 col = texture2D(diffuseMap, texCoord0);","gl_FragColor = vec4(col.rgb, col.a * opacity);","}"].join("\n")},i.simple={attributes:{vertexPosition:e.POSITION},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["void main(void)","{","gl_FragColor = vec4(1.0);","}"].join("\n")},i.simpleColored={attributes:{vertexPosition:e.POSITION},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,color:[1,1,1],opacity:1},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform vec3 color;","uniform float opacity;","void main(void)","{","if (opacity == 0.0) {","discard;","}","gl_FragColor = vec4(color, opacity);","}"].join("\n")},i.simpleLit={processors:[r.light.processor],defines:{NORMAL:!0},attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,cameraPosition:t.CAMERA,opacity:1},builder:function(e,t){r.light.builder(e,t)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;",r.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",r.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#endif","uniform float opacity;",r.light.prefragment,"#ifdef NORMAL","varying vec3 normal;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","void main(void)","{","if (opacity == 0.0) {","discard;","}","#ifdef NORMAL","vec3 N = normalize(normal);","#else","vec3 N = vec3(0,0,1);","#endif","vec4 final_color = vec4(1.0);",r.light.fragment,"final_color.a = opacity;","gl_FragColor = final_color;","}"].join("\n")}},i.textured={defines:{TEXCOORD0:!0,DIFFUSE_MAP:!0},attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,diffuseMap:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["#if defined(TEXCOORD0) && defined(DIFFUSE_MAP)","uniform sampler2D diffuseMap;","varying vec2 texCoord0;","#endif","void main(void)","{","#if defined(TEXCOORD0) && defined(DIFFUSE_MAP)","gl_FragColor = texture2D(diffuseMap, texCoord0);","#else","gl_FragColor = vec4(1.0);","#endif","}"].join("\n")},i.texturedLit={processors:[r.light.processor],attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL,vertexUV0:e.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,cameraPosition:t.CAMERA,diffuseMap:t.DIFFUSE_MAP},builder:function(e,t){r.light.builder(e,t)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;",r.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",r.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","texCoord0 = vertexUV0;","viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;",r.light.prefragment,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void)","{","vec3 N = normalize(normal);","vec4 final_color = texture2D(diffuseMap, texCoord0);",r.light.fragment,"gl_FragColor = final_color;","}"].join("\n")}},i.convolution={defines:{KERNEL_SIZE_FLOAT:"25.0",KERNEL_SIZE_INT:"25"},attributes:{position:e.POSITION,uv:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,uImageIncrement:[.001953125,0],cKernel:[],size:1},vshader:["attribute vec3 position;","attribute vec2 uv;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float size;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vUv = uv - ( ( KERNEL_SIZE_FLOAT - 1.0 ) / 2.0 ) * size * uImageIncrement;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( position, 1.0 );","}"].join("\n"),fshader:["uniform float cKernel[ KERNEL_SIZE_INT ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","uniform float size;","varying vec2 vUv;","void main() {","vec2 imageCoord = vUv;","vec4 sum = vec4( 0.0 );","for(float i = 0.0; i < KERNEL_SIZE_FLOAT; i++) {","sum += texture2D( tDiffuse, imageCoord ) * cKernel[int(i)];","imageCoord += uImageIncrement * size;","}","gl_FragColor = sum;","}"].join("\n"),buildKernel:function(e){function t(e,t){return Math.exp(-(e*e)/(2*t*t))}var n,r,i,s,o=25,u=2*Math.ceil(e*3)+1;u>o&&(u=o),s=(u-1)*.5,r=new Array(u),i=0;for(n=0;n<u;++n)r[n]=t(n-s,e),i+=r[n];for(n=0;n<u;++n)r[n]/=i;return r}},i.showNormals={defines:{NORMAL:!0},attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,opacity:1},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec3 normal;","void main() {","normal = vec3(worldMatrix * vec4(vertexNormal, 0.0));","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform float opacity;","#ifdef NORMAL","varying vec3 normal;","#else","vec3 normal = vec3(0,0,1);","#endif","void main() {","gl_FragColor = vec4( 0.5 * normalize( normal ) + 0.5, opacity );","}"].join("\n")},i.particles={attributes:{vertexPosition:e.POSITION,vertexColor:e.COLOR,vertexUV0:e.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,diffuseMap:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","varying vec4 color;","void main(void) {","texCoord0 = vertexUV0;","color = vertexColor;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","varying vec4 color;","void main(void)","{","vec4 texCol = texture2D(diffuseMap, texCoord0);","if (color.a == 0.0 || texCol.a == 0.0) discard;","else gl_FragColor = texCol * color;","}"].join("\n")},i.normalmap={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,heightMap:t.DIFFUSE_MAP,resolution:[512,512],height:.05},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float height;","uniform vec2 resolution;","uniform sampler2D heightMap;","varying vec2 vUv;","void main() {","float val = texture2D( heightMap, vUv ).x;","float valU = texture2D( heightMap, vUv + vec2( 1.0 / resolution.x, 0.0 ) ).x;","float valV = texture2D( heightMap, vUv + vec2( 0.0, 1.0 / resolution.y ) ).x;","gl_FragColor = vec4( ( 0.5 * normalize( vec3( val - valU, val - valV, height  ) ) + 0.5 ), 1.0 );","}"].join("\n")},i.point={attributes:{vertexPosition:e.POSITION,vertexColor:e.COLOR},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,pointSize:2},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform float pointSize;","varying vec4 color;","void main(void) {","color = vertexColor;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","gl_PointSize = pointSize;","}"].join("\n"),fshader:["varying vec4 color;","void main(void)","{","gl_FragColor = color;","}"].join("\n")},i.downsample={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n")},i.lightDepth={processors:[r.animation.processor],defines:{SHADOW_TYPE:0,WEIGHTS:!0,JOINTIDS:!0},attributes:{vertexPosition:e.POSITION,vertexJointIDs:e.JOINTIDS,vertexWeights:e.WEIGHTS},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,cameraScale:t.MAIN_DEPTH_SCALE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 worldPosition;",r.animation.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;",r.animation.vertex,"worldPosition = viewMatrix * wMatrix * vec4(vertexPosition, 1.0);","gl_Position = projectionMatrix * worldPosition;","}"].join("\n"),fshader:["uniform float cameraScale;","varying vec4 worldPosition;","void main(void)","{","float linearDepth = length(worldPosition) * cameraScale;","#if SHADOW_TYPE == 0","gl_FragColor = vec4(linearDepth);","#elif SHADOW_TYPE == 1","gl_FragColor = vec4(linearDepth);","#elif SHADOW_TYPE == 2","gl_FragColor = vec4(linearDepth, linearDepth * linearDepth, 0.0, 0.0);","#endif","}"].join("\n")},i.pickingShader={defines:{WEIGHTS:!0,JOINTIDS:!0},attributes:{vertexPosition:e.POSITION,vertexJointIDs:e.JOINTIDS,vertexWeights:e.WEIGHTS,vertexNormal:e.NORMAL},uniforms:{normalMatrix:t.NORMAL_MATRIX,viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,cameraFar:t.FAR_PLANE,thickness:0,id:function(e){return e.renderable._index!=null?e.renderable._index+1:e.renderable.id+1}},processors:[r.animation.processor,function(e){e.setDefine("NORMAL",!0)}],vshader:["attribute vec3 vertexPosition;","#ifdef NORMAL","attribute vec3 vertexNormal;","#endif","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float cameraFar;","uniform float thickness;","uniform mat3 normalMatrix;",r.animation.prevertex,"varying float depth;","void main() {","#ifdef NORMAL","mat3 nMatrix = normalMatrix;","#endif","mat4 wMatrix = worldMatrix;",r.animation.vertex,"#ifdef NORMAL","vec4 mvPosition = viewMatrix * wMatrix * vec4( vertexPosition + vertexNormal * thickness, 1.0 );","#else","vec4 mvPosition = viewMatrix * wMatrix * vec4( vertexPosition, 1.0 );","#endif","depth = -mvPosition.z / cameraFar;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fshader:["uniform float id;","varying float depth;",n.methods.packDepth16,"void main() {","vec2 packedId = vec2(floor(id/255.0), mod(id, 255.0)) * vec2(1.0/255.0);","vec2 packedDepth = packDepth16(depth);","gl_FragColor = vec4(packedId, packedDepth);","}"].join("\n")},i}),define("goo/loaders/handlers/MaterialHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Material","goo/renderer/Util","goo/renderer/shaders/ShaderLib","goo/renderer/RenderQueue","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o,u){function a(){e.apply(this,arguments)}return a.prototype=Object.create(e.prototype),a.prototype.constructor=a,e._registerClass("material",a),a.ENGINE_SHADER_PREFIX="GOO_ENGINE_SHADERS/",a.prototype._prepare=function(e){e.blendState||(e.blendState={}),u.defaults(e.blendState,{blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"}),e.cullState||(e.cullState={}),u.defaults(e.cullState,{enabled:!0,cullFace:"Back",frontFace:"CCW"}),e.depthState||(e.depthState={}),u.defaults(e.depthState,{enabled:!0,write:!0});if(e.renderQueue===null||e.renderQueue===undefined)e.renderQueue=-1;if(e.dualTransparency===null||e.dualTransparency===undefined)e.dualTransparency=!1;if(e.wireframe===null||e.wireframe===undefined)e.wireframe=!1;if(e.flat===null||e.flat===undefined)e.flat=!1},a.prototype._create=function(){return new t},a.prototype._remove=function(e){var t=this._objects.get(e);if(!t)return;t.empty(),this._objects.delete(e)},a.prototype._update=function(n,o,f){var l=this;return e.prototype._update.call(this,n,o,f).then(function(e){function v(t,n,r){return l._load(n,r).then(function(n){e.setTexture(t,n)}).then(null,function(e){throw new Error("Error loading texture: "+n+" - "+e)})}if(!e)return;var n=[];u.extend(e.blendState,o.blendState),u.extend(e.cullState,o.cullState),u.extend(e.depthState,o.depthState),e.id=o.id,e.name=o.name,e.wireframe=o.wireframe,e.flat=o.flat,e.dualTransparency=o.dualTransparency,o.renderQueue===-1?o.blendState.blending!=="NoBlending"?e.renderQueue=i.TRANSPARENT:e.renderQueue=null:e.renderQueue=o.renderQueue,e.uniforms={};for(var c in o.uniforms)o.uniforms[c].enabled===undefined?e.uniforms[c]=u.clone(o.uniforms[c]):o.uniforms[c].enabled&&(e.uniforms[c]=u.clone(o.uniforms[c].value));e.uniforms.materialSpecular!==undefined&&e.uniforms.materialSpecularPower!==undefined&&(e.uniforms.materialSpecular[3]=e.uniforms.materialSpecularPower);var h=o.shaderRef;if(!h)e.shader=t.createShader(r.texturedLit,"DefaultShader");else if(h.indexOf(a.ENGINE_SHADER_PREFIX)===0){var p=h.slice(a.ENGINE_SHADER_PREFIX.length);e.shader=t.createShader(r[p])}else{var d=l._load(h,f).then(function(t){e.shader=t}).then(null,function(e){throw new Error("Error loading shader: "+e)});n.push(d)}var m;for(var g in o.texturesMapping)m=o.texturesMapping[g],!m||!m.textureRef||m.enabled===!1?e.removeTexture(g):n.push(v(g,m.textureRef,f));for(var g in e._textureMaps)o.texturesMapping[g]||e.removeTexture(g);return s.all(n).then(function(){return e})})},a}),define("goo/entities/components/MeshDataComponent",["goo/renderer/bounds/BoundingBox","goo/entities/components/Component","goo/renderer/MeshData"],function(e,t,n){function r(n){t.apply(this,arguments),this.type="MeshDataComponent",this.meshData=n,this.modelBound=new e,this.autoCompute=!0,this.currentPose=null,Object.seal(this)}return r.type="MeshDataComponent",r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.setModelBound=function(e,t){this.modelBound=e,this.autoCompute=t},r.prototype.computeBoundFromPoints=function(){if(this.autoCompute&&this.modelBound!==null&&this.meshData){var e=this.meshData.getAttributeBuffer("POSITION");e!==undefined&&(this.modelBound.computeFromPoints(e),this.autoCompute=!1)}},r.prototype.clone=function(e){e=e||{};var t=new r;return e.shareMeshData?(t.meshData=this.meshData,t.modelBound=this.modelBound):(t.meshData=this.meshData.clone(),t.modelBound=this.modelBound.clone()),t.autoCompute=this.autoCompute,t},r.applyOnEntity=function(e,t){if(e instanceof n){var i=new r(e);return t.setComponent(i),!0}},r}),define("goo/loaders/handlers/MeshDataComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/MeshDataComponent","goo/renderer/bounds/BoundingBox","goo/util/ShapeCreatorMemoized","goo/util/rsvp","goo/util/ObjectUtil","goo/util/StringUtil"],function(e,t,n,r,i,s,o){function u(){e.apply(this,arguments),this._type="MeshDataComponent"}return u.prototype=Object.create(e.prototype),u.prototype.constructor=u,e._registerClass("meshData",u),u.prototype._prepare=function(e){return s.defaults(e,{})},u.prototype._create=function(){return new t},u.prototype._remove=function(e){e.meshDataComponent&&e.meshDataComponent.meshData&&this.world.gooRunner&&e.meshDataComponent.meshData.destroy(this.world.gooRunner.renderer.context),e.clearComponent("MeshDataComponent")},u.prototype.update=function(t,s,u){var a=this;return e.prototype.update.call(this,t,s,u).then(function(e){if(!e)return;if(s.shape){var t=r["create"+o.capitalize(s.shape)];if(t)return e.meshData=t(s.shapeOptions,e.meshData),e.autoCompute=!0,e}else{if(s.meshRef){var f=[];return f.push(a._load(s.meshRef,u).then(function(t){e.meshData=t;if(t.boundingBox){var r=t.boundingBox.min,i=t.boundingBox.max,s=[i[0]-r[0],i[1]-r[1],i[2]-r[2]],o=[(i[0]+r[0])*.5,(i[1]+r[1])*.5,(i[2]+r[2])*.5],u=new n;u.xExtent=s[0]/2,u.yExtent=s[1]/2,u.zExtent=s[2]/2,u.center.setArray(o),e.modelBound=u,e.autoCompute=!1}})),s.poseRef?f.push(a._load(s.poseRef,u).then(function(t){e.currentPose=t})):e.currentPose=null,i.all(f).then(function(){return e})}console.warn("MeshDataComponent config does not contain a primitive spec or a reference to a mesh")}})},u}),define("goo/loaders/handlers/MeshDataHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/MeshData","goo/renderer/BufferUtils","goo/util/PromiseUtil","goo/util/ArrayUtil"],function(e,t,n,r,i){function o(){e.apply(this,arguments)}var s=4;return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,e._registerClass("mesh",o),o.prototype._remove=function(e){var t=this._objects.get(e);t&&this.world.gooRunner&&t.destroy(this.world.gooRunner.renderer.context),this._objects.delete(e)},o.prototype._update=function(e,t,n){if(!t)return this._remove(e),r.resolve();var i=this._objects.get(e);return i?r.resolve(i):this.loadObject(t.binaryRef,n).then(function(n){if(!n)throw new Error("Binary mesh data was empty");var r=this._createMeshData(t,n);return this._fillMeshData(r,t,n),this._objects.set(e,r),r}.bind(this))},o.prototype._createMeshData=function(e){var r=e.type==="SkinnedMesh",i=e.vertexCount;if(i===0)return null;var s=0;e.indexLengths?s=e.indexLengths.reduce(function(e,t){return e+t}):e.indices&&(s=e.indices.wordLength);var o={float32:"Float",uint8:"UnsignedByte",uint16:"UnsignedShort",uint32:"UnsignedInt"};n.browserType==="Trident"&&(o.uint8="UnsignedShort");var u={};for(var a in e.attributes){var f=e.attributes[a],l=f.value[2];u[a]=t.createAttribute(f.dimensions,o[l])}var c=new t(u,i,s);return c.type=r?t.SKINMESH:t.MESH,c},o.prototype._fillMeshData=function(e,n,r){var o=e.type===t.SKINMESH;for(var u in n.attributes){if(u==="JOINTIDS")continue;var a=n.attributes[u].value;e.getAttributeBuffer(u).set(i.getTypedArray(r,a))}if(o&&n.attributes.JOINTIDS){var f=e.getAttributeBuffer(t.JOINTIDS),l=i.getTypedArray(r,n.attributes.JOINTIDS.value),c=[],h=0;for(var p=0;p<l.length;p++){var d=l[p];c[d]===undefined&&(c[d]=h++),f.set([c[d]],p)}var v=[];for(var d=0;d<c.length;d++){var h=c[d];h!==null&&(v[h]=d)}e.paletteMap=v,e.weightsPerVertex=s}e.getIndexBuffer().set(i.getTypedArray(r,n.indices)),e.indexModes=n.indexModes.slice(),e.indexLengths=n.indexLengths.slice();if(n.boundingVolume){if(n.boundingVolume.type!=="BoundingBox")throw new Error("Bounding volume was not BoundingBox");e.boundingBox={min:n.boundingVolume.min,max:n.boundingVolume.max}}return e},o}),define("goo/entities/components/MeshRendererComponent",["goo/entities/components/Component","goo/renderer/Material"],function(e,t){function n(t){e.apply(this,arguments),this.type="MeshRendererComponent",this.materials=Array.isArray(t)?t:t?[t]:[],this.worldBound=null,this.cullMode="Dynamic",this.castShadows=!0,this.receiveShadows=!0,this.isPickable=!0,this.isReflectable=!0,this.hidden=!1,this._renderDistance=0,Object.seal(this)}return n.type="MeshRendererComponent",n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.api={setDiffuse:function(){var e=this.meshRendererComponent.materials[0];e.uniforms.materialDiffuse||(e.uniforms.materialDiffuse=[0,0,0,1]);var t=e.uniforms.materialDiffuse;if(arguments.length>=3)t[0]=arguments[0],t[1]=arguments[1],t[2]=arguments[2],t[3]=arguments.length===3?1:arguments[3];else{var n=arguments[0];n instanceof Array?(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n.length===3?1:n[3]):n.r!==undefined&&n.g!==undefined&&typeof n.b!==undefined&&(t[0]=n.r,t[1]=n.g,t[2]=n.b,t[3]=n.a===undefined?1:n.a)}},getDiffuse:function(){return this.meshRendererComponent.materials[0].uniforms.materialDiffuse}},n.entitySelectionAPI={setDiffuse:n.prototype.api.setDiffuse},n.prototype.updateBounds=function(e,t){this.worldBound=e.transform(t,this.worldBound)},n.prototype.clone=function(e){e=e||{};var t;e.shareMaterials?t=this.materials:t=this.materials.map(function(t){return t.clone(e)});var r=new n(t);return r.cullMode=this.cullMode,r.castShadows=this.castShadows,r.receiveShadows=this.receiveShadows,r.isPickable=this.isPickable,r.isReflectable=this.isReflectable,r},n.applyOnEntity=function(e,r){var i=r.meshRendererComponent;i||(i=new n);var s=!1;e instanceof t&&(i.materials.push(e),s=!0);if(s)return r.setComponent(i),!0},n}),define("goo/loaders/handlers/MeshRendererComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o){function u(){e.apply(this,arguments),this._type="MeshRendererComponent"}return u.prototype=Object.create(e.prototype),u.prototype.constructor=u,e._registerClass("meshRenderer",u),u.DEFAULT_MATERIAL=new n(r.uber,"Default material"),u.prototype._prepare=function(e){return o.defaults(e,{cullMode:"Dynamic",castShadows:!0,receiveShadows:!0,reflectable:!0})},u.prototype._create=function(){return new t},u.prototype.update=function(t,n,r){var s=this;return e.prototype.update.call(this,t,n,r).then(function(e){if(!e)return;e.cullMode=n.cullMode,e.castShadows=n.castShadows,e.receiveShadows=n.receiveShadows,e.isReflectable=n.reflectable;var t=n.materials;if(!t||!Object.keys(t).length){var a=e.materials.filter(function(e){return e.name==="gooSelectionIndicator"});return e.materials=[u.DEFAULT_MATERIAL].concat(a),e}var f=[];return o.forEach(t,function(e){f.push(s._load(e.materialRef,r))},null,"sortValue"),i.all(f).then(function(t){var n=e.materials.filter(function(e){return e.name==="gooSelectionIndicator"});return e.materials=t.concat(n),e})})},u}),define("goo/loaders/handlers/SceneHandler",["goo/loaders/handlers/ConfigHandler","goo/entities/SystemBus","goo/util/ArrayUtil","goo/util/ObjectUtil","goo/util/rsvp"],function(e,t,n,r,i){function s(){e.apply(this,arguments)}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,e._registerClass("scene",s),s.prototype._remove=function(e){var t=this._objects.get(e);if(t)for(var n=0;n<t.entities.length;n++)t.entities[n].removeFromWorld();this._objects.delete(e)},s.prototype._create=function(){return{id:null,entities:{},posteffects:[],environment:null,initialCameraRef:null}},s.prototype._update=function(n,r,s){var o=this;return e.prototype._update.call(this,n,r,s).then(function(e){if(!e)return;e.id=n;var u=[];return u.push(o._handleEntities(r,e,s)),r.posteffectsRef&&u.push(o._load(r.posteffectsRef,s)),r.environmentRef&&u.push(o._load(r.environmentRef,s)),(!s.scene||!s.scene.dontSetCamera)&&r.initialCameraRef&&r.initialCameraRef!==e.initialCameraRef&&u.push(o._load(r.initialCameraRef,s).then(function(n){n&&n.cameraComponent&&t.emit("goo.setCurrentCamera",{camera:n.cameraComponent.camera,entity:n}),e.initialCameraRef=r.initialCameraRef})),i.all(u).then(function(){return e})})},s.prototype._handleEntities=function(e,t,n){var s=this,o=[],u=r.clone(e.entities),a=[];for(var f in t.entities)u[f]?delete u[f]:a[f]=f;return r.forEach(e.entities,function(e){o.push(s._load(e.entityRef,n))},null,"sortValue"),i.all(o).then(function(e){for(var n=0;n<e.length;n++){var r=e[n];u[r.id]&&r.addToWorld(),!u[r.id]&&!a[r.id]&&!r._world.entityManager.containsEntity(r)&&r.addToWorld(),t.entities[r.id]=r}for(var i in a)delete t.entities[i]})},s.prototype._handlePosteffects=function(e,t,n){return this._load(e.posteffectsRef,n)},s.prototype._handleEnvironment=function(e,t,n){return this._load(e.environmentRef,n)},s}),define("goo/loaders/handlers/ShaderHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderBuilder","goo/util/rsvp","goo/util/PromiseUtil"],function(e,t,n,r,i,s,o){function u(){e.apply(this,arguments)}return u.prototype=Object.create(e.prototype),u.prototype.constructor=u,e._registerClass("shader",u),u.prototype._remove=function(e){var t=this._objects.get(e);t&&this.world.gooRunner&&(t.destroy(this.world.gooRunner.renderer.context),this._objects.delete(e))},u.prototype._update=function(e,n,r){if(!n)return this._remove(e),o.resolve();if(!n.vshaderRef)return o.reject("Shader error, missing vertex shader ref");if(!n.fshaderRef)return o.reject("Shader error, missing fragment shader ref");var u=[this.loadObject(n.vshaderRef,r),this.loadObject(n.fshaderRef,r)];return s.all(u).then(function(r){var s=r[0],u=r[1];if(!s)return o.reject("Vertex shader"+n.vshaderRef+"in shader"+e+"not found");if(!u)return o.reject("Fragment shader"+n.fshaderRef+"in shader"+e+"not found");var a={defines:n.defines||{},attributes:n.attributes||{},uniforms:n.uniforms||{},vshader:s,fshader:u};if(n.processors){a.processors=[];for(var f=0;f<n.processors.length;f++){var l=n.processors[f];i[l]?a.processors.push(i[l].processor):console.error("Unknown processor "+l)}}var c=t.createShader(a,e);return this._objects.set(e,c),c}.bind(this))},u}),define("goo/loaders/handlers/TransformComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/TransformComponent","goo/math/MathUtils","goo/util/ObjectUtil","goo/util/rsvp"],function(e,t,n,r,i){function s(){e.apply(this,arguments),this._type="TransformComponent"}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,e._registerClass("transform",s),s.prototype._prepare=function(e){return r.defaults(e,{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]})},s.prototype._create=function(){return new t},s.prototype._remove=function(e){var t=e.transformComponent;t.transform.translation.setDirect(0,0,0),t.transform.setRotationXYZ(0,0,0),t.transform.scale.setDirect(1,1,1);for(var n=0;n<t.children.length;n++){var r=t.children[n];t.detachChild(r)}t.setUpdated()},s.prototype.update=function(t,r,s){function u(e,t){return o.loadObject(t,s).then(function(t){if(t&&t.transformComponent){e.attachChild(t.transformComponent);var n=o.world.entityManager.containsEntity(t)||o.world._addedEntities.indexOf(t)!==-1,r=o.world.entityManager.containsEntity(e.entity)||o.world._addedEntities.indexOf(e.entity)>-1;!n&&r&&t.addToWorld()}else console.error("Failed to add child to transform component");return e})}var o=this;return e.prototype.update.call(this,t,r,s).then(function(e){if(!e)return;e.transform.translation.setArray(r.translation),e.transform.setRotationXYZ(n.DEG_TO_RAD*r.rotation[0],n.DEG_TO_RAD*r.rotation[1],n.DEG_TO_RAD*r.rotation[2]),e.transform.scale.setArray(r.scale);var t=[];if(r.children){var s=Object.keys(r.children);for(var o=0;o<s.length;o++){var a=r.children[s[o]].entityRef;t.push(u(e,a))}for(var o=0;o<e.children.length;o++){var f=e.children[o],l=f.entity.id;r.children[l]||e.detachChild(f)}}else for(var o=0;o<e.children.length;o++){var f=e.children[o];e.detachChild(f)}return i.all(t).then(function(){return e.setUpdated(),e})})},s}),define("goo/loaders/handlers/ProjectHandler",["goo/loaders/handlers/ConfigHandler"],function(e){function t(){e.apply(this,arguments)}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,e._registerClass("project",t),t.prototype._remove=function(e,t){var n=this._objects.get(e);n&&this.updateObject(n.mainScene.id,null,t)},t.prototype._create=function(){return{mainScene:null}},t.prototype._update=function(t,n,r){var i=this;return e.prototype._update.call(this,t,n,r).then(function(e){function t(){return i._load(n.mainSceneRef,r).then(function(t){return e.mainScene=t,e})}if(!e)return;return e.mainScene&&n.mainSceneRef!==e.mainScene.id?i.updateObject(e.mainScene.id,null,r).then(t):t()})},t}),define("goo/sound/AudioContext",[],function(){var e=!0,t=window.AudioContext||window.webkitAudioContext;AudioContext||(console.warn("WebAudio not supported",AudioContext,window),e=!1);var n;return{getContext:function(){if(!n&&e)try{n=new AudioContext}catch(t){console.warn("WebAudio not supported"),e=!1}return n},isSupported:function(){return e}}}),define("goo/entities/components/SoundComponent",["goo/entities/components/Component","goo/sound/AudioContext","goo/math/Vector3","goo/math/MathUtils"],function(e,t,n,r){function i(){e.apply(this,arguments),this.type="SoundComponent",this.sounds=[],this._isPanned=!0,this._outDryNode=t.getContext().createGain(),this._outWetNode=t.getContext().createGain(),this.connectTo(),this._pannerNode=t.getContext().createPanner(),this._pannerNode.connect(this._outDryNode),this._inNode=t.getContext().createGain(),this._inNode.connect(this._pannerNode),this._oldPosition=new n,this._position=new n,this._orientation=new n,this._velocity=new n,this._attachedToCamera=!1,Object.seal(this)}return i.type="SoundComponent",i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.addSound=function(e){this.sounds.indexOf(e)===-1&&(e.connectTo([this._inNode,this._outWetNode]),this.sounds.push(e))},i.prototype.removeSound=function(e){var t=this.sounds.indexOf(e);t>-1&&(e.stop(),this.sounds.splice(t,1),e.connectTo())},i.prototype.getSoundById=function(e){for(var t=0;t<this.sounds.length;t++)if(this.sounds[t].id===e)return this.sounds[t]},i.prototype.connectTo=function(e){this._outDryNode.disconnect(),this._outWetNode.disconnect(),e&&e.dry&&this._outDryNode.connect(e.dry),e&&e.wet&&this._outWetNode.connect(e.wet)},i.prototype.updateConfig=function(e){e.volume!==undefined&&(this._outDryNode.gain.value=r.clamp(e.volume,0,1)),e.reverb!==undefined&&(this._outWetNode.gain.value=r.clamp(e.reverb,0,1))},i.prototype.process=function(e,t,n){this._pannerNode.rolloffFactor=e.rolloffFactor,this._pannerNode.maxDistance=e.maxDistance;if(this._attachedToCamera||!t){this._isPanned&&(this._inNode.disconnect(),this._inNode.connect(this._outDryNode),this._isPanned=!1),this._pannerNode.setPosition(0,0,0),this._pannerNode.setVelocity(0,0,0),this._pannerNode.setOrientation(0,0,0);return}this._isPanned||(this._inNode.disconnect(),this._inNode.connect(this._pannerNode),this._isPanned=!0),t.getTranslation(this._position),this._velocity.setVector(this._position).subVector(this._oldPosition).div(n),this._oldPosition.setVector(this._position),this._orientation.setDirect(0,0,-1),t.applyPostVector(this._orientation);var r=this._position.data;this._pannerNode.setPosition(r[0],r[1],r[2]);var i=this._velocity.data;this._pannerNode.setVelocity(i[0],i[1],i[2]);var s=this._orientation.data;this._pannerNode.setOrientation(s[0],s[1],s[2])},i}),define("goo/loaders/handlers/SoundComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/SoundComponent","goo/sound/AudioContext","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s){function o(){e.apply(this,arguments),this._type="SoundComponent"}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,e._registerClass("sound",o),o.prototype._remove=function(e){var t=e.soundComponent;if(t&&t.sounds){var n=t.sounds;for(var r=0;r<n.length;r++)n[r].stop()}},o.prototype._prepare=function(e){s.defaults(e,{volume:1,reverb:0})},o.prototype._create=function(){return new t},o.prototype.update=function(t,o,u){if(!n.isSupported())return i.resolve();var a=this;return e.prototype.update.call(this,t,o,u).then(function(e){if(!e)return;e.updateConfig(o);for(var t=0;t<e.sounds.length;t++){var n=e.sounds[t];o.sounds[n.id]||e.removeSound(n)}var i=[];return s.forEach(o.sounds,function(e){i.push(a._load(e.soundRef,u))},null,"sortValue"),r.all(i).then(function(t){for(var n=0;n<t.length;n++)e.sounds.indexOf(t[n])===-1&&e.addSound(t[n]);return e})})},o}),define("goo/sound/Sound",["goo/sound/AudioContext","goo/math/MathUtils","goo/util/rsvp"],function(e,t,n){function r(){this.id=null,this.name=null,this._loop=!1,this._rate=1,this._offset=0,this._duration=null,this._volume=1,this._buffer=null,this._stream=null,this._streamSource=null,this._currentSource=null,this._outNode=e.getContext().createGain(),this.connectTo(),this._playStart=0,this._pausePos=0,this._endPromise=null,this._paused=!1,Object.seal(this)}return r.prototype.play=function(){if(this._currentSource)return this._endPromise;this._endPromise=new n.Promise;if(!this._buffer||this._stream)return this._endPromise;var t=this._currentSource=e.getContext().createBufferSource();this._paused=!1,this._currentSource.onended=function(){this._currentSource===t&&!this._paused&&this.stop()}.bind(this),this._currentSource.playbackRate.value=this._rate,this._currentSource.connect(this._outNode),this._currentSource.buffer=this._buffer,this._currentSource.loop=this._loop,this._loop&&(this._currentSource.loopStart=this._offset,this._currentSource.loopEnd=this._duration+this._offset),this._playStart=e.getContext().currentTime-this._pausePos;var r=this._duration-this._pausePos;return this._currentSource.start(0,this._pausePos+this._offset,r),this._endPromise},r.prototype.pause=function(){if(!this._currentSource)return;this._paused=!0,this._pausePos=(e.getContext().currentTime-this._playStart)%this._duration,this._pausePos/=this._rate,this._stop()},r.prototype.stop=function(){this._paused=!1,this._pausePos=0,this._endPromise&&this._endPromise.resolve(),this._currentSource&&this._stop()},r.prototype.fadeIn=function(e){this.stop();var t=this._volume;this._outNode.gain.value=0;var n=this.fade(t,e);return this.play(),n},r.prototype.fadeOut=function(e){return this.fade(0,e)},r.prototype.fade=function(t,r){this._outNode.gain.setValueAtTime(this._outNode.gain.value,e.getContext().currentTime),this._outNode.gain.linearRampToValueAtTime(t,e.getContext().currentTime+r);var i=new n.Promise;return setTimeout(function(){i.resolve()},r*1e3),i},r.prototype.isPlaying=function(){return!!this._currentSource},r.prototype._stop=function(){this._currentSource.stop(0),this._currentSource=null},r.prototype.update=function(e){e=e||{},e.id!==undefined&&(this.id=e.id),e.name!==undefined&&(this.name=e.name),e.loop!==undefined&&(this._loop=!!e.loop,this._currentSource&&(this._currentSource.loop=this._loop)),e.volume!==undefined&&(this._volume=t.clamp(e.volume,0,1),this._outNode.gain.value=this._volume),e.offset!==undefined&&(this._offset=e.offset),e.duration!==undefined&&(this._duration=e.duration),e.timeScale!==undefined&&(this._rate=e.timeScale,this._currentSource&&(this._currentSource.playbackRate.value=e.timeScale)),this._buffer&&this._clampInterval()},r.prototype._clampInterval=function(){this._offset=Math.min(this._offset,this._buffer.duration),this._duration!==null?this._duration=Math.min(this._buffer.duration-this._offset,this._duration):this._duration=this._buffer.duration-this._offset,this._pausePos=t.clamp(this._pausePos,0,this._duration)},r.prototype.connectTo=function(e){this._outNode.disconnect();if(!e)return;e instanceof Array||(e=[e]);for(var t=0;t<e.length;t++)this._outNode.connect(e[t])},r.prototype.setAudioBuffer=function(e){this.setAudioStream(null),this._buffer=e,this._clampInterval()},r.prototype.setAudioStream=function(t){if(!t){this._streamSource&&(this._streamSource.disconnect(),this._streamSource=null);return}this.stop(),this._stream=t,this._streamSource=e.getContext().createMediaStreamSource(t),this._streamSource.connect(this._outNode)},r}),define("goo/loaders/handlers/SoundHandler",["goo/loaders/handlers/ConfigHandler","goo/sound/AudioContext","goo/sound/Sound","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s){function o(){e.apply(this,arguments),this._audioCache={};if(window.Audio!==undefined){var t=new Audio;this._codecs=[{type:"mp3",enabled:!!t.canPlayType("audio/mpeg;")},{type:"ogg",enabled:!!t.canPlayType('audio/ogg; codecs="vorbis"')},{type:"wav",enabled:!!t.canPlayType('audio/wav; codecs="1"')}]}else this._codecs=[]}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,e._registerClass("sound",o),o.prototype._remove=function(e){var t=this._objects.get(e);if(!t)return;t.stop(),this._objects.delete(e)},o.prototype._prepare=function(e){s.defaults(e,{loop:!1,audioRefs:{},volume:1,name:"A Sound"})},o.prototype._create=function(){return new n},o.prototype._update=function(n,r,s){if(!t.isSupported())return i.resolve();var o=this;return e.prototype._update.call(this,n,r,s).then(function(e){if(!e)return;e.update(r);for(var n=0;n<o._codecs.length;n++){var s=o._codecs[n],u=r.audioRefs[s.type];if(u&&s.enabled)return o._audioCache[u]?(e.setAudioBuffer(o._audioCache[u]),e):o.loadObject(u).then(function(e){return i.createPromise(function(n,r){t.getContext().decodeAudioData(e,function(e){n(e)},function(){console.error("Could not decode audio "+u),n(null)})})}).then(function(t){return t&&(o._audioCache[u]=t,e.setAudioBuffer(t)),e})}return console.warn("No supported audioformat was found"),e})},o}),define("goo/renderer/TextureCreator",["goo/renderer/Texture","goo/renderer/Util","goo/loaders/handlers/TextureHandler","goo/util/Ajax","goo/util/StringUtil","goo/util/PromiseUtil","goo/util/rsvp"],function(e,t,n,r,i,s,o){function u(){var e=this.ajax=new r;this.textureHandler=new n({},function(t,n){return e.load(t,n?n.noCache:!1)},function(){},function(t,n){return e.load(t,n?n.noCache:!1)})}u.UNSUPPORTED_FALLBACK=".png",u.clearCache=function(){},u.prototype.clear=function(){this.ajax.clear(),this.textureHandler.clear()},u.prototype.loadTexture2D=function(e,t,n){var r=i.createUniqueId("texture");t=t||{},t.imageRef=e;var s=this.textureHandler._create();return this.textureHandler._objects.set(r,s),this.textureHandler.update(r,t).then(function(){n&&n(s)}),s},u.prototype.loadTextureVideo=function(e,t,n,r){var s=i.createUniqueId("texture");n=n||{},n.imageRef=e,n.loop=t,n.wrapS="EdgeClamp",n.wrapT="EdgeClamp",n.autoPlay=!0;var o=this.textureHandler._create();return this.textureHandler._objects.set(s,o),this.textureHandler.update(s,n,{texture:{dontwait:!0}}).then(null,function(e){r(e)}),o},u.prototype.loadTextureWebCam=function(){var n=document.createElement("video");n.autoplay=!0,n.loop=!0;var r=new e(n,{wrapS:"EdgeClamp",wrapT:"EdgeClamp"});return r.readyCallback=function(){if(n.readyState>=3){console.log("WebCam video ready: "+n.videoWidth+", "+n.videoHeight),n.width=n.videoWidth,n.height=n.videoHeight;if(t.isPowerOfTwo(n.width)===!1||t.isPowerOfTwo(n.height)===!1)r.generateMipmaps=!1,r.minFilter="BilinearNoMipMaps";return n.dataReady=!0,!0}return!1},r.updateCallback=function(){return!n.paused},window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?navigator.getUserMedia({video:!0},function(e){n.src=window.URL.createObjectURL(e)},function(e){console.warn("Unable to capture WebCam. Please reload the page.",e)}):console.warn("No support for WebCam getUserMedia found!"),r},u.prototype.loadTextureCube=function(t,n,r){var i=new e(null,n);i.variant="CUBE";var u=t.map(function(e){return s.createPromise(function(t,n){typeof e=="string"?this.ajax._loadImage(e).then(t):t(e)}.bind(this))}.bind(this));return o.all(u).then(function(e){var t=e[0].width,n=e[0].height;for(var s=0;s<6;s++){var o=e[s];if(t!==o.width||n!==o.height)i.generateMipmaps=!1,i.minFilter="BilinearNoMipMaps",console.error("Images not all the same size!")}i.setImage(e),i.image.dataReady=!0,i.image.width=t,i.image.height=n,r&&r()}),i},u._globalCallback=null,u._finishedLoading=function(e){if(u._globalCallback)try{u._globalCallback(e)}catch(t){console.error("Error in texture callback:",t)}};var a=new Uint8Array([255,255,255,255]);return u.DEFAULT_TEXTURE_2D=new e(a,null,1,1),u.DEFAULT_TEXTURE_CUBE=new e([a,a,a,a,a,a],null,1,1),u.DEFAULT_TEXTURE_CUBE.variant="CUBE",u}),define("goo/particles/ParticleLib",[],function(){var e={};return e.getSmoke=function(e){return e=e||{},e.scale=typeof e.scale!="undefined"?e.scale:1,e.spread=typeof e.spread!="undefined"?e.spread:2,e.rate=typeof e.spread!="undefined"?e.rate:25,e.velocity=typeof e.velocity!="undefined"?e.velocity:function(t){var n=t.velocity;return n.data[0]=(Math.random()-.5)*2*e.spread*e.scale,n.data[1]=(Math.random()+4)*2*e.scale,n.data[2]=(Math.random()-.5)*2*e.spread*e.scale,n},e.color=e.color||[0,0,0],{totalParticlesToSpawn:-1,releaseRatePerSecond:e.rate,minLifetime:.5,maxLifetime:4,getEmissionVelocity:e.velocity,timeline:[{timeOffset:0,spin:0,mass:1,size:3*e.scale,color:[e.color[0],e.color[1],e.color[2],1]},{timeOffset:1,size:6*e.scale,color:[e.color[0],e.color[1],e.color[2],0]}]}},e.getFire=function(e){return e=e||{},e.scale=typeof e.scale!="undefined"?e.scale:1,e.spread=typeof e.spread!="undefined"?e.spread:2,e.velocity=typeof e.velocity!="undefined"?e.velocity:10,e.startColor=e.startColor||[1,1,0],e.endColor=e.endColor||[1,0,0],{totalParticlesToSpawn:-1,releaseRatePerSecond:30,minLifetime:.5,maxLifetime:2,getEmissionVelocity:function(t){var n=t.velocity;return n.data[0]=(Math.random()-.5)*2*e.spread*e.scale,n.data[1]=(Math.random()+1)*e.velocity*e.scale,n.data[2]=(Math.random()-.5)*2*e.spread*e.scale,n},timeline:[{timeOffset:0,spin:0,mass:1,size:2*e.scale,color:[e.startColor[0],e.startColor[1],e.startColor[2],0]},{timeOffset:.05,color:[e.startColor[0],e.startColor[1],e.startColor[2],1]},{timeOffset:.45,color:[e.endColor[0],e.endColor[1],e.endColor[2],.8]},{timeOffset:.5,size:3*e.scale,color:[0,0,0,0]}]}},e.getSnow=function(e){return e=e||{},e.scale=typeof e.scale!="undefined"?e.scale:2,e.spread=typeof e.spread!="undefined"?e.spread:50,e.velocity=typeof e.velocity!="undefined"?e.velocity:3,e.color=e.color||[1,1,1],{particleCount:1e3,totalParticlesToSpawn:-1,releaseRatePerSecond:50,minLifetime:15,maxLifetime:25,getEmissionPoint:function(t){var n=t.position;return e.getEmissionPoint(n),n},getEmissionVelocity:function(t){var n=t.velocity;return e.getEmissionVelocity(n),n},timeline:[{timeOffset:0,spin:0,mass:1,size:1*e.scale,color:[e.color[0],e.color[1],e.color[2],0]},{timeOffset:.05,color:[e.color[0],e.color[1],e.color[2],1]},{timeOffset:.7,color:[e.color[0],e.color[1],e.color[2],.8]},{timeOffset:.25,spin:5,size:.5*e.scale,color:[e.color[0],e.color[1],e.color[2],0]}]}},e}),define("goo/particles/ParticleUtils",["goo/math/Vector3"],function(e){function t(){}return t.getRandomVelocityOffY=function(e,n,r,i,s){var o=n+Math.random()*(r-n),u=Math.PI*2*Math.random();return e.x=Math.cos(u)*Math.sin(o),e.y=Math.cos(o),e.z=Math.sin(u)*Math.sin(o),s&&t.applyEntityTransformVector(e,s),e.mul(i),e},t.randomPointInCube=function(e,t,n,r,i){return e.x=Math.random()*2*t-t+(i?i.x:0),e.y=Math.random()*2*n-n+(i?i.y:0),e.z=Math.random()*2*r-r+(i?i.z:0),e},t.createConstantForce=function(t){var n=new e(t);return{enabled:!0,prepare:function(){},apply:function(e,t){t.velocity.x+=n.x*e,t.velocity.y+=n.y*e,t.velocity.z+=n.z*e}}},t.applyEntityTransformPoint=function(e,t){return!t.transformComponent||!t.transformComponent.worldTransform?e:t.transformComponent.worldTransform.applyForward(e,e)},t.applyEntityTransformVector=function(e,t){return!t.transformComponent||!t.transformComponent.worldTransform?e:t.transformComponent.worldTransform.applyForwardVector(e,e)},t.applyTimeline=function(e,t){var n=e.age,r=e.lifeSpan,i=0,s=0,o=0,u=0,a=r,f=r,l=r,c=r,h=0,p=0,d=null,v=null,m=null,g=null,y=null,b=null,w=null,E=null,S=null;for(var x=0,T=t.length;x<T;x++){var N=t[x];h+=(N.timeOffset?N.timeOffset:0)*r,b===null&&(h>n?N.color!==undefined&&(a=h,b=N):N.color!==undefined&&(i=h,d=N)),w===null&&(h>n?N.mass!==undefined&&(f=h,w=N):N.mass!==undefined&&(s=h,v=N)),h<=n&&N.uvIndex!==undefined&&(y=N),E===null&&(h>n?N.size!==undefined&&(l=h,E=N):N.size!==undefined&&(o=h,m=N)),S===null&&(h>n?N.spin!==undefined&&(c=h,S=N):N.spin!==undefined&&(u=h,g=N))}p=(n-i)/(a-i);var C=d!==null?d.color:[1,1,1,1],k=b!==null?b.color:C;e.color.data[0]=(1-p)*C[0]+p*k[0],e.color.data[1]=(1-p)*C[1]+p*k[1],e.color.data[2]=(1-p)*C[2]+p*k[2],e.color.data[3]=(1-p)*C[3]+p*k[3],p=(n-s)/(f-s);var C=v!==null?v.mass:1,k=w!==null?w.mass:C;e.mass=(1-p)*C+p*k,e.uvIndex=y!==null?y.uvIndex:0,p=(n-o)/(l-o);var C=m!==null?m.size:1,k=E!==null?E.size:C;e.size=(1-p)*C+p*k,p=(n-u)/(c-u);var C=g!==null?g.spin:0,k=S!==null?S.spin:C;e.spin=(1-p)*C+p*k},t}),define("goo/particles/Particle",["goo/particles/ParticleUtils","goo/math/Vector","goo/math/Vector3","goo/math/Vector4","goo/renderer/MeshData"],function(e,t,n,r,i){function o(e,t){this.alive=!1,this.position=new n,this.velocity=new n,this.lifeSpan=0,this.parent=e,this.age=0,this.index=t,this.color=new r(1,0,0,1),this.size=0,this.spin=0,this.mass=1,this.emitter=null,this.uvIndex=0,this.lastUVIndex=-1,this.bbX=new n,this.bbY=new n,this.lastColor=new r}var s=new n;o.prototype.respawnParticle=function(e){this.emitter=e,this.lifeSpan=e.nextParticleLifeSpan(),this.alive=!0,this.age=0};var u=[];return o.prototype.update=function(n,r){if(!this.alive)return;this.age+=n;if(this.age>this.lifeSpan){this.kill();return}this.position.addDirect(this.velocity.x*n,this.velocity.y*n,this.velocity.z*n),e.applyTimeline(this,this.emitter&&this.emitter.timeline?this.emitter.timeline:this.parent.timeline);if(!t.equals(this.lastColor,this.color)){var o=this.parent.meshData.getAttributeBuffer(i.COLOR);o.set(this.color.data,this.index*16+0),o.set(this.color.data,this.index*16+4),o.set(this.color.data,this.index*16+8),o.set(this.color.data,this.index*16+12),this.lastColor.setVector(this.color)}this.emitter&&this.emitter.getParticleBillboardVectors(this,r);if(this.spin===0)this.bbX.mulDirect(this.size,this.size,this.size),this.bbY.mulDirect(this.size,this.size,this.size);else{var a=Math.cos(this.spin)*this.size,f=Math.sin(this.spin)*this.size,l=this.bbY.x,c=this.bbY.y,h=this.bbY.z;this.bbY.setVector(this.bbX),this.bbX.mulDirect(a,a,a).addDirect(l*f,c*f,h*f),this.bbY.mulDirect(-f,-f,-f).addDirect(l*a,c*a,h*a)}var p=this.parent.meshData.getAttributeBuffer(i.POSITION);s.setVector(this.position).subVector(this.bbX).subVector(this.bbY),p.set(s.data,this.index*12+0),s.setVector(this.position).subVector(this.bbX).addVector(this.bbY),p.set(s.data,this.index*12+3),s.setVector(this.position).addVector(this.bbX).addVector(this.bbY),p.set(s.data,this.index*12+6),s.setVector(this.position).addVector(this.bbX).subVector(this.bbY),p.set(s.data,this.index*12+9);if(this.lastUVIndex!==this.uvIndex){var d=this.parent.meshData.getAttributeBuffer(i.TEXCOORD0),v=this.uvIndex%this.parent.uRange/this.parent.uRange,m=1-Math.floor(this.uvIndex/this.parent.vRange)/this.parent.vRange,g=1/this.parent.uRange,y=1/this.parent.vRange;u[0]=v+g,u[1]=m-y,d.set(u,this.index*8+0),u[0]=v+g,u[1]=m,d.set(u,this.index*8+2),u[0]=v,u[1]=m,d.set(u,this.index*8+4),u[0]=v,u[1]=m-y,d.set(u,this.index*8+6),this.lastUVIndex=this.uvIndex}},o.prototype.kill=function(){this.alive=!1;var e=this.parent.meshData.getAttributeBuffer(i.POSITION),t=e.subarray(this.index*12,this.index*12+3);e.set(t,this.index*12+3),e.set(t,this.index*12+6),e.set(t,this.index*12+9)},o}),define("goo/renderer/RendererRecord",[],function(){function e(){this.currentBuffer={ArrayBuffer:{buffer:null,valid:!1},ElementArrayBuffer:{buffer:null,valid:!1}},this.currentFrameBuffer=null,this.clippingTestValid=!1,this.clippingTestEnabled=!1,this.clips=[],this.enabledTextures=0,this.texturesValid=!1,this.currentTextureArraysUnit=0,this.textureRecord=[],this.usedProgram=null,this.boundAttributes=[],this.enabledAttributes=[],this.newlyEnabledAttributes=[],this.depthRecord={},this.cullRecord={},this.blendRecord={},this.offsetRecord={},this.lineRecord={},this.pointRecord={},this.shaderCache=new Map,this.attributeCache=[],Object.seal(this)}return e.prototype.invalidateBuffer=function(e){this.currentBuffer[e].buffer=null,this.currentBuffer[e].valid=!1},e}),define("goo/renderer/pass/RenderTarget",["goo/math/Vector2"],function(e){function t(t,n,r){this.glTexture=null,this._glRenderBuffer=null,this._glFrameBuffer=null,this.width=Math.floor(t),this.height=Math.floor(n),r=r||{},this.wrapS=r.wrapS!==undefined?r.wrapS:"EdgeClamp",this.wrapT=r.wrapT!==undefined?r.wrapT:"EdgeClamp",this.magFilter=r.magFilter!==undefined?r.magFilter:"Bilinear",this.minFilter=r.minFilter!==undefined?r.minFilter:"BilinearNoMipMaps",this.anisotropy=r.anisotropy!==undefined?r.anisotropy:1,this.format=r.format!==undefined?r.format:"RGBA",this.type=r.type!==undefined?r.type:"UnsignedByte",this.variant="2D",this.offset=new e(0,0),this.repeat=new e(1,1),this.generateMipmaps=r.generateMipmaps!==undefined?r.generateMipmaps:!1,this.premultiplyAlpha=r.premultiplyAlpha!==undefined?r.premultiplyAlpha:!1,this.unpackAlignment=r.unpackAlignment!==undefined?r.unpackAlignment:1,this.flipY=r.flipY!==undefined?r.flipY:!0,this.depthBuffer=r.depthBuffer!==undefined?r.depthBuffer:!0,this.stencilBuffer=r.stencilBuffer!==undefined?r.stencilBuffer:!0,this.textureRecord={}}return t.prototype.clone=function(){var e=new t(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.variant=this.variant,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.unpackAlignment=this.unpackAlignment,e.flipY=this.flipY,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e},t.prototype.getSizeInMemory=function(){var e=this.width*this.height*4;return this.generateMipmaps&&(e=Math.ceil(e*4/3)),e},t.prototype.destroy=function(e){this.glTexture&&(e.deleteTexture(this.glTexture),this.glTexture=null),this._glRenderBuffer&&(e.deleteRenderbuffer(this._glRenderBuffer),this._glRenderBuffer=null),this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null)},t}),define("goo/renderer/pass/FullscreenUtil",["goo/shapes/Quad","goo/renderer/Camera","goo/math/Vector3"],function(e,t,n){function r(){}var i=new t;return i.projectionMode=t.Parallel,i.setFrustum(0,1,-1,1,1,-1),i._left.copy(n.UNIT_X).invert(),i._up.copy(n.UNIT_Y),i._direction.copy(n.UNIT_Z),i.onFrameChange(),r.camera=i,r.quad=new e(2,2),r}),define("goo/renderer/pass/Pass",[],function(){function e(){}return e.prototype.destroy=function(){},e.prototype.render=function(){},e.prototype.updateSize=function(){},e.prototype.invalidateHandles=function(){},e}),define("goo/renderer/pass/FullscreenPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/shaders/ShaderLib","goo/renderer/pass/Pass"],function(e,t,n,r){function i(r){this.material=new e(r||n.simple),this.useReadBuffer=!0,this.renderToScreen=!1,this.renderable={meshData:t.quad,materials:[this.material]},this.enabled=!0,this.clear=!1,this.needsSwap=!0,this.viewportSize=undefined}return i.prototype=Object.create(r.prototype),i.prototype.constructor=i,i.prototype.render=function(e,n,r){this.useReadBuffer&&this.material.setTexture("DIFFUSE_MAP",r),this.renderToScreen?e.render(this.renderable,t.camera,[],null,this.clear):e.render(this.renderable,t.camera,[],n,this.clear)},i.prototype.destroy=function(){this.material.shader.destroy()},i.prototype.invalidateHandles=function(e){e.invalidateMaterial(this.renderable.materials[0]),e.invalidateMeshData(this.renderable.meshData)},i}),define("goo/renderer/shadow/ShadowHandler",["goo/renderer/Capabilities","goo/math/Vector3","goo/renderer/pass/FullscreenPass","goo/renderer/Camera","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/pass/RenderTarget","goo/math/Vector4","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight"],function(e,t,n,r,i,s,o,u,a,f,l){function c(){this.depthMaterial=new i(s.lightDepth,"depthMaterial"),this.depthMaterial.cullState.cullFace="Back",this.depthMaterial.fullOverride=!0,this.fullscreenPass=new n,this.downsample=i.createShader(s.downsample,"downsample");var e=2;this.blurfilter=i.createShader(s.convolution,"blurfilter");var t=2*Math.ceil(e*3)+1;this.blurfilter.defines={KERNEL_SIZE_FLOAT:t.toFixed(1),KERNEL_SIZE_INT:t.toFixed(0)},this.blurfilter.uniforms.cKernel=s.convolution.buildKernel(e),this.oldClearColor=new u(0,0,0,0),this.shadowClearColor=new u(1,1,1,1),this.renderList=[],this.shadowList=[],this.first=!0}var h=new t;return c.prototype._createShadowData=function(t,n){var r=t.resolution[0],i=t.resolution[1],s=!!e.TextureFloatLinear;t.shadowData.shadowTarget&&n._deallocateRenderTarget(t.shadowData.shadowTarget),t.shadowData.shadowTarget=new o(r,i,{type:"Float",magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps"}),t.shadowData.shadowResult=null;if(t.shadowType==="VSM"){var u={type:"Float"};s||(u.magFilter="NearestNeighbor",u.minFilter="NearestNeighborNoMipMaps"),t.shadowData.shadowTargetDown&&n._deallocateRenderTarget(t.shadowData.shadowTargetDown),t.shadowData.shadowTargetDown=new o(r/2,i/2,u),t.shadowData.shadowBlurred&&n._deallocateRenderTarget(t.shadowData.shadowBlurred),t.shadowData.shadowBlurred=new o(r/2,i/2,u)}t.shadowRecord.resolution=t.shadowRecord.resolution||[],t.shadowRecord.resolution[0]=r,t.shadowRecord.shadowType=t.shadowType},c.prototype.checkShadowRendering=function(e,n,i,s){if(this.first===!0){this.first=!1;return}for(var o=0;o<s.length;o++){var u=s[o];if(u.shadowCaster||u.lightCookie){var f=u.shadowSettings;f.shadowData||(f.shadowData={},f.shadowRecord={},f.shadowData.lightCamera=new r(55,1,1,1e3));var c=f.shadowRecord,p=f.shadowData.lightCamera;p.translation.copy(u.translation),u.direction?(h.setVector(u.translation).addVector(u.direction),p.lookAt(h,f.upVector)):p.lookAt(t.ZERO,f.upVector);if(!f.shadowData.shadowTarget||c.angle!==u.angle||!c.resolution||c.resolution[0]!==f.resolution[0]||c.resolution[1]!==f.resolution[1]||c.near!==f.near||c.far!==f.far||c.size!==f.size){(!c.resolution||c.resolution[0]!==f.resolution[0]||c.resolution[1]!==f.resolution[1])&&this._createShadowData(f,e);if(u instanceof l)p.setFrustumPerspective(u.angle,f.resolution[0]/f.resolution[1],f.near,f.far);else if(u instanceof a)p.setFrustumPerspective(90,f.resolution[0]/f.resolution[1],f.near,f.far);else{var d=f.size;p.setFrustum(f.near,f.far,-d,d,d,-d),p.projectionMode=r.Parallel}p.update(),c.resolution=c.resolution||[],c.resolution[0]=f.resolution[0],c.resolution[1]=f.resolution[1],c.angle=u.angle,c.near=f.near,c.far=f.far,c.size=f.size}f.shadowType==="VSM"&&c.shadowType!==f.shadowType&&(this._createShadowData(f,e),c.shadowType=f.shadowType),p.onFrameChange();var v=p.getViewProjectionMatrix().data,m=f.shadowData.vpm=f.shadowData.vpm||[];for(var g=0;g<16;g++)m[g]=v[g];if(u.shadowCaster){this.depthMaterial.shader.setDefine("SHADOW_TYPE",f.shadowType==="VSM"?2:0),this.depthMaterial.uniforms.cameraScale=1/(p.far-p.near),f.shadowData.cameraScale=this.depthMaterial.uniforms.cameraScale,this.oldClearColor.copy(e.clearColor),e.setClearColor(this.shadowClearColor.r,this.shadowClearColor.g,this.shadowClearColor.b,this.shadowClearColor.a),this.shadowList.length=0;for(var g=0;g<i.length;g++){var y=i[g];y.meshRendererComponent&&y.meshRendererComponent.castShadows&&!y.isSkybox&&this.shadowList.push(y)}n.process(p,this.shadowList,this.renderList),e.render(this.renderList,p,[],f.shadowData.shadowTarget,!0,this.depthMaterial);switch(f.shadowType){case"VSM":this.fullscreenPass.material.shader=this.downsample,this.fullscreenPass.render(e,f.shadowData.shadowTargetDown,f.shadowData.shadowTarget),this.fullscreenPass.material.shader=this.blurfilter,this.fullscreenPass.material.uniforms.uImageIncrement=[2/f.resolution[0],0],this.fullscreenPass.render(e,f.shadowData.shadowBlurred,f.shadowData.shadowTargetDown),this.fullscreenPass.material.uniforms.uImageIncrement=[0,2/f.resolution[1]],this.fullscreenPass.render(e,f.shadowData.shadowTargetDown,f.shadowData.shadowBlurred),f.shadowData.shadowResult=f.shadowData.shadowTargetDown;break;case"PCF":f.shadowData.shadowResult=f.shadowData.shadowTarget;break;case"Basic":f.shadowData.shadowResult=f.shadowData.shadowTarget;break;default:f.shadowData.shadowResult=f.shadowData.shadowTarget}e.setClearColor(this.oldClearColor.r,this.oldClearColor.g,this.oldClearColor.b,this.oldClearColor.a)}}}},c.prototype.invalidateHandles=function(e){this.fullscreenPass.invalidateHandles(e),e.invalidateMaterial(this.depthMaterial),e.invalidateShader(this.downsample),e.invalidateShader(this.blurfilter)},c}),define("goo/renderer/RenderStats",[],function(){function e(){this.reset()}return e.prototype.reset=function(){this.calls=0,this.vertices=0,this.indices=0},e.prototype.toString=function(){return"Calls: "+this.calls+"<br/>Vertices: "+this.vertices+"<br/>Indices: "+this.indices},e}),define("goo/renderer/TaskScheduler",["goo/util/PromiseUtil"],function(e){function t(){}return function(){window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return Date.now()}}()}(),t.maxTimePerFrame=50,t.each=function(n){return e.createPromise(function(e,r){function s(){var r=performance.now();while(i<n.length&&performance.now()-r<t.maxTimePerFrame)n[i](),i++;i<n.length?setTimeout(s,4):e()}var i=0;s()})},t}),define("goo/renderer/RenderInfo",["goo/entities/Entity","goo/math/Transform"],function(e,t){function n(){this.reset()}return n.prototype.reset=function(){this.renderable=null,this.lights=null,this.materials=null,this.meshData=null,this.camera=null,this.mainCamera=null,this.lights=null,this.shadowHandler=null,this.renderer=null,this.material=null,this.transform=null,this.currentPose=null,Object.seal(this)},n.prototype.fill=function(n){n instanceof e?(this.meshData=n.meshDataComponent.meshData,this.materials=n.meshRendererComponent.materials,this.transform=n.particleComponent?t.IDENTITY:n.transformComponent.worldTransform,n.meshDataComponent.currentPose?this.currentPose=n.meshDataComponent.currentPose:this.currentPose=null):(this.meshData=n.meshData,this.materials=n.materials,this.transform=n.transform,n.currentPose?this.currentPose=n.currentPose:this.currentPose=null),this.renderable=n},n}),define("goo/renderer/Renderer",["goo/renderer/Capabilities","goo/renderer/RendererRecord","goo/renderer/Util","goo/renderer/TextureCreator","goo/renderer/pass/RenderTarget","goo/math/Vector4","goo/entities/Entity","goo/renderer/Texture","goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils","goo/renderer/Material","goo/math/Transform","goo/renderer/RenderQueue","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/renderer/RenderStats","goo/entities/SystemBus","goo/renderer/TaskScheduler","goo/renderer/RenderInfo"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){function E(n){n=n||{};var r=n.canvas;r===undefined&&(r=document.createElement("canvas"),r.width=500,r.height=500),r.screencanvas=!0,this.domElement=r,this._alpha=n.alpha!==undefined?n.alpha:!1,this._premultipliedAlpha=n.premultipliedAlpha!==undefined?n.premultipliedAlpha:!0,this._antialias=n.antialias!==undefined?n.antialias:!0,this._stencil=n.stencil!==undefined?n.stencil:!1,this._preserveDrawingBuffer=n.preserveDrawingBuffer!==undefined?n.preserveDrawingBuffer:!1,this._useDevicePixelRatio=n.useDevicePixelRatio!==undefined?n.useDevicePixelRatio:!1,this._onError=n.onError,this._contextSettings={alpha:this._alpha,premultipliedAlpha:this._premultipliedAlpha,antialias:this._antialias,stencil:this._stencil,preserveDrawingBuffer:this._preserveDrawingBuffer},this.context=null,this.establishContext(),this._setupContextLost(),n.debug&&this.setupDebugging(n),this.rendererRecord=new t,this.context.getShaderPrecisionFormat===undefined&&(this.context.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),this.maxTextureSize=isNaN(n.maxTextureSize)?e.maxTexureSize:Math.min(n.maxTextureSize,e.maxTexureSize),this.maxCubemapSize=isNaN(n.maxTextureSize)?e.maxCubemapSize:Math.min(n.maxTextureSize,e.maxCubemapSize),this.shaderPrecision=n.shaderPrecision||"highp",this.shaderPrecision==="highp"&&e.vertexShaderHighpFloat.precision>0&&e.fragmentShaderHighpFloat.precision>0?this.shaderPrecision="highp":this.shaderPrecision!=="lowp"&&e.vertexShaderMediumpFloat.precision>0&&e.fragmentShaderMediumpFloat.precision>0?this.shaderPrecision="mediump":this.shaderPrecision="lowp",this.downScale=n.downScale||1,this.clearColor=new s,this._clearColor=new Float64Array(4),this.setClearColor(.3,.3,.3,1),this.viewportX=0,this.viewportY=0,this.viewportWidth=0,this.viewportHeight=0,this.currentWidth=0,this.currentHeight=0,this.devicePixelRatio=1,this._overrideMaterials=[],this._mergedMaterial=new l("Merged Material"),this.renderQueue=new h,this.info=new v,this.shadowHandler=new d,this.hardwarePicking=null,m.addListener("goo.setClearColor",function(e){this.setClearColor.apply(this,e)}.bind(this)),document.createElementNS?(this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.setAttribute("version","1.1"),this.svg.style.position="absolute",this.svg.style.display="none",document.body.appendChild(this.svg)):this.svg={currentScale:1},m.addListener("goo.setCurrentCamera",function(e){E.mainCamera=e.camera,this.checkResize(E.mainCamera)}.bind(this)),this._definesIndices=[],Object.seal(this)}function S(e,t){for(var n=0;n<t.length;++n)t[n]===undefined&&console.error("undefined passed to gl."+e+"("+window.WebGLDebugUtils.glFunctionArgsToString(e,t)+")")}var b=function(){},w=window.WebGLRenderingContext;E.prototype.setupDebugging=function(e){var t=new XMLHttpRequest;t.open("GET","/js/goo/lib/webgl-debug.js",!1),t.onreadystatechange=function(){t.readyState===4&&t.status>=200&&t.status<=299&&window.eval.call(window,t.responseText)},t.send(null),typeof window.WebGLDebugUtils=="undefined"?console.warn("You need to include webgl-debug.js in your script definition to run in debug mode."):(console.log("Running in webgl debug mode."),e.validate?(console.log('Running with "undefined arguments" validation.'),this.context=window.WebGLDebugUtils.makeDebugContext(this.context,this.onDebugError.bind(this),S)):this.context=window.WebGLDebugUtils.makeDebugContext(this.context,this.onDebugError.bind(this)))},E.prototype.establishContext=function(){if(!window.WebGLRenderingContext)throw{name:"GooWebGLError",message:"WebGL is not supported",supported:!1,enabled:!1};var t=["experimental-webgl","webgl","moz-webgl","webkit-3d"];for(var n=0;n<t.length;n++)try{this.context=this.domElement.getContext(t[n],this._contextSettings);if(this.context&&typeof this.context.getParameter=="function")break}catch(r){}if(!this.context)throw{name:"GooWebGLError",message:"WebGL is supported but disabled",supported:!0,enabled:!1};this.context.clearDepth(1),this.context.clearStencil(0),this.context.stencilMask(0),this.context.enable(w.DEPTH_TEST),this.context.depthFunc(w.LEQUAL),e.init(this.context)},E.prototype._setupContextLost=function(){this.domElement.addEventListener("webglcontextlost",function(e){e.preventDefault(),m.emit("goo.contextLost")},!1),this.domElement.addEventListener("webglcontextrestored",function(){this._restoreContext(),m.emit("goo.contextRestored")}.bind(this),!1)},E.prototype._restoreContext=b,E.prototype.onDebugError=function(e,t,n){var r="WebGL error "+window.WebGLDebugUtils.glEnumToString(e)+" in "+t+"(";for(var i=0;i<n.length;++i)r+=(i===0?"":", ")+window.WebGLDebugUtils.glFunctionArgToString(t,i,n[i]);r+=")",console.error(r),this._onError&&this._onError(r)},E.mainCamera=null,E.prototype.checkResize=function(e){var t=this.devicePixelRatio=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,n,r;document.querySelector?(n=this.domElement.offsetWidth,r=this.domElement.offsetHeight):(n=window.innerWidth,r=window.innerHeight),n=n*t/this.downScale,r=r*t/this.downScale;var i=n,s=r;e&&e.lockedRatio===!0&&e.aspect&&(n=r*e.aspect);var o=n/r;this.setSize(n,r,i,s),e&&e.lockedRatio===!1&&e.aspect!==o&&(e.aspect=o,e.projectionMode===0?e.setFrustumPerspective():e.setFrustum(),e.onFrameChange())},E.prototype.setSize=function(e,t,n,r){n===undefined&&(n=e),r===undefined&&(r=t),this.domElement.width=n,this.domElement.height=r;if(e>n){var i=n/e;e=n,t=r*i}var s=(n-e)*.5,o=(r-t)*.5;if(s!==this.viewportX||o!==this.viewportY||e!==this.viewportWidth||t!==this.viewportHeight)this.setViewport(s,o,e,t),this.hardwarePicking!==null&&(this.hardwarePicking.pickingTarget=null)},E.prototype.setViewport=function(e,t,n,r){this.viewportX=e!==undefined?e:0,this.viewportY=t!==undefined?t:0,this.viewportWidth=n!==undefined?n:this.domElement.width,this.viewportHeight=r!==undefined?r:this.domElement.height,this.context.viewport(this.viewportX,this.viewportY,this.viewportWidth,this.viewportHeight),m.emit("goo.viewportResize",{x:this.viewportX,y:this.viewportY,width:this.viewportWidth,height:this.viewportHeight},!0)},E.prototype.setClearColor=function(e,t,n,r){if(this._clearColor[0]===e&&this._clearColor[1]===t&&this._clearColor[2]===n&&this._clearColor[3]===r)return;this._clearColor[0]=e,this._clearColor[1]=t,this._clearColor[2]=n,this._clearColor[3]=r,this.clearColor.setArray(this._clearColor),this.context.clearColor(e,t,n,r)},E.prototype.bindData=function(e){var t=e.glBuffer;t!==null?(this.setBoundBuffer(t,e.target),e._dataNeedsRefresh&&(this.context.bufferSubData(this.getGLBufferTarget(e.target),0,e.data),e._dataNeedsRefresh=!1)):(t=this.context.createBuffer(),e.glBuffer=t,this.rendererRecord.invalidateBuffer(e.target),this.setBoundBuffer(t,e.target),this.context.bufferData(this.getGLBufferTarget(e.target),e.data,this.getGLBufferUsage(e._dataUsage)))},E.prototype.updateAttributeData=function(e,t){this.context.bufferSubData(w.ARRAY_BUFFER,t,e)},E.prototype.setShadowType=function(e){this.shadowHandler.shadowType=e},E.prototype.updateShadows=function(e,t,n){this.shadowHandler.checkShadowRendering(this,e,t,n)},E.prototype.preloadTexture=function(e,t){e.bindTexture(this.getGLType(t.variant),t.glTexture),e.pixelStorei(w.UNPACK_ALIGNMENT,t.unpackAlignment),e.pixelStorei(w.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),e.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,t.flipY);var r=t.image;if(t.variant==="2D")r?(!r.isCompressed&&(t.generateMipmaps||r.width>this.maxTextureSize||r.height>this.maxTextureSize)&&(this.checkRescale(t,r,r.width,r.height,this.maxTextureSize),r=t.image),r.isData===!0?r.isCompressed?this.loadCompressedTexture(e,w.TEXTURE_2D,t,r.data):e.texImage2D(w.TEXTURE_2D,0,this.getGLInternalFormat(t.format),r.width,r.height,t.hasBorder?1:0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),r.data):e.texImage2D(w.TEXTURE_2D,0,this.getGLInternalFormat(t.format),this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),r),t.generateMipmaps&&!r.isCompressed&&e.generateMipmap(w.TEXTURE_2D)):e.texImage2D(w.TEXTURE_2D,0,this.getGLInternalFormat(t.format),t.width,t.height,0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),null);else if(t.variant==="CUBE"){if(r&&!r.isData&&(t.generateMipmaps||r.width>this.maxCubemapSize||r.height>this.maxCubemapSize)){for(var i=0;i<u.CUBE_FACES.length;i++)r.data[i]&&!r.data[i].buffer?n.scaleImage(t,r.data[i],r.width,r.height,this.maxCubemapSize,i):n.getBlankImage(t,[.3,.3,.3,0],r.width,r.height,this.maxCubemapSize,i);t.image.width=Math.min(this.maxCubemapSize,n.nearestPowerOfTwo(t.image.width)),t.image.height=Math.min(this.maxCubemapSize,n.nearestPowerOfTwo(t.image.height)),r=t.image}for(var s=0;s<u.CUBE_FACES.length;s++){var o=u.CUBE_FACES[s];r?r.isData===!0?r.isCompressed?this.loadCompressedTexture(e,this.getGLCubeMapFace(o),t,r.data[s]):e.texImage2D(this.getGLCubeMapFace(o),0,this.getGLInternalFormat(t.format),r.width,r.height,t.hasBorder?1:0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),r.data[s]):e.texImage2D(this.getGLCubeMapFace(o),0,this.getGLInternalFormat(t.format),this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),r.data[s]):e.texImage2D(this.getGLCubeMapFace(o),0,this.getGLInternalFormat(t.format),t.width,t.height,0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),null)}r&&t.generateMipmaps&&!r.isCompressed&&e.generateMipmap(w.TEXTURE_CUBE_MAP)}},E.prototype.preloadTextures=function(e,t){var n=this.context,s=Object.keys(e._textureMaps);s.forEach(function(s){var o=e.getTexture(s);if(o===undefined)return;var u=o;o instanceof Array==0&&(u=[o]),u.forEach(function(e){if(!e)return;t.push(function(){e instanceof i==0&&(e.image===undefined||e.checkDataReady()===!1)&&(e.variant==="2D"?e=r.DEFAULT_TEXTURE_2D:e.variant==="CUBE"&&(e=r.DEFAULT_TEXTURE_CUBE)),e.glTexture===null?(e.glTexture=n.createTexture(),this.preloadTexture(n,e),e.needsUpdate=!1):e instanceof i==0&&e.checkNeedsUpdate()&&(this.preloadTexture(n,e),e.needsUpdate=!1)}.bind(this))}.bind(this))}.bind(this))};var x=new y;E.prototype.preloadMaterials=function(e){var t=[],n=x;n.reset();if(Array.isArray(e))for(var r=0;r<e.length;r++){var i=e[r];if(i.isSkybox&&this._overrideMaterials.length>0)continue;n.fill(i);for(var s=0;s<n.materials.length;s++)this.preloadTextures(n.materials[s],t)}else{n.fill(e);for(var s=0;s<n.materials.length;s++)this.preloadTextures(n.materials[s],t)}return g.each(t)},E.prototype.precompileShader=function(e,t,n){var r=e.shader;r.updateProcessors(t),this.findOrCacheMaterialShader(e,t),r=e.shader,r.precompile(this)},E.prototype.clearShaderCache=function(){this.rendererRecord.shaderCache.clear()},E.prototype.precompileShaders=function(e,t){var n=new y;t&&(n.lights=t);var r=[];if(Array.isArray(e))for(var i=0;i<e.length;i++){var s=e[i];if(s.isSkybox&&this._overrideMaterials.length>0)continue;n.fill(s);for(var o=0;o<n.materials.length;o++)n.material=n.materials[o],this.precompileShader(n.materials[o],n,r)}else{n.fill(e);for(var o=0;o<n.materials.length;o++)n.material=n.materials[o],this.precompileShader(n.materials[o],n,r)}return g.each(r)},E.prototype.preloadBuffers=function(e){var t=new y;if(Array.isArray(e))for(var n=0;n<e.length;n++){var r=e[n];if(r.isSkybox&&this._overrideMaterials.length>0)continue;t.fill(r);for(var i=0;i<t.materials.length;i++)t.material=t.materials[i],this.preloadBuffer(r,t.materials[i],t)}else{t.fill(e);for(var i=0;i<t.materials.length;i++)t.material=t.materials[i],this.preloadBuffer(e,t.materials[i],t)}},E.prototype.preloadBuffer=function(e,t,n){var r=n.meshData;if(r.vertexData===null||r.vertexData!==null&&r.vertexData.data.byteLength===0||r.indexData!==null&&r.indexData.data.byteLength===0)return;this.bindData(r.vertexData),r.getIndexBuffer()!==null&&this.bindData(r.getIndexData());var i=n.materials,s=null,o=r,u=0;this._overrideMaterials.length===0?u=i.length:u=this._overrideMaterials.length;for(var a=0;a<u;a++){var t=null,f=null;a<i.length&&(t=i[a]),a<this._overrideMaterials.length&&(f=this._overrideMaterials[a]),t&&f?(this._override(f,t,this._mergedMaterial),t=this._mergedMaterial):f&&(t=f);if(!t.shader){t.errorOnce||(console.warn("No shader set on material: "+t.name),t.errorOnce=!0);continue}t.errorOnce=!1,t.wireframe&&s!=="wire"?(r.wireframeData||(r.wireframeData=r.buildWireframeData()),r=r.wireframeData,this.bindData(r.vertexData),s="wire"):t.flat&&s!=="flat"?(r.flatMeshData||(r.flatMeshData=r.buildFlatMeshData()),r=r.flatMeshData,this.bindData(r.vertexData),s="flat"):!t.wireframe&&!t.flat&&s!==null&&(r=o,this.bindData(r.vertexData),s=null)}};var T=new y;return E.prototype.render=function(e,t,r,i,s,o){o?this._overrideMaterials=o instanceof Array?o:[o]:this._overrideMaterials=[];if(!t)return;E.mainCamera===null&&(E.mainCamera=t),this.setRenderTarget(i),s===undefined||s===null||s===!0?this.clear():typeof s=="object"&&this.clear(s.color,s.depth,s.stencil),this.rendererRecord.shaderCache.forEach(function(e){e.startFrame()});var u=T;u.reset(),u.camera=t,u.mainCamera=E.mainCamera,u.lights=r,u.shadowHandler=this.shadowHandler,u.renderer=this;if(Array.isArray(e)){this.renderQueue.sort(e,t);for(var a=0;a<e.length;a++){var f=e[a];if(f.isSkybox&&this._overrideMaterials.length>0)continue;u.fill(f),this.renderMesh(u)}}else u.fill(e),this.renderMesh(u);i&&i.generateMipmaps&&n.isPowerOfTwo(i.width)&&n.isPowerOfTwo(i.height)&&this.updateRenderTargetMipmap(i)},E.prototype._override=function(e,t,n){n.empty();var r=Object.keys(n);for(var i=0,s=r.length;i<s;i++){var o=r[i],u=n[o],a=e[o],f=t[o];if(u instanceof Object&&o!=="shader"){var l=Object.keys(a);for(var c=0,h=l.length;c<h;c++){var p=l[c];u[p]=a[p]}var l=Object.keys(f);for(var c=0,h=l.length;c<h;c++){var p=l[c];u[p]===undefined&&(u[p]=f[p])}}else a!==undefined?n[o]=a:n[o]=f}},E.prototype.renderMesh=function(e){var t=e.meshData;if(!t||t.vertexData===null||t.vertexData!==null&&t.vertexData.data.byteLength===0||t.indexData!==null&&t.indexData.data.byteLength===0)return;this.bindData(t.vertexData),t._attributeDataNeedsRefresh&&(t._dirtyAttributeNames.forEach(function(e){this.updateAttributeData(t.dataViews[e],t.attributeMap[e].offset)}.bind(this)),t._attributeDataNeedsRefresh=!1,t._dirtyAttributeNames.clear());var n=e.materials,r=null,i=t,s=0;this._overrideMaterials.length===0?s=n.length:s=this._overrideMaterials.length;for(var o=0;o<s;o++)this.renderMeshMaterial(o,n,r,i,e)},E.prototype.callShaderProcessors=function(e,t){e.shader.updateProcessors(t),this.findOrCacheMaterialShader(e,t)},E.prototype.renderMeshMaterial=function(e,t,n,r,i){var s=null,o=null;e<t.length&&(s=t[e]),e<this._overrideMaterials.length&&(o=this._overrideMaterials[e]),s=this.configureRenderInfo(i,e,s,o,r,n);var u=i.meshData;this.callShaderProcessors(s,i),s.shader.apply(i,this),this.updateDepthTest(s),this.updateCulling(s),this.updateBlending(s),this.updateOffset(s),this.updateTextures(s),this.updateLineAndPointSettings(s),this._checkDualTransparency(s,u),this.updateCulling(s),this._drawBuffers(u),this.info.calls++,this.info.vertices+=u.vertexCount,this.info.indices+=u.indexCount},E.prototype._drawBuffers=function(e){e.getIndexBuffer()!==null?(this.bindData(e.getIndexData()),e.getIndexLengths()!==null?this.drawElementsVBO(e.getIndexBuffer(),e.getIndexModes(),e.getIndexLengths()):this.drawElementsVBO(e.getIndexBuffer(),e.getIndexModes(),[e.getIndexBuffer().length])):e.getIndexLengths()!==null?this.drawArraysVBO(e.getIndexModes(),e.getIndexLengths()):this.drawArraysVBO(e.getIndexModes(),[e.vertexCount])},E.prototype.configureRenderInfo=function(e,t,n,r,i,s){var o=e.meshData;t<this._overrideMaterials.length&&(r=this._overrideMaterials[t]),n&&r&&r.fullOverride!==!0?(this._override(r,n,this._mergedMaterial),n=this._mergedMaterial):r&&(n=r);if(!n.shader){n.errorOnce||(console.warn("No shader set on material: "+n.name),n.errorOnce=!0);return}return n.errorOnce=!1,n.wireframe&&s!=="wire"?(o.wireframeData||(o.wireframeData=o.buildWireframeData()),o=o.wireframeData,this.bindData(o.vertexData),s="wire"):n.flat&&s!=="flat"?(o.flatMeshData||(o.flatMeshData=o.buildFlatMeshData()),o=o.flatMeshData,this.bindData(o.vertexData),s="flat"):!n.wireframe&&!n.flat&&s!==null&&(o=i,this.bindData(o.vertexData),s=null),e.material=n,e.meshData=o,n},E.prototype.findOrCacheMaterialShader=function(e,t){var n=e.shader,r=n.getDefineKey(this._definesIndices);n.endFrame();var i=this.rendererRecord.shaderCache,s=i.get(r);if(s){if(s!==e.shader){var o=e.shader.uniforms,u=Object.keys(o);for(var a=0,f=u.length;a<f;a++){var l=u[a],c=s.uniforms[l]=o[l];c instanceof Array&&(s.uniforms[l]=c.slice(0))}}e.shader=s}else n.builder&&n.builder(n,t),n=n.clone(),i.set(r,n),e.shader=n},E.prototype._checkDualTransparency=function(e,t){if(e.dualTransparency){var n=e.cullState.cullFace,r=n==="Front"?"Back":"Front";e.cullState.cullFace=r,this.updateCulling(e),this._drawBuffers(t),e.cullState.cullFace=n}},E.prototype.readPixels=function(e,t,n,r,i){return i=i||new Uint8Array(n*r*4),this.context.readPixels(e,t,n,r,w.RGBA,w.UNSIGNED_BYTE,i),i},E.prototype.readTexturePixels=function(e,t,n,r,i,s){s=s||new Uint8Array(r*i*4);var o=this.context.createFramebuffer();return this.context.bindFramebuffer(w.FRAMEBUFFER,o),this.context.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_2D,e.glTexture,0),this.context.checkFramebufferStatus(w.FRAMEBUFFER)===w.FRAMEBUFFER_COMPLETE&&this.context.readPixels(t,n,r,i,w.RGBA,w.UNSIGNED_BYTE,s),s},E.prototype.drawElementsVBO=function(e,t,n){var r=0,i=0,s=e.type=e.type||this.getGLArrayType(e),o=this.getGLByteSize(e);for(var u=0;u<n.length;u++){var a=n[u],f=this.getGLIndexMode(t[i]);this.context.drawElements(f,a,s,r*o),r+=a,i<t.length-1&&i++}},E.prototype.drawArraysVBO=function(e,t){var n=0,r=0;for(var i=0;i<t.length;i++){var s=t[i],o=this.getGLIndexMode(e[r]);this.context.drawArrays(o,n,s),n+=s,r<e.length-1&&r++}},E.prototype.renderToPick=function(e,t,n,r,o,u,a,f,c){if(this.viewportWidth*this.viewportHeight===0)return;var h=4;if(this.hardwarePicking===null){var d=l.createEmptyMaterial(p.pickingShader,"pickingMaterial");d.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},d.wireframe=!1,this.hardwarePicking={pickingTarget:new i(this.viewportWidth/h,this.viewportHeight/h,{minFilter:"NearestNeighborNoMipMaps",magFilter:"NearestNeighbor"}),pickingMaterial:d,pickingBuffer:new Uint8Array(4),clearColorStore:new s},r=!1}else this.hardwarePicking.pickingTarget===null&&(this.hardwarePicking.pickingTarget=new i(this.viewportWidth/h,this.viewportHeight/h,{minFilter:"NearestNeighborNoMipMaps",magFilter:"NearestNeighbor"}),r=!1);if(!r){this.hardwarePicking.clearColorStore.setVector(this.clearColor);if(o&&u!==undefined&&a!==undefined){var v=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,m=Math.floor((u*v-this.viewportX)/h),g=Math.floor((this.viewportHeight-(a*v-this.viewportY))/h);this.context.enable(w.SCISSOR_TEST),this.context.scissor(m,g,1,1)}var y=[];for(var b=0,E=e.length;b<E;b++){var S=e[b];(!S.meshRendererComponent||S.meshRendererComponent.isPickable)&&y.push(S)}c?this.render(y,t,[],this.hardwarePicking.pickingTarget,n):this.render(y,t,[],this.hardwarePicking.pickingTarget,n,f||this.hardwarePicking.pickingMaterial),o&&this.context.disable(w.SCISSOR_TEST)}else this.setRenderTarget(this.hardwarePicking.pickingTarget)},E.prototype.pick=function(e,t,n,r){if(this.viewportWidth*this.viewportHeight===0){n.id=-1,n.depth=0;return}var i=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,s=4,o=Math.floor((e*i-this.viewportX)/s),u=Math.floor((this.viewportHeight-(t*i-this.viewportY))/s);this.readPixels(o,u,1,1,this.hardwarePicking.pickingBuffer);var a=this.hardwarePicking.pickingBuffer[0]*255+this.hardwarePicking.pickingBuffer[1]-1,f=(this.hardwarePicking.pickingBuffer[2]/255+this.hardwarePicking.pickingBuffer[3]/65025)*r.far;n.id=a,n.depth=f},E.prototype.updateLineAndPointSettings=function(e){var t=this.rendererRecord.lineRecord,n=e.lineWidth||1;t.lineWidth!==n&&(this.context.lineWidth(n),t.lineWidth=n)},E.prototype.updateDepthTest=function(e){var t=this.rendererRecord.depthRecord,n=e.depthState;t.enabled!==n.enabled&&(n.enabled?this.context.enable(w.DEPTH_TEST):this.context.disable(w.DEPTH_TEST),t.enabled=n.enabled),t.write!==n.write&&(n.write?this.context.depthMask(!0):this.context.depthMask(!1),t.write=n.write)},E.prototype.updateCulling=function(e){var t=this.rendererRecord.cullRecord,n=e.cullState.cullFace,r=e.cullState.frontFace,i=e.cullState.enabled;t.enabled!==i&&(i?this.context.enable(w.CULL_FACE):this.context.disable(w.CULL_FACE),t.enabled=i);if(t.cullFace!==n){var s=n==="Front"?w.FRONT:n==="Back"?w.BACK:w.FRONT_AND_BACK;this.context.cullFace(s),t.cullFace=n}if(t.frontFace!==r){switch(r){case"CCW":this.context.frontFace(w.CCW);break;case"CW":this.context.frontFace(w.CW)}t.frontFace=r}},E.prototype.updateTextures=function(e){var t=this.context,s=e.shader.textureSlots;for(var o=0;o<s.length;o++){var u=s[o],a=e.getTexture(u.mapping);if(a===undefined)continue;var f=a;a instanceof Array==0&&(f=[a]);for(var l=0;l<f.length;l++){a=f[l];var c=u.index instanceof Array?u.index[l]:u.index;if(a===null||a instanceof i==0&&(a.image===undefined||a.checkDataReady()===!1))u.format==="sampler2D"?a=r.DEFAULT_TEXTURE_2D:u.format==="samplerCube"&&(a=r.DEFAULT_TEXTURE_CUBE);var h=this.rendererRecord.textureRecord[c];h===undefined&&(h=this.rendererRecord.textureRecord[c]={}),a.glTexture===null?(a.glTexture=t.createTexture(),this.updateTexture(t,a,c,h),a.needsUpdate=!1):a instanceof i==0&&a.checkNeedsUpdate()?(this.updateTexture(t,a,c,h),a.needsUpdate=!1):this.bindTexture(t,a,c,h);var p=a.image!==undefined?a.image:a,d=n.isPowerOfTwo(p.width)&&n.isPowerOfTwo(p.height);this.updateTextureParameters(a,d)}}},E.prototype.updateTextureParameters=function(t,n){var r=this.context,i=t.textureRecord,s=this.getGLType(t.variant);i.magFilter!==t.magFilter&&(r.texParameteri(s,w.TEXTURE_MAG_FILTER,this.getGLMagFilter(t.magFilter)),i.magFilter=t.magFilter);var o=n?t.minFilter:this.getFilterFallback(t.minFilter);i.minFilter!==o&&(r.texParameteri(s,w.TEXTURE_MIN_FILTER,this.getGLMinFilter(o)),i.minFilter=o);var u=n?t.wrapS:"EdgeClamp";if(i.wrapS!==u){var a=this.getGLWrap(u,r);r.texParameteri(s,w.TEXTURE_WRAP_S,a),i.wrapS=u}var f=n?t.wrapT:"EdgeClamp";if(i.wrapT!==f){var l=this.getGLWrap(f,r);r.texParameteri(s,w.TEXTURE_WRAP_T,l),i.wrapT=f}if(e.TextureFilterAnisotropic&&t.type!=="Float"){var c=t.anisotropy;i.anisotropy!==c&&(r.texParameterf(s,e.TextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(c,e.maxAnisotropy)),i.anisotropy=c)}},E.prototype.bindTexture=function(e,t,n,r){if(r.boundTexture===undefined||t.glTexture!==undefined&&r.boundTexture!==t.glTexture)e.activeTexture(w.TEXTURE0+n),e.bindTexture(this.getGLType(t.variant),t.glTexture),r.boundTexture=t.glTexture},E.prototype.unbindTexture=function(e,t,n,r){e.activeTexture(w.TEXTURE0+n),e.bindTexture(this.getGLType(t.variant),null),r.boundTexture=undefined},E.prototype.getGLType=function(e){switch(e){case"2D":return w.TEXTURE_2D;case"CUBE":return w.TEXTURE_CUBE_MAP}throw"invalid texture type: "+e},E.prototype.loadCompressedTexture=function(t,n,r,i){var s=r.image.mipmapSizes,o=0,u=0,a=r.image.width,f=r.image.height,l=e.CompressedTextureS3TC,c=l.COMPRESSED_RGBA_S3TC_DXT5_EXT;if(r.format==="PrecompressedDXT1")c=l.COMPRESSED_RGB_S3TC_DXT1_EXT;else if(r.format==="PrecompressedDXT1A")c=l.COMPRESSED_RGBA_S3TC_DXT1_EXT;else if(r.format==="PrecompressedDXT3")c=l.COMPRESSED_RGBA_S3TC_DXT3_EXT;else{if(r.format!=="PrecompressedDXT5")throw new Error("Unhandled compression format: "+i.getDataFormat().name());c=l.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(typeof s=="undefined"||s===null)i instanceof Uint8Array?t.compressedTexImage2D(n,0,c,a,f,0,i):t.compressedTexImage2D(n,0,c,a,f,0,new Uint8Array(i.buffer,i.byteOffset,i.byteLength));else{r.generateMipmaps=!1;if(i instanceof Array)for(var h=0;h<i.length;h++)t.compressedTexImage2D(n,h,c,a,f,0,i[h]),a=~~(a/2)>1?~~(a/2):1,f=~~(f/2)>1?~~(f/2):1;else for(var h=0;h<s.length;h++)u=s[h],t.compressedTexImage2D(n,h,c,a,f,0,new Uint8Array(i.buffer,i.byteOffset+o,u)),a=~~(a/2)>1?~~(a/2):1,f=~~(f/2)>1?~~(f/2):1,o+=u;var p=1+Math.ceil(Math.log(Math.max(r.image.height,r.image.width))/Math.log(2)),d=s[s.length-1];if(s.length<p)for(var h=s.length;h<p;h++)d=~~((a+3)/4)*~~((f+3)/4)*r.image.bpp*2,t.compressedTexImage2D(n,h,c,a,f,0,new Uint8Array(d)),a=~~(a/2)>1?~~(a/2):1,f=~~(f/2)>1?~~(f/2):1}},E.prototype.updateTexture=function(e,t,r,i){e.activeTexture(w.TEXTURE0+r),e.bindTexture(this.getGLType(t.variant),t.glTexture),i.boundTexture=t.glTexture,e.pixelStorei(w.UNPACK_ALIGNMENT,t.unpackAlignment),e.pixelStorei(w.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),e.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,t.flipY);var s=t.image;if(t.variant==="2D")s?(!s.isCompressed&&(t.generateMipmaps||s.width>this.maxTextureSize||s.height>this.maxTextureSize)&&(this.checkRescale(t,s,s.width,s.height,this.maxTextureSize),s=t.image),s.isData===!0?s.isCompressed?this.loadCompressedTexture(e,w.TEXTURE_2D,t,s.data):e.texImage2D(w.TEXTURE_2D,0,this.getGLInternalFormat(t.format),s.width,s.height,t.hasBorder?1:0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),s.data):e.texImage2D(w.TEXTURE_2D,0,this.getGLInternalFormat(t.format),this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),s),t.generateMipmaps&&!s.isCompressed&&e.generateMipmap(w.TEXTURE_2D)):e.texImage2D(w.TEXTURE_2D,0,this.getGLInternalFormat(t.format),t.width,t.height,0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),null);else if(t.variant==="CUBE"){if(s&&!s.isData&&(t.generateMipmaps||s.width>this.maxCubemapSize||s.height>this.maxCubemapSize)){for(var o=0;o<u.CUBE_FACES.length;o++)s.data[o]&&!s.data[o].buffer?n.scaleImage(t,s.data[o],s.width,s.height,this.maxCubemapSize,o):n.getBlankImage(t,[.3,.3,.3,0],s.width,s.height,this.maxCubemapSize,o);t.image.width=Math.min(this.maxCubemapSize,n.nearestPowerOfTwo(t.image.width)),t.image.height=Math.min(this.maxCubemapSize,n.nearestPowerOfTwo(t.image.height)),s=t.image}for(var a=0;a<u.CUBE_FACES.length;a++){var f=u.CUBE_FACES[a];s?s.isData===!0?s.isCompressed?this.loadCompressedTexture(e,this.getGLCubeMapFace(f),t,s.data[a]):e.texImage2D(this.getGLCubeMapFace(f),0,this.getGLInternalFormat(t.format),s.width,s.height,t.hasBorder?1:0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),s.data[a]):e.texImage2D(this.getGLCubeMapFace(f),0,this.getGLInternalFormat(t.format),this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),s.data[a]):e.texImage2D(this.getGLCubeMapFace(f),0,this.getGLInternalFormat(t.format),t.width,t.height,0,this.getGLInternalFormat(t.format),this.getGLPixelDataType(t.type),null)}s&&t.generateMipmaps&&!s.isCompressed&&e.generateMipmap(w.TEXTURE_CUBE_MAP)}},E.prototype.checkRescale=function(e,t,r,i,s,o){n.scaleImage(e,t,r,i,s,o)},E.prototype.getGLWrap=function(e){switch(e){case"Repeat":return w.REPEAT;case"MirroredRepeat":return w.MIRRORED_REPEAT;case"EdgeClamp":return w.CLAMP_TO_EDGE}throw"invalid WrapMode type: "+e},E.prototype.getGLInternalFormat=function(e){switch(e){case"RGBA":return w.RGBA;case"RGB":return w.RGB;case"Alpha":return w.ALPHA;case"Luminance":return w.LUMINANCE;case"LuminanceAlpha":return w.LUMINANCE_ALPHA;default:throw"Unsupported format: "+e}},E.prototype.getGLPixelDataType=function(e){switch(e){case"UnsignedByte":return w.UNSIGNED_BYTE;case"UnsignedShort565":return w.UNSIGNED_SHORT_5_6_5;case"UnsignedShort4444":return w.UNSIGNED_SHORT_4_4_4_4;case"UnsignedShort5551":return w.UNSIGNED_SHORT_5_5_5_1;case"Float":return w.FLOAT;default:throw"Unsupported type: "+e}},E.prototype.getFilterFallback=function(e){switch(e){case"NearestNeighborNoMipMaps":case"NearestNeighborNearestMipMap":case"NearestNeighborLinearMipMap":return"NearestNeighborNoMipMaps";case"BilinearNoMipMaps":case"Trilinear":case"BilinearNearestMipMap":return"BilinearNoMipMaps";default:return"NearestNeighborNoMipMaps"}},E.prototype.getGLMagFilter=function(e){switch(e){case"Bilinear":return w.LINEAR;case"NearestNeighbor":return w.NEAREST}throw"invalid MagnificationFilter type: "+e},E.prototype.getGLMinFilter=function(e){switch(e){case"BilinearNoMipMaps":return w.LINEAR;case"Trilinear":return w.LINEAR_MIPMAP_LINEAR;case"BilinearNearestMipMap":return w.LINEAR_MIPMAP_NEAREST;case"NearestNeighborNoMipMaps":return w.NEAREST;case"NearestNeighborNearestMipMap":return w.NEAREST_MIPMAP_NEAREST;case"NearestNeighborLinearMipMap":return w.NEAREST_MIPMAP_LINEAR}throw"invalid MinificationFilter type: "+e},E.prototype.getGLBufferTarget=function(e){return e==="ElementArrayBuffer"?w.ELEMENT_ARRAY_BUFFER:w.ARRAY_BUFFER},E.prototype.getGLArrayType=function(e){return e instanceof Uint8Array?w.UNSIGNED_BYTE:e instanceof Uint16Array?w.UNSIGNED_SHORT:e instanceof Uint32Array?w.UNSIGNED_INT:e instanceof Int8Array?w.UNSIGNED_BYTE:e instanceof Int16Array?w.UNSIGNED_SHORT:e instanceof Int32Array?w.UNSIGNED_INT:null},E.prototype.getGLByteSize=function(e){return e instanceof Uint8Array?1:e instanceof Uint16Array?2:e instanceof Uint32Array?4:e instanceof Int8Array?1:e instanceof Int16Array?2:e instanceof Int32Array?4:1},E.prototype.getGLCubeMapFace=function(e){switch(e){case"PositiveX":return w.TEXTURE_CUBE_MAP_POSITIVE_X;case"NegativeX":return w.TEXTURE_CUBE_MAP_NEGATIVE_X;case"PositiveY":return w.TEXTURE_CUBE_MAP_POSITIVE_Y;case"NegativeY":return w.TEXTURE_CUBE_MAP_NEGATIVE_Y;case"PositiveZ":return w.TEXTURE_CUBE_MAP_POSITIVE_Z;case"NegativeZ":return w.TEXTURE_CUBE_MAP_NEGATIVE_Z}throw"Invalid cubemap face: "+e},E.prototype.getGLBufferUsage=function(e){var t=w.STATIC_DRAW;switch(e){case"StaticDraw":t=w.STATIC_DRAW;break;case"DynamicDraw":t=w.DYNAMIC_DRAW;break;case"StreamDraw":t=w.STREAM_DRAW}return t},E.prototype.getGLIndexMode=function(e){var t=w.TRIANGLES;switch(e){case"Triangles":t=w.TRIANGLES;break;case"TriangleStrip":t=w.TRIANGLE_STRIP;break;case"TriangleFan":t=w.TRIANGLE_FAN;break;case"Lines":t=w.LINES;break;case"LineStrip":t=w.LINE_STRIP;break;case"LineLoop":t=w.LINE_LOOP;break;case"Points":t=w.POINTS}return t},E.prototype.updateBlending=function(e){var t=this.rendererRecord.blendRecord,n=this.context,r=e.blendState.blending;r!==t.blending&&(r==="NoBlending"?n.disable(w.BLEND):r==="AdditiveBlending"?(n.enable(w.BLEND),n.blendEquation(w.FUNC_ADD),n.blendFunc(w.SRC_ALPHA,w.ONE)):r==="SubtractiveBlending"?(n.enable(w.BLEND),n.blendEquation(w.FUNC_REVERSE_SUBTRACT),n.blendFunc(w.SRC_ALPHA,w.ONE)):r==="MultiplyBlending"?(n.enable(w.BLEND),n.blendEquation(w.FUNC_ADD),n.blendFunc(w.DST_COLOR,w.ONE_MINUS_SRC_ALPHA)):r==="AlphaBlending"?(n.enable(w.BLEND),n.blendEquation(w.FUNC_ADD),n.blendFunc(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA)):r==="TransparencyBlending"?(n.enable(w.BLEND),n.blendEquationSeparate(w.FUNC_ADD,w.FUNC_ADD),n.blendFuncSeparate(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA,w.ONE,w.ONE_MINUS_SRC_ALPHA)):r==="CustomBlending"?n.enable(w.BLEND):r==="SeparateBlending"?(n.enable(w.BLEND),n.blendEquationSeparate(this.getGLBlendParam(e.blendState.blendEquationColor),this.getGLBlendParam(e.blendState.blendEquationAlpha)),n.blendFuncSeparate(this.getGLBlendParam(e.blendState.blendSrcColor),this.getGLBlendParam(e.blendState.blendDstColor),this.getGLBlendParam(e.blendState.blendSrcAlpha),this.getGLBlendParam(e.blendState.blendDstAlpha))):(n.enable(w.BLEND),n.blendEquationSeparate(w.FUNC_ADD,w.FUNC_ADD),n.blendFuncSeparate(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA,w.ONE,w.ONE_MINUS_SRC_ALPHA)),t.blending=r);if(r==="CustomBlending"){var i=e.blendState.blendEquation,s=e.blendState.blendSrc,o=e.blendState.blendDst;i!==t.blendEquation&&(n.blendEquation(this.getGLBlendParam(i)),t.blendEquation=i);if(s!==t.blendSrc||o!==t.blendDst)n.blendFunc(this.getGLBlendParam(s),this.getGLBlendParam(o)),t.blendSrc=s,t.blendDst=o}else t.blendEquation=null,t.blendSrc=null,t.blendDst=null},E.prototype.updateOffset=function(e){var t=this.rendererRecord.offsetRecord,n=this.context,r=e.offsetState.enabled,i=e.offsetState.factor,s=e.offsetState.units;t.enabled!==r&&(r?n.enable(w.POLYGON_OFFSET_FILL):n.disable(w.POLYGON_OFFSET_FILL),t.enabled=r),r&&(t.factor!==i||t.units!==s)&&(n.polygonOffset(i,s),t.factor=i,t.units=s)},E.prototype.setBoundBuffer=function(e,t){var n=this.rendererRecord.currentBuffer[t];if(!n.valid||n.buffer!==e)this.context.bindBuffer(this.getGLBufferTarget(t),e),n.buffer=e,n.valid=!0,t==="ArrayBuffer"&&(this.rendererRecord.attributeCache.length=0)},E.prototype.bindVertexAttribute=function(e,t){var n=this.rendererRecord.attributeCache[e];n!==t.hashKey&&(this.context.vertexAttribPointer(e,t.count,this.getGLDataType(t.type),t.normalized,t.stride,t.offset),this.rendererRecord.attributeCache[e]=t.hashKey)},E.prototype.getGLDataType=function(e){switch(e){case"Float":case"HalfFloat":case"Double":return w.FLOAT;case"Byte":return w.BYTE;case"UnsignedByte":return w.UNSIGNED_BYTE;case"Short":return w.SHORT;case"UnsignedShort":return w.UNSIGNED_SHORT;case"Int":return w.INT;case"UnsignedInt":return w.UNSIGNED_INT;default:throw"Unknown datatype: "+e}},E.prototype.getGLBlendParam=function(e){switch(e){case"AddEquation":return w.FUNC_ADD;case"SubtractEquation":return w.FUNC_SUBTRACT;case"ReverseSubtractEquation":return w.FUNC_REVERSE_SUBTRACT;case"ZeroFactor":return w.ZERO;case"OneFactor":return w.ONE;case"SrcColorFactor":return w.SRC_COLOR;case"OneMinusSrcColorFactor":return w.ONE_MINUS_SRC_COLOR;case"SrcAlphaFactor":return w.SRC_ALPHA;case"OneMinusSrcAlphaFactor":return w.ONE_MINUS_SRC_ALPHA;case"DstAlphaFactor":return w.DST_ALPHA;case"OneMinusDstAlphaFactor":return w.ONE_MINUS_DST_ALPHA;case"DstColorFactor":return w.DST_COLOR;case"OneMinusDstColorFactor":return w.ONE_MINUS_DST_COLOR;case"SrcAlphaSaturateFactor":return w.SRC_ALPHA_SATURATE;default:throw"Unknown blend param: "+e}},E.prototype.clear=function(e,t,n){var r=0;if(e===undefined||e)r|=w.COLOR_BUFFER_BIT;if(t===undefined||t)r|=w.DEPTH_BUFFER_BIT;if(n===undefined||n)r|=w.STENCIL_BUFFER_BIT;var i=this.rendererRecord.depthRecord;i.write!==!0&&(this.context.depthMask(!0),i.write=!0),r&&this.context.clear(r)},E.prototype.flush=function(){this.context.flush()},E.prototype.finish=function(){this.context.finish()},E.prototype.setupFrameBuffer=function(e,t,n){this.context.bindFramebuffer(w.FRAMEBUFFER,e),this.context.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,n,t.glTexture,0)},E.prototype.setupRenderBuffer=function(e,t){this.context.bindRenderbuffer(w.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(this.context.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_COMPONENT16,t.width,t.height),this.context.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(this.context.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_STENCIL,t.width,t.height),this.context.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_STENCIL_ATTACHMENT,w.RENDERBUFFER,e)):this.context.renderbufferStorage(w.RENDERBUFFER,w.RGBA4,t.width,t.height)},E.prototype.setRenderTarget=function(e){if(e&&!e._glFrameBuffer){e.depthBuffer===undefined&&(e.depthBuffer=!0),e.stencilBuffer===undefined&&(e.stencilBuffer=!0),e.glTexture=this.context.createTexture();var t=n.isPowerOfTwo(e.width)&&n.isPowerOfTwo(e.height),r=this.getGLInternalFormat(e.format),i=this.getGLDataType(e.type);e._glFrameBuffer=this.context.createFramebuffer(),e._glRenderBuffer=this.context.createRenderbuffer(),this.context.bindTexture(w.TEXTURE_2D,e.glTexture),this.updateTextureParameters(e,t),this.context.texImage2D(w.TEXTURE_2D,0,r,e.width,e.height,0,r,i,null),this.setupFrameBuffer(e._glFrameBuffer,e,w.TEXTURE_2D),this.setupRenderBuffer(e._glRenderBuffer,e),e.generateMipmaps&&t&&this.context.generateMipmap(w.TEXTURE_2D),this.context.bindTexture(w.TEXTURE_2D,null),this.context.bindRenderbuffer(w.RENDERBUFFER,null),this.context.bindFramebuffer(w.FRAMEBUFFER,null)}var s,o,u,a,f;e?(s=e._glFrameBuffer,a=0,f=0,o=e.width,u=e.height):(s=null,a=this.viewportX,f=this.viewportY,o=this.viewportWidth,u=this.viewportHeight),s!==this.rendererRecord.currentFrameBuffer&&(this.context.bindFramebuffer(w.FRAMEBUFFER,s),this.context.viewport(a,f,o,u),this.rendererRecord.currentFrameBuffer=s,this.rendererRecord.textureRecord=[]),this.currentWidth=o,this.currentHeight=u},E.prototype.updateRenderTargetMipmap=function(e){this.context.bindTexture(w.TEXTURE_2D,e.glTexture),this.context.generateMipmap(w.TEXTURE_2D),this.context.bindTexture(w.TEXTURE_2D,null)},E.prototype._deallocateMeshData=function(e){e.destroy(this.context)},E.prototype._deallocateTexture=function(e){e.destroy(this.context)},E.prototype._deallocateRenderTarget=function(e){e.destroy(this.context)},E.prototype._deallocateShader=function(e){e.destroy()},E}),define("goo/particles/ParticleEmitter",["goo/particles/ParticleUtils","goo/renderer/Renderer"],function(e,t){function n(t){t=t||{},this.totalParticlesToSpawn=isNaN(t.totalParticlesToSpawn)?-1:t.totalParticlesToSpawn,this.maxLifetime=isNaN(t.maxLifetime)?3:t.maxLifetime,this.minLifetime=isNaN(t.minLifetime)?2:t.minLifetime,this.timeline=t.timeline?t.timeline:undefined,this.influences=t.influences?t.influences:[],this.getEmissionPoint=t.getEmissionPoint?t.getEmissionPoint:function(t,n){var r=t.position;return r.setDirect(0,0,0),e.applyEntityTransformPoint(r,n)},this.getEmissionVelocity=t.getEmissionVelocity?t.getEmissionVelocity:function(t,n){var r=t.velocity;return r.setDirect(0,1,0),e.applyEntityTransformVector(r,n)},this.getParticleBillboardVectors=t.getParticleBillboardVectors?t.getParticleBillboardVectors:n.CAMERA_BILLBOARD_FUNC,this.releaseRatePerSecond=isNaN(t.releaseRatePerSecond)?10:t.releaseRatePerSecond,this.particlesWaitingToRelease=0,this.enabled=t.enabled!==undefined?t.enabled===!0:!0}return n.CAMERA_BILLBOARD_FUNC=function(e){var n=t.mainCamera;n&&(e.bbX.setVector(n._left),e.bbY.setVector(n._up))},n.prototype.nextParticleLifeSpan=function(){return this.minLifetime+(this.maxLifetime-this.minLifetime)*Math.random()},n}),define("goo/entities/components/ParticleComponent",["goo/entities/components/Component","goo/particles/Particle","goo/particles/ParticleEmitter","goo/renderer/MeshData"],function(e,t,n,r){function i(t){e.apply(this,arguments),this.type="ParticleComponent",e.call(this),t=t||{},this.emitters=[];if(t.emitters)for(var r=0,i=t.emitters.length;r<i;r++)this.emitters.push(new n(t.emitters[r]));this.timeline=t.timeline?t.timeline:[],this.uRange=isNaN(t.uRange)?1:t.uRange,this.vRange=isNaN(t.vRange)?1:t.vRange;var s=isNaN(t.particleCount)?100:t.particleCount;this.recreateParticles(s),this.enabled=!0,Object.seal(this)}return i.type="ParticleComponent",i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.generateMeshData=function(){var e=r.defaultMap([r.POSITION,r.COLOR,r.TEXCOORD0]);this.meshData=new r(e,this.particleCount*4,this.particleCount*6),this.meshData.vertexData.setDataUsage("DynamicDraw");var t=this.meshData.getAttributeBuffer(r.TEXCOORD0),n=this.meshData.getIndexBuffer();for(var i=0,s=this.particleCount;i<s;i++)t.set([1,0],i*8+0),t.set([1,1],i*8+2),t.set([0,1],i*8+4),t.set([0,0],i*8+6),n.set([i*4+0,i*4+3,i*4+1,i*4+1,i*4+3,i*4+2],i*6)},i.prototype.recreateParticles=function(e){this.particleCount=e,this.particles=[];for(var n=0;n<this.particleCount;n++)this.particles[n]=new t(this,n);this.generateMeshData()},i}),define("goo/util/ParticleSystemUtils",["goo/entities/components/ParticleComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MeshDataComponent","goo/renderer/Texture","goo/particles/ParticleEmitter"],function(e,t,n,r,i){function s(){}return s.createParticleSystemEntity=function(r,s,o){var u=r.createEntity(),a=new e({particleCount:s.particleCount||500});a.emitters.push(new i(s)),u.setComponent(a);var f=new n(a.meshData);u.setComponent(f);var l=new t;return l.materials.push(o),l.cullMode="Never",u.setComponent(l),u},s.createFlareTexture=function(e,t){e=e||64,t=t||{},t.startRadius=typeof t.startRadius!="undefined"?t.startRadius:0,t.endRadius=typeof t.endRadius!="undefined"?t.endRadius:e/2,t.steps=t.steps||[{fraction:0,value:1},{fraction:1,value:0}];var n=document.createElement("canvas");n.width=e,n.height=e;var i=n.getContext("2d"),s=i.createRadialGradient(e/2,e/2,t.startRadius,e/2,e/2,t.endRadius);for(var o=0;o<t.steps.length;o++){var u=t.steps[o];s.addColorStop(u.fraction,"rgba(255, 255, 255, "+u.value+")")}i.fillStyle=s,i.fillRect(0,0,e,e);var a=i.getImageData(0,0,e,e).data;a=new Uint8Array(a);var f=new r(a,null,e,e);return f},s.createSplashTexture=function(e,t){function s(e,t,n){var r=i.createRadialGradient(e,t,0,e,t,n);r.addColorStop(0,"rgba(255, 255, 255, 0.5)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),i.fillStyle=r,i.fillRect(e-n,t-n,2*n,2*n)}function u(e,t,n,r,i,u){var a=(n-e)/o,f=(r-t)/o,l=(u-i)/o;for(var c=0,h=e,p=t,d=i;c<o;c++,h+=a,p+=f,d+=l)s(h,p,d)}function a(e,t,n,r,i,s,o){for(var a=0;a<o;a++){var f=Math.random()*Math.PI*2,l=Math.random()*4+n,c=Math.random()*4-r;u(e+Math.cos(f)*l,t+Math.sin(f)*l,e+Math.cos(f)*c,t+Math.sin(f)*c,i,s)}}e=e||64,t=t||{},t.nTrails=typeof t.nTrails!="undefined"?t.nTrails:8,t.trailStartRadius=typeof t.trailStartRadius!="undefined"?t.trailStartRadius:1,t.trailEndRadius=typeof t.trailEndRadius!="undefined"?t.trailEndRadius:4;var n=document.createElement("canvas");n.width=e,n.height=e;var i=n.getContext("2d"),o=30;a(e/2,e/2,e/2/10*1,e/2/10*9,t.trailStartRadius,t.trailEndRadius,t.nTrails);var f=i.getImageData(0,0,e,e).data;f=new Uint8Array(f);var l=new r(f,null,e,e);return l},s.createPlanktonTexture=function(e,t){function s(e,t,n){var r=i.createRadialGradient(e,t,0,e,t,n);r.addColorStop(0,"rgba(255, 255, 255, 1)"),r.addColorStop(.3,"rgba(255, 255, 255, 1)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),i.fillStyle=r,i.fillRect(e-n,t-n,2*n,2*n)}function o(n){for(var r=0;r<n;r++){var i=Math.random()*(e-t.maxRadius*2)+t.maxRadius,o=Math.random()*(e-t.maxRadius*2)+t.maxRadius;s(i,o,Math.random()*(t.maxRadius-t.minRadius)+t.minRadius)}}e=e||64,t=t||{},t.nPoints=typeof t.nPoints!="undefined"?t.nPoints:10,t.minRadius=typeof t.minRadius!="undefined"?t.minRadius:2,t.maxRadius=typeof t.maxRadius!="undefined"?t.maxRadius:5;var n=document.createElement("canvas");n.width=e,n.height=e;var i=n.getContext("2d");o(t.nPoints);var u=i.getImageData(0,0,e,e).data;u=new Uint8Array(u);var a=new r(u,null,e,e);return a},s.createSnowflakeTexture=function(e,t){function s(e,t){var n=2*Math.PI/e;for(var r=0;r<e;r++)i.rotate(n),t()}function o(){i.beginPath(),i.moveTo(0,0),i.lineTo(0,90);for(var e=0;e<6;e++)i.moveTo(0,25+e*10),i.lineTo(16-e*1.5,35+e*10),i.moveTo(0,25+e*10),i.lineTo(-(16-e*1.5),35+e*10);i.stroke()}e=e||64,t=t||{};var n=document.createElement("canvas");n.width=e,n.height=e;var i=n.getContext("2d");i.strokeStyle="#FFF",i.lineWidth=4,i.lineCap="round",i.translate(e/2,e/2),i.scale(e/100/2,e/100/2),s(7,o);var u=i.getImageData(0,0,e,e).data;u=new Uint8Array(u);var a=new r(u,null,e,e);return a},s}),define("goo/util/Snow",["goo/entities/SystemBus","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/TextureCreator","goo/particles/ParticleLib","goo/util/ParticleSystemUtils","goo/renderer/Renderer","goo/math/Vector3"],function(e,t,n,r,i,s,o,u){function a(e){this.velocity=10,this.height=25,this.material=new t(n.particles);var r=s.createFlareTexture(64);r.generateMipmaps=!0,this.material.setTexture("DIFFUSE_MAP",r),this.material.blendState.blending="AdditiveBlending",this.material.cullState.enabled=!1,this.material.depthState.write=!1,this.material.renderQueue=2002;var a=this;this.particleCloudEntity=s.createParticleSystemEntity(e.world,i.getSnow({getEmissionPoint:function(e){e.copy(o.mainCamera?o.mainCamera.translation:new u),e.data[0]+=Math.random()*1e3-500,e.data[1]+=a.height,e.data[2]+=Math.random()*1e3-500},getEmissionVelocity:function(e){e.data[0]=(Math.random()-.5)*2,e.data[1]=-(Math.random()+1)*a.velocity,e.data[2]=(Math.random()-.5)*2}}),this.material),this.particleCloudEntity.name="_ParticleSystemSnow",this.onCameraChange=function(e){e.entity.attachChild(this.particleCloudEntity)}.bind(this),this.particleCloudEntity.transformComponent.transform.translation.copy(o.mainCamera?o.mainCamera.translation:new u),this.particleCloudEntity.addToWorld()}return a.prototype.setEmissionVelocity=function(e){if(e){this.velocity=e;var t=this.particleCloudEntity.particleComponent,n=t.particles;for(var r=0;r<n.length;r++)n[r].velocity[1]=-(Math.random()+1)*this.velocity}},a.prototype.setEmissionHeight=function(e){e&&(this.height=e)},a.prototype.setReleaseRatePerSecond=function(e){if(e){var t=this.particleCloudEntity.particleComponent,n=t.emitters[0];n.releaseRatePerSecond=e}},a.prototype.remove=function(){this.particleCloudEntity.removeFromWorld()},a}),define("goo/loaders/handlers/EnvironmentHandler",["goo/loaders/handlers/ConfigHandler","goo/util/ObjectUtil","goo/entities/SystemBus","goo/renderer/shaders/ShaderBuilder","goo/util/Snow","goo/util/rsvp"],function(e,t,n,r,i,s){function a(){e.apply(this,arguments)}var o={backgroundColor:[.3,.3,.3,1],globalAmbient:[0,0,0],fog:{enabled:!1,color:[1,1,1],near:10,far:1e3}},u={volume:1,reverb:0,dopplerFactor:1,rolloffFactor:.4,maxDistance:100};return a.prototype=Object.create(e.prototype),a.prototype.constructor=a,e._registerClass("environment",a),a.prototype._prepare=function(e){t.defaults(e,o)},a.prototype._create=function(){return{weatherState:{}}},a.prototype._remove=function(e){var t=this._objects.get(e);this._objects.delete(e);if(!t)return;for(var i in t.weatherState)a.weatherHandlers[i].remove(t.weatherState);n.emit("goo.setClearColor",o.backgroundColor),r.CLEAR_COLOR=o.backgroundColor,r.GLOBAL_AMBIENT=o.globalAmbient.slice(0,3),r.USE_FOG=o.fog.enabled,r.FOG_COLOR=o.fog.color.slice(0,3),r.FOG_SETTINGS=[o.fog.near,o.fog.far];var s=this.world.getSystem("SoundSystem");s&&(s.updateConfig(u),s.setReverb(null))},a.prototype._update=function(i,o,u){var f=this;return e.prototype._update.call(this,i,o,u).then(function(e){if(!e)return;e.backgroundColor=o.backgroundColor.slice(0),e.globalAmbient=o.globalAmbient.slice(0,3),e.fog=t.deepClone(o.fog),n.emit("goo.setClearColor",e.backgroundColor),r.CLEAR_COLOR=e.backgroundColor,r.GLOBAL_AMBIENT=e.globalAmbient,r.USE_FOG=e.fog.enabled,r.FOG_COLOR=e.fog.color.slice(0,3),r.FOG_SETTINGS=[e.fog.near,o.fog.far];for(var i in o.weather){var l=a.weatherHandlers[i];l&&l.update.call(f,o.weather[i],e.weatherState)}var c=[];if(o.skyboxRef)e.skyboxRef=o.skyboxRef,c.push(f._load(o.skyboxRef,{reload:!0}));else if(e.skyboxRef){var h=f.updateObject(e.skyboxRef,null).then(function(){delete e.skyboxRef});c.push(h)}var p=f.world.getSystem("SoundSystem");if(o.sound&&p){p.updateConfig(o.sound);if(o.sound.reverbRef){var h=f._load(o.sound.reverbRef,u).then(function(e){p.setReverb(e._buffer)});c.push(h)}else p.setReverb(null)}return s.all(c).then(function(){return e})})},a.weatherHandlers={snow:{update:function(e,t){e.enabled?t.snow&&t.snow.enabled?(t.snow.snow.setEmissionVelocity(e.velocity),t.snow.snow.setReleaseRatePerSecond(e.rate),t.snow.snow.setEmissionHeight(e.height)):(t.snow=t.snow||{},t.snow.enabled=!0,t.snow.snow=new i(this.world.gooRunner)):t.snow&&t.snow.enabled&&(t.snow.snow.remove(),t.snow.enabled=!1,delete t.snow.snow)},remove:function(e){e.snow.snow&&(e.snow.snow.remove(),e.snow.enabled=!1,delete e.snow.snow)}}},a}),define("goo/util/Skybox",["goo/shapes/Box","goo/shapes/Sphere","goo/renderer/MeshData","goo/renderer/Material","goo/renderer/Shader","goo/renderer/TextureCreator","goo/math/Transform"],function(e,t,n,r,i,s,o){function u(n,f,l,c){var h;if(n===u.SPHERE)this.meshData=new t(48,48,1,l||t.TextureModes.Projected),f instanceof Array&&(f=f[0]),f&&(h=(new s).loadTexture2D(f));else{if(n!==u.BOX)throw new Error("Unknown geometry type");this.meshData=new e(1,1,1),f.length&&(h=(new s).loadTextureCube(f,{flipY:!1}))}var p=new r(a[n],"Skybox material");p.setTexture(i.DIFFUSE_MAP,h),p.cullState.cullFace="Front",p.depthState.enabled=!1,p.renderQueue=1,this.materials=[p],this.transform=new o;var d=n===u.SPHERE?Math.PI/2:0;this.transform.rotation.fromAngles(d,c,0),this.transform.update(),this.active=!0}u.SPHERE="sphere",u.BOX="box";var a={};return a.box={attributes:{vertexPosition:n.POSITION},uniforms:{viewMatrix:i.VIEW_MATRIX,projectionMatrix:i.PROJECTION_MATRIX,worldMatrix:i.WORLD_MATRIX,cameraPosition:i.CAMERA,near:i.NEAR_PLANE,diffuseMap:i.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float near;","varying vec3 eyeVec;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition * near * 10.0, 1.0);"," worldPos += vec4(cameraPosition, 0.0);","	gl_Position = projectionMatrix * viewMatrix * worldPos;","	eyeVec = worldPos.xyz - cameraPosition;"," eyeVec.x = -eyeVec.x;"," eyeVec = (worldMatrix * vec4(eyeVec, 0.0)).xyz;","}"].join("\n"),fshader:["precision mediump float;","uniform samplerCube diffuseMap;","varying vec3 eyeVec;","void main(void)","{","	vec4 cube = textureCube(diffuseMap, eyeVec);"," if (cube.a < 0.05) discard;","	gl_FragColor = cube;","}"].join("\n")},a.sphere={attributes:{vertexPosition:n.POSITION,vertexUV0:n.TEXCOORD0},uniforms:{viewMatrix:i.VIEW_MATRIX,projectionMatrix:i.PROJECTION_MATRIX,worldMatrix:i.WORLD_MATRIX,cameraPosition:i.CAMERA,near:i.NEAR_PLANE,diffuseMap:i.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float near;","varying vec2 texCoord0;","varying vec3 eyeVec;","void main(void) {","	texCoord0 = vertexUV0;","	vec4 worldPos = worldMatrix * vec4(vertexPosition * near * 10.0, 1.0);"," worldPos += vec4(cameraPosition, 0.0);","	gl_Position = projectionMatrix * viewMatrix * worldPos;","	eyeVec = cameraPosition - worldPos.xyz;","}"].join("\n"),fshader:["precision mediump float;","uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{"," vec4 sphere = texture2D(diffuseMap, texCoord0);"," if (sphere.a < 0.05) discard;","	gl_FragColor = sphere;","}"].join("\n")},u}),define("goo/loaders/handlers/SkyboxHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Texture","goo/renderer/shaders/ShaderBuilder","goo/util/Skybox","goo/util/rsvp","goo/util/PromiseUtil","goo/entities/SystemBus"],function(e,t,n,r,i,s,o){function u(){e.apply(this,arguments),this._activeSkyboxRef=null;var n=new r("box",[],null,0);this._skybox=this.world.createEntity(n.meshData,n.materials[0],n.transform),this._skybox.transformComponent.updateWorldTransform(),this._skybox.isSkybox=!0,this._skybox.name="Skybox_box",this._skyboxTexture=new t(null,{flipY:!1}),this._skyboxTexture.variant="CUBE",this._skybox.meshRendererComponent.materials[0].setTexture("DIFFUSE_MAP",this._skyboxTexture);var i=new r("sphere",[],null,0);this._skysphere=this.world.createEntity(i.meshData,i.materials[0],i.transform),this._skysphere.transformComponent.updateWorldTransform(),this._skysphere.isSkybox=!0,this._skysphere.name="Skybox_sphere",this._skysphereTexture=new t(null,{flipY:!1,wrapS:"EdgeClamp",wrapT:"EdgeClamp"}),this._skysphere.meshRendererComponent.materials[0].setTexture("DIFFUSE_MAP",this._skysphereTexture),this._activeSkyshape=null}function f(e,t){var n=e.length;if(n!==t.length)return!1;while(n--)if(e[n]!==t[n])return!1;return!0}u.prototype=Object.create(e.prototype),u.prototype.constructor=u,e._registerClass("skybox",u),u.prototype._remove=function(e){this._objects.delete(e),this._activeSkyboxRef===e&&(this._hide(this._skybox),this._hide(this._skysphere),this._skyboxTexture.setImage(null),this._activeSkyshape=null,n.SKYBOX=null,n.SKYSPHERE=null,this._activeSkyboxRef=null)},u.prototype._create=function(){return{textures:[],enabled:!1}},u.prototype._update=function(t,n,r){var o=this;return e.prototype._update.call(this,t,n,r).then(function(e){if(!e)return s.resolve([]);var u=[];return n.box&&u.push(o._updateBox(n.box,r,e)),n.sphere&&u.push(o._updateSphere(n.sphere,r,e)),i.all(u).then(function(e){if(n.box||n.sphere)o._activeSkyboxRef=t;return e})})},u.prototype._updateSphere=function(e,t,n){var r=this;return e.sphereRef?this._load(e.sphereRef,t).then(function(t){if(!t||!t.image){o.emit("goo.error.skybox",{type:"Sphere",message:"The skysphere needs an image to display."}),r._hide(r._skysphere);return}var i=r._skysphereTexture;return n.textures=[t],i.setImage(t.image),e.enabled?r._show(r._skysphere):r._hide(r._skysphere),r._skysphere}):(r._skysphereTexture.setImage(null),r._hide(r._skysphere),s.resolve(r._skysphere))};var a=["rightRef","leftRef","topRef","bottomRef","frontRef","backRef"];return u.prototype._updateBox=function(e,t,n){var r=this,o=a.map(function(n){return e[n]?r._load(e[n],t):s.resolve()});return i.all(o).then(function(t){if(f(t,n.textures)&&r._activeSkyShape===r._skybox)return r._skybox;var i=t.map(function(e){return e?e.image:null});if(i.filter(Boolean).length===0)return r._skyboxTexture.setImage(null),r._hide(r._skybox),r._skybox;var s=1,o=1;for(var u=0;u<i.length;u++)i[u]&&(s=Math.max(s,i[u].width),o=Math.max(o,i[u].width));n.textures=t;var a=r._skyboxTexture;return a.setImage(i),a.image.width=s,a.image.height=o,a.image.dataReady=!0,a.setNeedsUpdate(),e.enabled?r._show(r._skybox):r._hide(r._skybox),r._skybox})},u.prototype._hide=function(e){var t=this.world.getSystem("RenderSystem");t.removed(e),e===this._skybox?n.SKYBOX=null:e===this._skysphere&&(n.SKYSPHERE=null)},u.prototype._show=function(e){var t=this.world.getSystem("RenderSystem");this._activeSkyshape&&t.removed(this._activeSkyshape),t.added(e),this._activeSkyshape=e,n.SKYBOX=e===this._skybox?this._skyboxTexture:null,n.SKYSPHERE=e===this._skysphere?this._skysphereTexture:null},u}),define("goo/entities/components/HtmlComponent",["goo/entities/components/Component"],function(e){function t(t){e.apply(this,arguments),this.type="HtmlComponent",this.domElement=t,this.hidden=!1,this.useTransformComponent=!0,Object.seal(this)}return t.type="HtmlComponent",t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t}),define("goo/loaders/handlers/HtmlComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/HtmlComponent","goo/util/rsvp","goo/util/PromiseUtil"],function(e,t,n,r){function i(){e.apply(this,arguments),this._type="HtmlComponent"}function o(e){return"__"+e.replace(s,"-")}i.prototype=Object.create(e.prototype),e._registerClass("html",i),i.prototype.constructor=i,i.prototype._prepare=function(){},i.prototype._create=function(){return new t};var s=/\W/g;return i.prototype.update=function(t,i,s){var u=this;return e.prototype.update.call(this,t,i,s).then(function(e){function v(e,t){return u.loadObject(t,s).then(function(t){return e.src=t.src,e},function(t){return console.error(t),delete e.src,e})}if(!e)return;var a=o(t.id),f=e.domElement;if(!f){f=document.createElement("div"),f.id=a,f.className="goo-entity",f.addEventListener("mousedown",function(e){var n=t._world.gooRunner,r={entity:t,depth:0,x:e.pageX,y:e.pageY,domEvent:e,id:t.id,type:"mousedown"};n.triggerEvent("mousedown",r)}),f.addEventListener("mouseup",function(e){var n=t._world.gooRunner,r={entity:t,depth:0,x:e.pageX,y:e.pageY,domEvent:e,id:t.id,type:"mouseup"};n.triggerEvent("mouseup",r)}),f.addEventListener("click",function(e){var n=t._world.gooRunner,r={entity:t,depth:0,x:e.pageX,y:e.pageY,domEvent:e,id:t.id,type:"click"};n.triggerEvent("click",r)}),e.domElement=f,f.style.position="absolute",f.style.top=0,f.style.left=0,f.style.zIndex=1,f.style.display="none";var l=t._world.gooRunner.renderer.domElement.parentElement||document.body;l.appendChild(f)}var c=i.innerHtml!==f.prevInnerHtml,h=i.style!==f.prevStyle;f.prevInnerHtml=i.innerHtml,f.prevStyle=i.style,e.useTransformComponent=i.useTransformComponent!==!1;if(!c&&!h)return r.resolve();var p="";if(i.style){var d=i.style.replace("__entity","#"+a);p="<style>\n"+d+"\n</style>"}f.innerHTML=p+i.innerHtml;var m=f.getElementsByTagName("IMG"),g=[];for(var y=0;y<m.length;y++){var b=m[y],w=b.getAttribute("data-id");if(w){var E=v(b,w);g.push(E)}}return n.all(g)})},i.prototype._remove=function(t){var n=t.htmlComponent;e.prototype._remove.call(this,t),n.domElement&&n.domElement.parentNode.removeChild(n.domElement)},i}),define("goo/loaders/DynamicLoader",["goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/ComponentHandler","goo/util/Ajax","goo/util/rsvp","goo/util/StringUtil","goo/util/PromiseUtil","goo/util/ArrayUtil","goo/util/ShapeCreatorMemoized","goo/loaders/handlers/CameraComponentHandler","goo/loaders/handlers/EntityHandler","goo/loaders/handlers/LightComponentHandler","goo/loaders/handlers/MaterialHandler","goo/loaders/handlers/MeshDataComponentHandler","goo/loaders/handlers/MeshDataHandler","goo/loaders/handlers/MeshRendererComponentHandler","goo/loaders/handlers/SceneHandler","goo/loaders/handlers/ShaderHandler","goo/loaders/handlers/TextureHandler","goo/loaders/handlers/TransformComponentHandler","goo/loaders/handlers/ProjectHandler","goo/loaders/handlers/SoundComponentHandler","goo/loaders/handlers/SoundHandler","goo/loaders/handlers/EnvironmentHandler","goo/loaders/handlers/SkyboxHandler","goo/loaders/handlers/HtmlComponentHandler"],function(e,t,n,r,i,s,o,u){function a(e){if(!e.world)throw new Error("World argument cannot be null");this._world=e.world;if(e.ajax)this._ajax=e.ajax;else{if(!e.rootPath)throw new Error("ajax or rootPath must be defined");this._ajax=new n(e.rootPath)}this._objects=new Map,this._handlers={}}a.prototype.preload=function(e,t){this._ajax.prefill(e,t)},a.prototype.clear=function(){var e=[];for(var t in this._handlers)e.push(this._handlers[t].clear());this._ajax.clear instanceof Function&&this._ajax.clear();if(this._world&&this._world.gooRunner){u.clearCache(this._world.gooRunner.renderer.context);for(var n=0;n<this._world.gooRunner.renderSystems.length;n++){var i=this._world.gooRunner.renderSystems[n].lights;if(i)for(var s=0;s<i.length;s++)i[s].destroy(this._world.gooRunner.renderer)}this._world.gooRunner.renderer.clearShaderCache()}return r.all(e)},a.prototype.load=function(e,t){t=t||{};var n=this._loadObject.bind(this,e,t);return t.preloadBinaries===!0?this._loadBinariesFromRefs(e,t).then(n):n()},a.prototype.update=function(e,t,n){var r=this;return n=n||{},this._ajax.update(e,t).then(function(t){return r._updateObject(e,t,n)}).then(null,function(t){throw console.error("Error updating "+e+" "+t),t})},a.prototype._loadObject=function(e,t){var n=a.getTypeForRef(e),r=this._getHandler(n);return r?r.load(e,t):this._loadRef(e,t)},a.prototype.remove=function(e){return this._objects.delete(e),this.update(e,null)},a.prototype._updateObject=function(e,t,n){var r=a.getTypeForRef(e),i=this._getHandler(r);return i?i.update(e,t,n):a._isRefTypeInGroup(e,"binary")||r!=="bundle"?s.resolve(t):(console.warn("No handler for type "+r),s.resolve(t))},a.prototype._loadRef=function(e,t){return this._ajax.load(e,t==null?!1:t.noCache)},a.prototype._loadBinariesFromRefs=function(e,t){function i(e){function s(r){return n._loadRef(r,t).then(function(){i++,t.progressCallback instanceof Function&&t.progressCallback(i,e.length)})}var i=0;return r.all(e.map(function(e){return s(e)}))}function u(e){function f(e){return n._loadRef(e,t).then(l)}function l(e){var t=[];if(e.lazy===!0)return s.resolve();var o=n._getRefsFromConfig(e);for(var l=0,c=Object.keys(o),h=o.length;l<h;l++){var p=o[c[l]];a._isRefTypeInGroup(p,"asset")&&!i.has(p)?i.add(p):a._isRefTypeInGroup(p,"json")&&!u.has(p)&&(u.add(p),t.push(f(p)))}return r.all(t)}var i=new Set,u=new Set;return l({collectionRefs:e}).then(function(){return o.fromValues(i)})}var n=this;return u(e).then(i)},a.prototype._getHandler=function(t){var n=this._handlers[t];if(n)return n;var r=e.getHandler(t);return r?this._handlers[t]=new r(this._world,this._loadRef.bind(this),this._updateObject.bind(this),this._loadObject.bind(this)):null};var f=new RegExp("\\S+refs?$","i");return a.prototype._getRefsFromConfig=function(e){function n(e,r){if(f.test(e)&&e!=="thumbnailRef")if(r instanceof Object)for(var i=0,s=Object.keys(r),o=s.length;i<o;i++)r[s[i]]&&t.push(r[s[i]]);else r&&t.push(r);else if(r instanceof Object&&e!=="assets")for(var i=0,s=Object.keys(r),o=s.length;i<o;i++)n(s[i],r[s[i]])}var t=[];return n("",e),t},a.getTypeForRef=function(e){return e.substr(e.lastIndexOf(".")+1).toLowerCase()},a._isRefTypeInGroup=function(e,t){var r=a.getTypeForRef(e);return r&&n.types[t]&&n.types[t][r]},a}),define("data_pipeline/goodata/BundleLoader",["goo/loaders/DynamicLoader"],function(e){function n(t,n,r,i,s){var o=new e({world:t.world,rootPath:n,beforeAdd:function(){return!1}});o.load(r).then(function(e){i(n,e,o)}).then(null,function(e){s([n,r,e,o])})}function r(e,t,r,i,s){n(e,t,r,i,s)}var t={};return{loadBundleData:r}}),define("data_pipeline/pipes/GooPipe",["data_pipeline/DataWorker","data_pipeline/goodata/BundleLoader"],function(e,t){var n=.2,r=n,i={},s=0,o=[],u={},a={polling:{enabled:!0,frequency:1}},f=function(){};return f.passToDynamicLoader=function(e,n,r,i,s){t.loadBundleData(e,n,r,i,s)},f.registerPollCallback=function(e,t){u[e]=t,o.push(e)},f.storeConfig=function(e,t,n,r,s,o,u){i[n]=s;var a=function(e,t,r){o(n,t,r)};f.passToDynamicLoader(e,window.gooBundlesPath+n,r,a,u);var l=function(){f.passToDynamicLoader(e,window.gooBundlesPath+n,r,a,u)};f.registerPollCallback(n+r,l)},f.loadBundleFromFolderUrl=function(t,n,r,i,s,o){var u=function(e,u){f.storeConfig(n,t,r,i,e,s,o)},a=function(e,t){u(JSON.parse(t),e)},l=function(e){o("Worker fail: "+e)};e.fetchJsonData(r+i,a,l)},f.tickGooPipe=function(t){if(!a.polling.enabled)return;n=1/a.polling.frequency,r-=o.length*t/(o.length+1);if(r<0){s+=1,s>=o.length&&(s=0);var i=function(e){console.error("GooPolling failed",e)};e.fetchJsonData(o[s],u[o[s]],i),r=n}},f.setGooPipeOpts=function(e){a=e},f}),define("data_pipeline/GameDataPipeline",["data_pipeline/pipes/JsonPipe","data_pipeline/pipes/SvgPipe","data_pipeline/pipes/ImagePipe","data_pipeline/pipes/GooPipe"],function(e,t,n,r){var i=function(){};return i.loadConfigFromUrl=function(t,n,r){e.loadJsonFromUrl(t,n,r)},i.loadGooBundleFromUrl=function(e,t,n,i,s,o){r.loadBundleFromFolderUrl(e,t,n,i,s,o)},i.loadSvgFromUrl=function(e,n,r){t.loadSvg(e,n,r)},i.loadImageFromUrl=function(e,t,r){n.loadImage(e,t,r)},i.tickDataLoader=function(i){e.tickJsonPipe(i),t.tickSvgPipe(i),r.tickGooPipe(i),n.tickImagePipe(i)},i.applyPipelineOptions=function(i){e.setJsonPipeOpts(i.jsonPipe),t.setSvgPipeOpts(i.jsonPipe),r.setGooPipeOpts(i.gooPipe),n.setImagePipeOpts(i.imagePipe)},i}),define("goo/scripts/ScriptUtils",["goo/util/ObjectUtil"],function(e){var t={};return t.defaultsByType={"float":0,"int":0,string:"",vec2:[0,0],vec3:[0,0,0],vec4:[0,0,0,0],"boolean":!1,texture:{},entity:{}},t.fillDefaultValues=function(n,r){if(!(r instanceof Array))return;var i=[];r.forEach(function(r){if(!r||typeof r.key!="string")return;if(r["default"]===null||r["default"]===undefined)r["default"]=t.defaultsByType[r.type];i.push(r.key),typeof n[r.key]=="undefined"&&(n[r.key]=e.clone(r["default"]))});for(var s in n)i.indexOf(s)===-1&&s!=="enabled"&&delete n[s]},t.fillDefaultNames=function(e){function t(e){if(typeof e!="string"||e.length===0)return"";var t=e[0].toUpperCase()+e.slice(1);return t.replace(/(.)([A-Z])/g,"$1 $2")}if(!(e instanceof Array))return;e.forEach(function(e){if(!e)return;typeof e.name=="undefined"&&(e.name=t(e.key))})},t.getKey=function(e){return t._keys[e]?t._keys[e]:e.charCodeAt(0)},t._keys={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Meta:91,Pause:19,Capslock:20,Esc:27,Space:32,Pageup:33,Pagedown:34,End:35,Home:36,Leftarrow:37,Uparrow:38,Rightarrow:39,Downarrow:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"0numpad":96,"1numpad":97,"2numpad":98,"3numpad":99,"4numpad":100,"5numpad":101,"6numpad":102,"7numpad":103,"8numpad":104,"9numpad":105,Multiply:106,Plus:107,Minus:109,Dot:110,Slash1:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Equals:187,Comma:188,Slash:191,Backslash:220},t._keyInverse=function(e){var t={},n=Object.keys(e);for(var r=0;r<n.length;r++)t[e[n[r]]]=n[r];return t}(t._keys),t.keyForCode=function(e){return t._keyInverse[e]},t}),define("goo/scripts/Scripts",["goo/scripts/ScriptUtils","goo/util/ObjectUtil"],function(e,t){var n={},r={},i={};return i.register=function(t){var r=t.externals.key||t.externals.name;if(n[r]){console.warn("Script already registered for key "+r);return}e.fillDefaultNames(t.externals.parameters),n[r]=t},i.addClass=function(e,t){r[e]=t},i.getClasses=function(){return r},i.getScript=function(e){return n[e]},i.create=function(r,i){var s;if(typeof r=="string"){s=n[r];if(!s)throw new Error('Script "'+r+'" is not registered')}else typeof r=="function"&&(s=r);var o=s();return o.parameters={},o.environment=null,o.externals=s.externals,s.externals&&(e.fillDefaultNames(o.externals.parameters),e.fillDefaultValues(o.parameters,s.externals.parameters)),i&&t.extend(o.parameters,i),o},i.allScripts=function(){var e={},t=Object.keys(n);for(var r=0;r<t.length;r++){var i=t[r];e[i]=n[i]}return e},i}),define("goo/entities/EntityUtils",["goo/scripts/Scripts","goo/renderer/bounds/BoundingBox","goo/util/ObjectUtil"],function(e,t,n){function r(){}function i(e,t){t.skeletonMap=t.skeletonMap||{originals:[],clones:[]};var n=t.skeletonMap.originals.indexOf(e),r;return n===-1?(r=e.clone(),t.skeletonMap.originals.push(e),t.skeletonMap.clones.push(r)):r=t.skeletonMap.clones[n],r}function s(t,r,o){var u=t.createEntity(r.name);u._tags=n.cloneSet(r._tags),u._attributes=n.cloneMap(r._attributes),u._hidden=r._hidden,u.static=r.static;for(var a=0;a<r._components.length;a++){var f=r._components[a];if(f.type==="TransformComponent")u.transformComponent.transform.copy(f.transform);else if(f.type==="MeshDataComponent"){var l=f.clone(o);f.currentPose&&(l.currentPose=i(f.currentPose,o)),u.setComponent(l)}else if(f.type==="AnimationComponent"){var c=f.clone();c._skeletonPose=i(f._skeletonPose,o),u.setComponent(c)}else if(f.type==="ScriptComponent"){var h=new f.constructor;for(var p=0;p<f.scripts.length;p++){var d,v=f.scripts[p],m=v.externals?v.externals.key||v.externals.name:null;m&&e.getScript(m)?d=e.create(m,v.parameters):(d={externals:v.externals,name:(v.name||"")+"_clone",enabled:!!v.enabled},v.parameters&&(d.parameters=n.deepClone(v.parameters)),v.setup&&(d.setup=v.setup),v.update&&(d.update=v.update),v.setup&&(d.cleanup=v.cleanup),h.scripts.push(d))}u.setComponent(h),t.getSystem("ScriptSystem").manualSetup&&f.scripts[0].context&&h.setup(u)}else f.clone?u.setComponent(f.clone(o)):u.setComponent(f)}for(var p=0;p<r.transformComponent.children.length;p++){var g=r.transformComponent.children[p],y=s(t,g.entity,o);u.transformComponent.attachChild(y.transformComponent)}return o.callback&&o.callback(u),u}return r.clone=function(e,t,n){return n=n||{},s(e,t,n)},r.getRoot=function(e){while(e.transformComponent.parent)e=e.transformComponent.parent.entity;return e},r.updateWorldTransform=function(e){e.updateWorldTransform();for(var t=0;t<e.children.length;t++)r.updateWorldTransform(e.children[t])},r.getTotalBoundingBox=function(e){var n=new t,r=!0;e.traverse(function(e){if(e.meshRendererComponent)if(r){var i=e.meshRendererComponent.worldBound;i instanceof t?n.copy(i):(n.center.setVector(i.center),n.xExtent=n.yExtent=n.zExtent=i.radius),r=!1}else n.merge(e.meshRendererComponent.worldBound)});if(r){var i=e.transformComponent.worldTransform.translation;n=new t(i.clone(),.001,.001,.001)}return n},r}),define("data_pipeline/goodata/MaterialBatch",["goo/entities/EntityUtils"],function(e){var t=function(e,t){this.key=e,this.meshRendererComponent=t,this.meshDataTransforms=[]};return t.prototype.addEntity=function(t){t.transformComponent.updateTransform(),e.updateWorldTransform(t.transformComponent),this.meshDataTransforms.push({meshData:t.meshDataComponent.meshData,transform:t.transformComponent.worldTransform})},t}),define("goo/util/MeshBuilder",["goo/renderer/MeshData","goo/math/Vector3","goo/entities/EntityUtils"],function(e,t,n){function r(){this.meshDatas=[],this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]}r.prototype.addEntity=function(e){e.traverse(function(e){e.transformComponent._dirty&&e.transformComponent.updateTransform()}),e.traverse(function(e){e.transformComponent._dirty&&n.updateWorldTransform(e.transformComponent)});var t=this;e.traverse(function(e){e.meshDataComponent&&t.addMeshData(e.meshDataComponent.meshData,e.transformComponent.worldTransform)})};var i=new t;return r.prototype.addMeshData=function(t,n){if(t.vertexCount>=65536)throw new Error("Maximum number of vertices for a mesh to add is 65535. Got: "+t.vertexCount);this.vertexCounter+t.vertexCount>=65536&&this._generateMesh();var r=n.matrix,s=n.rotation,o=t.attributeMap,u=Object.keys(o);for(var a=0,f=u.length;a<f;a++){var l=u[a],c=o[l],h=this.vertexData[l];h||(this.vertexData[l]={},h=this.vertexData[l],h.array=[],h.map={count:c.count,type:c.type,stride:c.stride,offset:c.offset,normalized:c.normalized});var p=t.getAttributeBuffer(l),d=p.length,v=h.array,m=c.count,g=this.vertexCounter*m;if(l===e.POSITION)for(var y=0;y<d;y+=m)i.setDirect(p[y+0],p[y+1],p[y+2]),r.applyPostPoint(i),v[g+y+0]=i.data[0],v[g+y+1]=i.data[1],v[g+y+2]=i.data[2];else if(l===e.NORMAL)for(var y=0;y<d;y+=m)i.setDirect(p[y+0],p[y+1],p[y+2]),s.applyPost(i),v[g+y+0]=i.data[0],v[g+y+1]=i.data[1],v[g+y+2]=i.data[2];else if(l===e.TANGENT)for(var y=0;y<d;y+=m)i.setDirect(p[y+0],p[y+1],p[y+2]),s.applyPost(i),v[g+y+0]=i.data[0],v[g+y+1]=i.data[1],v[g+y+2]=i.data[2],v[g+y+3]=p[y+3];else for(var y=0;y<d;y++)v[g+y]=p[y]}var b=t.getIndexBuffer();for(var y=0,f=t.indexCount;y<f;y++)this.indexData[this.indexCounter+y]=b[y]+this.vertexCounter;this.vertexCounter+=t.vertexCount,this.indexCounter+=t.indexCount,t.indexLengths?this.indexLengths=this.indexLengths.concat(t.indexLengths):this.indexLengths=this.indexLengths.concat(t.getIndexBuffer().length),this.indexModes=this.indexModes.concat(t.indexModes)},r.prototype._generateMesh=function(){var t={};for(var n in this.vertexData){var r=this.vertexData[n];t[n]=r.map}var i=new e(t,this.vertexCounter,this.indexCounter);for(var n in this.vertexData){var r=this.vertexData[n].array;i.getAttributeBuffer(n).set(r)}i.getIndexBuffer().set(this.indexData),i.indexLengths=this.indexLengths,i.indexModes=this.indexModes;var s=i.indexModes[0],o=0,u=[],a=[];for(var f=0;f<i.indexModes.length;f++){var l=i.indexModes[f];s!==l&&(u.push(s),a.push(o),s=l,o=0),o+=i.indexLengths[f],f===i.indexModes.length-1&&(u.push(l),a.push(o),s=l,o=0)}i.indexLengths=a,i.indexModes=u,this.meshDatas.push(i),this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]},r.prototype.build=function(){return this.vertexCounter>0&&this._generateMesh(),this.meshDatas},r.prototype.reset=function(){this.meshDatas=[],this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]},r}),define("data_pipeline/goodata/GooEntityListCombiner",["data_pipeline/goodata/MaterialBatch","goo/util/MeshBuilder"],function(e,t){var n=function(){this.meshBuilder=new t};return n.prototype.buildMaterialBatches=function(t){var n={},r=function(e){var t="";for(var n=0;n<e.materials.length;n++)t+=e.materials[n].name;return t},i=function(t){var i=r(t.meshRendererComponent);n[i]||(n[i]=new e(i,t.meshRendererComponent)),n[i].addEntity(t)};for(var s=0;s<t.length;s++)t[s].traverse(function(e){e.meshRendererComponent&&i(e)});return n},n.prototype.combineBatch=function(e,t){this.meshBuilder.reset();for(var n=0;n<t.meshDataTransforms.length;n++)this.meshBuilder.addMeshData(t.meshDataTransforms[n].meshData,t.meshDataTransforms[n].transform);var r=this.meshBuilder.build(),i=e.world.createEntity(r[0]);return i.setComponent(t.meshRendererComponent),i},n.prototype.combineList=function(e,t,n){var r=this.buildMaterialBatches(t),i=[];for(var s in r){var o=this.combineBatch(e,r[s]);i.push(o)}n(i)},n}),define("data_pipeline/goodata/GooEntityCache",["goo/entities/EntityUtils","data_pipeline/goodata/GooEntityListCombiner"],function(e,t){var n,r=function(){this.clonableEntities={},this.cachedEntities={},this.cachedEnvironments={},this.gooEntityListCombiner=new t};return r.prototype.preloadEntityData=function(e,t){var r=n.world,i=r.getSystem("TransformSystem"),s=r.getSystem("CameraSystem"),o=r.getSystem("BoundingUpdateSystem"),u=r.getSystem("AnimationSystem"),a=r.getSystem("RenderSystem"),f=n.renderer,l=0,c=0,h=function(e){e.id||console.error("No id on Child: ",e);if(e.meshRendererComponent){l++;var n=function(){return f.preloadMaterials([e]).then(h)},h=function(){r.processEntityChanges(),l--,l==0&&(c++,t())};r.processEntityChanges(),i._process(),s._process(),o._process(),u._process(),f.precompileShaders([e],a.lights).then(n)}};typeof e.traverse=="function"?(e.traverse(h),c==0&&l==0&&(console.error("Traversed entity and found zero mesh renderer comps..",e),t())):t()},r.prototype.clone=function(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var n=0,r=e.length;n<r;n++)t[n]=this.clone(e[n]);return t}if(e instanceof Object){t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=this.clone(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")},r.prototype.processForClone=function(e){var t={skeletonMap:{originals:[],clones:[]}},n=function(e){console.log("Skel Pose: ",e),t.skeletonMap.originals.push(e),t.skeletonMap.clones.push(e.clone())},r=function(e){console.log("Clone ent anims: ",e),n(e.animationComponent._skeletonPose)};e.animationComponent&&r(e);var i=function(e){return this.clone(e)}.bind(this),s=function(e){e.id||console.error("No id on Child: ",e),e.animationComponent&&n(e.animationComponent._skeletonPose),e.meshRendererComponent&&e.hasTag("reflectable")&&(console.log("has the reflectable tag: ",e),e.meshRendererComponent.isReflectable=!0)}.bind(this);return typeof e.traverse=="function"&&e.traverse(s),e},r.prototype.preloadEntity=function(e,t,n,r,i){var s=function(e,t,n){r(e.name,{conf:t,sourceData:n,build:i})},o=function(){this.clonableEntities[e.name]=e,s(e,t,n)}.bind(this);this.preloadEntityData(e,o)},r.prototype.cloneEntity=function(t,r){this.clonableEntities[t]||console.error("No entity available with name: ",t,this.clonableEntities);var i=this.processForClone(e.clone(n.world,this.clonableEntities[t]));r(i)},r.prototype.reloadEnvironment=function(e,t){this.cachedEnvironments[e]||console.error("No environment available with name: ",e,this.cachedEnvironments),this.cachedEnvironments[e].loader.load(this.cachedEnvironments[e].conf.id).then(function(e){t(e)})},r.prototype.returnBuiltEntity=function(t,r,i,s,o,u){var a=function(e){return this.processForClone(e)}.bind(this),f=function(t,i){setTimeout(function(){var t=e.clone(n.world,r);a(t),i(t)},0)},l=function(e,t){f(this.cachedEntities[e],t)}.bind(this);this.preloadEntity(r,this.cachedEntities[r.name],s,o,l)},r.prototype.cacheLoadedEntities=function(e,t,r,i,s,o,u){n=e;var a=function(e,t){u(e,t)};for(var f in r){var l=r[f];if(t.environment&&t.environment.indexOf(l.name)!=-1){this.cachedEnvironments[l.name]={conf:l,loader:i},console.log("Added env: ",l.name,this.cachedEnvironments);var c=function(e,t){console.log("Apply: ",this.cachedEnvironments[e]),t(this.cachedEnvironments[e])}.bind(this)}if(t.entities&&t.entities.indexOf(l.name)!=-1){var h=function(e,n,r){this.returnBuiltEntity(e,n,r,t,s,o)}.bind(this);this.cachedEntities[l.name]=l,i.load(l.id,{preloadBinaries:!1,progressCallback:a}).then(function(e){if(!l.id){console.error("No ID on entry: ",l);return}h(l.id,e,i)}).then(null,function(e){o("Failed to load bundle: ",e)})}}},r.prototype.runCombinerOnList=function(e,t){this.gooEntityListCombiner.combineList(n,e,t)},r}),define("data_pipeline/data/ConfigCache",["data_pipeline/GameDataPipeline","data_pipeline/goodata/GooEntityCache"],function(e,t){var n={urls:{}},r=!1,i=[],s={},o={},u={},a=function(){},f=[],l=[],c=[],h=[],p=new t,d=function(){};return d.pipelineReady=function(e){r=e;if(r){for(var t=0;t<i.length;t++)i[t]();i.length=0}},d.getReady=function(){return r},d.addReadyCallback=function(e){i.push(e)},d.applyDataPipelineOptions=function(t){e.applyPipelineOptions(t)},d.addProgressCallback=function(e){f.push(e)},d.setMasterResetFunction=function(e){a=e},d.storeImageRef=function(e,t){d.notifyUrlReadRequest(t.url),o[e]=t},d.getImageRef=function(e){return o[e]},d.addCategory=function(e){n[e]={},s[e]={callbacks:[],subscription:{}}},d.fireCategoryCallbacks=function(e){for(var t=0;t<s[e].callbacks.length;t++)s[e].callbacks[t](e,n[e]);for(var r in s[e].subscription)n[e][r]&&s[e].subscription[r](r,n[e][r]);a()},d.dataCombineToKey=function(e,t,r){n[e]||d.addCategory(e);for(var i in r[e])n[e][i]=r[e][i];d.fireCategoryCallbacks(e)},d.getCategory=function(e){var t=n[e];return t?t:"No data "+e},d.getConfigKey=function(e,t){var n=d.getCategory(e)[t];return n?n:"No value for "+t},d.registerCategoryKeySubscriber=function(e,t,n){s[e]||d.addCategory(e),s[e].subscription[t]=n},d.registerCategoryUpdatedCallback=function(e,t){return s[e]||d.addCategory(e),s[e].callbacks.push(t),n[e]},d.subscribeToCategoryKey=function(e,t,n){var r=d.getConfigKey(e,t);typeof r!="string"&&n(t,r),d.registerCategoryKeySubscriber(e,t,n)},d.registerImageSub=function(e,t,n){u[t]||(u[t]={}),u[t][e]=n},d.subscribeToImageId=function(e,t,n){var r=d.getImageRef(t);r&&r.loaded&&n(t,r),d.registerImageSub(e,t,n)},d.imageDataLoaded=function(e){d.notifyUrlReceived(d.getImageRef(e).url);if(!u[e])return;for(var t in u[e])u[e][t](e,d.getImageRef(e))},d.notifyLoadStateChange=function(){for(var e=0;e<f.length;e++)f[e](l.length,h.length,c.length,h)},d.notifyUrlReadRequest=function(e){l.indexOf(e)==-1&&(l.push(e),h.push(e),d.notifyLoadStateChange())},d.notifyUrlReceived=function(e){h.indexOf(e)!=-1&&h.splice(h.indexOf(e),1),c.indexOf(e)==-1&&c.push(e),d.notifyLoadStateChange()},d.cacheFromUrl=function(t,r,i){d.notifyUrlReadRequest(t);var s=function(e,i){d.notifyUrlReceived(e),n.urls[e]=i;for(var s=0;s<i.length;s++)for(var o in i[s])d.dataCombineToKey(o,t,i[s]);r(e,i)};e.loadConfigFromUrl(t,s,i)},d.cloneCachedEntity=function(e,t){p.cloneEntity(e,t)},d.reloadEnvironmentEntity=function(e,t){p.reloadEnvironment(e,t)},d.cacheGooBundleFromUrl=function(t,n,r,i,s,o){d.notifyUrlReadRequest(t+r.folder);var u=function(e,t){i(e,t)},a=function(e,t,i){console.log("Bundle Url: ",e),d.notifyUrlReceived(e),d.dataCombineToKey("bundles",r.id,t,i),p.cacheLoadedEntities(n,r,t,i,u,s,o)};e.loadGooBundleFromUrl(t,n,t+r.folder,r.file,a,s)},d.cacheSvgFromUrl=function(t,n,r){d.notifyUrlReadRequest(t);var i=function(e,t){n(e,t)};e.loadSvgFromUrl(t,i,r)},d.cacheImageFromUrl=function(t,n,r){d.notifyUrlReadRequest(t);var i=function(e,t){n(e,t)};e.loadImageFromUrl(t,i,r)},d.loadBundleMaster=function(e,t,n,r,i,s){var o,u=function(e,t){if(o.length){var n=o.shift();console.log("next bundle:",n),a(n)}r(e,t)}.bind(this),a=function(e){var n=function(e){console.error("Failed to cache bundle: ",e)};d.cacheGooBundleFromUrl(window.resourcePath,t,e,u,n,s)},f=function(e){o=e,a(o.shift())},l=function(e,t){for(var n=0;n<t.length;n++)f(t[n].bundle_index.bundles)};d.cacheFromUrl(n,l,i)},d.combineEntities=function(e,t){p.runCombinerOnList(e,t)},d.getCachedConfigs=function(){return n},d}),define("data_pipeline/PipelineAPI",["data_pipeline/data/ConfigCache"],function(e){var t=window.resourcePath,n=function(){};return n.addReadyCallback=function(t){e.addReadyCallback(t)},n.checkReadyState=function(){return e.getReady()},n.addProgressCallback=function(t){e.addProgressCallback(t)},n.readCachedConfigKey=function(t,n){return e.getConfigKey(t,n)},n.subscribeToCategoryUpdate=function(t,n){return e.registerCategoryUpdatedCallback(t,n)},n.subscribeToCategoryKey=function(t,n,r){e.subscribeToCategoryKey(t,n,r)},n.cloneLoadedGooEntity=function(t,n){e.cloneCachedEntity(t,n)},n.applyEnvironmentGooEntity=function(t,n){e.reloadEnvironmentEntity(t,n)},n.initBundleDownload=function(t,n,r,i,s,o){e.loadBundleMaster(t,n,r,i,s,o)},n.meshCombineEntityList=function(t,n){e.combineEntities(t,n)},n.subscribeToConfigUrl=function(t,n,r){e.cacheFromUrl(t,n,r)},n.cacheSvgFromUrl=function(t,n,r){e.cacheSvgFromUrl(t,n,r)},n.cacheImageFromUrl=function(t,n,r){e.cacheImageFromUrl(t,n,r)},n.subscribeToImage=function(t,n,r){e.subscribeToImageId(t,n,r)},n.getCachedConfigs=function(){return e.getCachedConfigs()},n}),define("load/ClientLoader",["application/EventManager","goo/entities/SystemBus","sound/SoundManager","load/TrackProgress","game/GameConfiguration","game/ships/BoatData","game/cars/CarData","game/piece/TargetData","game/planes/PlaneData","game/characters/CharacterData","game/world/ZoneData","data_pipeline/PipelineAPI"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=function(){this.cacheLoadStarted=0,this.cacheLoadRemaining=0,this.cacheLoadCompleted=0,this.notYetLoadedUrls=[],this.setupCacheLoadListener(),this.startedLoadCount=0,this.completedLoadCount=0,this.loadedEntities={},this.callbackIndex={},this.bundleHandled=0,this.bundleTotal=0,this.completeCheckTimeout=null,this.setupBundleLoader(),this.preloadClientData()};return h.prototype.setupCacheLoadListener=function(){var e=function(e,t,n,r){this.cacheLoadStarted=e,this.cacheLoadRemaining=t,this.cacheLoadCompleted=n,this.notYetLoadedUrls=r,this.emitProgressState()}.bind(this);c.addProgressCallback(e)},h.prototype.emitProgressState=function(){t.emit("data_source_update",{dataSource:"loadState",data:{progress:this.bundleTotal-this.bundleHandled+this.cacheLoadRemaining,started:this.startedLoadCount+this.cacheLoadStarted,completed:this.completedLoadCount+this.cacheLoadCompleted}});var e=["Progress: "+(this.startedLoadCount-this.completedLoadCount+this.cacheLoadRemaining),"CacheInit: "+this.cacheLoadStarted,"Cached OK: "+this.cacheLoadCompleted,"Progress:  "+this.cacheLoadRemaining,"Ent Init:  "+this.startedLoadCount,"Ent Done:  "+this.completedLoadCount,"Substep T: "+this.bundleTotal,"Substep H: "+this.bundleHandled];t.emit("message_to_gui",{channel:"system:channel",message:this.notYetLoadedUrls}),t.emit("message_to_gui",{channel:"data_validation_update_channel",message:e})},h.prototype.notifyUpdate=function(e){this.emitProgressState(),e&&!this.onLoadCompleted&&(this.onLoadCompleted=e);var t=function(){if(this.startedLoadCount-this.completedLoadCount+this.cacheLoadRemaining==0&&typeof this.onLoadCompleted=="function"){this.onLoadCompleted();var e=function(){};this.onLoadCompleted=null}}.bind(this);this.startedLoadCount-this.completedLoadCount==0&&(clearTimeout(this.completeCheckTimeout),this.completeCheckTimeout=setTimeout(function(){t()},2150))},h.prototype.setupBundleLoader=function(){var t=function(t){var n=e.eventArgs(t).callback,r=e.eventArgs(t).modelPath,i=function(e){var t=this.loadedEntities[e].build;return function(){t(e,n)}}.bind(this);i(r)()}.bind(this);e.registerListener(e.list().BUILD_GOO_GAMEPIECE,t)},h.prototype.handleBundleUpdated=function(e){this.notifyUpdate(),this.callbackIndex[e]||(this.callbackIndex[e]=[]);var t=function(e){console.log("Count ready: ",e.name),this.completedLoadCount++,this.notifyUpdate()}.bind(this),n=function(e){t(e)},r=function(e){var t=this.loadedEntities[e].build;return function(){t(e,n)}}.bind(this);this.callbackIndex[e].push(r(e));for(var i=0;i<this.callbackIndex[e].length;i++)console.log("Count started: ",e),this.startedLoadCount++,this.notifyUpdate(),this.callbackIndex[e][i]()},h.prototype.initBundleData=function(e,t,n,r,i){var s=function(e,t){this.bundleHandled=e,this.bundleTotal=t,this.notifyUpdate()}.bind(this),o=function(e,t){this.loadedEntities[e]=t,this.handleBundleUpdated(e),r(e,t)}.bind(this);c.initBundleDownload(e,t,n,o,i,s)},h.prototype.runGooPipeline=function(e,t,n,r){var i=function(e,t){console.log("Bundle update OK",e,t)}.bind(this),s=function(e){console.error("Bundle update FAIL:",e)},o=function(){this.notifyUpdate(r),this.initBundleData(e,t,n,i,s)}.bind(this);setTimeout(function(){o()},100)},h.prototype.preloadClientData=function(){n.initSounds(),n.loadSounds()},h.prototype.clientLoaded=function(){n.initFx()},{ClientLoader:h}}),require(["application/EventManager","io/InputSettersGetters"],function(e,t){var n=[],r=!1,i=(new Date).getTime(),s=10,o={cameraDrag:!1,pointerDrag:!1},u={movestate:"stop",forward:0,mouseSteer:0,mouseForward:[0,0],back:0,turnright:0,turnleft:0,jump:0},a,f=function(e){u.mouseForward=e,r==1,c(u)},l=function(t,n){e.fireEvent(e.list().PLAYER_MOVEMENT_INPUT,{movestate:t,turnSpeed:n});return;var r,i,s},c=function(e){var t="stop",n=e.turnleft-e.turnright;e.forward+e.mouseForward[0]*e.mouseForward[1]-e.back>0&&(t="walk"),e.forward-e.back<0&&(t="back"),u.mouseSteer==1&&n!=0&&(t=="walk"&&(e.turnright==1&&(t="st_f_r"),e.turnleft==1&&(t="st_f_l")),t=="back"&&(e.turnright==1&&(t="st_b_r"),e.turnleft==1&&(t="st_b_l")),t=="stop"&&(e.turnright==1&&(t="st_r"),e.turnleft==1&&(t="st_l")),n=0),u.movestate=t,u=e,l(u.movestate,n)},h=function(e){if(u.mouseSteer==1){var t=-e.visuals.pointer.getRotY(),n=-e.visuals.head.collada.getRotY();Math.abs(t-n)<.13,e.spatial.dir[0]=scene.camEntity.spatial.dir[0],e.spatial.dir[2]=scene.camEntity.spatial.dir[2]}},p=function(t,n){t[1]==1?u.mouseSteer=1:u.mouseSteer=0,t[1]==1&&!o.cameraDrag?(o.cameraDrag=!0,e.fireEvent(e.list().START_CAMERA_DRAG,{xy:n})):o.cameraDrag==1&&(o.cameraDrag=!1,e.fireEvent(e.list().STOP_CAMERA_DRAG,{})),t[0]==1&&!o.pointerDrag?(o.pointerDrag=!0,e.fireEvent(e.list().START_POINTER_DRAG,{xy:n})):t[0]==0&&o.pointerDrag==1&&(o.pointerDrag=!1,e.fireEvent(e.list().STOP_POINTER_DRAG,{})),f(t)},d=function(e){for(var n in e)for(var r=0;r<e[n].length;r++){var i=e[n][r];t.registeKeyBinding(n,i)}},v=function(e){for(var n in e)for(var r=0;r<e[n].length;r++){var i=e[n][r];t.unregisteKeyBinding(n,i)}},m=function(t){var n=e.eventArgs(t);p(n.action,n.xy)},g=function(t){d(e.eventArgs(t).bindings)},y=function(t){v(e.eventArgs(t).bindings)};e.registerListener(e.list().CLEAR_KEYBINDINGS,y),e.registerListener(e.list().ADD_KEYBINDINGS,g),e.registerListener(e.list().MOUSE_ACTION,m)}),define("io/PlayerMovementInput",function(){}),define("io/MouseListener",["application/EventManager"],function(e){var t=[0,0],n=function(e,n){var r=[0,0];switch(n){case"RIGHT":switch(e){case"mousedown":t[1]=1,r=t;break;case"mouseup":t[1]=0,r=t;break;case"mouseout":break;case"click":}break;case"LEFT":switch(e){case"mousedown":t[0]=1,r=t;break;case"mouseup":t[0]=0,r=t;break;case"click":t[1]==0}break;case"MIDDLE":switch(e){case"mousedown":r=[1,1];break;case"mouseup":r=[0,0];break;case"click":}}return r},r=function(e){var t="LEFT";return e.which?(e.which==3&&(t="RIGHT"),e.which==2&&(t="MIDDLE")):e.button&&(e.button==2&&(t="RIGHT"),e.button==4&&(t="MIDDLE")),n(e.type,t)},i=function(t,n){function i(t){t.stopPropagation();var i=t==null?e:t;n(r(i))}t.addEventListener("mouseup",i),t.addEventListener("click",i),t.addEventListener("mousedown",i),t.addEventListener("mouseout",i)};return{setElementClickFunction:i}}),define("io/GameScreen",["application/EventManager"],function(e){}),define("io/AnalogFeedback",["application/EventManager","io/InputSettersGetters","goo/math/Vector3"],function(e,t,n){var r=function(e,t){this.ctrlDetectBox=DomUtils.createDivElement(this.controllerOverlay,"ctrl_detect","Controller...","ctrl_detect"),this.analogMap=e,this.axesDirections={pitch:{up:1,left:0},roll:{up:0,left:1},yaw:{up:0,left:1},throttle:{up:1,left:0},flaps:{up:1,left:0},look_up:{up:1,left:0},look_left:{up:0,left:1}},this.allButtonElems=[],this.allAxesElems=[],this.buttonElems=[],this.axesElems=[],this.analogElems=[],this.updateElem=null;var n=function(){this.loadButtonDetect(e.buttons),this.loadAxesDetect(e.axes),this.addCancelButton()}.bind(this);setTimeout(function(){n()},100),this.done=t};return r.prototype.showDetectedButtonsAndAxes=function(e,t){for(var n=0;n<e.length;n++)this.allButtonElems[n]=DomUtils.createDivElement(this.allButtons,"all_buttons_"+n,""+n,"possible_button");var r=this.allAxesElems,i=function(e,t){setTimeout(function(){r[t]=DomUtils.createDivElement(e,"all_axes_"+t,"","crtl_axis")},200)};for(n=0;n<t.length;n++){var s=DomUtils.createDivElement(this.allAxes,"all_axes_"+n,""+n,"possible_axis");i(s,n)}},r.prototype.loadButtonDetect=function(e){this.allButtons=DomUtils.createDivElement(this.buttonsBox,"all_buttons","Controller Buttons:","all_candidates");for(var t=0;t<e.length;t++)this.buttonElems[t]=DomUtils.createDivElement(this.buttonsBox,"ctrl_button_detect_"+e[t],e[t],"ctrl_button_detect")},r.prototype.loadAxesDetect=function(e){var t=function(e,t){var n=this.analogElems;setTimeout(function(){console.log("Elems: ",n),n[t]=DomUtils.createDivElement(e,"ctrl_axes_value_"+t,t,"ctrl_axes_value")},200*t)}.bind(this);this.allAxes=DomUtils.createDivElement(this.axesBox,"all_axes","Controller Axes:","all_candidates");for(var n=0;n<e.length;n++)this.axesElems[n]=DomUtils.createDivElement(this.axesBox,"ctrl_axes_detect_"+e[n],e[n],"ctrl_axes_detect"),t(this.axesElems[n],n)},r.prototype.addCancelButton=function(){var e=function(){DomUtils.removeElement(this.controllerOverlay),this.done()}.bind(this);this.cancelButton=DomUtils.createDivElement(this.controllerOverlay,"config_cancel","Close","config_cancel"),DomUtils.addElementClickFunction(this.cancelButton,e)},r.prototype.startControllerDetect=function(){return this.setupDetectElement(this.ctrlDetectBox)},r.prototype.startButtonDetect=function(e){var t="Press [ "+this.analogMap.buttons[e]+" ]";return e!=0&&(t+=" (or press [ "+this.analogMap.buttons[0]+" ] to skip)"),this.samplePrompt.innerHTML=t,this.setupDetectElement(this.buttonElems[e])},r.prototype.startAxisDetect=function(e){return this.samplePrompt.innerHTML="Move [ "+this.analogMap.axes[e]+" ] (or press [ "+this.analogMap.buttons[0]+" ] to skip)",this.analogStateElem=this.analogElems[e],this.setupDetectElement(this.axesElems[e])},r.prototype.setupDetectElement=function(e){this.updateElem=e;var t=function(t){setTimeout(function(){DomUtils.removeElementClass(e,"sampling_activated"),e.innerHTML=t,DomUtils.addElementClass(e,"sampling_successful")},200)};return DomUtils.addElementClass(e,"sampling_activated"),t},r.prototype.skipMappingOfRequestedControl=function(){DomUtils.removeElementClass(this.updateElem,"sampling_activated"),this.updateElem.style.opactiy=.5},r.prototype.controllerSetupDone=function(e){var t=function(){DomUtils.removeElement(this.controllerOverlay),e(),this.done()}.bind(this);this.doneButton=DomUtils.createDivElement(this.controllerOverlay,"config_done","Done","config_done"),DomUtils.addElementClickFunction(this.doneButton,t)},r.prototype.controllerSetupLoaded=function(e,t){var n=function(){DomUtils.removeElement(this.controllerOverlay),e(),this.done()}.bind(this);this.doneButton=DomUtils.createDivElement(this.controllerOverlay,"config_done","UseLoaded","config_done"),DomUtils.addElementClickFunction(this.doneButton,n);var r=function(){DomUtils.removeElement(this.doneButton),DomUtils.removeElement(this.redoButton),t()}.bind(this);this.redoButton=DomUtils.createDivElement(this.controllerOverlay,"config_use","Replace","config_use"),DomUtils.addElementClickFunction(this.redoButton,r)},r.prototype.updateSampleState=function(e){this.updateElem.innerHTML=e},r.prototype.showControllerButtonState=function(e,t){this.allButtonElems[e].style.backgroundColor="rgba(100, 255, 100, "+t+")"},r.prototype.showControllerAxisState=function(e,t){if(!this.allAxesElems[e])return;this.allAxesElems[e].style.backgroundColor="rgba(125"+125*t+", 125"-125*t+", 100, 1)",this.allAxesElems[e].style.left=50+50*t+"%"},r.prototype.showMappedButtonState=function(e,t,n){this.buttonElems[this.analogMap.buttons.indexOf(e.control)].style.backgroundColor="rgba(100, 255, 100, "+n+")"},r.prototype.showSamplePercent=function(e,t){this.analogStateElem.style.top=50+t*50*this.axesDirections[e].up+"%",this.analogStateElem.style.left=50+t*50*this.axesDirections[e].left+"%"},r}),define("io/AnalogState",["application/EventManager"],function(e){var t=function(e,t){this.version=t,this.controllerId=e.id,this.axesMap={},this.buttonMap={},this.altAxes=0,this.altAxesShift=e.axes.length,this.controlMap={fire_1:"cannons",fire_2:"taxi_lights",pitch:"elevator",roll:"aeilrons",yaw:"rudder",throttle:"throttle",reset_trim:"reset_trim",adjust_trim:"adjust_trim",alt_axes:"alt_axes",flaps:"flaps",canopy:"canopy",gear:"gears",brake:"breaks",look_up:"look_up",look_left:"look_left"},this.controlState={fire_1:0,fire_2:0,pitch:0,roll:0,yaw:0,throttle:0}};t.prototype.checkButtonMapping=function(e){return this.buttonMap[e]},t.prototype.checkAxesMapping=function(e){return this.axesMap[e]},t.prototype.mapButtonToControl=function(e,t){this.buttonMap[e]={control:t},console.log("MapButtonToCtrl: ",this.buttonMap,e,t)},t.prototype.mapAxisToControl=function(e,t,n,r){this.axesMap[e]&&this.axesMap[e].factor>r*n&&(r=this.axesMap[e].factor*n),this.axesMap[e]={control:t,factor:r*n},console.log("MapAxisToCtrl: ",this.axesMap,e,t,r,n)},t.prototype.mapAxes=function(e){for(var t in e)this.mapAxisToControl(e[t].key,t,e[t].factor)};var n=!1;return t.prototype.updateAxes=function(t,r,i){var s,o;n=!1;for(var u=0;u<t.length;u++){s=u+r*this.altAxesShift;if(this.axesMap[s]){o=t[u];var a=this.controlMap[this.axesMap[s].control];a&&(i?e.fireEvent(e.list().PLAYER_CONTROL_EVENT,{control:"trim_"+a,value:Math.abs(o*o)*o*this.axesMap[s].factor*.2}):a=="look_up"||a=="look_left"?(this.controlState[this.axesMap[s].control]=o,n=!0):o!=this.controlState[this.axesMap[s].control]&&(e.fireEvent(e.list().PLAYER_CONTROL_EVENT,{control:a,value:Math.abs(o*o)*o*this.axesMap[s].factor}),this.controlState[this.axesMap[s].control]=o))}}if(n)e.fireEvent(e.list().SET_CAMERA_ANALOGS,{rotX:this.controlState.look_left,rotY:this.controlState.look_up,rotZ:0});else if(this.controlState["look_left"]!=0||this.controlState[!0])this.controlState.look_left=0,this.controlState.look_up=0,e.fireEvent(e.list().SET_CAMERA_ANALOGS,{rotX:this.controlState.look_left,rotY:this.controlState.look_up,rotZ:0})},t.prototype.updateButtons=function(t){for(var n in this.buttonMap)t[n].value!=this.controlState[this.buttonMap[n].control]&&(console.log("Button changed",n,this.buttonMap[n],t[n]),this.controlMap[this.buttonMap[n].control]&&(e.fireEvent(e.list().PLAYER_CONTROL_EVENT,{control:this.controlMap[this.buttonMap[n].control],value:t[n].value}),this.controlState[this.buttonMap[n].control]=t[n].value))},t}),define("goo/renderer/pass/Composer",["goo/renderer/pass/RenderTarget","goo/renderer/pass/FullscreenPass","goo/renderer/shaders/ShaderLib","goo/entities/SystemBus"],function(e,t,n,r){function s(i){this._passedWriteBuffer=!!i,this.writeBuffer=i;if(this.writeBuffer===undefined){var s=window.innerWidth||1,o=window.innerHeight||1;this.writeBuffer=new e(s,o)}this.readBuffer=this.writeBuffer.clone(),this.passes=[],this._clearColor=[0,0,0,1],this.copyPass=new t(n.copy),this.size=null,this.dirty=!1,this._viewportResizeHandler=function(e){this.dirty=!0,this.size=e}.bind(this),r.addListener("goo.viewportResize",this._viewportResizeHandler,!0)}var i=window.WebGLRenderingContext;return s.prototype.destroy=function(e){this.deallocateBuffers(e);for(var t=0;t<this.passes.length;t++){var n=this.passes[t];n.destroy(e)}r.removeListener("goo.viewportResize",this._viewportResizeHandler)},s.prototype.deallocateBuffers=function(e){this.writeBuffer&&!this._passedWriteBuffer&&this.writeBuffer.destroy(e.context),this.readBuffer&&this.readBuffer.destroy(e.context),this.copyPass.destroy(e)},s.prototype.swapBuffers=function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},s.prototype._checkPassResize=function(e,t){return!e.viewportSize||e.viewportSize.x!==t.x||e.viewportSize.y!==t.y||e.viewportSize.width!==t.width||e.viewportSize.height!==t.height},s.prototype.addPass=function(e,t){this.passes.push(e),e.updateSize&&this.size&&this._checkPassResize(e,this.size)&&(e.updateSize(this.size,t),e.viewportSize=this.size)},s.prototype.setClearColor=function(e){this._clearColor[0]=e[0],this._clearColor[1]=e[1],this._clearColor[2]=e[2],this._clearColor[3]=e[3]},s.prototype.updateSize=function(t){var n=this.size;if(!n)return;var r=n.width,i=n.height;this.deallocateBuffers(t),this.writeBuffer=new e(r,i),this.readBuffer=this.writeBuffer.clone();for(var s=0,o=this.passes.length;s<o;s++){var u=this.passes[s];u.updateSize&&this._checkPassResize(u,n)&&(u.updateSize(n,t),u.viewportSize=n)}},s.prototype.render=function(e,t,n,r){this.dirty&&(this.updateSize(e),this.dirty=!1);var s=!1,o,u,a=this.passes.length;for(u=0;u<a;u++){o=this.passes[u];if(!o.enabled)continue;o.render(e,this.writeBuffer,this.readBuffer,t,s,n,r,this._clearColor);if(o.needsSwap){if(s){var f=this.renderer.context;f.stencilFunc(i.NOTEQUAL,1,4294967295),this.copyPass.render(e,this.writeBuffer,this.readBuffer,t,n,r),f.stencilFunc(i.EQUAL,1,4294967295)}this.swapBuffers()}}},s}),define("io/OculusRiftScripts",["goo/renderer/Material","goo/renderer/pass/Composer","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/renderer/Camera","goo/math/Vector3","goo/util/ArrayUtil"],function(e,t,n,r,i,s,o){var u=function(){this.parameters=[{key:"boost3D",name:"Boost 3D Effect",type:"float",control:"slider","default":1,min:1,max:20}]};return u.prototype.setup=function(e){this.goo=e,this.world=e.world,this.pass=new RiftRenderPass(this,e),this.active=!1},u.prototype.updateConfig=function(e){this.pass.updateConfig(e)},u.prototype.cleanup=function(e){this.hasPreEffect(e)&&PassSwitcher.switchBack(this,e)},u.prototype.update=function(){this.hasPreEffect()&&PassSwitcher.switchBack(this,this.goo),PassSwitcher.switchPass(this.pass,this,this.goo),console.log("mee")},u.prototype.hasPreEffect=function(e){var t=this.world.getSystem("RenderSystem");return t.composers.length===0?!1:!0},function(e){var n=null,r=null,i=null,s={switchPass:function(e,s,o){console.log("Switch Pass",e,s,o),i=e;var u=s.world.getSystem("RenderSystem"),a;u.composers.length?(a=u.composers[0],n=a.passes.shift(),e.renderToScreen=!1):(r=a=new t,u.composers.push(a),e.renderToScreen=!0),a.passes.unshift(e),a.size&&(e.updateSize instanceof Function&&e.updateSize(a.size,s.world.gooRunner.renderer),e.viewportSize=a.size)},switchBack:function(e,t){var s=e.world.getSystem("RenderSystem");if(r)r.destroy(e.world.gooRunner.renderer),o.remove(s.composers,r);else{var u=s.composers[0];o.remove(u.passes,i),u.passes.unshift(n)}}};e.PassSwitcher=s}(window),function(){function t(t,r){this.goo=r,this.ctx=t,this.camera=new i,this.fullscreenCamera=n.camera,this.renderToScreen=!1,this.clear=!0,this.enabled=!0,this.needsSwap=!0,this.eyeOffset=.4,this.fov=100,this.material=new e("Composit material",o),this.updateSize({width:16,height:9}),this.offsetVector=new s,this.renderable={meshData:n.quad,materials:[this.material]},this.renderList=t.world.getSystem("RenderSystem").renderList,this.setup(t,r)}t.prototype.setup=function(e){this.boost=1},t.prototype.destroy=function(e){this.leftTarget.destroy(e.context),this.rightTarget.destroy(e.context),this.leftTarget=null,this.rightTarget=null},t.prototype.updateConfig=function(e){var t=this.material.uniforms;t.distortion=e.distortionK,t.aberration=e.chromAbParameter,t.lensCenterOffset=[e.lensSeparationDistance/e.hScreenSize-.5,0],this.fov=e.FOV,this.eyeOffset=e.interpupillaryDistance*this.boost;var n=-1-4*(e.hScreenSize/4-e.lensSeparationDistance/2)/e.hScreenSize,r=e.distortionK[0]+e.distortionK[1]*Math.pow(n,2)+e.distortionK[2]*Math.pow(n,4)+e.distortionK[3]*Math.pow(n,6);t.scale=[1/r,1/r]},t.prototype.updateSize=function(e,t){this.material.uniforms.scaleIn=[e.width*.5/e.height,1];if(!this.leftTarget){var e=1024;this.leftTarget=new r(e,e),this.rightTarget=new r(e,e)}},t.prototype.render=function(e,t,n,r,i,s,o,u){s=s||this.goo.Renderer.mainCamera;if(!s)return;this.camera.copy(s),this.camera.setFrustumPerspective(this.fov,1),o=o||[];var a=this.renderList;this.offsetVector.setv(this.camera._left).scale(this.eyeOffset),this.camera.translation.addv(this.offsetVector),this.camera.update(),e.render(a,this.camera,o,this.leftTarget,this.clear),this.offsetVector.scale(2),this.camera.translation.subv(this.offsetVector),this.camera.update(),e.render(a,this.camera,o,this.rightTarget,this.clear),this.material.setTexture("LEFT_TEX",this.leftTarget),this.material.setTexture("RIGHT_TEX",this.rightTarget),this.renderToScreen?e.render(this.renderable,this.fullscreenCamera,[],null,this.clear):e.render(this.renderable,this.fullscreenCamera,[],t,this.clear)},t.parameters=[{key:"eyeDistance",type:"float",min:0,max:.4,"default":.1,control:"slider"}];var o={attributes:{vertexPosition:"POSITION",vertexUV0:"TEXCOORD0"},uniforms:{viewMatrix:"VIEW_MATRIX",projectionMatrix:"PROJECTION_MATRIX",worldMatrix:"WORLD_MATRIX",leftTex:"LEFT_TEX",rightTex:"RIGHT_TEX",lensCenterOffset:[0,0],distortion:[1,.22,.24,0],aberration:[.996,-0.004,1.014,0],scaleIn:[1,1],scale:[.8,.8]},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D leftTex;","uniform sampler2D rightTex;","uniform vec2 scaleIn;","uniform vec2 scale;","uniform vec2 lensCenterOffset;","uniform vec4 distortion;","uniform vec4 aberration;","varying vec2 vUv;","vec2 distort(vec2 texCoords, vec2 ab) {","vec2 lensCoords = ((texCoords * 2.0 - 1.0) - lensCenterOffset) * scaleIn;","float rSq = dot(lensCoords, lensCoords);","vec4 r = vec4(1.0, rSq, rSq*rSq, rSq*rSq*rSq);","vec2 newCoords = lensCoords * dot(ab, r.xy) * dot(distortion, r);","return ((newCoords * scale + lensCenterOffset) + 1.0) / 2.0;","}","void main() {","vec2 coord = vUv;","if (vUv.x > 0.5) {","coord.x = 1.0 - coord.x;","}","coord.x *= 2.0;","vec2 blue = distort(coord, aberration.zw);","if (!all(equal(clamp(blue, vec2(0.0), vec2(1.0)), blue))) {","discard;","}","vec2 red = distort(coord, aberration.xy);","vec2 green = distort(coord, vec2(1.0, 0.0));","gl_FragColor.a = 1.0;","if (vUv.x > 0.5) {","red.x = 1.0 - red.x;","green.x = 1.0 - green.x;","blue.x = 1.0 - blue.x;","gl_FragColor.r = texture2D(rightTex, red).r;","gl_FragColor.g = texture2D(rightTex, green).g;","gl_FragColor.b = texture2D(rightTex, blue).b;","} else {","gl_FragColor.r = texture2D(leftTex, red).r;","gl_FragColor.g = texture2D(leftTex, green).g;","gl_FragColor.b = texture2D(leftTex, blue).b;","}","}"].join("\n")};window.RiftRenderPass=t}(),{RiftRenderScript:u}}),define("goo/math/Quaternion",["goo/math/Vector","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r){function i(){e.call(this,4),arguments.length!==0?e.prototype.set.apply(this,arguments):this.data[3]=1,Object.seal(this)}function o(e,t){var n=!1;return function(){return n||(n=!0,console.warn(t)),e.apply(this,arguments)}}i.prototype=Object.create(e.prototype),i.prototype.constructor=i,e.setupAliases(i.prototype,[["x"],["y"],["z"],["w"]]),i.IDENTITY=new i(0,0,0,1),i.ALLOWED_DEVIANCE=1e-8,i.add=function(e,t,n){return n||(n=new i),n.data[0]=e.data[0]+t.data[0],n.data[1]=e.data[1]+t.data[1],n.data[2]=e.data[2]+t.data[2],n.data[3]=e.data[3]+t.data[3],n},i.sub=function(e,t,n){return n||(n=new i),n.data[0]=e.data[0]-t.data[0],n.data[1]=e.data[1]-t.data[1],n.data[2]=e.data[2]-t.data[2],n.data[3]=e.data[3]-t.data[3],n},i.mul=function(e,t,n){var r=e.data[0],i=e.data[1],s=e.data[2],o=e.data[3],u=t.data[0],a=t.data[1],f=t.data[2],l=t.data[3];return n.data[0]=r*l+o*u+i*f-s*a,n.data[1]=i*l+o*a+s*u-r*f,n.data[2]=s*l+o*f+r*a-i*u,n.data[3]=o*l-r*u-i*a-s*f,n},i.div=function(e,t,n){n||(n=new i);var r=!0;return n.data[0]=(r&=t.data[0]<0||t.data[0]>0)?e.data[0]/t.data[0]:0,n.data[1]=(r&=t.data[1]<0||t.data[1]>0)?e.data[1]/t.data[1]:0,n.data[2]=(r&=t.data[2]<0||t.data[2]>0)?e.data[2]/t.data[2]:0,n.data[3]=(r&=t.data[3]<0||t.data[3]>0)?e.data[3]/t.data[3]:0,n},i.scalarAdd=function(e,t,n){return n||(n=new i),n.data[0]=e.data[0]+t,n.data[1]=e.data[1]+t,n.data[2]=e.data[2]+t,n.data[3]=e.data[3]+t,n},i.scalarSub=function(e,t,n){return n||(n=new i),n.data[0]=e.data[0]-t,n.data[1]=e.data[1]-t,n.data[2]=e.data[2]-t,n.data[3]=e.data[3]-t,n},i.scalarMul=function(e,t,n){return n||(n=new i),n.data[0]=e.data[0]*t,n.data[1]=e.data[1]*t,n.data[2]=e.data[2]*t,n.data[3]=e.data[3]*t,n},i.scalarDiv=function(e,t,n){n||(n=new i);var r=!0;return t=(r&=t<0||t>0)?1/t:0,n.data[0]=e.data[0]*t,n.data[1]=e.data[1]*t,n.data[2]=e.data[2]*t,n.data[3]=e.data[3]*t,n},i.slerp=function(e,t,n,r){if(n===0)return r.setVector(e);if(n===1)return r.setVector(t);if(e.equals(t))return r.setVector(e);var i=e.dot(t);r.setVector(t),i<0&&(r.negate(),i=-i);var s=1-n,o=n;if(1-i>.1){var u=Math.acos(i),a=1/Math.sin(u);s=Math.sin((1-n)*u)*a,o=Math.sin(n*u)*a}var f=s*e.data[0]+o*r.data[0],l=s*e.data[1]+o*r.data[1],c=s*e.data[2]+o*r.data[2],h=s*e.data[3]+o*r.data[3];return r.setDirect(f,l,c,h),r},i.prototype.negate=function(){return this.data[0]*=-1,this.data[1]*=-1,this.data[2]*=-1,this.data[3]*=-1,this},i.prototype.conjugate=function(){return this.data[0]*=-1,this.data[1]*=-1,this.data[2]*=-1,this},i.prototype.invert=function(){return this.conjugate().normalize()},i.prototype.dot=function(e){var t=this.data,n=e.data||e,r=0;return r+=t[0]*n[0],r+=t[1]*n[1],r+=t[2]*n[2],r+=t[3]*n[3],r},i.prototype.add=function(e){return i.add(this,e,this)},i.prototype.sub=function(e){return i.sub(this,e,this)},i.prototype.mul=function(e){return i.mul(this,e,this)},i.prototype.div=function(e){return i.div(this,e,this)},i.prototype.scalarAdd=function(e){return i.scalarAdd(this,e,this)},i.prototype.scalarSub=function(e){return i.scalarSub(this,e,this)},i.prototype.scalarMul=function(e){return i.scalarMul(this,e,this)},i.prototype.scalarDiv=function(e){return i.scalarDiv(this,e,this)};var s;return i.prototype.slerp=function(e,t){return s||(s=new i),s.copy(e),i.slerp(this,e,t,s),this.copy(s),this},i.prototype.fromRotationMatrix=function(e){var t=e.e00+e.e11+e.e22,n,r,i,s;if(t>=0){var o=Math.sqrt(t+1);s=.5*o,o=.5/o,n=(e.e21-e.e12)*o,r=(e.e02-e.e20)*o,i=(e.e10-e.e01)*o}else if(e.e00>e.e11&&e.e00>e.e22){var o=Math.sqrt(1+e.e00-e.e11-e.e22);n=o*.5,o=.5/o,r=(e.e10+e.e01)*o,i=(e.e02+e.e20)*o,s=(e.e21-e.e12)*o}else if(e.e11>e.e22){var o=Math.sqrt(1+e.e11-e.e00-e.e22);r=o*.5,o=.5/o,n=(e.e10+e.e01)*o,i=(e.e21+e.e12)*o,s=(e.e02-e.e20)*o}else{var o=Math.sqrt(1+e.e22-e.e00-e.e11);i=o*.5,o=.5/o,n=(e.e02+e.e20)*o,r=(e.e21+e.e12)*o,s=(e.e10-e.e01)*o}return this.setDirect(n,r,i,s)},i.prototype.toRotationMatrix=function(e){var t=e;t||(t=new n);var r=this.magnitudeSquared(),i=r>0?2/r:0,s=this.data,o=s[0]*i,u=s[1]*i,a=s[2]*i,f=s[0]*o,l=s[0]*u,c=s[0]*a,h=s[3]*o,p=s[1]*u,d=s[1]*a,v=s[3]*u,m=s[2]*a,g=s[3]*a,y=t.data;return y[0]=1-(p+m),y[1]=l+g,y[2]=c-v,y[3]=l-g,y[4]=1-(f+m),y[5]=d+h,y[6]=c+v,y[7]=d-h,y[8]=1-(f+p),t},i.prototype.fromVectorToVector=function(e,n){var s=e,o=n,u=s.length()*o.length();if(Math.abs(u)>r.EPSILON){var a=new t,f=s.dot(o)/u,l=Math.acos(Math.max(-1,Math.min(f,1)));t.cross(s,o,a);if(f<0&&a.length()<r.EPSILON){var c;Math.abs(s.x)>Math.abs(s.y)?Math.abs(s.x)>Math.abs(s.z)?c=0:c=2:Math.abs(s.y)>Math.abs(s.z)?c=1:c=2,a.setValue(c,-s[(c+1)%3]),a.setValue((c+1)%3,s[c]),a.setValue((c+2)%3,0)}return this.fromAngleAxis(l,a)}return this.setVector(i.IDENTITY)},i.prototype.normalize=function(){var e=1/this.magnitude(),t=this.x*e,n=this.y*e,r=this.z*e,i=this.w*e;return this.setDirect(t,n,r,i)},i.prototype.magnitude=function(){var e=this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3];return e===1?1:Math.sqrt(e)},i.prototype.magnitudeSquared=function(){return this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3]},i.prototype.fromAngleAxis=function(e,n){var r=(new t(n)).normalize();return this.fromAngleNormalAxis(e,r)},i.prototype.fromAngleNormalAxis=function(e,n){if(n.equals(t.ZERO))return this.setVector(i.IDENTITY);var r=.5*e,s=Math.sin(r),o=Math.cos(r),u=s*n.x,a=s*n.y,f=s*n.z;return this.setDirect(u,a,f,o)},i.prototype.toAngleAxis=function(e){var t=this.x*this.x+this.y*this.y+this.z*this.z,n;if(Math.abs(t)<=i.ALLOWED_DEVIANCE)n=0,e!==null&&(e.x=1,e.y=0,e.z=0);else{n=2*Math.acos(this.w);if(e!==null){var r=1/Math.sqrt(t);e.x=this.x*r,e.y=this.y*r,e.z=this.z*r}}return n},i.prototype.equals=function(e){return this===e?!0:e instanceof i?Math.abs(this.data[0]-e.data[0])<i.ALLOWED_DEVIANCE&&Math.abs(this.data[1]-e.data[1])<i.ALLOWED_DEVIANCE&&Math.abs(this.data[2]-e.data[2])<i.ALLOWED_DEVIANCE&&Math.abs(this.data[3]-e.data[3])<i.ALLOWED_DEVIANCE:!1},i.prototype.setDirect=function(e,t,n,r){return this.data[0]=e,this.data[1]=t,this.data[2]=n,this.data[3]=r,this},i.prototype.setd=o(i.prototype.setDirect,".setd is deprecated; please use .setDirect instead"),i.prototype.setArray=function(e){return this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this},i.prototype.seta=o(i.prototype.setArray,".seta is deprecated; please use .setArray instead"),i.prototype.setVector=function(e){return this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[3]=e.data[3],this},i.prototype.setv=o(i.prototype.setVector,".setv is deprecated; please use .setVector instead"),i.prototype.clone=function(){return new i(this)},e.addPostChecks(i.prototype,["add","sub","mul","slerp","fromRotationMatrix","fromVectorToVector","normalize","magnitude","magnitudeSquared","fromAngleAxis","fromAngleNormalAxis","setDirect","setVector"]),i}),define("io/OculusRiftInput",["application/EventManager","io/OculusRiftScripts","goo/math/Quaternion"],function(e,t,n){var r=function(){this.bridge=null,this.config=null,this.useRiftRendering=!1};r.prototype.riftConfig=function(e){this.config=e,console.log("Config update: ",e)};var i=!1;return r.prototype.seekRiftBridge=function(){i=!0;var t=function(t,r){if(!window.OculusBridge)return!1;var i=!0;return t.orientation=new n,t.bridge=new OculusBridge({onConnect:function(){i=!1,console.log("connected"),r(t.bridge)},onOrientationUpdate:function(n){t.orientation.setd(n.x,n.y,n.z,n.w),e.fireEvent(e.list().OCULUS_RIFT_QUATERNION,{quat:t.orientation})},onAccelerationUpdate:function(e){},onConfigUpdate:function(e){t.riftConfig(e)}}),t.bridge.connect(),setTimeout(function(){i&&t.bridge.disconnect()},2e3),t.bridge},r=function(e,t){e.bridge&&e.bridge.disconnect()},s=function(e){if(!i)return;var n=(new Date).getTime()*.003,r=Math.round(99+Math.sin(n)*88),o=Math.round(100+Math.cos(n)*25),u=Math.round(99+Math.sin(.5+n)*44),a=t(this,e);a?(i=!1,setTimeout(function(){document.getElementById("rift_enabled").innerHTML="Oculus Rift Bridge Detected",document.getElementById("rift_enabled").style.color="#CFC"},200)):requestAnimationFrame(function(){s(e)})}.bind(this),o=function(t){console.log("Oculus Rift Connection Detected",t),setTimeout(function(){document.getElementById("rift_enabled").innerHTML="Oculus Rift Connection Established",document.getElementById("rift_controller").style.backgroundColor="rgb(37, 219, 37)",document.getElementById("rift_controller").innerHTML="Click to Use",document.getElementById("rift_enabled").style.color="#EFE"},400);var n=function(t){if(e.eventArgs(t).controllerType!="OculusRift")return;this.enableRiftMode()}.bind(this);e.registerListener(e.list().CONFIGURE_CONTROLLER,n)}.bind(this);s(o),setTimeout(function(){document.getElementById("rift_controller").style.backgroundColor="rgb(137, 100, 37)",document.getElementById("rift_controller").innerHTML="Connect Rift..",document.getElementById("rift_enabled").innerHTML="Seeking Oculus Rift",document.getElementById("rift_enabled").style.color="#FC7"},50)},r.prototype.enableRiftMode=function(){document.getElementById("rift_controller").innerHTML="Rift Active",document.getElementById("rift_enabled").innerHTML="Oculus Rift Rendering Enabled",console.log("Enable Rift Mode",this),this.useRiftRendering=!0,this.riftRenderScript=new t.RiftRenderScript;var n=function(t){this.riftRenderScript.setup(e.eventArgs(t).goo),this.riftRenderScript.update(e.eventArgs(t).goo)}.bind(this);e.registerListener(e.list().ENINGE_READY,n)},r.prototype.tickRiftInput=function(){},r}),define("io/AnalogInput",["application/EventManager","io/AnalogFeedback","io/AnalogState","io/OculusRiftInput"],function(e,t,n,r){var i,s,o=new r,u={version:"0.1",axes:["pitch","roll","yaw","throttle","flaps","look_up","look_left"],buttons:["fire_1","alt_axes","adjust_trim","reset_trim","adjust_yaw","gear","canopy","brake"]},a=function(e,t,n){e(n+"<br>button: "+t),i.mapButtonToControl(t,n)},f=function(e,t){for(var n=0;n<e.buttons.length;n++){var r=i.checkButtonMapping(n);if(r&&r.control==u.buttons[u.buttons.indexOf(t)]&&e.buttons[n].pressed)return 1}return 0},l=function(e){s.showDetectedButtonsAndAxes(e.buttons,e.axes);var t=!1,n=0,r=0,o={},l={},c=function(e,r){l.buttonId||(l.onDetect=s.startButtonDetect(n));for(var u=0;u<e.buttons.length;u++)o[u]!=e.buttons[u].pressed&&t&&(i.checkButtonMapping(u)||(s.updateSampleState(e.buttons[u].value),l.buttonNr=u,l.buttonId=r)),o[u]=e.buttons[u].pressed;t=!0;for(u=0;u<e.buttons.length;u++)e.buttons[u].pressed&&(t=!1);t&&l.buttonId&&(a(l.onDetect,l.buttonNr,l.buttonId),l={},n+=1)},h=!1,p=function(e,t){for(var o=0;o<t.buttons.length;o++){var a=i.checkButtonMapping(o);a&&(a.control==u.buttons[0]&&(!h&&t.buttons[o].pressed&&(h=!0),h&&!t.buttons[o].pressed&&(r!=0?r+=1:n+=1,s.skipMappingOfRequestedControl(),h=!1)),s.showMappedButtonState(a,o,t.buttons[o].value)),s.showControllerButtonState(o,t.buttons[o].value)}for(o=0;o<t.axes.length;o++)s.showControllerAxisState(o,t.axes[o]);var f=function(){c(t,u.buttons[n])};u.buttons[n]?f():e(t)},v={},m=0,g=0,y=.5,b,w=0,E=0,x={axes:{}},T=function(e,t){var n=0,o=s.startAxisDetect(r),u=f(e,"alt_axes"),a=e.axes.length*u;for(var l=0;l<e.axes.length;l++)x.axes[l]!=e.axes[l]&&(Math.abs(e.axes[l])>Math.abs(e.axes[n])&&(n=l),x.axes[l]=e.axes[l]);console.log("Biggest:",n,"AltAxis:",u);if(Math.abs(e.axes[n])>y){if(Math.abs(m)<Math.abs(e.axes[n])){v[n]!=e.axes[n]&&(g+=1),E=m,console.log("Growing: ",t,g,m),s.showSamplePercent(t,e.axes[n]);if(g>5){w=n;if(!i.checkAxesMapping(w+a)){clearTimeout(b);var c=1-Math.abs(E);i.mapAxisToControl(w+a,t,N,Math.round(E)),y=.5,r+=1;var h=t+"<br> axis: "+w;u&&(h+=" alt"),o(h),g=0}}}m=e.axes[n],v[n]=e.axes[n]}else t&&s.showSamplePercent(t,0),clearTimeout(b)},N=1,C=function(){localStorage.setItem(i.controllerId,JSON.stringify(i)),S(i.controllerId)},k=function(e){var t=function(){T(e,u.axes[r])};u.axes[r]?t():L=function(){s.controllerSetupDone(C),console.log("Axes Mapping ended")}},L=function(){p(k,d()),requestAnimationFrame(function(){L()})};L()},c,h=function(e){var t=function(){console.log("Loaded controller from localStorage: ",e,c),i.axesMap=c.axesMap,i.buttonMap=c.buttonMap,S(e.id),document.getElementById("config_controller").innerHTML="Edit Loaded"},r=function(){};i=new n(e,u.version),c=JSON.parse(localStorage.getItem(e.id)),c&&c.version==u.version&&t()},p=function(r){console.log("Configure Controller: ",r);if(e.eventArgs(r).controllerType!="GamePad")return;v=!0,i=null;var o=function(e){console.log("Remap Controller: ",e),i=new n(e,u.version),s=new t(u,E);var r=s.startControllerDetect();setTimeout(function(){r(e.id),l(e)},300)};m(o)};e.registerListener(e.list().CONFIGURE_CONTROLLER,p);var d=function(){var e=navigator.getGamepads();for(var t=0;t<e.length;t++)if(e[t])return e[t]},v=!1,m=function(e){if(!v)return;var t=(new Date).getTime()*.005,n=Math.round(99+Math.sin(t)*88),r=Math.round(100+Math.cos(t)*25),s=Math.round(99+Math.sin(.5+t)*44),o=d();o&&!i?(v=!1,e(o)):requestAnimationFrame(function(){m(e)})},g=function(e){h(e),document.getElementById("config_controller").style.backgroundColor="rgb(117, 200, 37)",document.getElementById("controller_enabled").innerHTML=e.id,document.getElementById("controller_enabled").style.color="#FEA"},y=!1,b=function(){if(v||y)return;v=!0,i=null;var e=function(e){g(e)};setTimeout(function(){},1300)},w=function(){y=!0,E()},E=function(){console.log("End GamePad config"),v=!1},S=function(e){document.getElementById("config_controller").style.backgroundColor="rgb(37, 219, 37)",document.getElementById("controller_enabled").innerHTML=e,document.getElementById("controller_enabled").style.color="#EFE"},x=function(){if(i){var e=d();i.updateButtons(e.buttons),i.updateAxes(e.axes,f(e,"alt_axes"),f(e,"adjust_trim"))}};e.registerListener(e.list().SCENARIO_SELECTED,w),e.registerListener(e.list().RENDER_TICK,x),e.registerListener(e.list().LOADING_COMPLETED,b)}),define("io/KeyboardHandler",["application/EventManager","game/GameConfiguration"],function(e,t){var n={eject:{control:"eject",value:1},canopy:{control:"canopy",value:1},gears:{control:"gears",value:1},cannons:{control:"cannons",value:1},flapsDown:{control:"flaps",value:1},flapsUp:{control:"flaps",value:-1},throttleUp:{control:"throttle",value:1},throttleDown:{control:"throttle",value:-1},breaksOn:{control:"breaks",value:1},breaksOff:{control:"breaks",value:-1},pitchUp:{control:"elevator",value:1},pitchDown:{control:"elevator",value:-1},trimPitchUp:{control:"trim_elevator",value:.3},trimPitchDown:{control:"trim_elevator",value:-0.3},rollLeft:{control:"aeilrons",value:1},rollRight:{control:"aeilrons",value:-1},trimRollLeft:{control:"trim_aeilrons",value:.3},trimRollRight:{control:"trim_aeilrons",value:-0.3},yawLeft:{control:"rudder",value:1},yawRight:{control:"rudder",value:-1},trimYawLeft:{control:"trim_rudder",value:.3},trimYawRight:{control:"trim_rudder",value:-0.3},wingSmoke:{control:"wing_smoke",value:1},forward:{control:"forward",value:1},back:{control:"back",value:1},turnleft:{control:"turnleft",value:1},turnright:{control:"turnright",value:1},strafeModifier:{control:"strafe",value:1},jump:{control:"jump",value:1}},r=function(t,r){r?e.fireEvent(e.list().PLAYER_CONTROL_EVENT,{control:n[t].control,value:n[t].value}):e.fireEvent(e.list().PLAYER_CONTROL_EVENT,{control:n[t].control})},i=function(t){r(e.eventArgs(t).control,e.eventArgs(t).value)};return e.registerListener(e.list().UPDATE_KEYBINDING,i),{}}),define("data_pipeline/data/CanvasGuiImages",["data_pipeline/GameDataPipeline","data_pipeline/data/ConfigCache"],function(e,t){var n=function(){this.urls={},this.data={},this.svg={},this.bin={}};return n.prototype.getImageData=function(e){return this.data[e]},n.prototype.downloadSvgImageRef=function(n,r){var i=function(e,r){this.data[n].svg=r,this.data[n].image=new Image,this.data[n].loaded=!1,this.data[n].image.onload=function(){this.data[n].loaded=!0,t.imageDataLoaded(n)}.bind(this),this.data[n].image.src=e}.bind(this),s=function(e){console.error("Image download error",e)};e.loadSvgFromUrl(r,i,s,!0)},n.prototype.downloadBinaryImageRef=function(n,r){this.data[n].image=new Image;var i=function(e,r){this.data[n].bin=r,this.data[n].loaded=!1,this.data[n].image.onload=function(){this.data[n].loaded=!0,t.imageDataLoaded(n)}.bind(this),this.data[n].image.src=e}.bind(this),s=function(e){console.error("Image download error",e)};e.loadImageFromUrl(r,i,s,!0)},n.prototype.registerBinaryImageRefs=function(e){for(var n in e)this.data[n]||(t.storeImageRef(n,{id:n,url:e[n]}),this.data[n]=t.getImageRef(n),this.downloadBinaryImageRef(n,window.resourcePath+e[n]))},n.prototype.registerSvgImageRefs=function(e){for(var n in e)this.data[n]||(t.storeImageRef(n,{id:n,url:e[n]}),this.data[n]=t.getImageRef(n),this.downloadSvgImageRef(n,e[n]))},n}),define("gui/GuiConfigLoader",["data_pipeline/data/CanvasGuiImages","data_pipeline/data/ConfigCache"],function(e,t){var n={pollData:!0},r=function(){this.registryUrls={};var n=function(e,n){t.applyDataPipelineOptions(n)};t.registerCategoryKeySubscriber("setup","pipeline",n),this.canvasGuiImages=new e};return r.prototype.grabSvgImages=function(e){this.canvasGuiImages.registerSvgImageRefs(e)},r.prototype.grabBinaryImages=function(e){this.canvasGuiImages.registerBinaryImageRefs(e)},r.prototype.loadConfigDataFile=function(e,n,r){var i=function(e,r){for(var i=0;i<r.length;i++)for(var s in r[i])t.dataCombineToKey(s,e,r[i]),n(r[i][s],e),t.registerCategoryUpdatedCallback(s,n),s=="svg"&&this.grabSvgImages(r[i][s]),s=="bin"&&this.grabBinaryImages(r[i][s])}.bind(this);t.cacheFromUrl(e,i,r)},r.prototype.loadFiles=function(e,n,r){var i=0,s=function(){i-=1;if(i==0){if(!n)return;r[n].success(n)}}.bind(this),o=function(e){console.error("Epic Fail: ",t,this.registryUrls),this.registryUrls[n].fail(e)};for(var u in e)for(var a=0;a<e[u].length;a++)i+=1,this.loadConfigDataFile(e[u][a],s,o)},r.prototype.initConfigs=function(e,t,n){this.registryUrls[e]={success:t,fail:n};var r=function(e,t){this.loadFiles(e,t,this.registryUrls)}.bind(this);this.loadConfigDataFile(e,r,n)},r}),define("gui/layout/LayoutEnums",[],function(){var e={percent:"%",pixels:"px",screen:"scr"},t={box:"box",line:"line",image:"image"};return{units:e,shapes:t}}),define("gui/layout/GuiConstants",["gui/layout/GuiConstants","data_pipeline/data/ConfigCache"],function(e,t){function n(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var r=0,i=e.length;r<i;r++)t[r]=n(e[r]);return t}if(e instanceof Object){t={};for(var s in e)e.hasOwnProperty(s)&&(t[s]=n(e[s]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}var r=t.getCategory("layout_key_maps"),i=t.getCategory("layout_constants"),s=[],o=[],u=function(e,t){s=[];for(var n in t)s.push(n);r=t},a=function(e,t){o=[];for(var n in t)o.push(n);i=t};t.registerCategoryUpdatedCallback("layout_key_maps",u),t.registerCategoryUpdatedCallback("layout_constants",a),u(r),a(i);var e=function(){};return e.traverseSourceAgainstList=function(e,t,n){var r=function(e){for(var i in e)t.indexOf(e[i])!=-1?e[i]=n[e[i]]:typeof e[i]=="object"&&r(e[i])};r(e)},e.applyConstantValues=function(t){e.traverseSourceAgainstList(t,o,n(i))},e.applyLayoutRules=function(t){e.traverseSourceAgainstList(t,s,n(r))},e.clone=function(e){return n(e)},e}),define("gui/layout/CanvasBoxLayout",["gui/layout/GuiConstants"],function(e){var t=function(){};return t.layoutBorder=function(e,t,n){n.box={},n.box.y=n.pos.final.top,n.box.x=n.pos.final.left,n.box.w=n.size.width,n.box.h=n.size.height,n.box.color=e.toRgba(t.color),n.box.lineW=e.valueXToUnitX(t.line_width,t.unit)},t.configureText=function(e,t,n,r){n.text={},n.text.y=r.valueYToUnitY(t.top,t.unit,e)+n.size.height*.5,n.text.x=r.valueXToUnitX(t.left,t.unit,e)+n.size.width*.5,n.text.line_height=e.pxToX(t.font_size)+t.line_spacing||e.pxToX(t.font_size)*.5,n.text.font=e.pxToX(t.font_size)+"px "+t.font_family,typeof t.color=="string"&&console.error("Bad text color:",t.color,t),n.text.color=e.toRgba(t.color),n.text.align_text=t.text_align||"start"},t.layoutBackground=function(e,t,n){t.color&&(n.rect={},n.rect.y=n.pos.final.top,n.rect.x=n.pos.final.left,n.rect.w=n.size.width,n.rect.h=n.size.height,typeof t.color=="string"&&console.error("Bad background...",t,n),n.rect.color=e.toRgba(t.color)),t.image_svg&&(n.backgroundSvg=t.image_svg),t.image_bin&&(n.backgroundBin=t.image_bin)},t.applyPosition=function(e,t,n,r,i){n.final.top=i.valueYToUnitY(t.top,t.unit,e),n.final.left=i.valueXToUnitX(t.left,t.unit,e)},t.applyShape=function(e,t,n,r){t.unit=="%"?(n.size.height=r.valueToHeightPercent(t.height),n.size.width=r.valueToWidthPercent(t.width)):(n.size.height=e.valueYToUnitY(t.height,t.unit),n.size.width=e.valueXToUnitX(t.width,t.unit)),n.data.xMin=e.pxToPercentX(n.pos.final.left),n.data.xMax=e.pxToPercentX(n.pos.final.left+n.size.width),n.data.yMin=e.pxToPercentY(n.pos.final.top),n.data.yMax=e.pxToPercentY(n.pos.final.top+n.size.height),isNaN(n.data.xMax)&&console.error("Bad data: ",e,t,n,r)},t.layoutCanvasBox=function(e,n,r,i){t.applyPosition(e,n.pos,r.renderData.pos,i.renderData.pos.final,i),n.shape&&t.applyShape(e,n.shape,r.renderData,i),n.border&&t.layoutBorder(e,n.border,r.renderData),n.background&&t.layoutBackground(e,n.background,r.renderData),n.text&&t.configureText(e,n.text,r.renderData,r)},t}),define("gui/functions/UiCallbacks",[],function(){var e=function(){},t={};return e.registerDrawCallback=function(e,n){t[e]=n},e.addDrawCallbacks=function(t){for(var n in t)e.registerDrawCallback(n,t[n])},e.getCallById=function(e){return t[e]?t[e]:(console.error("No Ui callback with id: ",e),function(){})},e}),define("gui/functions/CustomGraphCallbacks",[],function(){var e=function(){},t=function(e){var t=""+Math.floor(e[0]*255),n=""+Math.floor(e[1]*255),r=""+Math.floor(e[2]*255),i=""+e[3];return"rgba("+t+", "+n+", "+r+", "+i+")"};e.drawGraphArray=function(n,r,i,s,o){var u=i.pos.final,a=i.size;r.strokeStyle=t(i.callbackData.color),r.lineWidth=1;var f=0;for(var l in n)f+=1;var c={};if(o.wings)for(var l in o.wings){var h=o.wings[l].sourceData.liftCurveId;c[h]||(c[h]=[]),c[h].push(o.wings[l])}r.beginPath(),r.strokeStyle=t([.2,.5,.6,1]),e.startGraph(r,u.left+a.width*.5,u.top),e.addPointToGraph(r,u.left+a.width*.5,u.top+a.height),r.stroke();var p=0;for(var l in n){p+=1;var d=l,v=n[l],m=v[0][0],g=v[v.length-1][0],y=u.left+a.width/v.length*(v[0][0]-m),b=u.top+v[0][1]*25+a.height/5*p;r.beginPath(),r.strokeStyle=t([.2,.5,.6,.6]),e.startGraph(r,u.left,b),e.addPointToGraph(r,u.left+a.width,b),r.stroke();var w=t([.7+Math.sin(1*p)*.3,.7+Math.cos(2*p)*.3,.7+Math.sin(2*p)*.3,.4]);r.font="16px Russo One",r.textAlign="start",r.fillStyle=w,r.fillText(d,u.left+5,b-5),r.strokeStyle=w,r.beginPath(),r.lineWidth=1,e.startGraph(r,y,b);for(var E=0;E<v.length;E++){var S=u.left+a.width/(g-m)*(v[E][0]-m),x=u.top+v[E][1]*a.height/7+a.height/5*p;e.addPointToGraph(r,S,x)}r.stroke();if(c[d]){var T=c[d].length;for(var E=0;E<T;E++){var N=c[d][E];S=u.left+a.width*.5,S+=N.angleOfAttack*(a.width/(2*Math.PI));var C=10,k=-2*C-T-E*C*.7;r.font=C+"px Russo One",r.textAlign="center",r.fillStyle=t([.7+Math.sin(1*p)*.3,.7+Math.cos(2*p)*.3,.7+Math.sin(2*p)*.3,.4]),r.fillText(N.wingId,S,b+k+C*1),r.lineWidth=1,e.startGraph(r,S,b+k+C*1.2),e.addPointToGraph(r,S,b);var L=N.angleOfAttackYaw*a.height*.5;e.startGraph(r,S,b),e.addPointToGraph(r,S-40,b+L);var A=-(N.force.data[2]*1);e.startGraph(r,S,b),e.addPointToGraph(r,S+A,b+A);var O=-(N.force.data[1]*.1);e.startGraph(r,S,b),e.addPointToGraph(r,S-O,b+O),r.stroke()}}}},e.startGraph=function(e,t,n){e.moveTo(t,n)},e.addPointToGraph=function(e,t,n){e.lineTo(t,n)},e.renderGraph=function(n,r,i,s,o,u,a){var f=n.length;f==0&&(f=1);var l=i.width/f,c=function(){e.startGraph(u,r.left,r.top+i.height-i.height*o/n[0]);for(var t=0;t<f;t++)e.addPointToGraph(u,r.left+t*l,r.top+i.height-i.height*o/n[t])};u.strokeStyle=t(a.callbackData.color),u.lineWidth=a.callbackData.line_width,u.beginPath(),c(),u.stroke()},e.drawGraph=function(t,n,r,i){var s=r.pos.final,o=r.size,u=0;e.renderGraph(t,s,o,u,i,n,r)};var n={left:0,top:0,width:0,height:0};return e.drawControlState=function(e,r,i,s){var o=i.pos.final,u=i.size;n.left=o.left,n.top=o.top,n.width=u.width,n.height=-u.height,n[s.target]*=e*s.factor;if(!s.color)r.fillStyle="rgba(245, 220, 80, 0.6)";else if(s.color.length)if(s.color[0].length){var a=s.color,f=r.createLinearGradient(n.top-n.height,0,n.top-n.height,n.top);for(var l=0;l<a.length;l++){var c=l/(a.length-1);f.addColorStop(1-c,t(a[l]))}r.fillStyle=f}else r.fillStyle=t(s.color);r.fillRect(n.left,n.top,n.width,n.height)},e}),define("gui/functions/CustomRadarOverview",["gui/functions/CustomGraphCallbacks"],function(e){var t=function(e){var t=""+Math.floor(e[0]*255),n=""+Math.floor(e[1]*255),r=""+Math.floor(e[2]*255),i=""+e[3];return"rgba("+t+", "+n+", "+r+", "+i+")"},n=function(){},r={left:0,top:0,width:0,height:0},i=[],s=!1,o=o;return n.drawRadarContent=function(n,u,a,f){var l=a.pos.final,c=a.size;u.strokeStyle=t(a.callbackData.color),u.lineWidth=1;var h=0,p=f.spatial.pos.data[0],d=f.spatial.pos.data[2];s||(i.push(p,f.spatial.pos.data[1],d),s=!0);var v=setTimeout(function(){s=!1,o=!0},1500),m=p+25e3,g=p-25e3,y=d+25e3,b=d-25e3;for(var w in n)h+=1,n[w].spatial.pos.data[0]>g&&(g=n[w].spatial.pos.data[0]),n[w].spatial.pos.data[0]<m&&(m=n[w].spatial.pos.data[0]),n[w].spatial.pos.data[2]>g&&(g=n[w].spatial.pos.data[2]),n[w].spatial.pos.data[2]<m&&(m=n[w].spatial.pos.data[2]);y=m,b=g;var E=m-g,S=m-g,x=l.top+c.height*.5,T=l.left+c.width*.5;if(i.length>6){u.beginPath(),u.strokeStyle=t([.1,.4,.6,.5]);var N=(i[0]-p)*(c.height/(E*2))+l.top+c.height*.5,C=(i[2]-d)*(c.width/(S*2))+l.left+c.width*.5;e.startGraph(u,C,N);for(var k=0;k<i.length;k++)N=(i[k]-p)*(c.height/(E*2))+l.top+c.height*.5,k++,k++,C=(i[k]-d)*(c.width/(S*2))+l.left+c.width*.5,e.addPointToGraph(u,C,N-i[k-1]*.02),k%62==1&&(e.addPointToGraph(u,C,N),e.startGraph(u,C,N-i[k-1]*.02));i.length>6e3&&(i.shift(),i.shift(),i.shift()),u.stroke()}r.left=T-4,r.top=x-4,r.width=8,r.height=8;var L=0;for(w in n){L+=1;var A=n[w].spatial;N=(A.pos.data[0]-p)*(c.height/(E*2))+l.top+c.height*.5,C=(A.pos.data[2]-d)*(c.width/(S*2))+l.left+c.width*.5,n[w].geometries[0]?(r.left=C-2,r.top=N-2-A.pos[1]*.02,r.width=4,r.height=4,u.fillStyle=t([.6+Math.sin(L*.25)*.4,.6+Math.sin(L*.15)*.4,.6+Math.cos(L*.25)*.4,1])):(r.left=C-1,r.top=N-1-A.pos[1]*.02,r.width=2,r.height=2,u.fillStyle=t([.9,.6,.4,.8]),u.strokeStyle=t([.9,.4,.3,.2])),u.fillRect(r.left,r.top,r.width,r.height),u.beginPath(),e.startGraph(u,C,N),e.addPointToGraph(u,C,N-A.pos[1]*.02),u.stroke()}},n}),define("gui/functions/DrawFunctionShapes",["gui/functions/CustomGraphCallbacks","gui/functions/CustomRadarOverview"],function(e,t){var n=function(){},r=function(e){var t=""+Math.floor(e[0]*255),n=""+Math.floor(e[1]*255),r=""+Math.floor(e[2]*255),i=""+e[3];return"rgba("+t+", "+n+", "+r+", "+i+")"};n.drawGraphArray=function(t,n,r,i,s){e.drawGraphArray(t,n,r,i,s)},n.drawGraph=function(t,n,r,i){e.drawGraph(t,n,r,i)},n.drawRadarContent=function(e,n,r,i){t.drawRadarContent(e,n,r,i)};var i={left:0,top:0,width:0,height:0};return n.drawControlState=function(e,t,n,s){var o=n.pos.final,u=n.size;i.left=o.left,i.top=o.top,i.width=u.width,i.height=-u.height,i[s.target]*=e*s.factor;if(!s.color)t.fillStyle="rgba(245, 220, 80, 0.6)";else if(s.color.length)if(s.color[0].length){var a=s.color,f=t.createLinearGradient(i.top-i.height,0,i.top-i.height,i.top);for(var l=0;l<a.length;l++){var c=l/(a.length-1);f.addColorStop(1-c,r(a[l]))}t.fillStyle=f}else t.fillStyle=r(s.color);t.fillRect(i.left,i.top,i.width,i.height)},n}),define("gui/functions/DrawCallbacks",["gui/functions/UiCallbacks","gui/functions/DrawFunctionShapes","data_pipeline/data/ConfigCache"],function(e,t,n){var r=function(r,i){switch(r){case"random_test":return function(){return Math.random()};case"frame_tpf":return function(){return"ms:"+e.getCallById("frame_tpf")()};case"game_parameter":return function(){return e.getCallById("fetchGameParameter")(i)};case"more_stats":return function(){return e.getCallById("more_stats")()};case"tpf_graph":return function(n,r){t.drawGraph(e.getCallById("fetchTpfStack")(),n,r,r.callbackData.top_value)};case"aerodynamic_curves":return function(n,r){t.drawGraphArray(e.getCallById("fetchAerodynamicCurves")(),n,r,r.callbackData.top_value,e.getCallById("fetchPlayerPiece")())};case"radar_overview":return function(n,r){t.drawRadarContent(e.getCallById("fetchActiveGamePieces")(),n,r,e.getCallById("fetchPlayerPiece")())};case"player_control_update":return function(n,r){t.drawControlState(e.getCallById("fetchControlState")(r.callbackData.params.control),n,r,r.callbackData.params)};case"setting_control_update":return function(n,r){t.drawControlState(e.getCallById("fetchSettingState")(r.callbackData.params.control),n,r,r.callbackData.params)};case"applied_control_update":return function(n,r){t.drawControlState(e.getCallById("applied_control_update")(r.callbackData.params.control),n,r,r.callbackData.params)};case"registerMessageElement":return function(t,n,r){e.getCallById("registerMessageElement")(t,n,r)};case"fetchChannelData":return function(t){return function(){return e.getCallById("getChannelMessage")(t)}};case"fetchGuiText":return function(e){return n.getConfigKey("text_keys",e)};default:console.error("No gui drawCallback registered for: ",r)}};return{getGuiDrawCallback:r}}),define("gui/layout/ImageLayouter",["gui/functions/DrawCallbacks","data_pipeline/data/ConfigCache"],function(e,t){var n=function(){},r=function(e,t,n){return function(r){r.drawImage(e,t.left,t.top,n.width,n.height)}},i=function(e,n,i){var s=function(e,t){i.callback=i.callbacks,i.callbacks=[{callback:r(t.image,i.pos.final,i.size)}]};i.backgroundSvg&&t.subscribeToImageId(e,i.backgroundSvg,s),i.backgroundBin&&t.subscribeToImageId(e,i.backgroundBin,s)};return n.setupDrawImage=function(e,t,n){i(e,t,n)},n}),define("gui/layout/CanvasLayoutInterpreter",["gui/layout/LayoutEnums","gui/layout/CanvasBoxLayout","gui/layout/ImageLayouter","gui/functions/DrawCallbacks"],function(e,t,n,r){function i(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var n=0,r=e.length;n<r;n++)t[n]=i(e[n]);return t}if(e instanceof Object){t={};for(var s in e)e.hasOwnProperty(s)&&(t[s]=i(e[s]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}var s=function(e){this.canvasCalls=e};s.combineConstantsToData=function(e,t){for(var n in t)e[n]=t[n]},s.applyConstantValues=function(e,t){for(var n in e)for(var r in e[n])for(var i in t)e[n][r]==i&&(e[n][r]=t[i])};var o=function(e,t,n){for(var r in e){if(typeof e[r]=="string")for(var i in t)i==e[r]&&s.combineConstantsToData(e,t[i]);s.applyConstantValues(e,n)}};s.setupDrawShape=function(e,r,i,o){t.layoutCanvasBox(o,e,r,i),n.setupDrawImage(r.id,r.drawData,r.renderData),r.drawData.draw_callback&&s.setupDrawCallback(r.drawData.draw_callback,r.renderData),s.setupDrawText(r.drawData,r.renderData)};var u=function(e,t){return function(n){n.text.label=e(t)}};return s.buildTextLabel=function(e,t){e.callback?t.text.callback=u(r.getGuiDrawCallback(e.callback,e.params)):e.channel?t.text.callback=u(r.getGuiDrawCallback("fetchChannelData")(e.channel)):t.text.label=r.getGuiDrawCallback("fetchGuiText")(e.key)},s.applyTextLabel=function(e,t){s.buildTextLabel(e.text.source,t)},s.setupDrawText=function(e,t){e.text&&(t.text={x:t.text.x,y:t.text.y,color:t.text.color,font:t.text.font,align:t.text.align_text,height:t.text.line_height})},s.applyMessageCallback=function(e,t){t.messageChannels={},t.renderData.text.callbacks=[];for(var n in e.channels)t.messageChannels[e.channels[n]]="on_message",t.messageData=e,t.renderData.text.callbacks.push(u(r.getGuiDrawCallback("fetchChannelData")(e.channels[n]))),r.getGuiDrawCallback("registerMessageElement")(t,e.channels[n],t.messageChannels[e.channels[n]])},s.setupDrawCallback=function(e,t){e.source&&(t.callbacks.push({callback:r.getGuiDrawCallback(e.source)}),t.callbackData=e,t.callback=!0)},s}),define("gui/layout/ElementLayout",["gui/layout/LayoutEnums"],function(e){var t=0,n=function(e){e.pos={origin:{top:0,left:0},"final":{top:0,left:0}},e.size={width:400,height:200},e.data={xMin:0,xMax:100,yMin:0,yMax:100},e.callbacks=[]},r=function(e,r,i){t+=1,this.id=e+"_"+t,this.onStateChange=r,this.states={passive:"passive"},this.state=this.states.passive,this.drawData=i,this.shape=e,this.renderData={},n(this.renderData)};return r.prototype.valueYToUnitY=function(t,n,r){return n==e.units.pixels?this.renderData.pos.final.top+t*r.getPxFactor():this.renderData.pos.final.top+t*this.renderData.size.height*.01},r.prototype.valueXToUnitX=function(t,n,r){return n==e.units.pixels?this.renderData.pos.final.left+t*r.getPxFactor():this.renderData.pos.final.left+t*this.renderData.size.width*.01},r.prototype.valueToWidthPercent=function(e){return this.renderData.size.width*.01*e},r.prototype.valueToHeightPercent=function(e){return this.renderData.size.height*.01*e},r.prototype.registerElementState=function(e){this.states[e]=e},r.prototype.imageCallback=function(e){console.log("Call element image CB: ",e)},r.prototype.getShapeData=function(){return this.drawData},r.prototype.notifyStateChange=function(e){this.state=e,this.onStateChange(e)},r}),define("gui/functions/InteractiveSurface",["gui/functions/UiCallbacks"],function(e){var t=function(e,t,n){this.onStateChange=t,this.canvasGuiLayer=e,this.renderStates=e.renderStates,this.onApplyCallbacks={},this.onDragCallbacks=[],this.min=0,this.max=1,this.dragDist=0,this.currentState=0,this.currentDrag=[0,0],this.startDrag=[0,0],n.on_apply&&this.registerOnApplyCalls(n.on_apply),n.on_drag&&this.registerOnDragCalls(n.on_drag)};return t.prototype.triggerOnApply=function(){for(var e in this.onApplyCallbacks)this.onApplyCallbacks[e]()},t.prototype.registerApplyCallback=function(e,t){this.onApplyCallbacks[e]=t},t.prototype.setupApplyCallback=function(t,n){var r=e.getCallById(t),i=function(){r(n)};this.registerApplyCallback(t,i)},t.prototype.registerOnApplyCalls=function(e){this.onApplyCallbacks=[];if(e.length)for(var t=0;t<e.length;t++)this.setupApplyCallback(e[t].call,e[t].params);else this.setupApplyCallback(e.call,e.params)},t.prototype.triggerOnDragUpdate=function(e){for(var t=0;t<this.onDragCallbacks.length;t++){var n=this.onDragCallbacks[t].params;n.axis==0?this.dragDist=this.renderStates[this.canvasGuiLayer.state].renderData.size.width:this.dragDist=this.renderStates[this.canvasGuiLayer.state].renderData.size.height,this.currentDrag[n.axis]=this.onDragCallbacks[t].startDrag[n.axis]+e[n.axis]/this.dragDist,n.value=this.currentDrag[n.axis],this.currentState=n.value,this.onDragCallbacks[t].callback(n)}},t.prototype.registerDragCallback=function(e,t){t.value=0,this.onDragCallbacks.push({callback:e,params:t,startDrag:[0,0]})},t.prototype.setupDragCallback=function(t,n){var r=e.getCallById(t),i=function(e){r(e)};this.registerDragCallback(i,n)},t.prototype.registerOnDragCalls=function(e){this.onDragCallbacks=[];if(e.length)for(var t=0;t<e.length;t++)this.setupDragCallback(e[t].call,e[t].params);else this.setupDragCallback(e.call,e.params)},t.prototype.propagateStateChange=function(e){if(this.canvasGuiLayer.state==this.canvasGuiLayer.guiStateKeys.hidden)return;if(this.canvasGuiLayer.state=="on_enabled")return;this.canvasGuiLayer.state!=e&&this.canvasGuiLayer.setRenderState(e)},t.prototype.surfaceStateCheck=function(e){this.canvasGuiLayer.state!=e&&this.propagateStateChange(e)},t.prototype.setDragValue=function(e){this.triggerOnDragUpdate(e)},t.prototype.showControlState=function(){},t.prototype.beginValueManipulation=function(){for(var t=0;t<this.onDragCallbacks.length;t++)console.log("Trigger callback: ",this.onDragCallbacks[t]),this.onDragCallbacks[t].params.control?this.onDragCallbacks[t].startDrag[this.onDragCallbacks[t].params.axis]=e.getCallById("fetchControlState")(this.onDragCallbacks[t].params.control):this.onDragCallbacks[t].params.setting&&(this.onDragCallbacks[t].startDrag[this.onDragCallbacks[t].params.axis]=e.getCallById("fetchSettingState")(this.onDragCallbacks[t].params.setting))},t.prototype.onControlActive=function(e){if(this.canvasGuiLayer.state=="on_enabled")return;e.push(this),this.propagateStateChange("on_active")},t.prototype.onInputActivate=function(){this.onControlActive()},t.prototype.onInputRelease=function(){this.endValueManipulation()},t.prototype.endValueManipulation=function(){this.canvasGuiLayer.state=="on_active"&&this.triggerOnApply(),this.canvasGuiLayer.state!="passive"&&this.surfaceStateCheck("passive")},t.prototype.onControlHover=function(){this.surfaceStateCheck("on_hover")},t.prototype.updateSurface=function(e,t){if(this.canvasGuiLayer.state==this.canvasGuiLayer.guiStateKeys.hidden)return;this.data=this.renderStates[this.canvasGuiLayer.state].renderData.data,t.visualXY.x>this.data.xMin&&t.visualXY.x<this.data.xMax&&t.visualXY.y>this.data.yMin&&t.visualXY.y<this.data.yMax?t.interactionTargets.push(this):(this.canvasGuiLayer.state=="on_hover"||this.canvasGuiLayer.state=="on_active")&&this.surfaceStateCheck("passive")},t}),define("gui/elements/CanvasGuiLayer",["goo/entities/SystemBus","gui/layout/CanvasLayoutInterpreter","gui/layout/ElementLayout","gui/functions/InteractiveSurface","gui/layout/GuiConstants"],function(e,t,n,r,i){var s={hidden:"hidden",passive:"passive",on_hover:"on_hover",on_message:"on_message",on_active:"on_active",on_applied:"on_applied"},o=function(){this.renderData={},this.zIndex=0},u=function(t,i,u,a,f){this.pointerCursor=u,this.renderCall=new o,i?(this.parentLayout=i.renderStates.passive,this.zIndex=i.zIndex):(this.parentLayout=new n,this.zIndex=0),this.zIndex+=t.zIndex||0,t.id?(this.id=t.id,e.emit("registerGuiElementId",{id:this.id,layer:this})):this.id=t.shape,this.layerKeys=t,this.canvasCalls=a,this.guiStateKeys=s,this.state=this.guiStateKeys.passive,this.renderStates={};var l=function(e){this.setRenderState(e)}.bind(this);this.interactiveSurface=new r(this,l,this.layerKeys),f?this.setupElementLayout(f):this.renderStates[this.state]=new n(this.layerKeys.shape,null),this.setRenderState(this.guiStateKeys.passive)};return u.prototype.onInputActivate=function(){this.interactiveSurface.onInputActivate()},u.prototype.onInputRelease=function(){this.interactiveSurface.onInputRelease()},u.prototype.checkHoverHit=function(e,t,n){this.interactiveSurface.checkHoverHit(e,t,n)},u.prototype.endValueManipulation=function(){this.interactiveSurface.endValueManipulation()},u.prototype.updateInteractiveState=function(e,t){this.renderStates.on_hover&&this.interactiveSurface.updateSurface(e,t)},u.prototype.updateRenderData=function(){this.renderCall.renderData=this.renderStates[this.state].renderData,this.renderCall.zIndex=this.zIndex,this.canvasCalls.drawToCanvasGui(this.renderCall)},u.prototype.drawCanvasLayer=function(e,t){if(this.state==this.guiStateKeys.hidden)return;this.updateInteractiveState(e,t),this.updateRenderData(),this.notifyRenderedState(this.state)},u.prototype.setRenderState=function(e){e==this.guiStateKeys.hidden&&(this.state=e);if(!this.renderStates[e])return;this.state=e},u.prototype.notifyRenderedState=function(e){this.renderedDtate!=e&&this.pointerCursor&&this.pointerCursor.notifyInputStateTransition(e),this.renderedDtate=e},u.prototype.combineDataForState=function(e,t,n){var r=function(e,t,n){for(var i in t){i=="image_svg";if(typeof t[i]=="object"){var s=i;n[i]||(n[i]={}),r(s,t[i],n[i])}else n[i]=t[i]}};r(e,t,n)},u.prototype.addLayerState=function(e,r){this.renderStates[e]=new n(this.layerKeys.shape,this.interactiveSurface.onStateChange,r),this.renderStates[e].registerElementState(e),t.setupDrawShape(this.renderStates[e].drawData,this.renderStates[e],this.parentLayout,this.canvasCalls)},u.prototype.cookData=function(e){var t=i.clone(e);return this.attachConstantRules(t),i.applyConstantValues(t),t},u.prototype.addPassiveLayer=function(e){this.addLayerState(this.guiStateKeys.passive,this.cookData(e).passive)},u.prototype.addActiveLayer=function(e){var t=this.cookData(e).passive;this.combineDataForState(this.guiStateKeys.on_active,this.cookData(e).on_active,t),this.addLayerState(this.guiStateKeys.on_active,t)},u.prototype.addAppliedLayer=function(e){var t=this.cookData(e).passive;this.combineDataForState(this.guiStateKeys.on_applied,this.cookData(e).on_applied,t),this.addLayerState(this.guiStateKeys.on_applied,t)},u.prototype.addMessageLayer=function(e){var n=this.cookData(e).passive;this.combineDataForState(this.guiStateKeys.on_message,this.cookData(e).on_message,n),this.addLayerState(this.guiStateKeys.on_message,n),this.layerKeys.on_message&&t.applyMessageCallback(this.layerKeys.on_message,this.renderStates.on_message)},u.prototype.addHoverLayer=function(e){var t=this.cookData(e).passive;this.combineDataForState(this.guiStateKeys.on_hover,this.cookData(e).on_hover,t),this.addLayerState(this.guiStateKeys.on_hover,t),this.pointerCursor.registerInteractiveLayer(this)},u.prototype.addTextLabels=function(){for(var e in this.renderStates)this.layerKeys.text[e]?t.buildTextLabel(this.layerKeys.text[e],this.renderStates[e].renderData):t.buildTextLabel(this.layerKeys.text,this.renderStates[e].renderData)},u.prototype.attachConstantRules=function(e){i.applyLayoutRules(e)},u.prototype.setupElementLayout=function(e){this.addPassiveLayer(e),e.on_active&&this.addActiveLayer(e),e.on_applied&&this.addAppliedLayer(e),e.on_message&&this.addMessageLayer(e),e.on_hover&&this.addHoverLayer(e),this.layerKeys.text&&this.addTextLabels()},u}),define("gui/CanvasGuiWidget",["gui/elements/CanvasGuiLayer","gui/layout/GuiConstants","data_pipeline/PipelineAPI"],function(e,t,n){var r=function(e,t,n,r,i){this.pointerCursor=n,this.id=e,this.parent=t,this.canvasCalls=r,this.data=i,this.layers=[],this.onApplyCallbacks=[],this.templateHidden=!1,this.enablerFeedbackLayer=null,this.buildCanvasWidget(i)};return r.prototype.toggleTemplate=function(e){e&&(this.enablerFeedbackLayer=e),this.templateHidden=!this.templateHidden;if(!this.templateHidden&&e){this.enablerFeedbackLayer.setRenderState("on_applied");for(var t=0;t<this.layers.length;t++)this.layers[t].setRenderState("passive")}else{this.enablerFeedbackLayer&&this.enablerFeedbackLayer.setRenderState("passive"),this.enablerFeedbackLayer=null;for(var t=0;t<this.layers.length;t++)this.layers[t].setRenderState("hidden")}},r.prototype.addLayer=function(t,r,i){i||(i=n.readCachedConfigKey("shapes",t.shape));if(typeof i=="string"){var s=function(){this.addLayer(t,r,i)}.bind(this);setTimeout(function(){s()},200);return}var o=new e(t,r,this.pointerCursor,this.canvasCalls,i);t.feedback_gadgets&&this.processFeedbackGadgets(t,o),t.layers&&this.processLayers(t.layers,o),this.layers.push(o)},r.prototype.processFeedbackGadgets=function(e,r){var i=e.feedback_gadgets;for(var s=0;s<i.length;s++){var o=n.readCachedConfigKey("gadgets",i[s].gadget),u=i[s].params;for(var a=0;a<o.length;a++)for(var f in o[a]){var l=JSON.parse(JSON.stringify(n.readCachedConfigKey("shapes",o[a][f])));t.applyLayoutRules(l),t.applyConstantValues(l),l.passive.draw_callback.source=u[f],l.passive.draw_callback.params.control=u.control,l.passive.draw_callback.params.factor=u.factor;var c="gadget_"+r.id+u[f]+u.control,h={};h[c]=l,n.getCachedConfigs().shapes[c]=l,this.addLayer({shape:c},r,JSON.parse(JSON.stringify(l)))}}},r.prototype.processLayers=function(e,t){for(var n=0;n<e.length;n++)this.addLayer(e[n],t)},r.prototype.buildCanvasWidget=function(e){this.data=e,typeof e=="string"&&console.error("Widget has no data yet",this),this.layers=[];var t=function(){this.data.layers&&this.processLayers(this.data.layers,this.parent.layer),this.data.hidden&&(this.templateHidden=!0)}.bind(this);t()},r.prototype.updateGuiSystem=function(e,t){if(this.templateHidden)return;for(var n=0;n<this.layers.length;n++)this.layers[n].drawCanvasLayer(e,t)},r}),define("gui/CanvasGuiState",["goo/entities/SystemBus","gui/CanvasGuiWidget","data_pipeline/data/ConfigCache","data_pipeline/PipelineAPI","data_pipeline/GameDataPipeline"],function(e,t,n,r,i){var s=function(e,t){this.uiParent=e.uiParent,this.pointerCursor=t,this.pointerX=50,this.pointerY=50,this.canvasCalls=e,this.registerListeners(),this.initiatedTemplated={},this.builtTemplates={},this.activeTemplates={},this.idLayers={}};return s.prototype.attachGuiTemplate=function(e,n){var i=function(r,i){this.initiatedTemplated[e]&&(this.builtTemplates[e]=new t(e,this.uiParent,this.pointerCursor,this.canvasCalls,i),n(e))}.bind(this);r.subscribeToCategoryKey("template",e,i)},s.prototype.attachMainConfig=function(e){var t=function(e){this.activeTemplates[e]=this.builtTemplates[e]}.bind(this);for(var r=0;r<e.templates.length;r++)this.initiatedTemplated[e.templates[r]]={},this.attachGuiTemplate(e.templates[r],t);var i=function(){this.rebuildGuiLayers()}.bind(this),s,o=function(){clearTimeout(s),s=setTimeout(function(){i()},200)};n.setMasterResetFunction(o)},s.prototype.clearCurrentGui=function(){this.activeTemplates={},this.builtTemplates={},this.initiatedTemplated={}},s.prototype.loadMainState=function(e){this.clearCurrentGui(),this.attachMainStateId(e)},s.prototype.applyGuiSettings=function(e){e.blend_mode&&this.canvasCalls.canvasGui3d.setBlendModeId(e.blend_mode),e.attenuation&&this.canvasCalls.setAttenuateColor([0,0,0,e.attenuation])},s.prototype.attachMainStateId=function(e){var t=function(e,t){t.gui_settings&&this.applyGuiSettings(t.gui_settings),this.attachMainConfig(t)}.bind(this);r.subscribeToCategoryKey("main_gui_states",e,t);var n=function(){};r.subscribeToCategoryUpdate("layout_key_maps",n),r.subscribeToCategoryUpdate("layout_constants",n)},s.prototype.rebuildGuiLayers=function(){var e=function(e){this.activeTemplates[e]=this.builtTemplates[e]}.bind(this);for(var t in this.activeTemplates)this.attachGuiTemplate(t,e)},s.prototype.registerListeners=function(){var t=function(e){this.idLayers[e.id]=e.layer}.bind(this);e.addListener("registerGuiElementId",t);var n=function(e){e.value==1&&this.idLayers[e.enabler].state!="on_applied"?this.idLayers[e.enabler].setRenderState("on_applied"):this.idLayers[e.enabler].setRenderState("passive")}.bind(this);e.addListener("guiToggleEnabler",n);var r=function(e){if(e.enabler)var t=this.idLayers[e.enabler];this.activeTemplates[e.template].toggleTemplate(t)}.bind(this);e.addListener("guiToggleTemplate",r);var i=function(e){this.flashGui(e)}.bind(this);e.addListener("guiFlash",i);var s=function(e){this.updatePointerState(e.pointer)}.bind(this);e.addListener("pointerGuiState",s)},s.prototype.updatePointerState=function(e){var t=(new Date).getTime()*.01,n={line:{fromX:this.pointerX,fromY:this.pointerY,toX:e.x,toY:e.y,w:12,color:[.6+Math.sin(t)*.4,.5+Math.sin(t*.7)*.4,.6+Math.cos(t)*.3,.8]}};this.pointerX=e.x,this.pointerY=e.y,e.hidden||this.canvasCalls.drawToCanvasGui({renderData:n,zIndex:1e3})},s.prototype.flashGui=function(e){this.canvasCalls.drawToCanvasGui(e)},s.prototype.updateGuySystems=function(e,t){for(var n in this.activeTemplates)this.activeTemplates[n].updateGuiSystem(e,t.mouseState)},s.prototype.drawLayers=function(e){this.canvasCalls.updateCanvasCalls(e),i.tickDataLoader(e)},s}),define("gui/CanvasGui3D",["goo/renderer/Texture","goo/renderer/Material","goo/entities/components/MeshRendererComponent","goo/shapes/Quad","goo/renderer/shaders/ShaderLib","goo/renderer/pass/FullscreenUtil","data_pipeline/PipelineAPI"],function(e,t,n,r,i,s,o){var u=function(e,t){console.log(e),this.cameraEntity=e,this.camera=e.cameraComponent.camera,this.resolution=t,this.size=1,this.aspect=1,this.scalePercentToX=1,this.scalePxToX=1,this.scalePercentToY=1,this.materialSettings={blending:"CustomBlending",blendEquation:"AddEquation",blendSrc:"SrcColorFactor",blendDst:"SrcAlphaFactor"},this.setupParts(),this.constructCanvas(),this.onUpdateCallbacks=[];var n=function(e,t){this.handleConfigUpdate(e,t)}.bind(this);o.subscribeToCategoryKey("setup","page",n)};return u.prototype.setupParts=function(){this.uiQuad=this.createQuadEntity(this.cameraEntity),this.material=this.createCanvasMaterial(i.textured)},u.prototype.constructCanvas=function(){this.top=0,this.left=0,this.aspectMarginTop=0,this.aspectMarginLeft=0,this.ctx=this.setupCanvas(this.camera,this.resolution)},u.prototype.createCanvasMaterial=function(e){var n=new t("canvas_gui_mat",e);return n.cullState.enabled=!1,n.cullState.frontFace="CW",n.cullState.cullFace="Front",n.depthState.write=!1,n.renderQueue=4e3,n.blendState.blending=this.materialSettings.blending,n.blendState.blendEquation=this.materialSettings.blendEquation,n.blendState.blendSrc=this.materialSettings.blendSrc,n.blendState.blendDst=this.materialSettings.blendDst,n.shader.uniforms.color=[1,1,1],n},u.prototype.createQuadEntity=function(e){var t=s.quad,n=e._world.createEntity("canvas_gui_quad",t);return n.addToWorld(),n},u.prototype.attachQuad=function(e,t,r){return e.set(new n(r)),e.meshRendererComponent.cullMode="Never",e.meshRendererComponent.isReflectable=!1,t.transformComponent.attachChild(e.transformComponent,!1),e},u.prototype.setupMesh=function(){this.texture=new e(this.canvas,null,this.canvas.width,this.canvas.height),this.material.setTexture("DIFFUSE_MAP",this.texture),this.texture.setNeedsUpdate()},u.prototype.resolutionUpdated=function(){this.canvas.width=this.resolution,this.canvas.height=this.resolution,this.setupMesh(),this.top=0,this.updateFrustum()},u.prototype.setupCanvas=function(e,t){return this.canvas=document.createElement("canvas"),this.canvas.id="canvas_gui_id",this.canvas.width=t,this.canvas.height=t,this.canvas.dataReady=!0,this.ctx=this.canvas.getContext("2d"),this.setupMesh(),this.attachQuad(this.uiQuad,this.cameraEntity,this.material),this.ctx.globalCompositeOperation="source-over",this.ctx},u.prototype.updateFrustum=function(){if(this.top===this.camera._frustumTop&&this.left===Math.abs(this.camera._frustumLeft))return;this.top=this.camera._frustumTop,this.left=Math.abs(this.camera._frustumLeft),this.top<this.left?(this.aspectMarginTop=2*(this.left-this.top),this.aspectMarginLeft=0,this.size=this.left,this.uiQuad.transformComponent.transform.translation.set(0,-this.aspectMarginTop*.5*1.01,-this.camera.near*1.01),this.scalePxToX=this.top/this.size):(this.aspectMarginLeft=2*(this.top-this.left),this.aspectMarginTop=0,this.size=this.top,this.uiQuad.transformComponent.transform.translation.set(this.aspectMarginLeft*.5*1.01,0,-this.camera.near*1.01),this.scalePxToX=this.left/this.size),this.aspect=this.left/this.top,this.scalePercentToX=.01*this.canvas.width/(this.size/this.left),this.scalePercentToY=.01*this.canvas.height/(this.size/this.top),this.uiQuad.transformComponent.transform.rotation.fromAngles(0,0,0),this.uiQuad.transformComponent.transform.scale.set(this.size*1.01,this.size*1.01,-1),this.uiQuad.transformComponent.setUpdated(),this.onFrustumUpdate()},u.prototype.updateBlendMode=function(){var e=this.config.blending.modes[this.blendModeId];if(!this.material)this.materialSettings={blending:e.blending,blendEquation:e.blendEquation,blendSrc:e.blendSrc,blendDst:e.blendDst};else for(var t in e)this.material.blendState[t]=e[t]},u.prototype.setBlendModeId=function(e){this.blendModeId=e,this.updateBlendMode()},u.prototype.handleConfigUpdate=function(e,t){this.config=t,this.updateBlendMode(),t.resolution!=this.resolution&&(this.resolution=t.resolution,this.ctx&&this.resolutionUpdated())},u.prototype.updateCanvasGui=function(){this.updateFrustum()},u.prototype.applyChanges=function(){this.texture.setNeedsUpdate()},u.prototype.onFrustumUpdate=function(){for(var e=0;e<this.onUpdateCallbacks.length;e++)this.onUpdateCallbacks[e]()},u}),define("gui/elements/UiParent",["gui/elements/CanvasGuiLayer"],function(e){var t=function(t){this.layer=new e({shape:"canvas_parent"},null,null,t,null)};return t}),define("gui/CanvasCalls",["gui/CanvasGui3D","gui/layout/LayoutEnums","gui/layout/ElementLayout","gui/functions/UiCallbacks","gui/elements/UiParent"],function(e,t,n,r,i){var s=function(t,n,r){this.callsToCanvas=0,this.registerUiCallbacks(r),this.uiParent=new i(this),this.canvasGui3d=new e(t,n),this.aspect=this.canvasGui3d.aspect;var s=function(){this.updateParentLayout(),this.callResetCallbacks()}.bind(this),o=function(){this.updateParentLayout(),Math.round(this.aspect*1e3)!=Math.round(this.canvasGui3d.aspect*1e3)&&(this.callResetCallbacks(),this.aspect=this.canvasGui3d.aspect)}.bind(this);this.canvasGui3d.onUpdateCallbacks.push(o),this.canvas=this.canvasGui3d.canvas,this.ctx=this.canvasGui3d.ctx,this.resolution=n,this.lastFont="20px Verdana",this.attenuateColor="rgba(0, 0, 0, 0.2)",this.renderDepthLayers=[],this.drawInstructions=[],this.resetCallbacks=[],setTimeout(function(){s()},500)};s.prototype.updateParentLayout=function(){this.uiParent.layer.renderStates.passive.renderData.pos.final.left=0,this.uiParent.layer.renderStates.passive.renderData.pos.final.top=0,this.uiParent.layer.renderStates.passive.renderData.pos.origin.left=0,this.uiParent.layer.renderStates.passive.renderData.pos.origin.top=0,this.uiParent.layer.renderStates.passive.renderData.size.width=this.percentToX(100),this.uiParent.layer.renderStates.passive.renderData.size.height=this.percentToY(100)},s.prototype.toRgb=function(e){return"rgb("+Math.floor(e[0]*255)+","+Math.floor(e[1]*255)+","+Math.floor(e[2]*255)+")"},s.prototype.registerUiCallbacks=function(e){r.addDrawCallbacks(e)},s.prototype.toRgba=function(e){var t=""+Math.floor(e[0]*255),n=""+Math.floor(e[1]*255),r=""+Math.floor(e[2]*255),i=""+e[3];return"rgba("+t+", "+n+", "+r+", "+i+")"},s.prototype.pxToPercentX=function(e){return e/this.canvasGui3d.scalePercentToX},s.prototype.pxToPercentY=function(e){return e/this.canvasGui3d.scalePercentToY},s.prototype.percentToX=function(e){return e*this.canvasGui3d.scalePercentToX},s.prototype.percentToY=function(e){return e*this.canvasGui3d.scalePercentToY},s.prototype.pxToX=function(e){return this.getPxFactor()*e},s.prototype.getPxFactor=function(){return this.canvasGui3d.resolution/1024*this.canvasGui3d.scalePxToX};var o={CALLBACK:{id:"CALLBACK"},APPLY_RECT:{id:"APPLY_RECT"},APPLY_BOX:{id:"APPLY_BOX"},APPLY_TEXT:{id:"APPLY_TEXT"},APPLY_LINE:{id:"APPLY_LINE"},APPLY_ARC:{id:"APPLY_ARC"}};s.prototype.valueYToUnitY=function(e,n){return n==t.units.pixels?this.pxToX(e):this.percentToY(e)},s.prototype.valueXToUnitX=function(e,n){return n==t.units.pixels?this.pxToX(e):this.percentToX(e)},s.prototype.processTextLabel=function(e){e.text.color&&(this.ctx.fillStyle=e.text.color),e.text.font&&this.useFont!=e.text.font&&(this.useFont=e.text.font,this.ctx.font=this.useFont),this.ctx.textAlign=e.text.align;if(typeof e.text.label!="string")for(var t=0;t<e.text.label.length;t++)this.ctx.fillText(e.text.label[t],e.text.x,e.text.y+e.text.height*t);else this.ctx.fillText(e.text.label,e.text.x,e.text.y)},s.prototype.processTextCall=function(e){if(e.text.callbacks)for(var t=0;t<e.text.callbacks.length;t++)e.text.callbacks[t](e);e.text.callback&&e.text.callback(e),e.text.label&&this.processTextLabel(e)},s.prototype.processRectCall=function(e){if(typeof e.rect.color!="string")return;this.ctx.fillStyle=e.rect.color,this.ctx.fillRect(e.rect.x,e.rect.y,e.rect.w,e.rect.h)},s.prototype.processLineCall=function(e){e.color&&(this.ctx.strokeStyle=this.toRgba(e.color)),this.ctx.lineWidth=this.pxToX(e.w),this.ctx.beginPath(),this.ctx.moveTo(this.percentToX(e.fromX),this.percentToY(e.fromY)),this.ctx.lineTo(this.percentToX(e.toX),this.percentToY(e.toY)),this.ctx.stroke()},s.prototype.processArcCall=function(e){e.color&&(this.ctx.strokeStyle=this.toRgba(e.color)),this.ctx.lineWidth=this.pxToX(e.w),this.ctx.beginPath(),this.ctx.arc(this.percentToX(e.x),this.percentToY(e.y),this.pxToX(e.radius),e.start,e.end),this.ctx.stroke()},s.prototype.processDrawCallbackCall=function(e){if(e.callbacks)for(var t=0;t<e.callbacks.length;t++)e.callbacks[t].callback(this.ctx,e);else e.callback.callback(this.ctx,e)},s.prototype.processBoxCall=function(e){if(!e.box)return;if(typeof e.box.color!="string")return;this.ctx.strokeStyle=e.box.color,this.ctx.lineWidth=e.box.lineW,this.ctx.strokeRect(e.box.x,e.box.y,e.box.w,e.box.h)},s.prototype.callDraw=function(e,t){this.callsToCanvas+=1;switch(e.id){case o.APPLY_RECT.id:if(!t.rect)return;this.processRectCall(t);break;case o.APPLY_BOX.id:this.processBoxCall(t);break;case o.APPLY_TEXT.id:if(!t.text)return;this.processTextCall(t);break;case o.APPLY_LINE.id:this.processLineCall(t);break;case o.APPLY_ARC.id:this.processArcCall(t);break;case o.CALLBACK.id:this.processDrawCallbackCall(t)}},s.list=function(){return o},s.prototype.list=function(){return s.list()},s.prototype.attenuateGui=function(){this.ctx.fillStyle=this.attenuateColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)};var u=0;s.prototype.updateCanvasCalls=function(e){this.canvasGui3d.applyChanges(),this.canvasGui3d.updateCanvasGui(),r.getCallById("processCallbacks")(e),this.attenuateGui(),this.drawDepthLayers()},s.prototype.drawToCanvasGui=function(e){e.renderData||(console.error("No renderData",e),e.renderData=e),e.zIndex||(e.zIndex=0),this.drawInstructions[e.zIndex]||(this.drawInstructions[e.zIndex]=[],this.renderDepthLayers.push(e.zIndex)),this.drawInstructions[e.zIndex].push(e.renderData)},s.prototype.drawSortedLayers=function(){this.callsToCanvas=0;for(var e=0;e<this.renderDepthLayers.length;e++)this.applyDrawInstructions(this.drawInstructions[this.renderDepthLayers[e]]);this.drawInstructions={},this.renderDepthLayers=[]},s.prototype.drawDepthLayers=function(){this.renderDepthLayers.sort(),this.drawSortedLayers()},s.prototype.applyDrawInstructions=function(e){for(var t=0;t<e.length;t++)e[t].rect&&this.callDraw(this.list().APPLY_RECT,e[t]);for(t=0;t<e.length;t++)e[t].box&&this.callDraw(this.list().APPLY_BOX,e[t]);for(t=0;t<e.length;t++)e[t].line&&this.callDraw(this.list().APPLY_LINE,e[t].line);for(t=0;t<e.length;t++)e[t].callback&&this.callDraw(this.list().CALLBACK,e[t]);for(t=0;t<e.length;t++)e[t].text&&this.callDraw(this.list().APPLY_TEXT,e[t]);for(t=0;t<e.length;t++)e[t].arc&&this.callDraw(this.list().APPLY_ARC,e[t].arc)},s.prototype.setAttenuateColor=function(e){this.attenuateColor=this.toRgba(e)},s.prototype.registerResetCallback=function(e){this.resetCallbacks.push(e)};var a;return s.prototype.callResetCallbacks=function(){this.updateParentLayout(),this.setAttenuateColor([0,0,0,1]),this.attenuateGui(),this.renderDepthLayers=[],this.drawInstructions=[];var e=function(){this.updateParentLayout(),this.setAttenuateColor([0,0,0,.2]),this.resolution=this.canvasGui3d.resolution;for(var e=0;e<this.resetCallbacks.length;e++)this.resetCallbacks[e]();this.drawInstructions=[]}.bind(this);this.resolution=this.canvasGui3d.resolution,clearTimeout(a),a=setTimeout(function(){e()},0)},s}),define("gui/GuiBusSends",["goo/entities/SystemBus"],function(e){var t=function(e){this.data=e,this.range=this.data.max-this.data.min};return t.prototype.showControlWidget=function(t){e.emit("guiFlash",{box:{x:this.data.xMin,y:this.data.yMin,w:this.data.xMax-this.data.xMin,h:this.data.yMax-this.data.yMin,color:t,lineW:2}})},t.prototype.axisFrom=function(e){return this.data.axis?this.data.yMax-e*(this.data.yMax-this.data.yMin):this.data.xMax-e*(this.data.xMax-this.data.xMin)},t.prototype.showMenuButton=function(t){e.emit("guiFlash",{rect:{x:this.data.xMin,y:this.data.yMin,w:this.data.xMax-this.data.xMin,h:this.data.yMax-this.data.yMin,color:[t[0]*.3,t[1]*.6,t[2]*.7,t[3]]},box:{x:this.data.xMin,y:this.data.yMin,w:this.data.xMax-this.data.xMin,h:this.data.yMax-this.data.yMin,color:t,lineW:2}})},t.prototype.showControlAxisHorizontal=function(t,n){e.emit("guiFlash",{line:{fromX:this.data.xMin,fromY:this.axisFrom(t),toX:this.data.xMax,toY:this.axisFrom(t),w:4,color:n}})},t.prototype.showControlDiffHorizontal=function(t,n,r){e.emit("guiFlash",{rect:{x:this.data.xMin,y:this.axisFrom(n),w:this.data.xMax-this.data.xMin,h:this.data.yMax-this.axisFrom(n-r),color:t}})},t.prototype.showAppliedStateHorizontal=function(t,n){e.emit("guiFlash",{rect:{x:this.data.xMin,y:this.axisFrom(n/(this.data.max-this.data.min)-(this.data.max-(this.data.max-this.data.min))/(this.data.max-this.data.min)),w:this.data.xMax-this.data.xMin,h:-(this.data.yMin-this.data.yMax)*n/(this.data.max-this.data.min),color:t}})},t.prototype.showAppliedStateVertical=function(t,n){e.emit("guiFlash",{rect:{x:this.axisFrom(n/(this.data.max-this.data.min)-(this.data.max-(this.data.max-this.data.min))/(this.data.max-this.data.min)),y:this.data.yMin,w:-(this.data.xMin-this.data.xMax)*n/(this.data.max-this.data.min),h:this.data.yMax-this.data.yMin,color:t}})},t.prototype.showControlAxisVertical=function(t,n){e.emit("guiFlash",{line:{fromX:this.axisFrom(t),fromY:this.data.yMin,toX:this.axisFrom(t),toY:this.data.yMax,w:4,color:n}})},t.prototype.showControlDiffVertical=function(t,n,r){e.emit("guiFlash",{rect:{x:this.axisFrom(n),y:this.data.yMin,w:this.data.xMax-this.axisFrom(n-r),h:this.data.yMax-this.data.yMin,color:t}})},t.prototype.showControlButtonState=function(t){e.emit("guiFlash",{box:{x:this.data.xMin,y:this.data.yMin,w:this.data.xMax-this.data.xMin,h:this.data.yMax-this.data.yMin,color:t}})},t}),define("gui/io/GameScreen",[],function(){var e,t,n,r=function(r){e=r,e.style.pointerEvents="auto",t=e.offsetWidth,n=e.offsetHeight,window.addEventListener("resize",function(){i()})},i=function(){t=e.offsetWidth,n=e.offsetHeight},s=function(){return e},o=function(){return t},u=function(){return n};return{registerAppContainer:r,getElement:s,getWidth:o,getHeight:u}}),define("gui/io/MouseActionListener",[],function(){var e=[0,0],t={RIGHT:"RIGHT",LEFT:"LEFT",MIDDLE:"MIDDLE"},n={mousedown:"mousedown",mouseup:"mouseup",mouseout:"mouseout",click:"click"},r=function(){this.pressedButtons=[0,0]};return r.prototype.handleElementMouseEvent=function(r,i){switch(i){case t.RIGHT:switch(r){case n.mousedown:this.pressedButtons[1]=1,e=this.pressedButtons;break;case n.mouseup:this.pressedButtons[1]=0,e=this.pressedButtons;break;case n.mouseout:break;case n.click:}break;case t.LEFT:switch(r){case n.mousedown:this.pressedButtons[0]=1,e=this.pressedButtons;break;case n.mouseup:this.pressedButtons[0]=0,e=this.pressedButtons;break;case n.click:}break;case t.MIDDLE:switch(r){case n.mousedown:e=[1,1];break;case n.mouseup:e=[0,0];break;case n.click:}}},r.prototype.handleMouseEvt=function(e){var n=t.LEFT;e.which?(e.which==3&&(n=t.RIGHT),e.which==2&&(n=t.MIDDLE)):e.button&&(e.button==2&&(n=t.RIGHT),e.button==4&&(n=t.MIDDLE)),this.handleElementMouseEvent(e.type,n)},r.prototype.setupElementClickListener=function(e){var t=function(e){e.stopPropagation();var t=e==null?event:e;this.handleMouseEvt(t)}.bind(this);e.addEventListener(n.mouseup,t),e.addEventListener(n.click,t),e.addEventListener(n.mousedown,t),e.addEventListener(n.mouseout,t)},r.prototype.sampleMouseAction=function(t){t.action[0]=e[0],t.action[1]=e[1]},r}),define("gui/io/TouchActionListener",[],function(){var e=[0],t={touchstart:"touchstart",touchend:"touchend",touchmove:"touchmove"},n="ontouchstart"in document.documentElement,r=function(){this.enabled=n};return r.prototype.setupElementTouchListener=function(n){var r=function(){e[0]=1},i=function(){e[0]=1};n.addEventListener(t.touchstart,r),n.addEventListener(t.touchend,i)},r.prototype.sampleTouchAction=function(t){t.action[0]+=e[0],e[0]=0},r}),define("gui/io/ElementListeners",["gui/io/GameScreen","gui/io/MouseActionListener","gui/io/TouchActionListener"],function(e,t,n){var r,i,s,o,u,a=function(){this.mouseActionListener=new t,this.touchActionListener=new n,this.setupMouseListener(),this.setupTouchListener()};return a.prototype.setupMouseListener=function(){this.mouseActionListener.setupElementClickListener(e.getElement()),e.getElement().addEventListener("mousemove",function(t){t.stopPropagation(),r=t.clientX,i=t.clientY,s=2*(r-e.getWidth()/2)/e.getWidth(),o=2*(i-e.getHeight()/2)/e.getHeight()}),e.getElement().addEventListener("mouseout",function(e){e.stopPropagation(),s=0,o=0});var t;e.getElement().addEventListener("mousewheel",function(e){e.stopPropagation();if(t)return;u=e.wheelDelta/1200,setTimeout(function(){t=!1},100),t=!0})},a.prototype.setupTouchListener=function(){this.touchActionListener.setupElementTouchListener(e.getElement()),e.getElement().addEventListener("touchstart",function(e){e.preventDefault(),r=e.touches[0].clientX,i=e.touches[0].clientY,s=0,o=0}),e.getElement().addEventListener("touchmove",function(t){t.preventDefault(),r=t.touches[0].clientX,i=t.touches[0].clientY,s=2*(r-e.getWidth()/2)/e.getWidth(),o=2*(i-e.getHeight()/2)/e.getHeight()}),e.getElement().addEventListener("touchend",function(e){e.preventDefault(),s=0,o=0})},a.prototype.sampleMouseState=function(e){this.mouseActionListener.sampleMouseAction(e),this.touchActionListener.sampleTouchAction(e),e.x=r,e.y=i,e.dx=s,e.dy=o,e.wheelDelta=u,u=0,s=0,o=0},a}),define("gui/io/InputState",["gui/io/ElementListeners"],function(e){var t=function(){this.mouseState={x:0,y:0,dx:0,dy:0,wheelDelta:0,drag:!1,startDrag:[0,0],dragDistance:[0,0],action:[0,0],lastAction:[0,0],visualXY:{x:0,y:0},interactionTargets:[],pressingButton:!1},this.elementListeners=new e(this.mouseState),this.buttonDownTargets=[],this.dragTargets=[]};return t.prototype.processDragState=function(e){this.dragTargets.length&&(e.inputVector(this.mouseState.startDrag[0],this.mouseState.startDrag[1],this.mouseState.x,this.mouseState.y),this.buttonDownTargets.length=0);if(this.buttonDownTargets.length&&(this.mouseState.dx||this.mouseState.dy)&&!this.mouseState.drag){this.mouseState.startDrag[0]=this.mouseState.x,this.mouseState.startDrag[1]=this.mouseState.y,this.mouseState.drag=!0;for(var t=0;t<this.buttonDownTargets.length;t++)this.buttonDownTargets[t].onDragCallbacks.length&&(this.dragTargets.push(this.buttonDownTargets[t]),this.buttonDownTargets[t].beginValueManipulation())}this.mouseState.dragDistance[0]=this.mouseState.startDrag[0]-this.mouseState.x,this.mouseState.dragDistance[1]=this.mouseState.startDrag[1]-this.mouseState.y;for(t=0;t<this.dragTargets.length;t++)this.dragTargets[t].setDragValue(this.mouseState.dragDistance),this.dragTargets[t].onControlHover()},t.prototype.updateInputState=function(e,t){this.mouseState.lastAction[0]=this.mouseState.action[0],this.mouseState.lastAction[1]=this.mouseState.action[1],this.processDragState(t),this.elementListeners.sampleMouseState(this.mouseState),this.mouseState.visualXY=t.moveTo(this.mouseState.x,this.mouseState.y),this.processHoverTargets();if(this.mouseState.lastAction[0]!=this.mouseState.action[0]||this.mouseState.lastAction[1]!=this.mouseState.action[1])this.dragEnded(),t.inputMouseAction(this.mouseState.action),this.mouseState.action[0]+this.mouseState.action[1]?this.mouseButtonEmployed():this.mouseState.pressingButton==1&&this.handleReleaseTargets();this.mouseState.action[0]+this.mouseState.action[1]&&this.showActivatedHovered(),this.buttonDownTargets.length||(this.mouseState.pressingButton=!1)},t.prototype.dragEnded=function(){this.mouseState.drag=!1,this.dragTargets.length=0},t.prototype.handleReleaseTargets=function(){for(var e=0;e<this.buttonDownTargets.length;e++)this.buttonDownTargets[e].triggerOnApply()},t.prototype.mouseButtonEmployed=function(){this.mouseState.action[0]?this.handleLeftButtonPress():this.dragEnded()},t.prototype.showActivatedHovered=function(){this.buttonDownTargets.length=0;if(this.mouseState.pressingButton==1)for(var e=0;e<this.mouseState.interactionTargets.length;e++)this.mouseState.interactionTargets[e].onControlActive(this.buttonDownTargets)},t.prototype.handleLeftButtonPress=function(){this.mouseState.pressingButton=!0,this.mouseState.lastAction[0]=this.mouseState.action[0],this.showActivatedHovered()},t.prototype.initFrameSample=function(){this.mouseState.interactionTargets.length=0},t.prototype.processHoverTargets=function(){if(this.mouseState.interactionTargets.length>0)for(var e=0;e<this.mouseState.interactionTargets.length;e++)this.mouseState.interactionTargets[e].onControlHover()},t}),define("gui/io/VisualCursor",["gui/io/GameScreen","goo/entities/SystemBus"],function(e,t){var n=function(){this.x=0,this.y=0,this.vectorColor=[.3,.9,.8,1],this.renderPointer={pointer:{x:0,y:0,hidden:!1}}};return n.prototype.pxXtoPercentX=function(t){return 100*t/e.getWidth()},n.prototype.pxYtoPercentY=function(t){return 100*t/e.getHeight()},n.prototype.moveTo=function(e,n,r){return this.renderPointer.pointer.x=this.pxXtoPercentX(e),this.renderPointer.pointer.y=this.pxYtoPercentY(n),this.renderPointer.pointer.hidden=r,t.emit("pointerGuiState",this.renderPointer),this.renderPointer.pointer},n.prototype.transformConnector=function(n,r,i,s,o){var u=e.getWidth(),a=e.getHeight();t.emit("guiFlash",{renderData:{line:{fromX:n*100/u,fromY:r*100/a,toX:i*100/u,toY:s*100/a,w:2+(o+.4),color:this.vectorColor},zIndex:1e4}})},n.prototype.showDragToPoint=function(n,r,i,s){var o=e.getWidth(),u=e.getHeight();t.emit("guiFlash",{renderData:{arc:{x:this.renderPointer.pointer.x,y:this.renderPointer.pointer.y,radius:8+12*i,start:-Math.PI*.5+s+Math.PI*i,end:-Math.PI*.5+s-Math.PI*i,w:2+(i+.4),color:this.vectorColor},zIndex:1e4}})},n.prototype.showStartDragPoint=function(n,r,i,s){var o=e.getWidth(),u=e.getHeight();t.emit("guiFlash",{renderData:{arc:{x:100*n/o,y:100*r/u,radius:4/(i+.1),start:-Math.PI*.5+s+Math.PI*i,end:-Math.PI*.5+s-Math.PI*i,w:2+(i+.4),color:this.vectorColor},line:{x:100*n/o,y:100*r/u,toX:100*n/o+20*i,toY:100*r/u,w:2+(i+.4),color:this.vectorColor},zIndex:1e4}}),t.emit("guiFlash",{renderData:{line:{x:100*n/o,y:100*r/u,toX:100*n/o,toY:100*r/u+20*i,w:2+(i+.4),color:this.vectorColor},zIndex:1e4}})},n.prototype.showPressPoint=function(e){t.emit("guiFlash",{renderData:{arc:{x:this.renderPointer.pointer.x,y:this.renderPointer.pointer.y,radius:5+4*e,start:2*Math.PI,end:0,w:5+2*e,color:this.vectorColor},zIndex:1e4}})},n.prototype.visualizeMouseAction=function(e){this.vectorColor[0]=.5+e[0]*.5,this.vectorColor[1]=.5+e[1]*.5,this.showPressPoint(e[0]+e[1])},n.prototype.lineDistance=function(e,t,n,r){return Math.sqrt((e-n)*(e-n)+(t-r)*(t-r))},n.prototype.visualizeVector=function(e,t,n,r){var i=.008*this.pxXtoPercentX(this.lineDistance(e,t,n,r));this.vectorColor[0]=.5+i*.5,this.vectorColor[1]=1-i*.5,this.vectorColor[2]=1-i*.5,this.showStartDragPoint(e,t,i,Math.atan2(n-e,t-r)),this.transformConnector(e,t,n,r,i),this.showDragToPoint(n,r,i,Math.atan2(e-n,r-t))},n}),define("gui/io/PointerCursor",["gui/io/VisualCursor"],function(e){var t=function(t){this.guiStateTransitionCallbacks={passive:[],on_hover:[],on_active:[],on_applied:[],on_message:[]},this.pointerStateTransitionCallbacks={press_0:[],press_1:[],press_2:[],release_0:[],release_1:[],release_2:[]},this.inputState=t,this.visualCursor=new e,this.interactiveLayers={},this.x=0,this.y=0};return t.prototype.moveTo=function(e,t,n){return this.x=e,this.y=t,this.visualCursor.moveTo(e,t,n)},t.prototype.inputVector=function(e,t,n,r){this.visualCursor.visualizeVector(e,t,n,r)},t.prototype.inputMouseAction=function(e){this.visualCursor.visualizeMouseAction(e)},t.prototype.registerInteractiveLayer=function(e){this.interactiveLayers[e.id]=e},t.prototype.getPointerState=function(){return this.inputState.mouseState},t.prototype.addGuiStateTransitionCallback=function(e,t){this.guiStateTransitionCallbacks[e]||(this.guiStateTransitionCallbacks[e]=[]),this.guiStateTransitionCallbacks[e].indexOf(t)!=-1?console.error("Function for Gui transition state callback already registered"):this.guiStateTransitionCallbacks[e].push(t)},t.prototype.notifyInputStateTransition=function(e){if(this.guiStateTransitionCallbacks[e])for(var t=0;t<this.guiStateTransitionCallbacks[e].length;t++)this.guiStateTransitionCallbacks[e][t]()},t}),define("gui/CanvasGuiMain",["gui/GuiConfigLoader","gui/CanvasGuiState","gui/CanvasCalls","gui/GuiBusSends","gui/io/InputState","gui/io/PointerCursor","gui/io/GameScreen"],function(e,t,n,r,i,s,o){var u=function(){o.registerAppContainer(document.body),this.inputState=new i,this.pointerCursor=new s(this.inputState),this.guiConfigLoader=new e};return u.prototype.loadMasterConfig=function(e,t,n){this.guiConfigLoader.initConfigs(e,t,n)},u.prototype.initGuiMain=function(e,r,i){this.canvasCalls=new n(e,i,r),this.canvasGuiState=new t(this.canvasCalls,this.pointerCursor);var s=function(){this.canvasGuiState.rebuildGuiLayers()}.bind(this);this.canvasCalls.registerResetCallback(s)},u.prototype.setMainUiState=function(e){this.canvasGuiState.loadMainState(e)},u.prototype.addUiSubstateId=function(e){this.canvasGuiState.attachMainStateId(e)},u.prototype.tickGuiMain=function(e){this.inputState.initFrameSample(),this.canvasGuiState.updateGuySystems(e,this.inputState),this.inputState.updateInputState(e,this.pointerCursor),this.canvasGuiState.drawLayers(e)},u.prototype.addGuiStateTransitionCallback=function(e,t){this.pointerCursor.addGuiStateTransitionCallback(e,t)},u}),define("gui/CanvasGuiAPI",["gui/CanvasGuiMain"],function(e){var t=1024,n=function(n){this.canvasGuiMain=new e,this.uiTxResolution=n||t,this.pointerCursor=this.canvasGuiMain.pointerCursor};return n.prototype.initCanvasGui=function(e,t,n,r,i){var s=function(e,i){this.canvasGuiMain.initGuiMain(t,n,this.uiTxResolution,this.pointerCursor),r(e,i)}.bind(this);this.canvasGuiMain.loadMasterConfig(e,s,i)},n.prototype.setUiToStateId=function(e){this.canvasGuiMain.setMainUiState(e)},n.prototype.attachUiSubstateId=function(e){this.canvasGuiMain.addUiSubstateId(e)},n.prototype.updateCanvasGui=function(e){this.canvasGuiMain.tickGuiMain(e)},n.prototype.getPointerCursor=function(){return this.pointerCursor},n.prototype.addGuiStateTransitionCallback=function(e,t){this.canvasGuiMain.addGuiStateTransitionCallback(e,t)},n.prototype.getPointerState=function(){return this.getPointerCursor().getPointerState()},n}),define("io/InputSettersGetters",["application/EventManager","io/PlayerMovementInput","io/MouseListener","io/GameScreen","io/AnalogInput","io/KeyboardHandler","gui/CanvasGuiAPI"],function(e,t,n,r,i,s,o){var u=0,a=0,f=0,l=0,c=0,h=0,p=0,d=!1,v={},m=0,g=0,y=!1,b={},w={},E="game",S,x=function(e){if(typeof e=="number")n||(n=e);else var t=""+e+"",n=t.charCodeAt(0);return n},T=function(e,t){var n=x(t);w[n]=e},N=function(e){var t=x(e);delete w[t]},C=function(){document.body.onkeydown=function(t){t.preventDefault();var n=t.keyCode;E=="game"&&(b[n],w[n]&&!v[n]&&(v[n]=1,e.fireEvent(e.list().UPDATE_KEYBINDING,{control:w[t.keyCode],value:1})))},document.body.onkeyup=function(t){var n=t.keyCode;E=="game"&&w[n]&&(v[n]=0,e.fireEvent(e.list().UPDATE_KEYBINDING,{control:w[t.keyCode],value:0}))}},k=function(e,t){var n=t.charCodeAt(0);b[n]=e},L=function(t){S=!0,u=t,e.fireEvent(e.list().MOUSE_WHEEL_UPDATE,{delta:t})},A=function(){return[o.getPointerState().x,o.getPointerState().y]},O=function(){return y},M=function(t,n){h=t,p=n,e.fireEvent(e.list().MOUSE_POSITION_UPDATE,{xy:[t,n]})},_=function(){l=0,c=0},D,P=function(e,t){l=e,c=t,a+=e,f+=t,clearTimeout(D),D=setTimeout(function(){_()},100)},H=function(){return[a,f]},B=function(e){m=e[0],g=e[1],y=!0},j=function(e){r.setupMouseListener(e),r.getElement().addEventListener("mousemove",function(e){e.stopPropagation();var t=e.clientX,n=e.clientY,i=2*(t-r.getWidth()/2)/r.getWidth(),s=2*(n-r.getHeight()/2)/r.getHeight();M(t,n),P(i,s)}),r.getElement().addEventListener("mouseout",function(e){e.stopPropagation(),P(0,0)});var t;r.getElement().addEventListener("mousewheel",function(e){e.stopPropagation();if(t)return;var n=e.wheelDelta/1200;n!=0&&L(n),setTimeout(function(){t=!1},100),t=!0})},F=function(t){e.fireEvent(e.list().MOUSE_ACTION,{action:t,xy:[h,p]})},I=function(t){j(e.eventArgs(t).goo.renderer.domElement),n.setElementClickFunction(document.body,F)},q=function(t){B(e.eventArgs(t).xy)},R=function(){y=!1},U=function(e){R()},z=function(){return[m-h,g-p]},W=function(){return[l,c]};C();var X=function(t){e.eventArgs(t).callback(W())},V=function(){return w},$,J=function(e){$=e},K=[0,0],Q=function(){var t=$.getPointerState();P(t.dx,t.dy),M(t.x,t.y),t.wheelDelta&&e.fireEvent(e.list().MOUSE_WHEEL_UPDATE,{delta:t.wheelDelta}),t.drag&&B(t.startDrag[0],t.startDrag[1]),(K[0]!=t.action[0]||K[1]!=t.action[1])&&e.fireEvent(e.list().MOUSE_ACTION,{action:t.action,xy:[t.x,t.y]}),K[0]=t.action[0],K[1]=t.action[1]};return e.registerListener(e.list().RENDER_TICK,Q),e.registerListener(e.list().START_POINTER_DRAG,q),e.registerListener(e.list().START_CAMERA_DRAG,q),e.registerListener(e.list().STOP_CAMERA_DRAG,U),e.registerListener(e.list().FETCH_DRAG_DELTA,X),{setGuiApi:J,registeKeyBinding:T,unregisteKeyBinding:N,getDragDeltaXY:z,getBoundKeys:V}}),define("application/PerfMon",["goo/entities/SystemBus","application/EventManager","io/GameScreen"],function(e,t,n){var r=[0],i,s,o=function(e,t){this.gooController=e,i=this.gooController.goo,this.tfpGraphSize=200,this.gameController=t,s=t};return o.prototype.updateMonitorFrame=function(e){r.push(e*1e3),r.length==this.tfpGraphSize&&r.shift()},o.getTpfStack=function(){return r},o.getStatsCollection=function(){var e=function(e){var t=0;for(var n=0;n<e.length;n++)t+=e[n].passes.length;return t},t=function(e){for(var t=0;t<i.world._systems.length;t++)if(i.world._systems[t].type==e)return i.world._systems[t]},n=function(){return s.canvasGuiAPI.canvasGuiMain.canvasCalls},o={tpf:r[r.length-1],cachedShaders:"NYI",drawCalls:i.renderer.info.calls,verts:i.renderer.info.vertices,indices:i.renderer.info.indices,entities:i.world.entityManager._entityCount,allentities:t("TransformSystem")._activeEntities.length,lights:i.renderSystem.lights.length,composers:i.renderSystem.composers.length,passes:e(i.renderSystem.composers),transforms:t("TransformSystem").numUpdates,animations:t("AnimationSystem")._activeEntities.length,guiCalls:n().callsToCanvas};return o},o}),define("application/Sequencer",["application/EventManager"],function(e){var t,n=[],r=function(){};r.prototype.flushQueue=function(){for(var e=0;e<n.length;e++){var t=n[e];console.log("Flush Queue Entry: ",t)}n=[]};var i=function(e,t){n.push({wait:t,callback:e})},s=function(e){for(var t=0;t<n.length;t++){var r=n[t];r.wait-=e,r.wait<=0&&(r.callback(),n.splice(t,1))}},o=function(t){var n=e.eventArgs(t),r=n.callback,s=n.wait;i(r,s)};return e.registerListener(e.list().SEQUENCE_CALLBACK,o),r.prototype.tick=function(e){t+=e,s(e)},r}),define("goo/entities/components/ScriptComponent",["goo/entities/components/Component","goo/entities/SystemBus","goo/scripts/Scripts","goo/util/ObjectUtil"],function(e,t,n,r){function i(t){e.apply(this,arguments),this.type="ScriptComponent",this._gooClasses=n.getClasses(),t instanceof Array?this.scripts=t:t?this.scripts=[t]:this.scripts=[],Object.seal(this)}return i.type="ScriptComponent",i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.setup=function(e){var t=e._world.getSystem("ScriptSystem").context,n=Object.create(t);r.extend(n,{entity:e,entityData:{}});for(var i=0;i<this.scripts.length;i++){var s=this.scripts[i];if(!s.context){s.context=Object.create(n),s.parameters&&s.parameters.enabled!==undefined?s.enabled=s.parameters.enabled:s.enabled=!0;if(s.setup&&s.enabled)try{s.setup(s.parameters,s.context,this._gooClasses)}catch(o){this._handleError(s,o,"setup")}}}},i.prototype.run=function(e){for(var t=0;t<this.scripts.length;t++){var n=this.scripts[t];if(n&&n.run&&(n.enabled===undefined||n.enabled))try{n.run(e,e._world.tpf,n.context,n.parameters)}catch(r){this._handleError(n,r,"run")}else if(n.update&&(n.enabled===undefined||n.enabled))try{n.update(n.parameters,n.context,this._gooClasses)}catch(r){this._handleError(n,r,"update")}}},i.prototype.cleanup=function(){for(var e=0;e<this.scripts.length;e++){var t=this.scripts[e];if(t.context){if(t.cleanup)try{t.cleanup(t.parameters,t.context,this._gooClasses)}catch(n){this._handleError(t,n,"cleanup")}t.enabled=!1,t.context=null}}},i.prototype._handleError=function(e,n,r){e.enabled=!1;var i={id:e.id,errors:[{message:n.message||n,phase:r}]};if(n instanceof Error){var s=n.stack.split("\n")[1].match(/(\d+):\d+\)$/);s&&(i.line=parseInt(s[1],10)-1)}console.error(i.errors[0].message,i),t.emit("goo.scriptError",i)},i.applyOnEntity=function(e,t){if(e instanceof Function||e&&e.run instanceof Function||e&&e.update instanceof Function){var n;return t.scriptComponent?n=t.scriptComponent:(n=new i,t.setComponent(n)),n.scripts.push(e.run instanceof Function||e.update instanceof Function?e:{run:e}),!0}},i}),define("physics/PhysicalWorld",["application/EventManager","goo/entities/components/ScriptComponent","goo/entities/EntityUtils","goo/math/Quaternion","goo/math/Matrix3x3","goo/math/Vector3"],function(e,t,n,r,i,s){function E(e,t){var n=e.dataViews.POSITION,r=e.indexData.data,i=e.indexCount/3,s=e.vertexCount,o=new Ammo.btTriangleIndexVertexArray,u=g,a=new Ammo.btIndexedMesh,f=4,l=Ammo.allocate(f*n.length,"float",Ammo.ALLOC_NORMAL),c=1;for(var h=0,p=n.length;h<p;h++)Ammo.setValue(l+h*f,c*n[h],"float");var d=!0,v=d?4:2,m=d?"i32":"i16",y=Ammo.allocate(v*r.length,m,Ammo.ALLOC_NORMAL);for(var h=0,p=r.length;h<p;h++)Ammo.setValue(y+h*v,r[h],m);var b=v*3,w=f*3;a.set_m_numTriangles(i),a.set_m_triangleIndexBase(y),a.set_m_triangleIndexStride(b),a.set_m_numVertices(s),a.set_m_vertexBase(l),a.set_m_vertexStride(w),o.addIndexedMesh(a,u);var E=!0,S=!0,x=new Ammo.btBvhTriangleMeshShape(o,E,S);return x}function S(e,t,n,r){console.log("Phys Mesh: ",e);var i=E(e),s=new Ammo.btTransform;s.setIdentity(),s.setOrigin(new Ammo.btVector3(t,n,r));var o=0,a=new Ammo.btVector3(0,0,0),f=new Ammo.btDefaultMotionState(s),l=new Ammo.btRigidBodyConstructionInfo(o,f,i,a),c=new Ammo.btRigidBody(l);c.setFriction(5),u.addRigidBody(c)}function x(e,t){}function T(){u.stepSimulation(1/60,3)}function N(){console.log("Init Physics"),a=new Ammo.btTransform,f=new r;var e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),n=new Ammo.btDbvtBroadphase,i=new Ammo.btSequentialImpulseConstraintSolver;u=new Ammo.btDiscreteDynamicsWorld(t,n,i,e),u.setGravity(new Ammo.btVector3(0,-9.81,0))}function C(){var e=new t({run:function(e){var t=e.getComponent("transformComponent");e.ammoComponent.getMotionState().getWorldTransform(a);var n=a.getOrigin();t.setTranslation(n.x(),n.y(),n.z());var r=a.getRotation();f.setd(r.x(),r.y(),r.z(),r.w()),t.transform.rotation.copyQuaternion(f),t.setUpdated()}});return e}function k(e,n){n.physTransform=new Ammo.btTransform,n.physQuat=new Ammo.btQuaternion;var r=new t({run:function(e){e.ammoShapeComponent.getWorldTransform(e.physTransform),e.physTransform.getOrigin().setX(e.gameSpatial.pos.data[0]),e.physTransform.getOrigin().setY(e.gameSpatial.pos.data[1]),e.physTransform.getOrigin().setZ(e.gameSpatial.pos.data[2]),d.set(e.gameSpatial.rot),d.rotateX(-Math.PI*.5);var t=d.toAngles();e.physQuat.setEuler(t.data[2],t.data[0],t.data[1]),e.physTransform.setRotation(e.physQuat),e.ammoShapeComponent.setWorldTransform(e.physTransform),e.ammoShapeComponent.activate()}});return r}function L(e,t,n){var r=E(e),i=new Ammo.btTransform;i.setIdentity(),i.setOrigin(new Ammo.btVector3(n.spatial.pos.data[0],n.spatial.pos.data[1],n.spatial.pos.data[2]));var s=0,o=new Ammo.btVector3(0,0,0),a=new Ammo.btDefaultMotionState(i),f=new Ammo.btRigidBodyConstructionInfo(s,a,r,o),c=new Ammo.btRigidBody(f);l.setValue(1,0,1),c.setLinearFactor(l),u.addRigidBody(c),t.ammoShapeComponent=c,c.setFriction(1),n.rbPtr=c.ptr;var h=k(n,t);t.setComponent(h)}function A(e,t){L(t.transformComponent.children[0].entity.meshDataComponent.meshData,t,e)}function O(e,t){var n=5*e*e*e,r=new Ammo.btTransform;r.setIdentity(),r.getOrigin().setX(t[0]),r.getOrigin().setY(t[1]+e),r.getOrigin().setZ(t[2]);var i=new Ammo.btVector3(0,0,0),s=new Ammo.btSphereShape(e);s.calculateLocalInertia(n,i);var o=new Ammo.btDefaultMotionState(r),a=new Ammo.btRigidBodyConstructionInfo(n,o,s,i),f=new Ammo.btRigidBody(a);return f.setFriction(.5),u.addRigidBody(f),f}function _(e,t){h.setX(e[0]),h.setY(e[1]),h.setZ(e[2]),p.setX(t[0]),p.setY(t[1]),p.setZ(t[2]),M.set_m_closestHitFraction(1),M.get_m_rayFromWorld().setValue(e[0],e[1],e[2]),M.get_m_rayToWorld().setValue(t[0],t[1],t[2]),u.rayTest(h,p,M);var n=M.get_m_closestHitFraction(),r=!1;return n<1&&(r={fraction:n,normal:M.get_m_hitNormalWorld(),rbPtr:M.get_m_collisionObject().ptr}),r}function D(e,t){return _([e[0],e[1]-t*.5,e[2]],[e[0],e[1]-t*1.5,e[2]])}function P(e,t){return e.gameEntity=t,e.sphereEntity.updatePhysics=function(){t.spatial.pos.set(e.sphereEntity.transformComponent.transform.translation),t.moveSphere.spatialControl.sphereMovement.groundContact=D(t.spatial.pos,t.pieceData.dimensions.mobRadius)},e.sphereEntity.deactivate=function(){j(e.sphereEntity.ammoComponent)},e.sphereEntity.activate=function(t,n,r){B(e.sphereEntity.ammoComponent,t,n,r)},e}function H(e){u.removeRigidBody(e)}function B(e,t,n,r){e.activate();if(t){r||(r=.5);var i=e.getCenterOfMassTransform();i.getOrigin().setX(t[0]),i.getOrigin().setY(t[1]+r),i.getOrigin().setZ(t[2]),console.log(t[0],t[1],t[2]),e.setCenterOfMassTransform(i)}n&&(console.log("SET VEL: ",n),e.setLinearVelocity(new Ammo.btVector3(n[0],n[1],n[2]))),e.enabled=!0}function j(e){e.enabled=!1}function F(e,t,n,r){var i=t.maxX-t.minX,s=t.maxY-t.minY,o=t.maxZ-t.minZ,a=4,f=Ammo.allocate(a*n*r,"float",Ammo.ALLOC_NORMAL);for(var l=0;l<r;l++)for(var c=0;c<n;c++)Ammo.setValue(f+(l*n+c)*a,e[c][l]*s,"float");var h=1,p=t.minY,d=t.maxY,v=1,m=0,g=!1,y=new Ammo.btHeightfieldTerrainShape(n,r,f,h,p,d,v,m,g),b=i/n,w=o/r,E=1,S=new Ammo.btVector3(b,E,w);y.setLocalScaling(S);var x=new Ammo.btTransform;x.setIdentity(),x.setOrigin(new Ammo.btVector3(t.minX,t.minY,t.minZ));var T=new Ammo.btDefaultMotionState(x),N=new Ammo.btVector3(0,0,0),C=0,k=new Ammo.btRigidBodyConstructionInfo(C,T,y,N),L=new Ammo.btRigidBody(k);u.addRigidBody(L)}var o=new s,u,a,f,l=new Ammo.btVector3,c=new Ammo.btVector3,h=new Ammo.btVector3,p=new Ammo.btVector3,d=new i,v=0,m=1,g=2,y=3,b=4,w=5,M=new Ammo.ClosestRayResultCallback(h,p);return{addHeightmap:F,initPhysics:N,stepAmmoSimulation:T,addPhysicalWorldMesh:S,setTrimeshPhysicsTransform:x,physicsRayRange:_,createAmmoJSSphere:O,createAmmoShapeComponent:A,createAmmoComponentScript:C,attachSphericalMovementScript:P,removeAmmoComponent:H,deactivateAmmoComponent:j,activateAmmoComponent:B}}),define("3d/SceneController",["application/EventManager","physics/PhysicalWorld"],function(e,t){var n=function(){this.ticking=!1};return n.prototype.viewTick=function(n){t.stepAmmoSimulation(),e.fireEvent(e.list().UPDATE_ACTIVE_ENTITIES,{frameTime:n})},n}),define("physics/ForceProcessor",["goo/math/Vector3"],function(e){var t=new e,n=function(e,t){t.addv(e)},r=function(e,n,r){t.setv(n),r.addv(t.cross(e))};return{addForceToAcc:n,addForceToTorque:r}}),define("3d/GooJointAnimator",["goo/math/Quaternion","goo/math/Matrix4x4","goo/math/Matrix3x3","goo/math/Vector3"],function(e,t,n,r){var i=new e,s=new n,o=new t,u=new r,a={},f=function(e,t,n,r){s.copy(e.sourceMatrix),t&&s.rotateX(t),n&&s.rotateY(n),r&&s.rotateZ(r),i.fromRotationMatrix(s),e._rotations[0]=i.data[0],e._rotations[1]=i.data[1],e._rotations[2]=i.data[2],e._rotations[3]=i.data[3]},l=function(e,t){e._scales[0]=t,e._scales[1]=t,e._scales[2]=t},c=function(e,t,n,r){s.copy(e.sourceMatrix),s.rotateX(t),s.rotateY(n),s.rotateZ(r),i.fromRotationMatrix(s),e._rotations[0]+=i.data[0],e._rotations[1]+=i.data[1],e._rotations[2]+=i.data[2],e._rotations[3]+=i.data[3]},h=function(e,t){e._translations[0]=t[0]+e.sourceTranslation[0],e._translations[1]=t[1]+e.sourceTranslation[1],e._translations[2]=t[2]+e.sourceTranslation[2]},p=function(e){console.log(e.geometries[0]);if(a[e.geometries[0].id]){e.pieceData.boneMap=a[e.geometries[0].id].boneMap,e.animationChannels=a[e.animationChannels[0].id].animationChannels;return}e.geometries[0].animationComponent.layers[0]._currentState||alert("No Source Tree loaded yet?"),e.pieceData.boneMap={},console.log("Setup bone map",e.geometries[0].animationComponent.layers[0]);var t=e.geometries[0].animationComponent.layers[0]._currentState._sourceTree._clip;for(var n=0;n<t._channels.length;n++)e.pieceData.boneMap[t._channels[n]._jointName]=n,t._channels[n].sourceTranslation=[t._channels[n]._translations[0],t._channels[n]._translations[1],t._channels[n]._translations[2]],i.seta(t._channels[n]._rotations),t._channels[n].sourceMatrix=i.toRotationMatrix();e.animationChannels=t._channels,a[e.geometries[0].id]={animationChannels:t._channels,boneMap:e.pieceData.boneMap}},d=function(e,t,n){var r=e.animationChannels[e.pieceData.boneMap[t]];r==undefined&&console.log("No Bone:",t,e.animationChannels),f(r,n)},v=function(e,t,n){var r=e.animationChannels[e.pieceData.boneMap[t]];r==undefined&&console.log("No Bone:",t,e.animationChannels),l(r,n)},m=function(e,t,n,r,i){var s=e.animationChannels[e.pieceData.boneMap[t]];s==undefined&&console.log("No Bone:",t,e.animationChannels),f(s,n,r,i)},g=function(e){for(var t in e.animationChannels)f(e.animationChannels[t],0,0,0),l(e.animationChannels[t],1),h(e.animationChannels[t],[0,0,0])};return{resetEntityAnimationState:g,rotateBone:f,addRotationToBone:c,translateBone:h,printClipInitialTransform:p,updateEntityBoneRotX:d,updateEntityBoneRotXYZ:m,setEntityBoneScale:v}}),define("game/EntityModel",["3d/GooJointAnimator","goo/math/Vector3","goo/math/Matrix3x3"],function(e,t,n){var r={},i=0,s=function(e){var t=r[e];return t},o=function(e){u(e),e.removeFromWorld()},u=function(e){if(!e.transformComponent)return;for(var t=0;t<e.transformComponent.children.length;t++){var n=e.transformComponent.children[t];o(n.entity)}e.removeFromWorld()},a=function(t){if(r[t].geometries){var n=r[t];for(var i=0;i<n.geometries.length;i++){var s=n.geometries[i];s.animationComponent&&e.resetEntityAnimationState(n),u(s)}}delete r[t]},f=function(e){return r[e.id]=e,r[e.id]},l=function(e,r,i,s){e.controls={forward:{value:0,controlState:0},back:{value:0,controlState:0},turnleft:{value:0,controlState:0},turnright:{value:0,controlState:0},mouseturn:{value:0,controlState:0},mouseforward:{value:0,controlState:0},strafe:{value:0,controlState:0},jump:{value:0,controlState:0}},e.stats={altitude:0,speed:0,heading:0},e.spatial={pos:new t(0,0,0),visualPos:new t(0,0,0),visualRot:new n,rot:new n,dir:s||[0,0,0],acc:new t([0,0,0]),axisAttitudes:new t([0,0,0]),velocity:new t([0,1e-6,0]),audioVel:new t([0,1e-6,0]),angularVelocity:new t([0,0,0]),speed:0,state:"stop",angle:0,lastFrame:(new Date).getTime()},e.forces={lift:new t([0,1,0]),wingLiftLeft:{mag:new t([0,0,0]),poa:new t([0,0,0])},wingLiftRight:{mag:new t([0,0,0]),poa:new t([0,0,0])},rudderYaw:{mag:new t([0,0,0]),poa:new t([0,0,0])},elevatorLift:{mag:new t([0,0,0]),poa:new t([0,0,0])},buoyancy:new t([0,0,0]),drag:new t([0,0,1]),weight:new t([0,1,0]),thrust:new t([0,0,0]),torque:new t([0,0,0]),g:new t([0,0,0])},e.combat={hitPoints:1,damageTaken:0,isAlive:!0},e.geometries=[]},c=function(){i+=1;var e="cl"+i+"";return e},h=function(e){if(!e)var e=c();var t={};return t.id=e,t.isSelected=!1,f(t),l(t),t},p=function(e,t){e.hideDelay=setTimeout(function(){e.removedFromWorld=!0,e.geometries[0].removeFromWorld();for(var t=0;t<e.geometries[0].transformComponent.children.length;t++);},t)},d=function(e){clearTimeout(e.hideDelay),e.hideDelay=null;if(!e.removedFromWorld)return;e.geometries[0].addToWorld(),e.removedFromWorld=!1;for(var t=0;t<e.geometries[0].transformComponent.children.length;t++);},v=function(e){if(e.hideDelay)return;if(e.removedFromWorld)return;p(e,5e3)},m=function(){i=0};return{clientEntities:r,resetSeed:m,getEntityById:s,createClientEntity:h,deleteClientEntity:a,hideEntityGeometry:v,showEntityGeometry:d}}),define("game/EntityController",["application/EventManager","game/EntityModel","goo/math/Vector3"],function(e,t,n){var r=function(e){return t.getEntityById(e)},i=function(e){return t.createClientEntity(e)},s=function(e){t.deleteClientEntity(e)},o=function(t){var n=i(e.eventArgs(t).entityId);e.eventArgs(t).callback(n)},u=function(t){s(e.eventArgs(t).entityId)},a=function(e){t.hideEntityGeometry(e)},f=function(e){t.showEntityGeometry(e)},l=function(n){for(var r in t.clientEntities){console.log("PieceController Remove: ",r,t.clientEntities[r]);if(t.clientEntities[r].isPlayer){var i=t.clientEntities[r],s=0,o=function(t){s+=1,s==i.pieceData.uiPages.length&&(console.log("PieceController Remove UI: ",s,t),setTimeout(function(){e.eventArgs(n).callback()},100))};for(var u=0;u<i.pieceData.uiPages.length;u++)e.fireEvent(e.list().UNLOAD_UI_TEMPLATE,{templateId:i.pieceData.uiPages[u],callback:o});u==0&&e.eventArgs(n).callback()}e.fireEvent(e.list().REMOVE_GAME_ENTITY,{entityId:r})}t.resetSeed()};return e.registerListener(e.list().UN_LOAD_3D,l),e.registerListener(e.list().REMOVE_GAME_ENTITY,u),e.registerListener(e.list().ADD_GAME_ENTITY,o),{getEntityById:r,hideEntity:a,showEntity:f}}),define("game/GameUtil",[],function(){var e,t,n=function(e,t,n){var r=[n[0]-e[0],n[1]-e[1],n[2]-e[2]];return Math.atan2(r[0],r[2])-t[1]},r=function(e,t){return e.transformComponent?e.transformComponent.transform.rotation.applyPost(t):e.spatial?e.spatial.rot.applyPost(t):(console.log("NO ROTATION MATRIX"),t)},i=function(e,t,n){return t[n][1]+(e-t[n][0])/(t[n+1][0]-t[n][0])*(t[n+1][1]-t[n][1])},s=function(e,t){for(var n=0;n<t.length;n++){if(!t[n+1])return 0;if(t[n+1][0]>e)return i(e,t,n)}return 0},o=function(e,t,n,r){return Math.atan2(r-t,e-n)},u=function(e,t,n,r){return Math.sqrt((e-n)*(e-n)+(t-r)*(t-r))};return{determineYAngleFromPosAndRotToPos:n,angleBetweenPoints:o,lineDistance:u,applyRotationToVelocity:r,fitValueInCurve:s}}),define("goo/addons/terrainpack/TerrainSurface",["goo/renderer/MeshData","goo/math/MathUtils"],function(e,t){function n(t,n,r,i){var s=[];for(var o=0;o<t.length;o++)for(var u=0;u<t[o].length;u++)s.push(o*n/(t.length-1),t[o][u]*r,u*i/(t.length-1));this.verts=s,this.vertsPerLine=t[0].length;var a=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]),f=this.verts.length/3,l=f/this.vertsPerLine;e.call(this,a,f,(l-1)*(this.vertsPerLine-1)*6),this.rebuild()}return n.prototype=Object.create(e.prototype),n.prototype.rebuild=function(){this.getAttributeBuffer(e.POSITION).set(this.verts);var n=[],r=[],i=[],s=this.verts.length/3,o=s/this.vertsPerLine;for(var u=0;u<o-1;u++){for(var a=0;a<this.vertsPerLine-1;a++){var f=(u+0)*this.vertsPerLine+(a+0),l=(u+1)*this.vertsPerLine+(a+0),c=(u+1)*this.vertsPerLine+(a+1),h=(u+0)*this.vertsPerLine+(a+1);n.push(l,f,h,l,h,c),i=t.getTriangleNormal(this.verts[f*3+0],this.verts[f*3+1],this.verts[f*3+2],this.verts[h*3+0],this.verts[h*3+1],this.verts[h*3+2],this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2]),r.push(i[0],i[1],i[2])}r.push(i[0],i[1],i[2])}u--;for(var a=0;a<this.vertsPerLine-1;a++){var f=(u+0)*this.vertsPerLine+(a+0),l=(u+1)*this.vertsPerLine+(a+0),h=(u+0)*this.vertsPerLine+(a+1);i=t.getTriangleNormal(this.verts[f*3+0],this.verts[f*3+1],this.verts[f*3+2],this.verts[h*3+0],this.verts[h*3+1],this.verts[h*3+2],this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2]),r.push(i[0],i[1],i[2])}r.push(i[0],i[1],i[2]),this.getAttributeBuffer(e.NORMAL).set(r),this.getIndexBuffer().set(n);var p=[],d=this.verts[this.verts.length-3],v=this.verts[this.verts.length-1];for(var u=0;u<this.verts.length;u+=3){var m=this.verts[u+0]/d,g=this.verts[u+2]/v;p.push(m,g)}return this.getAttributeBuffer(e.TEXCOORD0).set(p),this},n}),define("goo/scriptpack/HeightMapBoundingScript",["goo/math/MathUtils"],function(e){function t(e){this.matrixData=e,this.width=e.length-1}return t.prototype.getMatrixData=function(){return this.matrixData},t.prototype.getPointInMatrix=function(e,t){return this.matrixData[e][t]},t.prototype.getAt=function(e,t){return e<0||e>this.width||t<0||t>this.width?0:this.getPointInMatrix(e,t)},t.prototype.getInterpolated=function(e,t){var n=this.getAt(Math.ceil(e),Math.ceil(t)),r=this.getAt(Math.ceil(e),Math.floor(t)),i=this.getAt(Math.floor(e),Math.ceil(t)),s=this.getAt(Math.floor(e),Math.floor(t)),o=e-Math.floor(e),u=t-Math.floor(t),a=n*o+i*(1-o),f=r*o+s*(1-o),l=a*u+f*(1-u);return l},t.prototype.getTriangleAt=function(e,t){var n=Math.ceil(e),r=Math.floor(e),i=Math.ceil(t),s=Math.floor(t),o=e-r,u=t-s,a={x:r,y:i,z:this.getAt(r,i)},f={x:n,y:s,z:this.getAt(n,s)},l;return o<1-u?l={x:r,y:s,z:this.getAt(r,s)}:l={x:n,y:i,z:this.getAt(n,i)},[a,f,l]},t.prototype.getPreciseHeight=function(t,n){var r=this.getTriangleAt(t,n),i=e.barycentricInterpolation(r[0],r[1],r[2],{x:t,y:n,z:0});return i.z},t.prototype.run=function(e){var t=e.transformComponent.transform.translation;t.data[1]=this.getInterpolated(t.data[2],t.data[0])},t}),define("goo/scriptpack/WorldFittedTerrainScript",["goo/scriptpack/HeightMapBoundingScript","goo/math/Vector3"],function(e,t){function s(e,t){if(e.minX>e.maxX)throw{name:"Terrain Exception",message:"minX is larger than maxX"};if(e.minY>e.maxY)throw{name:"Terrain Exception",message:"minY is larger than maxY"};if(e.minZ>e.maxZ)throw{name:"Terrain Exception",message:"minZ is larger than maxZ"};if(!t)throw{name:"Terrain Exception",message:"No heightmap data specified"};if(t.length!==t[0].length)throw{name:"Terrain Exception",message:"Heightmap data is not a square"};return!0}function o(t,n,r){n=n||i,s(n,t,r);var o={dimensions:n,sideQuadCount:t.length-1,script:new e(t)};return o}function u(){this.heightMapData=[],this.yMargin=1}var n=new t,r=new t,i={minX:0,maxX:100,minY:0,maxY:50,minZ:0,maxZ:100};return u.prototype.addHeightData=function(e,t){var n=o(e,t,this.heightMapData);return this.heightMapData.push(n),n},u.prototype.getHeightDataForPosition=function(e){for(var t=0;t<this.heightMapData.length;t++){var n=this.heightMapData[t].dimensions;if(e[0]<=n.maxX&&e[0]>=n.minX&&e[1]<n.maxY+this.yMargin&&e[1]>n.minY-this.yMargin&&e[2]<=n.maxZ&&e[2]>=n.minZ)return this.heightMapData[t]}return null},u.prototype.displaceAxisDimensions=function(e,t,n,r){var i=e-t;return r*i/(n-t)},u.prototype.returnToWorldDimensions=function(e,t,n,r){var i=(n-t)/r,s=e*i;return t+s},u.prototype.getTerrainHeightAt=function(e){var t=this.getHeightDataForPosition(e);if(t===null)return null;var n=t.dimensions,r=this.displaceAxisDimensions(e[0],n.minX,n.maxX,t.sideQuadCount),i=this.displaceAxisDimensions(e[2],n.minZ,n.maxZ,t.sideQuadCount),s=t.script.getPreciseHeight(r,i);return s*(n.maxY-n.minY)+n.minY},u.prototype.getTerrainNormalAt=function(e){var t=this.getHeightDataForPosition(e);if(!t)return null;var i=t.dimensions,s=this.displaceAxisDimensions(e[0],i.minX,i.maxX,t.sideQuadCount),o=this.displaceAxisDimensions(e[2],i.minZ,i.maxZ,t.sideQuadCount),u=t.script.getTriangleAt(s,o);for(var a=0;a<u.length;a++)u[a].x=this.returnToWorldDimensions(u[a].x,i.minX,i.maxX,t.sideQuadCount),u[a].z=this.returnToWorldDimensions(u[a].z,i.minY,i.maxY,1),u[a].y=this.returnToWorldDimensions(u[a].y,i.minZ,i.maxZ,t.sideQuadCount);return n.set(u[1].x-u[0].x,u[1].z-u[0].z,u[1].y-u[0].y),r.set(u[2].x-u[0].x,u[2].z-u[0].z,u[2].y-u[0].y),n.cross(r),n.data[1]<0&&n.scale(-1),n.normalize(),n},u}),define("3d/TerrainColorer",["goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/Texture","goo/renderer/TextureCreator"],function(e,t,n,r,i,s,o,u){function f(e,t){var n=document.createElement("canvas"),r=n.getContext("2d"),u=new Image;console.log("MAKE TERRAIN MATERIAL",e);var a=function(e){var r=new i(s.uber,"ground_colors"),a=new o(n,null,e.width,e.height);r.setTexture("DIFFUSE_MAP",a),r.materialState.ambient=[0,0,0,1],r.materialState.diffuse=[.4590909090909091,.4690909090909091,.2590909090909091,1],r.cullState.frontFace="CW",r.cullState.cullFace="Back",r.cullState.enabled=!1,r.materialState.specular=[.02,.016,.006,.5],r.materialState.emissive=[0,0,0,1],r.materialState.shininess=4.1,console.log("CANVAS MATERIAL LOADED",r),t(r,a,u,n)};u.onload=function(){console.log("TERRAIN MATERIAL IMAGE LOADED",u),n.width=u.width,n.height=u.height,r.drawImage(u,0,0,u.width,u.height),n.dataReady=!0,a(n)},u.src=e}var a="resources/images/textures/ground_stones_normal.png";return{makeTerrainMaterial:f}}),define("3d/Colorer",["application/EventManager","goo/renderer/Texture"],function(e,t){var n={},r=function(e){var t=""+Math.floor(e[0]*255),n=""+Math.floor(e[1]*255),r=""+Math.floor(e[2]*255);return"rgb("+t+", "+n+", "+r+")"},i=function(e){var t=""+Math.floor(e[0]*255),n=""+Math.floor(e[1]*255),r=""+Math.floor(e[2]*255),i=""+e[3];return"rgba("+t+", "+n+", "+r+", "+i+")"},s=function(){var e=Math.floor(Math.random()*3),t=[.5,.5,.5];return t[e]=.8,r(t)},o=function(e,t,n,r){var i={texture:t,sourceImage:n,canvas:r,width:r.width,height:r.height,context:r.getContext("2d")};return i},u=function(e,t,n){e.context.fillStyle=i(t.color),e.context.fillRect(n[0]-n[2]*.5,n[1]-n[3]*.5,n[2],n[3]),e.texture.needsUpdate=!0},a=function(e,t){return e.context.getImageData(t[0],t[1],1,1).data},f=function(e){return e.context.getImageData(0,0,e.height,e.width).data};return{registerCanvasTexture:o,getPaintableRGBA:a,getPaintableCanvasData:f,paintPaintable:u}}),define("goo/noise/Noise",["goo/math/MathUtils"],function(e){function t(){}return t.shifter=[37,91,12,128,216,96,51,153,39,231,223,180,160,157,135,179,74,50,205,151,4,213,196,58,212,120,53,45,10,195,137,159,103,144,109,170,202,48,121,13,245,68,232,28,210,174,197,80,107,206,156,116,155,240,162,79,41,59,147,117,0,242,118,164,129,101,98,126,214,105,89,26,130,254,85,199,8,165,76,75,187,166,64,143,217,149,78,7,172,230,87,119,42,247,84,139,16,141,134,86,154,71,253,60,99,235,168,30,34,55,113,140,191,69,31,106,40,82,73,33,81,14,234,131,255,88,169,136,248,148,220,138,219,102,44,127,36,200,95,208,54,152,47,20,23,15,52,123,177,224,122,171,215,173,211,188,190,133,244,167,236,35,63,145,221,104,65,24,70,100,56,150,49,77,110,228,112,209,198,1,237,185,250,225,93,201,124,108,218,72,243,21,22,6,114,38,125,29,66,249,222,111,241,11,186,61,176,183,17,163,229,161,57,238,227,132,67,83,207,226,46,189,115,193,194,233,182,192,18,27,25,2,3,252,97,62,184,239,175,92,246,142,251,204,203,32,146,90,19,9,178,158,181,94,43,5],t.split=function(t){var n=Math.floor(t),r=e.scurve5(t-n);return{i0:n+0,i1:n+1,f0:1-r,f1:0+r}},t.fractal1d=function(e,t,n,r,i,s){var o=0,u=1,a=0;for(var f=0;f<n;f++)o+=u*s.evaluate1d(e,t),a+=u,u*=r,e*=i;return o/a},t.fractal2d=function(e,t,n,r,i,s,o){var u=0,a=1,f=0;for(var l=0;l<r;l++)u+=a*o.evaluate2d(e,t,n),f+=a,a*=i,e*=s,t*=s;return u/f},t.fractal3d=function(e,t,n,r,i,s,o,u){var a=0,f=1,l=0;for(var c=0;c<i;c++)a+=f*u.evaluate3d(e,t,n,r),l+=f,f*=s,e*=o,t*=o,n*=o;return a/l},t.fractal4d=function(e,t,n,r,i,s,o,u,a){var f=0,l=1,c=0;for(var h=0;h<s;h++)f+=l*a.evaluate4d(e,t,n,r,i),c+=l,l*=o,e*=u,t*=u,n*=u,r*=u;return f/c},t}),define("goo/noise/ValueNoise",["goo/noise/Noise"],function(e){function t(){e.call(this)}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.sources=[0,1/15,2/15,.2,4/15,5/15,.4,7/15,8/15,.6,10/15,11/15,.8,13/15,14/15,1],t.evaluate1d=function(n,r){var i=e.split(n/r),s=e.shifter[i.i0&255]&15,o=e.shifter[i.i1&255]&15,u=0;return u+=i.f0*t.sources[s],u+=i.f1*t.sources[o],u},t.evaluate2d=function(n,r,i){var s=e.split(n/i),o=e.split(r/i),u=e.shifter[e.shifter[o.i0&255]+s.i0&255]&15,a=e.shifter[e.shifter[o.i0&255]+s.i1&255]&15,f=e.shifter[e.shifter[o.i1&255]+s.i0&255]&15,l=e.shifter[e.shifter[o.i1&255]+s.i1&255]&15,c=0;return c+=o.f0*s.f0*t.sources[u],c+=o.f0*s.f1*t.sources[a],c+=o.f1*s.f0*t.sources[f],c+=o.f1*s.f1*t.sources[l],c},t.evaluate3d=function(n,r,i,s){var o=e.split(n/s),u=e.split(r/s),a=e.split(i/s),f=e.shifter[e.shifter[e.shifter[a.i0&255]+u.i0&255]+o.i0&255]&15,l=e.shifter[e.shifter[e.shifter[a.i0&255]+u.i0&255]+o.i1&255]&15,c=e.shifter[e.shifter[e.shifter[a.i0&255]+u.i1&255]+o.i0&255]&15,h=e.shifter[e.shifter[e.shifter[a.i0&255]+u.i1&255]+o.i1&255]&15,p=e.shifter[e.shifter[e.shifter[a.i1&255]+u.i0&255]+o.i0&255]&15,d=e.shifter[e.shifter[e.shifter[a.i1&255]+u.i0&255]+o.i1&255]&15,v=e.shifter[e.shifter[e.shifter[a.i1&255]+u.i1&255]+o.i0&255]&15,m=e.shifter[e.shifter[e.shifter[a.i1&255]+u.i1&255]+o.i1&255]&15,g=0;return g+=a.f0*u.f0*o.f0*t.sources[f],g+=a.f0*u.f0*o.f1*t.sources[l],g+=a.f0*u.f1*o.f0*t.sources[c],g+=a.f0*u.f1*o.f1*t.sources[h],g+=a.f1*u.f0*o.f0*t.sources[p],g+=a.f1*u.f0*o.f1*t.sources[d],g+=a.f1*u.f1*o.f0*t.sources[v],g+=a.f1*u.f1*o.f1*t.sources[m],g},t.evaluate4d=function(n,r,i,s,o){var u=e.split(n/o),a=e.split(r/o),f=e.split(i/o),l=e.split(s/o),c=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i0&255]+a.i0&255]+u.i0&255]&15,h=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i0&255]+a.i0&255]+u.i1&255]&15,p=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i0&255]+a.i1&255]+u.i0&255]&15,d=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i0&255]+a.i1&255]+u.i1&255]&15,v=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i1&255]+a.i0&255]+u.i0&255]&15,m=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i1&255]+a.i0&255]+u.i1&255]&15,g=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i1&255]+a.i1&255]+u.i0&255]&15,y=e.shifter[e.shifter[e.shifter[e.shifter[l.i0&255]+f.i1&255]+a.i1&255]+u.i1&255]&15,b=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i0&255]+a.i0&255]+u.i0&255]&15,w=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i0&255]+a.i0&255]+u.i1&255]&15,E=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i0&255]+a.i1&255]+u.i0&255]&15,S=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i0&255]+a.i1&255]+u.i1&255]&15,x=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i1&255]+a.i0&255]+u.i0&255]&15,T=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i1&255]+a.i0&255]+u.i1&255]&15,N=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i1&255]+a.i1&255]+u.i0&255]&15,C=e.shifter[e.shifter[e.shifter[e.shifter[l.i1&255]+f.i1&255]+a.i1&255]+u.i1&255]&15,k=0;return k+=l.f0*f.f0*a.f0*u.f0*t.sources[c],k+=l.f0*f.f0*a.f0*u.f1*t.sources[h],k+=l.f0*f.f0*a.f1*u.f0*t.sources[p],k+=l.f0*f.f0*a.f1*u.f1*t.sources[d],k+=l.f0*f.f1*a.f0*u.f0*t.sources[v],k+=l.f0*f.f1*a.f0*u.f1*t.sources[m],k+=l.f0*f.f1*a.f1*u.f0*t.sources[g],k+=l.f0*f.f1*a.f1*u.f1*t.sources[y],k+=l.f1*f.f0*a.f0*u.f0*t.sources[b],k+=l.f1*f.f0*a.f0*u.f1*t.sources[w],k+=l.f1*f.f0*a.f1*u.f0*t.sources[E],k+=l.f1*f.f0*a.f1*u.f1*t.sources[S],k+=l.f1*f.f1*a.f0*u.f0*t.sources[x],k+=l.f1*f.f1*a.f0*u.f1*t.sources[T],k+=l.f1*f.f1*a.f1*u.f0*t.sources[N],k+=l.f1*f.f1*a.f1*u.f1*t.sources[C],k},t}),define("3d/addons/Vegetation",["goo/renderer/Material","goo/renderer/Camera","goo/math/Vector3","goo/math/Transform","goo/renderer/TextureCreator","goo/renderer/Texture","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/light/DirectionalLight","goo/util/CanvasUtils","goo/util/Ajax","goo/util/MeshBuilder","goo/noise/Noise","goo/noise/ValueNoise","goo/addons/terrainpack/TerrainSurface","goo/shapes/Quad","goo/renderer/shaders/ShaderBuilder","goo/util/rsvp"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g){function w(e,t,n){b=e,this.terrainData=n;var r=this.terrainData.dimensions,i=r.minX+(r.maxX-r.minX)*.5,s=r.minZ+(r.maxZ-r.minZ)*.5,o=[i,r.minY+1,s];this.canvasData=t.getTerrainCanvasDataAtPos(o)}var y=window.resourcePath,b;w.prototype.init=function(t,s,o){var u=new g.Promise,a=this.terrainData.dimensions,f=[];for(var l=0;l<E.length;l++){var h=this.createBase(E[l]);f[l]=h}var p=13,d=13,v=new c,m=new r,w=35,x=6e4;while(x>0){var T=a.minX+(a.maxX-a.minX)*Math.random(),N=a.minZ+(a.maxZ-a.minZ)*Math.random(),C=[T,10,N],k=t.getHeightAt(C),L=t.getGroundNormal(C);k===null&&(console.log("No height at pos: ",C),k=0),L===null&&(console.log("Pos outside terrain: ",C),L=new n(0,1,0));var A=L.dot(n.UNIT_Y),O=(Math.random()+Math.random()-1)/2+.5,M=Math.floor(O*f.length);if(k<1){M=Math.floor(Math.random()*2);if(k<-1.4){x--;continue}}if(A<.9){x--;continue}if(s(this.canvasData,C)>.3){x--;continue}var _=Math.random()*Math.random()*3+1;m.scale.setd(_,_,_),m.translation.setd(0,0,0);var D=Math.random()*Math.PI*.5,P=Math.sin(D),H=Math.cos(D);m.lookAt(new n(P,0,H),L),m.translation.setd(T,k,N),m.update();var h=f[M];v.addMeshData(h,m),o(C,_*.2+.2*Math.random(),2+_*2+Math.random()*2),x--}var B=v.build(),j=new e(S,"vegetation"),F=(new i).loadTexture2D(y+"images/textures/nature1024.png",null,function(){u.resolve()});j.setTexture("DIFFUSE_MAP",F),j.cullState.enabled=!1,j.uniforms.discardThreshold=.9,j.blendState.blending="NoBlending",j.uniforms.materialAmbient=[.4,.4,.4,1],j.uniforms.materialSpecular=[.1,.1,.01,1],j.uniforms.specularIntensity=.01,j.renderQueue=2001;for(var I in B){var q=b.world.createEntity(B[I],j);q.meshRendererComponent.castShadows=!1,q.meshRendererComponent.isReflectable=!1,q.meshRendererComponent.receiveShadows=!1,q.meshRendererComponent.materials.push(j),q.addToWorld()}return u};var E=[{w:1.4,h:2.1,tx:.004,ty:.7,tw:.13,th:.13},{w:1.4,h:2.1,tx:.004,ty:.54,tw:.15,th:.16},{w:.5,h:.5,tx:.02,ty:.875,tw:.128,th:.11},{w:2.6,h:4.1,tx:.14,ty:.73,tw:.19,th:.27},{w:1.8,h:1.1,tx:.34,ty:.79,tw:.33,th:.21},{w:1.8,h:1.1,tx:.34,ty:.79,tw:.33,th:.21},{w:.8,h:.5,tx:.14,ty:.59,tw:.28,th:.13}];w.prototype.createBase=function(e){var t=new v(e.w,e.h,1,1);t.attributeMap.BASE=o.createAttribute(1,"Float"),t.rebuildData(t.vertexCount,t.indexCount,!0),t.getAttributeBuffer(o.TEXCOORD0).set([e.tx,e.ty,e.tx,e.ty+e.th,e.tx+e.tw,e.ty+e.th,e.tx+e.tw,e.ty]),t.getAttributeBuffer("BASE").set([0,1*e.h,1*e.h,0]);var n=new c,i=new r;i.translation.y=e.h*.5,i.update(),n.addMeshData(t,i),i.setRotationXYZ(0,Math.PI*.5,0),i.update(),n.addMeshData(t,i);var s=n.build();return s[0]};var S={processors:[m.light.processor],attributes:{vertexPosition:o.POSITION,vertexNormal:o.NORMAL,vertexUV0:o.TEXCOORD0,base:"BASE"},uniforms:{viewProjectionMatrix:u.VIEW_PROJECTION_MATRIX,worldMatrix:u.WORLD_MATRIX,cameraPosition:u.CAMERA,diffuseMap:u.DIFFUSE_MAP,discardThreshold:-0.01,time:u.TIME},builder:function(e,t){m.light.builder(e,t)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","attribute vec2 vertexUV0;","attribute float base;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float time;",m.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void) {","vec3 swayPos = vertexPosition;","swayPos.x += sin(time * 0.5 + swayPos.x * 0.4) * base * sin(time * 1.5 + swayPos.y * 0.4) * 0.1 + 0.08;","	vec4 worldPos = worldMatrix * vec4(swayPos, 1.0);","	vWorldPos = worldPos.xyz;","	gl_Position = viewProjectionMatrix * worldPos;",m.light.vertex,"	normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","	texCoord0 = vertexUV0;","	viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;","uniform float discardThreshold;",m.light.prefragment,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void)","{","	vec4 final_color = texture2D(diffuseMap, texCoord0);","if (final_color.a < discardThreshold) discard;","	vec3 N = normalize(normal);",m.light.fragment,"	gl_FragColor = final_color;","}"].join("\n")}};return w}),define("goo/util/combine/EntityCombiner",["goo/entities/EntityUtils","goo/entities/Entity","goo/util/MeshBuilder","goo/math/Transform","goo/math/Vector3","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere"],function(e,t,n,r,i,s,o){function u(e,t,n,r){this.world=e,this.gridCount=t||1,this.gridSize=1,this.removeOldData=n!==undefined?n:!0,this.keepEntities=r!==undefined?r:!1,this.createdEntities=[]}function a(){var e=[],t=[];return{put:function(n,r){var i=e.indexOf(n);i===-1?(e.push(n),t.push(r)):t[i]=r},get:function(n){return t[e.indexOf(n)]},getKeys:function(){return e},getValues:function(){return t}}}return u.prototype.combine=function(){this.world.processEntityChanges(),this.world.getSystem("TransformSystem")._process(),this.world.getSystem("BoundingUpdateSystem")._process();var e=this.world.entityManager.getTopEntities();this.gridSize>1&&(this.gridSize=this._calculateBounds(e)/this.gridCount),this._combineList(e)},u.prototype._combineList=function(e){var n=e;this.createdEntities=[];if(e instanceof t==0){n=this.world.createEntity("root"),n.addToWorld();for(var r=0;r<e.length;r++)n.attachChild(e[r])}var i=new a;this._buildSubs(n,i);var s=i.getKeys();for(var r=0;r<s.length;r++){var o=s[r],u=i.get(o);this._combine(o,u)}},u.prototype._buildSubs=function(e,t,n){if(e._hidden||e.skip||e.animationComponent||e.particleComponent)return;if(!n||e.static===!1)n=[],t.put(e,n);e.meshDataComponent&&e.meshRendererComponent&&e.meshRendererComponent.worldBound&&n.push(e);for(var r=0;r<e.transformComponent.children.length;r++){var i=e.transformComponent.children[r];this._buildSubs(i.entity,t,n)}},u.prototype._combine=function(e,t){var i=e.transformComponent.worldTransform,s=new r,o=new r;i.invert(s);var u=new a;for(var f=0;f<t.length;f++){var l=t[f],c=l.meshRendererComponent.materials[0],h=l.meshDataComponent.meshData.attributeMap,p=Object.keys(h);p.sort(),p=p.join("_");if(this.gridSize>1){var d=l.meshRendererComponent.worldBound.center.x/this.gridSize,v=l.meshRendererComponent.worldBound.center.z/this.gridSize;p=p+"_"+Math.round(d)+"_"+Math.round(v)}var m=u.get(c);m||(m=new a,u.put(c,m));var g=m.get(p);g||(g=[],m.put(p,g)),g.push(l)}var y=u.getKeys();for(var f=0;f<y.length;f++){var b=y[f],w=u.get(b),E=w.getKeys();for(var S=0;S<E.length;S++){var x=w.get(E[S]);if(x.length===1)continue;var T=new n;for(var N=0;N<x.length;N++){var l=x[N];e!==l?o.multiply(s,l.transformComponent.worldTransform):o.setIdentity(),T.addMeshData(l.meshDataComponent.meshData,o),this.removeOldData?(l.clearComponent("meshDataComponent"),l.clearComponent("meshRendererComponent"),!this.keepEntities&&l._components.length===1&&l.transformComponent.children.length===0&&l.removeFromWorld()):(l.skip=!0,l._hidden=!0)}var C=T.build();for(var c in C){var l=this.world.createEntity(C[c],b);l.addToWorld(),e.attachChild(l),this.createdEntities.push(l)}}}},u.prototype._calculateBounds=function(e){var t=!0,n=new s;for(var r=0;r<e.length;r++){var u=e[r];u.traverse(function(e){if(e.meshRendererComponent&&!e.particleComponent)if(t){var r=e.meshRendererComponent.worldBound;r instanceof s?n.copy(r):r instanceof o?(n.center.setVector(r.center),n.xExtent=n.yExtent=n.zExtent=r.radius):(n.center.setVector(i.ZERO),n.xExtent=n.yExtent=n.zExtent=10),t=!1}else n.merge(e.meshRendererComponent.worldBound)})}return Math.max(n.xExtent,n.zExtent)*2},u.prototype.cleanup=function(e){for(var t=0;t<this.createdEntities.length;t++){var n=this.createdEntities[t];n.removeFromWorld(),n.parent().each(function(e){e.detachChild(n)})}},u}),define("3d/addons/Forrest",["goo/renderer/Material","goo/renderer/Camera","goo/math/Vector3","goo/math/Transform","goo/renderer/TextureCreator","goo/renderer/Texture","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/light/DirectionalLight","goo/util/CanvasUtils","goo/util/Ajax","goo/util/MeshBuilder","goo/noise/Noise","goo/noise/ValueNoise","goo/addons/terrainpack/TerrainSurface","goo/shapes/Quad","goo/loaders/DynamicLoader","goo/entities/EntityUtils","goo/util/combine/EntityCombiner","goo/util/TangentGenerator","goo/renderer/shaders/ShaderBuilder","goo/util/rsvp"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E){function S(){this.startX=20,this.startZ=20}S.prototype.init=function(e,t,i){var s=new E.Promise,o=new m({world:e.world,rootPath:i+"/tree1"});return o.load("project.project","root.bundle",{recursive:!1,preloadBinaries:!0,noEnvironment:!0}).then(function(i){e.world.process();var u=o.getCachedObjectForRef("entities/Veg_T01_aspenM_LOD2-Whole_root.entity"),a=e.world.createEntity("newroot"),f=new n,l=new r,c=15;while(c>0){var h=Math.random()*2-1,p=Math.random()*2-1;f.setd(h,0,p),f.normalize();var d=Math.random()*15+10;f.muld(d,d,d),f.x+=this.startX,f.z+=this.startZ,h=f.x,p=f.z,f.y=10;var v=t.getTerrainHeightAt(f.data),m=t.getTerrainNormalAt(f.data),b=m.dot(n.UNIT_Y);if(b<.9)continue;var w=(Math.random()*.6+.7)*.03;l.scale.setd(w,w,w),l.translation.setd(0,0,0);var E=Math.random()*Math.PI*.5,S=Math.sin(E),x=Math.cos(E);l.lookAt(new n(S,0,x),n.UNIT_Y),l.translation.setd(h,v,p),l.update();var T=g.clone(e.world,u);T.transformComponent.transform.copy(l),a.attachChild(T),c--}u.removeFromWorld(),a.addToWorld(),e.world.process();var N=new y(e.world,1);console.time("combine"),N._combineList(a),console.timeEnd("combine"),this.loadLODTrees(e,t).then(function(){s.resolve()})}.bind(this)).then(null,function(e){console.error("Failed to load scene: "+e)}),s},S.prototype.loadLODTrees=function(t,s){var o=new E.Promise,u=[];for(var a=0;a<x.length;a++){var f=this.createBase(x[a]);u[a]=f}var l=new c,h=new n,p=new r,d=500;for(var v=0;v<d;v++){var m=Math.random()*2-1,g=Math.random()*2-1;h.setd(m,0,g),h.normalize();var y=Math.random()*30+30;h.muld(y,y,y),h.x+=this.startX,h.z+=this.startZ,m=h.x,g=h.z,h.y=10;var b=s.getTerrainHeightAt(h.data);b===null&&(b=0);var w=s.getTerrainNormalAt(h.data);w===null&&(w=new n(0,1,0));var S=w.dot(n.UNIT_Y);if(S<.9||b>13)continue;var N=Math.random()*.4+.8;p.scale.setd(N,N,N),p.translation.setd(0,0,0),h.x-=32,h.y=0,h.z-=32,h.normalize(),p.lookAt(h,n.UNIT_Y),p.translation.setd(m,b,g),p.update();var f=u[Math.floor(Math.random()*u.length)];l.addMeshData(f,p)}var C=l.build(),k=new e(T,"vegetation"),L=(new i).loadTexture2D(window.hunterResources+"/veg_treeImpostors_full_alpha_0_dif_small.dds",null,function(){o.resolve()});k.setTexture("DIFFUSE_MAP",L);var L=(new i).loadTexture2D(window.hunterResources+"/veg_treeImpostors_0_nrm_small.dds");k.setTexture("NORMAL_MAP",L),k.uniforms.discardThreshold=.6,k.blendState.blending="CustomBlending",k.uniforms.materialAmbient=[.3,.3,.3,1],k.uniforms.materialSpecular=[0,0,0,1],k.renderQueue=3e3;for(var A in C){var O=t.world.createEntity(C[A],k);O.addToWorld()}return o};var x=[{w:7,h:7,tx:0,ty:.75,tw:.25,th:.25},{w:7,h:7,tx:.25,ty:.5,tw:.25,th:.25},{w:7,h:7,tx:.5,ty:.25,tw:.25,th:.25}];S.prototype.createBase=function(e){var t=new v(e.w,e.h,1,1);t.attributeMap.BASE=o.createAttribute(1,"Float"),t.rebuildData(t.vertexCount,t.indexCount,!0),b.addTangentBuffer(t),t.getAttributeBuffer(o.TEXCOORD0).set([e.tx,e.ty,e.tx,e.ty+e.th,e.tx+e.tw,e.ty+e.th,e.tx+e.tw,e.ty]),t.getAttributeBuffer("BASE").set([0,1*e.h,1*e.h,0]);var n=new c,i=new r;i.translation.y=e.h*.5-e.h*.2,i.update(),n.addMeshData(t,i);var s=n.build();return s[0]};var T={processors:[w.light.processor],attributes:{vertexPosition:o.POSITION,vertexTangent:o.TANGENT,vertexNormal:o.NORMAL,vertexUV0:o.TEXCOORD0,base:"BASE"},uniforms:{viewProjectionMatrix:u.VIEW_PROJECTION_MATRIX,worldMatrix:u.WORLD_MATRIX,normalMatrix:u.NORMAL_MATRIX,cameraPosition:u.CAMERA,diffuseMap:u.DIFFUSE_MAP,normalMap:u.NORMAL_MAP,discardThreshold:-0.01,time:u.TIME},builder:function(e,t){w.light.builder(e,t)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec4 vertexTangent;","attribute vec3 vertexNormal;","attribute vec2 vertexUV0;","attribute float base;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","uniform float time;",w.light.prevertex,"varying vec3 normal;","varying vec3 binormal;","varying vec3 tangent;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void) {","mat4 nMatrix = normalMatrix;","vec3 swayPos = vertexPosition;","swayPos.x += sin(time * 0.5 + swayPos.x * 0.4) * base * sin(time * 1.5 + swayPos.y * 0.4) * 0.02 + 0.01;","	vec4 worldPos = worldMatrix * vec4(swayPos, 1.0);","	vWorldPos = worldPos.xyz;","	gl_Position = viewProjectionMatrix * worldPos;",w.light.vertex,"	normal = normalize((nMatrix * vec4(vertexNormal, 0.0)).xyz);","	tangent = normalize((nMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	binormal = cross(normal, tangent) * vec3(vertexTangent.w);","	texCoord0 = vertexUV0;","	viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;","uniform sampler2D normalMap;","uniform float discardThreshold;",w.light.prefragment,"varying vec3 normal;","varying vec3 binormal;","varying vec3 tangent;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void)","{","	vec4 final_color = texture2D(diffuseMap, texCoord0);","if (final_color.a < discardThreshold) discard;","mat3 tangentToWorld = mat3(tangent, binormal, normal);","vec3 tangentNormal = texture2D(normalMap, texCoord0).xyz * vec3(2.0) - vec3(1.0);","vec3 worldNormal = (tangentToWorld * tangentNormal);","vec3 N = normalize(worldNormal);",w.light.fragment,"	gl_FragColor = final_color;","}"].join("\n")}};return S}),define("3d/addons/Terrain",["goo/renderer/Material","goo/renderer/Camera","goo/math/Vector3","goo/renderer/TextureCreator","goo/renderer/Texture","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/light/DirectionalLight","goo/util/CanvasUtils","goo/util/Ajax","goo/noise/Noise","goo/noise/ValueNoise","goo/addons/terrainpack/TerrainSurface","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderFragment","goo/entities/EntityUtils","goo/scriptpack/WorldFittedTerrainScript","goo/renderer/shaders/ShaderLib","3d/addons/Vegetation","3d/addons/Forrest","goo/util/rsvp","physics/PhysicalWorld","3d/Colorer"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S){function x(){this.material=null,this.paintable=null,this.colorTx=null}var T=window.resourcePath+"/images/terrain",N=window.resourcePath+"/images/tiles/striperock.png",C=window.resourcePath+"/images/tiles/grass.png",k=window.resourcePath+"/images/tiles/darkrock.png",L=window.resourcePath+"/images/tiles/mud.png",A=window.resourcePath+"/images/tiles/detail.png",O=window.resourcePath+"/images/tiles/crackstile.png",M=window.resourcePath+"/images/tiles/striperock.png",_=window.resourcePath+"/images/tiles/grass.png",D=window.resourcePath+"/images/tiles/slabs.png",P=window.resourcePath+"/images/tiles/mud.png";x.prototype.buildCanvasTexture=function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d"),s=new Image;console.log("MAKE TERRAIN MATERIAL",e);var o=function(e){var r=new i(n,null,e.width,e.height);t(r,s,n)};s.onload=function(){console.log("TERRAIN MATERIAL IMAGE LOADED",s),n.width=s.width,n.height=s.height,r.drawImage(s,0,0,s.width,s.height),n.dataReady=!0,o(n)},s.src=e},x.prototype.init=function(e,t,n,r,i,s){var o=new w.Promise,u=function(t){var u=a.getMatrixFromCanvas(t);this._buildMesh(e,T,u,n,128,128,i,s);var f=r.addHeightData(u,n);o.resolve()}.bind(this);return a.loadCanvasFromPath(t,u),o},x.prototype.getPaintable=function(){return this.paintable},x.prototype._buildMesh=function(t,n,i,s,o,u,a,f){var l=s.maxX-s.minX,c=s.maxY-s.minY,p=s.maxZ-s.minZ,d=new h(i,l,c,p),v=new e(H,"Terrain");E.addPhysicalWorldMesh(d,s.minX,s.minY,s.minZ),v.uniforms.materialAmbient=[0,0,0,1],v.uniforms.materialDiffuse=[1.5,1.5,1.5,1];var m=(new r).loadTexture2D(n+"/start_norm.png");v.setTexture("NORMAL_MAP2",m);var g=4,y=(new r).loadTexture2D(C,{anisotropy:g}),b=(new r).loadTexture2D(k,{anisotropy:g}),w=(new r).loadTexture2D(L,{anisotropy:g}),x=(new r).loadTexture2D(N,{anisotropy:g}),T=(new r).loadTexture2D(A,{anisotropy:g}),B=(new r).loadTexture2D(O,{anisotropy:g}),j=this,F=function(e,n,i){j.paintable=S.registerCanvasTexture("terrain_canvas",e,n,i),v.setTexture("GROUND_MAP1",x),v.setTexture("GROUND_MAP2",b),v.setTexture("GROUND_MAP3",w),v.setTexture("GROUND_MAP4",y),v.setTexture("GROUND_MAP5",T),v.setTexture("GROUND_MAP6",B),v.setTexture("GROUND_MAP7",e);var o=(new r).loadTexture2D(_,{anisotropy:g}),u=(new r).loadTexture2D(D,{anisotropy:g}),a=(new r).loadTexture2D(P,{anisotropy:g}),l=(new r).loadTexture2D(M,{anisotropy:g});v.setTexture("GROUND_MAP1_NORMALS",l),v.setTexture("GROUND_MAP2_NORMALS",u),v.setTexture("GROUND_MAP3_NORMALS",a),v.setTexture("GROUND_MAP4_NORMALS",o);var c=t.world.createEntity("Terrain",d,v);c.transformComponent.transform.translation.setd(s.minX,s.minY,s.minZ),c.transformComponent.setUpdated(),c.addToWorld(),c.meshRendererComponent.cullMode="Never",f()};this.buildCanvasTexture(a,F)};var H={processors:[p.uber.processor,p.light.processor,p.animation.processor],attributes:{vertexPosition:s.POSITION,vertexNormal:s.NORMAL,vertexTangent:s.TANGENT,vertexColor:s.COLOR,vertexUV0:s.TEXCOORD0,vertexUV1:s.TEXCOORD1,vertexJointIDs:s.JOINTIDS,vertexWeights:s.WEIGHTS},uniforms:{viewProjectionMatrix:o.VIEW_PROJECTION_MATRIX,worldMatrix:o.WORLD_MATRIX,normalMatrix:o.NORMAL_MATRIX,cameraTranslation:o.CAMERA_TRANSLATION,cameraPosition:o.CAMERA,normalMap2:"NORMAL_MAP2",groundMap1:"GROUND_MAP1",groundMap2:"GROUND_MAP2",groundMap3:"GROUND_MAP3",groundMap4:"GROUND_MAP4",groundMap5:"GROUND_MAP5",groundMap6:"GROUND_MAP6",groundMap7:"GROUND_MAP7",groundMapN1:"GROUND_MAP1_NORMALS",groundMapN2:"GROUND_MAP2_NORMALS",groundMapN3:"GROUND_MAP3_NORMALS",groundMapN4:"GROUND_MAP4_NORMALS",diffuseMap:o.DIFFUSE_MAP,offsetRepeat:[0,0,1,1],normalMap:o.NORMAL_MAP,normalMultiplier:1,specularMap:o.SPECULAR_MAP,emissiveMap:o.EMISSIVE_MAP,aoMap:o.AO_MAP,lightMap:o.LIGHT_MAP,environmentCube:"ENVIRONMENT_CUBE",environmentSphere:"ENVIRONMENT_SPHERE",reflectionMap:"REFLECTION_MAP",transparencyMap:"TRANSPARENCY_MAP",opacity:1,reflectivity:0,refractivity:0,etaRatio:0,fresnel:0,discardThreshold:-0.01,fogSettings:[0,1e4],fogColor:[1,1,1],shadowDarkness:.5},builder:function(e,t){p.light.builder(e,t)},vshader:function(){return["attribute vec3 vertexPosition;","#ifdef NORMAL","attribute vec3 vertexNormal;","#endif","#ifdef TANGENT","attribute vec4 vertexTangent;","#endif","#ifdef COLOR","attribute vec4 vertexColor;","#endif","#ifdef TEXCOORD0","attribute vec2 vertexUV0;","uniform vec4 offsetRepeat;","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","attribute vec2 vertexUV1;","varying vec2 texCoord1;","#endif","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","uniform vec3 cameraTranslation;","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","#endif","varying float noise;","varying float noise2;",p.light.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;","#ifdef NORMAL","mat4 nMatrix = normalMatrix;","#endif","vec4 worldPos = wMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;","viewPosition = worldPos.xyz;","#ifdef NORMAL","	normal = normalize((nMatrix * vec4(vertexNormal, 0.0)).xyz);","#endif","#ifdef TANGENT","	tangent = normalize((nMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	binormal = cross(normal, tangent) * vec3(vertexTangent.w);","#endif","#ifdef COLOR","	color = vertexColor;","#endif","#ifdef TEXCOORD0","	texCoord0 = vertexUV0 * offsetRepeat.zw * 1.0 + offsetRepeat.xy;","#endif","#ifdef TEXCOORD1","	texCoord1 = vertexUV1;","#endif",p.light.vertex,"noise = (sin(texCoord0.x * 9450.0) + sin(texCoord0.y * 9450.0))*0.25+0.5;","noise2 = 0.0;","}"].join("\n")},fshader:function(){return["uniform sampler2D normalMap2;","uniform sampler2D groundMap1;","uniform sampler2D groundMap2;","uniform sampler2D groundMap3;","uniform sampler2D groundMap4;","uniform sampler2D groundMap5;","uniform sampler2D groundMap6;","uniform sampler2D groundMap7;","uniform sampler2D groundMapN1;","uniform sampler2D groundMapN2;","uniform sampler2D groundMapN3;","uniform sampler2D groundMapN4;","#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#endif","#ifdef FOG","uniform vec2 fogSettings;","uniform vec3 fogColor;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","varying vec2 texCoord1; //Use for lightmap","#endif","varying float noise;","varying float noise2;",p.light.prefragment,d.noise2d,"void main(void)","{","vec4 final_color = vec4(1.0);","vec2 coord  = texCoord0 * vec2(16.0);","vec2 coord1 = texCoord0 * vec2(40.0);","vec2 coord2 = texCoord0 * vec2(78.5);","vec2 coord3 = texCoord0 * vec2(124.0);","vec2 coord4 = texCoord0 * vec2(420.0);","vec2 coord5 = texCoord0 * vec2(1124.0);","vec3 landNormal = (texture2D(normalMap2, texCoord0).xyz * vec3(2.0) - vec3(1.0)).xzy;","landNormal.y = 0.5;","landNormal = normalize(landNormal);","vec3 landTangent = vec3(1.0, 0.0, 0.0);","vec3 landBinormal = cross(landNormal, landTangent);","mat3 tangentToWorld = mat3(landTangent, landBinormal, landNormal);","float slope = clamp(1.0 - dot(landNormal, vec3(0.0, 1.0, 0.0)), 0.0, 1.0);","slope = smoothstep(0.0, 0.5, slope);","const float NMUL = 1.2;","vec3 mountainN = texture2D(groundMapN1, coord1).xyz * vec3(1.0) - vec3(1.0);","mountainN.z = NMUL;","vec3 n1 = texture2D(groundMapN2, coord2).xyz * vec3(0.5) - vec3(1.0);","n1.z = NMUL;","vec3 n2 = texture2D(groundMapN3, coord3).xyz * vec3(2.0) - vec3(1.0);","n2.z = NMUL;","vec3 tangentNormal = mix(n1, n2, smoothstep(0.0, 1.0, noise));","tangentNormal = mix(tangentNormal, mountainN, slope);","vec3 worldNormal = (tangentToWorld * tangentNormal);","vec3 N = normalize(worldNormal);","vec4 mountain = texture2D(groundMap1, coord1);","vec4 g1 = texture2D(groundMap2, coord2);","vec4 g2 = texture2D(groundMap3, coord3);","vec4 g3 = texture2D(groundMap4, coord4);","vec4 detail = texture2D(groundMap5, coord);","vec4 detail2 = texture2D(groundMap6, coord5);","vec4 colors = texture2D(groundMap7, texCoord0);","final_color = mix(mountain, g1, clamp(((landNormal.y+noise*0.6)*1.2) - 0.7, 0.0, 1.0));","final_color = mix(final_color, g2, clamp(((landNormal.y-noise*0.13)*16.2) - 10.6, 0.0, 1.0));","final_color = mix(final_color, g3, clamp((landNormal.y*31.0-noise*6.1) - 21.0, 0.0, 1.0));","final_color = mix(final_color, colors, colors.a);","final_color = mix(final_color, detail, detail.a * final_color.r );","final_color = mix(final_color, detail2, detail2.a * (final_color.r - (final_color.r * final_color.g * final_color.b)));",p.light.fragment,"#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","gl_FragColor = final_color;","}"].join("\n")}};return x}),define("3d/HeightmapManager",["application/EventManager","game/GameUtil","game/GameConfiguration","goo/math/Vector3","goo/addons/terrainpack/TerrainSurface","goo/entities/EntityUtils","goo/scriptpack/WorldFittedTerrainScript","goo/util/CanvasUtils","3d/TerrainColorer","physics/PhysicalWorld","3d/Colorer","3d/addons/Terrain"],function(e,t,n,r,i,s,o,u,a,f,l,c){function d(e,t,n,r,i){var s={minX:t.pos[0],minZ:t.pos[2],minY:t.pos[1],maxX:t.pos[0]+t.width,maxZ:t.pos[2]+t.depth,maxY:t.pos[1]+t.height},o=function(){p[n]={dimensions:s,id:"terrain_"+n,zoneData:t,terrain:u},console.log("BUILT HEIGHT MAPS: ",p),r()};console.log("ADD HEIGHTMAP: ",n);var u=new c,a=u.init(e,t.heightData,s,h,t.texture1,i);a.resolve=o}var h=new o,p={},v=function(e,t){var n=e.terrain.getPaintable(),r=e.dimensions,i=n.width,s=n.height,o=(r.maxX-r.minX)/i,u=(t[0]-r.minX)/o,a=(t[2]-r.minZ)/o;return[u,s-a,o]},m=function(e,t,n){var r=p[E(e)];if(!r)return;var i=v(r,e);l.paintPaintable(r.terrain.getPaintable(),n,[i[0],i[1],t*i[2],t*i[2]])},g=function(e){var t=p[E(e)];if(!t)return;return l.getPaintableCanvasData(t.terrain.getPaintable())},y=function(e,t){var n=p[E(t)];if(!n)return;var r=v(n,t);return e[(Math.floor(r[1])*n.terrain.getPaintable().width+Math.floor(r[0]))*4+3]/255},b=function(e){var t=p[E(e)];if(!t)return 1;var n=t.terrain.getPaintable(),r=v(t,e);return l.getPaintableRGBA(t.terrain.getPaintable(),[Math.floor(r[0]),Math.floor(r[1])])},w=1,E=function(e){for(var t in p){var n=p[t].dimensions;if(e[0]<=n.maxX&&e[0]>=n.minX&&e[1]<n.maxY+w&&e[1]>n.minY-w&&e[2]<=n.maxZ&&e[2]>=n.minZ)return t}},S=function(e){return h.getTerrainHeightAt(e)},x=function(e){var t=h.getTerrainHeightAt(e),n=1e5;return t&&(n=e[1]-t),n},T=function(e){return h.getTerrainNormalAt(e)},N=function(){return p},C=function(e){return e==null?0:1-Math.abs(e.data[1])};return{getHeightAt:S,getGroundSlope:C,getGroundNormal:T,addHeightMap:d,getTerrainData:N,paintTerrainPoint:m,getCanvasRGBAAtPos:b,getTerrainCanvasDataAtPos:g,readTerrainCanvasAlphaAtPos:y,getHeightAboveGroundAtPos:x}}),define("game/world/PhysicalWorld",["goo/math/Vector3","game/EntityController","game/GameUtil","3d/HeightmapManager","physics/PhysicalWorld"],function(e,t,n,r,i){var s=new e,o=new e,u={},a=function(e){u[e.id]=e},f=function(e,t){for(var r=0;r<t.pieceData.physicalShapes.length;r++){var i=t.pieceData.physicalShapes[r];s.seta(i.posOffset);var o=n.applyRotationToVelocity(t.geometries[0],s);o.addv(t.spatial.pos);var u=o.subv(e),a=Math.sqrt(u.lengthSquared());if(a<i.radius)return{part:i,entity:t,pos:[e.data[0],e.data[1],e.data[2]]}}},l=function(e,t){for(var n in u)if(e.originatorId!=n&&e.id!=n){var r=u[n],i=r.pieceData.physicalRadius,o=s.setv(r.spatial.pos);o.data==undefined&&console.log(n,r);var a=o.subv(t),l=Math.sqrt(a.lengthSquared());if(l<i){var c=f(t,r);if(c)return c}}},c=function(e,t){var n=e.spatial.pos,s=t,u,a=i.physicsRayRange(e.spatial.pos,[e.spatial.pos[0]+e.spatial.velocity[0]*s,e.spatial.pos[1]+e.spatial.velocity[1]*s,e.spatial.pos[2]+e.spatial.velocity[2]*s]);if(a){var f=o.set(e.spatial.pos[0]+e.spatial.velocity[0]*a.fraction*s,e.spatial.pos[1]+e.spatial.velocity[1]*a.fraction*s,e.spatial.pos[2]+e.spatial.velocity[2]*a.fraction*s);return u=l(e,f),u?u:{part:"mesh",entity:null,pos:f}}var c=r.getHeightAboveGroundAtPos(n.data);return c<.5?{part:"ground",entity:null,pos:[n.data[0],n.data[1],n.data[2]]}:n.data[1]<0?{part:"water",entity:null,pos:[n.data[0],n.data[1],n.data[2]]}:!1},h=function(e){var t=e.spatial.pos,n={entities:[]},i=r.getHeightAboveGroundAtPos(t.data);return n.ground=i,n},p=function(e){r.paintTerrainPoint(e,2,{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.1]}),r.paintTerrainPoint(e,1,{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.2]}),r.paintTerrainPoint(e,.4,{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.3]})},d=function(e){delete u[e]};return{registerPhysicalEntity:a,getRangesToNearbyConflics:h,checkHitAgainstPhysicalShape:f,checkSpatialConflict:c,renderGroundHitEffect:p,removePhysical:d}}),define("game/controls/SurfaceController",["application/EventManager","3d/GooJointAnimator","goo/math/MathUtils"],function(e,t,n){var r=function(e){var t={data:e,lastSpeed:0,currentState:0,targetState:0,trimState:0,speed:e.speed,release:e.inputBehavior.release,lights:e.lights,locked:!1};return t},i=function(e,t,n){var r=e.surfaces[n];return t==undefined&&(r.release?t=0:t=r.currentState),r.targetState=t,r.locked=!1,t},s=function(t,n,r){var i=t.surfaces[r];return n==undefined&&(n=0),i.trimState+=.02*n,i.trimState=Math.min(i.trimState,.95),i.trimState=Math.max(i.trimState,-0.95),i.locked=!1,t.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:"trim_"+r,currentState:i.trimState}),n},o=function(t,n){t.surfaces[n].trimState=0,u(t,n),t.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:"trim_"+n,currentState:0})},u=function(r,i){var s=r.surfaces[i],o=s.data;if(s.locked)return;var u=s.targetState-s.currentState,a=o.controls,f=o.speed,l=1/(1+r.spatial.speed*r.spatial.speed*.03);f=f*u*l,f=n.lerp(.5,s.lastSpeed,f),s.lastSpeed=f;var c=s.currentState+f;Math.abs(c-s.targetState)<=f&&(c=s.targetState,s.locked=!0),r.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:i,currentState:c});for(var h in a){var p=a[h],d=function(e,n,i,s){s=s||0;for(var o in e){var u=r.pieceData.boneMap[o],f=r.animationChannels[u],l=(i+s)*a[n][o];n=="spoiler"&&(r.surfaces.wing_sweep.currentState>.5&&(l=0),c>0?l=Math.sqrt(Math.max(0,-l)):l=-Math.sqrt(-Math.min(0,l))),s,f&&t.rotateBone(f,l,0,0)}};d(p,h,c,s.trimState)}r.pieceInput.setAppliedState(i,c),s.currentState=c},a=function(e){for(var t in e.surfaces)u(e,t)};return{applyControlStateToSurface:i,applyTrimStateToSurface:s,processControlState:a,zeroSurfaceTrimState:o,buildSurface:r}}),define("game/controls/FlapsController",["application/EventManager","3d/GooJointAnimator"],function(e,t){var n=function(e){var t={data:e,currentState:0,targetState:0,speed:e.speed,locked:!1};return t},r=function(e,t){console.log("Fire Flaps change",t);var n=e.surfaces.flaps;return t==undefined&&(t=n.currentState),n.targetState=t,n.locked=!1,t},i=function(n){var r=n.surfaces.flaps;if(r.locked)return;var i=r.targetState-r.currentState;if(i==0)return;var s=i>0?1:i==0?0:-1;r.currentState+=s*r.speed,r.currentState=Math.max(r.currentState,0),r.currentState=Math.min(r.currentState,1),n.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:"flaps",currentState:r.currentState});var o=n.pieceData.surfaces.flaps.controls,u=n.pieceData.surfaces.flaps.speed;r.targetState<r.currentState&&(u=-u);var a=r.currentState+u;Math.abs(a-r.targetState)<=u&&(a=r.targetState,r.locked=!0);var f=o.flaps,l=function(e,r,i){console.log(e,r,i);for(var s in e){var u=n.pieceData.boneMap[s],a=n.animationChannels[u],f=i*o[r][s];t.rotateBone(a,f,0,0)}};l(f,"flaps",a),n.pieceInput.setAppliedState("flaps",a),r.currentState=a};return{applyControlStateToFlaps:r,processControlState:i,buildFlaps:n}}),define("game/controls/BreaksController",["application/EventManager","3d/GooJointAnimator"],function(e,t){var n=function(e,t,n){var r={data:t,targetState:n,currentState:0,lights:t.lights,type:t.type,breaks:t.breaks,speed:t.speed,locked:!1};return r},r,i=function(e,t){return r=e.systems.breaks,t==undefined&&(t=r.currentState),r.targetState=t,r.locked=!1,t},s=function(e,n,r){var i=e.pieceData.boneMap[n],n=e.animationChannels[i];t.rotateBone(n,r)},o,u,a,f,l,c=function(e){r=e.systems.breaks;if(r.locked)return;a=e.systems.breaks.data.controls,f=r.targetState-r.currentState;if(f==0)return;l=f>0?1:f==0?0:-1,r.currentState+=l*r.speed,r.currentState=Math.max(r.currentState,0),r.currentState=Math.min(r.currentState,1),o=r.speed,r.targetState<r.currentState&&(o=-o);var t=r.currentState+o;Math.abs(t-r.targetState)<=o&&(t=r.targetState,r.locked=!0),e.isPlayer,u=a.breaks;if(r.lights)for(var n=0;n<r.lights.length;n++)e.lights[r.lights[n]].setIntensity(t);var i=function(t,n,r){for(var i in t)s(e,i,r*t[i],a[n][i])};i(u,"breaks",t),e.pieceInput.setAppliedState("breaks",t),r.currentState=t};return{processControlState:c,applyControlStateToBreaks:i,buildSystem:n}}),define("game/parts/CanvasLight",[],function(){var e="darker",t="source-over",n=function(e,t,n,r){this.lightSystem=r,this.meshData=e,this.txcoords=t,this.materialMap=n,this.intensity=0,this.attenuation=0,this.masterIntensity=1,this.ctx=this.materialMap.ctx,this.img=this.materialMap.emitImg};return n.prototype.adjustMasterIntensity=function(e){this.masterIntensity=e,this.renderLightState()},n.prototype.attenuatedFill=function(e){return"rgba(0, 0, 0, "+e+")"},n.prototype.approachIntensity=function(e,t){this.intensity=1/(t+1)*(e+this.intensity*t),this.renderLightState()},n.prototype.setIntensity=function(e){this.intensity=e,this.renderLightState()},n.prototype.renderLightState=function(){if(this.intensity*this.masterIntensity>.05&&Math.abs(this.attenuation-(1-this.intensity*this.masterIntensity))<.05)return;this.lightSystem.registerAddImageRect([this.img,this.txcoords[0],this.txcoords[1],this.txcoords[2],this.txcoords[3],this.txcoords[0],this.txcoords[1],this.txcoords[2],this.txcoords[3]]),this.attenuation=1-this.intensity*this.masterIntensity,this.lightSystem.registerFillRectDarker([this.txcoords[0],this.txcoords[1],this.txcoords[2],this.txcoords[3],this.attenuatedFill(this.attenuation)])},n}),define("game/parts/LightSystem",[],function(){var e="darker",t="source-over",n=function(e,n,r,i){this.id=n,this.materialMap=i,this.entity=e,this.lights={},this.addImg=[],this.fillDark=[],this.patterns=r,this.activePattern=0,this.time=0,this.masterIntensity=1,this.ctx=this.materialMap.ctx,this.ctx.globalCompositeOperation=t};return n.prototype.addLight=function(e,t){this.lights[e]=t},n.prototype.setMasterIntensity=function(e,t){this.masterIntensity=e;for(var n in this.lights)this.lights[n].adjustMasterIntensity(this.masterIntensity);t&&(this.masterColor=t)},n.prototype.setSystemIntensity=function(e){for(var t in this.lights)this.lights[t].setIntensity(e)},n.prototype.lightOn=function(e,t,n){e.setIntensity(t)},n.prototype.lightOff=function(e){},n.prototype.setLightPatterns=function(e){this.activePattern=e},n.prototype.setMode=function(e){if(e<-0.9){this.setSystemIntensity(1),this.setLightPatterns(0);return}if(e<-0.4){this.setSystemIntensity(1),this.setLightPatterns(1);return}if(e<.4){this.setSystemIntensity(1),this.setLightPatterns(2);return}this.setLightPatterns(0),this.setSystemIntensity(0)},n.prototype.updateLightSystem=function(e){if(this.activePattern==0)return;var t=Math.floor(this.time*.015)%this.patterns[this.activePattern].length;for(var n in this.lights)t>=this.patterns[this.activePattern].length&&(t=0),this.lights[n].approachIntensity(this.patterns[this.activePattern][t],2),t+=1;this.time+=e},n.prototype.registerAddImageRect=function(e){this.addImg.push(e)},n.prototype.registerFillRectDarker=function(e){this.fillDark.push(e)},n.prototype.printAddImages=function(){this.ctx.globalCompositeOperation="source-over";for(var e=0;e<this.addImg.length;e++)this.ctx.drawImage(this.addImg[e][0],this.addImg[e][1],this.addImg[e][2],this.addImg[e][3],this.addImg[e][4],this.addImg[e][5],this.addImg[e][6],this.addImg[e][7],this.addImg[e][8]);this.addImg=[]},n.prototype.printFillDarkRects=function(){this.ctx.globalCompositeOperation=e;for(var t=0;t<this.fillDark.length;t++)this.ctx.fillStyle=this.fillDark[t][4],this.ctx.fillRect(this.fillDark[t][0],this.fillDark[t][1],this.fillDark[t][2],this.fillDark[t][3]);this.fillDark=[]},n}),define("game/parts/Lights",["application/EventManager","goo/renderer/Texture","game/parts/CanvasLight","game/parts/LightSystem"],function(e,t,n,r){function o(e,t,n,i){if(!t.length)return;var o={};e.lights=o,e.lightSystems={},e.lightsMaterialMap=u(e,n);for(var a=0;a<t.length;a++)e.lightSystems[t[a].id]=new r(e,t[a].id,i,e.lightsMaterialMap),s(e,t[a].id,t[a])}function u(e,n){var r=e.geometries[0].transformComponent.children,s={};for(var o=0;o<r.length;o++){var u=r[o].entity;for(var a=0;a<n.length;a++)if(u.name==n[a].meshEntityName){console.log("Emissive material: ",u.name);var f=u.meshRendererComponent.materials;u.meshRendererComponent.isReflectable=!1;for(var l=0;l<f.length;l++)if(f[l]._textureMaps.EMISSIVE_MAP&&f[l]._textureMaps.EMISSIVE_MAP.image){console.log(f[l].name);var c=f[l]._textureMaps.EMISSIVE_MAP.image,h=u.name+"_canvas",p;if(i[h])return i[h];e.screenMaterialMap&&e.screenMaterialMap.meshEntity.name==u.name&&(p=e.screenMaterialMap.canvas,c=e.screenMaterialMap.emitImg,d=e.screenMaterialMap.emissiveMap);if(!p){p=document.createElement("canvas"),p.id=h,p.width=c.naturalWidth,p.height=c.naturalHeight,p.dataReady=!0,i[h]=p;var d=new t(p,null,p.width,p.height);f[l].setTexture("EMISSIVE_MAP",d)}return s={meshRendComp:u.meshRendererComponent,meshEntity:u,material:f[l],emissiveMap:d,diffuseMap:f[l]._textureMaps.DIFFUSE_MAP,emitImg:c,canvas:p,ctx:p.getContext("2d")},i[h]=s,s}}}}function a(e,t,n){e.lights[t].setIntensity(n)}function f(e,t){for(var n in e.lightSystems)e.lightSystems[n].updateLightSystem(t);for(var n in e.lightSystems)e.lightSystems[n].printAddImages()}function l(e){for(var t in e.lightSystems)e.lightSystems[t].printFillDarkRects()}var i={},s=function(e,t,r){for(var i=0;i<r.lights.length;i++){var s=r.lights[i];e.lights[s.id]=new n(s.meshData,s.txcoords,e.lightsMaterialMap,e.lightSystems[t]),e.lightSystems[t].addLight(s.id,e.lights[s.id])}};return{setEntityLightIntensity:a,registerEntityLights:o,updateEntityLightState:f,attenuateWithDarkRects:l}}),define("game/planes/PlaneEngine",["application/EventManager","game/GameUtil","goo/math/Vector3","goo/math/Matrix3x3","game/parts/Lights","3d/GooJointAnimator","goo/entities/SystemBus"],function(e,t,n,r,i,s,o){var u=new n,a=new n,f,l=function(t){f=e.eventArgs(t).goo.world};e.registerListener(e.list().ENINGE_READY,l);var c=function(e,t,r){console.log("--------------->>>>  Add Engine"),this.planeEntity=e,this.engineId=e.id+JSON.stringify(r.posOffset),this.type=t,this.engineData=r,this.currentState=0,this.targetState=0,this.maxThrust=r.maxThrust,this.afterBurnerBoost=r.afterBurner,this.thrust=0,this.thrustVector=new n,this.pos=new n(r.posOffset),this.started=!1,this.flameEffect={},this.smokeEffect={},this.fireSounds={},this.rpm=0,this.exhaustTemp=0,this.engineGeometry=f.createEntity("engine_geometry_"+this.engineId),this.planeEntity.geometries[0].transformComponent.attachChild(this.engineGeometry.transformComponent),this.engineGeometry.transformComponent.transform.translation.set(this.pos),r.rot?this.engineGeometry.transformComponent.transform.setRotationXYZ(r.rot[0],r.rot[1],r.rot[2]):r.rot=[0,0,0],this.flameLight=r.flame_light,this.engineData.nozzle&&this.updateNozzleState(this.determineNozzleState(0))},h,p=function(e,t){return e.transformComponent.transform.rotation.applyPost(t)};c.prototype.startEmission=function(){clearTimeout(this.endTimeout),this.particleComp.enabled=!0;for(var e=0;e<this.particleComp.emitters.length;e++)this.particleComp.emitters[e].enabled=!0};var d=2;c.prototype.determineNozzleState=function(e){var t=Math.max(e-.8,0);return t*d},c.prototype.updateNozzleState=function(e){s.setEntityBoneScale(this.planeEntity,this.engineData.nozzle,.6+e),s.updateEntityBoneRotXYZ(this.planeEntity,this.engineData.nozzle,0,e*this.engineData.rot[1],0)},c.prototype.updateEffects=function(n,r,i,s){var f=.4*(1-Math.cos(.5*Math.PI*n)),l=10*(r-n),c=(new Date).getTime()*.001;this.fireSounds[v(this.engineId)].sourceNode.playbackRate.value=n*n*1.8+n*.3+.8+.05+f*.13+Math.sin(c*134)*.01,this.fireSounds[v(this.engineId)].gainNode.gain.value=Math.sin(n*1.4),this.fireSounds[m(this.engineId)].sourceNode.playbackRate.value=n*n*.5+.7+n*Math.sin(Math.PI*n*.5)*.4+Math.sin(n*c*40+c*120)*.001,this.fireSounds[m(this.engineId)].gainNode.gain.value=n+n*Math.sin(n*c*90+c*120)*.02,this.fireSounds[g(this.engineId)].gainNode.gain.value=n*n*n*Math.sin(Math.PI*n*.8)*.5*(1+Math.sin(c*80)*.01),this.fireSounds[g(this.engineId)].sourceNode.playbackRate.value=Math.sqrt(n+.2)*194*Math.sin(Math.PI*n*.4)+f*3.12+Math.sin(c*130)*.03;var h=this.planeEntity.spatial.pos;u.set(this.pos);var p=t.applyRotationToVelocity(this.planeEntity.geometries[0],u);p.addv(h),a.set(0,0,-Math.random()*n*12-14.4*n-6),t.applyRotationToVelocity(this.planeEntity.geometries[0],a),Math.random()<(f-i)*.02&&e.fireEvent(e.list().ACROBATIC_SMOKE,{pos:p.data,count:1,dir:a.data}),Math.random()<(l-i)*.06&&e.fireEvent(e.list().PUFF_SMALL_WHITE,{pos:p.data,count:1,dir:[a.data[0]*.15+.1*(Math.random()-.5),a.data[1]*.15+.1*(Math.random()-.5),a.data[2]*.15+.1*(Math.random()-.5)]}),Math.random()<(l-i)*.02&&e.fireEvent(e.list().PUFF_WHITE_SMOKE,{pos:p.data,count:1,dir:[a.data[0]*.5+.3*(Math.random()-.5),a.data[1]*.5+.3*(Math.random()-.5),a.data[2]*.5+.3*(Math.random()-.5)]}),a.set(0,0,n*10),this.engineGeometry.transformComponent.worldTransform.rotation.applyPost(a),a.mul(-0.6*n*n);var d=.4;if(this.engineData.nozzle){var y=this.determineNozzleState(n);this.updateNozzleState(y),d+=y*.4}var b={color:[.8,.6,.7,1],opacity:[.7*n,.9*n],count:30*n,alpha:[[.1,1],[.6,.5],[1,0]],growth:[[0,-1],[.1,-3],[.6,-2]],size:[d,d*1.1],growthFactor:[1,1.2],stretch:1,strength:11*n,spread:.03,acceleration:1.01,lifespan:[.03,.03],rotation:[0,7],spin:"posToNeg",spinspeed:[-0.05,.07],sprite:"shockwave",loopcount:1,trailsprite:"projectile_1",trailwidth:1};o.emit("playParticles",{simulatorId:"AdditiveParticle",pos:p,vel:a,effectData:b});if(n>.9){this.maxThrust=this.engineData.maxThrust+this.engineData.afterBurner;var b={color:[1*n,.6*n,.2*n,.5*n*n],opacity:[.3,.8],alpha:[[0,1],[.3,.4],[1,0]],growth:[[.3,.5],[.65,1.2],[1,-0.2]],size:[d,d+.1],count:40*n,growthFactor:[1,1.2],stretch:1,strength:12,spread:.03,lifespan:[.03,.035],rotation:[0,7],spin:"posToNeg",spinspeed:[-0.05,.07],sprite:"shockwave",loopcount:1,trailsprite:"projectile_1",trailwidth:1};o.emit("playParticles",{simulatorId:"AdditiveParticle",pos:p,vel:a,effectData:b})}else this.maxThrust=this.engineData.maxThrust;var w=this.planeEntity.spatial.audioVel.data,E=[-w[0],-w[1],-w[2]];this.fireSounds[v(this.engineId)].panner.setPosition(p[0],p[1],p[2]),this.fireSounds[v(this.engineId)].panner.setVelocity(w[0],w[1],w[2]),this.fireSounds[v(this.engineId)].panner.setOrientation(E[0],E[1],E[2]),this.fireSounds[m(this.engineId)].panner.setPosition(p[0],p[1],p[2]),this.fireSounds[m(this.engineId)].panner.setVelocity(w[0],w[1],w[2]),this.fireSounds[m(this.engineId)].panner.setOrientation(E[0],E[1],E[2]),this.fireSounds[g(this.engineId)].panner.setPosition(p[0],p[1],p[2]),this.fireSounds[g(this.engineId)].panner.setVelocity(w[0],w[1],w[2]),this.fireSounds[g(this.engineId)].panner.setOrientation(E[0],E[1],E[2])};var v=function(e){return e+"_engine_loop"},m=function(e){return e+"_turbine_loop"},g=function(e){return e+"_tone_loop"};c.prototype.addJetSounds=function(){var t=function(e){this.fireSounds[e.playId]=e,console.log(e)}.bind(this);e.fireEvent(e.list().LOOP_AMBIENT_SOUND,{soundData:e.sound().ENGINE_ON,playId:v(this.engineId),callback:t}),e.fireEvent(e.list().LOOP_AMBIENT_SOUND,{soundData:e.sound().ENGINE_GAS,playId:m(this.engineId),callback:t}),e.fireEvent(e.list().LOOP_AMBIENT_SOUND,{soundData:e.sound().ENGINE_TONE,playId:g(this.engineId),callback:t})},c.prototype.removeJetSounds=function(){console.log("Stop loop"),e.fireEvent(e.list().STOP_SOUND_LOOP,{loopId:v(this.engineId)}),e.fireEvent(e.list().STOP_SOUND_LOOP,{loopId:m(this.engineId)}),e.fireEvent(e.list().STOP_SOUND_LOOP,{loopId:g(this.engineId)})},c.prototype.addJetFlame=function(){var e=this.planeEntity.spatial,t=this.engineData.rot,n=function(n){return n.velocity.set(6*(Math.random()-.5-t[1]*15),6.7*(Math.random()-.5),e.speed-175*(Math.random()-.5)),e.rot.applyPost(n.velocity),n.velocity},r=function(n){return n.position.set(t[1]*5-t[1]*.9*e.speed,0,-2-Math.random()*5),n.position.data[2]+=e.speed-e.speed*Math.random(),n.position.data[1]+=e.angularVelocity.data[0]*60,n.position},i={velocity:n,position:r},s=function(e){this.engineGeometry.transformComponent.attachChild(e.transformComponent),this.flameEffect=e.particleComponent,this.flameEffect.parentEntity=this.planeEntity.geometries[0],console.log(e);var t=0;for(var n=0;n<this.flameEffect.emitters.length;n++)t+=this.flameEffect.emitters[n].releaseRatePerSecond;this.flameEffect.maxReleaseRate=t}.bind(this)},c.prototype.addJetSmoke=function(){var e=function(e){this.smokeEffect=e.particleComponent;var t=0;for(var n=0;n<this.smokeEffect.emitters.length;n++)t+=this.smokeEffect.emitters[n].releaseRatePerSecond;this.smokeEffect.maxReleaseRate=t}.bind(this)},c.prototype.start=function(){this.started||(e.fireEvent(e.list().ONESHOT_AMBIENT_SOUND,{soundData:e.sound().ENGINE_START,pos:this.planeEntity.spatial.pos.data,dir:[0,0,0]}),this.addJetSounds(),this.started=!0,console.log("Start Engine"))},c.prototype.pause=function(){this.removeJetSounds(),this.started=!1,console.log("Pause Engine")};var y=function(e,t,n){return t>2&&(t=.2),e*(Math.random()*t*.2+t*.9)*n};c.prototype.updateRpm=function(){var e=.98*this.currentState+.04*Math.random()-this.rpm;this.rpm+=e*.01},c.prototype.updateTemps=function(){var e=Math.sin(this.rpm*(2.6-this.rpm)),t=Math.max((e-this.exhaustTemp)*e*.004,0),n=this.exhaustTemp*this.exhaustTemp*.001;this.flameLight&&i.setEntityLightIntensity(this.planeEntity,this.flameLight,2*this.exhaustTemp*(.8*this.exhaustTemp+Math.random()*.2)-.5),this.exhaustTemp+=t-n},c.prototype.updateThrust=function(e){this.airDensity=e;if(this.currentState==0&&this.targetState>0)this.start();else if(this.started&&this.rpm<=1e-5)this.pause();else if(!this.started)return;var t=this.targetState-this.currentState,n=t>0?1:t==0?0:-1;this.currentState+=n*.003,this.currentState=Math.max(this.currentState,0),this.currentState=Math.min(this.currentState,1),this.updateRpm(),this.updateTemps(),this.thrust=y(this.rpm,e,this.maxThrust),this.thrustVector.setd(0,0,this.thrust)};var b=function(t){h=e.eventArgs(t).context};return c.prototype.updateSystemEffects=function(e){this.started&&this.updateEffects(this.rpm,this.targetState,this.airDensity,e)},e.registerListener(e.list().REGISTER_AUDIO_CONTEXT,b),c}),define("game/controls/EngineController",["application/EventManager","game/planes/PlaneEngine"],function(e,t){var n=function(e,n,r){var i=new t(e,n,r);return i},r=function(e,t){var r=[];for(var i in t.controls)for(var s=0;s<t.mounts.length;s++)r.push(n(e,i,t.mounts[s]));var o={data:t,currentState:0,targetState:0,engines:r};return o},i=function(e,t){e.targetState=t},s=function(e,t){return t==undefined&&(t=engine.currentState),i(e.systems.engine,t),t},o=function(t){var n=t.systems.engine.engines;for(var r=0;r<n.length;r++){var i=n[r];i.targetState=t.systems.engine.targetState;var s=i.currentState;i.updateThrust(t.air.density)}if(s==i.currentState)return;t.systems.engine.currentState=s,t.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:"engine",currentState:s}),t.pieceInput.setAppliedState("throttle",t.systems.engine.currentState)};return{applyControlStateToEngines:s,processControlState:o,buildSystem:r}}),define("game/parts/WheelPart",["application/EventManager","3d/GooJointAnimator","game/GameUtil","3d/HeightmapManager","physics/PhysicalWorld","game/world/PhysicalWorld","goo/math/Vector3","goo/math/Matrix3x3"],function(e,t,n,r,i,s,o,u){function h(e,t){this.wheelId=e,this.controlId=t.control,this.controlAxis=t.axis||[1,0,0],this.pos=new o(t.pos),this.worldPos=new o,this.angle=0,this.forceVector=new o,this.dragCoeff=t.drag,this.breakMax=t.breakMax,this.radius=t.radius,this.suspBone=t.suspension.boneId,this.suspRange=t.suspension.range,this.suspStiffness=t.suspension.stiffness,this.suspAxis=t.suspension.axis,this.compressionLoss=0,this.stage=1,this.springCompression=0,this.wheelSpeed=0,this.wheelRot=0,this.groundVelocity=new o(0,0,0)}var a,f=new o,l=new o,c=new u,p=function(e,n,r){var i=e.pieceData.boneMap[n];if(i==undefined)return;var s=e.animationChannels[i];t.rotateBone(s,r,0,0)},d=function(e,n,r){var i=e.pieceData.boneMap[n];if(i==undefined)return;var s=e.animationChannels[i];t.addRotationToBone(s,r,0,0)},v=function(e,n,r,i){var s=e.pieceData.boneMap[n];if(s==undefined)return;var o=e.animationChannels[s];t.translateBone(o,[i[0]*-r,i[1]*-r,i[2]*-r])};h.prototype.setGroundVelocity=function(e){this.groundVelocity.setVector(e)},h.prototype.updateWheelRotation=function(e,t){this.springCompression?this.wheelSpeed=t/this.radius:this.wheelSpeed*=.995+Math.random()*.003,this.wheelRot+=this.wheelSpeed,p(e,this.wheelId,this.wheelRot)},h.prototype.compressedSuspensionForce=function(e,t,n,r){var i=0,s=e.systems.breaks.currentState*this.breakMax;e.systems.breaks.currentState>.2&&t<.02&&(e.spatial.velocity.mul(.958),e.spatial.angularVelocity.data[1]*.98),i=-r*7e4,f=e.spatial.rot.toAngles(),f.dot(g),this.forceVector.data[0]=this.forceVector.data[0]*.5-e.spatial.axisAttitudes.data[0]*this.breakMax*t*10+i*e.spatial.axisAttitudes.data[2]*t,this.forceVector.data[1]=n*this.suspStiffness*this.stage,this.forceVector.data[2]=this.forceVector.data[2]*.95-s*e.spatial.axisAttitudes.data[2]*t/(t+1.95/s)-s*t,this.forceVector.dot(f)},h.prototype.calcWheelForceVector=function(e){var t=0,n=this.springCompression+this.compressionLoss;v(e,this.suspBone,this.suspRange-n,this.suspAxis),f.set(e.spatial.velocity),f.subVector(this.groundVelocity);var r=f.length()+e.spatial.angularVelocity.data[1]*(this.pos.data[2]-this.pos.data[0]),i=0;if(this.controlId){var i=this.controlAxis[0]*e.surfaces[this.controlId].currentState*.2;i/=Math.max(r*2,.25),p(e,this.suspBone,i*1.2)}return n?(this.compressedSuspensionForce(e,r,n,-i),e.spatial.angularVelocity.data[0]*=.98,e.spatial.angularVelocity.data[1]*=.97,e.spatial.angularVelocity.data[2]*=.98,e.forces.torque.mul(.98)):this.forceVector.set(0,0,0),r};var m,g=new o;return h.prototype.calcSpringCompression=function(e){f.set(this.pos),this.worldPos.set(e.spatial.pos);var t=n.applyRotationToVelocity(e.geometries[0],f);this.worldPos.add(t),f.set(this.worldPos),f.data[1]+=1,l.set(this.worldPos),l.data[1]-=this.suspRange;var o=i.physicsRayRange(f.data,l.data);if(o){f.sub(l),a=o.fraction*Math.sqrt(f.lengthSquared())-1,g.set(o.normal.getX(),o.normal.getY(),o.normal.getZ());var u=s.checkSpatialConflict(e,100);e.cable?e.cable.updateHookedPlane(e):u.entity&&(e.groundEntity=u.entity,u.part.partId=="cable"&&(e.spatial.velocity.mul(.95),console.log(u.part.partId,u),u.entity.cables[u.part.cableNr].catchPlane(e)))}else e.groundEntity=null,a=r.getHeightAboveGroundAtPos(this.worldPos.data),a<100&&g.set(r.getGroundNormal(this.worldPos.data)),a||(a=100);var c=this.suspRange-Math.min(a,this.suspRange);this.compressionLoss=c-this.springCompression*1.2,this.retraction=0,this.springCompression=c,this.springCompression-this.suspRange>0&&(this.stage=5)},h.prototype.updateForceVector=function(e){this.calcSpringCompression(e);var t=this.calcWheelForceVector(e);this.updateWheelRotation(e,t),this.groundVelocity.mulDirect(.9999,.9999,.9999)},h}),define("game/controls/GearController",["application/EventManager","3d/GooJointAnimator","game/parts/WheelPart","game/controls/SurfaceController"],function(e,t,n,r){var i=function(e){var t=[];for(var r in e)t.push(new n(r,e[r]));return t},s=function(e,t,n){var r={data:t,doors:t.controls.doors,stands:t.controls.stands,lights:t.controls.lights,wheels:i(t.wheels),speed:t.speed,targetState:n,currentState:n,locked:!1};return r},o=function(e,t){console.log("Toggle Gear Target State - >",e,t);var n=1;t||(n=0),e.systems.gears.targetState=n,e.systems.gears.locked=!1},u=function(n){var i=n.systems.gears;if(i.currentState==1&&i.locked)return;var s=n.systems.gears.data.controls,o=i.speed;i.targetState<i.currentState&&(o=-o);var u=i.currentState+o;Math.abs(u-i.targetState)<=i.speed&&(u=i.targetState,i.currentState=u,i.locked=!0),n.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:"gears",currentState:u});var a=s.doors,f=s.stands;if(s.lights)for(var l=0;l<s.lights.length;l++)n.lights[s.lights[l]].setIntensity(u);var c=function(e,r,i){for(var o in e){var u=n.pieceData.boneMap[o],a=n.animationChannels[u],f=s[r][o];t.rotateBone(a,i*f[0],i*f[1],i*f[2])}};c(a,"doors",Math.min(u*1.6,1)),c(f,"stands",Math.max(1.6*u-.6,0)),n.pieceInput.setAppliedState("gears",u),i.currentState=u,r.applyControlStateToSurface(n,u,"gears")};return{processControlState:u,setEntityGearTargetState:o,buildSystem:s}}),define("game/controls/DriveController",["application/EventManager","3d/GooJointAnimator","game/parts/WheelPart"],function(e,t,n){var r=function(e){var t=[];for(var r in e)t.push(new n(r,e[r]));return t},i=function(e,t,n){var i={wheels:r(t.wheels)};return i},s=function(e,t){};return{processControlState:s,buildSystem:i}}),define("game/controls/CanopyController",["game/GameConfiguration","application/EventManager","3d/GooJointAnimator"],function(e,t,n){var r=function(e,t,n){var r=0;n&&(r=1);var i={data:t,targetState:r,currentState:r,doors:t.controls.doors,type:t.type,speed:t.speed,locked:!1};return i},i=function(e,t){console.log("Toggle Canopy Target State - >",e,t),e.systems.canopy.targetState=t,e.systems.canopy.locked=!1},s=function(e){var t=e.systems.canopy;t.targetState=1.5,t.speed=t.speed*4,t.locked=!1},o=function(e,t,r,i,s){var o=e.pieceData.boneMap[t],t=e.animationChannels[o];s=="rotate"?n.rotateBone(t,i[0]*-r,i[1]*-r,i[2]*-r):n.translateBone(t,[i[0]*-r,i[1]*-r,i[2]*-r])},u=function(n){var r=n.systems.canopy;if(r.locked)return;var i=n.systems.canopy.data.controls,s=r.speed;r.targetState<r.currentState&&(s=-s);var u=r.currentState+s;Math.abs(u-r.targetState)<=r.speed&&(u=r.targetState*1,r.locked=!0,console.log("Lock Canopy",u)),n.isPlayer&&(t.fireEvent(t.list().MIX_CHANNEL_VALUE,{channelId:e.MIX_TRACKS.game.id,valueId:"setChannelGain",amount:.5+Math.sin(1.68*u)*.5}),t.fireEvent(t.list().MIX_CHANNEL_VALUE,{channelId:e.MIX_TRACKS.game.id,valueId:"tuneFilterFreq",amount:.01+Math.sin(1.68*u)}),t.fireEvent(t.list().MIX_CHANNEL_VALUE,{channelId:e.MIX_TRACKS.game.id,valueId:"tuneFilterQ",amount:.01+u*u*.04}),t.fireEvent(t.list().PLAYER_CONTROL_STATE_UPDATE,{control:"canopy",currentState:u}));var a=i.doors,f=function(e,t,r,s){for(var u in e)o(n,u,r,i[t][u],s)};f(a,"doors",u,i.xform),n.pieceInput.setAppliedState("canopy",u),r.currentState=u};return{processControlState:u,fireCanopyEject:s,setEntityCanopyTargetState:i,buildSystem:r}}),define("game/controls/EjectionSeatController",["application/EventManager","3d/GooJointAnimator"],function(e,t){var n=function(e,t,n){var r=0;n&&(r=1);var i={data:t,targetState:r,currentState:r,seats:t.controls.seats,speed:t.speed,locked:!0};return i},r=function(t){t.systems.canopy.targetState=1.2,t.systems.canopy.locked=!1;var n=function(){t.systems.seat.ejectionTime=(new Date).getTime(),t.systems.seat.locked=!1};e.fireEvent(e.list().SEQUENCE_CALLBACK,{wait:800,callback:n})},i=function(e,n){return;var r,i,s,o,u,a,f};return{fireEjectionSeat:r,processControlState:i,buildSystem:n}}),define("game/weapons/FireDamage",["application/EventManager","game/GameUtil","goo/math/Vector3"],function(e,t,n){var r=new n,i=0,s=[],o=function(e,t,n){i+=1,this.age=0,this.id="fire_"+i,this.entity=e,this.intensity=n.intensity,this.size=n.size,this.posOffset=t.posOffset,this.partSize=t.radius,s.push(this)},u=function(e,t){return[e.data[0]+t*Math.random()-.5,e.data[1]+t*.5*Math.random()-.5,e.data[2]+t*Math.random()-.5]};o.prototype.updateFire=function(n){this.age+=n;if(Math.random()<this.intensity){var i=this.entity.spatial.pos;r.set(this.posOffset);var s=t.applyRotationToVelocity(this.entity.geometries[0],r);s.addv(i),s.add_d(this.partSize*(Math.random()-.5),this.partSize*.3+this.partSize*Math.random()*.2,this.partSize*(Math.random()-.5)),Math.random()<this.intensity*.5&&(e.fireEvent(e.list().DAMAGE_ENTITY,{entity:this.entity,damage:5}),e.fireEvent(e.list().FLASH_MUZZLE_FIRE,{pos:u(s,this.size),count:1,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),Math.random()<this.intensity*.5&&e.fireEvent(e.list().PUFF_BLACK_SMOKE,{pos:u(s,this.size),count:1,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]})),this.age<500&&e.fireEvent(e.list().FLASH_SPARKS,{pos:u(s,this.size),count:1,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),this.age<8500&&Math.random()<this.intensity&&e.fireEvent(e.list().FLASH_MUZZLE_FIRE,{pos:u(s,this.size),count:1,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),this.age<2500&&e.fireEvent(e.list().FLASH_MUZZLE_FIRE,{pos:u(s,this.size),count:1,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]})}this.age>15e3&&this.remove()},o.prototype.remove=function(){var e=s.indexOf(this);s.splice(e,1),delete this};var a=function(e){for(var t=0;t<s.length;t++)s[t].updateFire(e)},f=function(t){var n=e.eventArgs(t).frameTime;a(n)};return e.registerListener(e.list().UPDATE_ACTIVE_ENTITIES,f),o}),define("3d/effects/EffectConfigs",["game/GameConfiguration"],function(e){var t={flare:e.PRELOAD_GOO_TEXTURES.dot_particle,splash:e.PRELOAD_GOO_TEXTURES.splash_particle},n={white_cloud_puff:"white_cloud_puff",white_smoke_stream:"white_smoke_stream",splash_water:"splash_water",metal_sparks:"metal_sparks",explosion:"explosion"};return{effects:[{id:n.white_cloud_puff,particles:["white_cloud_puff"],sounds:[]},{id:n.white_smoke_stream,particles:["white_smoke_stream"],sounds:[]},{id:n.splash_water,particles:["splash_water"],sounds:[]},{id:n.metal_sparks,particles:["metal_sparks"],sounds:[]},{id:n.explosion,particles:["explosion_fire"],sounds:[]}],audio:[],particles:[{id:"white_cloud_puff",texture:e.PRELOAD_GOO_TEXTURES.smoke_particle,color:[.61,.61,.75,.02],size:[3214200,6214480],growth:[0,10],rotation:[0,350],spin:[0,0],gravity:0,count:1,spread:1,strength:10.1,acceleration:1,lifespan:[26.1,155.8],poolCount:2500},{id:"white_smoke_stream",texture:e.PRELOAD_GOO_TEXTURES.smoke_particle,color:[.8,.84,.91,.01],size:[200,480],growth:[4900,12400],rotation:[0,360],spin:[-10,10],gravity:0,count:1,spread:1,strength:.1,acceleration:1.0007,lifespan:[2.1,15.8],poolCount:2500},{id:"splash_water",texture:t.splash,color:[.8,.8,.99,1],size:[1200,2280],growth:[6900,7400],rotation:[0,360],spin:[0,0],gravity:-4,count:2,spread:.4,strength:1,acceleration:.999,lifespan:[1.1,1.8],poolCount:500},{id:"metal_sparks",texture:t.flare,blending:"additive",color:[1,1,1,.8],size:[20,40],rotation:[0,360],gravity:-15,count:15,spread:0,strength:1,lifespan:[.05,.1],poolCount:1e3,growth:[0,0],spin:[0,0],acceleration:.999},{id:"explosion_fire",texture:t.flare,color:[1,1,.7,1],blending:"additive",size:[120,140],growth:[900,900],rotation:[0,360],spin:[-150,150],gravity:0,count:7,spread:0,strength:1,acceleration:1,lifespan:[.02,.03],poolCount:12500}]}}),define("3d/effects/SoundHandler",["goo/sound/AudioContext","goo/loaders/DynamicLoader","goo/entities/SystemBus"],function(e,t,n){function r(){}var i={},s,o,u=1,a=!1,f=!0,l,c={},h={},p=!0;r.getMasterVolume=function(){return u},r.init=function(i){return};var d=function(e,t,n,r,u,a){if(t=="")return;i[e]="loading";if(p==0){var f=[t];i[e]=new Howl({urls:f,volume:n,buffer:!1,loop:r});return}l.load(t).then(function(t){var f=function(t){console.log("sound :"+e+" has been loaded"),i[e]={sources:{},index:0,play:function(i,f){var l=s.createBufferSource();l.id=this.index++,this.sources[l.id]=l,l.onended=function(){h[e]&&(console.log("Loop ended in stack Stack:",e,l.id,h),delete h[e][l.id]),delete this.sources[l.id]}.bind(this),l.loop=r,l.buffer=t;var c=s.createGain();if(a===!0){var p=s.createPanner();l.connect(p),p.setPosition(i.x,i.y,i.z),p.setVelocity(f.x,f.y,f.z),p.refDistance=15,p.connect(c)}else l.connect(c);var d=s.createBiquadFilter();c.connect(d),typeof u=="object"?(d.Q.value=u.q,d.frequency.value=u.f):(d.Q.value=1,d.frequency.value=22e3),d.connect(o),r&&(h[e]||(h[e]={}),h[e][l.id]={sound:this,source:l,gain:c.gain,panner:p,filter:d}),c.gain.value=n,l.start(0)},stop:function(){for(var t in this.sources){var n=this.sources[t];n.stop(0),n.onended()}this.index=0,this.sources={},h[e]&&console.log("Loop ended in stack Stack:",e,h)}}};s.decodeAudioData(t,f,function(){alert("Failed to decode the audio buffer.")})}).then(null,function(e){alert("failed to load: "+e)})};return r.setListenerData=function(e,t){s&&(s.listener.setPosition(e.x,e.y,e.z),s.listener.setOrientation(t.x,t.y,t.z,0,1,0))},r.registerAudioConfigs=function(e){console.log("register audio configs:",e);for(var t in e)d(e[t].id,e[t].url,e[t].volume,e[t].loop,e[t].filter,e[t].spatial)},r.startup=function(){var e=!0;localStorage["gooSoundEnabled"]=="false"&&(e=!1),r.useSounds=e,r.play("background")},r.shutdown=function(){r.useSounds=!1;for(var e in i)r.stop(e)},r.toggleSound=function(){r.useSounds?r.shutdown():r.startup()},r.play=function(e,t,n){console.log("Play sound",e);if(r.useSounds){var s=i[e];s==="loading"?(c[e]={pos:t,vel:n},setTimeout(function(){c[e]&&r.play(e,c[e].pos,c[e].vel)},250)):s&&(p?s.play(t,n):s.play())}},r.stop=function(e){var t=i[e];console.log("Stop SoundId: ",e,t),t&&typeof t.stop=="function"&&t.stop(),c[e]&&delete c[e]},r.updateSound=function(e,t,n,r){var i=h[e];if(c[e]){console.log("Loop is in queue...: ",e);return}var o=0;if(i){var u=.05;r.time&&(u=r.time);for(var a in i)o+=1,i[a].panner&&(i[a].panner.setPosition(t.x,t.y,t.z),i[a].panner.setVelocity(n.x,n.y,n.z)),r.pitch&&i[a].source.playbackRate.linearRampToValueAtTime(r.pitch,s.currentTime+u),r.frequency&&i[a].filter.frequency.linearRampToValueAtTime(r.frequency,s.currentTime+u),r.Q&&i[a].filter.Q.linearRampToValueAtTime(r.Q,s.currentTime+u),r.volume&&i[a].gain.linearRampToValueAtTime(r.volume,s.currentTime+u);o>1&&console.log("More than 1 loop active",e,i)}},r.stopAllLoops=function(){for(var e in h)r.stop(e)},r.update=function(e,t){var n=t.translation,i=t._up;r.setListenerData(n,i)},r}),define("3d/effects/MusicPlayer",["3d/effects/SoundHandler"],function(e){var t=function(){this.currentSong=null};return t.prototype.playMusic=function(t){e.play(t),this.currentSong=t},t.prototype.stopMusic=function(t){!t&&this.currentSong&&(t=this.currentSong),e.stop(t),this.currentSong=null},t}),define("particle_system/simulation/Particle",["goo/math/Vector3","goo/math/Vector4"],function(e,t){function n(r){this.calcVec=new e,this.upVector=new e,this.index=r,this.position=new e,this.direction=new e,this.velocity=new e,this.color=new t,this.color0=new e,this.color1=new e,this.id=n.ID++,this.reset()}function r(e,t){return Math.random()*(t-e)+e}return n.ID=0,n.prototype.reset=function(){this.position.set(0,0,0),this.velocity.set(0,0,0),this.color.set(1,1,1,1),this.color0.set(1,1,1),this.color1.set(1,1,1),this.upVector.set(0,1,0),this.colorBlend=0,this.colorCurve=[[0,1],[1,0]],this.opacity=1,this.alpha=[[0,0],[1,1]],this.size=1,this.growthFactor=1,this.growth=[[0,1],[1,0]],this.acceleration=1,this.gravity=0,this.rotation=0,this.spinspeed=0,this.spin=[[0,1],[1,0]],this.lifeSpan=0,this.lifeSpanTotal=0,this.progress=0,this.frameOffset=0,this.frameCount=0,this.tileIndex=0,this.offsetX=0,this.offsetY=0,this.dead=!0,this.requestKill=!1},n.prototype.joinSimulation=function(e,t){var n=e.data;this.direction.x=(Math.random()-.5)*2*n.spread+(1-n.spread)*e.normal.x,this.direction.y=(Math.random()-.5)*2*n.spread+(1-n.spread)*e.normal.y,this.direction.z=(Math.random()-.5)*2*n.spread+(1-n.spread)*e.normal.z,this.direction.normalize(),this.velocity.x=n.strength*this.direction.x,this.velocity.y=n.strength*this.direction.y,this.velocity.z=n.strength*this.direction.z,this.position.x=e.position.x+this.velocity.x*n.stretch*t,this.position.y=e.position.y+this.velocity.y*n.stretch*t,this.position.z=e.position.z+this.velocity.z*n.stretch*t,this.sprite=n.sprite,this.trailSprite=n.trailsprite,this.trailWidth=n.trailwidth,this.loopcount=n.loopcount,this.color1.seta(n.color1),this.color0.data[0]=n.color0[0]*(1-n.colorRandom)+n.colorRandom*Math.random(),this.color0.data[1]=n.color0[1]*(1-n.colorRandom)+n.colorRandom*Math.random(),this.color0.data[2]=n.color0[2]*(1-n.colorRandom)+n.colorRandom*Math.random(),this.color.data[0]=this.color0[0],this.color.data[1]=this.color0[1],this.color.data[2]=this.color0[2],this.colorCurve=n.colorCurve,this.opacity=r(n.opacity[0],n.opacity[1]),this.alpha=n.alpha,this.size=r(n.size[0],n.size[1]),this.growthFactor=r(n.growthFactor[0],n.growthFactor[1]),this.growth=n.growth,this.spin=n.spin,this.spinspeed=r(n.spinspeed[0],n.spinspeed[1]),this.rotation=r(n.rotation[0],n.rotation[1]),this.acceleration=n.acceleration,this.gravity=n.gravity,this.progress=0,this.lifeSpan=r(n.lifespan[0],n.lifespan[1]),this.lifeSpanTotal=this.lifeSpan,this.frameOffset=t,this.dead=!1},n.prototype.setTileInfo=function(e,t,n){this.tileInfo=e,this.scaleX=t,this.scaleY=n},n.prototype.setTrailInfo=function(e,t,n){this.trailInfo=e,this.trailScaleX=t,this.trailScaleY=n,this.trailOffsetX=this.trailScaleX*this.trailInfo.tiles[0][0],this.trailOffsetY=1-this.trailScaleY*(this.trailInfo.tiles[0][1]+1)},n.prototype.selectAnimationFrame=function(){this.tileIndex=Math.floor(this.tileInfo.tiles.length*this.progress*this.loopcount)%this.tileInfo.tiles.length},n.prototype.updateAtlasOffsets=function(){this.tileInfo.tiles.length>1&&this.selectAnimationFrame(),this.offsetX=this.scaleX*this.tileInfo.tiles[this.tileIndex][0],this.offsetY=1-this.scaleY*(this.tileInfo.tiles[this.tileIndex][1]+1)},n.prototype.setDataUsage=function(){},n.prototype.getInterpolatedInCurveAboveIndex=function(e,t,n){return t[n][1]+(e-t[n][0])/(t[n+1][0]-t[n][0])*(t[n+1][1]-t[n][1])},n.prototype.valueFromCurve=function(e,t){for(var n=0;n<t.length;n++){if(!t[n+1])return 0;if(t[n+1][0]>e)return this.getInterpolatedInCurveAboveIndex(e,t,n)}return 0},n.prototype.applyParticleCurves=function(e){this.size+=this.growthFactor*this.valueFromCurve(this.progress,this.growth)*e,this.rotation+=this.spinspeed*this.valueFromCurve(this.progress,this.spin)*e,this.color.data[3]=this.opacity*this.valueFromCurve(this.progress,this.alpha),this.colorBlend=this.valueFromCurve(this.progress,this.colorCurve),this.color.data[0]=this.color0.data[0]*this.colorBlend+this.color1.data[0]*(1-this.colorBlend),this.color.data[1]=this.color0.data[1]*this.colorBlend+this.color1.data[1]*(1-this.colorBlend),this.color.data[2]=this.color0.data[2]*this.colorBlend+this.color1.data[2]*(1-this.colorBlend)},n.prototype.defaultParticleUpdate=function(e){this.progress=1-(this.lifeSpan-this.frameOffset*.016)/this.lifeSpanTotal,this.applyParticleCurves(e),this.velocity.muld(this.acceleration,this.acceleration,this.acceleration),this.velocity.add_d(this.upVector.x*this.gravity*e,this.upVector.y*this.gravity*e,this.upVector.z*this.gravity*e),this.calcVec.set(this.velocity),this.calcVec.muld(e,e,e),this.position.addv(this.calcVec)},n.prototype.killParticle=function(){this.requestKill=!0},n}),define("particle_system/simulation/SimulationParameters",[],function(){var e={zeroToOne:[[0,0],[1,1]],oneToZero:[[0,1],[1,0]],quickFadeOut:[[0,1],[.9,1],[1,0]],quickFadeIn:[[0,0],[.2,1],[1,1]],centerStep:[[0,0],[.45,0],[.55,1],[1,1]],quickInOut:[[0,0],[.1,1],[.9,1],[1,0]],posToNeg:[[0,1],[1,-1]],negToPos:[[0,-1],[1,1]],zeroOneZero:[[0,0],[.5,1],[1,0]],oneZeroOne:[[0,1],[.5,0],[1,1]],growShrink:[[0,1],[.5,0],[1,-2]]},t=function(e,t,n,r){this.position=e,this.normal=t,this.data=this.configureData(n,r)};return t.prototype.configureData=function(t,n){var r={};for(var i=0;i<t.length;i++){var s;n[t[i].param]?s=n[t[i].param]:s=t[i].value,t[i].type=="curve"&&typeof s=="string"?r[t[i].param]=e[s]:r[t[i].param]=s}return r.effectCount=r.count,r},t}),define("particle_system/defaults/DefaultSimulationParams",{id:"defaultConfig",particle_params:[{param:"color0",value:[.4,.7,1,1],type:"color"},{param:"color1",value:[.8,.2,0,1],type:"color"},{param:"colorCurve",value:"oneToZero",type:"curve",values:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","growShrink"],texts:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","growShrink"]},{param:"colorRandom",value:0,type:"number"},{param:"count",value:25,type:"number",min:1,max:200},{param:"opacity",value:[.6,1],type:"range",min:0,max:1},{param:"alpha",value:"oneToZero",type:"curve",values:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","growShrink"],texts:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","growShrink"]},{param:"size",value:[.01,.1],type:"range",min:0,max:10},{param:"growthFactor",value:[.02,.6],type:"range",min:0,max:10},{param:"growth",value:"posToNeg",type:"curve",values:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","posToNeg","negToPos","growShrink"],texts:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","posToNeg","negToPos","growShrink"]},{param:"stretch",value:0,type:"number",min:0,max:1},{param:"strength",value:0,type:"number",min:0,max:100},{param:"spread",value:.94,type:"number",min:0,max:1},{param:"acceleration",value:.98,type:"number",min:0,max:5},{param:"gravity",value:0,type:"number",min:-20,max:20},{param:"rotation",value:[0,6.29],type:"range",min:0,max:6.29},{param:"spin",value:"posToNeg",type:"curve",values:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","posToNeg","negToPos","growShrink"],texts:["zeroToOne","oneToZero","zeroOneZero","oneZeroOne","posToNeg","negToPos","growShrink"]},{param:"spinspeed",value:[-15,15],type:"range",min:-40,max:40},{param:"lifespan",value:[.01,4],type:"range",min:0,max:25},{param:"sprite",value:"dot_seq",type:"option",values:["dot","dot_seq","spark_seq","trail_dot","flaredot","sparks"],texts:["dot","dot_seq","spark_seq","trail_dot","flaredot","sparks"]},{param:"loopcount",value:5,type:"number",min:1,max:100},{param:"trailsprite",value:"tail",type:"option",values:["dot","tail","bluetrails","wave","waves","dot_seq","spark_seq","trail_dot","flaredot","sparks"],texts:["dot","tail","bluetrails","wave","waves","dot_seq","spark_seq","trail_dot","flaredot","sparks"]},{param:"trailwidth",value:.2,type:"number",min:0,max:10}]}),define("particle_system/simulation/ParticleSimulation",["goo/math/Vector3","particle_system/simulation/SimulationParameters","particle_system/defaults/DefaultSimulationParams"],function(e,t,n){var r=function(){this.resetSimulation()};return r.prototype.resetSimulation=function(){this.renderers=[],this.particles=[],this.recover=[],this.active=!1,this.onUpdate=null,this.particleUpdate=null,this.onParticleAdded=null,this.onParticleDead=null},r.prototype.initSimulation=function(r,i,s,o){this.resetSimulation(),this.params=new t(new e(r),new e(i),n.particle_params,o),this.active=!0},r.prototype.registerEffectCallbacks=function(e){e.onUpdate&&(this.onUpdate=e.onUpdate),e.particleUpdate&&(this.particleUpdate=e.particleUpdate),e.onParticleAdded&&(this.onParticleAdded=e.onParticleAdded),e.onParticleDead&&(this.onParticleDead=e.onParticleDead)},r.prototype.registerParticleRenderer=function(e){this.renderers.push(e)},r.prototype.attachSpawnBehaviour=function(e,t){this.behaviors[e]=createSpawner(t)},r.prototype.notifyDied=function(e){e.reset();for(var t=0;t<this.renderers.length;t++)this.renderers[t].died(e);this.onParticleDead&&this.onParticleDead(e),this.recover.push(e)},r.prototype.includeParticle=function(e,t){e.joinSimulation(this.params,t),this.particles.push(e),this.onParticleAdded&&this.onParticleAdded(e)},r.prototype.updateParticle=function(e,t){if(e.dead)return;var n=t;e.frameCount||(n=.016),e.lifeSpan-=n,this.particleUpdate?this.particleUpdate(e,n):e.defaultParticleUpdate(n);if(e.lifeSpan<0||e.requestKill){this.notifyDied(e);return}this.renderParticle(t,e)},r.prototype.updateSimParticles=function(e){this.onUpdate&&this.onUpdate(this);for(var t=0;t<this.particles.length;t++)this.updateParticle(this.particles[t],e)},r.prototype.renderParticle=function(e,t){for(var n=0;n<this.renderers.length;n++)typeof this.renderers[n].updateParticle=="function"&&this.renderers[n].updateParticle(e,t)},r}),define("particle_system/render/ParticleRenderer",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Material","goo/entities/components/MeshRendererComponent"],function(e,t,n,r){function i(){this.settings=null,this.entity=null,this.meshData=null,this.sprites={}}i.prototype.init=function(t,i,o,u,a){this.settings=o,this.atlasConf=u;for(var f=0;f<this.atlasConf.sprites.length;f++)this.sprites[this.atlasConf.sprites[f].id]=this.atlasConf.sprites[f];var l=e.defaultMap([e.POSITION,e.COLOR]);l.DATA=e.createAttribute(2,"Float"),l.OFFSET=e.createAttribute(2,"Float"),l.TILE=e.createAttribute(4,"Float");var c=new e(l,i.poolCount*4,i.poolCount*6);c.vertexData.setDataUsage("DynamicDraw"),this.meshData=c;var h=new n(s);h.uniforms.alphakill=i.alphakill.value,h.blendState.blending=i.blending.value,h.depthState.write=!1,h.renderQueue=3010;var p=this.entity=t.world.createEntity(c);p.set(new r(h)),p.name="ParticleRenderer",p.meshRendererComponent.cullMode="Never",p.addToWorld(),h.setTexture("PARTICLE_MAP",a);var d=this.meshData.getAttributeBuffer("OFFSET"),v=this.meshData.getAttributeBuffer("TILE"),m=this.meshData.getIndexBuffer();for(f=0;f<i.poolCount;f++){d[8*f+0]=-1,d[8*f+1]=-1,d[8*f+2]=-1,d[8*f+3]=1,d[8*f+4]=1,d[8*f+5]=1,d[8*f+6]=1,d[8*f+7]=-1;for(var g=0;g<4;g++)v[16*f+g*4+0]=0,v[16*f+g*4+1]=0,v[16*f+g*4+2]=1,v[16*f+g*4+3]=1;m[6*f+0]=4*f+0,m[6*f+1]=4*f+3,m[6*f+2]=4*f+1,m[6*f+3]=4*f+1,m[6*f+4]=4*f+3,m[6*f+5]=4*f+2}},i.prototype.rebuild=function(){this.settings.textureUrl.valueLoaded&&this.entity.meshRendererComponent.materials[0].setTexture("PARTICLE_MAP",this.settings.textureUrl.valueLoaded)},i.prototype.remove=function(){this.entity.removeFromWorld()},i.prototype.setVisible=function(e){this.entity.meshRendererComponent.hidden=!e,this.entity.hidden=!e},i.prototype.died=function(e){var t=this.meshData.getAttributeBuffer("DATA");for(var n=0;n<4;n++)t[8*e.index+0+2*n]=0},i.prototype.initFrame=function(){this.pos=this.meshData.getAttributeBuffer(e.POSITION),this.col=this.meshData.getAttributeBuffer(e.COLOR),this.data=this.meshData.getAttributeBuffer("DATA"),this.tile=this.meshData.getAttributeBuffer("TILE"),this.tileInfo=this.settings.tile,this.tileCountX=this.atlasConf.textureUrl.tilesX,this.tileCountY=this.atlasConf.textureUrl.tilesY,this.loopScale=1,this.scaleX=1/this.tileCountX,this.scaleY=1/this.tileCountY,this.lastAlive=0},i.prototype.updateParticleBufferData=function(e,t){var n,r,i;r=this.renderedCount,t.setTileInfo(this.sprites[t.sprite],this.scaleX,this.scaleY),t.updateAtlasOffsets(this.loopScale);for(n=0;n<4;n++)this.tile[16*r+0+4*n]=t.offsetX,this.tile[16*r+1+4*n]=t.offsetY,this.tile[16*r+2+4*n]=t.scaleX,this.tile[16*r+3+4*n]=t.scaleY;var s=t.position.data,o=t.color.data;for(n=0;n<4;n++)this.pos[12*r+0+3*n]=s[0],this.pos[12*r+1+3*n]=s[1],this.pos[12*r+2+3*n]=s[2],this.col[16*r+0+4*n]=o[0],this.col[16*r+1+4*n]=o[1],this.col[16*r+2+4*n]=o[2],this.col[16*r+3+4*n]=o[3],this.data[8*r+0+2*n]=t.size,this.data[8*r+1+2*n]=t.rotation;this.lastAlive=r+1},i.prototype.updateParticle=function(e,t){this.renderedCount||this.initFrame(),this.renderedCount++;if(t.dead)return;this.updateParticleBufferData(e,t)},i.prototype.updateMeshdata=function(){if(this.entity.hidden)return;this.meshData.indexLengths=[this.lastAlive*6],this.meshData.indexCount=this.lastAlive*6,this.renderedCount=0,this.meshData.setVertexDataUpdated()};var s={processors:[function(e,t){e.defines.BILLBOARD_TYPE=t.xxx||1}],defines:{SPIN:!0,BILLBOARD_TYPE:0},attributes:{vertexPosition:e.POSITION,vertexColor:e.COLOR,vertexData:"DATA",vertexOffset:"OFFSET",textureTile:"TILE"},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,particleMap:"PARTICLE_MAP",cameraPosition:t.CAMERA,alphakill:0,upVec:[0,0,1],dirVec:[0,1,0]},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","attribute vec2 vertexData;","attribute vec2 vertexOffset;","attribute vec4 textureTile;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","#if BILLBOARD_TYPE == 1","uniform vec3 cameraPosition;","#elif BILLBOARD_TYPE == 2","uniform vec3 upVec;","uniform vec3 dirVec;","#endif","varying vec4 color;","varying vec2 coords;","void main(void) {","color = vertexColor;","coords = (vertexOffset * 0.5 + 0.5) * textureTile.zw + textureTile.xy;","#ifdef SPIN","float rotation = vertexData.y;","float c = cos(rotation); float s = sin(rotation);","mat3 spinMatrix = mat3(c, s, 0.0, -s, c, 0.0, 0.0, 0.0, 1.0);","vec2 offset = (spinMatrix * vec3(vertexOffset, 1.0)).xy * vertexData.x;","#else","vec2 offset = vertexOffset * vertexData.x;","#endif","#if BILLBOARD_TYPE == 0","gl_Position = viewMatrix * worldMatrix * vec4(vertexPosition.xyz, 1.0);","gl_Position.xy += offset;","#elif BILLBOARD_TYPE == 1","vec3 worldPos = (worldMatrix * vec4(vertexPosition.xyz, 1.0)).xyz;","vec3 dirVec = cameraPosition - worldPos;","dirVec.y = 0.0;","dirVec = normalize(dirVec);","vec3 upVec = vec3(0.0, 1.0, 0.0);","vec3 leftVec = cross(upVec, dirVec) * offset.x;","gl_Position = viewMatrix * vec4(worldPos + leftVec + upVec * offset.y, 1.0);","#elif BILLBOARD_TYPE == 2","vec3 worldPos = (worldMatrix * vec4(vertexPosition.xyz, 1.0)).xyz;","vec3 leftVec = cross(upVec, dirVec) * offset.x;","gl_Position = viewMatrix * vec4(worldPos + leftVec + upVec * offset.y, 1.0);","#endif","gl_Position = projectionMatrix * gl_Position;","}"].join("\n"),fshader:["uniform sampler2D particleMap;","uniform float alphakill;","varying vec4 color;","varying vec2 coords;","void main(void)","{","vec4 col = color * texture2D(particleMap, coords);","if (col.a <= alphakill) discard;","gl_FragColor = col;","}"].join("\n")};return i}),define("particle_system/render/TrailRenderer",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Material","goo/math/Vector3","goo/entities/components/MeshRendererComponent","goo/renderer/Renderer"],function(e,t,n,r,i,s){function o(){this.settings=null,this.entity=null,this.meshData=null,this.segmentCount=0,this.sprites={},this.trailDatas=[],this.facingMode="Billboard",this.updateMode="Interpolate"}function u(e){this.isReset=!0,this.width=1,this.invalid=!0,this.throttle=10,this.trailSegmentDatas=[];for(var t=e-1;t>=0;t--)this.trailSegmentDatas.push(new a)}function a(){this.position=new r,this.tangent=new r,this.interpolatedPosition=new r}function f(e,t){return Math.random()*(t-e)+e}o.prototype.init=function(t,r,s,o,a){this.settings=s,this.atlasConf=o;for(var f=0;f<this.atlasConf.sprites.length;f++)this.sprites[this.atlasConf.sprites[f].id]=this.atlasConf.sprites[f];this.scaleX=1/this.atlasConf.textureUrl.tilesX,this.scaleY=1/this.atlasConf.textureUrl.tilesY,this.segmentCount=s.segmentCount||8,s.poolCount=r.poolCount;var l=e.defaultMap([e.POSITION,e.TEXCOORD0,e.COLOR]);l.TILE=e.createAttribute(4,"Float");var c=new e(l,s.poolCount*this.segmentCount*2,s.poolCount*(this.segmentCount-1)*6);c.vertexData.setDataUsage("DynamicDraw"),this.meshData=c;var p=new n(h);p.uniforms.alphakill=r.alphakill.value,p.blendState.blending=r.blending.value,p.cullState.enabled=!1,p.depthState.write=!1,p.renderQueue=s.renderqueue!==undefined?s.renderqueue:3010;var d=this.entity=t.world.createEntity(c);d.set(new i(p)),d.name="TrailRenderer",d.meshRendererComponent.cullMode="Never",d.addToWorld(),p.setTexture("PARTICLE_MAP",a);var v=this.meshData.getAttributeBuffer(e.COLOR),m=this.meshData.getAttributeBuffer(e.TEXCOORD0),g=this.meshData.getAttributeBuffer("TILE"),y=this.meshData.getIndexBuffer();for(var f=0;f<s.poolCount;f++){var b=new u(this.segmentCount);b.width=this.settings.width.value,this.trailDatas.push(b);for(var w=0;w<this.segmentCount;w++)g[this.segmentCount*8*f+w*8+0]=0,g[this.segmentCount*8*f+w*8+1]=0,g[this.segmentCount*8*f+w*8+2]=1,g[this.segmentCount*8*f+w*8+3]=1,g[this.segmentCount*8*f+w*8+4]=0,g[this.segmentCount*8*f+w*8+5]=0,g[this.segmentCount*8*f+w*8+6]=1,g[this.segmentCount*8*f+w*8+7]=1,v[this.segmentCount*8*f+w*8+0]=1,v[this.segmentCount*8*f+w*8+1]=1,v[this.segmentCount*8*f+w*8+2]=1,v[this.segmentCount*8*f+w*8+3]=1,v[this.segmentCount*8*f+w*8+4]=1,v[this.segmentCount*8*f+w*8+5]=1,v[this.segmentCount*8*f+w*8+6]=1,v[this.segmentCount*8*f+w*8+7]=1,m[this.segmentCount*4*f+w*4+0]=w/this.segmentCount,m[this.segmentCount*4*f+w*4+1]=0,m[this.segmentCount*4*f+w*4+2]=w/this.segmentCount,m[this.segmentCount*4*f+w*4+3]=1;var E=this.segmentCount-1;for(var w=0;w<E;w++)y[E*6*f+w*6+0]=this.segmentCount*2*f+w*2+0,y[E*6*f+w*6+1]=this.segmentCount*2*f+w*2+1,y[E*6*f+w*6+2]=this.segmentCount*2*f+w*2+2,y[E*6*f+w*6+3]=this.segmentCount*2*f+w*2+2,y[E*6*f+w*6+4]=this.segmentCount*2*f+w*2+1,y[E*6*f+w*6+5]=this.segmentCount*2*f+w*2+3}},o.prototype.setTrailFront=function(e,t,n,r){var i=null;if(e.isReset){for(var s=0;s<this.segmentCount;s++){var o=e.trailSegmentDatas[s];o.position.setv(t)}e.isReset=!1}var u=e.trailSegmentDatas;e.throttle+=r*this.settings.updateSpeed.value,e.throttle>1?(e.throttle%=1,i=u.splice(u.length-1,1)[0],u.splice(0,0,i)):i=u[0],i.position.setv(t),n!=null&&i.tangent.setv(n),e.invalid=!0},o.prototype.updateTrail=function(e,t,n,r){if(e.invalid||this.facingMode=="Billboard")this.updateInterpolate(e,t,n,r),e.invalid=!1};var l=new r,c=new r;o.prototype.updateBillboard=function(e,t,n,r,i,s){e===0?l.setv(n[e+1].interpolatedPosition).subv(r):e===this.segmentCount-1?l.setv(r).subv(n[e-1].interpolatedPosition):l.setv(n[e+1].interpolatedPosition).subv(n[e-1].interpolatedPosition),c.setv(r).subv(i);var o=l.data,u=c.data,a=u[2]*o[1]-u[1]*o[2],f=u[0]*o[2]-u[2]*o[0],h=u[1]*o[0]-u[0]*o[1],p=Math.sqrt(a*a+f*f+h*h);p<1e-7?(a=0,f=0,h=0):(p=1/p,a*=p*s,f*=p*s,h*=p*s),l.data[0]=a,l.data[1]=f,l.data[2]=h},o.prototype.updateTrailDirection=function(e,t,n,r,i,s){this.facingMode=="Billboard"?this.updateBillboard(e,t,n,r,i,s):t.tangent!==null?l.setv(t.tangent).muld(s,s,s):l.setd(s,0,0)},o.prototype.updateInterpolationVectors=function(e,t,n){var r=t[e],i=r.interpolatedPosition;i.setv(r.position),e>0&&i.lerp(t[e-1].position,n.throttle)},o.prototype.updateBufferData=function(e,t,n,r,i,s,o,u){n[e*this.segmentCount*8+t*8+0]=u.trailOffsetX,n[e*this.segmentCount*8+t*8+1]=u.trailOffsetY,n[e*this.segmentCount*8+t*8+2]=this.scaleX,n[e*this.segmentCount*8+t*8+3]=this.scaleY,n[e*this.segmentCount*8+t*8+4]=u.trailOffsetX,n[e*this.segmentCount*8+t*8+5]=u.trailOffsetY,n[e*this.segmentCount*8+t*8+6]=this.scaleX,n[e*this.segmentCount*8+t*8+7]=this.scaleY,r[e*this.segmentCount*6+6*t+0]=s.data[0]-l.data[0],r[e*this.segmentCount*6+6*t+1]=s.data[1]-l.data[1],r[e*this.segmentCount*6+6*t+2]=s.data[2]-l.data[2],r[e*this.segmentCount*6+6*t+3]=s.data[0]+l.data[0],r[e*this.segmentCount*6+6*t+4]=s.data[1]+l.data[1],r[e*this.segmentCount*6+6*t+5]=s.data[2]+l.data[2],i[e*this.segmentCount*8+8*t+0]=o[0],i[e*this.segmentCount*8+8*t+1]=o[1],i[e*this.segmentCount*8+8*t+2]=o[2],i[e*this.segmentCount*8+8*t+4]=o[0],i[e*this.segmentCount*8+8*t+5]=o[1],i[e*this.segmentCount*8+8*t+6]=o[2];var a=u.color.data[3]*(this.segmentCount-t)/this.segmentCount;i[e*this.segmentCount*8+8*t+3]=a,i[e*this.segmentCount*8+8*t+7]=a},o.prototype.updateInterpolate=function(t,n,r,i){var s=t.trailSegmentDatas;n.setTrailInfo(this.sprites[n.trailSprite],this.scaleX,this.scaleY);var o=this.meshData.getAttributeBuffer(e.POSITION),u=this.meshData.getAttributeBuffer(e.COLOR),a=this.meshData.getAttributeBuffer("TILE"),f=n.color.data,l=n.size*n.trailWidth;for(var c=0;c<this.segmentCount;c++)this.updateInterpolationVectors(c,s,t);for(var c=0;c<this.segmentCount;c++){var h=s[c],p=h.interpolatedPosition;this.updateTrailDirection(c,h,s,p,r,l),this.updateBufferData(i,c,a,o,u,p,f,n)}},o.prototype.rebuild=function(){this.settings.textureUrl.valueLoaded&&this.entity.meshRendererComponent.materials[0].setTexture("PARTICLE_MAP",this.settings.textureUrl.valueLoaded);for(var e=0;e<this.trailDatas.length;e++){var t=this.trailDatas[e];t.width=this.settings.width.value}},o.prototype.remove=function(){this.entity.removeFromWorld()},o.prototype.setVisible=function(e){this.entity.meshRendererComponent.hidden=!e,this.entity.hidden=!e},o.prototype.died=function(e){var t=this.trailDatas[e.index];t.isReset=!0},o.prototype.updateParticle=function(e,t){this.renderedCount++;if(t.dead)return;var n=this.trailDatas[t.index];this.setTrailFront(n,t.position,null,e),this.updateTrail(n,t,s.mainCamera.translation,this.renderedCount),this.lastAlive=this.renderedCount+1},o.prototype.updateMeshdata=function(){if(this.entity.hidden)return;this.meshData.indexLengths=[this.lastAlive*(this.segmentCount-1)*6],this.meshData.indexCount=this.lastAlive*(this.segmentCount-1)*6,this.meshData.setVertexDataUpdated(),this.lastAlive=0,this.renderedCount=0};var h={attributes:{vertexPosition:e.POSITION,vertexColor:e.COLOR,vertexCoords:e.TEXCOORD0,textureTile:"TILE"},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,particleMap:"PARTICLE_MAP",cameraPosition:t.CAMERA,time:t.TIME,alphakill:0},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","attribute vec2 vertexCoords;","attribute vec4 textureTile;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float time;","varying vec4 color;","varying vec2 coords;","void main(void) {","color = vertexColor;","coords = vertexCoords * textureTile.zw + textureTile.xy;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition.xyz, 1.0);","}"].join("\n"),fshader:["uniform sampler2D particleMap;","uniform float alphakill;","varying vec4 color;","varying vec2 coords;","void main(void)","{","vec4 col = color * texture2D(particleMap, coords);","if (col.a <= alphakill) discard;","gl_FragColor = col;","}"].join("\n")};return o}),define("particle_system/simulation/ParticleSimulator",["particle_system/simulation/Particle","particle_system/simulation/ParticleSimulation","particle_system/render/ParticleRenderer","particle_system/render/TrailRenderer"],function(e,t,n,r){function i(e){if(e==="ParticleRenderer")return new n;if(e==="TrailRenderer")return new r}function s(t,n,r,i,s){this.goo=t,this.settings=n,this.rendererConfigs=r,this.rendererSettings={},this.meshPositions=[],this.simulations=[],this.totalPool=this.settings.poolCount,this.particles=[],this.availableParticles=[];for(var o=0;o<this.totalPool;o++)this.availableParticles[o]=new e(o);this.setup=n.setup,this.behaviors=[],this.renderers=[],n.renderers=n.renderers||[];for(o=0;o<this.rendererConfigs.renderers.length;o++)this.rendererSettings[this.rendererConfigs.renderers[o].id]=this.rendererConfigs.renderers[o];for(o=0;o<n.renderers.length;o++)this.initRenderer(n.renderers[o],i,s);this.setVisible(!0)}s.prototype.getAvailableSimulation=function(){for(var e=0;e<this.simulations.length;e++)if(!this.simulations[e].active)return this.simulations[e];var n=new t;return this.simulations.push(n),n},s.prototype.addEffectSimulation=function(e,t,n,r){var i=this.getAvailableSimulation();if(this.availableParticles.length-1<=0){console.error("Pool exhausted:",this.settings.id);return}i.initSimulation(e,t,this.settings.simulation_params,n),this.includeSimulation(i,r)},s.prototype.initRenderer=function(e,t,n){var r=this.rendererSettings[e],s=i(r.script);s.topSettings=this.settings,s.globalSettings=r,this.renderers.push(s),s.init&&s.init(this.goo,this.settings,r.settings,t,n)},s.prototype.remove=function(){for(var e=0;e<this.renderers.length;e++)this.renderers[e].remove&&this.renderers[e].remove()},s.prototype.setVisible=function(e){for(var t=0;t<this.renderers.length;t++)this.renderers[t].setVisible&&this.renderers[t].setVisible(e);this.visible=e},s.prototype.includeSimulation=function(e,t){t&&e.registerEffectCallbacks(t);for(var n=0;n<this.renderers.length;n++)e.registerParticleRenderer(this.renderers[n]);var r=e.params.data,i=Math.ceil(r.count*(this.availableParticles.length-1)/this.totalPool);for(n=0;n<i;n++){var s=this.availableParticles.pop();if(!s){console.log("");return}var o=1-(r.count-n)/r.count;e.includeParticle(s,o)}};var o;return s.prototype.recoverSimulation=function(e){for(var t=0;t<e.particles.length;t++){var n=e.particles[t];this.availableParticles.push(n)}if(e.particles.length!=e.recover.length){console.error("count missmatch",e);return}e.resetSimulation()},s.prototype.updateSimulation=function(e,t){if(!t.active)return;t.updateSimParticles(e),t.particles.length==t.recover.length&&this.recoverSimulation(t)},s.prototype.update=function(e){if(!this.visible)return;for(o=0;o<this.simulations.length;o++)this.updateSimulation(e,this.simulations[o]);for(o=0;o<this.renderers.length;o++)typeof this.renderers[o].updateMeshdata=="function"&&this.renderers[o].updateMeshdata()},s}),define("particle_system/ParticleSystem",["particle_system/simulation/ParticleSimulator"],function(e){function t(e){this.goo=e,this.atlases={},this.simData={},this.simulators={},this.groups={}}return t.prototype.addConfiguredAtlasSystems=function(t,n,r,i){for(var s=0;s<t.simulators.length;s++){var o=t.simulators[s],u=new e(this.goo,o,n,r,i);this.simulators[o.id]=u}},t.prototype.spawnParticleSimulation=function(e,t,n,r,i){this.simulators[e].addEffectSimulation(t,n,r,i)},t.prototype.get=function(e){return this.simulators[e]},t.prototype.removeParticleSystemId=function(e){this.simulators[e]&&(this.simulators[e].remove(),delete this.simulators[e])},t.prototype.remove=function(e){if(!e)for(var t in this.simulators)this.removeParticleSystemId(t);else this.removeParticleSystemId(e)},t.prototype.wakeParticle=function(e){var t=this.simulators[e];if(t)return t.wakeParticle()},t.prototype.setVisible=function(e,t){var n=this.simulators[e];if(n)return n.setVisible(t)},t.prototype.update=function(e){var t="";for(var n in this.simulators){var r=this.simulators[n];r.update(e),t+=n+" = "+r.aliveParticles+"<br>"}},t}),define("particle_system/ParticlesAPI",["particle_system/ParticleSystem"],function(e){var t=function(t){this.particleSystem=new e(t)};return t.prototype.setEnabled=function(e){this.enabled=e},t.prototype.requestFrameUpdate=function(e){this.particleSystem.update(e)},t.prototype.spawnParticles=function(e,t,n,r,i){this.particleSystem.spawnParticleSimulation(e,t,n,r,i)},t.prototype.createParticleSystems=function(e,t,n,r){this.particleSystem.addConfiguredAtlasSystems(e,t,n,r)},t.prototype.removeParticleSystem=function(e){this.particleSystem.remove(e)},t.prototype.cleanupParticleSystems=function(){this.particleSystem.remove()},t}),define("particle_system/defaults/ExampleEffects",{effects:[{id:"firework_blue",effect_data:{color0:[.6,1,1],color1:[0,.7,1],colorRandom:.4,colorCurve:[[0,1],[.05,.6],[.3,1],[.45,.4],[.6,1],[.75,.3],[.9,1],[1,0]],count:40,opacity:[.4,1],alpha:[[0,1],[.3,1],[1,0]],size:[.05,.12],growthFactor:[.01,.7],growth:[[0,-1],[.05,1],[.3,2],[.45,-2],[.6,1],[.75,-1],[.9,1],[1,0]],stretch:1,strength:12,spread:.6,acceleration:.97,gravity:-9,rotation:[0,7],spin:"oneToZero",spinspeed:[-15,15],lifespan:[1,3],sprite:"dot_seq",loopcount:15,trailsprite:"tail",trailwidth:.3}},{id:"firework_red",effect_data:{color0:[1,.8,.3],color1:[1,0,.1],colorRandom:.4,colorCurve:[[0,0],[.15,1],[.2,.7],[.3,0],[.45,.5],[.6,0],[.75,.5],[1,0]],count:30,opacity:[.99,1],alpha:"oneToZero",size:[.02,.2],growthFactor:[.01,.7],growth:"posToNeg",stretch:1e-4,strength:22,spread:1,acceleration:.97,gravity:-9,rotation:[0,7],spin:"oneToZero",spinspeed:[0,1],lifespan:[1,2],sprite:"fielddot",loopcount:1,trailsprite:"wave",trailwidth:.8}},{id:"firework_green",effect_data:{color0:[.4,1,.4],colorRandom:.4,count:30,opacity:[.4,1],alpha:"oneToZero",size:[.02,.2],growthFactor:[.01,.7],growth:"posToNeg",stretch:1e-4,strength:22,spread:.95,acceleration:.97,gravity:-9,rotation:[0,7],spin:"oneToZero",spinspeed:[25,45],lifespan:[1,2],sprite:"sinedot",loopcount:15,trailsprite:"tail",trailwidth:.3}},{id:"firework_cone_yellow",effect_data:{color0:[1,1,0],color1:[.8,.5,.6],colorCurve:[[0,0],[.15,1],[.2,.7],[.3,0],[.45,.5],[.6,0],[.75,.5],[1,0]],colorRandom:.6,count:15,opacity:[.7,1],alpha:"oneToZero",size:[.32,.6],growthFactor:[-0.01,-0.7],growth:"oneToZero",stretch:1e-4,strength:26,spread:.7,acceleration:.997,gravity:-7,rotation:[0,7],spin:"zeroToOne",spinspeed:[-15,-55],lifespan:[.4,2],sprite:"spinfield",loopcount:15,trailsprite:"tail",trailwidth:.2}},{id:"tail_orange",effect_data:{color0:[1,.4,.2],color1:[1,.4,.2],colorCurve:[[0,1],[1,1]],colorRandom:0,count:1,opacity:[.7,1],alpha:"oneToZero",size:[.12,.3],growthFactor:[1.01,.7],growth:"posToNeg",stretch:1e-4,strength:0,spread:.7,acceleration:.997,gravity:0,rotation:[0,7],spin:"posToNeg",spinspeed:[-45,45],lifespan:[2,2],sprite:"flaredot",loopcount:15,trailsprite:"tail",trailwidth:1}}]}),define("particle_system/defaults/DefaultRendererConfigs",{renderers:[{id:"ParticleRenderer",script:"ParticleRenderer",settings:{}},{id:"FastTrailRenderer",script:"TrailRenderer",settings:{segmentCount:3,width:{value:1,type:"number"},updateSpeed:{value:15,type:"number"}}},{id:"TrailRenderer",script:"TrailRenderer",settings:{segmentCount:5,width:{value:1,type:"number"},updateSpeed:{value:5,type:"number"}}},{id:"LineRenderer",script:"LineRenderer",settings:{width:{value:.1,type:"number",step:.01,decimals:2},distance:{value:.2,type:"number",step:.1},limit:{value:3,type:"number",step:1,decimals:0}}},{id:"TriangleRenderer",script:"TriangleRenderer",settings:{distance:{value:.2,type:"number"}}}]}),define("particle_system/defaults/DefaultSpriteAtlas",{atlases:[{id:"defaultSpriteAtlas",textureUrl:{value:"./configs/gui/images/bin/test/particle_atlas.png",type:"texture",tilesX:8,tilesY:8},sprites:[{id:"0_0",tiles:[[0,0]]},{id:"0_1",tiles:[[0,1]]},{id:"0_2",tiles:[[0,2]]},{id:"0_3",tiles:[[0,3]]},{id:"0_4",tiles:[[0,4]]},{id:"0_5",tiles:[[0,5]]},{id:"0_6",tiles:[[0,6]]},{id:"0_7",tiles:[[0,7]]},{id:"1_0",tiles:[[1,0]]},{id:"1_1",tiles:[[1,1]]},{id:"1_2",tiles:[[1,2]]},{id:"1_3",tiles:[[1,3]]},{id:"1_4",tiles:[[1,4]]},{id:"1_5",tiles:[[1,5]]},{id:"1_6",tiles:[[1,6]]},{id:"1_7",tiles:[[1,7]]},{id:"dot",tiles:[[2,4]]},{id:"shockwave",tiles:[[0,0]]},{id:"tail",tiles:[[0,5]]},{id:"bluetrails",tiles:[[2,2]]},{id:"waves",tiles:[[0,7]]},{id:"wave",tiles:[[0,6]]},{id:"sparks",tiles:[[3,0]]},{id:"dot_seq",tiles:[[0,4],[2,4],[1,4],[3,4],[2,4],[4,4]]},{id:"spark_seq",tiles:[[0,3],[1,3],[2,3],[1,3]]},{id:"trail_dot",tiles:[[2,2],[3,2],[4,1],[5,2],[6,0],[7,2],[8,1]]},{id:"flaredot",tiles:[[4,0]]},{id:"fielddot",tiles:[[1,2]]},{id:"spinfield",tiles:[[3,1]]},{id:"sinedot",tiles:[[5,1]]},{id:"projectile_1",tiles:[[7,2]]},{id:"splash_thick",tiles:[[1,0]]},{id:"splash_thin",tiles:[[2,0]]},{id:"smokey",tiles:[[3,0]]},{id:"snow_4",tiles:[[7,7]]},{id:"snow_3",tiles:[[6,7]]},{id:"snow_2",tiles:[[5,7]]},{id:"snow_1",tiles:[[4,7]]}]}]}),define("particle_system/defaults/DefaultSimulators",{simulators:[{id:"AdditiveParticleAndTrail",atlas:"defaultSpriteAtlas",renderers:["ParticleRenderer","TrailRenderer"],poolCount:1e3,blending:{value:"AdditiveBlending",type:"option",values:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"],texts:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"]},alphakill:{value:0,type:"number",min:0,max:1}},{id:"AdditiveParticle",atlas:"defaultSpriteAtlas",renderers:["ParticleRenderer"],poolCount:1e3,blending:{value:"AdditiveBlending",type:"option",values:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"],texts:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"]},alphakill:{value:0,type:"number",min:0,max:1}},{id:"StandardParticle",atlas:"defaultSpriteAtlas",renderers:["ParticleRenderer"],poolCount:2e3,blending:{value:"CustomBlending",type:"option",values:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"],texts:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"]},alphakill:{value:0,type:"number",min:0,max:1}},{id:"FastAdditiveTrail",atlas:"defaultSpriteAtlas",renderers:["FastTrailRenderer"],poolCount:400,blending:{value:"AdditiveBlending",type:"option",values:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"],texts:["AdditiveBlending","SubtractiveBlending","MultiplyBlending","NoBlending","CustomBlending"]},alphakill:{value:0,type:"number",min:0,max:1}}]}),define("3d/effects/SimpleParticles",["particle_system/ParticlesAPI","particle_system/defaults/ExampleEffects","particle_system/defaults/DefaultRendererConfigs","particle_system/defaults/DefaultSpriteAtlas","particle_system/defaults/DefaultSimulators","goo/renderer/TextureCreator","goo/math/Vector3"],function(e,t,n,r,i,s,o){function u(t){this.goo=t,this.particlesAPI=new e(t),this.ready=!1}return u.prototype.createSystems=function(){var e={};for(var t=0;t<r.atlases.length;t++)e[r.atlases[t].id]=r.atlases[t];var o=function(){this.particlesAPI.createParticleSystems(i,n,r.atlases[0],a),this.ready=!0}.bind(this),u=new s,a=u.loadTexture2D(e[r.atlases[0].id].textureUrl.value,{minFilter:"NearestNeighborNoMipMaps",wrapS:"EdgeClamp",wrapT:"EdgeClamp"},function(){o()})},u.prototype.createSystem=function(){},u.prototype.spawn=function(e,t,n,r,i){if(!this.ready)return;this.particlesAPI.spawnParticles(e,t,n,r,i)},u.prototype.update=function(e){this.particlesAPI.requestFrameUpdate(e)},u}),define("3d/effects/EffectPlayer",["goo/math/Vector3","goo/entities/SystemBus","3d/effects/EffectConfigs","3d/effects/MusicPlayer","3d/effects/SoundHandler","3d/effects/SimpleParticles","data_pipeline/PipelineAPI","goo/renderer/Texture"],function(e,t,n,r,i,s,o,u){function y(e,t,n,r){f.createSystems();for(var s in e){var o=e[s].id,u=e[s].particles;l[o]=e[s].sounds}i.registerAudioConfigs(n),r()}function b(){console.log("init effects: ",a,e,r,s);var e=n.effects,r=n.particles,s=n.audio,o=function(){if(v)return;v=!0,t.addListener("playParticles",M),t.addListener("playEffect",_),t.addListener("stopEffect",I),t.addListener("stopAllSounds",O),t.addListener("playMusic",j),t.addListener("stopMusic",F),t.addListener("groundEffect",A),t.addListener("terrainEffect",B);var e=function(e){f.update(e)};c.push(e);var n=function(e,t){i.update(e,t)};c.push(n)};y(e,r,s,o)}function w(e,t){for(var n=0;n<c.length;n++)c[n](e,t)}function S(e){return console.log("Play random from list: ",e),e[Math.floor(Math.random()*e.length)]}function x(e,t,n){if(l[e]===undefined)return;for(var r=0;r<l[e].length;r++)typeof l[e][r]!="string"?i.play(S(l[e][r]),t,n):i.play(l[e][r],t,n)}function T(e){console.log("Stop Effect: ",e);if(l[e]===undefined)return;for(var t=0;t<l[e].length;t++)if(typeof l[e][t]!="string")for(var n=0;n<l[e][t].length;n++)i.stop(l[e][n]);else i.stop(l[e][t])}function N(e,t,n,r){if(l[e]===undefined)return;for(var s=0;s<l[e].length;s++)if(typeof l[e][s]!="string")for(var o=0;o<l[e][s].length;o++)i.updateSound(l[e][o],t,n,r);else i.updateSound(l[e][s],t,n,r)}function C(e,t,n,r,i){f.spawn(e,t,n,r,i)}function k(t){var n=p.terrainHandler.terrainQuery,r=n.getNormalAt(t);r===null&&(r=e.UNIT_Y);var i=r.dot(e.UNIT_Y);return n.getType(t[0],t[2],i,Math.random())}function A(e){var t=k(e.pos);_({effectName:L[t.texture],pos:e.pos,vel:e.vel,effectData:e.effectData})}function O(){i.stopAllLoops()}function M(e){C(e.simulatorId,e.pos,e.vel,e.effectData,e.callbacks)}function _(e){C(e.simulatorId,e.pos,e.vel,e.effectData,e.callbacks)}function D(e){N(e.effectName,e.pos,e.vel,e.effectData)}function B(e){var t=k(e.pos);P.set(e.pos),H.set(0,-3,0),console.log("Terrain FX: ",e),e.effectData.type=="sub"&&(H.data[1]=5);var n=function(t){var n=Math.random()*(Math.random()-.5)*e.effectData.size*t,r=Math.random()*3.15;P.data[0]+=Math.sin(r)*n,P.data[1]+=t*(.5-Math.random()),P.data[2]+=Math.cos(r)*n,_({effectName:"terrain_up",pos:P,vel:H,effectData:null})};n(.5),n(.3)}function j(e){h.playMusic(e.soundName)}function F(e){h.stopMusic(e.soundName)}function I(e){T(e.effectName)}var a,f,l={},c=[],h,p,d={},v=!1,m=window.resourcePath,g=function(e,t){a=e,p=t,h=new r,console.log("Add effect player ",a,n),i.init(a),f=new s(a),E()};g.prototype.initEffectPlayer=function(){var e=function(){f.particlesAPI.enabled||!f.particlesAPI.useWorker?b():setTimeout(function(){e()},100)};e()};var E=function(){a.callbacksPreRender.push(function(e){w(e,a.renderSystem.camera)})},L={"grass.jpg":"grass_puff","road.jpg":"dirt_puff","vertical_stone.jpg":"stone_puff","rock.jpg":"gravel_puff"},P=new e,H=new e;return g}),define("3d/GooEffectController",["application/EventManager","3d/effects/EffectPlayer","goo/entities/EntityUtils","goo/renderer/light/DirectionalLight","goo/math/Vector3","goo/entities/components/ScriptComponent","goo/entities/components/LightComponent","goo/renderer/shaders/ShaderBuilder"],function(e,t,n,r,i,s,o,u){function S(e){a=e,y=new t(a),console.log("SET GOO: ",a)}function x(){y.initEffectPlayer()}function T(e){w.color.setd(e[0]*(1+Math.random()*.03),e[1]*(1+Math.random()*.02),e[2]*(1+Math.random()*.05),1)}function N(e){u.GLOBAL_AMBIENT=e}function C(e){u.FOG_COLOR=e}function k(e,t){L(m*e,g*t)}function L(e,t){u.FOG_SETTINGS=[e,t],u.USE_FOG=!0}function A(e){f.set(-e[2],-e[1],-e[0]),b.transformComponent.transform.lookAt(f,i.UNIT_Y),b.transformComponent.setUpdated()}function M(t){f.set(e.eventArgs(t).pos),f.add(v),b.transformComponent.transform.translation.set(f),b.lightComponent.light.translation.set(f),f.set(e.eventArgs(t).pos),b.transformComponent.transform.lookAt(f,i.UNIT_Y),b.transformComponent.setUpdated()}function _(t,n,r){B()[t].fx[n]=r,e.fireEvent(e.list().ANALYTICS_EVENT,{category:"CONFIG_EFFECT",action:t,labels:JSON.stringify(r),value:0})}function D(t,n,r){I()[t].fx[n]=r,e.fireEvent(e.list().ANALYTICS_EVENT,{category:"CONFIG_OPTION",action:t,labels:JSON.stringify(r),value:0})}function P(t){_(e.eventArgs(t).effect,e.eventArgs(t).parameter,e.eventArgs(t).value)}function H(){return console.log(a.renderSystem.composers),a.renderSystem.composers[0].passes}function B(){return{}}function I(){return{"Fancy Water":{fx:F.water,param:"fancy"},"Lots of Trees":{fx:F.nature,param:"manyTrees"}}}function q(e,t){return F[e][t]}var a,f=new i,l=128,c=3.2,h=25,p=27,d="basic",v=new i(3.5,8,-2.1),m=2e3,g=2e4,y,b,w,E;u.USE_FOG=!0;var O=function(){return b=a.world.createEntity("Light1"),w=new r,w.color.setd(1,.95,.85,1),w.specularIntensity=1.8,w.intensity=1,E=new o(w),E.light.shadowCaster=!1,E.light.shadowSettings.darkness=.9,E.light.shadowSettings.near=c,E.light.shadowSettings.far=p,E.light.shadowSettings.size=h,E.light.shadowSettings.shadowType=d,E.light.shadowSettings.resolution=[l,l],console.log("lightComp ---- ",E),b.setComponent(E),b.transformComponent.transform.translation.setd(0,0,0),b.transformComponent.transform.lookAt(new i(-0.5,-0.4,.43),i.UNIT_Y),b.addToWorld(),b},j=function(){},F={particles:{highDensity:1},bullets:{visible:0},water:{fancy:1},nature:{manyTrees:0}};return e.registerListener(e.list().SET_EFFECT_PARAMETER,P),e.registerListener(e.list().SCENARIO_LOADED,j),{setGoo:S,initFxPlayer:x,getEffects:B,getSettingParam:q,getSettings:I,setSettingParamToValue:D,setEffectParamToValue:_,setSunlightColor:T,setSunlightDirection:A,setAmbientColor:N,setFogColor:C,scaleFogNearFar:k,setupMainLight:O}}),define("game/weapons/Bullet",["game/weapons/WeaponData","game/weapons/FireDamage","game/GameConfiguration","game/ModelDefinitions","application/EventManager","goo/math/Matrix3x3","goo/math/Vector3","goo/entities/SystemBus","game/world/PhysicalWorld","3d/GooEffectController"],function(e,t,n,r,i,s,o,u,a,f){var l=[],c=0,h=function(e,t,n){c+=1;var r=function(t){e.id=t.id,e.entity=t,t.spatial=e.spatial,t.pieceData=e.bulletData,i.fireEvent(i.list().REGISTER_ACTIVE_ENTITY,{entity:e.entity})};i.fireEvent(i.list().ADD_GAME_ENTITY,{entityId:"bullet_"+c,callback:r}),l.push(e)},p=function(e,t,n,r,i,u,a){var f=new s;this.hitVec=new o,this.hitNormal=new o,this.originatorId=u,this.onHitEffects=n.onHitEffects,this.bulletData=n,this.spatial={visualPos:new o(0,0,0),pos:e,rot:f,velocity:new o(t),audioVel:new o([0,1e-6,0])},this.caliber=r.caliber,this.lifetime=r.lifetime,this.age=0,this.lifeTime=n.lifeTime,this.hitCallback=i,h(this,this.caliber,this.visible),this.particles=[];if(n.trailEffects)for(var l=0;l<n.trailEffects.length;l++)this.attachTrailEffect(this.spatial,n.trailEffects[l]);this.removed=!1,this.updatePosition(a)};p.prototype.attachTrailEffect=function(e,t){var n=function(e){this.particles.splice(this.particles.indexOf(e),1)}.bind(this),r=function(e){this.particles.push(e)}.bind(this),i=function(t){t.lifeSpan=this.lifeTime-this.age*3,t.position.setv(e.pos)}.bind(this),s={particleUpdate:i,onParticleAdded:r,onParticleDead:n},o=t.effectData;o.size=[.1+this.caliber*.003,.1+this.caliber*.005],o.lifespan=[this.age,this.age],u.emit("playParticles",{simulatorId:t.simulatorId,pos:this.spatial.pos,vel:this.hitNormal,effectData:o,callbacks:s})},p.prototype.remove=function(){var e=l.indexOf(this);l.splice(e,1),this.lifeTime=0,this.removed=!0,this.delete()},p.prototype.delete=function(){for(var e=0;e<this.particles.length;e++)this.particles[e].killParticle();i.fireEvent(i.list().REMOVE_GAME_ENTITY,{entityId:this.id}),delete this},p.prototype.disappear=function(){this.hitCallback(this.spatial,"nothing"),this.remove()};var d=function(e,n){for(var r in n)r=="fire"&&new t(e.entity,e.part,n[r]),r=="kinetic"&&i.fireEvent(i.list().DAMAGE_ENTITY,{entity:e.entity,damage:n[r].points})};p.prototype.playHitSound=function(e){var t=Math.floor(Math.random()*this.bulletData.onHitSounds.length);i.fireEvent(i.list().ONESHOT_AMBIENT_SOUND,{soundData:i.sound()[this.bulletData.onHitSounds[t]],pos:e.pos,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]})},p.prototype.waterSplash=function(e){var t=Math.ceil(Math.random()*this.caliber*.25),n=[e[0],0,e[2]];this.hitVec.set(e),this.hitNormal.set(0,t,0),i.fireEvent(i.list().SPLASH_WATER,{pos:n,count:4+t,dir:[0,t,0]}),Math.random()<.2*t&&i.fireEvent(i.list().SPLASH_RINGLET,{pos:n,count:1,dir:[0,0,0]}),Math.random()<.05*t&&i.fireEvent(i.list().SPLASH_FOAM,{pos:n,count:1,dir:[0,0,0]})},p.prototype.hit=function(e){this.hitCallback(this.spatial,e);var t=e.pos;if(e.part=="water"){this.waterSplash(t);return}var n=this.spatial.velocity.data;for(var r=0;r<this.onHitEffects.length;r++)u.emit("playParticles",{simulatorId:this.onHitEffects[r].simulatorId,pos:new o(t),vel:o.UNIT_Y,effectData:this.onHitEffects[r].effectData});if(e.entity)for(var r=0;r<this.bulletData.damageEffects.length;r++)d(e,this.bulletData.damageEffects[r]);else a.renderGroundHitEffect(t);this.playHitSound(e)},p.prototype.updatePosition=function(e){this.age+=e;var t=a.checkSpatialConflict(this,e);if(t){this.hit(t),this.remove();return}if(this.spatial.pos.data[1]<=0){this.hitCallback(this.spatial,"water"),this.remove();return}this.hitNormal.set(this.spatial.velocity),this.hitNormal.mul(2);if(this.bulletData.trailEffects)for(var n=0;n<this.bulletData.trailEffects.length;n++){var r={lifespan:.035,intensity:1-this.age/this.lifeTime*(this.age/this.lifeTime),size:30*this.caliber,alphacurve:[[0,1],[1,1]],color0:[.8,.7,.6],color1:[.8,.3,.2],colorRandom:.2};for(var i in this.bulletData.trailEffects[n].effectData)r[i]=this.bulletData.trailEffects[n].effectData[i];r.count&&(r.count*=1-this.age*(this.age*.002+.998)/this.lifeTime)}this.age>this.lifeTime&&this.disappear()};var v=function(e){for(var t=0;t<l.length;t++)l[t].updatePosition(e)},m=function(e){var t=i.eventArgs(e).frameTime;v(t)};return i.registerListener(i.list().UPDATE_ACTIVE_ENTITIES,m),p}),define("game/weapons/PlaneCannon",["goo/entities/SystemBus","game/GameConfiguration","data_pipeline/PipelineAPI","game/weapons/Bullet","application/EventManager","game/GameUtil","goo/math/Vector3"],function(e,t,n,r,i,s,o){var u=function(e,t,n,r){this.planeEntity=e,this.posOffset=n.posOffset,this.attachCannonData(t),this.attachBulletData(r),this.elevation=48,this.currentState=0,this.targetState=0,this.flameEffect=null,this.smokeEffect=null,this.fireSounds={},this.lastBulletVelocity=new o};return u.prototype.attachCannonData=function(e){var t=function(t,n){for(var r=0;r<n.length;r++)if(n[r].id==e){this.name=n[r].name,this.data=n[r],this.cooldownTime=1e3/this.data.rateOfFire;return}console.error("no cannon data for cannonId on turret",e,n,this)}.bind(this);n.subscribeToCategoryKey("game_parts_data","cannons",t)},u.prototype.attachBulletData=function(e){var t=function(t,n){for(var r=0;r<n.length;r++)if(n[r].id==e){this.bulletData=n[r];return}console.error("no bullet data for bulletId",e,n)}.bind(this);n.subscribeToCategoryKey("game_parts_data","bullets",t)},u.prototype.playFireSound=function(e,t){var n=Math.floor(Math.random()*this.data.onFireSounds.length);i.fireEvent(i.list().ONESHOT_SOUND,{soundData:i.sound()[this.data.onFireSounds[n]]})},u.prototype.createBullet=function(){var n=.1,i=new o;i.setv(this.planeEntity.spatial.pos);var u=s.applyRotationToVelocity(this.planeEntity.geometries[0],new o(this.posOffset));i.addv(u);var a=new o(0,this.elevation*(1/t.RENDER_SETUP.physicsFPS),this.data.exitVelocity*(1/t.RENDER_SETUP.physicsFPS));a=s.applyRotationToVelocity(this.planeEntity.geometries[0],a),a.add(this.planeEntity.spatial.velocity),a.add_d(n*(Math.random()-.5),n*(Math.random()-.5),n*(Math.random()-.5));var f=function(e,t){console.log("Cannan hit!",t)};this.lastBulletVelocity.set(a),new r(i,a,this.bulletData,this.data,f,this.planeEntity.id,this.planeEntity.geometries[0]._world.tpf),this.playFireSound(i,a);for(var l=0;l<this.data.onFireEffects.length;l++)e.emit("playParticles",{simulatorId:this.data.onFireEffects[l].simulatorId,pos:i,vel:a,effectData:this.data.onFireEffects[l].effectData})},u.prototype.fire=function(){this.createBullet(),this.currentState==1&&this.sequenceShot(this.cooldownTime)},u.prototype.sequenceShot=function(e){var t=function(){this.fire()}.bind(this);i.fireEvent(i.list().SEQUENCE_CALLBACK,{callback:t,wait:e})},u.prototype.updateTriggerState=function(e,t,n){this.currentState=e;if(!e)return 0;var r=t*this.cooldownTime/n;return this.sequenceShot(r),this.currentState},u}),define("game/controls/WeaponsController",["application/EventManager","3d/GooJointAnimator","data_pipeline/PipelineAPI","game/weapons/WeaponData","game/weapons/PlaneCannon"],function(e,t,n,r,i){var s=function(e,t){var n={weaponData:t,cannons:[],locked:!1},r=[];for(var s in t.controls)for(var o=0;o<t[s].length;o++)r.push(new i(e,t[s][o].data,t[s][o],t[s][o].bulletData));return n.cannons=r,n},o=function(e,n,r){for(var i=0;i<n.length;i++)for(var s in n[i]){var o=e.pieceData.boneMap[s],u=e.animationChannels[o];t.rotateBone(u,n[i][s]*r)}},u=function(e,t,n){console.log("Trigger lights: ",t,n);for(var r=0;r<t.length;r++)var i=e.lights[t[r]].setIntensity(n)},a=function(e,t){t==undefined&&(t=0);var n=e.systems.weapons.weaponData,r=e.systems.weapons.cannons;for(var i=0;i<r.length;i++){var s=r[i];s.currentState==t&&(t=0),t=s.updateTriggerState(t,i,r.length)}return t},f=function(t,n){var r=t.systems.weapons.cannons;for(var i=0;i<r.length;i++)var s=r[i].currentState;if(s==engine.currentState)return;t.isPlayer&&e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:"weapons",currentState:s}),t.pieceInput.setAppliedState("weapons",s)},l=function(){};return{processControlState:l,applyControlStateToWeapons:a,updateWeaponState:f,buildSystem:s}}),define("game/controls/TrimController",[],function(){var e=function(e,t,n){var r={data:t};return r},t=function(){};return{buildSystem:e,processControlState:t}}),define("game/controls/HookController",["application/EventManager","3d/GooJointAnimator"],function(e,t){var n=function(e,t,n){var r=0;n&&(r=1);var i={data:t,targetState:r,currentState:r,hook:t.controls.hook,speed:t.speed,locked:!0};return i},r=function(e,t){return};return{processControlState:r,buildSystem:n}}),define("game/planes/Contrails",["goo/entities/SystemBus","game/GameUtil","goo/math/Vector3"],function(e,t,n){function s(n,s){r.set(s),t.applyRotationToVelocity(n.geometries[0],r),r.addv(n.spatial.pos),r.subv(n.spatial.velocity),i.set(n.spatial.velocity),i.mul(2);var o={lifespan:[0,25*Math.random()*Math.random()*Math.random()],size:[.1,.5],rotation:[0,6],spinspeed:[-0.1,.1],spin:"oneToZero",gravity:0,count:4,spread:.1,stretch:1,strength:16,acceleration:.98,alpha:[[0,1],[.1,.06],[.3,.04],[1,0]],growth:[[0,1],[.05,.8],[.3,.3],[1,1]],growthFactor:[2,5],sprite:"smokey"};e.emit("playVaporEffect",{pos:r,vel:i,effectData:o})}function o(e){var t=e.pieceData.wing_smoke;for(var n=0;n<t.length;n++)s(e,t[n])}var r=new n,i=new n;return{puffWingSmoke:o}}),define("game/controls/ControlStateCallbacks",["application/EventManager","game/controls/SurfaceController","game/controls/FlapsController","game/controls/BreaksController","game/controls/EngineController","game/controls/GearController","game/controls/DriveController","game/controls/CanopyController","game/controls/EjectionSeatController","game/controls/WeaponsController","game/controls/TrimController"],function(e,t,n,r,i,s,o,u,a,f){var l=function(n){switch(n){case"trim_elevator":return function(e,n,r){return t.applyTrimStateToSurface(e,n,"elevator")};case"trim_rudder":return function(e,n,r){return t.applyTrimStateToSurface(e,n,"rudder")};case"trim_aeilrons":return function(e,n,r){return t.applyTrimStateToSurface(e,n,"aeilrons")};case"elevator":case"rudder":case"aeilrons":case"flaps":case"wing_sweep":return function(e,n,r){return t.applyControlStateToSurface(e,n,r)};case"breaks":return function(e,n,i){return r.applyControlStateToBreaks(e,n),t.applyControlStateToSurface(e,n,i)};case"throttle":return function(e,t,n){return i.applyControlStateToEngines(e,t)};case"cannons":return function(t,n,r){n=f.applyControlStateToWeapons(t,n),e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:r,currentState:n})};case"gears":return function(e,t,n){t&&s.setEntityGearTargetState(e,!e.systems.gears.targetState)};case"canopy":return function(e,t,n){t&&u.setEntityCanopyTargetState(e,!e.systems.canopy.targetState)};case"eject":return function(e,t,n){t&&a.fireEjectionSeat(e)};case"wing_smoke":return function(e,t,n){e.pieceInput.getAppliedState(n)==1&&(t=0),e.pieceInput.setAppliedState(n,t)};case"debug_mechanics":case"auto_trim":return function(t,n,r){t.pieceInput.controls[r].value==n&&(n=0),e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:r,currentState:n})};case"reset_trim":return function(e,n,r){t.zeroSurfaceTrimState(e,"aeilrons"),t.zeroSurfaceTrimState(e,"elevator"),t.zeroSurfaceTrimState(e,"rudder")};case"screen_intensity":return function(e,t,n){e.screenSystem.setMasterIntensity(t)};case"hud_intensity":return function(e,t,n){e.screenSystem.displays.hud.setIntensity(t)};case"hdd_intensity":return function(e,t,n){for(var r in e.screenSystem.displays)r!="hud"&&e.screenSystem.displays[r].setIntensity(t)};case"cockpit_lights":return function(e,t,n){e.lightSystems.cockpit.setMasterIntensity(t)};case"cockpit_mode":return function(e,t,n){e.lightSystems.cockpit.setMode(t)};case"formation_lights":return function(e,t,n){e.lightSystems.formation.setMasterIntensity(t)};case"formation_mode":return function(e,t,n){e.lightSystems.formation.setMode(t)};case"position_lights":return function(e,t,n){e.lightSystems.position.setMasterIntensity(t)};case"sound_channel":return function(e,t,n){console.log("Sound Channel Level: ",e,t,n)};case"position_mode":return function(e,t,n){e.lightSystems.position.setMode(t)};case"taxi_lights":return function(e,t,n){e.lightSystems.taxi.setMasterIntensity(t)};case"taxi_mode":return function(e,t,n){e.lightSystems.taxi.setMode(t)};case"collision_lights":return function(e,t,n){e.lightSystems.collision.setMasterIntensity(t)};case"collision_mode":return function(e,t,n){e.lightSystems.collision.setMode(t)};default:return function(t,n,r){t.pieceInput.readControlValue(r)==1&&(n=0),e.fireEvent(e.list().PLAYER_CONTROL_STATE_UPDATE,{control:r,currentState:n})}}};return{getControlUpdateCallback:l}}),define("game/ControlsController",["application/EventManager","game/controls/SurfaceController","game/controls/FlapsController","game/controls/BreaksController","game/controls/EngineController","game/controls/GearController","game/controls/DriveController","game/controls/CanopyController","game/controls/EjectionSeatController","game/controls/WeaponsController","game/controls/TrimController","game/controls/HookController","game/planes/Contrails","game/GameConfiguration","game/controls/ControlStateCallbacks"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v={auto_trim:l,engine:i,drive:o,gears:s,canopy:u,seat:a,breaks:r,weapons:f,hook:c},m=function(e,t,n){e.systems={};for(var r=0;r<t.length;r++){e.systems[t[r].id]=v[t[r].id].buildSystem(e,t[r],n);for(var i in t[r].pieceInput)e.pieceInput.addPieceControl(i,t[r].pieceInput[i].value,d.getControlUpdateCallback(i))}},g=function(e,n){e.surfaces={};for(var r=0;r<n.length;r++)console.log("ADD SURFACE: ",n[r].id,n[r]),e.surfaces[n[r].id]=t.buildSurface(n[r])},y=function(e,t,n){var r=0;n&&(r=1),e.pieceData=t,m(e,t,r),g(e,t.surfaces)},b=function(e){var t={},n=function(e){if(!e.getChildren)return;var t=e.getChildren();for(var n=0;n<t.length;n++)r(e.children[n])},r=function(e){e.name&&(t[e.name]=e),e.baseRotMatrix=e.getRotMatrix(),e.basePos=[parseFloat(e.getLocX()),parseFloat(e.getLocY()),parseFloat(e.getLocZ())],n(e)};n(e.collada),e.pieceData.bones=t,console.log(t)},w=function(e,n){if(e.pieceInput.controls.auto_trim.value&&!e.pieceInput.controls.elevator.update){var r=e.forces.torque[0]*p.RENDER_SETUP.physicsFPS*n,i=r*Math.abs(Math.max(0,1-e.surfaces.elevator.currentState*.5));t.applyTrimStateToSurface(e,i,"elevator")}},E=function(e,t,n){for(var r in e.pieceInput.controls)e.pieceInput.controls[r].update&&e.pieceInput.controls[r].onChange(e,e.pieceInput.controls[r].value,r),r=="auto_trim"&&w(e,t),e.pieceInput.controls[r].update=!1,r=="wing_smoke"&&e.pieceInput.getAppliedState(r)==1&&h.puffWingSmoke(e);S(e,t,n)},S=function(e,n,r){t.processControlState(e);for(var i in e.systems)v[i].processControlState(e,r)};return{buildPieceControls:y,configurePlaneBones:b,applyInputStateToControls:E,addSurfacesToEntity:g,addSystemsToEntity:m}}),define("game/planes/PlaneController",["game/EntityController","game/ControlsController"],function(e,t){var n=function(e){var t=!e.systems.gears.targetState;console.log("Toggle Gears"),e.pieceInput.setInputAmount("gears",t)},r=function(e){var t=1,n=e.systems.canopy;n.targetState==1&&(t=0),e.pieceInput.setInputAmount("canopy",1)},i=function(e){e.pieceInput.setInputAmount("seat",1)},s=6.5,o=3,u=function(e,t){var n=0,r=e.spatial.speed;r>s?(n=1,e.surfaces.flaps.currentState!=0&&e.pieceInput.controls.flaps.onChange(e,0,"flaps")):r>(o+s)*.5?(n=.6,e.surfaces.flaps.currentState!=0&&e.pieceInput.controls.flaps.onChange(e,0,"flaps")):r>o&&(n=.3,e.surfaces.flaps.currentState!=0&&e.pieceInput.controls.flaps.onChange(e,0,"flaps"));if(t.currentState!=n){e.pieceInput.controls.wing_sweep.onChange(e,n,"wing_sweep");if(t.lights)for(var i=0;i<t.lights.length;i++)e.lights[t.lights[i]].setIntensity(n)}},a=function(e,n,r){e.surfaces.wing_sweep&&u(e,e.surfaces.wing_sweep),t.applyInputStateToControls(e,n,r)};return{updatePlaneControlState:a,toggleGears:n,toggleCanopy:r,fireEject:i}}),define("game/world/VideoBroadcasts",["application/EventManager","game/GameConfiguration"],function(e,t){function i(t,n){e.fireEvent(e.list().BROADCAST_VIDEO,{source:t,channel:n})}function s(){setTimeout(function(){},24300+Math.random()*12400)}function o(){var e=n.cats.funnyCat,t="hud";for(var r in n)if(Math.random()<.2){t=r;for(var o in n[t])Math.random()<.5&&(e=n[t][o])}i(e,t),s()}var n=t.VIDEOS.sources,r=t.VIDEOS.channels;return{broadcastVideo:i,playRandom:o}}),define("game/instruments/Instrument",[],function(){var e=function(e,t,n,r,i){this.id=e,this.curve=r,this.sample=n,this.boneName=i,this.axisAmp=t,this.value=null};return e.prototype.setValue=function(e){this.value=e},e.prototype.getValue=function(){return this.value},e.prototype.applyVector=function(e){return[e.data[this.axisAmp[0][0]]*this.axisAmp[0][1],e.data[this.axisAmp[1][0]]*this.axisAmp[1][1],e.data[this.axisAmp[2][0]]*this.axisAmp[2][1]]},e.prototype.getBoneName=function(){return this.boneName},e}),define("game/player/PlayerInstruments",["application/EventManager","goo/math/Vector3","3d/GooJointAnimator","game/GameConfiguration","game/GameUtil","game/instruments/Instrument","data_pipeline/PipelineAPI"],function(e,t,n,r,i,s,o){var u;require(["game/player/PlayerController"],function(e){u=e});var a=0,f=0,l,c=new t,h=new t,p=r.RENDER_SETUP.physicsFPS,d={speed:0,g:0},v=function(t,n,r){t.measurements.throttle&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"throttle",amount:l.systems.engine.engines[0].thrust*.001}),t.measurements.speed&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"speed",amount:3.6*d.speed*n}),t.measurements.altitude&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"altitude",amount:l.spatial.pos[1]}),t.measurements.airflowx&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"airflowx",amount:90*l.spatial.axisAttitudes.data[0]}),t.measurements.airflowy&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"airflowy",amount:90*l.spatial.axisAttitudes.data[1]}),t.measurements.airflowz&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"airflowz",amount:90*l.spatial.axisAttitudes.data[2]}),t.measurements.gForce&&e.fireEvent(e.list().PLAYER_VALUE_UPDATE,{value:"gForce",amount:1+d.g*9.81/(r*.001)}),a=0,f=0,d.speed=0,d.g=0},m=function(e,t){var r=l.animationChannels[l.pieceData.boneMap[e]];r&&n.rotateBone(r,t)},g=function(e,t){var r=l.animationChannels[l.pieceData.boneMap[e]];r&&n.translateBone(r,t)},y=function(e){return Math.atan2(e.spatial.velocity.data[0],-e.spatial.velocity.data[2])},b=function(e,t,n){return t[n][1]+(e-t[n][0])/(t[n+1][0]-t[n][0])*(t[n+1][1]-t[n][1])},w=function(e,t){for(var n=0;n<t.length;n++)if(t[n+1][0]>e)return b(e,t,n);return 0},E,S=function(e,t,n){h.set(t);var r=y(e),i=Math.atan2(h.data[0],h.data[1]);E={rotVec:t,xyHeading:r,rollAng:i,pitch:t.data[2],altitude:e.spatial.pos[1],speed:Math.sqrt(e.spatial.audioVel.lengthSquared()),g:e.forces.g.data[1]*n,acc:e.forces.g,aoa:e.spatial.axisAttitudes.data[1],climbRate:e.spatial.velocity.data[1]*n,rpm:e.systems.engine.engines[0].rpm,temp:e.systems.engine.engines[0].temp}},x=function(e){return E[e]},T=function(e,t,n){if(e.systems==undefined)return;S(e,t,n);var r;for(var s in e.instruments)e.instruments[s].sample&&(e.instruments[s].setValue(x(e.instruments[s].sample)),e.instruments[s].axisAmp.length?(r=e.instruments[s].applyVector(e.instruments[s].getValue()),g(e.instruments[s].getBoneName(),r)):(r=e.instruments[s].getValue(),e.instruments[s].curve&&(r=i.fitValueInCurve(r,e.instruments[s].curve)),m(e.instruments[s].getBoneName(),e.instruments[s].axisAmp*r)))},N=function(){l=u.getPlayerEntity(),c.setd(0,1,0),l.spatial.rot.applyPre(c),T(l,c,p)},C=function(t){l=u.getPlayerEntity();if(!l)return;var n=e.eventArgs(t).frameTime;c.set(0,0,1),l.spatial.rot.applyPost(c),e.fireEvent(e.list().MOVE_AUDIO_LISTENER,{pos:l.spatial.pos.data,rot:c.data,vel:l.spatial.audioVel.data}),a+=n,f+=1,d.speed+=l.spatial.speed,d.g+=l.forces.g.data[1];var r=250,i=1e3/a;N()},k=function(e,t,n,r){e.instruments[t]=new s(t,n.axisAmp,n.sample,r,n.boneName)},L=function(e,t,n){e.instruments={};for(var r=0;r<t.length;r++)k(e,t[r].id,t[r],n[t[r].curve]);e.measurements=e.pieceData.measurements},A=function(t,n,r){L(t,n,r),e.registerListener(e.list().UPDATE_ACTIVE_ENTITIES,C)};return{initInstruments:A}}),define("game/characters/CharacterAnimator",["application/EventManager","game/characters/CharacterData"],function(e,t){function o(e){return e>0?n.turnRight:e<0?n.turnLeft:n.idle}function u(e){return e>0?n.strafeRight:e<0?n.strafeLeft:n.idle}function a(e){return e>0?n.forward:e<0?n.back:n.idle}function f(e,t){if(e>0){if(t>0)return n.halfStrafeRight;if(t<0)return n.halfStrafeLeft}if(e<0){if(t>0)return n.backRight;if(t<0)return n.backLeft}return n.idle}function l(e,t,n){return e==0&&t==0?o(n):t==0?a(e):e==0?u(t):f(e,t)}function c(e){var t=e.forward-e.back,n=e.strafe*(e.turnright-e.turnleft),r=(1-e.strafe)*(e.turnright-e.turnleft)+e.mouseturn;return l(t,n,r)}function h(e,t){var s=e.animStateMap[t];console.log(t,s,e),e.geometries[0].animationComponent.transitionTo(s),t==n.idle||t=="sit"||t=="pilot_sit"||t=="jumpstate"?clearTimeout(r):(e.currentMovementAnimState=!t)&&i(e)}function p(e){var t=e.pieceData.animations.moveStates;h(e,t[e.currentMovementAnimState])}function d(e,t){var n=e.pieceData.animations[t],r=e.animationComponent.getCurrentState();if(r.name!=n)return r.name}function m(e,t){clearTimeout(v),v=setTimeout(function(){g(e,t)},100)}var n=t.ANIM_STATES.movement,r,i=function(e){clearTimeout(r),s(e)},s=function(t){r=setTimeout(function(){var n=Math.ceil(Math.random()*3),r=t.spatial.pos.data;e.fireEvent(e.list().ONESHOT_AMBIENT_SOUND,{soundData:e.sound()["STEP_ROAD_"+n],pos:[r[0],r[1]+1,r[2]],dir:[Math.random()-.5,Math.random(),Math.random()-.5]}),i(t)},300)},v,g=function(e,t){if(e.isPilot)return;e.geometries[0].animationComponent||(alert("No Animation"),console.log(e.geometries[0]));if(!e.geometries[0].animationComponent.getCurrentState()){m(e,t);return}var r=n.jumpState;e.moveSphere.spatialControl.sphereMovement.groundContact&&(r=c(t));if(e.geometries[0].animationComponent.getCurrentState()._name==undefined){m(e,t);return}if(e.currentMovementAnimState==r)return;e.currentMovementAnimState=r,p(e)};return{applyMovementAnimation:p,applyEntityAnimationState:h,updateCharacterMovementAnimation:g}}),define("game/player/PlayerUtils",["application/EventManager","game/characters/CharacterAnimator","game/player/PlayerPieceHandler"],function(e,t,n){function i(){return r.getPlayerEntity()}var r;require(["game/player/PlayerController"],function(e){r=e});var s=function(e){var t=i();for(var n in t.wings)t.wings[n].visualize(t,t.wings[n],e)},o=function(t){var n=e.eventArgs(t).pos,r=" "+[i().spatial.pos.data[0],i().spatial.pos.data[1],i().spatial.pos.data[2]];e.fireEvent(e.list().ANALYTICS_EVENT,{category:"ui_action",action:"RESET",labels:"From:"+r,value:0}),i().spatial.pos.set(n)},u=function(e){for(var t in e.systems)t!="engine"&&(e.systems[t].locked=!1)},a=function(n,r){n.isPilot!=1&&console.log("Pilot transition failed! ",n),n.moveSphere.deactivate(),r.pilot=n,n.spatial.velocity.set(0,0,0),n.spatial.pos.set(r.pieceData.dimensions.pilotSeatPos);var i=function(){t.applyEntityAnimationState(n,n.pieceData.animations.seated.pilotSit),e.fireEvent(e.list().SET_CAMERA_TARGET,{spatial:n.spatial,geometry:n.geometries[0],controlScript:"pilotCam"});var i=function(){u(r)};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:i,wait:300})};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:i,wait:300})},f=function(e,t){t()},l=function(t,n,r){console.log("Attach Pilot: ",t),t.isPilot=!0;var i=function(){a(t,n),e.fireEvent(e.list().SET_PLAYER_CONTROLLED_ENTITY,{entity:n,callback:r})};t.isPlayer?f(t,i):i(),t.isPlayer=!1},c=function(){var t=i().spatial.pos;console.log("USE NEAREST ENTITY");var n=i(),r=function(){console.log("Using nearest vehicle ready")},s=function(){function i(e){l(n,e,r)}e.fireEvent(e.list().FETCH_LEVEL_ENTITY,{entityId:"NEAREST",pos:t,callback:i})};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:s,wait:300})},h=function(t){e.eventArgs(t).control=="debug_mechanics"&&s(e.eventArgs(t).currentState)},p=function(){e.registerListener(e.list().PLAYER_MOVE_TO_POINT,o),e.registerListener(e.list().USE_NEAREST_ENTITY,c),e.registerListener(e.list().PLAYER_CONTROL_STATE_UPDATE,h)},d=function(t){l(e.eventArgs(t).pilot,e.eventArgs(t).vehicle,e.eventArgs(t).callback)};return e.registerListener(e.list().SCENARIO_LOADED,p),e.registerListener(e.list().PILOT_VEHICLE,d),{handleDebugState:s}}),define("game/player/PlayerInputSystem",["application/EventManager","goo/math/Vector3","3d/GooJointAnimator","game/GameConfiguration","game/planes/PlaneData","game/piece/PieceBuilder","game/player/PlayerUtils"],function(e,t,n,r,i,s,o){var u;require(["game/player/PlayerController"],function(e){u=e});var a="playerId",f=function(e){contrails.updateAcrobaticSmokeState(u.getPlayerEntity(),e)},l=function(t){var n=u.getPlayerEntity(),r=e.eventArgs(t);n.state=r.movestate},c=function(e,t){var r=u.getPlayerEntity();if(!r.systems)return;if(r.systems[e])var i=r.systems[e].data;else{if(!r.surfaces[e])return;var i=r.surfaces[e].data}if(i.inputBehavior.inputAnim){var s=i.inputBehavior.inputAnim,o=s.bone,a=r.pieceData.boneMap[o],f=r.animationChannels[a],l=s.rot;o=="stick"?n.rotateBone(f,r.surfaces.aeilrons.currentState*l[0],t*l[1],t*l[2]):n.rotateBone(f,t*l[0],t*l[1],t*l[2])}},h=function(e,t){c(e,t)},p=function(e){var t=u.getPlayerEntity();t.pieceInput.triggerUpdate(e)},d=function(e,t){var n=u.getPlayerEntity();n.pieceInput.setInputState(e,t)},v=function(t){d(e.eventArgs(t).control,e.eventArgs(t).value),e.eventArgs(t).control=="jump"&&console.log(u.getPlayerEntity().spatial.pos.data)},m=function(t){h(e.eventArgs(t).control,e.eventArgs(t).currentState)},g=0,y=0,b=function(t){function n(e){d("mouseturn",e[0]*30),y=e[0]}g&&e.fireEvent(e.list().FETCH_DRAG_DELTA,{callback:n})},w=function(t){var n=e.eventArgs(t).action;d("mouseforward",n[0]*n[1]),p("forward"),d("mouseturn",0),g!=n[1]&&d("strafe",n[1]),g=n[1]},E=!1,S=function(){if(E)return;e.registerListener(e.list().PLAYER_CONTROL_EVENT,v),e.registerListener(e.list().PLAYER_CONTROL_STATE_UPDATE,m),e.registerListener(e.list().RENDER_TICK,b),e.registerListener(e.list().MOUSE_ACTION,w),E=!0};return{ready:S}}),define("game/player/PlayerUiHandler",["application/EventManager"],function(e){var t=function(t,n){console.log("LOAD TEMPLATE: ",t),e.fireEvent(e.list().LOAD_UI_TEMPLATE,{templateId:t,callback:n})},n=function(t,n){e.fireEvent(e.list().UNLOAD_UI_TEMPLATE,{templateId:t,callback:n})};return{loadPlayerUi:t,unloadPlayerUi:n}}),define("game/player/PlayerPieceHandler",["application/EventManager","goo/math/Vector3","3d/GooJointAnimator","game/GameConfiguration","game/piece/PieceBuilder","game/player/PlayerInstruments","game/player/PlayerInputSystem","game/player/PlayerUiHandler","physics/PhysicalWorld"],function(e,t,n,r,i,s,o,u,a){var f;require(["game/player/PlayerController"],function(e){f=e});var l="playerId",c,h=function(t){if(!t.systems)return;e.fireEvent(e.list().INIT_PLAYER_CONTROL_STATE,{control:"engine",controlState:t.systems.engine.currentState})},p=function(t,n){t.isPlayer=!0,console.log("SET PLAYER ENTITY: ",t),e.fireEvent(e.list().ADD_KEYBINDINGS,{bindings:r.KEY_BINDINGS[t.pieceData.keyBindings]}),t.moveSphere&&a.activateAmmoComponent(t.moveSphere.ammoComponent,t.spatial.pos.data,t.spatial.velocity.data,t.pieceData.dimensions.mobRadius),setTimeout(function(){if(!t.systems)return;t.systems.engines&&h(t)},0);var i=0,s=function(){i+=1,console.log("UI CALLBACK: ",i),i==t.pieceData.uiPages.length&&(console.log("UI CALLBACK: ",i,t.pieceData.uiPages.length-1),n(t),o.ready())};return n(t),o.ready(),console.log("--------->>>>> playerEntity: ",t),t},d=function(e,t){var n=0,r=function(r){n+=1,console.log("Page count: ",r,n,e.pieceData.uiPages.length),n==e.pieceData.uiPages.length&&(console.log("unloading ui from ",e),setTimeout(function(){t()},100))};t()},v=function(t,n){console.log("REMOVE CONTROLS FROM: ",t),t.isPlayer=!1,e.fireEvent(e.list().CLEAR_KEYBINDINGS,{bindings:t.pieceData.keyBindings}),t.moveSphere&&a.removeAmmoComponent(e.moveSphere.ammoComponent),d(t,n)};return{removePlayerControlFrom:v,unloadControledEntityUi:d,setPlayerControlledEntity:p}}),define("game/ships/Boat",["game/world/PhysicalWorld","application/EventManager","goo/math/Vector3","game/player/PlayerPieceHandler","game/GameConfiguration","game/ModelDefinitions","game/world/LevelController","3d/GooJointAnimator","goo/entities/SystemBus","game/GameUtil"],function(e,t,n,r,i,s,o,u,a,f){var l=new n,c=function(n,r,i){this.wakes=r.wakes;var s=this;this.passengers={};var o=function(n){s.entity=n,n.pieceData=r,e.registerPhysicalEntity(n),n.combat.hitPoints=r.hitPoints,n.combat.destroyed=function(e){};var o=function(e){n.geometries[0]&&n.geometries[0].removeFromWorld(),n.geometries[0]=e,n.geometries[0].addToWorld(),e.animationComponent&&u.printClipInitialTransform(n),n.spatial.velocity.data[2]=.3*(Math.random()-.5),n.spatial.velocity.data[0]=.3*(Math.random()-.5),i(s)};t.fireEvent(t.list().BUILD_GOO_GAMEPIECE,{projPath:"bundles",modelPath:r.piecePath,callback:o})};t.fireEvent(t.list().ADD_GAME_ENTITY,{entityId:n,callback:o})};return c.prototype.setHostileTarget=function(e){for(var t=0;t<this.entity.turrets.length;t++)this.entity.turrets[t].setTargetEntity(e)},c.prototype.abandonShip=function(){for(var e=0;e<this.entity.turrets.length;e++)this.entity.turrets[e].disengageTurret();for(var t in this.chimneys)this.chimneys[t].setChimneyIntensity(0);for(t in this.radars)this.radars[t].stopRadar()},c.prototype.pushWakes=function(){var e=this.entity.spatial.speed,r=this.entity.spatial.pos;for(var i in this.wakes){l.set(this.wakes[i].posOffset);var s=Math.random()*this.wakes[i].spread;l.data[2]+=l.data[2]*s,l.data[0]+=l.data[0]*-s;var o=f.applyRotationToVelocity(this.entity.geometries[0],l);o.addv(r);if(i==0&&Math.random()<e*.6){var u={count:2,opacity:[1,1],alpha:"oneToZero",growthFactor:[3,6],growth:"oneToZero",stretch:0,strength:5,spread:.5,acceleration:.98,gravity:-9,rotation:[0,7],spin:"oneToZero",size:[1.1,3.3],lifespan:[1.1,1.4],spinspeed:[-0.2,.2],sprite:"splash_thick",loopcount:1,trailsprite:"projectile_1",trailwidth:1};a.emit("playWaterEffect",{pos:o,vel:n.UNIT_Y,effectData:u})}if(Math.random()+.01<e*.5)if(i==0||i==1)t.fireEvent(t.list().SPLASH_RINGLET,{pos:[o.data[0],o.data[1]+1.4,o.data[2]],count:1,dir:[0,0,0]}),t.fireEvent(t.list().SPLASH_FOAM,{pos:[o.data[0]+(Math.random()-.5)*15,o.data[1]+1.4,o.data[2]+(Math.random()-.5)*15],count:1,dir:[(Math.random()-.5)*.6,0,(Math.random()-.5)*.6]});else{var u={count:1,opacity:[1,1],alpha:"oneToZero",growthFactor:[4,6],growth:"oneToZero",stretch:2,strength:1,spread:.2,acceleration:.98,gravity:1,rotation:[0,7],spin:"oneToZero",size:[.1,1.3],lifespan:[.1,4.4],spinspeed:[-0.2,.2],sprite:"splash_thick",loopcount:1,trailsprite:"projectile_1",trailwidth:1};a.emit("playWaterEffect",{pos:o,vel:n.UNIT_Y,effectData:u})}}},c.prototype.getCatapultById=function(e){for(var t=0;t<this.catapults.length;t++)if(this.catapults[t].id==e)return this.catapults[t]},c.prototype.addPassenger=function(e,t){this.passengers[e.id]={entity:e,posOffset:t.posOffset,rot:new n(t.rot),catapult:this.getCatapultById(t.catapult)}},c.prototype.setPassengerParkingLot=function(e,t){var r=new n(t.posOffset);e.spatial.pos.data[1]=t.posOffset[1],e.spatial.rot.fromAngles(t.rot[0],t.rot[1],t.rot[2]),this.addPassenger(e,t)},c.prototype.removeCatapultThrustFromPlane=function(e){for(var t=0;t<e.systems.engine.engines.length;t++)e.systems.engine.engines[t].maxThrust*=.5},c.prototype.applyCatapultThrustToPlane=function(e){e.spatial.velocity.setDirect(0,0,1),e.spatial.rot.applyPost(e.spatial.velocity),e.spatial.velocity.mulDirect(.2,0,.2);for(var t=0;t<e.systems.engine.engines.length;t++)e.systems.engine.engines[t].maxThrust*=2;var n=this;setTimeout(function(){e.pieceInput.getAppliedState("gears")==1&&a.emit("message_to_gui",{channel:"alert_channel",message:"Retract landing Gear"}),n.removeCatapultThrustFromPlane(e)},8e3)},c.prototype.catapultPlane=function(e){var t=this.checkCatapultForLaunch(e);console.log(this.passengers);var n=this.passengers[e.id].catapult;n.catapultCharged();var r=this;if(t){var i=function(){delete this.passengers[e.id],a.emit("message_to_gui",{channel:"alert_channel",message:"-  -"}),a.emit("message_to_gui",{channel:"system_channel",message:"Engaged"}),this.applyCatapultThrustToPlane(e)}.bind(this);setTimeout(function(){a.emit("message_to_gui",{channel:"alert_channel",message:" "}),n.catapultPassive()},4500),setTimeout(function(){i()},4e3),setTimeout(function(){a.emit("message_to_gui",{channel:"alert_channel",message:"- 1 -"}),n.catapultTrigger()},3e3),setTimeout(function(){a.emit("message_to_gui",{channel:"alert_channel",message:"-  2  -"})},2e3),setTimeout(function(){a.emit("message_to_gui",{channel:"alert_channel",message:"-   3   -"}),a.emit("message_to_gui",{channel:"system_channel",message:"Systems Ready"})},1e3)}else setTimeout(function(){r.catapultPlane(e)},3e3)},c.prototype.checkCatapultForLaunch=function(e){return e.systems.engine.engines[0].started?e.pieceInput.getAppliedState("canopy")>.01?(a.emit("message_to_gui",{channel:"alert_channel",message:"Canopy Open"}),a.emit("message_to_gui",{channel:"system_channel",message:"Press [C] to toggle Canopy"}),!1):e.systems.engine.engines[0].thrust<e.systems.engine.engines[0].maxThrust*.92?(a.emit("message_to_gui",{channel:"hint_channel",message:"Increase Engine Power"}),a.emit("message_to_gui",{channel:"system_channel",message:"[THR] "+Math.round(e.systems.engine.engines[0].thrust/e.systems.engine.engines[0].maxThrust*100)}),!1):e.pieceInput.getAppliedState("flaps")<.4?(a.emit("message_to_gui",{channel:"hint_channel",message:"Engage Flaps"}),a.emit("message_to_gui",{channel:"system_channel",message:"[THR] "+Math.round(e.pieceInput.getAppliedState("canopy")*100)}),!1):e.pieceInput.getAppliedState("breaks")>.01?(a.emit("message_to_gui",{channel:"hint_channel",message:"Release Brakes"}),a.emit("message_to_gui",{channel:"system_channel",message:"Toggle Brakes [V]"}),!1):(a.emit("message_to_gui",{channel:"system_channel",message:"Catapult Ready"}),!0):(a.emit("message_to_gui",{channel:"hint_channel",message:"Start Engines"}),!1)},c.prototype.launchPlane=function(e){this.entity.pilot=null;var n=this,r=function(){setTimeout(function(){n.catapultPlane(e)},3e3)};t.fireEvent(t.list().PILOT_VEHICLE,{pilot:this.entity.pilot,vehicle:e,callback:r})},c.prototype.setPassengerToReady=function(e){this.setPassengerParkingLot(e,this.entity.pieceData.parkingLots.launch);var t=this;setTimeout(function(){t.launchPlane(e)},3e3)},c.prototype.initPlaneReadyAtLot=function(e,t){this.setPassengerParkingLot(e,t),console.log("Attach passenger:",e.id)},c.prototype.attachPassenger=function(e,n){this.setPassengerParkingLot(e,n),console.log("Attach passenger:",e.id);var i=e.pilot,s=this,o=function(){setTimeout(function(){s.setPassengerToReady(e)},3e3)},u=function(){setTimeout(function(){t.fireEvent(t.list().PILOT_VEHICLE,{pilot:i,vehicle:s.entity,callback:o}),e.pilot=null},2500)};r.removePlayerControlFrom(e,u)},c.prototype.updatePassenger=function(e){e.entity.spatial.velocity.x=this.entity.spatial.velocity.x,e.entity.spatial.velocity.z=this.entity.spatial.velocity.z,e.entity.spatial.velocity.y*=.9;for(var t=0;t<e.entity.systems.gears.wheels.length;t++)e.entity.systems.gears.wheels[t]?e.entity.systems.gears.wheels[t].setGroundVelocity(this.entity.spatial.velocity):console.error("wheel missing: ",e.entity.systems.gears.wheels,t);l.set(e.posOffset),this.entity.spatial.rot.applyPost(l),l.add(this.entity.spatial.pos),e.entity.spatial.pos.data[0]=l.data[0],e.entity.spatial.pos.data[2]=l.data[2];var n=this.entity.spatial.rot.toAngles();n.add(e.rot),e.entity.spatial.rot.fromAngles(e.rot.data[0],n.data[1],e.rot.data[2])},c.prototype.updateBoat=function(){var e=this.entity;for(var t in e.turrets)u.updateEntityBoneRotX(e,e.turrets[t].pivotBoneId,e.turrets[t].direction),u.updateEntityBoneRotX(e,e.turrets[t].elevateJointId,e.turrets[t].elevation),e.turrets[t].updateTurretState();for(t in e.chimneys)e.chimneys[t].updateChimney();for(t in e.radars)e.radars[t].updateRadar();for(t in e.flags)e.flags[t].updateFlag();for(t in this.passengers)this.updatePassenger(this.passengers[t]);for(var n=0;n<this.catapults.length;n++)this.catapults[n].updateCatapult();this.helmsman.updateHelmsman(),this.pushWakes()},c}),define("game/ships/Helmsman",["application/EventManager","game/GameUtil","goo/math/Vector3","goo/math/Matrix3x3"],function(e,t,n,r){var i=new n,s=new n,o=function(e,t){this.boat=e,this.entity=e.entity,this.navPoint=new n(this.entity.spatial.pos),this.nextNavPoint=new n(this.entity.spatial.pos),this.steerMat=new r,this.targetSpeed=new n(0,0,.1)};return o.prototype.setNavPoint=function(e){this.nextNavPoint.data[0]==0&&this.nextNavPoint.data[2]==0&&this.navPoint.set(e),this.nextNavPoint.set(e)},o.prototype.checkNavPointSwitch=function(){i.set(this.navPoint),i.sub(this.entity.spatial.pos),i.lengthSquared()<1e5&&this.navPoint.set(this.nextNavPoint)},o.prototype.updateHelmsman=function(){this.checkNavPointSwitch(),i.setVector(this.navPoint),i.subVector(this.entity.spatial.pos),this.steerMat.lookAt(i,n.UNIT_Y),s.set(this.targetSpeed),this.steerMat.applyPost(s),this.entity.spatial.velocity.lerp(s,.05);var e=Math.sin((new Date).getTime()*.001);this.entity.spatial.velocity.data[1]+=e*2,this.entity.spatial.rot.rotateX(3*e),this.entity.spatial.rot.rotateZ(Math.cos(e)*5)},o}),define("game/ships/ShipsCaptain",["application/EventManager"],function(e){var t;require(["game/world/LevelController"],function(e){t=e});var n=function(e){this.boat=e,this.target={},this.navIndex=0,this.updateCaptainsOrders()};n.prototype.setTargetEntity=function(e){this.target=e,this.boat.setHostileTarget(e)},n.prototype.orderClearTargets=function(){this.target=null,this.boat.setHostileTarget(this.target)},n.prototype.orderAbandonShip=function(){this.boat.abandonShip()},n.prototype.determineTargets=function(){this.updateCaptainsOrders();var e=t.getBoats();for(var n in e)if(e[n].entity.id!=this.boat.entity.id){if(e[n].entity.id==this.target.id)return;if(e[n].entity.combat.isAlive==0){this.orderClearTargets();return}this.setTargetEntity(e[n].entity);return}};var r=[[5600,0,1e3],[5200,0,4e3],[7600,0,5e3],[6600,0,100],[8100,0,1e3],[8100,0,4e3],[7100,0,1500],[7100,0,3e3]];return n.prototype.updateNavPoint=function(){var e=Math.floor(Math.random()*r.length);if(e==this.navIndex){this.updateNavPoint();return}this.navIndex=e,this.boat.helmsman.setNavPoint(r[e])},n.prototype.updateCaptainsOrders=function(){if(this.boat.entity.combat.isAlive==0){this.orderAbandonShip();return}this.updateNavPoint();var e=this;setTimeout(function(){},28e3+Math.random()*12e3)},n}),define("game/weapons/ShipCannon",["goo/entities/SystemBus","data_pipeline/PipelineAPI","game/GameConfiguration","game/weapons/Bullet","game/GameUtil","application/EventManager","goo/math/Vector3"],function(e,t,n,r,i,s,o){var u=function(e,t,n,r){this.boatEntity=e,this.posOffset=n,this.attachCannonData(t),this.attachBulletData(r),this.currentState=0,this.targetState=0,this.firing=!1,this.flameEffect=null,this.smokeEffect=null,this.fireSounds={},this.turretRot=this.boatEntity.geometries[0].transformComponent.transform.rotation.clone()};return u.prototype.attachCannonData=function(e){var n=function(t,n){for(var r=0;r<n.length;r++)if(n[r].id==e){this.name=n[r].name,this.data=n[r],this.cooldownTime=1e3/this.data.rateOfFire;return}console.error("no cannon data for cannonId on turret",e,n,this)}.bind(this);t.subscribeToCategoryKey("game_parts_data","cannons",n)},u.prototype.attachBulletData=function(e){var n=function(t,n){for(var r=0;r<n.length;r++)if(n[r].id==e){this.bulletData=n[r];return}console.error("no bullet data for bulletId",e,n)}.bind(this);t.subscribeToCategoryKey("game_parts_data","bullets",n)},u.prototype.playFireSound=function(e,t){var n=Math.floor(Math.random()*this.data.onFireSounds.length);s.fireEvent(s.list().ONESHOT_AMBIENT_SOUND,{soundData:s.sound()[this.data.onFireSounds[n]],pos:e,vel:this.boatEntity.spatial.velocity.data,dir:t.data})},u.prototype.createBullet=function(t,s,u){var a=new o;a.setv(this.boatEntity.spatial.visualPos);var f=i.applyRotationToVelocity(this.boatEntity.geometries[0],new o(this.posOffset));a.addv(f);var l=new o(0,0,this.data.exitVelocity*(1/n.RENDER_SETUP.physicsFPS));this.turretRot.copy(this.boatEntity.spatial.rot),this.turretRot.rotateY(t),this.turretRot.rotateX(-s),l=this.turretRot.applyPost(l),new r(a,l,this.bulletData,this.data,u,this.boatEntity.id),this.playFireSound(a.data,l);for(var c=0;c<this.data.onFireEffects.length;c++)e.emit("playParticles",{simulatorId:this.data.onFireEffects[c].simulatorId,pos:a,vel:l,effectData:this.data.onFireEffects[c].effectData})},u.prototype.fire=function(e,t,n){this.createBullet(e,t,n)},u.prototype.sequenceShot=function(e){var t=function(){this.fire()}.bind(this);s.fireEvent(s.list().SEQUENCE_CALLBACK,{callback:t,wait:e})},u}),define("physics/TrajectoryPhysics",["game/GameConfiguration"],function(e){var t=-e.WORLD_PROPERTIES.gravity[1],n=function(e,n,r){var i=e,s=n,o=r,u=.5*Math.asin(t*s/(i*i));return u},r=function(e,n){return n*n*Math.sin(2*e)/t},i=function(e,n,r){var i=n,s=e,o=r;if(s>Math.PI/2||s<0||i<0)return!1;var u=t,a=i*Math.cos(s),f=i*Math.sin(s),l=o+f*f/(2*u);if(l<0)return!1;var c=f/u,h=Math.sqrt(2*l/u),p=a*(c+h),d=c+h,v=Math.sqrt(u*h*u*h+a*a);return p};return{calcDistanceAtElevationVelocityAndHeight:i,calcDistanceAtElevationAndVelocity:r,calcElevationForTrajectory:n}}),define("game/weapons/Turret",["application/EventManager","goo/math/Vector3","game/weapons/ShipCannon","physics/TrajectoryPhysics","game/GameUtil"],function(e,t,n,r,i){var s=function(e,n){this.calcVec=new t,this.targets=n.targets,this.baseRot=n.baseRot,this.basePos=n.posOffset,this.shipEntity=e,this.pivotBoneId=n.bonePivot,this.elevateJointId=n.boneElevate,this.swivel=n.swivel,this.speed=n.speed,this.direction=0,this.elevation=0,this.ready=!0,this.targetEntity=null,this.lastDiff=[0,0,0],this.lastAimDelta=[0,0,0],this.targetAimDelta=[0,0,0],this.elevationReady=!1,this.swivelReady=!1,this.aimParams={sidewaysness:0,boostElevation:0,targetDistance:1e3,shotRange:1e3,hitDistance:1e3,newElevation:0,newSwivel:0},this.states={idle:"idle",loading:"loading",waiting:"waiting",aiming:"aiming",ready:"ready"},this.currentState=this.states.idle,this.attachCannon(n.cannonId,n.posOffset,n.bulletData)};return s.prototype.attachCannon=function(e,t,r){this.cannon=new n(this.shipEntity,e,t,r)},s.prototype.loadTurret=function(){var t=this,n=function(){t.currentState=t.states.aiming};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:n,wait:1e3/this.cannon.data.rateOfFire+Math.random()*200/this.cannon.data.rateOfFire})},s.prototype.handleTurretStateUpdate=function(){if(!this.shipEntity.combat.isAlive)return;this.targetEntity?this.targetEntity.combat.isAlive||this.disengageTurret():this.disengageTurret();switch(this.currentState){case this.states.idle:this.aimParams.newElevation=.4,this.aimParams.newSwivel=0,Math.round(this.direction*2e3)!=Math.round(this.aimParams.newSwivel*2e3)?(this.adjustSwivelAngle(),this.swivelReady=!1):(this.swivelReady=!0,Math.round(this.elevation*2e3)!=Math.round(this.aimParams.newElevation*2e3)?(this.adjustElevationAngle(),this.elevationReady=!1):this.elevationReady=!0);break;case this.states.loading:this.loadTurret(),this.currentState=this.states.waiting;break;case this.states.waiting:this.aimTurret();break;case this.states.aiming:if(Math.abs(this.aimParams.newSwivel)>Math.abs(this.swivel)&&Math.abs(this.aimParams.newSwivel-2*Math.PI)>Math.abs(this.swivel)){var t=this,n=function(){t.currentState=t.states.aiming};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:n,wait:5e3}),this.currentState=this.states.waiting;return}Math.round(this.direction*2e3)!=Math.round(this.aimParams.newSwivel*2e3)?(this.adjustSwivelAngle(),this.swivelReady=!1):(this.swivelReady=!0,Math.round(this.elevation*2e3)!=Math.round(this.aimParams.newElevation*2e3)?(this.adjustElevationAngle(),this.elevationReady=!1):this.elevationReady=!0),this.elevationReady&&this.swivelReady&&(this.currentState=this.states.ready);break;case this.states.ready:this.fireTurret()}},s.prototype.adjustElevationAngle=function(){var e=this.aimParams.newElevation-this.elevation;this.setElevationAngle(this.elevation+e*.08)},s.prototype.adjustSwivelAngle=function(){var e=this.aimParams.newSwivel-this.direction;this.setPivotAngle(this.direction+e*.06)},s.prototype.setPivotAngle=function(e){this.direction=e},s.prototype.setElevationAngle=function(e){this.elevation=e},s.prototype.setTargetEntity=function(e){e?(this.currentState=this.states.loading,this.targetEntity=e):this.disengageTurret()},s.prototype.disengageTurret=function(){this.currentState=this.states.idle,this.targetEntity=null},s.prototype.fireTurret=function(){var e=this,t=function(e,t){var n=e.pos;switch(t){case"water":break;case"nothing":}};this.cannon.fire(this.direction+this.baseRot,this.elevation,t),this.currentState=this.states.loading},s.prototype.aimTurret=function(){var e=.2*Math.random(),t=this,n=this.targetEntity.spatial.pos,s=this.shipEntity.spatial.pos,o=this.shipEntity.spatial.rot.toAngles(),u=this.calcVec.setv(n),a=this.basePos;u.subv(s);var f=Math.sqrt(u.lengthSquared()),l=r.calcElevationForTrajectory(t.cannon.data.exitVelocity,f,n.data[1]-s.data[1])+e*(Math.random()-.5);if(isNaN(l)){this.currentState=this.states.idle;return}t.aimParams.newSwivel=i.determineYAngleFromPosAndRotToPos(s.data,[o.data[0]+e*(Math.random()-.5),o.data[1]+t.baseRot+e*(Math.random()-.5),o.data[2]+e*(Math.random()-.5)],n.data),t.aimParams.newElevation=l},s.prototype.updateTurretState=function(){this.handleTurretStateUpdate()},s}),define("game/ships/Chimney",["goo/entities/SystemBus","application/EventManager","game/GameUtil","goo/math/Vector3"],function(e,t,n,r){var i=new r,s=new r,o=function(e,t){this.boat=e,this.puffIntensity=.3,this.posOffset=t.posOffset,this.shortest=.1,this.longest=35,this.effectData={color0:[.01,.01,.01],color1:[.3,.3,.3],count:1,opacity:[.3,.9],alpha:"oneToZero",growthFactor:[1.1,3],growth:"oneToZero",stretch:.4,strength:25,spread:.5,acceleration:.99,gravity:1,rotation:[0,7],spin:"oneToZero",size:[1.1,2.3],lifespan:[this.shortest,this.longest],spinspeed:[-0.1,.1],sprite:"smokey",loopcount:1,trailsprite:"projectile_1",trailwidth:1}};return o.prototype.calcLifespan=function(){this.effectData.lifespan[1]=this.longest*Math.random()*Math.random()*Math.random()*Math.random()},o.prototype.setChimneyIntensity=function(e){this.puffIntensity=e},o.prototype.updateChimney=function(){Math.random()<this.puffIntensity&&(this.calcLifespan(),i.set(this.posOffset),s.set(this.boat.spatial.pos),n.applyRotationToVelocity(this.boat.geometries[0],i),s.addv(i),i.set(0,4,0),e.emit("playParticles",{simulatorId:"StandardParticle",pos:s,vel:i,effectData:this.effectData}))},o}),define("game/ships/Radar",["3d/GooJointAnimator"],function(e){var t=function(e,t){this.boat=e,this.pivotBoneId=t.bonePivot,this.rotVel=t.rotVel,this.direction=0};return t.prototype.stopRadar=function(){this.rotVel=0},t.prototype.updateRadar=function(){this.direction+=this.rotVel,e.updateEntityBoneRotX(this.boat,this.pivotBoneId,this.direction)},t}),define("game/ships/CarrierCable",["application/EventManager","game/GameUtil","goo/math/Vector3"],function(e,t,n){var r=new n,i=function(e,t){this.boat=e,this.cableNr=t,this.entity=e.entity};return i.prototype.catchPlane=function(e){console.log("CATCH PLANE: ",this.cableNr,e),e.spatial.velocity.data[1]*=.4,e.spatial.velocity.mul(.9),e.cable=this},i.prototype.updateHookedPlane=function(t){t.spatial.velocity.mul(.998),t.spatial.velocity.data[1]*=.95,Math.abs(t.spatial.velocity.lengthSquared()-this.entity.spatial.velocity.lengthSquared())<.01&&(e.fireEvent(e.list().ANALYTICS_EVENT,{category:"GAME_EVENT",action:"CARRIER_LANDING",labels:t.id+" on: "+this.entity.id+" cableNr:"+this.cableNr,value:1}),console.log("HOOKED PLANE MATCH",t),this.boat.attachPassenger(t,this.entity.pieceData.parkingLots.service),t.cable=null)},i}),define("game/ships/Catapult",["goo/entities/SystemBus","application/EventManager","game/GameUtil","goo/math/Vector3","goo/math/Matrix3x3"],function(e,t,n,r,i){var s=new r,o=new r,u=function(e,t){this.id=t.id,this.boat=e,this.puffIntensity=.3,this.posOffset=t.posOffset,this.catapultData=t,this.rotOffset=new i,this.rotOffset.fromAngles(t.rot[0],t.rot[1],t.rot[2]),this.shortest=2,this.longest=4,this.effectData={color:[1,1,1,1],count:1,opacity:[.05,.1],alpha:"zeroOneZero",growthFactor:[1.1,8],growth:"zeroToOne",stretch:.4,strength:5,spread:.5,acceleration:.98,gravity:0,rotation:[0,7],spin:"oneToZero",size:[.1,2.3],lifespan:[this.shortest,this.longest],spinspeed:[-0.1,.1],sprite:"smokey",loopcount:1,trailsprite:"projectile_1",trailwidth:1}};return u.prototype.calcLifespan=function(){this.effectData.lifespan[1]=this.longest*Math.random()*Math.random()*Math.random()*Math.random()},u.prototype.catapultCharged=function(){this.puffCount=1,this.puffIntensity=.5},u.prototype.catapultTrigger=function(){this.puffCount=8,this.puffIntensity=1},u.prototype.catapultPassive=function(){this.puffCount=1,this.puffIntensity=.2},u.prototype.setCatapultIntensity=function(e){this.puffIntensity=e},u.prototype.updateCatapult=function(){for(var t=0;t<this.puffCount;t++)if(Math.random()<this.puffIntensity){this.calcLifespan(),s.set(this.posOffset),o.set(this.boat.entity.spatial.pos),n.applyRotationToVelocity(this.boat.entity.geometries[0],s),o.addv(s),s.set(0,0,this.catapultData.length*Math.random());var r=this.boat.entity.spatial.rot.toAngles();r.add(this.catapultData.rot),this.rotOffset.fromAngles(r.x,r.y,r.z),this.rotOffset.applyPost(s),o.add(s),s.set(0,1,0),e.emit("playVaporEffect",{pos:o,vel:s,effectData:this.effectData})}},u}),define("game/ships/Flag",["3d/GooJointAnimator"],function(e){var t=function(e,t){this.boat=e,this.baseBone=t.baseBone,this.flapBone=t.flapBone,this.flapFreq=t.flapFreq,this.direction=0,this.posY=0};return t.prototype.updateFlag=function(){this.direction+=this.flapFreq*.02,e.updateEntityBoneRotX(this.boat,this.baseBone,.3*Math.sin(this.direction+Math.cos(this.direction*.5))),e.updateEntityBoneRotX(this.boat,this.flapBone,.6*Math.sin(this.direction+(.5+Math.cos(this.direction*.4)*.4)))},t}),define("game/ships/BoatFactory",["application/EventManager","game/ships/Boat","game/ships/Helmsman","game/ships/ShipsCaptain","game/weapons/Turret","game/ships/Chimney","game/ships/Radar","game/ships/CarrierCable","game/ships/Catapult","game/ships/Flag"],function(e,t,n,r,i,s,o,u,a,f){var l=function(e,t){e.turrets=[];for(var n=0;n<t.turrets.length;n++)e.turrets.push(new i(e,t.turrets[n]))},c=function(e,t){e.chimneys=[];for(var n=0;n<t.chimneys.length;n++)e.chimneys.push(new s(e,t.chimneys[n]))},h=function(e,t){e.radars=[];for(var n=0;n<t.radars.length;n++)e.radars.push(new o(e,t.radars[n]))},p=function(e,t){e.flags=[];for(var n=0;n<t.flags.length;n++)e.flags.push(new f(e,t.flags[n]))},d=function(e,t){e.catapults=[];if(t.catapults)for(var n=0;n<t.catapults.length;n++)e.catapults.push(new a(e,t.catapults[n]))},v=function(e,t){e.helmsman=new n(e)},m=function(e,t){var n={};for(var r=0;r<t.physicalShapes.length;r++)t.physicalShapes[r].partId=="cable"&&(n[t.physicalShapes[r].cableNr]=new u(e,t.physicalShapes[r].cableNr));e.entity.cables=n},g=function(e,n,i){var s=function(e){l(e.entity,n),c(e.entity,n),h(e.entity,n),p(e.entity,n),v(e,n),m(e,n),d(e,n),new r(e),i(e)};new t(e,n,s)};return{buildShip:g}}),define("game/parts/Display",["application/EventManager","goo/renderer/Texture"],function(e,t){var n=function(e,t,n){return this.id=e,this.mapcoords=t,this.materialMap=n,this.materialMap.ctx.globalCompositeOperation="source-over",this.intensity=1,this.instruments={},this};return n.prototype.setIntensity=function(e){this.intensity=e},n.prototype.attenuate=function(e){var t=this.mapcoords,n=this.materialMap.ctx,r=1-(this.intensity*e+Math.random()*.03);n.fillStyle="rgba(0, 0, 0, "+r+")",n.fillRect(t[0]-t[2]*.5,t[1]-t[3]*.5,t[2],t[3]),this.materialMap.emissiveMap.setNeedsUpdate()},n.prototype.registerInstrument=function(e,t){this.instruments[e]=t},n.prototype.updateInstruments=function(){for(var e in this.instruments)this.instruments[e].updateInstrument()},n}),define("game/parts/ScreenSystem",[],function(){var e=function(e){this.entity=e,this.displays={},this.masterIntensity=1};return e.prototype.addDisplay=function(e){if(this.displays[e.id])return;this.displays[e.id]=e},e.prototype.setMasterIntensity=function(e){this.masterIntensity=e},e.prototype.attenuateIntensity=function(){var e=!1;for(var t in this.displays)e||(this.displays[t].materialMap.ctx.globalCompositeOperation="source-over",e=!0),this.displays[t].attenuate(this.masterIntensity)},e.prototype.updateDisplays=function(){var e=!1;for(var t in this.displays)e||(this.displays[t].materialMap.ctx.globalCompositeOperation="lighter",e=!0),this.displays[t].updateInstruments()},e}),define("game/instruments/HudLadder",[],function(){function t(e,t){var n=t.txcoords,r=t.display.materialMap.emitImg,i=t.display.materialMap.ctx,s=n[0],o=n[1],u=e.instruments.horizon.getValue();if(!u)return;var a=e.instruments.roll_indicator.getValue()*e.instruments.roll_indicator.axisAmp;i.translate(s,o),i.rotate(a);var f=200,l=16,c=f*u.data[2],h=5,p=Math.ceil(c/(l*.5));for(var d=p;d<h+p;d++){var v=c-l*(d-h*.5),m=c-l*(d+p*.5-h*.5);if(Math.abs(m)<l*.5)var g=t.sources.flat;else if(m<0)var g=t.sources.up;else var g=t.sources.down;var y=c+v;i.drawImage(r,g[0],g[1],g[2],g[3],-g[2]*.5,y-g[3]*.5,g[2],g[3])}i.rotate(-a),i.translate(-s,-o);var g=t.sources.origin;i.drawImage(r,g[0],g[1],g[2],g[3],s-g[2]*.5,o-3-g[3]*.5,g[2],g[3])}var e=function(e,t,n){return this.entity=e,this.display=t,this.txcoords=n.txcoords,this.sources=n.sources,this};return e.prototype.updateInstrument=function(){t(this.entity,this)},e}),define("game/instruments/VdiLadder",[],function(){function t(e,t){var n=t.txcoords,r=t.display,i=t.display.materialMap.emitImg,s=t.display.materialMap.ctx,o=.15+Math.random()*.25,u=35+Math.random()*10;s.fillStyle="rgba(5, "+Math.floor(u)+", 5, "+o+")",s.fillRect(n[0]-n[2]*.5,n[1]-n[3]*.5,n[2],n[3]);var a=n[0],f=n[1],l=e.instruments.horizon.getValue();if(!l)return;var c=e.instruments.roll_indicator.getValue()*e.instruments.roll_indicator.axisAmp;s.translate(a,f),s.rotate(c);var h=200,p=35,d=h*l.data[2],v=7,m=Math.ceil(d/(p*.5)),g=!0;for(var y=m;y<v+m;y++){var b=d-p*(y-v*.5),w=d-p*(y+m*.5-v*.5),E=d+b;if(Math.abs(w)<p*.5){var S=t.sources.flat;s.fillStyle="rgba(0, 15, 0, 0.55)";var E=d+b,x=[n[0]-n[2]*.5,n[1]+n[3]*.5,n[2],n[3]];s.fillRect(-x[2]*.5-30,-x[3]*.5-.5,x[2]+60,x[3]*.5+E*1),s.drawImage(i,S[0],S[1],S[2],S[3],-S[2]*.8,E-S[3]-.5,S[2]*1.6,S[3]),g=!1}else if(w<0){var S=t.sources.up;s.drawImage(i,S[0],S[1],S[2],S[3],-S[2]*.5,E-S[3]*.5,S[2],S[3])}else{g=!1;var S=t.sources.down;s.drawImage(i,S[0],S[1],S[2],S[3],-S[2]*.5,E-S[3]*.5,S[2],S[3])}}s.rotate(-c),s.translate(-a,-f),S=t.sources.origin,s.drawImage(i,S[0],S[1],S[2],S[3],a-S[2]*.5,f+5-S[3]*.5,S[2],S[3]),S=t.sources.o_line,s.drawImage(i,S[0],S[1],S[2],S[3],a-n[2]*.5+18,f+4-S[3]*.5,S[2],S[3]),s.drawImage(i,S[0],S[1],S[2],S[3],a+n[2]*.5-40,f+4-S[3]*.5,S[2],S[3]),g&&s.fillRect(n[0]-n[2]*.5,n[1]-n[3]*.5,n[2],n[3])}var e=function(e,t,n){return this.entity=e,this.display=t,this.txcoords=n.txcoords,this.sources=n.sources,this};return e.prototype.updateInstrument=function(){t(this.entity,this)},e}),define("game/parts/CanvasDigit",[],function(){function i(r,i,s){e=r,t=i,n=s}function s(t){return e[t]}function o(e,i,o){for(var u=0;u<e.length;u++)r=s(e[u]),n.drawImage(t,r[0],r[1],r[2],r[3],u*6+i-r[2]*.5,-3+o-r[3]-.5,r[2],r[3])}var e,t,n,r;return{setSourceData:i,drawNumberToContextCoordinate:o}}),define("game/instruments/CompassTape",["game/parts/CanvasDigit"],function(e){var t=function(e,t,n){return this.entity=e,this.display=t,this.data=n,this.txcoords=n.txcoords,this.sources=n.sources,this.coordX=this.data.txcoords[0],this.coordY=this.data.txcoords[1],this.img=this.display.materialMap.emitImg,this.ctx=this.display.materialMap.ctx,this};return t.prototype.updateInstrument=function(){this.updateCompassTape(this.entity.instruments.gyro_compass.getValue())},t.prototype.updateCompassTape=function(t){var n=115,r=24,i=n*-t,s=this.data.lines,o=Math.ceil(i/(r*.5));e.setSourceData(this.sources,this.img,this.ctx);var u=0;for(var a=o;a<s+o;a++){var f=i-r*(a-s*.5),l=i-r*(a+o*.5-s*.5),c=this.sources.dots,h=i+f;this.ctx.drawImage(this.img,c[0],c[1],c[2],c[3],this.coordX+h-c[2]*.5,this.coordY-c[3]-.5,c[2],c[3]);var p=""+Math.abs(Math.round(l*3)*10);u<s-1&&u!=0&&(p=="0"&&(p="00"),e.drawNumberToContextCoordinate([p[0],p[1]],this.coordX-4+h,-3+this.coordY)),u+=1}},t}),define("game/instruments/HsiRotation",[],function(){function t(e,t){var n=t.data.txcoords,r=t.display.materialMap.emitImg,i=t.display.materialMap.ctx,s=.15+Math.random()*.25,o=35+Math.random()*10;i.fillStyle="rgba(5, "+Math.floor(o)+", 5, "+s+")",i.fillRect(n[0]-n[2]*.5,n[1]-n[3]*.5,n[2],n[3]);var u=n[0],a=n[1];i.translate(u,a);var f=t.data.sources.circles;i.drawImage(r,f[0],f[1],f[2],f[3],-f[2]*.5,-f[3]*.5,f[2],f[3]),i.translate(-u,-a)}var e=function(e,t,n){return this.entity=e,this.display=t,this.data=n,this.txcoords=n.txcoords,this.sources=n.sources,this};return e.prototype.updateInstrument=function(){t(this.entity,this)},e}),define("game/instruments/ScreenDigits",["game/parts/CanvasDigit"],function(e){var t=function(e,t,n){return this.entity=e,this.display=t,this.data=n,this.txcoords=n.txcoords,this.coordX=this.data.txcoords[0],this.coordY=this.data.txcoords[1],this.sources=n.sources,this.img=this.display.materialMap.emitImg,this.ctx=this.display.materialMap.ctx,this};return t.prototype.sampleSourceValue=function(){return this.entity.instruments[this.data.sourceValue].getValue()},t.prototype.updateScreenDigits=function(t){if(t<1)return;e.setSourceData(this.data.sources,this.img,this.ctx),e.drawNumberToContextCoordinate(""+Math.round(t),this.coordX,this.coordY)},t.prototype.updateInstrument=function(){this.updateScreenDigits(this.sampleSourceValue())},t}),define("game/instruments/RulerGauge",[],function(){function t(e,t){var n=e.data.txcoords,r=e.display.materialMap.emitImg,i=e.display.materialMap.ctx,s=n[0],o=n[1],u=e.data.scaleFactor,a=u*-t,f=e.data.sources.ruler;i.drawImage(r,f[0],f[1],f[2],f[3],s-f[2]*.5,o-f[3]*.5,f[2],f[3]);var l=a,c=e.data.sources.arrow;i.drawImage(r,c[0],c[1],c[2],c[3],s+e.data.xOffset-c[2]*.5,o+l-c[3]*.5,c[2],c[3])}var e=function(e,t,n){return this.entity=e,this.display=t,this.data=n,this.txcoords=n.txcoords,this.sources=n.sources,this};return e.prototype.sampleSourceValue=function(){return this.entity.instruments[this.data.sourceValue].getValue()},e.prototype.updateInstrument=function(){t(this,this.sampleSourceValue())},e}),define("game/instruments/VideoPlayer",["application/EventManager"],function(e){function n(e){var t=e.data.txcoords,n=e.video,r=e.display.materialMap.ctx,i=t[0],s=t[1],o=e.data.sources.video,u=n.videoWidth,a=n.videoHeight,f=u/a,l=i-t[2]*.5,c=s-t[3]*.5,h=t[2],p=t[3]/f,d=t[3]-p;c+=d*.5,r.drawImage(n,o[0],o[1],u,a,l,c,h,p)}var t=function(t,n,r){this.entity=t,this.display=n,this.data=r,this.txcoords=r.txcoords,this.sources=r.sources;var i=function(t){e.eventArgs(t).channel==this.data.channel&&this.streamVideoSource(e.eventArgs(t).source)}.bind(this);return e.registerListener(e.list().BROADCAST_VIDEO,i),this};return t.prototype.streamVideoSource=function(e){this.active&&this.stopVideo();var t=document.createElement("video");t.width=128,t.height=128;var n=function(){this.stopVideo()}.bind(this);t.addEventListener("ended",function(){n()}),this.video=t,this.active=!0,this.video.src=e,this.video.play(),this.video.volume=.01},t.prototype.stopVideo=function(){this.active=!1,this.video.pause(),this.video=null},t.prototype.sampleSourceValue=function(){return this.entity.instruments[this.data.sourceValue].getValue()},t.prototype.updateInstrument=function(){this.active?n(this):Math.random()<.004&&this.streamVideoSource(this.data.video)},t}),define("game/instruments/InstrumentScripts",["game/instruments/HudLadder","game/instruments/VdiLadder","game/instruments/CompassTape","game/instruments/HsiRotation","game/instruments/ScreenDigits","game/instruments/RulerGauge","game/instruments/VideoPlayer"],function(e,t,n,r,i,s,o){var u=function(t,n,r){return new e(t,n,r)},a=function(e,n,r){return new t(e,n,r)},f=function(e,t,r){return new n(e,t,r)},l=function(e,t,n){return new r(e,t,n)},c=function(e,t,n){return new i(e,t,n)},h=function(e,t,n){return new s(e,t,n)},p=function(e,t,n){return new o(e,t,n)};return{HudLadder:u,VdiLadder:a,CompassTape:f,HsiRotation:l,ScreenDigits:c,RulerGauge:h,VideoPlayer:p}}),define("game/parts/Screens",["application/EventManager","goo/renderer/Texture","game/parts/Display","game/parts/ScreenSystem","game/instruments/InstrumentScripts"],function(e,t,n,r,i){function c(e,t,n){if(!t.length)return;var i={};e.screens=i,e.screenMaterialMap=h(e,n),e.screenSystem=new r(e),console.log("Register entity screens: ",e,t);for(var o=0;o<t.length;o++){s+=1;var u=t[o],a=u.id;e.screenSystem.displays[a]||l(e,a,u)}}function h(e,n){var r=e.geometries[0].transformComponent.children;for(var i=0;i<r.length;i++){var s=r[i].entity;for(var o=0;o<n.length;o++)if(s.name==n[o].meshEntityName){var u=s.meshRendererComponent.materials;s.meshRendererComponent.isReflectable=!1;for(var a=0;a<u.length;a++)if(u[a]._textureMaps.EMISSIVE_MAP&&u[a]._textureMaps.EMISSIVE_MAP.image){console.log(u[a].name);var f,l,c;e.lights&&e.lightsMaterialMap.meshEntity.name==s.name&&(l=e.lightsMaterialMap.canvas,f=e.lightsMaterialMap.emitImg,c=e.lightsMaterialMap.emissiveMap),l||(f=u[a]._textureMaps.EMISSIVE_MAP.image,l=document.createElement("canvas"),l.id=s.name+"_canvas",l.width=f.naturalWidth,l.height=f.naturalHeight,l.dataReady=!0,c=new t(l,null,l.width,l.height),u[a].setTexture("EMISSIVE_MAP",c));var h={meshRef:s.name,meshEntity:s,material:u[a],emissiveMap:c,diffuseMap:u[a]._textureMaps.DIFFUSE_MAP,emitImg:f,canvas:l,ctx:l.getContext("2d")};return h}}}}function p(e){if(!e.instruments)return;e.screenSystem.updateDisplays(),e.screenSystem.attenuateIntensity()}var s=0,o={},u={},a={},f=function(e){return u[e]},l=function(e,t,r){var s=new n(t,r.mapcoords,e.screenMaterialMap);u[r]=s;for(var o=0;o<r.instruments.length;o++){var a=r.instruments[o];a.script&&s.registerInstrument(a.id,i[a.script](e,s,a))}e.screenSystem.addDisplay(s)};return{registerEntityScreens:c,getDisplay:f,updateEntityScreenState:p}}),define("game/piece/PieceConfigurator",["data_pipeline/PipelineAPI","gui/layout/GuiConstants","game/ControlsController","game/controls/ControlStateCallbacks","game/parts/Screens","game/parts/Lights","game/player/PlayerInstruments"],function(e,t,n,r,i,s,o){var u=function(){},a=7;return u.applyModelRelatedConfigs=function(e,t){var n=e.entity.pieceData.configs.display_settings},u.applyConfigData=function(r,u,f,l){var c=r.entity.pieceData.configs.control_settings,h=r.entity.pieceData.configs.control_surfaces,p=r.entity.pieceData.configs.wing_shapes,d=r.entity.pieceData.configs.piece_systems,v=r.entity.pieceData.configs.display_settings,m=r.entity.pieceData.configs.light_systems,g=r.entity.pieceData.configs.instruments;console.log("Apply config to piece: ",u,r);var y=!1,b=function(e){console.log("Applied ",e),a--,a==0&&(r.entity.pieceInput.applySystemConfigs(r.configs[c]),l())};u[g]&&(r.configs[g]=u[g],o.initInstruments(r.entity,u[g],u.instrument_curves),b(g)),u[m]&&(r.configs[m]=u[m],s.registerEntityLights(r.entity,u[m],u.meshData,u.patterns),b(m)),u[v]&&(r.configs[v]=u[v],i.registerEntityScreens(r.entity,u[v],u.meshData),b(c)),u[c]&&(r.configs[c]=u[c],b(c)),u[h]&&(r.configs[h]=u[h],n.addSurfacesToEntity(r.entity,u[h]),b(h)),u[d]&&(r.configs[d]=u[d],n.addSystemsToEntity(r.entity,u[d],f),b(d));if(u[p]){r.configs[p]=u[p];var w=function(e,n){var i=t.clone(u[p]),s=t.clone(n);r.addWings(i,s),b(p)};e.subscribeToCategoryKey("game_data","aerodynamic_curves",w)}},u.configurePiece=function(t,n,r){t.configs={};var i=function(){r()},s=function(e,r){console.log("Apply :: ",e,r),u.applyConfigData(t,r,n,i)};for(var o=0;o<t.entity.pieceData.configs.dataKeys.length;o++)console.log("PieceSubscribe to: ",t.entity.pieceData.configs.dataKeys[o]),e.subscribeToCategoryKey("piece_data",t.entity.pieceData.configs.dataKeys[o],s)},u}),define("game/piece/PieceInput",["goo/math/MathUtils","game/controls/ControlStateCallbacks"],function(e,t){var n=function(e,t){this.data={},this.min=-1,this.max=1,this.control=e,this.onChange=t||function(){console.log("Control has no callback: ",this.id)},this.value=0,this.inputState=0,this.appliedState=0,this.update=!1};n.prototype.applyConfig=function(e){this.data=e,this.min=e.range.min,this.max=e.range.max,e.default&&(this.value=e.default,this.inputState=e.default,this.appliedState=e.default,this.update=!0)},n.prototype.setInputAmount=function(t){t=e.clamp(t,this.min,this.max),t==undefined&&(t=0),this.value=t,this.inputState=t,this.update=!0};var r=function(){this.controls={}};return r.prototype.addPieceControl=function(e){this.controls[e]=new n(e,t.getControlUpdateCallback(e))},r.prototype.registerOnChangeCallback=function(e,t){this.controls[e].onChange=t},r.prototype.setInputState=function(e,t){this.controls[e]&&this.controls[e].setInputAmount(t)},r.prototype.getInputState=function(e){return this.controls[e].inputState},r.prototype.setAppliedState=function(e,t){this.controls[e].appliedState=t},r.prototype.getAppliedState=function(e){return this.controls[e].appliedState},r.prototype.readControlValue=function(e){return this.controls[e].value},r.prototype.triggerUpdate=function(e){this.controls[e]&&(this.controls[e].update=!0)},r.prototype.applySystemConfigs=function(e){for(var t=0;t<e.length;t++)this.controls[e[t].control]||this.addPieceControl(e[t].control),this.controls[e[t].control].applyConfig(e[t])},r}),define("game/parts/Vehicle",["game/world/PhysicalWorld","application/EventManager","3d/GooJointAnimator"],function(e,t,n){var r=function(e){this.id=e};return r.prototype.attachGooEntity=function(e){this.entity.geometries[0]&&this.entity.geometries[0].removeFromWorld(),this.entity.geometries[0]=e,this.entity.geometries[0].addToWorld(),n.printClipInitialTransform(this.entity),this.entity.spatial.velocity.data[2]=.3*(Math.random()-.5),this.entity.spatial.velocity.data[0]=.3*(Math.random()-.5),this.vehicleReady(this.entity)},r.prototype.attachEntity=function(n,r){this.entity=n,this.entity.pieceData=r,this.entity.combat.hitPoints=r.hitPoints,this.entity.pieceData=r,e.registerPhysicalEntity(this.entity),this.entity.combat.destroyed=function(e){};var i=function(e){this.attachGooEntity(e)}.bind(this);console.log("Build Piece: ",this.entity.pieceData),t.fireEvent(t.list().BUILD_GOO_GAMEPIECE,{projPath:this.entity.pieceData.gooProjectUrl,modelPath:this.entity.pieceData.modelPath,callback:i})},r.prototype.applyPieceData=function(e,n){this.vehicleReady=n;var r=function(t){this.attachEntity(t,e)}.bind(this);t.fireEvent(t.list().ADD_GAME_ENTITY,{entityId:this.id,callback:r})},r}),define("game/gameConfiguration",[],function(){return{GAME_IDENTITY:{title:"Tunnan & Friends",tagLine:"Early test version for you to fly"},WORLD_PROPERTIES:{gravity:[0,-9.81,0],newton:9.81,speedOfSound:340.29},PLAYER_INIT:{startSpatial:{pos:[342,18.2,2880],vel:[0,1e-4,0],rot:[0,Math.PI*.5,0]},landingStrip:{pos:[2861,15,2388]},approach:{pos:[650,620,1e3]},stratosphere:{pos:[-1050,35690,3e3]},battle:{pos:[2750,820,2310]}},AERODYNAMICS:{airMassDensity:1.229,densityPerMeter:8e-5,kelvinsAtSeaLevel:288,kelvinDropByMeterUp:.0065,seaLevelPressure:1.01,gasConstant:8.3,airMolarMass:.0289644},RENDER_SETUP:{targetFPS:60,physicsFPS:100},GAME_SETTINGS:{soundDisable:{values:[0,1],loadIndex:1}},INTRO:{containerId:"intro",stages:[{id:"intro_1",time:2e3},{id:"intro_2",time:1e3},{id:"intro_3",time:1e3}]},MIX_TRACKS:{game:{id:"Game",spatial:!0,settingGain:"sound_game",settingFxSend:"sound_fx_game"},ambient:{id:"Ambient",spatial:!1,settingGain:"sound_ambient",settingFxSend:"sound_fx_ambient"},ui:{id:"UI",spatial:!1,settingGain:"sound_ui",settingFxSend:"sound_fx_ui"},music:{id:"Music",spatial:!1,settingGain:"sound_music",settingFxSend:"sound_fx_music"}},PRELOAD_IMAGES:[],PRELOAD_GOO_MATERIALS:{},PRELOAD_GOO_MESHES:{},GOO_PROJECTS:{tunnan:{folder:"tunnan_f",projectPath:"bundles",entityIds:{tunnan:"tunnan_f"}},human:{folder:"pilot_animated",projectPath:"bundles",entityIds:{pilot:"pilot_bind_AO"}},tomcat:{folder:"tomcat",projectPath:"bundles",entityIds:{tomcat_skinned:"TomcatSkinned"}},environment:{folder:"environment",projectPath:"bundles",entityIds:{skybox:"Default Environment",effects:"Post effects"}},carrier:{folder:"carrier",projectPath:"bundles",entityIds:{carrier:"carrier"}},car_pv_9031:{refFile:"pv_9031.bundle",projectPath:"bundles",pv_9031:"pv_9031"},cougar_f9f:{refFile:"cougar_f9f.bundle",projectPath:"bundles",cougar_f9f:"cougar_f9f"},stratofortress:{refFile:"stratofortress.bundle",projectPath:"bundles",b_52:"b_52"},draken:{refFile:"draken.bundle",projectPath:"bundles",draken:"draken"},tre_kronor:{refFile:"tre_kronor.bundle",projectPath:"bundles",tre_kronor:"tre_kronor"},battleship:{refFile:"battleship.bundle",projectPath:"bundles",battleship:"battleship_skinned"},nature:{folder:"nature",projectPath:"bundles",entityIds:{tree_leafy:"tree_leafy_30m",tree_40:"tree_leafy_40m",tree_leafy_small:"tree_leafy_small",rock_mossy:"rock_mossy",rock_plain:"rock_plain",rock_tiny:"rock_tiny"}},houses:{refFile:"houses.bundle",projectPath:"bundles",hangar_building:"hangar_building",seventeen_big_floors:"17_big_floors",seventeen_floor:"17_floors",ten_floors:"10_floors",cube_22:"cube_22",air_tower:"air_tower",cottage:"cottage"},targets:{refFile:"targets.bundle",projectPath:"bundles",ground_flat:"ground_flat",house_box_3:"house_box_3"},house_t:{refFile:"house_T.bundle",projectPath:"bundles",house_t:"house_T"},air_base:{refFile:"air_base.bundle",projectPath:"bundles",base:"base",roof:"roof",lockers:"lockers",lamps:"lamps"},hilltop_base:{refFile:"hilltop_base.bundle",projectPath:"bundles",base:"hilltop_base",roof:"hilltop_roof",lamps:"hilltop_lights",lamps_inner:"hilltop_lights_inner"},harbor:{refFile:"harbor.bundle",projectPath:"bundles",base:"harbor_base"},elevator:{refFile:"elevator.bundle",projectPath:"bundles",base:"elevator_base",roof:"elevator_roof"},top_base:{refFile:"top_base.bundle",projectPath:"bundles",base:"top_base",roof:"top_base_roof"},tv_screen:{refFile:"tv_monitors.bundle",projectPath:"bundles",tv:"tv_crt",tv_2:"tv_2",tv_3:"tv_3"},monitor_console:{refFile:"monitor_console.bundle",projectPath:"bundles",monitor_console:"monitor_console"},armaments:{refFile:"armaments.bundle",projectPath:"bundles",bomb_200kg:"bomb_200kg",rocket_7cm:"rocket_7cm",rocket_18cm:"rocket_18cm"},bullet_20:{refFile:"project.project",projectPath:"bullet_project",piecePath:"bullet_red"}},VIDEOS:{sources:{hsi:{funnyCat:"resources/video/funny_cat_352x240.mp4",cuteCat:"resources/video/cute_cat_320x240.mp4",angryCat:"resources/video/angry_cat_screams_at_enemy_cat_640x360.mp4"},vdi:{tunnanPromo:"resources/video/tunnan_short.mp4",marineAd:"resources/video/united_states_marine_corps_640x480.mp4",jetEngine:"resources/video/jet_engine_-_cinema_4d_animation_640x360.mp4"},hud:{memorial:"resources/video/the_collings_foundation_vietnam_memorial_flight.__f-4_phantom_a-4_skyhawk_uh-1_huey_480x240.mp4",dayTrap:"resources/video/day_trap_aboard_the_jfk_640x480.mp4",carrierOps:"resources/video/aircraft_carrier_operation_640x360.mp4"},cats:{funnyCat:"resources/video/funny_cat_352x240.mp4",cuteCat:"resources/video/cute_cat_320x240.mp4",angryCat:"resources/video/angry_cat_screams_at_enemy_cat_640x360.mp4"},promos:{tunnanPromo:"resources/video/tunnan_short.mp4",marineAd:"resources/video/united_states_marine_corps_640x480.mp4",jetEngine:"resources/video/jet_engine_-_cinema_4d_animation_640x360.mp4"},military:{memorial:"resources/video/the_collings_foundation_vietnam_memorial_flight.__f-4_phantom_a-4_skyhawk_uh-1_huey_480x240.mp4",dayTrap:"resources/video/day_trap_aboard_the_jfk_640x480.mp4",carrierOps:"resources/video/aircraft_carrier_operation_640x360.mp4"},history:{strangelove:"resources/video/dr._strangelove_-_ending_640x384.mp4",submarine:"resources/video/submarine_480x272.mp4",bomber:"bomber_480x270.mp4"},animals:{alaska:"resources/video/alaska_mammals_tour_640x350.mp4",frogYear:"resources/video/year_of_the_frog_campaign_568x320.mp4",unFrog:"resources/video/un_frog_640x272.mp4"},planes:{blackbird:"resources/video/sr-71_blackbird_-_the_worlds_fastest_and_highest_flying_aircraft_(jet)_-_youtube_640x480.mp4"},doge:{moonLaunch:"shopdoge.com-_dogecoin_moon_launch_hd__________much_trust_must_doge_640x358"}},channels:{vdi:"vdi",cats:"cats",animals:"animals",promos:"promos",military:"military",history:"history",planes:"planes"}},PRELOAD_GOO_TEXTURES:{splash_particle:"images/particles/splash.png",shockwave_particle:"images/particles/shockwave.png",fieldring_particle:"images/particles/fieldring.png",spark_particle:"images/particles/spark.png",dot_particle:"images/particles/dot.png",foam_particle:"images/particles/water_foam.png",smoke_particle:"images/particles/smoke.png"},PRELOAD_GOO_SHADERS:{},KEY_BINDINGS:{plane:{cannons:["1",32],throttleUp:["R",107],throttleDown:["F",109],pitchUp:["S",40],pitchDown:["W",38],rollLeft:["A",37],rollRight:["D",39],yawLeft:["Q"],yawRight:["E"],canopy:["C"],gears:["G"],breaksOn:["B"],breaksOff:["V"],flapsDown:["X"],flapsUp:["Z"],eject:["P"],trimPitchUp:["K"],trimPitchDown:["I"],trimRollLeft:["J"],trimRollRight:["L"],trimYawLeft:["U"],trimYawRight:["O"]},car:{breaksOn:["B","X"],breaksOff:["V","Q"],throttleUp:["W",107],throttleDown:["S",109],yawLeft:["A",37],yawRight:["D",39]},move:{forward:["W",38],back:["S",40],turnleft:["A",37],turnright:["D",39],strafeModifier:["-"],jump:[" ","E"]},carrier:{}}}}),define("physics/ShapePhysics",[],function(){var e=function(e,t,n){var r=n.stallAngle[0],i=n.stallLiftCoeff[0],s=i/r,o=Math.PI*t*s;return t>r&&(o=i/2),t<-r&&(o=-i/2),o*.5},t=function(e,t){if(!t.controlId)return;var n=t.rot.toAngles(),r=0;e[t.controlId].trimState&&(r=e[t.controlId].trimState);var i=e[t.controlId].currentState*Math.abs(e[t.controlId].currentState)+r,s=t.controls[t.controlId];t.frameRot.fromAngles(i*s[0]+n.data[0],i*s[1]+n.data[1],i*s[2]+n.data[2])},n=function(e,t){var n=e.sourceData.size[0]*e.sourceData.size[2];return n*Math.abs(t)},r=function(e,t){var n=-Math.abs(e*.05*t);return n*.01},i=function(e,t){return t>e*2&&(t=e*2),1/3*Math.PI*t*t*(3*e-t)},s=function(e,t){return Math.cos(e-t)},o=function(e,t,n){return Math.sin(e+t)*Math.sin(n)},u=function(e,t){},a=function(e,t,n){},f=function(e,t,n,r){n*=1/e,n>e*1.3&&(n=e*1.3),n<-e*.6&&(n=-e*.6);var i=(.0077+14.7*n+8.6*n*n+ -20.35*n*n*n)/8;return i*=t,i},e=function(e,t,n){return f(n.stallAngle[0],n.stallLiftCoeff[0],t)},l=function(e){return 4/3*Math.PI*e*e*e},c=function(e){return Math.pow(e*.75/Math.PI,1/3)};return{calcSurfaceAxisAngleOfAttack:o,volumeToApproxRadius:c,calcSphereDisplacement:i,calcPlaneFaceExposureAtAngle:s,calcRadiusToVolume:l,applyStallCurve:f}}),define("game/planes/PlaneWing",["application/EventManager","game/gameConfiguration","physics/ShapePhysics","goo/entities/components/ScriptComponent","goo/math/Vector3","game/GameUtil","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r,i,s,o,u){function O(e,t,r){this.wingId=t.id,this.worldPos=null,this.entity=e,this.sourceData=t,this.controlIds=[],this.controls={};for(var s in t.controls)this.controls[s]=new i(t.controls[s]);this.pos=new i(t.pos),this.size=new i(t.size),this.volume=this.size.data[0]*this.size.data[1]*this.size.data[2],this.approxRadius=n.volumeToApproxRadius(this.volume),this.maxLoad=this.entity.pieceData.dimensions.massMax*this.volume/10,this.rot=new o,this.rot.fromAngles(t.rot[0],t.rot[1],t.rot[2]),this.frameRot=this.rot.clone(),this.force=new i(0,0,0),this.drag=new i(0,0,0),this.formDragCoeff=t.formDragCoeff,this.liftCurve=t.liftCurve,this.stallLiftCoeff=t.stallLiftCoeff,this.angleOfAttack=0,this.angleOfAttackYaw=0,this.dragAmount=0,this.controlSurfaces={},this.waterForce=0,this.integrity=1,this.destroyed=!1,this.lastFrameForce=new i}var a,f,l,c,h=new i,p=new i,d=new i,v=new i,m=new o,g,y,b,w,E,S,x,T,N,C,k,L,A;return O.prototype.visualize=function(){var t=this;if(t.debugGeometry){for(var n=0;n<t.debugGeometry.length;n++)t.debugGeometry[n].removeFromWorld();delete t.debugGeometry;return}var s=[.5+Math.sin(this.pos[0]*.5),.5+Math.sin(this.pos[1]*.5),.5+Math.sin(this.pos[2]*.5)];t.debugGeometry=[];var u=t.frameRot,a=t.force,t=t,f=new i;f.seta([1,1,1]);var l=function(n){t.debugGeometry.push(n);var u=function(e){console.log(e),t.debugGeometry.push(e),e.setComponent(new r({run:function(t){var r=a.clone();r.data[0]=.05+a.data[0]*.2,r.data[1]=.05,r.data[2]=.05;var s=new i;e.transformComponent.transform.scale.setv(r);var s=r.clone();s.data[0]=s.data[0]/2,t.transformComponent.transform.translation.setv(s),n.transformComponent.setUpdated(),t.transformComponent.setUpdated()}}))},l=function(e){console.log(e),t.debugGeometry.push(e),e.setComponent(new r({run:function(t){var r=a.clone();r.data[0]=.05,r.data[1]=.05+a.data[1]*.1,r.data[2]=.05;var s=new i;e.transformComponent.transform.scale.setv(r);var s=r.clone();s.data[1]=s.data[1]/2,t.transformComponent.transform.translation.setv(s),n.transformComponent.setUpdated(),t.transformComponent.setUpdated()}}))},c=function(e){t.debugGeometry.push(e),e.setComponent(new r({run:function(t){var n=a.clone();n.data[0]=.05,n.data[1]=.05,n.data[2]=.05+a.data[2]*.5,e.transformComponent.transform.scale.setv(n);var r=n.clone();r.data[2]=r.data[2]/2,t.transformComponent.transform.translation.setv(r),t.transformComponent.transform.lookAt(n,i.UNIT_Y),t.transformComponent.setUpdated()}}))};e.fireEvent(e.list().BUILD_GOO_PRIMITIVE,{parentGooEntity:n,shape:"Box",pos:new i(0,0,0),rot:new o,size:f,color:s,callback:u}),e.fireEvent(e.list().BUILD_GOO_PRIMITIVE,{parentGooEntity:n,shape:"Box",pos:new i(0,0,0),rot:new o,size:f,color:s,callback:l}),e.fireEvent(e.list().BUILD_GOO_PRIMITIVE,{parentGooEntity:n,shape:"Box",pos:new i(0,0,0),rot:new o,size:f,color:s,callback:c})},c=function(e){var n=t.frameRot;e.wing=t,t.debugGeometry.push(e),e.setComponent(new r({run:function(e){t.destroyed&&(e.transformComponent.transform.scale.set(.5),e.transformComponent.setUpdated());if(!t.controlIds.length)return;e.transformComponent.transform.rotation=e.wing.frameRot,e.transformComponent.setUpdated()}})),e.transformComponent.setUpdated()};e.fireEvent(e.list().BUILD_GOO_PRIMITIVE,{parentGooEntity:t.entity.geometries[0],shape:"Box",pos:this.pos,rot:this.rot,size:this.size,color:[s[0]*.6,s[1]*.6,s[2]*.6],callback:c}),e.fireEvent(e.list().BUILD_GOO_PRIMITIVE,{parentGooEntity:t.entity.geometries[0],shape:"Sphere",pos:this.pos,rot:new o,size:new i(.2,.2,.2),color:[s[0]*.3,s[1]*.3,s[2]*.3],callback:l})},O.prototype.addControlSurface=function(e,t){this.controlSurfaces[e]=t},O.prototype.setAoAControl=function(e){this.controlIds.push(e)},O.prototype.attitudeAffectedLift=function(e,t){if(isNaN(t))return console.log("NaN: AoA",this),0;var n=e*s.fitValueInCurve(t,this.liftCurve);return Math.abs(n)>this.maxLoad&&(this.applyDamageToWing(.99),n=0),n},O.prototype.calcAxisLift=function(e){},O.prototype.updateControlledRotation=function(){if(this.controlIds.length==0)return;a=this.rot.toAngles(),c=[0,0,0],l=0,f=0;for(var e=0;e<this.controlIds.length;e++)this.entity.surfaces[this.controlIds[e]].trimState&&(f+=this.entity.surfaces[this.controlIds[e]].trimState),l=f+this.entity.surfaces[this.controlIds[e]].currentState,c[0]+=l*this.controls[this.controlIds[e]][0],c[1]+=l*this.controls[this.controlIds[e]][1],c[2]+=l*this.controls[this.controlIds[e]][2];this.frameRot.fromAngles(c[0]+a.data[0],c[1]+a.data[1],c[2]+a.data[2])},O.prototype.applyDamageToWing=function(t){console.log("Wing Damaged: ",this),e.fireEvent(e.list().ONESHOT_AMBIENT_SOUND,{soundData:e.sound().MAIN_HIT_0,pos:this.worldPos.data,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]}),e.fireEvent(e.list().PUFF_BLACK_SMOKE,{pos:this.worldPos.data,count:2,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),e.fireEvent(e.list().FLASH_MUZZLE_FIRE,{pos:this.worldPos.data,count:2,dir:[.2*(Math.random()-.5),.1+Math.random(),.2*(Math.random()-.5)]}),e.fireEvent(e.list().FLASH_SPARKS,{pos:this.worldPos.data,count:2,dir:[Math.random()-.5,.1+Math.random(),Math.random()-.5]}),this.integrity*=t},O.prototype.applyWaterInfluence=function(t,r){this.entity.spatial.angularVelocity.mul(.9);var i=n.calcSphereDisplacement(this.approxRadius,t);Math.random()<.3&&this.entity.spatial.speed>.1+5.5*Math.random()&&(Math.random()<.2&&e.fireEvent(e.list().SPLASH_RINGLET,{pos:[this.worldPos.data[0],.5,this.worldPos.data[2]],count:1,dir:[0,0,0]}),Math.random()<.15&&e.fireEvent(e.list().SPLASH_FOAM,{pos:[this.worldPos.data[0],.5,this.worldPos.data[2]],count:1,dir:[0,0,0]}),Math.random()<.5&&e.fireEvent(e.list().SPLASH_WATER,{pos:[this.worldPos.data[0],1,this.worldPos.data[2]],count:1,dir:[0,2,0]})),this.entity.spatial.velocity[1]>0&&(this.waterForce*=.75),this.waterForce=u.lerp(.1,this.waterForce,i*r*.1),p.set(0,this.waterForce,0),this.entity.spatial.velocity.mul(.9993),this.force.addv(p)},O.prototype.calcEffectSizeVector=function(e){return e.set((Math.random()-.5)*this.size.data[0]*.6,this.size.data[1]*.5,(Math.random()-.5)*this.size.data[2]*.6),m.set(this.entity.spatial.rot),m.rotateY(this.frameRot.toAngles().data[1]),m.applyPost(e),e},O.prototype.calcEffectPointVector=function(e){return e.set(this.worldPos.data),v=this.calcEffectSizeVector(v),e.add(v),e},O.prototype.applyTurbulence=function(){p=this.calcEffectPointVector(p),d.set(this.entity.spatial.velocity),e.fireEvent(e.list().PUFF_RAPID_WHITE,{pos:p.data,count:1,dir:d.data})},O.prototype.applySoundBarrierFx=function(){p=this.calcEffectPointVector(p),d.set(this.entity.spatial.velocity),e.fireEvent(e.list().PUFF_RAPID_WHITE,{pos:p.data,count:1,dir:d.data})},O.prototype.calcFormDrag=function(){C=this.size.data[1]*this.size.data[0],this.formDragForce=-this.airDensity*C*this.formDragCoeff*(this.airSpeed+this.entity.spatial.angularVelocity.data[1]*this.entity.spatial.angularVelocity.data[1]*this.pos.data[0]+this.entity.spatial.angularVelocity.data[2]*this.entity.spatial.angularVelocity.data[2]*this.pos.data[0]),-this.formDragForce>this.maxLoad&&(this.applyDamageToWing(.99),this.formDragForce=0)},O.prototype.calcInducedDrag=function(e,t){var n=Math.abs(e*.3*t);return n>this.maxLoad&&(this.applyDamageToWing(.99),n=0),-n},O.prototype.calcLiftForces=function(){a=this.frameRot.toAngles(),y=-this.sourceData.rot[2],b=this.entity.spatial.axisAttitudes,L=this.entity.spatial.angularVelocity.data[2],A=this.entity.spatial.angularVelocity.data[0],h.set(b),w=Math.abs(Math.cos(h.data[2]-this.sourceData.rot[2])),E=Math.abs(Math.sin(h.data[1]-this.sourceData.rot[0])),S=Math.abs(Math.cos(h.data[0]-this.sourceData.rot[1])),x=n.calcSurfaceAxisAngleOfAttack(h.data[0],a.data[0],Math.sin(y)),T=n.calcSurfaceAxisAngleOfAttack(h.data[1],a.data[0],Math.cos(y)),this.angleOfAttack=T*1.7,this.angleOfAttackYaw=x*1.7,x-=this.entity.spatial.angularVelocity.data[1]*this.pos.data[2],x+=A*this.pos.data[2],T+=L*this.pos.data[0],T-=this.entity.spatial.angularVelocity.data[0]*this.pos.data[2],T+=this.entity.spatial.angularVelocity.data[1]*this.pos.data[0]/(this.entity.spatial.speed+.001),N=Math.abs(S)*this.size.data[2]*this.size.data[0]*this.airSpeed,this.liftForcePitch=this.airDensity*N*this.attitudeAffectedLift(this.stallLiftCoeff[0],T,this),this.liftForceYaw=this.airDensity*N*this.attitudeAffectedLift(this.stallLiftCoeff[1],x,this),this.inducedLiftDragForce=this.calcInducedDrag(T,this.liftForcePitch),this.inducedYawDragForce=this.calcInducedDrag(x,this.liftForceYaw)},O.prototype.calcSurfaceForces=function(){g=this.worldPos.data[1],this.force.set(0,0,0),g<this.approxRadius;if(g<0){this.applyWaterInfluence(g,this.airDensity);return}this.waterForce=0,this.airSpeed=this.entity.spatial.velocity.lengthSquared(),this.calcLiftForces(),this.calcFormDrag(),k=this.formDragForce+this.inducedLiftDragForce+this.inducedYawDragForce,this.force.data[0]+=this.liftForceYaw,this.force.data[0]=this.force.data[0]*(1-Math.max(w*k,-1)),this.force.data[1]+=-this.liftForcePitch,this.force.data[1]=this.force.data[1]*(1-Math.max(E*k,-1)),this.force.data[2]+=k,this.force.data[2]=this.force.data[2]*(1-Math.max(S*k,-1)),this.dragAmount=k,this.lastFrameForce.lerp(this.force,.7),this.force.set(this.lastFrameForce),this.airSpeed>1&&(this.size.data[2]*this.size.data[0]*+Math.random()*this.size.data[2]*this.size.data[0]<-8550+this.force.lengthSquared()*Math.random()*.1*this.airDensity*this.airDensity&&this.applyTurbulence(),Math.abs(t.WORLD_PROPERTIES.speedOfSound*t.WORLD_PROPERTIES.speedOfSound-(this.entity.spatial.audioVel.lengthSquared()-3500))<1e3&&this.applySoundBarrierFx()),this.checkForceOverload()},O.prototype.checkForceOverload=function(){Math.random()>this.integrity&&(p=this.calcEffectPointVector(p),e.fireEvent(e.list().PUFF_BLACK_SMOKE,{pos:p.data,count:1,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]})),Math.sqrt(this.force.lengthSquared())>this.maxLoad&&this.force.mul(.5),this.destroyed&&this.force.mul(.9)},O.prototype.updateWingForces=function(e,t,n){if(this.destroyed)return;this.groundProximity=n,this.airDensity=e,this.worldPos=t,this.updateControlledRotation(),this.calcSurfaceForces(),this.destroyed&&this.force.mul(.9)},O.prototype.destroy=function(){this.destroyed=!0},O}),define("game/planes/Plane",["game/parts/Vehicle","game/controls/SurfaceController","game/planes/PlaneWing"],function(e,t,n){var r=function(t){this.vehicle=new e(t)};return r.prototype.parseWingData=function(e,t){e.liftCurveId=e.liftCurve,e.liftCurve=t.wings[e.liftCurve];for(var n=0;n<e.stallLiftCoeff.length;n++)typeof e.stallLiftCoeff[n]=="string"&&(e.stallLiftCoeff[n]=t.coefficients[e.stallLiftCoeff[n]]);e.formDragCoeff=t.coefficients[e.formDragCoeff]},r.prototype.rebuildWings=function(){for(var e in this.entity.wings)this.entity.wings[e].debugGeometry&&(this.entity.wings[e].visualize(this.entity,this.entity.wings[e]),this.revisualize=!0),this.entity.wings[e].destroy()},r.prototype.addWings=function(e,t){this.entity.wings&&(this.revisualize=!1,this.rebuildWings()),this.entity.wings={},this.entity.air={density:1};for(var r in e){var i=e[r];this.parseWingData(i,t),this.entity.wings[r]=new n(this.entity,i,r);for(var s in i.controls)this.entity.wings[r].setAoAControl(s,i.controls[s])}if(this.revisualize){for(r in this.entity.wings)this.entity.wings[r].visualize(this.entity,this.entity.wings[r]);this.revisualize=!1}},r}),define("3d/GooLayerAnimator",[],function(){var e=function(e){e.geometries[0].animationComponent||(alert("No Animation on entity: "+e.id),console.log(e.geometries[0]));var t=e.geometries[0].animationComponent.layers,n={};for(var r=0;r<t.length;r++){var i=t[0];for(var s in i._steadyStates)n[i._steadyStates[s]._name]=s}e.animStateMap=n,console.log("print animation layers: ",e)};return{printEntityLayerMap:e}}),define("game/piece/PieceBuilder",["application/EventManager","game/ships/BoatFactory","game/piece/PieceConfigurator","game/piece/PieceInput","game/planes/Plane","game/parts/Lights","game/parts/Screens","game/ControlsController","game/controls/ControlStateCallbacks","3d/GooLayerAnimator","data_pipeline/PipelineAPI"],function(e,t,n,r,i,s,o,u,a,f,l){function v(e,t,n){for(var r in t.controls)e.pieceInput.addPieceControl(r,t.controls[r],n.getControlUpdateCallback(r))}var c={vehicles:{},characters:{}},h=function(e,t){c[e]||(c[e]={});for(var n=0;n<t.length;n++)c[e][t[n].id]=t[n]};l.subscribeToCategoryKey("game_pieces","vehicles",h);var p=function(e){e.pieceInput=new r(e)},d=function(e){p(e),f.printEntityLayerMap(e)},m=function(e,t,n){t.lights,t.screens,e.forces.weight.setd(0,t.dimensions.massEmpty,0)},g=function(e,n,r){var i=function(e){p(e.entity),r(e)},s=function(n,r){t.buildShip(e,r,i)},o=c.vehicles[n].base_data_key;l.subscribeToCategoryKey("piece_data",o,s)},y=function(e,t,r,s){var o=function(e){u.entity=e,p(u.entity);var t=function(){m(u.entity,u.entity.pieceData,r),console.log("BUILD PLANE:",u),r==1&&(u.entity.pieceInput.controls.flaps&&u.entity.pieceInput.setInputState("flaps",.6),u.entity.pieceInput.controls.breaks&&u.entity.pieceInput.setInputState("breaks",.5)),s(u)};console.log("request config piece: ",u.entity.id),n.configurePiece(u,r,t)},u=new i(e),a=function(e,t){u.vehicle.applyPieceData(t,o)},f=c.vehicles[t].base_data_key;l.subscribeToCategoryKey("piece_data",f,a)};return{buildHuman:d,buildBoatPiece:g,buildPiece:m,buildPlane:y}}),define("game/movement/sphereMovement",["goo/math/Vector3"],function(e){function n(){this.jumpPower=8,this.jumpImpulse=this.jumpPower,this.modRun=4,this.modBack=2,this.modStrafe=3,this.groundContact=!0,this.targetVelocity=new e,this.targetHeading=new e,this.acceleration=new e,this.torque=new e,this.groundHeight=0,this.groundNormal=new e,this.controlState={run:0,strafe:0,jump:0,yaw:0,roll:0,pitch:0}}var t=new e;n.prototype.applyForward=function(e){this.controlState.run=e},n.prototype.applyStrafe=function(e){this.controlState.strafe=e},n.prototype.applyJump=function(e){this.controlState.jump=e},n.prototype.applyTurn=function(e){this.controlState.yaw=e};var r;return n.prototype.applyJumpImpulse=function(e){var t=function(){this.jumpImpulse=this.jumpPower}.bind(this);return this.groundContact&&(this.controlState.jump?(clearTimeout(r),e=this.jumpImpulse,this.jumpImpulse=0,this.controlState.jump=0,this.groundContact=!1,r=setTimeout(function(){t()},200)):e=0),e},n.prototype.applyDirectionalModulation=function(e,t){return e*=this.modStrafe,t<0?t*=this.modBack:t*=this.modRun,[e,this.applyJumpImpulse(0),t]},n.prototype.updateTargetVectors=function(){this.targetVelocity.set(this.applyDirectionalModulation(this.controlState.strafe,this.controlState.run)),this.targetHeading.set(this.controlState.pitch,this.controlState.yaw,this.controlState.roll)},n.prototype.getTargetVelocity=function(){return this.targetVelocity},n.prototype.getTargetHeading=function(){return this.targetHeading},n}),define("game/movement/sphereSpatial",["game/movement/sphereMovement"],function(e){function t(t){this.torqueVector=new Ammo.btVector3(0,0,0),this.sphereEntity=t,this.ammoComponent=this.sphereEntity.ammoComponent,this.sphereMovement=new e,this.timeout}return t.prototype.applyMovementState=function(e){switch(e){case 1:this.sphereMovement.applyForward(Math.round(1-Math.random()*2));break;case 2:this.sphereMovement.applyStrafe(Math.round(1-Math.random()*2));break;case 3:this.sphereMovement.applyJump(1);break;case 4:this.sphereMovement.applyTurn(1-Math.random()*2)}},t.prototype.selectMovementState=function(){return Math.ceil(Math.random()*4)},t.prototype.remove=function(){clearTimeout(this.timeout)},t.prototype.walk=function(){this.applyMovementState(this.selectMovementState()),this.sphereMovement.updateTargetVectors();var e=this.sphereMovement.getTargetVelocity();this.torqueVector.setValue(0,0,0),this.ammoComponent.setAngularVelocity(this.torqueVector),this.torqueVector.setValue(e.data[0],e.data[1],e.data[2]),this.ammoComponent.clearForces(),this.ammoComponent.applyTorqueImpulse(this.torqueVector),e.data[1]!=0&&(this.torqueVector.setValue(0,e.data[1],0),this.ammoComponent.applyCentralImpulse(this.torqueVector)),this.ammoComponent.activate(),this.update()},t.prototype.setPos=function(e){this.ammoComponent.setTransform()},t.prototype.update=function(){function t(){e.walk()}var e=this;this.timeout=setTimeout(function(){t()},2e3)},t}),define("game/movement/MobileUnits",["goo/entities/EntityUtils","goo/shapes/Sphere","goo/renderer/Material","goo/renderer/shaders/ShaderLib","game/movement/sphereSpatial","physics/PhysicalWorld"],function(e,t,n,r,i,s){function u(e){o=e,s.initPhysics()}function a(e){console.log("DELETE MOBILE UNIT: ",e),s.removeAmmoComponent(e.moveSphere.ammoComponent)}function f(e,i,u){if(u)var a=new t(16,16,e),f=new n(r.simpleLit),l=o.createEntity(a,f);else var l=o.createEntity();return l.ammoComponent=s.createAmmoJSSphere(e,i),l.setComponent(s.createAmmoComponentScript()),l.addToWorld(),l}function l(e,t,n){n.moveSphere=e;var r=n.geometries[0],i=t.createEntity();i.sphereEntity=e,s.attachSphericalMovementScript(i,n),i.transformComponent.attachChild(r.transformComponent),i.transformComponent.transform.translation.set(0,-n.pieceData.dimensions.mobRadius,0),i.transformComponent.setUpdated(),i.addToWorld()}function c(e,t){l(t,o,e);var n=new i(t);t.spatialControl=n}var o;return{deleteMobileUnit:a,setWorld:u,sphericalMobile:f,attachEntityToMobileSphere:c}}),define("game/characters/Character",["game/world/PhysicalWorld","application/EventManager","3d/GooJointAnimator","game/movement/MobileUnits"],function(e,t,n,r){var i=function(i,s,o,u){var a=this,f=function(i){a.entity=i,console.log("SPHERE POS: ",o),i.pieceData=s,console.log(s),e.registerPhysicalEntity(i),i.combat.hitPoints=i.pieceData.hitPoints;var f=function(e){i.geometries[0]&&i.geometries[0].removeFromWorld(),i.geometries[0]=e,n.printClipInitialTransform(i),i.spatial.pos.set(o),i.spatial.velocity.data[2]=.3*(Math.random()-.5),i.spatial.velocity.data[0]=.3*(Math.random()-.5),r.attachEntityToMobileSphere(i,r.sphericalMobile(s.dimensions.mobRadius,o,!1)),i.geometries[0].addToWorld(),u(a)};t.fireEvent(t.list().BUILD_GOO_GAMEPIECE,{projPath:i.pieceData.gooProject.projectPath,modelPath:i.pieceData.modelPath,callback:f})};t.fireEvent(t.list().ADD_GAME_ENTITY,{entityId:i,callback:f})};return i}),define("game/characters/CharacterFactory",["game/characters/Character","game/characters/CharacterData"],function(e,t){var n=function(n,r,i,s){r||(r=t.PILOT),new e(n,r,i,s)};return{buildCharacter:n}}),define("game/cars/Car",["game/parts/Vehicle"],function(e){var t=function(t,n){return new e(t,n)};return t}),define("game/cars/CarFactory",["game/cars/Car"],function(e){var t=function(t,n){var r=new e(t,n);return console.log("BUILD CAR:",r),r};return{buildCar:t}}),define("game/piece/TargetFactory",["game/world/PhysicalWorld","application/EventManager","game/movement/MobileUnits","game/parts/Lights","game/parts/Screens"],function(e,t,n,r,i){var s=function(r,i,s){var o=this,a=function(e){e.spatial.rot.rotateX(Math.random()),e.spatial.rot.rotateY(Math.random()),e.spatial.rot.rotateZ(Math.random()),e.combat.isAlive&&(t.fireEvent(t.list().ANALYTICS_EVENT,{category:"TARGET RANGE",action:"destroyed",labels:r,value:1}),n.deleteMobileUnit(e),setTimeout(function(){o.remove()},500))},f=function(r){o.entity=r,r.pieceData=i,e.registerPhysicalEntity(r),r.combat.hitPoints=r.pieceData.hitPoints,r.combat.destroyed=a;var f=function(e){r.geometries[0]&&r.geometries[0].removeFromWorld(),r.geometries[0]=e,r.geometries[0].addToWorld(),r.spatial.velocity.data[2]=.3*(Math.random()-.5),r.spatial.velocity.data[0]=.3*(Math.random()-.5),console.log("ADD TARGET AT POS: ",s),n.attachEntityToMobileSphere(r,n.sphericalMobile(i.dimensions.mobRadius,s,!1)),i.screens&&u(r,i.screens)};t.fireEvent(t.list().BUILD_GOO_GAMEPIECE,{projPath:r.pieceData.gooProject.projectPath,modelPath:r.pieceData.modelPath,callback:f})};t.fireEvent(t.list().ADD_GAME_ENTITY,{entityId:r,callback:f})},o=function(e,t){console.log("ADD TARGET LIGHTS: ",e),r.registerEntityLights(e,t)},u=function(e,n){for(var r in n.displays){console.log(r,i.getDisplay(r));if(i.getDisplay(r)!=undefined)return}i.registerEntityScreens(e,n),console.log("ADD TARGET SCREENS: ",e),e.instruments="target";var s=function(){i.updateEntityScreenState(e)};t.registerListener(t.list().RENDER_TICK,s)},a=function(e){};s.prototype.remove=function(){t.fireEvent(t.list().REMOVE_GAME_ENTITY,{entityId:this.entity.id}),delete this};var f=function(e,t,n){var r=new s(e,t,n);return console.log("BUILD TARGET:",r),r};return{buildTarget:f}}),define("game/world/SpawnSystem",["application/EventManager","game/piece/PieceBuilder","game/characters/CharacterFactory","game/cars/CarFactory","game/piece/TargetFactory","physics/PhysicalWorld","game/movement/MobileUnits"],function(e,t,n,r,i,s,o){var u=0,a=0,f=0,l=0,c=0,h=function(t){e.fireEvent(e.list().REGISTER_ACTIVE_ENTITY,{entity:t}),e.fireEvent(e.list().ACTIVATE_GOO_ENTITY,{gooEntity:t.geometries[0],gameEntity:t})},p=function(e,n,r,i,o,u){a+=1;var f=function(e){e.entity.spatial.pos.set(r),e.entity.spatial.rot.fromAngles(i[0],i[1],i[2]),e.entity.spatial.velocity.set(o),h(e.entity),s.createAmmoShapeComponent(e.entity,e.entity.geometries[0]),u(e)};t.buildBoatPiece(e+"_"+a,n,f)},d=function(e,n,i,s,o){f+=1;var u=r.buildCar(e+"_"+f,n);return u.entity.spatial.pos.set(i),u.entity.spatial.rot.fromAngles(s[0],s[1],s[2]),u.entity.spatial.velocity.set(o),t.buildPiece(u.entity,n,1),h(u.entity),u},v=function(e,n,r,s,o){l+=1;var u=i.buildTarget(e+"_"+l,n,r);return u.entity.spatial.rot.fromAngles(s[0],s[1],s[2]),u.entity.spatial.velocity.set(o),t.buildPiece(u.entity,n,1),h(u.entity),u},m=function(e,n,r,i,s,o,u){c+=1;var a=function(e){e.entity.spatial.pos.set(r),e.entity.spatial.rot.fromAngles(s[0],s[1],s[2]),e.entity.spatial.velocity.set(i),h(e.entity),u(e)};t.buildPlane(e+"_"+c,n,o,a)},g=function(e,r,i,s,o,a,f){u+=1;var l=function(e){e.entity.spatial.rot.fromAngles(o[0],o[1],o[2]),e.entity.spatial.velocity.set(s),t.buildHuman(e.entity,e.entity.pieceData,0),h(e.entity),f(e)};n.buildCharacter(e+"_"+u,r,i,l)};return{spawnHuman:g,spawnBoat:p,spawnCar:d,spawnTarget:v,spawnPlane:m}}),define("game/planes/AiPilot",["application/EventManager","goo/math/Vector3","goo/math/Matrix3x3","game/GameConfiguration"],function(e,t,n,r){var i=new t,s,o=r.RENDER_SETUP.physicsFPS;require(["game/world/LevelController"],function(e){s=e});var u=function(e){this.plane=e,this.target={},this.navpoint=new t,this.targetOrientation=new n,this.virtualInstruments={horizon:new t,rollAngle:0,climbRate:0,speed:0},this.inputValues={headTowards:0,elevate:0,speed:0},this.updatePilot(),this.determineNavPoint()};return u.prototype.setTargetEntity=function(e){this.target=e},u.prototype.requestEject=function(){this.plane.pieceInput.setInputState("throttle",0),this.plane.pieceInput.setInputState("elevator",2*(Math.random()-.5)),this.plane.pieceInput.setInputState("aeilrons",2*(Math.random()-.5)),this.plane.pieceInput.setInputState("rudder",2*(Math.random()-.5))},u.prototype.updateVirtualInstruments=function(){i.setd(0,1,0),this.plane.spatial.rot.applyPre(i),this.virtualInstruments.rollAng=Math.atan2(i.data[0],i.data[1]),this.virtualInstruments.horizon.set(i),this.virtualInstruments.altitude=this.plane.spatial.pos.data[1],this.virtualInstruments.climbRate=this.plane.spatial.velocity.data[1]*o,this.virtualInstruments.speed=Math.sqrt(this.plane.spatial.velocity.lengthSquared())},u.prototype.determineNavPoint=function(){this.navpoint.set([-2e3,3e3,600])},u.prototype.climb=function(e){this.inputValues.speed=1,this.inputValues.elevate=e/1e3},u.prototype.dive=function(e){this.inputValues.speed=0,this.inputValues.elevate=e/1e4},u.prototype.determineSteering=function(){i.set(this.navpoint),i.sub(this.plane.spatial.pos),i.mul(-1),this.targetOrientation.lookAt(i,t.UNIT_Y),i.set(this.targetOrientation.toAngles()),i.sub(this.plane.spatial.rot.toAngles()),this.inputValues.headTowards=Math.atan2(i.data[0],i.data[2]),this.virtualInstruments.altitude<this.navpoint.data[1]?this.climb(this.virtualInstruments.altitude-this.navpoint.data[1]):this.dive(this.virtualInstruments.altitude-this.navpoint.data[1])},u.prototype.determineAction=function(){this.updateVirtualInstruments(),this.determineSteering(),this.plane.pieceInput.setInputState("throttle",this.inputValues.speed),this.plane.pieceInput.setInputState("elevator",this.inputValues.elevate),this.plane.pieceInput.setInputState("aeilrons",this.inputValues.headTowards*.1),this.updatePilot()},u.prototype.updatePilot=function(){if(this.plane.combat.isAlive==0){this.requestEject();return}var e=this;setTimeout(function(){e.determineAction()},150+Math.random()*250)},u}),define("game/world/LevelController",["application/EventManager","game/EntityModel","game/world/VideoBroadcasts","game/ships/BoatData","game/cars/CarData","game/piece/TargetData","game/planes/PlaneData","game/characters/CharacterData","game/world/ZoneData","game/world/SpawnSystem","game/planes/AiPilot"],function(e,t,n,r,i,s,o,u,a,f,l){function A(e){var t=Infinity,n;for(var r in p)for(var i in p[r]){var s=p[r][i].entity.spatial.pos.clone();s.set(e),s.sub(p[r][i].entity.spatial.pos),s.lengthSquared()<t&&s.lengthSquared()!=0&&(t=s.lengthSquared(),n=p[r][i].entity)}return console.log(p),n}function _(e){c=e}function D(){}function P(t){var n=function(n){var r=function(e){D(),t(e)};e.fireEvent(e.list().SET_PLAYER_CONTROLLED_ENTITY,{entity:n,callback:r})};console.log("Player:",h),e.fireEvent(e.list().FETCH_LEVEL_ENTITY,{entityId:h,callback:n})}var c,h,p,d=function(){p={boats:{},cars:{},planes:{},targets:{},humans:{}}};d();var v=function(e,t,n,r,i,s,o){var u=function(e){p.boats[e.entity.id]=e,o(e.entity)};f.spawnBoat(e,t,n,i,r,u)},m=function(e,t,n,r,i){var s=f.spawnCar(e,t,n,i,r);return p.cars[s.entity.id]=s,s.entity},g=function(e,t,n,r,i,s,o){var u=function(e){p.planes[e.entity.id]=e,o(e.entity)};f.spawnPlane(e,t,n,r,i,s,u)},y=function(e,t,n,r,i,s){var o=f.spawnTarget(e,t,n,r,i,s);return p.targets[o.entity.id]=o,o.entity},b=function(e,t,n,r,i,s,o){var u=function(e){p.humans[e.entity.id]=e,console.log("ADD HUMAN TO LEVEL: ",p),o(e.entity)};f.spawnHuman(e,t,n,r,i,s,u)},w=function(e,t){var n=function(e){console.log("Boat ready: ",e)};for(var r in t)for(var i=0;i<t[r].length;i++){var s=t[r][i],o=[s.pos[0]+e[0],0,s.pos[2]+e[2]];v(r,r,o,s.vel,s.rot,0,n)}},E=function(e,t){for(var n in t)for(var r=0;r<t[n].length;r++){var s=t[n][r],o=[s.pos[0]+e[0],s.pos[1]+e[1],s.pos[2]+e[2]];m(n,i[n],o,s.rot,s.vel)}},S=function(e,t){for(var n in t)for(var r=0;r<t[n].length;r++){var i=t[n][r],o=[i.pos[0]+e[0],i.pos[1]+e[1],i.pos[2]+e[2]];y(n,s[n],o,i.rot,i.vel)}},x=function(e,t){for(var n in t)for(var r=0;r<t[n].length;r++){var i=t[n][r],s=[i.pos[0]+e[0],i.pos[1]+e[1],i.pos[2]+e[2]];g(n,n,s,i.vel,i.rot,i.state)}},T=function(e,t){var n=e.pos;w(n,t.boats),E(n,t.cars),x(n,t.planes),S(n,t.targets)},N=function(){console.log(c);var e=c.loadPlayer.playerSpawn.car,t=c.loadPlayer.pos,n=[e.pos[0]+t[0],e.pos[1]+t[1],e.pos[2]+t[2]];return m(c.playerCar,i[c.playerCar],n,e.vel,e.rot,e.state)},C=function(e,t,n,r,i){var s=c.loadPlayer.pos,o=[r.pos[0]+s[0],r.pos[1]+s[1],r.pos[2]+s[2]];return e(t,n,o,r.vel,r.rot,r.state,i)},k=function(t){d(),c||alert("NO SCENARIO LOADED"),console.log("initLevel Scen",c);var n=c.playerCharacter,r=c.loadPlayer.playerSpawn.human,i=function(n){h=n.id;if(c.playerVehicle){var r=c.playerVehicle,i=c.loadPlayer.playerSpawn.plane,s=function(t){var r=function(){if(c.playerCarrier){var e=c.playerCarrier,n=c.loadPlayer.playerSpawn.carrier,r=function(e){e.cables[1].boat.initPlaneReadyAtLot(t,e.pieceData.parkingLots.launch),e.cables[1].boat.catapultPlane(t),console.log("CARRIER: ",e)};C(v,e,e,n,r)}};e.fireEvent(e.list().PILOT_VEHICLE,{pilot:n,vehicle:t,callback:r})};C(g,r,r,i,s)}c.playerCar&&(h=N().id);for(var o=0;o<c.loadZones.length;o++)for(var u=0;u<c.loadVehicles[o].length;u++)T(c.loadZones[o],c.loadVehicles[o][u]);e.eventArgs(t).callback()};C(b,n,u[u],r,i)},L=function(){for(var e in p.boats)p.boats[e].updateBoat()},O=function(n){console.log("FETCH LEVEL ENTITY",p,n);var r=e.eventArgs(n).entityId,i=e.eventArgs(n).type,s=e.eventArgs(n).callback;if(r=="NEAREST"){s(A(e.eventArgs(n).pos));return}if(i)for(var o in p[i]){s(p[i][o].entity);return}if(r){s(t.getEntityById(r));return}for(o in p)for(var u in p[o]){s(p[o][u].entity);return}};e.registerListener(e.list().FETCH_LEVEL_ENTITY,O),e.registerListener(e.list().SCENARIO_LOADED,k);var M=function(){return p.boats},H=function(e,t){t(b("PILOT",null,e,[0,0,0],[0,0,0],0))},B=function(t){H(e.eventArgs(t).pos,e.eventArgs(t).callback)};return e.registerListener(e.list().SPAWN_PHYSICAL,B),{getBoats:M,updateBoats:L,registerScenario:_,addPlayerToLevel:P}}),define("3d/cameras/WalkMode",["physics/PhysicalWorld","goo/math/Vector2","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r,i){var s=function(){this.calcVec=new n,this.calcVec2=new n,this.calcVec3=new n,this.calcMat=new r,this.targetOffset=new n(0,1.75,0),this.targetSpatial=null,this.lookAtPoint=new n,this.camPos=new n,this.camDistance=6,this.azimuth=.4,this.baseFov=45,this.fov=this.baseFov,this.targetFov=this.baseFov,this.worldUpVector=new n(0,1,0),this.camera=null};return s.prototype.setTargetSpatial=function(e){this.targetSpatial=e},s.prototype.setTargetOffset=function(e){this.targetOffset=e},s.prototype.setCamDistance=function(e){this.camDistance=e},s.prototype.getCamDistance=function(){return this.camDistance},s.prototype.getRollInfluence=function(){return.8},s.prototype.adjustPhysical=function(t){this.calcVec.set(t),this.targetSpatial.rot.applyPost(this.calcVec),this.calcVec.add(this.targetSpatial.pos),this.calcVec3.set(this.targetSpatial.pos),this.calcVec3.add(this.lookAtPoint);var n=e.physicsRayRange(this.calcVec3.data,this.calcVec.data);return n&&t.mul(n.fraction),t.mul(.5),t},s.prototype.calcCamPos=function(e){this.lookAtPoint.set(this.targetOffset),this.calcVec2.set(e),this.calcVec2.add(this.targetOffset),this.calcVec.set(this.adjustPhysical(this.calcVec2)),this.calcVec.add(this.targetOffset),this.camPos.set(this.calcVec)},s.prototype.calcCamRot=function(e,t){var n=e.transformComponent,r=n.transform;r.translation.set(this.camPos),this.calcVec.set(this.camPos),this.calcVec.sub(this.lookAtPoint),this.calcVec.mul(-1),r.rotation.lookAt(this.calcVec3,this.calcVec),r.rotation.lookAt(this.calcVec,this.worldUpVector),t.y=i.lerp(.1,t.y,Math.PI*1.5)},s.prototype.releaseDrift=function(e){},s.prototype.pointerAction=function(e){e.y=Math.PI*1.5},s.prototype.setCamera=function(e){this.camera=e},s.prototype.adjustFov=function(e){this.targetFov=e},s}),define("game/player/PlayerController",["application/EventManager","game/player/PlayerUtils","game/player/PlayerPieceHandler","game/planes/PlaneData","3d/cameras/WalkMode"],function(e,t,n,r,i){function a(){var e=u+1;return o[e%o.length]}function f(e){s=e}function l(){return s}var s,o=["PILOT_1","TUNNAN_1","DRAKEN_3","PV_9031_1"],u,c=function(e,t){u=o.indexOf(e.id),f(n.setPlayerControlledEntity(e,t));var r=e;e.pilot&&(r=e.pilot),e.isPilot=!1},h=function(t){c(e.eventArgs(t).entity,e.eventArgs(t).callback)},p=function(t){var r=e.eventArgs(t).callback,i=l().pilot,s=l().spatial.pos.data,o=l().spatial.rot.toAngles(),u=l().spatial.velocity.data,a=function(){if(!i){var t=function(){console.log("Switch without pilot Completed"),typeof r=="function"&&r()},n=function(e){c(e,t)},a=function(t){console.log("SWITCH TO: ",t),t.spatial.pos.set(s),t.spatial.velocity.set(u),e.fireEvent(e.list().FETCH_LEVEL_ENTITY,{entityId:t.id,callback:n})},f=function(){e.fireEvent(e.list().SPAWN_PHYSICAL,{pos:s,callback:a})};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:f,wait:200})}else{l().pilot=null;var a=function(t,n){var i=function(){e.fireEvent(e.list().SET_CAMERA_TARGET,{spatial:t.spatial,geometry:t.geometries[0],controlScript:"walkCam"}),typeof r=="function"&&r()};console.log("SWITCH TO: ",t),t.spatial.pos.set(n),t.spatial.rot.fromAngles(0,o.data[1],0),c(t,i)},f=function(){a(i,s)};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:f,wait:200})}};n.removePlayerControlFrom(l(),a)},d=function(){console.log("POP Sphere"),e.fireEvent(e.list().SPAWN_PHYSICAL,{pos:l().spatial.pos.data})};return e.registerListener(e.list().SET_PLAYER_CONTROLLED_ENTITY,h),e.registerListener(e.list().EXIT_CONTROLLED_ENTITY,p),e.registerListener(e.list().POP_SPHERE,d),{getPlayerEntity:l}}),define("game/world/WorldEffects",["application/EventManager","game/ModelDefinitions"],function(e,t){}),define("game/world/Atmosphere",["game/GameConfiguration","game/world/WorldEffects"],function(e,t){var n=function(t){var n=e.AERODYNAMICS.airMassDensity,r=.9*Math.max(0,1-t*.8*e.AERODYNAMICS.densityPerMeter);return r+=.1*Math.max(0,1-t*.14*e.AERODYNAMICS.densityPerMeter),t<0&&(r=1e3),r};return{getAirDensity:n}}),define("game/AerodynamicController",["game/GameConfiguration","game/world/Atmosphere","goo/math/Vector3"],function(e,t,n){var r=new n,i=function(e){var t=new n,r=new n;r.setv(e.spatial.velocity),r.div(Math.sqrt(e.spatial.velocity.lengthSquared())),t.setv(r),e.spatial.rot.applyPre(t),e.spatial.axisAttitudes=t},s=function(e,t,n,r){e.updateWingForces(t,n,r)},o=function(e,n){for(var i in e.wings){var o=e.wings[i];r.set(0,0,0);var u=r;u.setv(o.pos),e.spatial.rot.applyPost(u),u.addv(e.spatial.pos);var a=u.data[1],f=t.getAirDensity(a);s(o,f,u,n)}},u=function(e,n){e.air.density=t.getAirDensity(e.spatial.pos.data[1]),o(e,n)},a=function(e,t){i(e),u(e,t)};return{updateAerodynamicInfluences:a}}),define("game/movement/CharacterMovement",["goo/math/Vector3","game/characters/CharacterAnimator"],function(e,t){function o(e,t,r){return e.rotateY(r.data[1]),n.set(t.data[2],t.data[1],t.data[0]),e.applyPost(n),n}function u(e,t){t.mouseforward&&(t.forward=t.mouseforward),e.applyForward(t.forward-t.back),t.strafe?(e.applyStrafe(t.turnright-t.turnleft),e.applyTurn(t.mouseturn)):(e.applyStrafe(0),e.applyTurn(.05*(t.turnleft-t.turnright))),e.applyJump(t.jump),t.jump=0,e.updateTargetVectors()}function a(e,t){var n=e.moveSphere.ammoComponent;r.setValue(0,0,0),n.setAngularVelocity(r),r.setValue(n.getLinearVelocity().getX()*.5,n.getLinearVelocity().getY(),n.getLinearVelocity().getZ()*.5),t.lengthSquared()<1&&(r.setValue(n.getLinearVelocity().getX()*.5,n.getLinearVelocity().getY(),n.getLinearVelocity().getZ()*.5),n.setLinearVelocity(r)),r.setValue(t.data[0],t.data[1],t.data[2]),n.clearForces(),n.applyTorqueImpulse(r),t.data[1]!=0&&(r.setValue(0,t.data[1],0),n.applyCentralImpulse(r)),n.activate()}function f(e,n){u(e.moveSphere.spatialControl.sphereMovement,n),t.updateCharacterMovementAnimation(e,n)}function l(e){return{vel:e.getTargetVelocity(),rot:e.getTargetHeading()}}function c(e){var t=l(e.moveSphere.spatialControl.sphereMovement),n=o(e.spatial.rot,t.vel,t.rot);a(e,n),t.vel.data[1]&&(t.vel.data[1]=0)}function h(e,t){t==undefined&&(t=0),i[e]=t,s=!0}function d(e){for(var t in e.pieceInput.controls)e.pieceInput.controls[t].update&&(h(t,e.pieceInput.controls[t].value),e.pieceInput.controls[t].update=!1);s&&(f(e,i),s=!1,clearTimeout(p),p=setTimeout(function(){s=!0},100)),c(e)}var n=new e,r=new Ammo.btVector3(0,0,0),i={forward:0,back:0,turnleft:0,turnright:0,mouseturn:0,mouseforward:0,strafe:0,jump:0},s=!1,p;return{updateCharacterControlState:d}}),define("game/PieceController",["goo/math/Vector3","goo/math/Matrix3x3","physics/ForceProcessor","game/world/PhysicalWorld","application/EventManager","game/GameConfiguration","game/planes/PlaneController","game/world/LevelController","game/player/PlayerController","game/AerodynamicController","game/movement/CharacterMovement","game/parts/Lights","game/parts/Screens","game/GameUtil","game/EntityController"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v={},m=new e,g=function(e){var t=i.eventArgs(e).entity;v[t.id]=t},y=function(e){r.removePhysical(e),delete v[e]},b=new t,w=new e,E=new e,S=function(e){e.spatial.pos.addv(e.spatial.velocity)},x=function(e,t){return e.applyPost(t)},T=function(e,t,n){var r=e.pieceData.dimensions.massEmpty;return t.div(r/n)},N=function(e){return 9.81*e},C=function(e){return-e.pieceData.dimensions.massEmpty},k=function(e,t){var n=T(e,e.spatial.acc,t);Math.sqrt(n.lengthSquared())>5&&(console.log("Over Acceleration damage",Math.sqrt(n.lengthSquared())),n.div(Math.sqrt(n.lengthSquared()))),e.forces.g.setv(n),e.spatial.velocity.addv(n)},L=function(e,t){var n=T(e,e.forces.torque,t);Math.sqrt(n.lengthSquared())>.5&&(console.log("Over Torque damage",Math.sqrt(n.lengthSquared())),n.div(Math.sqrt(n.lengthSquared())*2),e.spatial.angularVelocity.set(0,0,0)),e.spatial.angularVelocity.addv(n),e.spatial.rot.rotateX(e.spatial.angularVelocity[0]),e.spatial.rot.rotateY(e.spatial.angularVelocity[1]),e.spatial.rot.rotateZ(e.spatial.angularVelocity[2])},A=function(e,t){e.spatial.velocity.data[0]=e.spatial.velocity.data[0]*.9999,e.spatial.velocity.data[2]=e.spatial.velocity.data[2]*.9999,e.spatial.velocity.add_d(0,-6e-7,0),e.spatial.rot.rotateZ(9e-6*e.spatial.pos[1]),e.spatial.rot.rotateX(-0.000005*e.spatial.pos[1]),e.spatial.pos[0]=e.spatial.pos[0]-e.spatial.velocity.data[0],e.spatial.pos[2]=e.spatial.pos[2]-e.spatial.velocity.data[2],e.spatial.frameSpeed+=Math.sqrt(e.spatial.velocity.lengthSquared())},O=new e,M=function(t,n){if(t.wings)k(t,n),L(t,n);else{if(t.combat&&t.combat.isAlive===!1){A(t,n);return}t.spatial.velocity.add_d(0,n*s.WORLD_PROPERTIES.gravity[1]/s.RENDER_SETUP.physicsFPS,0);if(!t.spatial.velocity.data)return;if(t.spatial.pos[1]<=0){var r=0-t.spatial.velocity.data[1],i=t.spatial.velocity.data[1]-r,o=i/t.spatial.velocity.data[1];t.spatial.velocity.data[1]=0,t.spatial.pos[0]=t.spatial.pos[0]-t.spatial.velocity.data[0]*o,t.spatial.pos[1]=0,t.spatial.pos[2]=t.spatial.pos[2]-t.spatial.velocity.data[2]*o}O.setVector(t.spatial.velocity),O.mul(-1),t.spatial.rot.lookAt(O,e.UNIT_Y)}t.spatial.frameSpeed+=Math.sqrt(t.spatial.velocity.lengthSquared())},_=function(e){e.spatial.acc.set(0,0,0),e.forces.buoyancy.data[1]=0,e.forces.drag.set(0,0,0),e.forces.lift.set(0,0,0)},D=function(e){w.set(0,0,0);for(var t in e.wings){var r=e.wings[t];n.addForceToAcc(r.force.mul(9.81),e.spatial.acc),n.addForceToTorque(r.force,r.pos,w)}e.forces.torque.lerp(w,.4)},P=function(e,t,r){for(var i=0;i<t.length;i++){var s=t[i];s.updateForceVector(e),n.addForceToAcc(s.forceVector.mul(r),e.spatial.acc),n.addForceToTorque(s.forceVector,s.pos,e.forces.torque)}},H=function(e,t){w.set(0,0,0);for(var r in e.systems.engine.engines){var i=e.systems.engine.engines[r];n.addForceToAcc(i.thrustVector.mul(t),e.spatial.acc),n.addForceToTorque(i.thrustVector,i.pos,w)}e.forces.torque.lerp(w,.1)},B=function(e,t){var n=N(t);e.spatial.acc.data[1]+=n*C(e)},j=function(e,t){var n=r.getRangesToNearbyConflics(e),s=r.checkSpatialConflict(e,t);if(s)if(s.part=="water")e.spatial.velocity.mul(.99,.7,.99);else{e.spatial.velocity.set(1e-4,1e-4,.001);if(e.spatial.speed>.1){var o=e.spatial.pos.data;console.log("Loc: ",o[0],o[1],o[2]),i.fireEvent(i.list().ONESHOT_AMBIENT_SOUND,{soundData:i.sound().CANNON_20_0,pos:o,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]}),i.fireEvent(i.list().ONESHOT_AMBIENT_SOUND,{soundData:i.sound().MAIN_HIT_0,pos:o,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]}),i.fireEvent(i.list().PUFF_BLACK_SMOKE,{pos:o,count:20,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_MUZZLE_FIRE,{pos:o,count:7,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_MUZZLE_FIRE,{pos:o,count:3,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_SPARKS,{pos:o,count:6,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),setTimeout(function(){i.fireEvent(i.list().ONESHOT_AMBIENT_SOUND,{soundData:i.sound().MAIN_GUN_0,pos:o,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]}),i.fireEvent(i.list().FLASH_MUZZLE_FIRE,{pos:o,count:3,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().PUFF_BLACK_SMOKE,{pos:o,count:20,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_MUZZLE_FIRE,{pos:o,count:3,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_SPARKS,{pos:o,count:4,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),setTimeout(function(){i.fireEvent(i.list().ONESHOT_AMBIENT_SOUND,{soundData:i.sound().MAIN_HIT_2,pos:o,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]}),i.fireEvent(i.list().FLASH_MUZZLE_FIRE,{pos:o,count:3,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().PUFF_BLACK_SMOKE,{pos:o,count:20,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_MUZZLE_FIRE,{pos:o,count:3,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]}),i.fireEvent(i.list().FLASH_SPARKS,{pos:o,count:4,dir:[Math.random()-.5,1+Math.random(),Math.random()-.5]})},200)},200)}}else if(e.spatial.speed>.5)if(n.ground<30){var u=[e.spatial.pos.data[0]+.5*e.spatial.pos[1]*(Math.random()-.5),e.spatial.pos[1]-n.ground,e.spatial.pos.data[2]+.5*e.spatial.pos[1]*(Math.random()-.5)],a=function(){i.fireEvent(i.list().PUFF_WHITE_SMOKE,{pos:u,count:1,dir:[0,Math.random(),0]})};Math.random()<e.spatial.speed*.3&&setTimeout(function(){a()},n.ground*1.1+1*n.ground*Math.random())}else if(e.spatial.pos[1]<35&&e.spatial.speed>.5){var f=[e.spatial.pos.data[0]+.5*e.spatial.pos[1]*(Math.random()-.5),.1,e.spatial.pos.data[2]+.5*e.spatial.pos[1]*(Math.random()-.5)],l=function(){i.fireEvent(i.list().SPLASH_WATER,{pos:f,count:1,dir:[0,1,0]}),Math.random()<.1&&i.fireEvent(i.list().SPLASH_RINGLET,{pos:f,count:1,dir:[0,0,0]}),Math.random()<.02&&i.fireEvent(i.list().SPLASH_FOAM,{pos:f,count:1,dir:[0,0,0]})};setTimeout(function(){l()},e.spatial.pos[1]*12+8*e.spatial.pos[1]*(Math.random()-.5))}return n.ground},F=function(e){w.set(e.spatial.visualPos),w.sub(m),w.lengthSquared()>1e3*e.pieceData.physicalRadius*e.pieceData.physicalRadius?d.hideEntity(e):d.showEntity(e)},I=function(e,t){t.spatial.audioVel.set(t.spatial.pos),t.spatial.audioVel.sub(t.spatial.visualPos),t.spatial.audioVel.mul(1/e);if(t.isPilot){t.moveSphere.deactivate();return}t.screenSystem?(t.spatial.visualPos.setv(t.spatial.pos),h.updateEntityScreenState(t)):t.spatial.visualPos.setv(t.spatial.pos),t.animStateMap?l.updateCharacterControlState(t):t.moveSphere.deactivate()},q=!0,R=function(e,t,n,r){if(e.surfaces){var i=j(e,n*r);o.updatePlaneControlState(e,r,i)}e.spatial.frameSpeed=0,e.spatial.frameTime=t;if(q)return;e.lights&&c.updateEntityLightState(e,t),e.screenSystem&&e.instruments&&(e.screenSystem.updateDisplays(),e.screenSystem.attenuateIntensity()),e.lights&&c.attenuateWithDarkRects(e)},U=function(e,t){if(e.systems){_(e);var n=e.systems;n.engine&&H(e,t),n.gears&&n.gears.currentState!=0&&P(e,n.gears.wheels,t),n.drive&&P(e,n.drive.wheels,t)}e.wings&&(f.updateAerodynamicInfluences(e),D(e,t)),e.spatial.acc&&x(e.spatial.rot,e.spatial.acc),e.pieceData.dimensions&&B(e,t),M(e,t),S(e,t)},z=function(e,t){if(e.systems&&e.systems.engine)for(var n=0;n<e.systems.engine.engines.length;n++)e.systems.engine.engines[n].updateSystemEffects(t);e.updatePieceEffects&&e.updatePieceEffects(t)},W=function(e,t,n){var r=s.RENDER_SETUP.physicsFPS,i=1/r,o=Math.round(n/i);F(t);if(t.moveSphere)I(n,t);else{R(t,e,r,n);for(var u=0;u<o;u++)U(t,i);t.spatial.speed=t.spatial.frameSpeed,t.spatial.visualPos.setv(t.spatial.pos),w.set(t.spatial.velocity),w.mul(1/i),t.spatial.audioVel.set(w)}$(t,1/r),z(t,n)},X=function(e){for(var t=0;t<e.geometries.length;t++)e.geometries[t].transformComponent.transform.rotation.set(e.spatial.rot),e.geometries[t].transformComponent.transform.translation.setv(e.spatial.visualPos),e.geometries[t].transformComponent.setUpdated()},V=function(e){e.pilot.spatial.rot.set(e.spatial.rot),w.set(e.pieceData.dimensions.pilotSeatPos),w=p.applyRotationToVelocity(e,w),w.add(e.spatial.visualPos),E.set(0,e.pilot.pieceData.dimensions.mobRadius,0),E.add(w),e.pilot.spatial.pos.set(E),e.pilot.spatial.visualPos.set(E),e.pilot.geometries[0].transformComponent.transform.translation.set(E),e.pilot.geometries[0].transformComponent.setUpdated()},$=function(e,t){e.stats.update+=t;if(e.stats.update<.5)return;e.stats={update:0,altitude:Math.round(e.spatial.pos.y),speed:Math.round(3.6*e.spatial.speed/t),heading:e.spatial.angle,thrust:0};if(e.systems&&e.systems.engine.engines)for(var n=0;n<e.systems.engine.engines.length;n++)e.stats.thrust+=Math.round(e.systems.engine.engines[n].thrust*1e-5/t)},J=function(e,t,n){W(t,n,e),n.pilot&&V(n),X(n)},K=function(e){q=!q;var t=1e3/e,n=1/t;u.updateBoats();for(var r in v)J(n,e,v[r]);i.fireEvent(i.list().UPDATE_GAMEPIECE_EFFECTS,{tpf:n})},Q=function(e){y(i.eventArgs(e).entityId)},G=function(e){m.set(i.eventArgs(e).pos)},Y=function(){return v};return i.registerListener(i.list().REGISTER_ACTIVE_ENTITY,g),i.registerListener(i.list().REMOVE_GAME_ENTITY,Q),i.registerListener(i.list().MOVE_AUDIO_LISTENER,G),{tickEntities:K,getGameEntities:Y}}),define("game/combat/CombatSystem",["application/EventManager","game/EntityController","game/GameUtil"],function(e,t,n){var r=function(e){e.combat.destroyed(e),e.combat.isAlive=!1},i=function(e,t){e.combat.damageTaken+=t,e.combat.damageTaken>=e.combat.hitPoints&&e.combat.isAlive&&r(e)},s=function(t){i(e.eventArgs(t).entity,e.eventArgs(t).damage)};e.registerListener(e.list().DAMAGE_ENTITY,s)}),define("game/GameUiCallbacks",["application/Settings","application/PerfMon","application/EventManager","goo/entities/SystemBus","data_pipeline/PipelineAPI","game/PieceController"],function(e,t,n,r,i,s){var o=function(){},u,a=function(e){return""+u[e.source][e.key]},f={frame_tpf:function(){var e=t.getTpfStack();return Math.ceil(e[e.length-1])},fetchTpfStack:function(){return t.getTpfStack()},fetchGameParameter:function(e){return a(e)},fetchActiveGamePieces:function(){return s.getGameEntities()},fetchAerodynamicCurves:function(){return i.readCachedConfigKey("game_data","aerodynamic_curves").wings},applied_control_update:function(e){return u.pieceInput.getAppliedState(e)},player_control_update:function(e){return u.pieceInput.getInputState(e)},fire_game_event:function(e){n.fireEvent(n.list()[e.event],e.args)},fetchControlState:function(e){return u.pieceInput.getInputState(e)},fetchSettingState:function(t){return e.getAllSettings()[t].getValue()},fetchPlayerPiece:function(){return u},more_stats:function(){var e=t.getStatsCollection();return["Tpf: "+Math.round(e.tpf)*.001+"s","Shaders: "+e.cachedShaders,"Ents (all): "+e.allentities,"Ents (world): "+e.entities,"Ents (animated): "+e.animations,"TrxUpdates: "+e.transforms,"Lights: "+e.lights,"Comps: "+e.composers+" Passes: "+e.passes,"Gui Calls: "+e.guiCalls]},registerMessageElement:function(e,t,n){c[t]||(c[t]={}),c[t][e.shape+"_"+t+"_"+n]=e},getChannelMessage:function(e){return l[e]||"Channel: "+e+" is silent"},fetchCallById:function(e){switch(e){case"player_control_event":return function(e){n.fireEvent(n.list().PLAYER_CONTROL_EVENT,{control:e.control,value:e.value}),e.enabler&&r.emit("guiToggleEnabler",{value:e.value,enabler:e.enabler})};case"gui_toggle_template":return function(e){r.emit("guiToggleTemplate",{template:e.template,enabler:e.enabler})};default:}},player_control_event:function(e){n.fireEvent(n.list().PLAYER_CONTROL_EVENT,{control:e.control,value:e.value}),e.enabler&&r.emit("guiToggleEnabler",{value:e.value,enabler:e.enabler})},setting_control_event:function(e){n.fireEvent(n.list().SETTING_CONTROL_EVENT,{setting:e.setting,value:e.value}),e.enabler&&r.emit("guiToggleEnabler",{value:e.value,enabler:e.enabler})},gui_toggle_template:function(e){r.emit("guiToggleTemplate",{template:e.template,enabler:e.enabler})},processCallbacks:function(e){for(var t in c)for(var n in c[t]){var r=c[t][n];r.stateTieout>0&&(r.stateTieout-=e,r.notifyStateChange(r.messageChannels[t]),r.stateTieout<0&&r.notifyStateChange(r.states.passive))}}},l={};o.getCallbackMap=function(){return f},o.setChannelMessage=function(e,t){l[e]=t};var c={};o.handleGuiMessage=function(e){o.setChannelMessage(e.channel,e.message);if(c[e.channel])for(var t in c[e.channel]){var n=c[e.channel][t];n.notifyStateChange(n.messageChannels[e.channel]),n.stateTieout=n.messageData.duration}},r.addListener("message_to_gui",o.handleGuiMessage);var l=["system_channel","hint_channel"],h=[["sys_test_1","sys_test_2","sys_test_3"],["hint_test_1","hint_test_2","hint_test_3"]];return o.getPlayerPieceControlId=function(e){return u.pieceInput.controls[e]},o.handleSetPlayerPiece=function(e){u=n.eventArgs(e).entity},n.registerListener(n.list().SET_PLAYER_CONTROLLED_ENTITY,o.handleSetPlayerPiece),o}),define("game/GuiStateTransitionCallbacks",["application/EventManager"],function(e){var t=function(){e.fireEvent(e.list().ONESHOT_SOUND,{soundData:e.sound().UI_OUT})},n=function(){e.fireEvent(e.list().ONESHOT_SOUND,{soundData:e.sound().UI_HOVER})},r=function(){e.fireEvent(e.list().ONESHOT_SOUND,{soundData:e.sound().UI_ACTIVE})},i=function(){e.fireEvent(e.list().ONESHOT_SOUND,{soundData:e.sound().UI_CLICK})},s=function(){e.fireEvent(e.list().ONESHOT_SOUND,{soundData:e.sound().UI_OUT})},o={passive:t,on_hover:n,on_active:r,on_applied:i,on_message:s};return o}),define("io/PointerInputHandler",["goo/entities/SystemBus","application/EventManager","io/InputSettersGetters","io/GameScreen"],function(e,t,n,r,i){var s=!1,o,u,a,f,l=!1,c,h=[],p={},d={},v=[],m,g,y=[],b=[],w=function(e){p=e.screenControlTargets,d=e.screenSelectionSufaces,y=e.widgets},E=0,S=function(e){C();var t=0,r=e;for(t=0;t<y.length;t++)y[t].showControlState();D&&D.showControlState();if(m)return;var i=[];if(s){o=n.getDragDeltaXY(),g.inputVector(f[0],f[1],f[0]-o[0],f[1]-o[1]);for(t=0;t<h.length;t++)h[t].onControlActive(),h[t].setDragValue(o);u=o[0],a=o[1]}else if(v.length!=0)for(t=0;t<v.length;t++)v[t].onControlHover(),v[t].showControlState();else{T&&(T=!1,E+=.001*r);for(t=0;t<y.length;t++)y[t].onControlEnable();for(t=0;t<d.length;t++)d[t].state==1&&(d[t].showSelectionSurface([.5,.7,.7,.3]),E=0);for(t=0;t<d.length;t++)d[t].showSelectionSurface([.2,.4,.5,.5*E]);E*=1-.002*r}},x=[0,0],T=!1,N=function(e){x=t.eventArgs(e).xy},C=function(){if(D){k=_(x[0],x[1]);var e=!1;D.showControlState();for(t=0;t<k.length;t++)if(k[t].data.axis==2&&D==k[t]){e=!0;return}D=null}else if(s||m)return;k=_(x[0],x[1]);if(k.length>0){v=k,E=0;for(var t=0;t<k.length;t++)k[t].onControlHover()}else T=!0,v=[]},k=[],L,A,O,M,_=function(e,t){L=e,A=t,b=g.interactiveLayers,O=g.pxXtoPercentX(e),M=g.pxYtoPercentY(t),g.moveTo(O,M,v.length),k=[];for(var n in b)b[n].checkHoverHit(O,M,k);for(var r=0;r<d.length;r++)if(d[r].state==1)return E=0,d[r].checkHoverHit(O,M,k),k;for(r=0;r<d.length;r++){var i=d[r].checkHoverHit(O,M,k);if(i)return k}for(r=0;r<y.length;r++)y[r].checkHoverHit(O,M,k);return k},D,P=function(e,t){var n=_(e,t);h=[];for(var r=0;r<n.length;r++)h.push(n[r]),n[r].beginValueManipulation(),n[r].data.axis==2&&(D=n[r]);return h},H=function(e){u=0,a=0,f=t.eventArgs(e).xy,h=P(f[0],f[1]),h.length>0&&(s=!0)},B=function(){E=0,D&&D.state==3&&(D.applyControlState(1),D.onControlRelease());for(var e in h)h[e].endValueManipulation()},j=function(e){s&&B(),s=!1},F=function(e){c=e.pieceData,c.onScreenInput?w(e,c.onScreenInput):l=!1},I=function(){E=0,m=!0,v.length&&(v=[])},q=function(){E=0,m=!1},R=function(e){v.length&&t.eventArgs(e).xy[0]!=1&&(v=[]),g.inputMouseAction(t.eventArgs(e).action,t.eventArgs(e).xy)},U=function(e){g=e,t.registerListener(t.list().MOUSE_ACTION,R),t.registerListener(t.list().MOUSE_POSITION_UPDATE,N),t.registerListener(t.list().START_POINTER_DRAG,H),t.registerListener(t.list().STOP_POINTER_DRAG,j),t.registerListener(t.list().START_CAMERA_DRAG,I),t.registerListener(t.list().STOP_CAMERA_DRAG,q)};return U.prototype.tickInput=function(e){S(e)},U.prototype.setPlayerGamePiece=function(e){F(e)},U.prototype.applyGuiWidgets=function(e){w(e)},U}),define("gui/GuiWidgetComposer",[],function(){var e=function(){this.screenControlTargets={},this.screenSelectionSufaces=[],this.widgets=[]};return e}),define("game/GameController",["application/EventManager","gui/CanvasGuiAPI","application/Sequencer","3d/SceneController","game/PieceController","game/EntityController","game/combat/CombatSystem","game/GameUiCallbacks","game/GuiStateTransitionCallbacks","io/PointerInputHandler","gui/GuiWidgetComposer","3d/GooEffectController","data_pipeline/PipelineAPI"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=!0,d=!1,v=function(){this.sequencer=new n,this.sceneController=new r,this.canvasGuiAPI=new t(1024),this.guiWidgetComposer=new l};return v.prototype.tickGui=function(e){if(!d)return;this.canvasGuiAPI.updateCanvasGui(e)},v.prototype.tickGame=function(e){this.sceneController.viewTick(e),i.tickEntities(e),this.sequencer.tick(e)},v.prototype.setupGame=function(){var t=function(){this.sequencer.flushQueue()}.bind(this);e.registerListener(e.list().UN_LOAD_3D,t)},v.prototype.setGuiState=function(e){this.canvasGuiAPI.setUiToStateId(e),p&&this.canvasGuiAPI.attachUiSubstateId("debug_state")},v.prototype.setupGuiStateTransitionCallbacks=function(e){for(var t in e)this.canvasGuiAPI.addGuiStateTransitionCallback(t,e[t])},v.prototype.addCanvasGui=function(t,n){var r=function(t){this.setGuiState("messages_only"),this.applyPlayerPiece(e.eventArgs(t).entity)}.bind(this),i=function(){console.log("Gui init ok!"),setTimeout(function(){d=!0},200),this.setupGuiStateTransitionCallbacks(a),this.setGuiState("load_page"),e.registerListener(e.list().SET_PLAYER_CONTROLLED_ENTITY,r)}.bind(this),s=function(e){console.log("Gui failed to init: ",e)},o=function(){this.canvasGuiAPI.initCanvasGui(n,t,u.getCallbackMap(),i,s)}.bind(this);h.checkReadyState()?o():h.addReadyCallback(o)},v.prototype.applyPlayerPiece=function(e){var t=function(e){this.setGuiState(e)}.bind(this);e.pieceData.onScreenInput&&t(e.pieceData.onScreenInput.guiMainStateId)},v.prototype.gameLoadingCompleted=function(){c.initFxPlayer(),this.setGuiState("main_menu")},v}),define("application/UpdateLoop",["application/EventManager","game/GameConfiguration","application/DeviceHandler"],function(e,t,n){var r=function(){},i=n.getBrowser(),s=n.getVersion(),o=0,u=!1,a,f,l=(new Date).getTime(),c,h=0,p=0,d=t.RENDER_SETUP.targetFPS,v=10,m=20,g={slowFrameCount:0,worstFrameTime:0,cyclesOfTen:0,averageFrameTime:0,skipped:0},y=function(e,t){var n=1e3/d,r=n-1;return t>n*21&&(r=n/2),r},b=function(){clearTimeout(f),a&&console.log("unpause",a),a=!1,f=setTimeout(function(){console.log("pause",a)},400)},w=0,E=function(t){l=e.eventArgs(t).tpf*1e3,b();var n=function(t){w=t,T(),e.fireEvent(e.list().RENDER_TICK,{frameTime:now,lastFrameDuration:t})};e.fireEvent(e.list().FETCH_TIME,{callback:n})},S=function(){var t={avgT:Math.round(g.averageFrameTime*10)/10,slowFs:g.slowFrameCount,slowest:Math.round(g.worstFrameTime*10)/10,cycles:g.cyclesOfTen,mins:p,skipd:g.skipped};e.fireEvent(e.list().ANALYTICS_EVENT,{category:"PERFORMANCE",action:"STATS "+i,labels:JSON.stringify(t),value:Math.round(t.slowest)})},x=function(e){if(u||e>200){g.skipped+=1;return}g.slowFrameCount+=1,e>g.worstFrameTime&&(g.worstFrameTime=e),g.averageFrameTime=m/o,g.slowFrameCount>v&&(S(),g.slowFrameCount=0,g.cyclesOfTen+=1,g.worstFrameTime=0,v*=10)},T=function(){o+=1,c=l,isNaN(c)||(m+=c),C(w,c)},N=function(){h-=6e4,p+=1,S()},C=function(e,t){var n=1e3/d;t>n*1.5&&(x(t),t=n*1.5),h+=t,h>6e4&&N(),!u},k=function(){u=!0},L=function(){u=!1};return e.registerListener(e.list().GOO_TICK,E),e.registerListener(e.list().PAUSE_UPDATES,k),e.registerListener(e.list().UNPAUSE_UPDATES,L),r}),define("3d/WorldParticleSystems",["application/EventManager","game/GameConfiguration","game/ModelDefinitions","goo/math/Vector3","goo/entities/SystemBus"],function(e,t,n,r,i){function u(t){var r=function(e,t){return 4*t*(.2*e+1)+5*(Math.random()-.5)},i=function(e,t,n,i){return{p:[e[0]+t[0]*(1+n)*.2,e[1]+t[1]*(1+n)*.2,e[2]+t[2]*(1+n)*.2],d:[r(n,t[0]),r(n,t[1]),r(n,t[2])],w:n*65}},s=function(t){u.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},o=function(){e.registerListener(e.list().PUFF_BLACK_SMOKE,s)},u=new WorldParticles(t,n.GOO_PARTICLES.black_puff,i,o)}function a(t){var r=function(e,t,n,r){return{p:[e[0]+t[0]*(1+n)*.1,e[1]+t[1]*(1+n)*.1,e[2]+t[2]*(1+n)*.1],d:[5*t[0]*(1+n),5*t[1]*(1+n),5*t[2]*(1+n)],w:n*45}},i=function(t){o.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},s=function(){e.registerListener(e.list().PUFF_WHITE_SMOKE,i)},o=new WorldParticles(t,n.GOO_PARTICLES.white_puff,r,s)}function f(t){var r=function(e){return 3*e+1*(Math.random()-.5)},i=function(e){return 5*e+3*(Math.random()-.5)},s=function(e,t,n,s){return{p:[e[0]+r(t[0]),e[1]+r(t[1]),e[2]+r(t[2])],d:[i(t[0]),i(t[1]),i(t[2])],w:0}},o=function(t){a.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},u=function(){e.registerListener(e.list().PUFF_SMALL_WHITE,o)},a=new WorldParticles(t,n.GOO_PARTICLES.small_puff,s,u)}function l(t){var r=function(e,t,n,r){return{p:e,d:t,w:0}},i=function(t){o.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},s=function(){e.registerListener(e.list().PUFF_CLOUD_VAPOR,i)},o=new WorldParticles(t,n.GOO_PARTICLES.cloud_puff,r,s)}function c(t){var n=function(e,t,n,r){return{p:[e[0]+Math.random()*-0.5*2,e[1]+Math.random()*-0.5*2,e[2]+Math.random()*-0.5*2],d:[t[0]*(1+n),t[1]*(1+n),t[2]*(1+n)],w:0}},r=function(t){var n={lifespan:Math.random()*Math.random()*40*Math.random()*Math.random()};s.set(e.eventArgs(t).pos),o.set(e.eventArgs(t).dir),i.emit("playEffect",{effectName:"white_smoke_stream",pos:s,vel:o,effectData:n})};e.registerListener(e.list().ACROBATIC_SMOKE,r)}function h(t){var r=function(e,t){return 20*t*e+5*(Math.random()-.5)},i=function(e,t,n,i){return{p:[e[0]+t[0]*(1+n)*.5,e[1]+t[1]*(1+n)*.5,e[2]+t[2]*(1+n)*.5],d:[r(n,t[0]),r(n,t[1]),r(n,t[2])],w:n*25}},s=function(t){u.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},o=function(){e.registerListener(e.list().FLASH_MUZZLE_FIRE,s)},u=new WorldParticles(t,n.GOO_PARTICLES.muzzle_flash,i,o)}function p(t){var r=function(e,t,n,r){return{p:e,d:t,w:n*35}},i=function(t){o.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},s=function(){e.registerListener(e.list().FLASH_SPARKS,i)},o=new WorldParticles(t,n.GOO_PARTICLES.spark_flash,r,s)}function d(t){var r=function(e,t,n,r){return{p:e,d:t,w:n*5}},i=function(e){},s=function(){e.registerListener(e.list().FLASH_SHOCKWAVE,i)},o=new WorldParticles(t,n.GOO_PARTICLES.shockwave_hit,r,s)}function g(t){var n=Math.floor(Math.random()*4);Math.random()<v&&(e.fireEvent(e.list().ONESHOT_AMBIENT_SOUND,{soundData:e.sound()["SPLASH_"+n],pos:t,dir:[Math.random()-.5,Math.random()-.5,Math.random()-.5]}),v*=.5,clearTimeout(m),m=setTimeout(function(){v=1},200))}function y(t){var n=function(e,t,n,r){return{p:[e[0],e[1]+t[1]*n*(.7+Math.random()*.3),e[2]],d:[t[0],.01+.5*((n-1)*r*t[1]-.5*t[1]*(2*n-1)*r),t[2]],w:n*40}},u=function(t){g(e.eventArgs(t).pos),s.set(e.eventArgs(t).pos),o.set(0,3,0);var n={count:2,opacity:[1,1],alpha:"oneToZero",growthFactor:[3,12],growth:"oneToZero",stretch:0,strength:6,spread:.5,acceleration:.985,gravity:-9,rotation:[0,7],spin:"oneToZero",size:[.1,1.3],lifespan:[.1,2.4],spinspeed:[-0.02,.02],sprite:"splash_thick",loopcount:1,trailsprite:"projectile_1",trailwidth:1};i.emit("playWaterEffect",{pos:s,vel:r.UNIT_Y,effectData:n})};e.registerListener(e.list().SPLASH_WATER,u)}function b(t){var r=function(e,t,n,r){return{p:e,d:t,w:0}},i=function(t){o.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},s=function(){e.registerListener(e.list().SPLASH_RINGLET,i)},o=new WorldParticles(t,n.GOO_PARTICLES.water_ringlet,r,s)}function w(t){var r=function(e,t,n,r){return{p:e,d:t,w:0}},i=function(t){o.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},s=function(){e.registerListener(e.list().SPLASH_FOAM,i)},o=new WorldParticles(t,n.GOO_PARTICLES.water_foam,r,s)}function E(t){var r=function(e,t,n,r){return{p:e,d:t,w:0}},i=function(t){o.playEffect(e.eventArgs(t).pos,e.eventArgs(t).count,e.eventArgs(t).dir)},s=function(){e.registerListener(e.list().PUFF_RAPID_WHITE,i)},o=new WorldParticles(t,n.GOO_PARTICLES.rapid_puff,r,s)}function S(e){y(e),c(e)}var s=new r,o=new r,v=1,m;return{addWorldParticles:S}}),define("geometrypack/Surface",["goo/renderer/MeshData","goo/math/MathUtils"],function(e,t){function n(t,n,r){this.verts=t,this.vertsPerLine=n||2,this.verticallyClosed=!!r;var i=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]),s=this.verts.length/3,o=s/this.vertsPerLine;e.call(this,i,s,(o-1)*(this.vertsPerLine-1)*6),this.rebuild()}function r(e){var t=e[0],n=e[0],r=e[1],i=e[1];for(var s=3;s<e.length;s+=3)t=t<e[s+0]?t:e[s+0],n=n>e[s+0]?n:e[s+0],r=r<e[s+2]?r:e[s+2],i=i>e[s+2]?i:e[s+2];return{minX:t,maxX:n,minY:r,maxY:i}}return n.prototype=Object.create(e.prototype),n.prototype.rebuild=function(){this.getAttributeBuffer(e.POSITION).set(this.verts);var n=[],i=[],s=[],o=this.verts.length/3,u=o/this.vertsPerLine;for(var a=0;a<u-1;a++){for(var f=0;f<this.vertsPerLine-1;f++){var l=(a+0)*this.vertsPerLine+(f+0),c=(a+1)*this.vertsPerLine+(f+0),h=(a+1)*this.vertsPerLine+(f+1),p=(a+0)*this.vertsPerLine+(f+1);n.push(l,c,p,p,c,h),s=t.getTriangleNormal(this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2],this.verts[c*3+0],this.verts[c*3+1],this.verts[c*3+2],this.verts[p*3+0],this.verts[p*3+1],this.verts[p*3+2]),i.push(s[0],s[1],s[2])}if(this.verticallyClosed){var l=(a+0)*this.vertsPerLine+0,c=(a+1)*this.vertsPerLine+0,p=(a+0)*this.vertsPerLine+1;s=t.getTriangleNormal(this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2],this.verts[c*3+0],this.verts[c*3+1],this.verts[c*3+2],this.verts[p*3+0],this.verts[p*3+1],this.verts[p*3+2]),i.push(s[0],s[1],s[2])}else i.push(s[0],s[1],s[2])}a--;for(var f=0;f<this.vertsPerLine-1;f++){var l=(a+0)*this.vertsPerLine+(f+0),c=(a+1)*this.vertsPerLine+(f+0),p=(a+0)*this.vertsPerLine+(f+1);s=t.getTriangleNormal(this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2],this.verts[c*3+0],this.verts[c*3+1],this.verts[c*3+2],this.verts[p*3+0],this.verts[p*3+1],this.verts[p*3+2]),i.push(s[0],s[1],s[2])}i.push(s[0],s[1],s[2]),this.getAttributeBuffer(e.NORMAL).set(i),this.getIndexBuffer().set(n);var d=[],v=r(this.verts),m=v.maxX-v.minX,g=v.maxY-v.minY;for(var a=0;a<this.verts.length;a+=3){var y=(this.verts[a+0]-v.minX)/m,b=(this.verts[a+2]-v.minY)/g;d.push(y,b)}return this.getAttributeBuffer(e.TEXCOORD0).set(d),this},n.createFromHeightMap=function(e,t,r,i){t=t||1,r=r||1,i=i||1;var s=[];for(var o=0;o<e.length;o++)for(var u=0;u<e[o].length;u++)s.push(o*t,e[o][u]*r,u*i);return s.reverse(),new n(s,e[0].length)},n.createTessellatedFlat=function(e,t,r,i){var s=[];for(var o=0;o<r;o++)for(var u=0;u<i;u++)s.push(o*e/r-e*.5,u*t/i-t*.5,0);var a=new n(s,r);return a},n}),define("goo/addons/waterpack/FlatWaterRenderer",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Camera","goo/math/Plane","goo/renderer/pass/RenderTarget","goo/math/Vector3","goo/math/Vector4","goo/renderer/Material","goo/renderer/TextureCreator","goo/renderer/shaders/ShaderFragment"],function(e,t,n,r,i,s,o,u,a,f){function l(e){e=e||{},this.useRefraction=e.useRefraction!==undefined?e.useRefraction:!0,this.waterCamera=new n(45,1,.1,2e3),this.renderList=[],this.waterPlane=new r;var t=Math.floor(window.innerWidth/(e.divider||2)),f=Math.floor(window.innerHeight/(e.divider||2));this.reflectionTarget=new i(t,f),this.useRefraction&&(this.refractionTarget=new i(t,f),this.depthTarget=new i(t,f));var l=new u(c,"WaterMaterial");l.shader.defines.REFRACTION=this.useRefraction,l.cullState.enabled=!1;var p=e.normalsUrl||"../resources/water/waternormals3.png";l.setTexture("NORMAL_MAP",(new a).loadTexture2D(p)),l.setTexture("REFLECTION_MAP",this.reflectionTarget),this.useRefraction&&(l.setTexture("REFRACTION_MAP",this.refractionTarget),l.setTexture("DEPTH_MAP",this.depthTarget)),this.waterMaterial=l,this.followCam=!0,this.updateWaterPlaneFromEntity=e.updateWaterPlaneFromEntity!==undefined?this.updateWaterPlaneFromEntity:!0,this.calcVect=new s,this.camReflectDir=new s,this.camReflectUp=new s,this.camReflectLeft=new s,this.camLocation=new s,this.camReflectPos=new s,this.offset=new s,this.clipPlane=new o,this.waterEntity=null,this.depthMaterial=new u(h,"depth")}l.prototype.process=function(e,t,n,r,i){t=t.filter(function(e){return e.meshRendererComponent.isReflectable});var s=this.waterPlane;this.waterCamera.copy(r),this.updateWaterPlaneFromEntity&&(s.constant=this.waterEntity.transformComponent.transform.translation.y);var o=r.translation.y>s.constant;this.waterEntity.skip=!0;if(o){this.useRefraction&&(n.process(this.waterCamera,t,this.renderList),this.clipPlane.setd(s.normal.x,-s.normal.y,s.normal.z,s.constant),this.waterCamera.setToObliqueMatrix(this.clipPlane),e.render(this.renderList,this.waterCamera,i,this.depthTarget,!0,this.depthMaterial),e.render(this.renderList,this.waterCamera,i,this.refractionTarget,!0));var u=this.calcVect,a=this.camReflectDir,f=this.camReflectUp,l=this.camReflectLeft,c=this.camLocation,h=this.camReflectPos;c.set(r.translation);var p=s.pseudoDistance(c);u.set(s.normal).mul(p*2),h.set(c.sub(u)),c.set(r.translation).add(r._direction),p=s.pseudoDistance(c),u.set(s.normal).mul(p*2),a.set(c.sub(u)).sub(h).normalize(),c.set(r.translation).add(r._up),p=s.pseudoDistance(c),u.set(s.normal).mul(p*2),f.set(c.sub(u)).sub(h).normalize(),l.set(f).cross(a).normalize(),this.waterCamera.translation.set(h),this.waterCamera._direction.set(a),this.waterCamera._up.set(f),this.waterCamera._left.set(l),this.waterCamera.normalize(),this.waterCamera.update();if(this.skybox&&this.followCam){var d=this.skybox.transformComponent.worldTransform;d.translation.setv(h),d.update()}}this.waterMaterial.shader.uniforms.abovewater=o,n.process(this.waterCamera,t,this.renderList),e.setRenderTarget(this.reflectionTarget),e.clear();if(this.skybox)if(this.skybox instanceof Array){this.clipPlane.setd(s.normal.x,s.normal.y,s.normal.z,s.constant),this.waterCamera.setToObliqueMatrix(this.clipPlane,10);for(var v=0;v<this.skybox.length;v++)e.render(this.skybox[v],this.waterCamera,i,this.reflectionTarget,!1),this.skybox[v].skip=!0}else e.render(this.skybox,this.waterCamera,i,this.reflectionTarget,!1),this.skybox.skip=!0;this.clipPlane.setd(s.normal.x,s.normal.y,s.normal.z,s.constant),this.waterCamera.setToObliqueMatrix(this.clipPlane),e.render(this.renderList,this.waterCamera,i,this.reflectionTarget,!1),this.waterEntity.skip=!1;if(this.skybox)if(this.skybox instanceof Array)for(var v=0;v<this.skybox.length;v++)this.skybox[v].skip=!1;else this.skybox.skip=!1;if(o&&this.skybox&&this.followCam){var m=r.translation,d=this.skybox.transformComponent.worldTransform;d.translation.setv(m).addv(this.offset),d.update(),this.waterCamera._updatePMatrix=!0}},l.prototype.setSkyBox=function(e){this.skybox=e,e.meshRendererComponent&&(this.skybox.meshRendererComponent.materials[0].depthState.enabled=!1,this.skybox.meshRendererComponent.materials[0].renderQueue=0,this.skybox.meshRendererComponent.cullMode="Never")},l.prototype.setWaterEntity=function(e){this.waterEntity=e,this.waterEntity.meshRendererComponent.materials[0]=this.waterMaterial};var c={defines:{REFRACTION:!1},attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,normalMatrix:t.NORMAL_MATRIX,cameraTranslation:t.CAMERA_TRANSLATION,normalMap:"NORMAL_MAP",reflection:"REFLECTION_MAP",refraction:"REFRACTION_MAP",depthmap:"DEPTH_MAP",vertexTangent:[1,0,0,1],waterColor:[.0625,.0625,.0625],abovewater:!0,fogColor:[1,1,1],sunDirection:[.66,.66,.33],sunColor:[1,1,.5],sunShininess:100,sunSpecPower:4,fogStart:0,fogScale:2e3,timeMultiplier:1,time:t.TIME,distortionMultiplier:.025,fresnelPow:2,normalMultiplier:3,fresnelMultiplier:1,waterScale:5,doFog:!0,resolution:t.RESOLUTION},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform vec4 vertexTangent;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","uniform vec3 cameraTranslation;","uniform float waterScale;","varying vec2 texCoord0;","varying vec3 eyeVec;","varying vec4 viewCoords;","varying vec3 worldPos;","void main(void) {","	worldPos = (worldMatrix * vec4(vertexPosition, 1.0)).xyz;","	texCoord0 = (worldPos.xz + cameraTranslation.xz) * waterScale;","	vec3 n = normalize((normalMatrix * vec4(vertexNormal.x, vertexNormal.y, -vertexNormal.z, 0.0)).xyz);","	vec3 t = normalize((normalMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	vec3 b = cross(n, t) * vertexTangent.w;","	mat3 rotMat = mat3(t, b, n);","	vec3 eyeDir = worldPos - cameraPosition;","	eyeVec = eyeDir * rotMat;","	viewCoords = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewCoords;","}"].join("\n"),fshader:["uniform sampler2D normalMap;","uniform sampler2D reflection;","#ifdef REFRACTION","uniform sampler2D refraction;","uniform sampler2D depthmap;","#endif","uniform vec3 waterColor;","uniform bool abovewater;","uniform vec3 fogColor;","uniform float fogStart;","uniform float fogScale;","uniform float time;","uniform float timeMultiplier;","uniform float distortionMultiplier;","uniform float fresnelPow;","uniform vec3 sunDirection;","uniform vec3 sunColor;","uniform float sunShininess;","uniform float sunSpecPower;","uniform float normalMultiplier;","uniform float fresnelMultiplier;","uniform bool doFog;","uniform vec2 resolution;","varying vec2 texCoord0;","varying vec3 eyeVec;","varying vec4 viewCoords;","varying vec3 worldPos;","vec4 combineTurbulence(in vec2 coords) {","	float t = time * timeMultiplier;","	vec4 coarse1 = texture2D(normalMap, coords * vec2(0.0012, 0.001) + vec2(0.019 * t, 0.021 * t));","	vec4 coarse2 = texture2D(normalMap, coords * vec2(0.001, 0.0011) + vec2(-0.017 * t, 0.016 * t));","	vec4 detail1 = texture2D(normalMap, coords * vec2(0.008) + vec2(0.06 * t, 0.03 * t));","	vec4 detail2 = texture2D(normalMap, coords * vec2(0.006) + vec2(0.05 * t, -0.04 * t));","	return (detail1 * 0.25 + detail2 * 0.25 + coarse1 * 0.75 + coarse2 * 1.0) / 2.25 - 0.48;","}","#ifdef REFRACTION",f.methods.unpackDepth,"#endif","void main(void)","{","	float fogDist = clamp((viewCoords.z-fogStart)/fogScale,0.0,1.0);","	vec2 normCoords = texCoord0;","	vec4 noise = combineTurbulence(normCoords);","	vec3 normalVector = normalize(noise.xyz * vec3(normalMultiplier, normalMultiplier, 1.0));","	vec3 localView = normalize(eyeVec);","	float fresnel = dot(normalize(normalVector * vec3(fresnelMultiplier, fresnelMultiplier, 1.0)), localView);","	if ( abovewater == false ) {","		fresnel = -fresnel;","	}","	fresnel *= 1.0 - fogDist;","	float fresnelTerm = 1.0 - fresnel;","	fresnelTerm = pow(fresnelTerm, fresnelPow);","	fresnelTerm = clamp(fresnelTerm, 0.0, 1.0);","	fresnelTerm = fresnelTerm * 0.95 + 0.05;","	vec2 projCoord = viewCoords.xy / viewCoords.q;","	projCoord = (projCoord + 1.0) * 0.5;","	projCoord.y -= 1.0 / resolution.y;","#ifdef REFRACTION","	float depthUnpack = unpackDepth(texture2D(depthmap, projCoord));","	if (depthUnpack > 0.5) {depthUnpack = 0.0;}","	float depth2 = clamp(depthUnpack * 400.0, 0.0, 1.0);","	vec2 projCoordRefr = vec2(projCoord);","	projCoordRefr += (normalVector.xy * distortionMultiplier) * (depth2);","	projCoordRefr = clamp(projCoordRefr, 0.001, 0.999);","	depthUnpack = unpackDepth(texture2D(depthmap, projCoordRefr));","	float depth = clamp(depthUnpack * 40.0, 0.8, 1.0);","#endif","	projCoord += (normalVector.xy * distortionMultiplier);","	projCoord = clamp(projCoord, 0.001, 0.999);","	if ( abovewater == true ) {","		projCoord.x = 1.0 - projCoord.x;","	}","	vec4 waterColorX = vec4(waterColor, 1.0);","	vec4 reflectionColor = texture2D(reflection, projCoord);","	if ( abovewater == false ) {","		reflectionColor *= vec4(0.8,0.9,1.0,1.0);","		vec4 endColor = mix(reflectionColor,waterColorX,fresnelTerm);","		gl_FragColor = mix(endColor,waterColorX,fogDist);","	}","	else {","		vec3 sunSpecReflection = normalize(reflect(-sunDirection, normalVector));","		float sunSpecDirection = max(0.0, dot(localView, sunSpecReflection));","		vec3 specular = pow(sunSpecDirection, sunShininess) * sunSpecPower * sunColor;","		vec4 endColor = waterColorX;","#ifdef REFRACTION","		vec4 refractionColor = texture2D(refraction, projCoordRefr) * vec4(0.6);","		endColor = mix(refractionColor, waterColorX, depth);","#endif","		endColor = mix(endColor, reflectionColor, fresnelTerm);","		if (doFog) {","			gl_FragColor = (vec4(specular, 1.0) + mix(endColor,reflectionColor,fogDist)) * (1.0-fogDist) + vec4(fogColor, 1.0) * fogDist;","		} else {","			gl_FragColor = vec4(specular, 1.0) + mix(endColor,reflectionColor,fogDist);","		}","	}","}"].join("\n")},h={attributes:{vertexPosition:e.POSITION},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,farPlane:t.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec4 vPosition;","void main(void) {","	vPosition = worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewProjectionMatrix * vPosition;","}"].join("\n"),fshader:["uniform float farPlane;",f.methods.packDepth,"varying vec4 vPosition;","void main(void)","{","	float linearDepth = abs(vPosition.y) / farPlane;","	gl_FragColor = packDepth(linearDepth);","}"].join("\n")};return l}),define("game/world/StaticBatchBuilder",["application/EventManager","goo/shapes/Quad","goo/util/MeshBuilder","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","game/GameConfiguration","physics/PhysicalWorld"],function(e,t,n,r,i,s,o){function m(e,t){f[e].count==0&&h(e)}function g(e,t,n,r){console.log("Add TransformMesh: ",e,t,n),f[e]||alert("No batch queue registered for batchQueueId: "+e);var i=function(t,n){clearTimeout(f[e].addTimeout),f[e].materialBuilders[l[t].material.name].addMeshData(a[t].mesh,n),f[e].count-=1,f[e].materialBuilders[l[t].material.name].addMeshData(v,n),f[e].addTimeout=setTimeout(function(){m(e,t)},0)};p(e,t,n,r,i)}function y(e,t,n){f[e]={count:0,models:[],materialBuilders:{},material:null,physical:t,callback:n}}var u,a={},f={},l={},c=function(e,t){a[e]={mesh:t}},h=function(e){for(var t=0;t<f[e].models.length;t++){var n=f[e].materialBuilders[l[f[e].models[t]].material.name].build();for(var s in n){console.log("Add: ",n[s]);var a=u.world.createEntity(),c=new r(n[s]);f[e].physical&&o.addPhysicalWorldMesh(n[s],0,0,0),a.setComponent(c);var h=new i;h.materials.push(l[f[e].models[t]].material),h.castShadows=!1,h.isReflectable=!1,h.receiveShadows=!1,a.setComponent(h),a.addToWorld()}}var p=f[e].callback;setTimeout(function(){p()},150),delete f[e]},p=function(t,r,i,s,o){f[t].count+=1;if(!a[i]){l[i]={};var u=function(e){var r=e.transformComponent.children[0].entity.meshDataComponent.meshData;l[i].material=e.transformComponent.children[0].entity.meshRendererComponent.materials[0],c(i,r),f[t].models.push(i),f[t].materialBuilders[l[i].material.name]||(f[t].materialBuilders[l[i].material.name]=new n),console.log("StaticBatch:",t,a,l[i].material.name),o(i,s)};console.log(r,i),e.fireEvent(e.list().BUILD_GOO_GAMEPIECE,{projPath:r,modelPath:i,callback:u})}else f[t].material=l[i].material,o(i,s)},d,v=new t(.001,.001,1),b=function(t){u=e.eventArgs(t).goo};return e.registerListener(e.list().ENINGE_READY,b),{addTransformedMeshToBatchQueue:g,registerBatchQueue:y}}),define("game/world/NatureWorld",["application/EventManager","goo/math/Vector3","game/EntityController","game/GameUtil","3d/HeightmapManager","game/GameConfiguration","goo/util/MeshBuilder","goo/math/Transform","game/world/StaticBatchBuilder","3d/GooEffectController","3d/addons/Vegetation"],function(e,t,n,r,i,s,o,u,a,f,l){var c,h,p=[],d=function(t){var n=s.GOO_PROJECTS.nature.projectPath,r=s.GOO_PROJECTS.nature.folder,i=s.GOO_PROJECTS.nature.entityIds;e.fireEvent(e.list().LOAD_GOO_PROJECT,{projectPath:n,folder:r,entityIds:i,callback:t})},v=function(e,t,n){console.log("Add Vegetation: ",t);var r=[],s=function(e,t){return i.readTerrainCanvasAlphaAtPos(e,t)},o=function(e,t,n){y(e,9,t,n)};for(var u in t)r.push(new l(e,i,t[u]));var a=function(){r.length==0?n():f()},f=function(){var e=r.shift(),t=e.init(i,s,o);t.resolve=a};a()},m=function(e,t){var n=f.getSettings()["Lots of Trees"].fx.manyTrees*3+2;c=t,h=0;for(var r in e)h+=1,p.push([r,e[r].zoneData.tree_spread/n,e[r].dimensions]),console.log("Populate Terrain: ",r,e[r]);var i=function(){if(p.length==0)c();else{var e=p.pop();g(e[0],e[1],e[2],i),console.log("Populate Terrain next: ",e)}},s=function(){i()};d(s)},g=function(t,n,r,i){function s(){i(),e.fireEvent(e.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"add_trees_"+t})}e.fireEvent(e.list().LOAD_PROGRESS,{started:1,completed:0,errors:0,id:"add_trees_"+t});var o="trees_"+t;a.registerBatchQueue(o,!0,s),w(o,n,r)},y=function(e,t,n,r){for(var s=0;s<t;s++){var o=[e[0]+r*(Math.random()-.5)*Math.random(),e[1],e[2]+r*(Math.random()-.5)*Math.random()];i.paintTerrainPoint(o,n*Math.random(),{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.12]}),i.paintTerrainPoint(o,n*.5+(Math.random()-.5),{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.06]}),i.paintTerrainPoint(o,n*4*(Math.random()-.5),{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.02]}),i.paintTerrainPoint(o,n*8*Math.random(),{color:[.1*Math.random(),.1*Math.random(),.1*Math.random(),.01]})}},b=function(e){var t=i.getCanvasRGBAAtPos(e);return t[3]/255},w=function(e,t,n){var r=[s.GOO_PROJECTS.nature.tree_leafy,s.GOO_PROJECTS.nature.tree_leafy,s.GOO_PROJECTS.nature.tree_leafy_small,s.GOO_PROJECTS.nature.tree_leafy_small,s.GOO_PROJECTS.nature.tree_leafy_small],o=n,u=o.minX+(o.maxX-o.minX)*.5,a=o.minZ+(o.maxZ-o.minZ)*.5,f=[u,o.minY+1,a],l=i.getTerrainCanvasDataAtPos(f),c=n.maxX-n.minX;for(var h=0;h<Math.floor(c/t);h++)for(var p=0;p<Math.floor(c/t);p++){var d=n.minX+(h*t+t*.5+t*Math.random()),v=n.minZ+(p*t+t*.5+t*Math.random()),m=i.getHeightAboveGroundAtPos([d,0,v]),g=i.readTerrainCanvasAlphaAtPos(l,[d,m,v]);if(m!==null&&g<.3){var b=i.getGroundNormal([d,0,v]);if(b!==null){var w=i.getGroundSlope(b);if(w<.09&&m<-3&&m>-455){var S=Math.floor(Math.random()*r.length),x=r[S];E(e,x,[d,-m,v],b),y([d,-m,v],35,2,30)}}}}},E=function(e,n,r,i){console.log("Push mesh:",r);var s=function(e){var n=new u,r=.5+1.8*Math.random()*Math.random();return n.translation.x=e[0],n.translation.y=e[1],n.translation.z=e[2],i.muld(1,1.5,1),n.lookAt(i,t.UNIT_Y),n.rotation.rotateY(.1*Math.random()*.2),n.rotation.rotateZ(.1-Math.random()*10.2),n.rotation.rotateX(.1*Math.random()*.2),n.scale.set(r+.2*Math.random(),r+.2*Math.random(),r+.2*Math.random()),n.update(),n},o=s(r)};return{populateTrees:m,populateVegetation:v}}),define("game/world/BuiltWorld",["application/EventManager","goo/math/Vector3","game/EntityController","game/GameUtil","3d/HeightmapManager","game/GameConfiguration","goo/util/MeshBuilder","goo/math/Transform","game/world/StaticBatchBuilder"],function(e,t,n,r,i,s,o,u,a){var f,l=[],c={},h=function(t,n){for(var r=0;r<t.length;r++){console.log(c);for(var i=0;i<t[r].gooProjects.length;i++)c[t[r].gooProjects[i].refFile]=t[r].gooProjects[i].projectPath,console.log(c)}var s=0,o=function(){s-=1,console.log(s),s==0&&n()};for(var u in c)s+=1,e.fireEvent(e.list().LOAD_GOO_PROJECT,{projectPath:c[u],folder:u,callback:o});s||n()},p=function(e,t,n){var r=function(){f=n;for(var r=0;r<e.length;r++){console.log("Load Level: ",r,e[r],e[r].zoneId,t,t[e[r].zoneId]);var i=[e[r],t[e[r].zoneId],e[r].zoneId+"_"+r];l.push(i)}var s=function(){if(l.length==0)f();else{var e=l.pop();d(e[0],e[1],e[2],s)}};s()};h(e,r)},d=function(t,n,r,i){function o(){e.fireEvent(e.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"add_building_"+r}),i()}console.log("BUILD BUILDINGS WORLD: ",t,n);var s=n.zoneData.pos;e.fireEvent(e.list().LOAD_PROGRESS,{started:1,completed:0,errors:0,id:"add_building_"+r}),a.registerBatchQueue(r,!0,o);for(var u=0;u<t.buildings.length;u++){var f=t.buildings[u].model;for(var l=0;l<t.buildings[u].entries.length;l++){var c=t.buildings[u].entries[l];v(r,f,[s[0]+c.pos[0],s[1]+c.pos[1],s[2]+c.pos[2]],c.rot)}}},v=function(e,t,n,r){console.log("ADD TO BATCH: ",e,t,n,r);var s=i.getHeightAboveGroundAtPos(n);n[1]-=s;if(s!==null){var o=i.getGroundNormal(n);m(e,t,n,r,o)}},m=function(e,n,r,i,s){var o=function(e){var n=new u;return n.translation.x=e[0],n.translation.y=e[1],n.translation.z=e[2],n.lookAt(s,t.UNIT_Y),n.rotation.rotateZ(i[1]),n.update(),n};console.log("ADD TO POS: ",e,r);var a=o(r)};return{populateBuildings:p}}),define("game/world/ZoneBuilder",["application/EventManager","game/world/NatureWorld","game/world/BuiltWorld"],function(e,t,n){function r(e,r,i,s){console.log(r,i);var o=function(){s()},u=function(){t.populateVegetation(e,i,o)},a=function(){t.populateTrees(i,u)};n.populateBuildings(r,i,a)}return{buildTerrainZone:r}}),define("environment/Lighting",["goo/entities/EntityUtils","goo/renderer/light/DirectionalLight","goo/math/Vector3","goo/entities/components/LightComponent","goo/renderer/shaders/ShaderBuilder"],function(e,t,n,r,i){var s=function(e){this.goo=e,this.tempVec=new n,this.shadowReso=128,this.shadowNear=3.2,this.shadowSize=25,this.shadowFar=27,this.shadowType="basic",this.baseFogNear=50,this.baseFogFar=2e4,this.sunBoost=1.5,this.ambientBoost=.7,this.lightEntity,this.dirLight,this.lightComp};return i.USE_FOG=!0,s.prototype.setBaseFogNearFar=function(e,t){this.baseFogNear=e,this.baseFogFar=t},s.prototype.setSunlightColor=function(e){this.dirLight.color.setd(e[0]*(1+Math.random()*.003)*this.sunBoost,e[1]*(1+Math.random()*.002)*this.sunBoost,e[2]*(1+Math.random()*.005)*this.sunBoost,1)},s.prototype.setAmbientColor=function(e){i.GLOBAL_AMBIENT=[e[0]*(1+Math.random()*.003)*this.ambientBoost,e[1]*(1+Math.random()*.002)*this.ambientBoost,e[2]*(1+Math.random()*.005)*this.ambientBoost,1]},s.prototype.setFogColor=function(e){i.FOG_COLOR=e},s.prototype.scaleFogNearFar=function(e,t){this.setFogNearFar(this.baseFogNear*e,this.baseFogFar*t)},s.prototype.setFogNearFar=function(e,t){i.FOG_SETTINGS=[e,t],i.USE_FOG=!0},s.prototype.setSunlightDirection=function(e){this.tempVec.set(-e[2],-e[1],-e[0]),this.lightEntity.transformComponent.transform.lookAt(this.tempVec,n.UNIT_Y),this.lightEntity.transformComponent.setUpdated()},s.prototype.setupMainLight=function(){return console.log("Setup Main Light"),this.lightEntity=this.goo.world.createEntity("Light1"),this.dirLight=new t,this.dirLight.color.setd(1,.95,.85,1),this.dirLight.specularIntensity=1,this.dirLight.intensity=1,this.lightComp=new r(this.dirLight),this.lightComp.light.shadowCaster=!1,this.lightComp.light.shadowSettings.darkness=.9,this.lightComp.light.shadowSettings.near=this.shadowNear,this.lightComp.light.shadowSettings.far=this.shadowFar,this.lightComp.light.shadowSettings.size=this.shadowSize,this.lightComp.light.shadowSettings.shadowType=this.shadowType,this.lightComp.light.shadowSettings.resolution=[this.shadowReso,this.shadowReso],console.log("lightComp ---- ",this.lightComp),this.lightEntity.setComponent(this.lightComp),this.lightEntity.transformComponent.transform.translation.setd(0,0,0),this.lightEntity.transformComponent.transform.lookAt(new n(-0.5,-0.4,.43),n.UNIT_Y),this.lightEntity.addToWorld(),this.lightEntity},s}),define("environment/editor/EnvEditorGui",[],function(){var e=function(e){this.editorAPI=e};return e.prototype.startEditOfConfig=function(e){this.buildGUI(e)},e.prototype.addTextureControls=function(e,t){if(!t.image)return;var n={edit:!1,img:t.image.currentSrc,repeatX:t.repeat[0],repeatY:t.repeat[1],offsetX:.01,offsetY:.01},r=e.add(n,"edit");r.onFinishChange(function(e){console.log("Tx edit end: ",t,n),t.repeat[0]=n.repeatX,t.repeat[1]=n.repeatY,t.offset[0]=n.offsetX,t.offset[1]=n.offsetY,t.setNeedsUpdate()});var i=e.add(n,"repeatX",.1,10),s=e.add(n,"repeatY",.1,10),o=e.add(n,"offsetX",0,1),u=e.add(n,"offsetY",0,1);i.onValueChange=function(e){t.repeat[0]=e,t.setNeedsUpdate(),console.log("Tx edit: ",t)},s.onFinishChange=function(e){t.repeat[1]=e,t.setNeedsUpdate()}},e.prototype.removeEditorGui=function(){try{this.gui&&this.gui.destroy()}catch(e){console.log("dat.gui crashed"),window.document.body.removeChild(this.gui.domElement)}delete this.gui},e.prototype.buildGUI=function(e,t){this.gui=new dat.GUI,window.document.body.appendChild(this.gui.domElement),this.gui.domElement.style.zIndex="10000",this.gui.domElement.style.position="absolute",this.gui.domElement.style.top="0px",this.gui.domElement.style.right="300px";var n=this;this.guiFolders=[];var r=this.gui.addFolder("Environemnt"),i={edit:!1,fogNear:t.baseFogNear,fogFar:t.baseFogFar,baseCycleDuration:t.baseCycleDuration},s=r.add(i,"fogNear",1,2e3),o=r.add(i,"fogFar",1e3,3e4),u=r.add(i,"baseCycleDuration",200,4e4);s.onChange(function(t){console.log("Fog Near Change",t,i.fogNear),e.fogGlobalsUpdate(i.fogNear,i.fogFar)}),o.onChange(function(t){console.log("Fog Near Change",t,i.fogNear),e.fogGlobalsUpdate(i.fogNear,i.fogFar)}),u.onChange(function(t){console.log("Day Duration Change",t,i.baseCycleDuration),e.baseCycleUpdate(i.baseCycleDuration)});var a={Save:function(){console.log("Save environemnt data here...")}};r.add(a,"Save")},e}),define("environment/editor/EnvEditorAPI",["environment/editor/EnvEditorGui"],function(e){var t=function(e){this.dynamicEnvironemnt=e};return t.prototype.getEnvironmentGlobals=function(){return this.dynamicEnvironemnt.globals},t.prototype.fogGlobalsUpdate=function(e,t){this.dynamicEnvironemnt.setFogGlobals(e,t)},t.prototype.baseCycleUpdate=function(e){this.dynamicEnvironemnt.setDayStepDuration(e)},t.prototype.openEnvEditor=function(){var t=new e(this);t.buildGUI(this,this.dynamicEnvironemnt.globals),console.log("Start Environment editor")},t}),define("goo/geometrypack/Surface",["goo/renderer/MeshData","goo/math/MathUtils"],function(e,t){function n(t,n,r){this.verts=t,this.vertsPerLine=n||2,this.verticallyClosed=!!r;var i=e.defaultMap([e.POSITION,e.NORMAL,e.TEXCOORD0]),s=this.verts.length/3,o=s/this.vertsPerLine;e.call(this,i,s,(o-1)*(this.vertsPerLine-1)*6),this.rebuild()}function r(e){var t=e[0],n=e[0],r=e[1],i=e[1];for(var s=3;s<e.length;s+=3)t=t<e[s+0]?t:e[s+0],n=n>e[s+0]?n:e[s+0],r=r<e[s+2]?r:e[s+2],i=i>e[s+2]?i:e[s+2];return{minX:t,maxX:n,minY:r,maxY:i}}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.rebuild=function(){this.getAttributeBuffer(e.POSITION).set(this.verts);var n=[],i=[],s=[],o=this.verts.length/3,u=o/this.vertsPerLine;for(var a=0;a<u-1;a++){for(var f=0;f<this.vertsPerLine-1;f++){var l=(a+0)*this.vertsPerLine+(f+0),c=(a+1)*this.vertsPerLine+(f+0),h=(a+1)*this.vertsPerLine+(f+1),p=(a+0)*this.vertsPerLine+(f+1);n.push(l,c,p,p,c,h),s=t.getTriangleNormal(this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2],this.verts[c*3+0],this.verts[c*3+1],this.verts[c*3+2],this.verts[p*3+0],this.verts[p*3+1],this.verts[p*3+2]),i.push(s[0],s[1],s[2])}if(this.verticallyClosed){var l=(a+0)*this.vertsPerLine+0,c=(a+1)*this.vertsPerLine+0,p=(a+0)*this.vertsPerLine+1;s=t.getTriangleNormal(this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2],this.verts[c*3+0],this.verts[c*3+1],this.verts[c*3+2],this.verts[p*3+0],this.verts[p*3+1],this.verts[p*3+2]),i.push(s[0],s[1],s[2])}else i.push(s[0],s[1],s[2])}a--;for(var f=0;f<this.vertsPerLine-1;f++){var l=(a+0)*this.vertsPerLine+(f+0),c=(a+1)*this.vertsPerLine+(f+0),p=(a+0)*this.vertsPerLine+(f+1);s=t.getTriangleNormal(this.verts[l*3+0],this.verts[l*3+1],this.verts[l*3+2],this.verts[c*3+0],this.verts[c*3+1],this.verts[c*3+2],this.verts[p*3+0],this.verts[p*3+1],this.verts[p*3+2]),i.push(s[0],s[1],s[2])}i.push(s[0],s[1],s[2]),this.getAttributeBuffer(e.NORMAL).set(i),this.getIndexBuffer().set(n);var d=[],v=r(this.verts),m=v.maxX-v.minX,g=v.maxY-v.minY;for(var a=0;a<this.verts.length;a+=3){var y=(this.verts[a+0]-v.minX)/m,b=(this.verts[a+2]-v.minY)/g;d.push(y,b)}return this.getAttributeBuffer(e.TEXCOORD0).set(d),this},n.createFromHeightMap=function(e,t,r,i){t=t||1,r=r||1,i=i||1;var s=[];for(var o=0;o<e.length;o++)for(var u=0;u<e[o].length;u++)s.push(o*t,e[o][u]*r,u*i);return s.reverse(),new n(s,e[0].length)},n.createTessellatedFlat=function(e,t,r,i){var s=[];for(var o=0;o<r;o++)for(var u=0;u<i;u++)s.push(o*e/r-e*.5,u*t/i-t*.5,0);var a=new n(s,r);return a},n}),define("environment/Water",["goo/renderer/Material","goo/geometrypack/Surface","goo/entities/EntityUtils","goo/renderer/shaders/ShaderLib","goo/renderer/TextureCreator","goo/addons/waterpack/FlatWaterRenderer"],function(e,t,n,r,i,s){var o=function(n,i,s){this.folderUrl=s;var o=t.createTessellatedFlat(291500,291500,40,40),u=new e("water_material",r.simple);this.waterEntity=n.world.createEntity(o,u),this.waterEntity.transformComponent.transform.setRotationXYZ(-Math.PI/2,0,0),this.waterEntity.addToWorld(),this.waterRenderer=this.loadWaterShader(n,i,u),this.waterRenderer.waterMaterial.shader.uniforms.doFog=!0,this.baseFogNear=50,this.baseFogFar=2e4};return o.prototype.setBaseFogNearFat=function(e,t){this.baseFogNear=e,this.baseFogFar=t},o.prototype.updateWaterEnvironment=function(e,t,n,r){this.waterRenderer.waterMaterial.shader.uniforms.sunColor[0]=e[0],this.waterRenderer.waterMaterial.shader.uniforms.sunColor[1]=e[1],this.waterRenderer.waterMaterial.shader.uniforms.sunColor[2]=e[2],this.waterRenderer.waterMaterial.shader.uniforms.sunDirection[0]=t[2],this.waterRenderer.waterMaterial.shader.uniforms.sunDirection[1]=t[0],this.waterRenderer.waterMaterial.shader.uniforms.sunDirection[2]=t[1],this.waterRenderer.waterMaterial.shader.uniforms.fogColor[0]=n[0],this.waterRenderer.waterMaterial.shader.uniforms.fogColor[1]=n[1],this.waterRenderer.waterMaterial.shader.uniforms.fogColor[2]=n[2],this.waterRenderer.waterMaterial.shader.uniforms.fogStart=this.baseFogNear*r[0],this.waterRenderer.waterMaterial.shader.uniforms.fogScale=this.baseFogFar*r[1]},o.prototype.loadWaterShader=function(e,t,n){var r=new s({normalsUrl:this.folderUrl+"/waternormals3.png",useRefraction:!1});return e.renderSystem.preRenderers.push(r),r.setWaterEntity(this.waterEntity),r.setSkyBox(t),r.waterMaterial.shader.uniforms.fogColor=[.5,.7,1],r.waterMaterial.shader.uniforms.sunDirection=[-0.5,-0.1,.23],r.waterMaterial.shader.uniforms.sunColor=[1,.7,.2],r.waterMaterial.shader.uniforms.waterColor=[0,0,.03],r.waterMaterial.shader.uniforms.sunShininess=50,r.waterMaterial.shader.uniforms.sunSpecPower=.7,r.waterMaterial.shader.uniforms.fogStart=1e4,r.waterMaterial.shader.uniforms.waterScale=8,r.waterMaterial.shader.uniforms.distortionMultiplier=.04,r.waterMaterial.shader.uniforms.fogScale=5e4,r.waterMaterial.shader.uniforms.fresnelPow=1.3,r.waterMaterial.shader.uniforms.normalMultiplier=5,r.waterMaterial.shader.uniforms.fresnelMultiplier=.3,r},o}),define("environment/EnvironmentData",[],function(){var e=[{name:"predawn",values:{sunLight:[.4,.3,.2],sunDir:[-0.8,.3,.2],ambientLight:[.1,.3,.8],skyColor:[.1,.4,.6],fogColor:[.4,.65,.74],fogDistance:[.2,1.2]}},{name:"dawn",values:{sunLight:[.7,.5,.4],sunDir:[-0.5,.1,-0.2],ambientLight:[.1,.5,.8],skyColor:[.3,.6,.8],fogColor:[.4,.65,.81],fogDistance:[.1,1.3]}},{name:"morning",values:{sunLight:[.7,.65,.5],sunDir:[-0.6,-0.3,-0.3],ambientLight:[.4,.4,.7],skyColor:[.6,.6,.81],fogColor:[.68,.71,.81],fogDistance:[.1,1.4]}},{name:"day",values:{sunLight:[.96,.85,.6],sunDir:[-0.4,-0.6,-0.4],ambientLight:[.4,.5,.8],skyColor:[.61,.68,.74],fogColor:[.69,.71,.81],fogDistance:[.3,1.9]}},{name:"noon",values:{sunLight:[.96,.8,.6],sunDir:[-0.2,-0.9,-0.4],ambientLight:[.3,.5,.7],skyColor:[.62,.65,.75],fogColor:[.71,.72,.81],fogDistance:[.3,2.8]}},{name:"afternoon",values:{sunLight:[.9,.7,.5],sunDir:[-0.2,-0.7,-0.4],ambientLight:[.3,.4,.6],skyColor:[.4,.55,.78],fogColor:[.6,.68,.79],fogDistance:[.5,1.7]}},{name:"evening",values:{sunLight:[.7,.6,.3],sunDir:[.4,-0.21,-0.4],ambientLight:[.7,.5,.4],skyColor:[.6,.5,.4],fogColor:[.6,.5,.3],fogDistance:[.1,1.1]}},{name:"dusk",values:{sunLight:[.6,.4,.4],sunDir:[.5,.5,.2],ambientLight:[.6,.4,.3],skyColor:[.5,.3,.2],fogColor:[.5,.35,.3],fogDistance:[.1,.8]}},{name:"night1",values:{sunLight:[.5,.2,.4],sunDir:[.4,-0.3,.6],ambientLight:[.1,.1,.5],skyColor:[.1,0,.4],fogColor:[0,0,.1],fogDistance:[.1,.7]}},{name:"night2",values:{sunLight:[.2,.1,.2],sunDir:[-0.3,-0.6,.8],ambientLight:[.1,.1,.4],skyColor:[0,.1,.3],fogColor:[0,0,.1],fogDistance:[.1,.7]}}],t={baseFogNear:150,baseFogFar:2e4,baseCycleDuration:1e4,startCycleIndex:0};return{globals:t,cycles:e}}),define("environment/DynamicEnvironment",["environment/editor/EnvEditorAPI","goo/entities/SystemBus","goo/math/Vector3","environment/Water","environment/EnvironmentData"],function(e,t,n,r,i){var s=function(t){this.lighting=t,this.waterSettings=i.waterSettings,this.stepDuration,this.stepProgress,this.cycleIndex,this.envState={sunLight:new n,sunDir:new n,ambientLight:new n,skyColor:new n,fogColor:new n,fogDistance:new n},this.tempVec=new n,this.environments=i.cycles,this.globals=i.globals,this.lastUpdate=0,this.lighting.setBaseFogNearFar(this.globals.baseFogNear,this.globals.baseFogFar),this.cycleIndex=this.globals.startCycleIndex,this.setDayStepDuration(this.globals.baseCycleDuration),this.stepProgress=0,this.paused=!1;var r=function(e){document.getElementById("time_pause").addEventListener("click",function(){e.togglePauseTime()},!1)},s=function(t){var n=new e(t),r=function(e){document.getElementById("EditEnvironment").addEventListener("click",function(){e.openEnvEditor()},!1)};r(n)};this.setCycleData(i.cycles),this.addEnvEffects()};return s.prototype.setCycleData=function(e){this.environments=e},s.prototype.setGlobals=function(e){for(var t in e)this.globals[t]=e[t];this.setDayStepDuration(this.globals.baseCycleDuration)},s.prototype.playWaterEffect=function(e,n,r){var i=Math.random()*.16;r.color0=[this.envState.skyColor.data[0]*.5+this.envState.sunLight.data[0]*.5+Math.random()*.04+i,this.envState.skyColor.data[1]*.5+this.envState.sunLight.data[1]*.5+Math.random()*.04+i,this.envState.skyColor.data[2]*.5+this.envState.sunLight.data[2]*.5+Math.random()*.04+i],r.color1=r.color0,r.opacity=[.8,.4],t.emit("playParticles",{simulatorId:"StandardParticle",pos:e,vel:n,effectData:r})},s.prototype.playCloudEffect=function(e,n,r){r.color0=[this.envState.skyColor.data[0]*.5+this.envState.sunLight.data[0]*.6+Math.random()*.1,this.envState.skyColor.data[1]*.5+this.envState.sunLight.data[1]*.6+Math.random()*.1,this.envState.skyColor.data[2]*.5+this.envState.sunLight.data[2]*.6+Math.random()*.1],r.color1=r.color0,r.opacity=[.1,.2],t.emit("playParticles",{simulatorId:"StandardParticle",pos:e,vel:n,effectData:r})},s.prototype.playVaporEffect=function(e,n,r){r.color0=[Math.sqrt(this.envState.skyColor.data[0]*.5+this.envState.sunLight.data[0]*.5+Math.random()*.1),Math.sqrt(this.envState.skyColor.data[1]*.5+this.envState.sunLight.data[1]*.5+Math.random()*.1),Math.sqrt(this.envState.skyColor.data[2]*.5+this.envState.sunLight.data[2]*.5+Math.random()*.1)],r.color1=r.color0,r.opacity=[.1,.4],t.emit("playParticles",{simulatorId:"StandardParticle",pos:e,vel:n,effectData:r})},s.prototype.addEnvEffects=function(){var e=function(e){this.playWaterEffect(e.pos,e.vel,e.effectData)}.bind(this),n=function(e){this.playCloudEffect(e.pos,e.vel,e.effectData)}.bind(this),r=function(e){this.playVaporEffect(e.pos,e.vel,e.effectData)}.bind(this);t.addListener("playWaterEffect",e),t.addListener("playCloudEffect",n),t.addListener("playVaporEffect",r)},s.prototype.addWater=function(e,t,n){this.water=new r(e,t,n)},s.prototype.setFogGlobals=function(e,t){this.globals.baseFogNear=e,this.globals.baseFogFar=t,this.lighting.setBaseFogNearFar(this.globals.baseFogNear,this.globals.baseFogFar),this.water.setBaseFogNearFat(this.globals.baseFogNear*4,this.globals.baseFogFar*48)},s.prototype.setDayStepDuration=function(e){this.stepDuration=e/this.environments.length},s.prototype.togglePauseTime=function(){this.paused=!this.paused,console.log("Pause env time: ",this.paused)},s.prototype.getEnvironmentState=function(){return{fogColor:this.envState.fogColor.data,sunLight:this.envState.sunLight.data,ambientLight:this.envState.ambientLight.data,sunDir:this.envState.sunDir.data,skyColor:this.envState.skyColor.data,fogDistance:this.envState.fogDistance.data}},s.prototype.stepCycle=function(){this.cycleIndex+=1,this.stepProgress=0,this.cycleIndex==this.environments.length&&(this.cycleIndex=0)},s.prototype.applyEnvStateToColors=function(){var e=this.getEnvironmentState();this.lighting.setAmbientColor([this.envState.ambientLight.data[0],this.envState.ambientLight.data[1],this.envState.ambientLight.data[2]]),this.lighting.scaleFogNearFar(this.envState.fogDistance[0],this.envState.fogDistance[1]),this.lighting.setFogColor([e.fogColor[0],e.fogColor[1],e.fogColor[2]]),this.lighting.setSunlightDirection(this.envState.sunDir.data),this.lighting.setSunlightColor(this.envState.sunLight.data),this.water.updateWaterEnvironment(e.sunLight,e.sunDir,e.fogColor,e.fogDistance)},s.prototype.applyTimeOfDayUpdate=function(e){this.cycleIndex=Math.floor(e*(this.environments.length-1))},s.prototype.advanceTime=function(e){if(this.paused)return;this.lastUpdate-=e,this.stepProgress+=e,this.stepFraction=e/this.stepDuration,this.stepProgress>=this.stepDuration&&this.stepCycle();for(var t in this.environments[this.cycleIndex].values)this.tempVec.set(this.environments[this.cycleIndex].values[t]),this.envState[t].lerp(this.tempVec,this.stepFraction);if(this.lastUpdate>0)return;this.lastUpdate=.4,this.applyEnvStateToColors()},s}),define("environment/DynamicSkysphere",["goo/renderer/Material","goo/shapes/Sphere","goo/entities/EntityUtils","goo/renderer/shaders/ShaderLib","goo/util/Skybox","goo/renderer/shaders/ShaderBuilder","goo/renderer/Shader","goo/renderer/MeshData","goo/entities/components/MeshRendererComponent","goo/renderer/TextureCreator","goo/renderer/Texture"],function(e,t,n,r,i,s,o,u,a,f,l){var c=function(e){return"rgb("+Math.floor(e[0]*255)+","+Math.floor(e[1]*255)+","+Math.floor(e[2]*255)+")"},h=function(n){function m(n,r,s){var o=t.TextureModes.Linear,u=new i("sphere",[],o,0),f=u.meshData,l=n.world.createEntity(f),c=new e("skyMat",r);return c.setTexture("DIFFUSE_MAP",s),l.set(new a(c)),c.cullState.enabled=!1,c.depthState.write=!1,c.renderQueue=2,l.transformComponent.transform.rotation.rotateX(Math.PI*.5),l.transformComponent.transform.scale.mul(900),l.meshRendererComponent.cullMode="Never",l}o=n;var o;this.goo=o;var u,f,c=4,h=64;this.width=c,this.height=h;var p="darker",d="lighter",v=function(e){u=document.createElement("canvas"),u.id="sky_canvas",u.width=c,u.height=h,u.dataReady=!0;var t=new l(u,{wrapS:"EdgeClamp",wrapT:"EdgeClamp"},u.width,u.height);return f=u.getContext("2d"),e.ctx=f,t};this.tx=v(this),this.setColor([.7,.8,1],[.4,.3,.7],[.4,.6,1],1),this.skyEntity=m(o,r.textured,this.tx),s.SKYSPHERE=this.tx,this.skyEntity.addToWorld(),this.width=c,this.height=h};return h.prototype.setColor=function(e,t,n,r){var i=Math.min(r*25e-5,.099),s=this.ctx.createLinearGradient(0,0,0,this.height);s.addColorStop(1,c([t[0]*n[0],t[1]*n[1],t[2]*n[2]])),s.addColorStop(.627+i,c([n[0]*(1-i),n[1]*(1-i),n[2]*(1-i)])),s.addColorStop(.5,c(e)),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.width,this.height),this.tx.setNeedsUpdate()},h.prototype.makeSun=function(){var n=new t(25,25,220);this.sunmat=new e("SunMaterial",r.simpleColored),this.sunmat.shader.uniforms.color=[1,1,.98],this.sunmat.cullState.enabled=!1,this.sunmat.depthState.write=!1,this.sunmat.renderQueue=3,this.sun=this.goo.world.createEntity(n,this.sunmat),this.sun.transformComponent.transform.translation.set(0,1e4,0),this.sun.meshRendererComponent.isReflectable=!1,this.sun.addToWorld()},h.prototype.setSunColor=function(e){this.sunmat.shader.uniforms.color=[Math.sqrt(e[0]*.5+.5),Math.sqrt(e[1]*.5+.5),Math.sqrt(e[2]*.5+.5)]},h.prototype.setSunXYZ=function(e,t,n){this.sun.transformComponent.transform.translation.set(e,t,n),this.sun.transformComponent.setUpdated()},h}),define("environment/Clouds",["goo/math/Vector3","goo/entities/SystemBus"],function(e,t){var n=function(){this.hitVec=new e,this.hitNorm=new e,this.clouds=[],this.cloudScale=5,this.lastPuffIndex=0,this.cloudBaseHeight=400,this.effectData={size:[1220,2880],gravity:0,count:1,lifespan:[3.1,4.8],opacity:[.2,.7],alpha:"zeroOneZero",growthFactor:[0,5],growth:"oneToZero",stretch:0,strength:100,spread:1,acceleration:0,rotation:[0,7],spin:"oneToZero",spinspeed:[0,0],sprite:"smokey"}};return n.prototype.makeCloudPuff=function(e){this.hitVec.set(this.clouds[e][0]+Math.random()*this.clouds[e][3],this.clouds[e][1]+Math.random()*this.clouds[e][4],this.clouds[e][2]+Math.random()*this.clouds[e][5]),this.hitNorm.set(38*(Math.random()-.5),65*(Math.random()-.1),38*(Math.random()-.5)),t.emit("playCloudEffect",{pos:this.hitVec,vel:this.hitNorm,effectData:this.effectData})},n.prototype.tickClouds=function(){this.lastPuffIndex+=1;if(this.lastPuffIndex>=this.clouds.length){this.lastPuffIndex=-1;return}var e=Math.floor(Math.random()*this.clouds.length);if(Math.random()<.05)return;this.makeCloudPuff(e)},n.prototype.createClouds=function(e,t,n){this.intensity=n;var r=Math.floor(this.intensity*15),i=Math.floor(this.intensity*15);for(var s=0;s<r;s++)for(var o=0;o<i;o++){var u=e[0]-t[0]*.5+s*(t[0]/r)+2*t[0]/r*(Math.random()-.5),a=this.cloudBaseHeight+e[1]-t[1]*.5+Math.random()*Math.random()*t[1]*2.3,f=e[2]-t[2]*.5+o*(t[2]/i)+2*t[2]/i*(Math.random()-.5);u*=this.cloudScale,a*=this.cloudScale*.3,f*=this.cloudScale,this.clouds.push([u,a,f,t[0]/r*.8,t[1]*1.8,t[2]/i*.8])}for(s=0;s<this.clouds.length;s++)this.makeCloudPuff(s),this.lastPuffIndex=-1},n}),define("environment/Sky",["environment/Lighting","environment/DynamicEnvironment","environment/DynamicSkysphere","environment/Clouds"],function(e,t,n,r){var i=function(i){this.timeScale=1,this.lighting=new e(i),this.lighting.setupMainLight(),this.environment=new t(this.lighting),this.skySphere=new n(i),this.skySphere.makeSun(),this.clouds=new r,this.clouds.createClouds([0,1500,0],[1e4,800,1e4],8)};return i.prototype.setEnvData=function(e){e.globals&&this.environment.setGlobals(e.globals),this.environment.setCycleData(e.cycles)},i.prototype.attachWaterSystem=function(e,t){this.environment.addWater(e,this.skySphere.skyEntity,t)},i.prototype.updateEnvironmentTime=function(e,t){var n=t.transformComponent.worldTransform;this.environment.advanceTime(e*this.timeScale);var r=this.environment.getEnvironmentState();this.skySphere.setColor(r.fogColor,r.ambientLight,r.skyColor,n.translation.data[1]),this.skySphere.setSunColor(r.sunLight),this.updateSun(t,r)},i.prototype.updateSun=function(e,t){var n=e.transformComponent.worldTransform;this.skySphere.setSunXYZ(n.translation.data[0]-t.sunDir[2]*1e4,n.translation.data[1]-t.sunDir[1]*1e4,n.translation.data[2]-t.sunDir[0]*1e4)},i.prototype.repositionSkySphere=function(e){var t=e.transformComponent.worldTransform,n=this.skySphere.skyEntity.transformComponent.worldTransform;n.translation.setv(t.translation),n.update()},i.prototype.setTimeScale=function(e){this.timeScale=e},i.prototype.setTimeOfDay=function(e){this.environment.applyTimeOfDayUpdate(e)},i.prototype.updateCameraFrame=function(e,t){this.updateEnvironmentTime(e,t),this.repositionSkySphere(t),this.clouds.tickClouds()},i}),define("environment/EnvironmentAPI",["environment/Sky"],function(e){var t=window.resourcePath+"water",n=function(){};return n.prototype.setEnvironmentTimeOfDay=function(e){this.sky.setTimeOfDay(e)},n.prototype.setEnvironmentTimeScale=function(e){this.sky.setTimeScale(e)},n.prototype.setupEnvironment=function(n){this.sky=new e(n),this.sky.attachWaterSystem(n,t)},n.prototype.applyEnvironmentData=function(e){console.log("Applying env data: ",e),this.sky.setEnvData(e)},n.prototype.updateCameraFrame=function(e,t){this.sky.updateCameraFrame(e,t)},n}),define("3d/EnvironmentController",["application/Settings","application/EventManager","3d/WorldParticleSystems","3d/HeightmapManager","game/world/ZoneData","game/GameConfiguration","load/ClientLoader","goo/renderer/Material","goo/entities/components/ScriptComponent","geometrypack/Surface","goo/shapes/Sphere","goo/entities/EntityUtils","goo/renderer/shaders/ShaderLib","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/TextureCreator","goo/addons/waterpack/FlatWaterRenderer","goo/math/Plane","game/world/ZoneBuilder","3d/GooEffectController","goo/util/Skybox","goo/renderer/shaders/ShaderBuilder","goo/renderer/Texture","data_pipeline/PipelineAPI","environment/EnvironmentAPI"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T){function F(e){var t=new u("water_material",h.simple);return t}function q(){console.log("Setup Space Box"),H.setupEnvironment(N);var t=function(e,t){H.applyEnvironmentData(t)};x.subscribeToCategoryKey("environments","ocean_env",t);var n=function(e){H.setEnvironmentTimeScale(e)},r=function(e){H.setEnvironmentTimeOfDay(e)};e.getSetting("environemnt_time_scale").addOnChangeCallback(n),e.getSetting("environemnt_time_of_day").addOnChangeCallback(r),setTimeout(function(){n(e.getSetting("environemnt_time_scale").getProcessedValue())},2e3),r(e.getSetting("environemnt_time_of_day").getProcessedValue())}function R(e){_=N.world.createEntity(),_.addToWorld(),e(_)}function G(e,t,n,r){D=t,U(e,n,r)}function Y(e){var t=function(){K(),e()};y.buildTerrainZone(N,D.loadLevels,r.getTerrainData(),t),Q(e)}function Z(){water.waterEntity.transformComponent.transform.translation.data[0]=k.data[0],water.waterEntity.transformComponent.transform.translation.data[2]=k.data[2],water.waterEntity.transformComponent.setUpdated()}var N,C,k,L,A,O,M,_,D,P,H=new T,B=function(e){C=e,k=C.transformComponent.worldTransform.translation},j=function(){},I,U=function(e,t,n){var i=D.loadZones,s=0,o=0,u=function(){s+=1,s==o&&t()};for(var a=0;a<i.length;a++)i[a].heightData&&(o+=1,r.addHeightMap(e,i[a],i[a].id,u,n)),o||n();o+=1,setTimeout(function(){u()},10)},z=function(e){t.fireEvent(t.list().SPAWN_CLOUDS,{pos:e.pos,size:[e.width,e.height,e.depth],intensity:e.clouds.intensity})},W=function(){t.fireEvent(t.list().LOAD_PROGRESS,{started:1,completed:0,errors:0,id:"load_sky"}),I=q();var e=function(e){$(e),t.fireEvent(t.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"load_sky"})},n=function(){R(e)};n()},X=function(e){N=t.eventArgs(e).goo,W()},V=function(e){H.updateCameraFrame(t.eventArgs(e).lastFrameDuration,C)},$=function(e){n.addWorldParticles(e),t.registerListener(t.list().RENDER_TICK,V)},J={},K=function(){var e=function(e){J[e.playId]=e};t.fireEvent(t.list().START_SOUND_LOOP,{soundData:t.sound().SEATOWN_AMB,loopId:"env_amb",callback:e}),t.fireEvent(t.list().START_SOUND_LOOP,{soundData:t.sound().DARK_SUSPENS,loopId:"susp_amb",callback:e})},Q=function(e){for(var t=0;t<D.loadZones.length;t++)z(D.loadZones[t])};return t.registerListener(t.list().ENINGE_READY,X),{dataLoadCompleted:j,setCameraEntity:B,loadScenarioEnvironment:G,loadEnvironment:Y}}),define("game/scenario/ScenarioStateTracker",["load/ClientLoader","3d/EnvironmentController","application/EventManager","load/TrackProgress","game/world/LevelController","game/GameConfiguration"],function(e,t,n,r,i,s){var o=function(e){this.scenario=e,this.initOk=!1,this.gamePieceOk=!1,this.addPlayerOk=!1};return o.prototype.initLoading=function(e){this.initLoadingCallback=e},o.prototype.initOk=function(){this.initOk=!0,this.initLoadingCallback()},o.prototype.setupGamePieces=function(e){this.setupGamePiecesCallback=e},o.prototype.gamePiecesOk=function(){this.gamePieceOk=!0,this.setupGamePiecesCallback()},o.prototype.addPlayer=function(e){this.addPlayerCallback=e},o.prototype.addPlayerOk=function(){this.addPlayerOk=!0,this.addPlayerCallback()},o}),define("game/world/levels/ZoneLevels",["game/GameConfiguration","game/world/ZoneData"],function(e,t){var n={start:{zoneId:t.ZONE_ID_LIST.start,gooProjects:[],buildings:[]},cove:{zoneId:t.ZONE_ID_LIST.cove,gooProjects:[e.GOO_PROJECTS.harbor,e.GOO_PROJECTS.top_base,e.GOO_PROJECTS.elevator,e.GOO_PROJECTS.hilltop_base,e.GOO_PROJECTS.air_base,e.GOO_PROJECTS.houses],buildings:[{model:e.GOO_PROJECTS.air_base.base,entries:[{pos:[2791,218.2,2515],rot:[0,3.14,0]}]},{model:e.GOO_PROJECTS.air_base.roof,entries:[{pos:[2791,218.2,2515],rot:[0,3.14,0]}]},{model:e.GOO_PROJECTS.air_base.lamps,entries:[{pos:[2791,218.2,2515],rot:[0,3.14,0]}]},{model:e.GOO_PROJECTS.air_base.lockers,entries:[{pos:[2791,218.2,2515],rot:[0,3.14,0]}]}]}};return{ZONES:n}}),define("game/scenario/ScenarioDefinitions",["game/world/ZoneData","game/world/levels/ZoneLevels","game/GameConfiguration"],function(e,t,n){return{SCENARIOS:{carrier_patrol:{IDENTITY:{title:"Carrier at sea",tagLine:"Play around with the Carrier."},playerVehicle:"TOMCAT",playerCharacter:"PILOT",playerCarrier:"CARRIER",loadZones:[e.FREEFLIGHT_ZONES.ocean],loadLevels:[],loadPlayer:e.FREEFLIGHT_ZONES.carrier_takeoff,loadVehicles:[[e.SPAWN_POINTS.carrier_takeoff],[],[]]},tomcat_freeflight:{IDENTITY:{title:"F-14 Tomcat",tagLine:"Free flight over ocean"},playerVehicle:"TOMCAT",playerCharacter:"PILOT",loadLevels:[],loadZones:[e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.FREEFLIGHT_ZONES.ocean,loadVehicles:[[]]},tunnan_freeflight:{IDENTITY:{title:"J-29 Tunnan",tagLine:"Free flight over ocean"},playerVehicle:"TUNNAN",playerCharacter:"PILOT",loadZones:[e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.FREEFLIGHT_ZONES.ocean,loadVehicles:[[]],loadLevels:[]},island_carrier:{IDENTITY:{title:"Mysterious Island",tagLine:"An island with things to land on and shoot at"},playerVehicle:"TOMCAT",playerCharacter:"PILOT",playerCarrier:"CARRIER",loadZones:[e.TERRAIN_ZONES.start],loadLevels:[t.ZONES.start],loadPlayer:e.FREEFLIGHT_ZONES.carrier_takeoff,loadVehicles:[[e.SPAWN_POINTS.carrier_takeoff],[],[]]},draken_freeflight:{IDENTITY:{title:"J-35 Draken",tagLine:"Free flight over ocean"},playerVehicle:"DRAKEN",loadZones:[e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.FREEFLIGHT_ZONES.ocean,loadVehicles:[[]],loadProjects:{human:n.GOO_PROJECTS.human,vehicles:n.GOO_PROJECTS.draken,bullet_20:n.GOO_PROJECTS.bullet_20,environment:n.GOO_PROJECTS.environment}},cougar_freeflight:{IDENTITY:{title:"Cougar F9F",tagLine:"Free flight over ocean"},playerVehicle:"COUGAR",loadZones:[e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.FREEFLIGHT_ZONES.ocean,loadVehicles:[[]],loadProjects:{human:n.GOO_PROJECTS.human,vehicles:n.GOO_PROJECTS.cougar_f9f,bullet_20:n.GOO_PROJECTS.bullet_20}},b52_freeflight:{IDENTITY:{title:"B-52",tagLine:"Free flight over ocean"},playerVehicle:"B52",loadZones:[e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.FREEFLIGHT_ZONES.ocean,loadVehicles:[[]],loadProjects:{human:n.GOO_PROJECTS.human,stratofortress:n.GOO_PROJECTS.stratofortress}},tunnan_takeoff:{IDENTITY:{title:"Mysterious Island",tagLine:"An island with things to land on and shoot at"},playerCharacter:"PILOT",loadZones:[e.TERRAIN_ZONES.start],loadLevels:[t.ZONES.start],loadPlayer:e.TERRAIN_ZONES.start,loadVehicles:[[e.SPAWN_POINTS.air_base,e.SPAWN_POINTS.tomcat,e.SPAWN_POINTS.tunnan,e.SPAWN_POINTS.practice_range,e.SPAWN_POINTS.carrier],[],[]],loadProjects:{}},draken_takeoff:{IDENTITY:{title:"J-35 Draken",tagLine:"Island runway takeoff"},playerCharacter:"PILOT",loadZones:[e.TERRAIN_ZONES.start],loadLevels:[t.ZONES.start],loadPlayer:e.TERRAIN_ZONES.start,loadVehicles:[[e.SPAWN_POINTS.draken]],loadProjects:{human:n.GOO_PROJECTS.human,environment:n.GOO_PROJECTS.environment,houses:n.GOO_PROJECTS.houses,house_t:n.GOO_PROJECTS.house_t,draken:n.GOO_PROJECTS.draken,nature:n.GOO_PROJECTS.nature,air_base:n.GOO_PROJECTS.air_base,bullet_20:n.GOO_PROJECTS.bullet_20}},cougar_takeoff:{IDENTITY:{title:"Cougar F9F",tagLine:"Island runway takeoff"},playerCharacter:"PILOT",loadZones:[e.TERRAIN_ZONES.start],loadLevels:[t.ZONES.start],loadPlayer:e.TERRAIN_ZONES.start,loadVehicles:[[e.SPAWN_POINTS.cougar]],loadProjects:{human:n.GOO_PROJECTS.human,environment:n.GOO_PROJECTS.environment,houses:n.GOO_PROJECTS.houses,house_t:n.GOO_PROJECTS.house_t,cougar_f9f:n.GOO_PROJECTS.cougar_f9f,nature:n.GOO_PROJECTS.nature,air_base:n.GOO_PROJECTS.air_base,bullet_20:n.GOO_PROJECTS.bullet_20}},human_pilot:{IDENTITY:{title:"Purity of Essence",tagLine:"Intercept the Rogue B-52"},playerCharacter:"PILOT",loadZones:[e.TERRAIN_ZONES.start,e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.TERRAIN_ZONES.start,loadLevels:[t.ZONES.start],loadVehicles:[[e.SPAWN_POINTS.start,e.SPAWN_POINTS.air_patrol],[],[],[]],loadProjects:{human:n.GOO_PROJECTS.human,environment:n.GOO_PROJECTS.environment,houses:n.GOO_PROJECTS.houses,house_t:n.GOO_PROJECTS.house_t,draken:n.GOO_PROJECTS.draken,cougar_f9f:n.GOO_PROJECTS.cougar_f9f,car_pv_9031:n.GOO_PROJECTS.car_pv_9031,nature:n.GOO_PROJECTS.nature,stratofortress:n.GOO_PROJECTS.stratofortress,air_base:n.GOO_PROJECTS.air_base,bullet_20:n.GOO_PROJECTS.bullet_20}},battleship_battle:{IDENTITY:{title:"Fleet Battle",tagLine:"A fleet of ships are battling it out at the island."},playerCharacter:"PILOT",loadZones:[e.TERRAIN_ZONES.start,e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.TERRAIN_ZONES.start,loadLevels:[t.ZONES.start],loadVehicles:[[e.SPAWN_POINTS.air_base,e.SPAWN_POINTS.tunnan,e.SPAWN_POINTS.practice_range,e.SPAWN_POINTS.battleship_assault,e.SPAWN_POINTS.carrier],[]],loadProjects:{human:n.GOO_PROJECTS.human,houses:n.GOO_PROJECTS.houses,tre_kronor:n.GOO_PROJECTS.tre_kronor,battleship:n.GOO_PROJECTS.battleship,carrier:n.GOO_PROJECTS.carrier,tunnan:n.GOO_PROJECTS.tunnan,nature:n.GOO_PROJECTS.nature,air_base:n.GOO_PROJECTS.air_base,top_base:n.GOO_PROJECTS.top_base,harbor:n.GOO_PROJECTS.harbor,hilltop_base:n.GOO_PROJECTS.hilltop_base,elevator:n.GOO_PROJECTS.elevator,targets:n.GOO_PROJECTS.targets,bullet_20:n.GOO_PROJECTS.bullet_20,environment:n.GOO_PROJECTS.environment}},b52_chase:{IDENTITY:{title:"B-52 Chase",tagLine:"Chase the B-52"},playerVehicle:"DRAKEN",loadZones:[e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.FREEFLIGHT_ZONES.ocean,loadVehicles:[[e.SPAWN_POINTS.air_patrol]],loadProjects:{human:n.GOO_PROJECTS.human,draken:n.GOO_PROJECTS.draken,stratofortress:n.GOO_PROJECTS.stratofortress,bullet_20:n.GOO_PROJECTS.bullet_20}},three_world_islands:{IDENTITY:{title:"Tri Isles",tagLine:"Explore the three islands "},playerVehicle:"TUNNAN",loadZones:[e.TERRAIN_ZONES.start,e.TERRAIN_ZONES.peak,e.TERRAIN_ZONES.cove,e.FREEFLIGHT_ZONES.ocean],loadPlayer:e.TERRAIN_ZONES.start,loadVehicles:[[e.SPAWN_POINTS.start,e.SPAWN_POINTS.battleship_assault],[],[],[]],loadProjects:{human:n.GOO_PROJECTS.human,tre_kronor:n.GOO_PROJECTS.tre_kronor,battleship:n.GOO_PROJECTS.battleship,tunnan:n.GOO_PROJECTS.tunnan,cougar_f9f:n.GOO_PROJECTS.cougar_f9f,draken:n.GOO_PROJECTS.draken,car_pv_9031:n.GOO_PROJECTS.car_pv_9031,nature:n.GOO_PROJECTS.nature,bullet_20:n.GOO_PROJECTS.bullet_20}}}}}),define("game/scenario/ScenarioSelector",["load/ClientLoader","3d/EnvironmentController","application/EventManager","load/TrackProgress","game/world/LevelController","game/GameConfiguration","game/scenario/ScenarioStateTracker","game/scenario/ScenarioDefinitions"],function(e,t,n,r,i,s,o,u){function c(){n.removeListener(n.list().LOADING_ENDED)}var a,f=function(e,t){this.goo=e,this.clientLoader=t;var r=function(e){this.handleScenarioSelected(e)}.bind(this);n.registerListener(n.list().SCENARIO_SELECTED,r)};f.prototype.resetScenario=function(e){var t=this.goo,r=function(){t.renderer.preloadBuffers(t.renderSystem._activeEntities),t.renderer.preloadMaterials(t.renderSystem._activeEntities),t.renderer.precompileShaders(t.renderSystem._activeEntities,t.renderSystem.lights),i.addPlayerToLevel(e),setTimeout(function(){t.startGameLoop()},100)};n.fireEvent(n.list().SCENARIO_LOADED,{callback:r})},f.prototype.loadScenario=function(e){function f(){if(s)return;console.log("Track Progress says ",r.getLoadedCount());if(r.getLoadedCount().started-r.getLoadedCount().finished<=1){s=!0,clearInterval(l),console.log("Track Progress says almostThere!");var e=function(){n.fireEvent(n.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"game_loop"})};u.resetScenario(e)}}function h(){n.fireEvent(n.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"load_env"}),n.fireEvent(n.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"load_scenario_data"})}function p(){console.log("Terrains image loaded callback"),n.fireEvent(n.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"data_loaded"}),t.loadEnvironment(h),n.fireEvent(n.list().LOAD_PROGRESS,{started:0,completed:1,errors:0,id:"game_loop"})}this.goo.stopGameLoop(),a=e,console.log("Init scenario Load: ",a);var s=!1;n.fireEvent(n.list().LOAD_PROGRESS,{started:1,completed:0,errors:0,id:"data_loaded"}),n.fireEvent(n.list().LOAD_PROGRESS,{started:1,completed:0,errors:0,id:"load_env"});var o=this.goo,u=this,l=setInterval(function(){f()},50);i.registerScenario(a),n.registerListener(n.list().LOADING_ENDED,c);var d=function(){console.log("Terrains added callback"),n.removeListener(n.list().SCENARIO_SELECTED),n.fireEvent(n.list().ANALYTICS_EVENT,{category:"SCENARIO SELECT",action:a.IDENTITY.title,labels:a.IDENTITY.tagLine,value:1})};t.loadScenarioEnvironment(this.goo,a,d,p)},f.prototype.handleScenarioSelected=function(e){this.loadScenario(n.eventArgs(e).scenario)},f.prototype.openScenarioScreen=function(){this.clientLoader.clientLoaded()};var l=function(e){n.fireEvent(n.list().SCENARIO_SELECTED,{scenario:u.SCENARIOS[n.eventArgs(e).scenarioId]})};return n.registerListener(n.list().START_SCENARIO_ID,l),f}),define("application/Client",["load/ClientLoader","io/InputSettersGetters","application/EventManager","application/PerfMon","game/GameController","game/GameConfiguration","application/UpdateLoop","application/DeviceHandler","game/scenario/ScenarioSelector"],function(e,t,n,r,i,s,o,u,a){var f="configs/bundles/bundle_list.json",l="configs/config_urls.json",c="../../../../../../",h=function(){};return h.prototype.initiateClient=function(n){this.now=(new Date).getTime(),this.gooController=n,this.gooController.setupGooRunner(),this.clientLoader=new e.ClientLoader,this.scenarioSelector=new a(this.gooController.goo,this.clientLoader),this.gameController=new i,t.setGuiApi(this.gameController.canvasGuiAPI),this.updateLoop=new o,this.perfMon=new r(this.gooController,this.gameController),this.preload()},h.prototype.propagateGoo=function(e){this.gooController.propagateGoo()},h.prototype.preload=function(){var e=function(){this.preloadCompleted(),this.propagateGoo()}.bind(this),t=function(){this.clientSetupCompleted()}.bind(this);n.registerListener(n.list().LOADING_COMPLETED,e),n.registerListener(n.list().CLIENT_SETUP_OK,t)},h.prototype.clientSetupCompleted=function(){u.handleClientSetupDone()},h.prototype.preloadCompleted=function(){n.removeListener(n.list().LOADING_COMPLETED),this.initiateView()},h.prototype.initiateView=function(){var e=function(){console.log("loading ok"),this.loadingCompleted()}.bind(this);this.scenarioSelector.openScenarioScreen(),n.fireEvent(n.list().LOAD_3D,{});var t=function(e){this.tickClient(e)}.bind(this);this.gooController.goo.startGameLoop();var r=function(){console.log("Look for ready"),this.gooController.gooCameraController.getCamera()?(this.gameController.setupGame(),this.gooController.registerGooUpdateCallback(t),this.gameController.addCanvasGui(this.gooController.gooCameraController.getCameraEntity(),l),this.clientLoader.runGooPipeline(c,this.gooController.goo,f,e)):i()}.bind(this),i=function(){setTimeout(function(){r()},100)};i()},h.prototype.tickClient=function(e){this.now+=e,this.perfMon.updateMonitorFrame(e),this.gameController.tickGame(e*1e3),n.fireEvent(n.list().RENDER_TICK,{frameTime:this.now,lastFrameDuration:e*1e3}),this.gooController.updateWorld(),this.gameController.tickGui(e)},h.prototype.loadingCompleted=function(){this.gameController.gameLoadingCompleted(),n.removeListener(n.list().LOADING_COMPLETED),n.fireEvent(n.list().CLIENT_READY,{}),n.fireEvent(n.list().CLIENT_SETUP_OK,{})},h}),define("goo/animationpack/systems/AnimationSystem",["goo/entities/systems/System","goo/entities/World"],function(e,t){function n(){e.call(this,"AnimationSystem",["AnimationComponent"])}return n.prototype=Object.create(e.prototype),n.prototype.process=function(){for(var e=0;e<this._activeEntities.length;e++){var n=this._activeEntities[e],r=n.animationComponent;r.update(t.time),r.apply(n.transformComponent),r.postUpdate()}},n.prototype.pause=function(){this.passive=!0;for(var e=0;e<this._activeEntities.length;e++)this._activeEntities[e].animationComponent.pause()},n.prototype.stop=function(){this.passive=!0;for(var e=0;e<this._activeEntities.length;e++){var t=this._activeEntities[e];t.animationComponent.stop()}},n.prototype.resume=function(){this.passive=!1;for(var e=0;e<this._activeEntities.length;e++){var t=this._activeEntities[e];t.animationComponent.resume()}},n}),define("3d/FlightCameraScript",["physics/PhysicalWorld","goo/math/Vector2","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r,i){function o(e){e=e||{};for(var r in s)typeof s[r]=="boolean"?this[r]=e[r]!==undefined?e[r]===!0:s[r]:isNaN(s[r])?s[r]instanceof n?this[r]=e[r]||(new n).copy(s[r]):this[r]=e[r]||s[r]:this[r]=isNaN(e[r])?s[r]:e[r];this.name="FlightCameraScript",this.timeSamples=[0,0,0,0,0],this.xSamples=[0,0,0,0,0],this.ySamples=[0,0,0,0,0],this.sample=0,this.velocity=new t,this.targetSpherical=new n(this.spherical),this.cartesian=new n,this.dirty=!0,this.mouseState={buttonDown:!1,lastX:NaN,lastY:NaN}}function u(e,t,n){var r=(t+n)/2+(n>t?Math.PI:0),s=i.moduloPositive(e-r,i.TWO_PI),o=i.moduloPositive(t-r,i.TWO_PI),u=i.moduloPositive(n-r,i.TWO_PI);return e<0&&t>0?t-=i.TWO_PI:e>0&&t<0&&(t+=i.TWO_PI),e>i.TWO_PI&&n<i.TWO_PI&&(n+=i.TWO_PI),s<o?t:s>u?n:e}var s={domElement:document,turnSpeedHorizontal:.01,turnSpeedVertical:.01,zoomSpeed:.4,dragOnly:!0,dragButton:1,worldUpVector:new n(0,1,0),baseDistance:25,minZoomDistance:.01,maxZoomDistance:1e4,minAscent:-89.95*i.DEG_TO_RAD,maxAscent:89.95*i.DEG_TO_RAD,clampAzimuth:!1,minAzimuth:90*i.DEG_TO_RAD,maxAzimuth:270*i.DEG_TO_RAD,releaseVelocity:!0,invertedX:!1,invertedY:!1,invertedWheel:!0,drag:5,maxSampleTimeMS:200,lookAtPoint:new n(0,0,0),spherical:new n(15,0,0),interpolationSpeed:6,onRun:null};return o.prototype.setCamera=function(e){this.camera=e},o.prototype.updateDragState=function(e){this.mouseState.buttonDown=e,e?(this.mouseState.lastX=NaN,this.mouseState.lastY=NaN,this.velocity.set(0,0),this.spherical.y=i.moduloPositive(this.spherical.y,i.TWO_PI),this.targetSpherical.copy(this.spherical)):this.applyReleaseDrift()},o.prototype.updatePointerState=function(e){this.controlScript.pointerAction(this.targetSpherical,e)},o.prototype.updateDeltas=function(e,t){var n=0,r=0;isNaN(this.mouseState.lastX)||isNaN(this.mouseState.lastY)?(this.mouseState.lastX=e,this.mouseState.lastY=t):(n=-(e-this.mouseState.lastX),r=t-this.mouseState.lastY,this.mouseState.lastX=e,this.mouseState.lastY=t);if(this.dragOnly&&!this.mouseState.buttonDown||n===0&&r===0)return;this.timeSamples[this.sample]=Date.now(),this.xSamples[this.sample]=n,this.ySamples[this.sample]=r,this.sample++,this.sample>this.timeSamples.length-1&&(this.sample=0),this.velocity.set(0,0),this.move(this.turnSpeedHorizontal*n,this.turnSpeedVertical*r)},o.prototype.move=function(e,t){var n=this.invertedX?-e:e,r=this.invertedY?-t:t;this.clampAzimuth?this.targetSpherical.y=u(this.targetSpherical.y-n,this.minAzimuth,this.maxAzimuth):this.targetSpherical.y=this.targetSpherical.y-n,this.targetSpherical.z=i.clamp(this.targetSpherical.z+r,this.minAscent,this.maxAscent),this.dirty=!0},o.prototype.applyWheel=function(e){var e=(this.invertedWheel?-1:1)*e*this.targetSpherical.x*.3;this.zoom(this.zoomSpeed*e)},o.prototype.zoom=function(e){var t=e*this.baseDistance;this.controlScript.setCamDistance(i.clamp(this.targetSpherical.x+t,this.minZoomDistance,this.maxZoomDistance)),this.controlScript.adjustFov(e),this.dirty=!0},o.prototype.applyReleaseDrift=function(){this.controlScript.releaseDrift(this.targetSpherical);return},o.prototype.updateVelocity=function(e){this.velocity.lengthSquared()>1e-6?(this.move(this.velocity.x,this.velocity.y),this.velocity.mul(i.clamp(i.lerp(e,1,1-this.drag),0,1)),this.dirty=!0):this.velocity.set(0,0,0)},o.prototype.setControlScript=function(e){this.controlScript=e,this.controlScript.setCamera(this.camera)},o.prototype.setCameraTarget=function(e,t,n,r){console.log("Set camera target spatial: ",e),this.setControlScript(r),this.controlScript.setTargetSpatial(e),this.spherical.x=this.controlScript.getCamDistance(),this.spherical.y=this.targetSpherical.y,this.spherical.z=this.targetSpherical.z},o.prototype.calcFrameCartesian=function(e){this.targetSpherical.x=this.controlScript.getCamDistance(),this.releaseVelocity&&this.updateVelocity(e._world.tpf);var t=this.interpolationSpeed*e._world.tpf;this.clampAzimuth?this.spherical.y=i.lerp(t,this.spherical.y,this.targetSpherical.y):this.spherical.y=i.lerp(t,this.spherical.y,this.targetSpherical.y),this.spherical.x=i.lerp(t,this.spherical.x,this.targetSpherical.x),this.spherical.z=i.lerp(t,this.spherical.z,this.targetSpherical.z),this.controlScript.fov!=this.controlScript.targetFov&&this.camera.setFrustumPerspective(i.lerp(.05,this.controlScript.targetFov,this.controlScript.fov),null,null,null),i.sphericalToCartesian(this.spherical.x,this.spherical.y,this.spherical.z,this.cartesian)},o.prototype.setWheelDelta=function(e){this.wheelDelta=e},o.prototype.frameUpdate=function(e){this.wheelDelta&&(this.applyWheel(this.wheelDelta),this.wheelDelta=0),this.calcFrameCartesian(e),this.controlScript.calcCamPos(this.cartesian),this.controlScript.calcCamRot(e,this.targetSpherical),this.spherical.distanceSquared(this.targetSpherical)<1e-6&&(this.dirty=!1,this.spherical.y=i.moduloPositive(this.spherical.y,i.TWO_PI),this.targetSpherical.copy(this.spherical)),e.transformComponent.setUpdated();for(var t=0;t<e.transformComponent.children.length;t++)e.transformComponent.children[t].transform.update()},o.prototype.updateCam=function(e,t){if(this.paused){console.log("camera paused");return}this.frameUpdate(e)},o.prototype.update=function(e,t){},o.prototype.setPaused=function(e){this.paused=e},o}),define("3d/cameras/TransitMode",["application/EventManager","physics/PhysicalWorld","goo/math/Vector2","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r,i,s){var o;require(["game/player/PlayerController"],function(e){o=e});var u=function(){this.vehicle=null,this.calcVec=new r,this.calcVec2=new r,this.calcVec3=new r,this.lastZoom=new r,this.calcMat=new i,this.lastRot=new i,this.targetOffset=new r(0,1.52,3),this.targetSpatial=null,this.lookAtPoint=new r,this.camPos=new r,this.camDistance=.15,this.worldUpVector=new r(0,1,0),this.camera=null,this.baseFov=45,this.targetFov=this.baseFov,this.fov=this.baseFov,this.baseZoomIndex=0,this.zoomIndex=null,this.zoomStages=[{fov:this.baseFov-6,distance:7},{fov:this.baseFov-8,distance:5},{fov:this.baseFov+7,distance:75}]};u.prototype.setTargetSpatial=function(e){this.targetSpatial=e},u.prototype.setTargetOffset=function(e){this.targetOffset=e},u.prototype.setFov=function(e){this.targetFov=e},u.prototype.updateZoomLevel=function(){this.setFov(this.zoomStages[this.zoomIndex].fov),this.camDistance=this.zoomStages[this.zoomIndex].distance},u.prototype.changeZoomLevel=function(e){this.updateZoomLevel()},u.prototype.setZoomIndex=function(e){this.zoomIndex=e,this.updateZoomLevel()},u.prototype.adjustFov=function(e){this.changeZoomLevel(e)},u.prototype.setCamDistance=function(e){},u.prototype.getCamDistance=function(){return this.camDistance},u.prototype.getRollInfluence=function(){return.8},u.prototype.getRotInfluence=function(){return.5},u.prototype.adjustPhysical=function(e){return this.calcVec.set(e),this.targetSpatial.rot.applyPost(this.calcVec),this.calcVec.add(this.targetSpatial.pos),this.calcVec3.set(this.targetSpatial.pos),this.calcVec3.add(this.lookAtPoint),e.add(this.calcVec),e},u.prototype.calcCamPos=function(e){return this.calcVec.set(this.targetOffset),this.targetSpatial.rot.applyPost(this.calcVec),this.calcVec.add(e),this.camPos.set(this.targetSpatial.pos),this.camPos.add(this.calcVec),this.camPos},u.prototype.calcCamRot=function(e){var t=e.transformComponent,n=t.transform;return this.calcVec.set(2,2,-2),this.targetSpatial.rot.applyPost(this.calcVec),this.camPos.add(this.calcVec),n.translation.set(this.camPos),this.calcMat.set(this.targetSpatial.rot),this.calcMat.invert(),this.calcVec.set(this.worldUpVector),this.calcVec3.set(this.camPos),this.calcVec3.sub(this.targetSpatial.pos),this.calcVec3.mul(-1),n.rotation.lookAt(this.calcVec3,this.calcVec),n},u.prototype.releaseDrift=function(e){};var a;return u.prototype.pointerAction=function(e,t){},u.prototype.setCamera=function(e){this.camera=e,this.setZoomIndex(this.baseZoomIndex)},u}),define("3d/cameras/PilotMode",["application/EventManager","physics/PhysicalWorld","goo/math/Vector2","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r,i,s){var o;require(["game/player/PlayerController"],function(e){o=e});var u=function(){this.vehicle=null,this.calcVec=new r,this.calcVec2=new r,this.calcVec3=new r,this.calcMat=new i,this.lastRot=new i,this.targetOffset=new r(0,.82,0),this.targetSpatial=null,this.lookAtPoint=new r,this.camPos=new r,this.camDistance=.15,this.worldUpVector=new r(0,1,0),this.camera=null,this.baseFov=45,this.fov=45,this.targetFov=this.baseFov,this.baseZoomIndex=2,this.zoomIndex=1,this.zoomStages=[{fov:this.baseFov-27,distance:.21},{fov:this.baseFov+3,distance:.24},{fov:this.baseFov+28,distance:.28}]};return u.prototype.setTargetSpatial=function(e){this.targetSpatial=e},u.prototype.setTargetOffset=function(e){this.targetOffset=e},u.prototype.setFov=function(e){this.targetFov=e},u.prototype.updateZoomLevel=function(){this.setFov(this.zoomStages[this.zoomIndex].fov),this.camDistance=this.zoomStages[this.zoomIndex].distance},u.prototype.changeZoomLevel=function(t){t<0?t=-1:t=1,this.zoomIndex+=t,this.zoomIndex<0&&(this.zoomIndex=0);if(this.zoomIndex>=this.zoomStages.length){this.zoomIndex=this.baseZoomIndex,e.fireEvent(e.list().SET_CAMERA_TARGET,{spatial:this.targetSpatial,controlScript:"externalCam"});return}this.updateZoomLevel()},u.prototype.setZoomIndex=function(e){this.zoomIndex=e,this.updateZoomLevel()},u.prototype.adjustFov=function(e){this.changeZoomLevel(e)},u.prototype.setCamDistance=function(e){},u.prototype.getCamDistance=function(){return this.camDistance},u.prototype.getRollInfluence=function(){return.8},u.prototype.getRotInfluence=function(){return.5},u.prototype.adjustPhysical=function(e){this.calcVec.set(e),this.targetSpatial.rot.applyPost(this.calcVec),this.calcVec.add(this.targetSpatial.pos),this.calcVec3.set(this.targetSpatial.pos),this.calcVec3.add(this.lookAtPoint);var n=t.physicsRayRange(this.calcVec3.data,this.calcVec.data);return n&&e.mul(n.fraction),e.mul(.5),e},u.prototype.calcCamPos=function(e){return this.lookAtPoint.set(this.targetOffset),this.camPos.set(this.targetOffset),this.calcVec.set(this.targetOffset),this.calcVec.add(this.targetSpatial.pos),e.add(0,this.camDistance*this.camDistance*.5,0),this.calcVec.add(e),this.calcVec2.set(this.targetSpatial.pos),this.calcVec2.add(this.camPos),this.camPos.add(e),this.camPos},u.prototype.calcCamRot=function(e){var t=e.transformComponent,n=t.transform;n.translation.set(this.camPos),this.calcMat.set(this.targetSpatial.rot),this.calcMat.invert(),this.calcVec.set(this.worldUpVector),this.calcMat.applyPost(this.calcVec),this.calcVec.lerp(this.worldUpVector,this.getRollInfluence()),this.calcVec.add(this.vehicle.spatial.angularVelocity),this.calcVec3.set(this.camPos),this.calcVec3.sub(this.lookAtPoint),this.calcVec3.mul(-1),n.rotation.lookAt(this.calcVec3,this.calcVec);var r=Math.sqrt(this.vehicle.spatial.velocity.lengthSquared());return n.rotation.rotateX(-this.vehicle.spatial.angularVelocity.data[0]*5*r),n.rotation.rotateY(-this.vehicle.spatial.angularVelocity.data[1]*5*r),n.rotation.rotateZ(-this.vehicle.spatial.angularVelocity.data[2]*5*r),n},u.prototype.releaseDrift=function(e){e.y=Math.PI*1.5,e.z=-0.01+.02*Math.sqrt(e.x)},u.prototype.pointerAction=function(e){e.y=Math.PI*1.5},u.prototype.setCamera=function(e){this.camera=e,this.setZoomIndex(this.baseZoomIndex),this.vehicle=o.getPlayerEntity()},u}),define("3d/cameras/ExternalCamera",["application/EventManager","physics/PhysicalWorld","goo/math/Vector2","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(e,t,n,r,i,s){var o;require(["game/player/PlayerController"],function(e){o=e});var u=function(){this.vehicle=null,this.calcVec=new r,this.calcVec2=new r,this.calcVec3=new r,this.lastZoom=new r,this.calcMat=new i,this.lastRot=new i,this.targetOffset=new r(0,-0.52,-6),this.targetSpatial=null,this.lookAtPoint=new r,this.camPos=new r,this.camDistance=.15,this.worldUpVector=new r(0,1,0),this.camera=null,this.baseFov=45,this.targetFov=this.baseFov,this.fov=this.baseFov,this.baseZoomIndex=1,this.zoomIndex=1,this.vehicleLength=10,this.zoomStages=[{fov:this.baseFov-12,distance:this.vehicleLength*.5},{fov:this.baseFov-8,distance:this.vehicleLength*1.1},{fov:this.baseFov,distance:this.vehicleLength*3},{fov:this.baseFov+7,distance:this.vehicleLength*7},{fov:this.baseFov+15,distance:this.vehicleLength*12}]};u.prototype.setTargetSpatial=function(e){this.targetSpatial=e},u.prototype.setTargetOffset=function(e){this.targetOffset.set(e)},u.prototype.setFov=function(e){this.targetFov=e},u.prototype.updateZoomLevel=function(){this.setFov(this.zoomStages[this.zoomIndex].fov),this.camDistance=this.zoomStages[this.zoomIndex].distance},u.prototype.changeZoomLevel=function(t){t<0?t=-1:t=1,this.zoomIndex+=t;if(this.zoomIndex<=0){this.zoomIndex=0,e.fireEvent(e.list().SET_CAMERA_TARGET,{spatial:this.targetSpatial,geometry:this.vehicle.pilot.geometries[0],controlScript:"pilotCam"});return}this.zoomIndex>=this.zoomStages.length&&(this.zoomIndex=this.zoomStages.length-1),this.updateZoomLevel()},u.prototype.setZoomIndex=function(e){this.zoomIndex=e,this.updateZoomLevel()},u.prototype.adjustFov=function(e){this.changeZoomLevel(e)},u.prototype.setCamDistance=function(e){},u.prototype.getCamDistance=function(){return this.camDistance},u.prototype.getRollInfluence=function(){return.8},u.prototype.getRotInfluence=function(){return.5},u.prototype.adjustPhysical=function(e){return this.calcVec.set(e),this.targetSpatial.rot.applyPost(this.calcVec),this.calcVec.add(this.targetSpatial.pos),this.calcVec3.add(this.lookAtPoint),e.mul(.5),e},u.prototype.calcCamPos=function(e){this.calcVec.set(this.targetOffset),this.camPos.set(this.targetSpatial.pos),this.targetSpatial.rot.applyPost(this.calcVec),e.add(0,this.camDistance*this.camDistance*.5,0),this.calcVec.add(e),this.calcVec3.set(this.targetSpatial.pos),this.calcVec3.add(this.calcVec);var n=t.physicsRayRange(this.targetSpatial.pos,this.calcVec3.data);return n&&this.calcVec.mul(n.fraction),this.camPos.add(this.calcVec),this.camPos},u.prototype.calcCamRot=function(e){var t=e.transformComponent,n=t.transform;return n.translation.set(this.camPos),this.calcMat.set(this.targetSpatial.rot),this.calcMat.invert(),this.calcVec.set(this.worldUpVector),this.calcMat.applyPost(this.calcVec),this.calcVec.lerp(this.worldUpVector,this.getRollInfluence()),this.calcVec.add(this.vehicle.spatial.angularVelocity),this.calcVec3.set(this.camPos),this.calcVec3.sub(this.targetSpatial.pos),this.calcVec2.set(0,0,this.camDistance*.002),this.lastZoom.lerp(this.calcVec2,.15),this.calcVec3.mul(-1),n.rotation.lookAt(this.calcVec3,this.calcVec),n.rotation.rotateX(-this.vehicle.spatial.angularVelocity.data[0]*3+this.lastZoom.data[2]),n.rotation.rotateY(-this.vehicle.spatial.angularVelocity.data[1]*5+this.lastZoom.data[0]),n.rotation.rotateZ(-this.vehicle.spatial.angularVelocity.data[2]*12+this.lastZoom.data[1]),n},u.prototype.releaseDrift=function(e){};var a;return u.prototype.pointerAction=function(e,t){return},u.prototype.setCamera=function(e){this.camera=e,this.setZoomIndex(this.baseZoomIndex),this.vehicle=o.getPlayerEntity(),this.vehicleLength=this.vehicle.pieceData.dimensions.length},u}),define("3d/GooCameraController",["application/EventManager","3d/EnvironmentController","goo/renderer/Camera","goo/entities/components/CameraComponent","goo/entities/EntityUtils","goo/math/Vector3","goo/math/Matrix3x3","goo/entities/components/ScriptComponent","3d/FlightCameraScript","3d/cameras/TransitMode","3d/cameras/PilotMode","3d/cameras/WalkMode","3d/cameras/ExternalCamera"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=function(){};p.prototype.updateCamera=function(){D()},p.prototype.getCamera=function(){return b},p.prototype.getCameraEntity=function(){return g};var d=new s(0,.82,0),v={pilotCam:l,transitCam:f,walkCam:c,externalCam:h},m,g,y,b,w=function(i){y=e.eventArgs(i).goo,console.log("Setup Goo Camera"),b=new n(45,1,.25,45e3),g=y.world.createEntity("ViewCameraEntity");var u=new r(b);g.setComponent(u),m=new a({domElement:y.renderer.domElement,spherical:new s([.55,0,0]),lookAtPoint:new s(0,50,1300),worldUpVector:new s([0,1,0]),zoomSpeed:.312407560349,maxZoomDistance:1256,minZoomDistance:.05}),m.setCamera(b),m.setCameraTarget({pos:new s(0,100,0),rot:(new o).fromAngles(1.5,0,0)},d,null,new v.transitCam),g.addToWorld(),t.setCameraEntity(g)},E,S=function(e){E=e,e.transformComponent.attachChild(g.transformComponent)},x=function(t){var n=e.eventArgs(t).spatial;y.world.world_root.spatial=n;var r=e.eventArgs(t).geometry;r?S(r):E&&E.transformComponent&&E.transformComponent.detachChild(g.transformComponent),m.updateDragState(1),m.updatePointerState(1);var i=function(){m.updateDragState(0),m.updatePointerState(0)};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:i,wait:50}),m.setCameraTarget(n,d,y.world.world_root.spatial,new(v[e.eventArgs(t).controlScript]));var s=function(){m.setPaused(!1)};e.fireEvent(e.list().SEQUENCE_CALLBACK,{callback:s,wait:50})},T=function(){m.setPaused(!0)},N=function(t){var n=e.eventArgs(t).xy;m.updateDeltas(n[0],n[1])},C,k=function(){m.updateDragState(1),C=!0},L=function(){m.updateDragState(0),C=!1},A=function(t){var n=e.eventArgs(t).delta;m.setWheelDelta(n),C||m.applyReleaseDrift()},O=function(){m.updatePointerState(0)},M=function(){m.updatePointerState(1)},_=function(t){console.log("Set camera analogs: ",e.eventArgs(t)),m.move(e.eventArgs(t).rotX*-0.05,e.eventArgs(t).rotY*-0.05)},D=function(){m.updateCam(g)};return e.registerListener(e.list().START_POINTER_DRAG,M),e.registerListener(e.list().START_CAMERA_DRAG,k),e.registerListener(e.list().STOP_CAMERA_DRAG,L),e.registerListener(e.list().MOUSE_POSITION_UPDATE,N),e.registerListener(e.list().MOUSE_WHEEL_UPDATE,A),e.registerListener(e.list().ENINGE_READY,w),e.registerListener(e.list().SET_CAMERA_TARGET,x),e.registerListener(e.list().SET_CAMERA_ANALOGS,_),e.registerListener(e.list().EXIT_SCENARIO,T),p}),"use strict",define("3d/GooEntityFactory",["goo/shapes/Sphere","goo/shapes/Box","application/EventManager","goo/renderer/Material","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/renderer/shaders/ShaderLib","game/movement/MobileUnits"],function(e,t,n,r,i,s,o,u){var a={},f={},l={},c={},h={},p={},d={},v={},m={},g={},y,b,w,E,S=function(){f={},l={},c={},h={}},x=function(e){b=e,y=b.world;var t={world:y};u.setWorld(b.world)},T=function(e,t){e.meshRendererComponent.materials.push(t)},N=function(e,t){e.meshRendererComponent.materials.push(material)},C=function(e,t){n.fireEvent(n.list().ANALYTICS_EVENT,{category:"3D INIT ERROR",action:t,labels:e,value:1}),alert("Some sort of loading error!: "+t)},k=function(e,t){var n=new i(t);e.setComponent(n);var r=new s;return e.setComponent(r),e},L=function(e){var t=JSON.parse(n.eventArgs(e).mesh);console.log(t),l[n.eventArgs(e).url]=w._parseMeshData(t,0);return;var r,i},A=function(e){var t=JSON.parse(n.eventArgs(e).skeleton),r=t.joints,i=n.eventArgs(e).url,s=[];console.log(r);for(var o=0;o<r.length;o++){var u=new Joint(r[o].name),a={data:r[o].inverseBindPose.matrix};u._inverseBindPose.matrix.copy(a),u._index=r[o].index,u._parentIndex=r[o].parentIndex,s.push(u)}var f=new Skeleton(i,s);c[i]=f,console.log(c)},O=function(e){var t=JSON.parse(n.eventArgs(e).animation);h[n.eventArgs(e).url]=t,console.log(h)},M=function(e){var t=n.eventArgs(e).texture,r=new Texture(t);v[n.eventArgs(e).url]=r},_=function(e){var t=JSON.parse(n.eventArgs(e).material);d[n.eventArgs(e).url]={data:t}},D=function(e,t,n){m[e]||(m[e]={});var r=n;t=="shader"&&(r=JSON.parse(n)),m[e][t]=r},P=function(e){m[e].shader||C("shader data incomplete ",e),m[e].vert||C("shader vert incomplete ",e),m[e].frag||C("shader frag incomplete ",e);var t=m[e].shader,n={attributes:t.attributes,uniforms:t.uniforms,vshader:m[e].vert,fshader:m[e].frag};t.defines&&(n.defines=t.defines);if(t.processors){n.processors=[];for(var r=0;r<t.processors.length;r++)n.processors.push(ShaderBuilder[t.processors[r]].processor)}return g[e]=n,g[e].program=new Shader(e,n),g[e].program=new Shader("uber",o.uber),n},H=function(e,t,n){var i=e.data,s={};if(i.uniforms)for(var o in i.uniforms)s[o]=i.uniforms[o];var u=g[n];u||(u=P(n));var a=new r(i.name);a.shader=g[n].program,a.uniforms=i.uniforms,a.blendState.blending="CustomBlending",a.materialState={ambient:i.uniforms.materialAmbient,diffuse:i.uniforms.materialDiffuse,emissive:i.uniforms.materialEmissive,specular:i.uniforms.materialSpecular,shininess:i.uniforms.materialSpecularPower,transparency:i.uniforms.opacity},a.renderQueue=2200;for(var f in t)f=="TRANSPARENCY_MAP"&&(a.renderQueue=2100,a.depthState.write=!1,a.depthState.read=!0),v[t[f]]||C("textureId not loaded: ",t[f]),a.setTexture(f,v[t[f]]);return e.material=a,a},B=function(e,t,n,r,i){l[t]||C("Mesh not loaded: ",t),d[n]||C("Material not loaded: ",n),m[i]||C("shaderId not loaded: ",i);var s=k(e,l[t]),o=d[n].material;return o||(o=H(d[n],r,i)),T(s,o),s},j=function(e,t){if(f[e])var n=EntityUtils.clone(b.world,f[e]);else{var n=y.createEntity(e);f[e]=n}n.addToWorld(),n.models={};for(var r in t){var i=t[r].mesh;if(f[i])var s=EntityUtils.clone(b.world,f[i]);else{var o=t[r],s=y.createEntity("mesh_"+r);f[i]=s,B(s,o.mesh,o.material,o.textures,o.shaderId)}if(t[r].skeleton){var u=c[t[r].skeleton],a=new SkeletonPose(u),l=new AnimationComponent(a);console.log(u),console.log("Attach Skeleton to EntityHierarchy",e,a),console.log("Animation Component:",l,s)}n.transformComponent.attachChild(s.transformComponent),s.addToWorld(),n.models[i]=s}return n},F=function(i){var s=n.eventArgs(i).parentGooEntity,u=n.eventArgs(i).pos.clone(),a=n.eventArgs(i).rot.toAngles(),f=n.eventArgs(i).size.clone(),l=n.eventArgs(i).shape,c=n.eventArgs(i).color,h=y.createEntity("primitive");switch(l){case"Box":var p=new t(f.data[0],f.data[1],f.data[2]);break;case"Sphere":var p=new e(8,8,f.data[0]);break;case"Cylinder":var p=new t(f.data[0],f.data[1],f.data[2])}var d=new r(o.simpleColored,"PrimitiveMaterial");c!=undefined&&(d.uniforms.color=c),k(h,p),T(h,d),s.transformComponent.attachChild(h.transformComponent),h.meshRendererComponent.isReflectable=!1,h.addToWorld(),h.transformComponent.transform.translation.seta(u.data),h.transformComponent.transform.setRotationXYZ(a.data[0],a.data[1],a.data[2]),n.eventArgs(i).callback(h)},I=function(e){var t=y.createEntity(e);return b.world.world_root.transformComponent.attachChild(t.transformComponent),t},q=function(e){var t=e._skeletonPose._localTransforms;t[3].setRotationXYZ(0,0,0),t[3].update(),e._skeletonPose.updateTransforms()},R=function(e){D(n.eventArgs(e).shaderId,n.eventArgs(e).type,n.eventArgs(e).data)},U=function(e){var t=n.eventArgs(e).gooEntity,r=n.eventArgs(e).gameEntity;t.gameSpatial=r.spatial,r.spatial||alert("ActiveEntity Needs gameSpatial to work  o.O"),t.addToWorld()};return n.registerListener(n.list().ACTIVATE_GOO_ENTITY,U),n.registerListener(n.list().BUILD_GOO_PRIMITIVE,F),n.registerListener(n.list().UN_LOAD_3D,S),{setGoo:x}}),define("goo/entities/systems/TransformSystem",["goo/entities/systems/System"],function(e){function n(){e.call(this,"TransformSystem",["TransformComponent"]),this.numUpdates=0}function r(e){if(e.transformComponent._dirty){e.transformComponent.updateWorldTransform(),t++;var n=e.transformComponent.children;for(var r=0;r<n.length;r++)n[r]._dirty=!0}}var t;return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.process=function(e){t=0;var n,i;for(n=0;n<e.length;n++)i=e[n].transformComponent,i._updated=!1,i._dirty&&i.updateTransform();for(n=0;n<e.length;n++){var s=e[n];i=s.transformComponent,i.parent===null&&s.traverse(r)}this.numUpdates=t},n}),define("goo/renderer/SimplePartitioner",["goo/renderer/Camera"],function(e){function t(){}return t.prototype.added=function(){},t.prototype.removed=function(){},t.prototype.process=function(t,n,r){var i=0;for(var s=0;s<n.length;s++){var o=n[s];if(o.skip||o.meshRendererComponent.hidden)continue;if(o.meshRendererComponent.cullMode==="Never")r[i++]=o,o.isVisible=!0;else{var u=o.meshRendererComponent.worldBound,a=t.contains(u);a!==e.Outside?(r[i++]=o,o.isVisible=!0):o.isVisible=!1}}r.length=i},t}),define("goo/entities/systems/RenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/util/ObjectUtil"],function(e,t,n,r,i,s){function o(){e.call(this,"RenderSystem",["MeshRendererComponent","MeshDataComponent"]),this.entities=[],this.renderList=[],this.postRenderables=[],this.partitioner=new n,this.preRenderers=[],this.composers=[],this._composersActive=!0,this.doRender=!0,this._debugMaterials={},this.overrideMaterials=[],this.partitioningCamera=null,this.camera=null,this.lights=[],this.currentTpf=0,t.addListener("goo.setCurrentCamera",function(e){this.camera=e.camera}.bind(this)),t.addListener("goo.setLights",function(e){this.lights=e}.bind(this)),this.picking={doPick:!1,x:0,y:0,pickingStore:{},pickingCallback:function(e,t){console.log(e,t)},skipUpdateBuffer:!1}}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.pick=function(e,t,n,r){this.picking.x=e,this.picking.y=t,this.picking.skipUpdateBuffer=r===undefined?!1:r,n&&(this.picking.pickingCallback=n),this.picking.doPick=!0},o.prototype.inserted=function(e){this.partitioner&&this.partitioner.added(e)},o.prototype.deleted=function(e){this.partitioner&&this.partitioner.removed(e)},o.prototype.process=function(e,t){this.entities=e,this.currentTpf=t},o.prototype.render=function(e){if(!this.doRender)return;if(this.camera){e.updateShadows(this.partitioner,this.entities,this.lights);for(var t=0;t<this.preRenderers.length;t++){var n=this.preRenderers[t];n.process(e,this.entities,this.partitioner,this.camera,this.lights)}this.partitioningCamera?this.partitioner.process(this.partitioningCamera,this.entities,this.renderList):this.partitioner.process(this.camera,this.entities,this.renderList);if(this.composers.length>0&&this._composersActive)for(var t=0;t<this.composers.length;t++){var r=this.composers[t];r.render(e,this.currentTpf,this.camera,this.lights,null,!0,this.overrideMaterials)}else e.render(this.renderList,this.camera,this.lights,null,!0,this.overrideMaterials)}},o.prototype.renderToPick=function(e,t){e.renderToPick(this.renderList,this.camera,!0,t)},o.prototype.enableComposers=function(e){this._composersActive=!!e},o.prototype._createDebugMaterial=function(e){if(e==="")return;var t;switch(e){case"wireframe":case"color":t=s.deepClone(i.simpleColored.fshader);break;case"lit":t=s.deepClone(i.simpleLit.fshader);break;case"texture":t=s.deepClone(i.textured.fshader);break;case"normals":t=s.deepClone(i.showNormals.fshader);break;case"simple":t=s.deepClone(i.simple.fshader)}var n=s.deepClone(i.uber);n.fshader=t,e!=="flat"?(this._debugMaterials[e]=new r(n,e),e==="wireframe"&&(this._debugMaterials[e].wireframe=!0),e==="lit"&&(this._debugMaterials[e]._textureMaps={EMISSIVE_MAP:null,DIFFUSE_MAP:null,SPECULAR_MAP:null,NORMAL_MAP:null,AO_MAP:null,LIGHT_MAP:null,TRANSPARENCY_MAP:null})):(this._debugMaterials[e]=r.createEmptyMaterial(null,e),this._debugMaterials[e].flat=!0)},o.prototype.setDebugMaterial=function(e){if(!e||e===""){this.overrideMaterials=[];return}var t=e.split("+");this.overrideMaterials=[];for(var n=0;n<t.length;n++){var e=t[n];this._debugMaterials[e]||this._createDebugMaterial(e),e===""?this.overrideMaterials.push(null):this.overrideMaterials.push(this._debugMaterials[e])}},o.prototype.invalidateHandles=function(e){for(var t=0;t<this.entities.length;t++){var n=this.entities[t],r=n.meshRendererComponent.materials;for(var i=0;i<r.length;i++)e.invalidateMaterial(r[i]);e.invalidateMeshData(n.meshDataComponent.meshData)}for(var t=0;t<this.composers.length;t++){var s=this.composers[t];e.invalidateComposer(s)}e.rendererRecord=null},o}),define("goo/entities/systems/BoundingUpdateSystem",["goo/entities/systems/System","goo/renderer/bounds/BoundingBox"],function(e,t){function n(){e.call(this,"BoundingUpdateSystem",["TransformComponent","MeshRendererComponent","MeshDataComponent"]),this._worldBound=new t,this._computeWorldBound=null}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.process=function(e){for(var t=0;t<e.length;t++){var n=e[t],r=n.meshDataComponent,i=n.transformComponent,s=n.meshRendererComponent;r.autoCompute?(r.computeBoundFromPoints(),s.updateBounds(r.modelBound,i.worldTransform)):i._updated&&s.updateBounds(r.modelBound,i.worldTransform)}if(this._computeWorldBound&&this._computeWorldBound instanceof Function){if(e.length===0){this._computeWorldBound=null;return}for(var t=0;t<e.length;t++)if(!e[t].particleComponent){this._worldBound=e[t].meshRendererComponent.worldBound.clone();break}for(;t<e.length;t++)if(!e[t].particleComponent){var o=e[t].meshRendererComponent;this._worldBound=this._worldBound.merge(o.worldBound)}this._computeWorldBound(this._worldBound),this._computeWorldBound=null}},n.prototype.getWorldBound=function(e){this._computeWorldBound=e},n.prototype.deleted=function(e){e.meshRendererComponent&&(e.meshRendererComponent.worldBound=new t)},n}),define("goo/entities/systems/ScriptSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/scripts/Scripts"],function(e,t,n){function r(n){e.call(this,"ScriptSystem",["ScriptComponent"]),this._world=n;var r=this._world.gooRunner.renderer;this.context={domElement:r.domElement,viewportWidth:r.viewportWidth,viewportHeight:r.viewportHeight,world:n,activeCameraEntity:null,worldData:{}},t.addListener("goo.setCurrentCamera",function(e){this.context.activeCameraEntity=e.entity}.bind(this)),t.addListener("goo.viewportResize",function(e){this.context.viewportWidth=e.width,this.context.viewportHeight=e.height}.bind(this)),this.manualSetup=!1,this.priority=500}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.process=function(e,t){for(var n=0;n<e.length;n++){var r=e[n].scriptComponent;r.run(e[n],t)}},r.prototype.addedComponent=function(e,t){t.type==="ScriptComponent"&&!this.manualSetup&&t.setup(e)},r.prototype.removedComponent=function(e,t){t.type==="ScriptComponent"&&!this.manualSetup&&t.cleanup()},r.prototype.clear=function(){for(var t=0;t<this._activeEntities.length;t++){var n=this._activeEntities[t];n.scriptComponent.cleanup()}this._world=null,this.context=null,e.prototype.clear.call(this)},n.addClass("ScriptSystem",r),r}),define("goo/entities/systems/LightingSystem",["goo/renderer/Capabilities","goo/entities/systems/System","goo/entities/SystemBus"],function(e,t,n){function r(){t.call(this,"LightingSystem",["LightComponent","TransformComponent"]),this.overrideLights=null,this._needsUpdate=!0,this.lights=[]}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.setOverrideLights=function(e){this.overrideLights=e,n.emit("goo.setLights",this.overrideLights),this._needsUpdate=!0},r.prototype.clearOverrideLights=function(){this.overrideLights=undefined,this._needsUpdate=!0},r.prototype.inserted=function(e){e.lightComponent.updateLight(e.transformComponent.worldTransform)},r.prototype.process=function(t){if(!this.overrideLights){this.lights.length=0;for(var r=0;r<t.length;r++){var i=t[r],s=i.transformComponent,o=i.lightComponent;(s._updated||this._needsUpdate)&&o.updateLight(s.worldTransform);if(!o.hidden){var u=o.light;u.shadowCaster=u.shadowCaster&&e.TextureFloat,this.lights.push(u)}}this._needsUpdate=!1,n.emit("goo.setLights",this.lights)}},r.prototype.invalidateHandles=function(e){this._activeEntities.forEach(function(t){t.lightComponent.light.invalidateHandles(e)})},r}),define("goo/entities/systems/CameraSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/Renderer"],function(e,t,n){function r(){e.call(this,"CameraSystem",["TransformComponent","CameraComponent"]),this.mainCamera=null}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.findMainCamera=function(){if(this._activeEntities.length){var e=this._activeEntities[0];t.emit("goo.setCurrentCamera",{camera:e.cameraComponent.camera,entity:e})}},r.prototype.inserted=function(e){n.mainCamera||t.emit("goo.setCurrentCamera",{camera:e.cameraComponent.camera,entity:e})},r.prototype.deleted=function(){},r.prototype.process=function(){for(var e=0;e<this._activeEntities.length;e++){var t=this._activeEntities[e],n=t.transformComponent,r=t.cameraComponent;n._updated&&r.updateCamera(n.worldTransform)}},r}),define("goo/entities/systems/ParticlesSystem",["goo/entities/systems/System"],function(e){function t(){e.call(this,"ParticlesSystem",["TransformComponent","MeshRendererComponent","MeshDataComponent","ParticleComponent"]),this.passive=!1}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.process=function(e,t){if(t>1)return;for(var n=0,r=e.length;n<r;n++){var i=e[n],s=i.particleComponent;s.enabled&&this.updateParticles(i,s,t)}},t.prototype.updateParticles=function(e,t,n){var r=0,i=-1,s,o=!1,u=!1;while(r<t.particleCount){while(s===undefined){i++;if(t.emitters.length>i){s=t.emitters[i];if(s.influences.length)for(var a=0,f=s.influences.length;a<f;a++)s.influences[a].prepare(e,s);if(!s.enabled){s=undefined;continue}s.totalParticlesToSpawn!==0&&(s.particlesWaitingToRelease+=s.releaseRatePerSecond*n,s.particlesWaitingToRelease=Math.max(s.particlesWaitingToRelease,0),u=!0);if(s.particlesWaitingToRelease<1){s=undefined;continue}}else s=null}var l=t.particles[r];if(l.alive&&l.emitter&&l.emitter.influences.length)for(var a=0,f=l.emitter.influences.length;a<f;a++)l.emitter.influences[a].enabled&&l.emitter.influences[a].apply(n,l,r);l.alive&&(l.update(n,e),o=!0,u=!0);if(!l.alive&&s){s.particlesWaitingToRelease--,s.totalParticlesToSpawn>=1&&s.totalParticlesToSpawn--,l.respawnParticle(s),s.getEmissionPoint(l,e),s.getEmissionVelocity(l,e);if(s.particlesWaitingToRelease<1||s.totalParticlesToSpawn===0)s=undefined}r++}o&&(t.meshData.vertexData._dataNeedsRefresh=!0,e.meshDataComponent.autoCompute=!0),u||(t.enabled=!1)},t}),define("goo/util/Stats",[],function(){function e(){var e=Date.now(),t=e,n=e,r=0,i=Infinity,s=0,o=0,u=Infinity,a=0,f=0,l=0,c=document.createElement("div");c.id="stats",c.addEventListener("mousedown",function(e){e.preventDefault(),E(++l%2)},!1),c.style.cssText="width:80px;cursor:pointer;z-index:1000;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;";var h=document.createElement("div");h.id="fps",h.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",c.appendChild(h);var p=document.createElement("div");p.id="fpsText",p.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",p.innerHTML="FPS",h.appendChild(p);var d=document.createElement("div");d.id="fpsGraph",d.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",h.appendChild(d);while(d.children.length<74){var v=document.createElement("span");v.style.cssText="width:1px;height:30px;float:left;background-color:#113",d.appendChild(v)}var m=document.createElement("div");m.id="ms",m.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",c.appendChild(m);var g=document.createElement("div");g.id="msText",g.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",g.innerHTML="MS",m.appendChild(g);var y=document.createElement("div");y.id="msGraph",y.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",m.appendChild(y);while(y.children.length<74){var v=document.createElement("span");v.style.cssText="width:1px;height:30px;float:left;background-color:#131",y.appendChild(v)}var b=document.createElement("div");b.id="info",b.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#200",c.appendChild(b);var w=document.createElement("div");w.id="infoText",w.style.cssText="color:#f66;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",w.innerHTML="INFO",b.appendChild(w);var E=function(e){l=e;switch(l){case 0:h.style.display="block",m.style.display="none";break;case 1:h.style.display="none",m.style.display="block"}},S=function(e,t){var n=e.appendChild(e.firstChild);n.style.height=t+"px"};this.domElement=c,this.setMode=E,this.begin=function(){e=Date.now()},this.end=function(l){var c=Date.now();return c>n+100&&(r=c-e,i=Math.min(i,r),s=Math.max(s,r),g.textContent=r+" MS ("+i+"-"+s+")",S(y,Math.min(30,30-r/200*30)),n=c,l&&(w.innerHTML=l)),f++,c>t+1e3&&(o=Math.round(f*1e3/(c-t)),u=Math.min(u,o),a=Math.max(a,o),p.textContent=o+" FPS ("+u+"-"+a+")",S(d,Math.min(30,30-o/(Math.min(500,a)+10)*30)),t=c,f=0),c},this.update=function(t){e=this.end(t)}}return e}),define("goo/entities/systems/SoundSystem",["goo/entities/systems/System","goo/sound/AudioContext","goo/math/Vector3","goo/math/MathUtils","goo/entities/SystemBus","goo/util/ObjectUtil","goo/math/Matrix4x4"],function(e,t,n,r,i,s,o){function u(){return;var n}return u.prototype=Object.create(e.prototype),u.prototype.constructor=u,u.prototype.inserted=function(e){e.soundComponent.connectTo({dry:this._outNode,wet:this._convolver})},u.prototype.deleted=function(e){if(e.soundComponent){var t=e.soundComponent.sounds;for(var n=0;n<t.length;n++)t[n].stop();e.soundComponent.connectTo()}},u.prototype.updateConfig=function(e){if(!t.isSupported()){console.warn("WebAudio not supported");return}s.extend(this._settings,e),e.dopplerFactor!==undefined&&(this._listener.dopplerFactor=e.dopplerFactor*.05),e.volume!==undefined&&(this._outNode.gain.value=r.clamp(e.volume,0,1)),e.reverb!==undefined&&(this._wetNode.gain.value=r.clamp(e.reverb,0,1))},u.prototype.setReverb=function(e){if(!t.isSupported()){console.warn("WebAudio not supported");return}this._wetNode.disconnect(),!e&&this._wetNode?this._convolver.buffer=null:(this._convolver.buffer=e,this._wetNode.connect(this._outNode))},u.prototype.pause=function(){if(this._pausedSounds)return;this._pausedSounds={};for(var e=0;e<this.entities.length;e++){var t=this.entities[e].soundComponent.sounds;for(var n=0;n<t.length;n++){var r=t[n];r.isPlaying()&&(r.pause(),this._pausedSounds[r.id]=!0)}}},u.prototype.stop=function(){for(var e=0;e<this.entities.length;e++){var t=this.entities[e].soundComponent.sounds;for(var n=0;n<t.length;n++){var r=t[n];r.stop()}}this._pausedSounds=null},u.prototype.resume=function(){if(!this._pausedSounds)return;for(var e=0;e<this.entities.length;e++){var t=this.entities[e].soundComponent.sounds;for(var n=0;n<t.length;n++){var r=t[n];this._pausedSounds[r.id]&&r.play()}}this._pausedSounds=null},u.prototype.process=function(e,n){if(!t.isSupported())return;this.entities=e;var r=this._relativeTransform,i;this._camera&&(i=this._camera.getViewMatrix());for(var s=0;s<e.length;s++){var u=e[s],a=u.soundComponent;a._attachedToCamera=!!u.cameraComponent&&u.cameraComponent.camera===this._camera,this._camera&&!a._attachedToCamera?(o.combine(i,u.transformComponent.worldTransform.matrix,r),a.process(this._settings,r,n)):a.process(this._settings,null,n)}},u}),define("goo/util/GameUtils",[],function(){function e(){}e.supported={fullscreen:!0,pointerLock:!0},e.requestFullScreen=function(){!document.fullscreenElement&&document.documentElement.requestFullScreen&&document.documentElement.requestFullScreen()},e.exitFullScreen=function(){document.fullscreenElement&&document.cancelFullScreen&&document.cancelFullScreen()},e.toggleFullScreen=function(){document.fullscreenElement?document.cancelFullScreen&&document.cancelFullScreen():document.documentElement.requestFullScreen&&document.documentElement.requestFullScreen()},e.requestPointerLock=function(){document.documentElement.requestPointerLock&&document.documentElement.requestPointerLock()},e.exitPointerLock=function(){document.exitPointerLock&&document.exitPointerLock()},e.togglePointerLock=function(){document.pointerLockElement?document.exitPointerLock&&document.exitPointerLock():document.documentElement.requestPointerLock&&document.documentElement.requestPointerLock()};var t=[];return e.addVisibilityChangeListener=function(e){if(typeof e!="function")return;var n=["","ms","moz","webkit"],r,i;for(var s=0;s<n.length;++s){var o=n[s]+(n[s].length===0?"hidden":"Hidden"),u=n[s]+"visibilitychange";if(typeof document[o]!="undefined"){r=o,i=u;break}}if(typeof document.addEventListener!="undefined"&&typeof r!="undefined"){var a=function(){document[r]?e(!0):e(!1)};t.push({eventName:i,eventListener:a}),document.addEventListener(i,a)}},e.clearVisibilityChangeListeners=function(){t.forEach(function(e){document.removeEventListener(e.eventName,e.eventListener)}),t=[]},e.initAllShims=function(t){e.initWebGLShims(),e.initFullscreenShims(t),e.initPointerLockShims(t)},e.initWebGLShims=function(){window.Uint8ClampedArray=window.Uint8ClampedArray||window.Uint8Array},e.initFullscreenShims=function(t){function i(){var e=document.createEvent("CustomEvent");e.initCustomEvent("fullscreenchange",!0,!1,null),document.dispatchEvent(e)}function s(){var e=document.createEvent("CustomEvent");e.initCustomEvent("fullscreenerror",!0,!1,null),document.dispatchEvent(e)}t=t||window;var n=(t.HTMLElement||t.Element).prototype;if(!document.hasOwnProperty("fullscreenEnabled")){var r=function(){return"webkitIsFullScreen"in document?function(){return document.webkitFullscreenEnabled}:"mozFullScreenEnabled"in document?function(){return document.mozFullScreenEnabled}:(e.supported.fullscreen=!1,function(){return!1})}();Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,writeable:!1,get:r})}if(!document.hasOwnProperty("fullscreenElement")){var r=function(){var e=["webkitCurrentFullScreenElement","webkitFullscreenElement","mozFullScreenElement"],t=function(t){return function(){return document[e[t]]}};for(var n=0;n<e.length;n++)if(e[n]in document)return t(n);return function(){return null}}();Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,writeable:!1,get:r})}document.addEventListener("webkitfullscreenchange",i,!1),document.addEventListener("mozfullscreenchange",i,!1),document.addEventListener("webkitfullscreenerror",s,!1),document.addEventListener("mozfullscreenerror",s,!1),n.requestFullScreen||(n.requestFullScreen=function(){return n.webkitRequestFullScreen?function(){this.webkitRequestFullScreen(t.Element.ALLOW_KEYBOARD_INPUT)}:n.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:function(){}}()),document.cancelFullScreen||(document.cancelFullScreen=function(){return document.webkitCancelFullScreen||document.mozCancelFullScreen||function(){}}())},e.initPointerLockShims=function(t){function i(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(e)}function s(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(e)}t=t||window;var n=(t.HTMLElement||t.Element).prototype;if(!t.MouseEvent)return;var r=t.MouseEvent.prototype;"movementX"in r||Object.defineProperty(r,"movementX",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementX||this.mozMovementX||0}}),"movementY"in r||Object.defineProperty(r,"movementY",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementY||this.mozMovementY||0}}),navigator.pointer||(navigator.pointer=navigator.webkitPointer||navigator.mozPointer),document.addEventListener("webkitpointerlockchange",i,!1),document.addEventListener("webkitpointerlocklost",i,!1),document.addEventListener("mozpointerlockchange",i,!1),document.addEventListener("mozpointerlocklost",i,!1),document.addEventListener("webkitpointerlockerror",s,!1),document.addEventListener("mozpointerlockerror",s,!1);if(!document.hasOwnProperty("pointerLockElement")){var o=function(){return"webkitPointerLockElement"in document?function(){return document.webkitPointerLockElement}:"mozPointerLockElement"in document?function(){return document.mozPointerLockElement}:function(){return null}}();Object.defineProperty(document,"pointerLockElement",{enumerable:!0,configurable:!1,writeable:!1,get:o})}n.requestPointerLock||(n.requestPointerLock=function(){return n.webkitRequestPointerLock?function(){this.webkitRequestPointerLock()}:n.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:navigator.pointer?function(){var e=this;navigator.pointer.lock(e,i,s)}:(e.supported.pointerLock=!1,function(){})}()),document.exitPointerLock||(document.exitPointerLock=function(){return document.webkitExitPointerLock||document.mozExitPointerLock||function(){navigator.pointer&&navigator.pointer.unlock()}}())},e}),define("goo/util/Logo",[],function(){function e(){}e.blue="#2A3276",e.white="#FFFFFF";var t={color:e.white,shadow:!1};return e.getLogo=function(e){e=e||{};for(var n in t)e[n]===undefined&&(e[n]=t[n]);if(!document.createElementNS)return"";var r="http://www.w3.org/2000/svg",i=document.createElementNS(r,"svg");i.setAttribute("version","1.1"),i.setAttribute("xmlns",r),i.setAttribute("x","0px"),i.setAttribute("y","0px"),i.setAttribute("viewBox","0 0 396.603 277.343"),i.setAttribute("enable-background","new 0 0 396.603 277.343"),i.setAttribute("xml:space","preserve"),e.width&&i.setAttribute("width",e.width),e.height&&i.setAttribute("height",e.height);var s=document.createElementNS(r,"g");i.appendChild(s);var o=document.createElementNS(r,"filter");o.setAttribute("id","insetShadow");var u=document.createElementNS(r,"feGaussianBlur");u.setAttribute("in","SourceAlpha"),u.setAttribute("stdDeviation","0");var a=document.createElementNS(r,"feOffset");a.setAttribute("dx","0"),a.setAttribute("dy","-5"),a.setAttribute("result","offsetblur");var f=document.createElementNS(r,"feComponentTransfer"),l=document.createElementNS(r,"feFuncA");l.setAttribute("type","linear"),l.setAttribute("slope","0.5"),f.appendChild(l);var c=document.createElementNS(r,"feMerge"),h=document.createElementNS(r,"feMergeNode"),p=document.createElementNS(r,"feMergeNode");p.setAttribute("in","SourceGraphic"),c.appendChild(h),c.appendChild(p),o.appendChild(u),o.appendChild(a),o.appendChild(f),o.appendChild(c),s.appendChild(o);var d=document.createElementNS(r,"path");d.setAttribute("d","M303.337,46.286c-13.578,0-25.784,5.744-34.396,14.998c-9.86,10.59-26.319,10.59-36.172,0c-8.605-9.254-20.818-14.998-34.402-14.998c-25.936,0-46.971,21.034-46.971,46.978c0,25.936,21.035,46.972,46.971,46.972c13.584,0,25.797-5.744,34.402-14.998c9.853-10.598,26.325-10.598,36.172,0c8.612,9.254,20.818,14.998,34.396,14.998c25.941,0,46.977-21.036,46.977-46.972C350.313,67.32,329.278,46.286,303.337,46.286z M198.296,116.39c-12.785,0-23.146-10.359-23.146-23.144s10.361-23.151,23.146-23.151c12.795,0,23.156,10.367,23.156,23.151S211.091,116.39,198.296,116.39z M303.337,116.407c-12.785,0-23.146-10.36-23.146-23.144c0-12.784,10.36-23.151,23.146-23.151c12.795,0,23.156,10.367,23.156,23.151C326.493,106.047,316.132,116.407,303.337,116.407z M156.18,138.347c-14.087-3.23-22.316-17.482-18.068-31.305c3.704-12.072,2.568-25.511-4.22-37.256C120.927,47.323,92.22,39.63,69.766,52.587C47.317,65.552,39.624,94.26,52.581,116.713c6.795,11.761,17.853,19.462,30.17,22.282c14.084,3.235,22.314,17.497,18.074,31.317c-3.711,12.08-2.582,25.504,4.213,37.264c12.965,22.455,41.666,30.148,64.127,17.178c22.447-12.945,30.148-41.658,17.185-64.111C179.554,148.881,168.497,141.181,156.18,138.347z M104.802,113.287c-11.064,6.387-25.219,2.599-31.604-8.474c-6.397-11.07-2.604-25.225,8.474-31.609c11.057-6.398,25.22-2.598,31.611,8.46C119.673,92.741,115.872,106.897,104.802,113.287z M145.687,207.256c-12.785,0-23.145-10.361-23.145-23.145s10.359-23.15,23.145-23.15c12.797,0,23.156,10.367,23.156,23.15S158.483,207.256,145.687,207.256z"),d.setAttribute("fill",e.color),e.shadow&&(s.appendChild(o),d.setAttribute("style","filter:url(#insetShadow)")),s.appendChild(d);var v=new XMLSerializer,m=v.serializeToString(i);return m},e}),define("goo/entities/GooRunner",["goo/entities/World","goo/renderer/Renderer","goo/entities/systems/TransformSystem","goo/entities/systems/RenderSystem","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/ScriptSystem","goo/entities/systems/LightingSystem","goo/entities/systems/CameraSystem","goo/entities/systems/ParticlesSystem","goo/util/Stats","goo/sound/AudioContext","goo/entities/systems/SoundSystem","goo/entities/components/TransformComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/CameraComponent","goo/entities/components/LightComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/util/GameUtils","goo/util/Logo","goo/entities/SystemBus","goo/renderer/Material"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S){function x(n){n=n||{},b.initAllShims(),this.world=new e(this),this.renderer=new t(n),this.useTryCatch=n.useTryCatch!==undefined?n.useTryCatch:!0,this._setBaseSystems(),this._registerBaseComponents(),this.doProcess=!0,this.doRender=!0,this.tpfSmoothingCount=n.tpfSmoothingCount!==undefined?n.tpfSmoothingCount:10,n.showStats&&(this.stats=new f,this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="10px",this.stats.domElement.style.top="10px",document.body.appendChild(this.stats.domElement));if(n.logo===undefined||n.logo){var r=this._buildLogo(n.logo);r&&document.body.appendChild(r)}this.callbacksPreProcess=[],this.callbacksPreRender=[],this.callbacks=[],this.callbacksNextFrame=[],this._takeSnapshots=[],this.start=-1,this.animationId=0,n.manuallyStartGameLoop||this.startGameLoop(),n.debugKeys&&this._addDebugKeys(),this._events={click:null,mousedown:null,mouseup:null,mousemove:null,touchstart:null,touchend:null,touchmove:null},this._eventListeners={click:[],mousedown:[],mouseup:[],mousemove:[],touchstart:[],touchend:[],touchmove:[]},this._eventTriggered={click:null,mousedown:null,mouseup:null,mousemove:null,touchstart:null,touchend:null,touchmove:null},b.addVisibilityChangeListener(function(e){e?this._stopGameLoop():this.manuallyPaused||this._startGameLoop()}.bind(this)),this._picking={x:0,y:0,skipUpdateBuffer:!1,doPick:!1,pickingCallback:null,pickingStore:{},clearColorStore:[]},this.manuallyPaused=!!n.manuallyStartGameLoop,this._setupContextLost()}x.prototype._setupContextLost=function(){E.addListener("goo.contextLost",function(){for(var e=0;e<this.renderSystems.length;e++){var t=this.renderSystems[e];t.invalidateHandles&&t.invalidateHandles(this.renderer)}var n=this.world.getSystem("LightingSystem");n&&n.invalidateHandles(this.renderer),this.renderer.shadowHandler&&this.renderer.shadowHandler.invalidateHandles(this.renderer),this.renderer.invalidatePicking(),this.stopGameLoop()}.bind(this)),E.addListener("goo.contextRestored",function(){this.startGameLoop()}.bind(this))},x.prototype._setBaseSystems=function(){this.world.setSystem(new s(this.world)),this.world.setSystem(new n),this.world.setSystem(new u),this.world.setSystem(new a),this.world.setSystem(new i),this.world.setSystem(new o),this.renderSystem=new r,this.renderSystems=[this.renderSystem],this.world.setSystem(this.renderSystem)},x.prototype._registerBaseComponents=function(){this.world.registerComponent(h),this.world.registerComponent(p),this.world.registerComponent(d),this.world.registerComponent(v),this.world.registerComponent(m),this.world.registerComponent(g)},x.prototype.run=function(e){this.useTryCatch?this._callSafe(this._updateFrame,e):this._updateFrame(e)},x.prototype._callSafe=function(e){try{e.apply(this,Array.prototype.slice.call(arguments,1))}catch(t){t instanceof Error?console.error(t.stack):console.log(t)}},x.prototype.setRenderSystem=function(e,t){this.world.setSystem(e),t!==undefined?this.renderSystems.splice(t,0,e):this.renderSystems.push(e)};var T=[],N=0;return x.prototype._updateFrame=function(n){this.start<0&&(this.start=n);var r=(n-this.start)/1e3;if(r<0||r>1){this.start=n,this.animationId=window.requestAnimationFrame(this.run.bind(this));return}r=Math.max(Math.min(r,.5),1e-4),T[N]=r,N=(N+1)%this.tpfSmoothingCount;var i=0;for(var s=0;s<T.length;s++)i+=T[s];i/=T.length,this.world.tpf=i,this.world.time+=this.world.tpf,e.time=this.world.time,e.tpf=this.world.tpf,this.start=n;if(this.callbacksNextFrame.length>0){var o=this.callbacksNextFrame;this.callbacksNextFrame=[];if(this.useTryCatch)for(var s=0;s<o.length;s++){var u=o[s];this._callSafe(u,this.world.tpf)}else for(var s=0;s<o.length;s++){var u=o[s];u(this.world.tpf)}}if(this.useTryCatch)for(var s=0;s<this.callbacksPreProcess.length;s++){var u=this.callbacksPreProcess[s];this._callSafe(u,this.world.tpf)}else for(var s=0;s<this.callbacksPreProcess.length;s++){var u=this.callbacksPreProcess[s];u(this.world.tpf)}this.doProcess&&this.world.process(),this.renderer.info.reset();if(this.doRender){this.renderer.checkResize(t.mainCamera),this.renderer.setRenderTarget();for(var s=0;s<this.callbacksPreRender.length;s++)this.callbacksPreRender[s](this.world.tpf);for(var s=0;s<this.renderSystems.length;s++)this.renderSystems[s].passive||this.renderSystems[s].render(this.renderer);if(this._picking.doPick&&t.mainCamera){var a=this.renderer.clearColor.data;this._picking.clearColorStore[0]=a[0],this._picking.clearColorStore[1]=a[1],this._picking.clearColorStore[2]=a[2],this._picking.clearColorStore[3]=a[3],this.renderer.setClearColor(0,0,0,1);for(var s=0;s<this.renderSystems.length;s++)this.renderSystems[s].renderToPick&&!this.renderSystems[s].passive&&this.renderSystems[s].renderToPick(this.renderer,this._picking.skipUpdateBuffer);this.renderer.pick(this._picking.x,this._picking.y,this._picking.pickingStore,t.mainCamera),this.useTryCatch?this._callSafe(this._picking.pickingCallback,this._picking.pickingStore.id,this._picking.pickingStore.depth):this._picking.pickingCallback(this._picking.pickingStore.id,this._picking.pickingStore.depth),this._picking.doPick=!1,this.renderer.setClearColor.apply(this.renderer,this._picking.clearColorStore)}}if(this.useTryCatch)for(var s=0;s<this.callbacks.length;s++){var u=this.callbacks[s];this._callSafe(u,this.world.tpf)}else for(var s=0;s<this.callbacks.length;s++){var u=this.callbacks[s];u(this.world.tpf)}this.stats&&this.stats.update(this.renderer.info.toString()+"<br>"+"Transform updates: "+this.world.getSystem("TransformSystem").numUpdates+"<br>Cached shaders: ");if(this._takeSnapshots.length){var f=this.renderer.domElement.toDataURL();if(this.useTryCatch)for(var s=this._takeSnapshots.length-1;s>=0;s--){var u=this._takeSnapshots[s];this._callSafe(u,f)}else for(var s=this._takeSnapshots.length-1;s>=0;s--){var u=this._takeSnapshots[s];u(f)}this._takeSnapshots=[]}this.animationId&&(this.animationId=window.requestAnimationFrame(this.run.bind(this)))},x.prototype._buildLogo=function(e){var t=document.createElement("div"),n=e&&e.color?e.color:w.white,r=w.getLogo({width:"70px",height:"50px",color:n});if(r==="")return;return t.innerHTML='<a style="text-decoration: none;" href="http://www.goocreate.com" target="_blank">'+r+"</a>",t.style.position="absolute",t.style.zIndex="2000",e?e==="topright"||e.position==="topright"?(t.style.top="10px",t.style.right="10px"):e==="topleft"||e.position==="topleft"?(t.style.top="10px",t.style.left="10px"):e==="bottomright"||e.position==="bottomright"?(t.style.bottom="10px",t.style.right="10px"):(t.style.bottom="10px",t.style.left="10px"):(t.style.top="10px",t.style.right="10px"),t.id="goologo",t.style.webkitTouchCallout="none",t.style.webkitUserSelect="none",t.style.khtmlUserSelect="none",t.style.mozUserSelect="none",t.style.msUserSelect="none",t.style.userSelect="none",t.ondragstart=function(){return!1},t},x.prototype._addDebugKeys=function(){var e="shiftKey";document.addEventListener("keydown",function(t){t.which===32&&t[e]?b.toggleFullScreen():t.which===13&&t[e]?b.togglePointerLock():t.which===49&&t[e]?this.renderSystem.setDebugMaterial():t.which!==50&&t.which!==222||!t[e]?t.which===51&&t[e]?this.renderSystem.setDebugMaterial("lit"):t.which===52&&t[e]?this.renderSystem.setDebugMaterial("color"):t.which===53&&t[e]?this.renderSystem.setDebugMaterial("wireframe"):t.which===54&&t[e]?this.renderSystem.setDebugMaterial("flat"):t.which!==55&&t.which!==191||!t[e]?t.which===56&&t[e]&&this.renderSystem.setDebugMaterial("+wireframe"):this.renderSystem.setDebugMaterial("texture"):this.renderSystem.setDebugMaterial("normals")}.bind(this),!1),document.addEventListener("mousedown",function(t){if(t[e]){var n=t.clientX,r=t.clientY;this.pick(n,r,function(e,t){var n=this.world.entityManager.getEntityById(e);console.log("Picked entity:",n,"At depth:",t)}.bind(this))}}.bind(this),!1)},x.prototype.addEventListener=function(e,t){if(!this._eventListeners[e]||this._eventListeners[e].indexOf(t)>-1)return;typeof t=="function"&&(this._eventListeners[e].push(t),this._eventListeners[e].length===1&&this._enableEvent(e))},x.prototype.removeEventListener=function(e,t){if(!this._eventListeners[e])return;var n=this._eventListeners[e].indexOf(t);n>-1&&this._eventListeners[e].splice(n,1),this._eventListeners[e].length===0&&this._disableEvent(e)},x.prototype.triggerEvent=function(e,t){t.type=e,this._eventTriggered[e]=t.domEvent,this._dispatchEvent(t)},x.prototype._dispatchEvent=function(e){var t=Object.keys(this._eventTriggered);for(var n=0;n<t.length;n++){var r=t[n];if(this._eventTriggered[r]&&this._eventListeners[r]){var i={entity:e.entity,depth:e.depth,x:e.x,y:e.y,type:r,domEvent:this._eventTriggered[r],id:e.id,intersection:e.intersection};try{for(var s=0;s<this._eventListeners[r].length;s++)if(this._eventListeners[r][s](i)===!1)break}catch(o){console.error(o)}this._eventTriggered[r]=null}}},x.prototype._enableEvent=function(e){if(this._events[e])return;var n=function(n){var r,i;n.type==="touchstart"||n.type==="touchend"||n.type==="touchmove"?(r=n.changedTouches[0].pageX-n.changedTouches[0].target.getBoundingClientRect().left,i=n.changedTouches[0].pageY-n.changedTouches[0].target.getBoundingClientRect().top):(r=n.offsetX!==undefined?n.offsetX:n.clientX,i=n.offsetY!==undefined?n.offsetY:n.clientY),this._eventTriggered[e]=n,this.pick(r,i,function(e,n){var s=this.renderer.devicePixelRatio,o=this.world.entityManager.getEntityByIndex(e),u=t.mainCamera.getWorldPosition(r*s,i*s,this.renderer.viewportWidth,this.renderer.viewportHeight,n);this._dispatchEvent({entity:o,depth:n,x:r,y:i,id:e,intersection:u})}.bind(this))}.bind(this);this.renderer.domElement.addEventListener(e,n),this._events[e]=n},x.prototype._disableEvent=function(e){this._events[e]&&this.renderer.domElement.removeEventListener(e,this._events[e]),this._events[e]=null},x.prototype._startGameLoop=function(){this.animationId||(this.start=-1,this.animationId=window.requestAnimationFrame(this.run.bind(this)))},x.prototype.startGameLoop=function(){this.manuallyPaused=!1,this._startGameLoop()},x.prototype._stopGameLoop=function(){window.cancelAnimationFrame(this.animationId),this.animationId=0},x.prototype.stopGameLoop=function(){this.manuallyPaused=!0,this._stopGameLoop()},x.prototype.takeSnapshot=function(e){this._takeSnapshots.push(e)},x.prototype.pick=function(e,t,n,r){this._picking.x=e,this._picking.y=t,this._picking.skipUpdateBuffer=r===undefined?!1:r,n&&(this._picking.pickingCallback=n),this._picking.doPick=!0},x.prototype.pickSync=function(e,n,r){var i=this.renderer.clearColor.data;this._picking.skipUpdateBuffer=r===undefined?!1:r;var s=[i[0],i[1],i[2],i[3]];this.renderer.setClearColor(0,0,0,1),this.renderSystem.renderToPick(this.renderer,!1),this.renderer.setClearColor.apply(this.renderer,s);var o={};return this.renderer.pick(e,n,o,t.mainCamera),o},x.prototype.clear=function(){this.stopGameLoop(),this.world.clear();var e=this.renderer.domElement;e.parentNode&&e.parentNode.removeChild(e),E.clear(),S.store=[],S.hash=[],t.mainCamera=null,b.clearVisibilityChangeListeners(),this.world=null,this.renderer=null,this.renderSystem=null,this.renderSystems=null,this.callbacks=null,this.callbacksPreProcess=null,this.callbacksPreRender=null,this.callbacksNextFrame=null,this._takeSnapshots=null,this._events=null},x}),define("goo/animationpack/Joint",["goo/math/Transform"],function(e){function t(t){this._name=t,this._index=0,this._parentIndex=0,this._inverseBindPose=new e}return t.NO_PARENT=-32768,t}),define("goo/animationpack/Skeleton",["goo/animationpack/Joint"],function(e){function t(e,t){this._name=e,this._joints=t}return t.prototype.clone=function(){var n=this._name,r=this._joints,i=[];for(var s=0,o=r.length;s<o;s++){var u=r[s],a=u._name,f=new e(a);f._index=u._index,f._parentIndex=u._parentIndex,f._inverseBindPose.copy(u._inverseBindPose),f._inverseBindPose.update(),i[s]=f}return new t(n,i)},t}),define("goo/animationpack/SkeletonPose",["goo/math/Transform","goo/animationpack/Joint","goo/math/Matrix4x4"],function(e,t,n){function r(t){this._skeleton=t,this._localTransforms=[],this._globalTransforms=[],this._matrixPalette=[],this._poseListeners=[];var r=this._skeleton._joints.length;for(var i=0;i<r;i++)this._localTransforms[i]=new e;for(var i=0;i<r;i++)this._globalTransforms[i]=new e;for(var i=0;i<r;i++)this._matrixPalette[i]=new n;this.setToBindPose()}return r.prototype.setToBindPose=function(){for(var e=0;e<this._localTransforms.length;e++){this._localTransforms[e].matrix.copy(this._skeleton._joints[e]._inverseBindPose.matrix).invert();var r=this._skeleton._joints[e]._parentIndex;r!==t.NO_PARENT&&n.combine(this._skeleton._joints[r]._inverseBindPose.matrix,this._localTransforms[e].matrix,this._localTransforms[e].matrix)}this.updateTransforms()},r.prototype.updateTransforms=function(){var e=this._skeleton._joints;for(var r=0,i=e.length;r<i;r++){var s=e[r]._parentIndex;s!==t.NO_PARENT?n.combine(this._globalTransforms[s].matrix,this._localTransforms[r].matrix,this._globalTransforms[r].matrix):this._globalTransforms[r].matrix.copy(this._localTransforms[r].matrix),n.combine(this._globalTransforms[r].matrix,e[r]._inverseBindPose.matrix,this._matrixPalette[r])}this.firePoseUpdated()},r.prototype.firePoseUpdated=function(){for(var e=this._poseListeners.length-1;e>=0;e--)this._poseListeners[e].poseUpdated(this)},r.prototype.clone=function(){return new r(this._skeleton)},r}),define("goo/animationpack/handlers/SkeletonHandler",["goo/loaders/handlers/ConfigHandler","goo/animationpack/Joint","goo/animationpack/Skeleton","goo/animationpack/SkeletonPose","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s){function o(){e.apply(this,arguments)}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,e._registerClass("skeleton",o),o.prototype._update=function(e,o){if(!this._objects.has(e)){if(!o)return i.resolve();var u=[];s.forEach(o.joints,function(e){var n=new t(e.name);n._index=e.index,n._parentIndex=e.parentIndex,n._inverseBindPose.matrix.data.set(e.inverseBindPose),u.push(n)},null,"index");var a=new n(o.name,u),f=new r(a);f.setToBindPose(),this._objects.set(e,f)}return i.resolve(this._objects.get(e))},o}),define("goo/animationpack/state/AbstractState",[],function(){function e(){this._globalStartTime=0,this.onFinished=null}return e.prototype.update=function(){},e.prototype.postUpdate=function(){},e.prototype.getCurrentSourceData=function(){},e.prototype.resetClips=function(e){this._globalStartTime=e},e.prototype.shiftClipTime=function(e){this._globalStartTime+=e},e}),define("goo/animationpack/clip/TransformData",["goo/math/Quaternion","goo/math/Vector3"],function(e,t){function n(n){this._rotation=(new e).copy(n?n._rotation:e.IDENTITY),this._scale=(new t).copy(n?n._scale:t.ONE),this._translation=(new t).copy(n?n._translation:t.ZERO)}return n.prototype.applyTo=function(e){e.rotation.copyQuaternion(this._rotation),e.scale.setVector(this._scale),e.translation.setVector(this._translation),e.update()},n.prototype.set=function(e){this._rotation.copy(e._rotation),this._scale.copy(e._scale),this._translation.copy(e._translation)},n.prototype.blend=function(t,r,i){var s=i?i:new n;return s._translation.setVector(this._translation).lerp(t._translation,r),s._scale.setVector(this._scale).lerp(t._scale,r),e.slerp(this._rotation,t._rotation,r,s._rotation),s},n}),define("goo/animationpack/blendtree/BinaryLERPSource",["goo/math/MathUtils","goo/animationpack/clip/TransformData"],function(e,t){function n(e,t,n){this._sourceA=e?e:null,this._sourceB=t?t:null,this.blendWeight=n?n:null}return n.prototype.getSourceData=function(){var e=this._sourceA?this._sourceA.getSourceData():null,t=this._sourceB?this._sourceB.getSourceData():null;return n.combineSourceData(e,t,this.blendWeight)},n.prototype.setTime=function(e){var t=!1,n=!1;return this._sourceA&&(t=this._sourceA.setTime(e)),this._sourceB&&(n=this._sourceB.setTime(e)),t||n},n.prototype.resetClips=function(e){this._sourceA&&this._sourceA.resetClips(e),this._sourceB&&this._sourceB.resetClips(e)},n.prototype.shiftClipTime=function(e){this._sourceA&&this._sourceA.shiftClipTime(e),this._sourceB&&this._sourceB.shiftClipTime(e)},n.prototype.setTimeScale=function(e){this._sourceA.setTimeScale(e),this._sourceB.setTimeScale(e)},n.prototype.isActive=function(){var e=!1;return this._sourceA&&(e=e||this._sourceA.isActive()),this._sourceB&&(e=e||this._sourceB.isActive()),e},n.combineSourceData=function(e,r,i,s){if(!r)return e;if(!e)return r;var o=s?s:{};for(var u in e){var a=e[u],f=r[u];if(!isNaN(a)){n.blendFloatValues(o,u,i,a,f);continue}if(!(a instanceof t)){o[u]=a;continue}f?o[u]=a.blend(f,i,o[u]):o[u]?o[u].set(a):o[u]=new a.constructor(a)}for(var u in r){if(o[u])continue;o[u]=r[u]}return o},n.blendFloatValues=function(t,n,r,i,s){isNaN(s)?t[n]=i:t[n]=e.lerp(r,i[0],s[0])},n.prototype.clone=function(){return new n(this._sourceA,this._sourceB,this._blendWeight)},n}),define("goo/animationpack/state/AbstractTransitionState",["goo/animationpack/state/AbstractState","goo/animationpack/blendtree/BinaryLERPSource","goo/math/MathUtils"],function(e,t,n){function r(){e.call(this),this._sourceState=null,this._targetState=null,this._percent=0,this._sourceData=null,this._fadeTime=0,this._blendType="Linear"}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.update=function(e){var t=e-this._globalStartTime;if(t>this._fadeTime&&this.onFinished){this.onFinished();return}var r=t/this._fadeTime;switch(this._blendType){case"SCurve3":this._percent=n.scurve3(r);break;case"SCurve5":this._percent=n.scurve5(r);break;default:this._percent=r}},r.prototype.readFromConfig=function(e){e&&(e.fadeTime!==undefined&&(this._fadeTime=e.fadeTime),e.blendType!==undefined&&(this._blendType=e.blendType))},r.prototype.getCurrentSourceData=function(){var e=this._sourceState?this._sourceState.getCurrentSourceData():null,n=this._targetState?this._targetState.getCurrentSourceData():null;return this._sourceData||(this._sourceData={}),t.combineSourceData(e,n,this._percent,this._sourceData)},r.prototype.isValid=function(e,t){var n=t-this._sourceState._globalStartTime,r=e[0],i=e[1];return r<=0?i<=0?!0:n<=i:i<=0?n>=r:r<=i?r<=n&&n<=i:n>=r||n<=i},r.prototype.resetClips=function(t){e.prototype.resetClips.call(this,t),this._percent=0},r.prototype.shiftClipTime=function(t){e.prototype.shiftClipTime.call(this,t)},r.prototype.setTimeScale=function(e){this._sourceState&&this._sourceState.setTimeScale(e),this._targetState&&this._targetState.setTimeScale(e)},r}),define("goo/animationpack/state/FadeTransitionState",["goo/animationpack/state/AbstractTransitionState"],function(e){function t(){e.call(this)}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.update=function(t){e.prototype.update.call(this,t),this._sourceState&&this._sourceState.update(t),this._targetState&&this._targetState.update(t)},t.prototype.postUpdate=function(){this._sourceState&&this._sourceState.postUpdate(),this._targetState&&this._targetState.postUpdate()},t.prototype.resetClips=function(t){e.prototype.resetClips.call(this,t),this._targetState&&this._targetState.resetClips(t)},t.prototype.shiftClipTime=function(t){e.prototype.shiftClipTime.call(this,t),this._targetState&&this._targetState.shiftClipTime(t),this._sourceState&&this._sourceState.shiftClipTime(t)},t}),define("goo/animationpack/state/SyncFadeTransitionState",["goo/animationpack/state/FadeTransitionState"],function(e){function t(){e.call(this)}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.resetClips=function(t){e.prototype.resetClips.call(this,t),this._targetState.resetClips(this._sourceState._globalStartTime)},t.prototype.shiftClipTime=function(t){e.prototype.shiftClipTime.call(this,t),this._targetState.shiftClipTime(this._sourceState._globalStartTime+t),this._sourceState.shiftClipTime(t)},t}),define("goo/animationpack/state/FrozenTransitionState",["goo/animationpack/state/AbstractTransitionState"],function(e){function t(){e.call(this)}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.update=function(t){e.prototype.update.call(this,t),this._targetState&&this._targetState.update(t)},t.prototype.postUpdate=function(){this._targetState&&this._targetState.postUpdate()},t.prototype.resetClips=function(t){e.prototype.resetClips.call(this,t),this._targetState.resetClips(t)},t.prototype.shiftClipTime=function(t){e.prototype.shiftClipTime.call(this,t),this._targetState.shiftClipTime(t)},t}),define("goo/animationpack/state/SteadyState",["goo/animationpack/state/AbstractState"],function(e){function t(t){e.call(this),this.id=null,this._name=t,this._transitions={},this._sourceTree=null}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.setClipSource=function(e){this._sourceTree=e},t.prototype.update=function(e){this._sourceTree.setTime(e)||this.onFinished&&this.onFinished()},t.prototype.getCurrentSourceData=function(){return this._sourceTree.getSourceData()},t.prototype.resetClips=function(t){e.prototype.resetClips.call(this,t),this._sourceTree.resetClips(t)},t.prototype.shiftClipTime=function(t){e.prototype.shiftClipTime.call(this,t),this._sourceTree.shiftClipTime(t)},t.prototype.setTimeScale=function(e){this._sourceTree.setTimeScale(e)},t.prototype.clone=function(){var e=new t(this._name);for(var n in this._transitions)e._transitions[n]=this._transitions[n];return e._sourceTree=this._sourceTree.clone(),e._sourceTree._name=this._sourceTree.name,e},t}),define("goo/animationpack/layer/LayerLERPBlender",["goo/animationpack/blendtree/BinaryLERPSource"],function(e){function t(){this._blendWeight=null,this._layerA=null,this._layerB=null}return t.prototype.getBlendedSourceData=function(){var t=this._layerA.getCurrentSourceData(),n=this._layerB._currentState?this._layerB._currentState.getCurrentSourceData():null;return e.combineSourceData(t,n,this._blendWeight)},t}),define("goo/animationpack/layer/AnimationLayer",["goo/animationpack/state/FadeTransitionState","goo/animationpack/state/SyncFadeTransitionState","goo/animationpack/state/FrozenTransitionState","goo/animationpack/state/SteadyState","goo/animationpack/layer/LayerLERPBlender","goo/entities/World","goo/math/MathUtils"],function(e,t,n,r,i,s,o){function u(e,t){this.id=t,this._name=e,this._steadyStates={},this._currentState=null,this._layerBlender=new i,this._transitions={},this._transitionStates={}}return u.BASE_LAYER_NAME="-BASE_LAYER-",u.prototype.getStates=function(){return Object.keys(this._steadyStates)},u.prototype.setState=function(e,t){this._steadyStates[e]=t},u.prototype.setBlendWeight=function(e){this._layerBlender&&(this._layerBlender._blendWeight=o.clamp(e,0,1))},u.prototype.getTransitions=function(){var e;this._currentState?e=Object.keys(this._currentState._transitions):e=[];if(this._transitions)for(var t in this._transitions)e.indexOf(t)===-1&&e.push(t);return e.sort(),e},u.prototype.update=function(e){this._currentState&&this._currentState.update(typeof e!="undefined"?e:s.time)},u.prototype.postUpdate=function(){this._currentState&&this._currentState.postUpdate()},u.prototype.transitionTo=function(e,t,n){t=typeof t!="undefined"?t:s.time;var i=this._currentState,o;if(this._steadyStates[e]===i)return!1;if(!this._steadyStates[e])return!1;i&&i._transitions&&(o=i._transitions[e]||i._transitions["*"]),!o&&this._transitions&&(o=this._transitions[e]||this._transitions["*"]);if(i instanceof r&&o){var u=this._getTransitionByType(o.type);return this._doTransition(u,i,this._steadyStates[e],o,t,n),!0}if(!i){o=this._transitions[e];if(o){var u=this._getTransitionByType(o.type);if(u)return this._doTransition(u,null,this._steadyStates[e],o,t,n),!0}}return!1},u.prototype._doTransition=function(e,t,n,r,i,s){if(t){e._sourceState=t;var o=r.timeWindow||[-1,-1];if(!e.isValid(o,i)){console.warn("State not in allowed time window");return}t.onFinished=null}e._targetState=n,e.readFromConfig(r),this.setCurrentState(e,!0,i,s)},u.prototype.setCurrentState=function(e,t,n,i){n=typeof n!="undefined"?n:s.time,this._currentState=e,e&&(t&&e.resetClips(n),e.onFinished=function(){this.setCurrentState(e._targetState||null,!1,undefined,i),e instanceof r&&i instanceof Function&&i(),this.update()}.bind(this))},u.prototype.getCurrentState=function(){return this._currentState},u.prototype.setCurrentStateById=function(e,t,n,r){var i=this.getStateById(e);this.setCurrentState(i,t,n,r)},u.prototype.getStateById=function(e){return this._steadyStates[e]},u.prototype.getStateByName=function(e){for(var t in this._steadyStates){var n=this._steadyStates[t];if(n._name===e)return this._steadyStates[t]}},u.prototype.setCurrentStateByName=function(e,t,n){if(e){var r=this.getStateByName(e);if(r)return this.setCurrentState(r,t,n),!0;console.warn("unable to find SteadyState named: "+e)}return!1},u.prototype.getCurrentSourceData=function(){return this._layerBlender?this._layerBlender.getBlendedSourceData():this._currentState?this._currentState.getCurrentSourceData():null},u.prototype.updateLayerBlending=function(e){this._layerBlender&&(this._layerBlender._layerA=e,this._layerBlender._layerB=this)},u.prototype.clearCurrentState=function(){this.setCurrentState(null)},u.prototype.resetClips=function(e){this._currentState&&this._currentState.resetClips(typeof e!="undefined"?e:s.time)},u.prototype.shiftClipTime=function(e){this._currentState&&this._currentState.shiftClipTime(typeof e!="undefined"?e:0)},u.prototype.setTimeScale=function(e){this._currentState&&this._currentState.setTimeScale(e)},u.prototype._getTransitionByType=function(r){if(this._transitionStates[r])return this._transitionStates[r];var i;switch(r){case"Fade":i=new e;break;case"SyncFade":i=new t;break;case"Frozen":i=new n;break;default:console.log("Defaulting to frozen transition type"),i=new n}return this._transitionStates[r]=i},u.prototype.clone=function(){var e=new u(this._name,this.id+"_");for(var t in this._steadyStates)e._steadyStates[t]=this._steadyStates[t].clone(),this._steadyStates[t]===this._currentState&&(e._currentState=e._steadyStates[t]);for(var t in this._transitions)e._transitions[t]=this._transitions[t];for(var t in this._transitionStates)e._transitionStates[t]=new this._transitionStates[t].constructor;return e},u}),define("goo/animationpack/clip/JointData",["goo/animationpack/clip/TransformData"],function(e){function t(t){e.call(this,t),this._jointIndex=t?t._jointIndex:0}return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.set=function(t){e.prototype.set.call(this,t),this._jointIndex=t._jointIndex},t.prototype.blend=function(n,r,i){var s=i;return s?s instanceof t&&(s._jointIndex=this._jointIndex):(s=new t,s._jointIndex=this._jointIndex),e.prototype.blend.call(this,n,r,s)},t.prototype.clone=function(){return new t(this)},t}),define("goo/animationpack/clip/TriggerData",[],function(){function e(){this._currentTriggers=[],this._currentIndex=-1,this.armed=!1}return e.prototype.arm=function(e,t){if(t===null||t.length===0)this._currentTriggers.length=0,this.armed=!1;else if(e!==this._currentIndex){this._currentTriggers.length=0;for(var n=0,r=t.length;n<r;n++)t[n]&&t[n]!==""&&this._currentTriggers.push(t[n]);this.armed=!0}this._currentIndex=e},e}),define("goo/animationpack/components/AnimationComponent",["goo/entities/components/Component","goo/entities/World","goo/animationpack/layer/AnimationLayer","goo/animationpack/clip/JointData","goo/animationpack/clip/TransformData","goo/animationpack/clip/TriggerData"],function(e,t,n,r,i,s){function o(t){e.apply(this,arguments),this.type="AnimationComponent",this.layers=[],this.floats={},this._updateRate=1/60,this._lastUpdate=0,this._triggerCallbacks={};var r=new n(n.BASE_LAYER_NAME);this.layers.push(r),this._skeletonPose=t,this.paused=!1,this.lastTimeOfPause=-1}return o.type="AnimationComponent",o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.transitionTo=function(e,t,n){return this.layers[0].transitionTo(e,undefined,n)?!0:t?this.layers[0].setCurrentStateById(e,!0,undefined,n):!1},o.prototype.getStates=function(){return this.layers[0].getStates()},o.prototype.getCurrentState=function(){return this.layers[0].getCurrentState()},o.prototype.getTransitions=function(){return this.layers[0].getTransitions()},o.prototype.update=function(e){if(this.paused)return;e=typeof e!="undefined"?e:t.time;if(this._updateRate!==0){if(e>this._lastUpdate&&e-this._lastUpdate<this._updateRate)return;this._lastUpdate=e-(e-this._lastUpdate)%this._updateRate}for(var n=0,r=this.layers.length;n<r;n++)this.layers[n].update(e)},o.prototype.apply=function(e){var t=this.getCurrentSourceData(),n=this._skeletonPose;if(t){var o=Object.keys(t);for(var u=0,a=o.length;u<a;u++){var f=o[u],l=t[f];if(l instanceof r)n&&l._jointIndex>=0&&l.applyTo(n._localTransforms[l._jointIndex]);else if(l instanceof i)e&&(l.applyTo(e.transform),e.updateTransform(),this._updateWorldTransform(e));else if(l instanceof s){if(l.armed){for(var u=0,c=l._currentTriggers.length;u<c;u++){var h=this._triggerCallbacks[l._currentTriggers[u]];if(h&&h.length)for(var p=0,d=h.length;p<d;p++)h[p]()}l.armed=!1}}else l instanceof Array&&(this.floats[f]=l[0])}n&&n.updateTransforms()}},o.prototype._updateWorldTransform=function(e){e.updateWorldTransform();for(var t=0;t<e.children.length;t++)this._updateWorldTransform(e.children[t])},o.prototype.postUpdate=function(){for(var e=0,t=this.layers.length;e<t;e++)this.layers[e].postUpdate()},o.prototype.getCurrentSourceData=function(){if(this.layers.length===0)return[];var e=this.layers.length-1;this.layers[0]._layerBlender=null;for(var t=0;t<e;t++)this.layers[t+1].updateLayerBlending(this.layers[t]);return this.layers[e].getCurrentSourceData()},o.prototype.addLayer=function(e,t){isNaN(t)?this.layers.push(e):this.layers.splice(t,0,e)},o.prototype.resetClips=function(e){for(var t=0;t<this.layers.length;t++)this.layers[t].resetClips(e)},o.prototype.shiftClipTime=function(e){for(var t=0;t<this.layers.length;t++)this.layers[t].shiftClipTime(e)},o.prototype.setTimeScale=function(e){for(var t=0;t<this.layers.length;t++)this.layers[t].setTimeScale(e)},o.prototype.pause=function(){this.paused||(this.lastTimeOfPause=t.time,this.paused=!0)},o.prototype.stop=function(){this._skeletonPose&&this._skeletonPose.setToBindPose(),this.paused=!0,this.lastTimeOfPause=-1},o.prototype.resume=function(){if(this.paused||this.lastTimeOfPause===-1)this.lastTimeOfPause===-1?this.resetClips(t.time):this.shiftClipTime(t.time-this.lastTimeOfPause);this.paused=!1},o.prototype.clone=function(){var e=new o;return e.layers=this.layers.map(function(e){return e.clone()}),e},o}),define("goo/animationpack/handlers/AnimationComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/animationpack/components/AnimationComponent","goo/util/rsvp"],function(e,t,n){function r(){e.apply(this,arguments),this._type="AnimationComponent"}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,e._registerClass("animation",r),r.prototype._create=function(){return new t},r.prototype.update=function(t,r,i){var s=this;return e.prototype.update.call(this,t,r,i).then(function(e){if(!e)return;var t=[],o,u=r.poseRef;u&&(o=s._load(u,i).then(function(t){e._skeletonPose=t}),t.push(o));var a=r.layersRef;return a&&(o=s._load(a,i).then(function(t){e.layers=t,e._layersId=a}),t.push(o)),n.all(t).then(function(){return e})})},r}),define("goo/animationpack/clip/AnimationClipInstance",["goo/entities/World"],function(e){function t(){this._active=!0,this._loopCount=0,this._timeScale=1,this._startTime=0,this._prevClockTime=0,this._prevUnscaledClockTime=0,this._clipStateObjects={}}return t.prototype.setTimeScale=function(t,n){n=typeof n!="undefined"?n:e.time;if(this._active&&this._timeScale!==t)if(this._timeScale!==0&&t!==0){var r=n,i=r-this._startTime;i*=this._timeScale,i/=t,this._startTime=r-i}else if(this._timeScale===0){var r=n;this._startTime=r-this._prevUnscaledClockTime}this._timeScale=t},t.prototype.getApplyTo=function(e){var t=e._channelName,n=this._clipStateObjects[t];return n||(n=e.createStateDataObject(),this._clipStateObjects[t]=n),n},t.prototype.clone=function(){var e=new t;return e._active=this._active,e._loopCount=this._loopCount,e._timeScale=this._timeScale,e},t}),define("goo/animationpack/blendtree/ClipSource",["goo/math/MathUtils","goo/animationpack/clip/AnimationClipInstance"],function(e,t){function n(e,n,r){this._clip=e,this._clipInstance=new t,this._filterChannels={},this._filter=null,this.setFilter(n,r),this._startTime=-Infinity,this._endTime=Infinity}return n.prototype.setFilter=function(e,t){if(e&&t){this._filter=["Exclude","Include"].indexOf(e)>-1?e:null;for(var n=0;n<t.length;n++)this._filterChannels[t[n]]=!0}else this._filter=null},n.prototype.setTime=function(t){var n=this._clipInstance;typeof n._startTime!="number"&&(n._startTime=t);var r,i;if(n._active){n._timeScale!==0?(n._prevUnscaledClockTime=t-n._startTime,r=n._timeScale*n._prevUnscaledClockTime,n._prevClockTime=r):r=n._prevClockTime;var s=Math.min(this._clip._maxTime,this._endTime),o=Math.max(this._startTime,0);i=s-o;if(s===-1)return!1;if(s!==0){n._loopCount===-1?r<0?(r*=-1,r%=i,r=i-r,r+=o):(r%=i,r+=o):n._loopCount>0&&i*n._loopCount>=Math.abs(r)&&(r<0?(r*=-1,r%=i,r=i-r,r+=o):(r%=i,r+=o));if(r>s||r<o)r=e.clamp(r,o,s),n._active=!1}this._clip.update(r,n)}return n._active},n.prototype.resetClips=function(e){this._clipInstance._startTime=typeof e!="undefined"?e:0,this._clipInstance._active=!0},n.prototype.shiftClipTime=function(e){this._clipInstance._startTime+=e,this._clipInstance._active=!0},n.prototype.setTimeScale=function(e){this._clipInstance.setTimeScale(e)},n.prototype.isActive=function(){return this._clipInstance._active&&this._clip._maxTime!==-1},n.prototype.getSourceData=function(){if(!this._filter||!this._filterChannels)return this._clipInstance._clipStateObjects;var e=this._clipInstance._clipStateObjects,t={},n=this._filter==="Include";for(var r in e)this._filterChannels[r]!==undefined===n&&(t[r]=e[r]);return t},n.prototype.clone=function(){var e=new n(this._clip);e._clipInstance=this._clipInstance.clone(),e._filter=this._filter;for(var t in this._filterChannels)e._filterChannels[t]=this._filterChannels[t];return e._startTime=this._startTime,e._endTime=this._endTime,e},n}),define("goo/animationpack/clip/AbstractAnimationChannel",[],function(){function e(e,t,n){this._blendType=n||"Linear",this._channelName=e,(t instanceof Array||t instanceof Float32Array)&&t.length?this._times=new Float32Array(t):this._times=[],this._lastStartFrame=0}return e.prototype.getSampleCount=function(){return this._times.length},e.prototype.getMaxTime=function(){return this._times.length?this._times[this._times.length-1]:0},e.prototype.updateSample=function(e,t){var n=this._times.length;if(!n)return;var r=n-1;if(e<0||n===1)this.setCurrentSample(0,0,t);else if(e>=this._times[r])this.setCurrentSample(r,0,t);else{var i=0;if(e>=this._times[this._lastStartFrame]){i=this._lastStartFrame;for(var s=this._lastStartFrame;s<n-1;s++){if(this._times[s]>=e)break;i=s}}else for(var s=0;s<this._lastStartFrame;s++){if(this._times[s]>=e)break;i=s}var o=(e-this._times[i])/(this._times[i+1]-this._times[i]);this.setCurrentSample(i,o,t),this._lastStartFrame=i}},e}),define("goo/animationpack/clip/TransformChannel",["goo/animationpack/clip/AbstractAnimationChannel","goo/animationpack/clip/TransformData","goo/math/Quaternion"],function(e,t,n){function r(t,n,r,i,s,o){e.call(this,t,n,o);if(r.length/4!==n.length||i.length/3!==n.length||s.length/3!==n.length)throw new Error("All provided arrays must be the same length (accounting for type)! Channel: "+t);this._rotations=new Float32Array(r),this._translations=new Float32Array(i),this._scales=new Float32Array(s)}var i=new n,s=new n;return r.prototype=Object.create(e.prototype),r.prototype.createStateDataObject=function(){return new t},r.prototype.setCurrentSample=function(e,t,r){var o=r,u=e*4,a=e*3,f=(e+1)*4,l=(e+1)*3;if(t===0){o._rotation.data[0]=this._rotations[u+0],o._rotation.data[1]=this._rotations[u+1],o._rotation.data[2]=this._rotations[u+2],o._rotation.data[3]=this._rotations[u+3],o._translation.data[0]=this._translations[a+0],o._translation.data[1]=this._translations[a+1],o._translation.data[2]=this._translations[a+2],o._scale.data[0]=this._scales[a+0],o._scale.data[1]=this._scales[a+1],o._scale.data[2]=this._scales[a+2];return}if(t===1){o._rotation.data[0]=this._rotations[f+0],o._rotation.data[1]=this._rotations[f+1],o._rotation.data[2]=this._rotations[f+2],o._rotation.data[3]=this._rotations[f+3],o._translation.data[0]=this._translations[l+0],o._translation.data[1]=this._translations[l+1],o._translation.data[2]=this._translations[l+2],o._scale.data[0]=this._scales[l+0],o._scale.data[1]=this._scales[l+1],o._scale.data[2]=this._scales[l+2];return}o._rotation.data[0]=this._rotations[u+0],o._rotation.data[1]=this._rotations[u+1],o._rotation.data[2]=this._rotations[u+2],o._rotation.data[3]=this._rotations[u+3],i.data[0]=this._rotations[f+0],i.data[1]=this._rotations[f+1],i.data[2]=this._rotations[f+2],i.data[3]=this._rotations[f+3],o._rotation.equals(i)||(n.slerp(o._rotation,i,t,s),o._rotation.setVector(s)),o._translation.data[0]=(1-t)*this._translations[a+0]+t*this._translations[l+0],o._translation.data[1]=(1-t)*this._translations[a+1]+t*this._translations[l+1],o._translation.data[2]=(1-t)*this._translations[a+2]+t*this._translations[l+2],o._scale.data[0]=(1-t)*this._scales[a+0]+t*this._scales[l+0],o._scale.data[1]=(1-t)*this._scales[a+1]+t*this._scales[l+1],o._scale.data[2]=(1-t)*this._scales[a+2]+t*this._scales[l+2]},r.prototype.getData=function(e,n){var r=n?n:new t;return this.setCurrentSample(e,0,r),r},r}),define("goo/animationpack/clip/JointChannel",["goo/animationpack/clip/TransformChannel","goo/animationpack/clip/JointData"],function(e,t){function n(t,n,r,i,s,o,u){e.call(this,n,r,i,s,o,u),this._jointName=n,this._jointIndex=t}return n.prototype=Object.create(e.prototype),n.JOINT_CHANNEL_NAME="_jnt",n.prototype.createStateDataObject=function(){return new t},n.prototype.setCurrentSample=function(t,n,r){e.prototype.setCurrentSample.call(this,t,n,r),r._jointIndex=this._jointIndex},n.prototype.getData=function(n,r){var i=r?r:new t;return e.prototype.getData.call(this,n,i),i._jointIndex=this._jointIndex,i},n}),define("goo/animationpack/blendtree/ManagedTransformSource",["goo/animationpack/clip/JointChannel","goo/animationpack/clip/JointData","goo/animationpack/clip/JointChannel","goo/animationpack/clip/JointData","goo/math/Vector3","goo/math/Quaternion"],function(e,t,n,r,i,s){function o(e){this._sourceName=e?e:null,this._data={}}return o.prototype.setTranslation=function(e,t){var n=this._data[e];n instanceof r&&n._translation.setVector(t)},o.prototype.getTranslation=function(e,t){var n=this._data[e];return n instanceof r&&(t=t||new i,t.setVector(n._translation)),t},o.prototype.setScale=function(e,t){var n=this._data[e];n instanceof r&&n._scale.setVector(t)},o.prototype.getScale=function(e,t){var n=this._data[e];return n instanceof r&&(t=t||new i,t.setVector(n._scale)),t},o.prototype.setRotation=function(e,t){var n=this._data[e];n instanceof r&&n._rotation.set(t)},o.prototype.getRotation=function(e,t){var n=this._data[e];return n instanceof r&&(t=t||new s,t.setVector(n._rotation)),t},o.prototype.initFromClip=function(e,t,n){if(t==="Include"&&n&&n.length)for(var r=0,i=n.length;r<i;r++){var s=n[r],o=e.findChannelByName(s);if(o){var u=o.getData(0);this._data[s]=u}else console.error("Channel not in clip: "+s)}else for(var r=0,i=e._channels.length;r<i;r++){var o=e._channels[r],s=o._channelName;if(t==="Exclude"&&n&&n.length&&n.indexOf(s)>-1){var u=o.getData(0);this._data[s]=u}}},o.prototype.resetClips=function(){},o.prototype.setTimeScale=function(){},o.prototype.setTime=function(){return!0},o.prototype.isActive=function(){return!0},o.prototype.getChannelData=function(e){return this._data[e]},o.prototype.getSourceData=function(){return this._data},o.prototype.clone=function(){var e={};for(var t in this._data)e[t]=this._data[t].clone();return new o(this._sourceName,e)},o}),define("goo/animationpack/blendtree/FrozenClipSource",[],function(){function e(e,t){this._source=e,this._time=t}return e.prototype.getSourceData=function(){return this._source.getSourceData()},e.prototype.resetClips=function(){this._source.resetClips(0)},e.prototype.setTime=function(){return this._source.setTime(this._time),!0},e.prototype.isActive=function(){return!0},e.prototype.setTimeScale=function(){},e.prototype.clone=function(){var t=new e(this._source.clone(),this._time);return t},e}),define("goo/animationpack/handlers/AnimationStateHandler",["goo/loaders/handlers/ConfigHandler","goo/animationpack/state/SteadyState","goo/animationpack/blendtree/ClipSource","goo/animationpack/blendtree/ManagedTransformSource","goo/animationpack/blendtree/BinaryLERPSource","goo/animationpack/blendtree/FrozenClipSource","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o,u,a){function f(){e.apply(this,arguments)}return f.prototype=Object.create(e.prototype),f.prototype.constructor=f,e._registerClass("animstate",f),f.prototype._create=function(e){var n=new t;return this._objects.set(e,n),n},f.prototype._update=function(t,n,r){var i=this;return e.prototype._update.call(this,t,n,r).then(function(e){if(!e)return;return e._name=n.name,e.id=n.id,e._transitions=a.deepClone(n.transitions),i._parseClipSource(n.clipSource,e._sourceTree,r).then(function(t){return e._sourceTree=t,e})})},f.prototype._parseClipSource=function(e,t,a){switch(e.type){case"Clip":return this.loadObject(e.clipRef,a).then(function(r){!t||!t instanceof n?t=new n(r,e.filter,e.channels):(t._clip=r,t.setFilter(e.filter,e.channels)),e.loopCount!==undefined&&(t._clipInstance._loopCount=+e.loopCount),e.timeScale!==undefined&&(t._clipInstance._timeScale=e.timeScale),t._startTime=e.startTime||0;var i=Infinity;for(var s=0;s<r._channels.length;s++){var o=r._channels[s];for(var u=0;u<o._times.length;u++){var a=o._times[u];a<i&&(i=a)}}return t._startTime=Math.max(t._startTime,i),t});case"Managed":if(!t||!t instanceof r)t=new r;return e.clipRef?this.loadObject(e.clipRef,a).then(function(n){return t.initFromClip(n,e.filter,e.channels),t}):u.resolve(t);case"Lerp":var f=[this._parseClipSource(e.clipSourceA,null,a),this._parseClipSource(e.clipSourceB,null,a)];return o.all(f).then(function(n){return t=new i(n[0],n[1]),e.blendWeight&&(t.blendWeight=e.blendWeight),t});case"Frozen":return this._parseClipSource(e.clipSource).then(function(n){return!!t&&t instanceof s?(t._source=n,t._time=e.frozenTime||0):t=new s(n,e.frozenTime||0),t});default:return console.error("Unable to parse clip source"),u.resolve()}},f}),define("goo/animationpack/handlers/AnimationLayersHandler",["goo/loaders/handlers/ConfigHandler","goo/animationpack/layer/AnimationLayer","goo/animationpack/layer/LayerLERPBlender","goo/animationpack/state/FadeTransitionState","goo/animationpack/state/SyncFadeTransitionState","goo/animationpack/state/FrozenTransitionState","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o,u,a){function f(){e.apply(this,arguments)}return f.prototype=Object.create(e.prototype),f.prototype.constructor=f,e._registerClass("animation",f),f.prototype._create=function(e){var t=[];return this._objects.set(e,t),t},f.prototype._setInitialState=function(e,t){if(t){var n=e.getStateById(t);e._currentState!==n&&e.setCurrentStateById(t,!0)}else e.setCurrentState()},f.prototype._update=function(t,n,r){var i=this;return e.prototype._update.call(this,t,n,r).then(function(e){if(!e)return;var t=[],s=0;return a.forEach(n.layers,function(n){t.push(i._parseLayer(n,e[s++],r))},null,"sortValue"),o.all(t).then(function(t){e.length=t.length;for(var n=0;n<t.length;n++)e[n]=t[n];return e})})},f.prototype._parseLayer=function(e,n,r){var i=this;n?n._name=e.name:n=new t(e.name),n.id=e.id,n._transitions=a.deepClone(e.transitions),n._layerBlender&&(e.blendWeight!==undefined?n._layerBlender._blendWeight=e.blendWeight:n._layerBlender._blendWeight=1);var s=[];return a.forEach(e.states,function(e){s.push(i.loadObject(e.stateRef,r).then(function(e){n.setState(e.id,e)}))},null,"sortValue"),o.all(s).then(function(){return i._setInitialState(n,e.initialStateRef),n})},f}),define("goo/animationpack/clip/AnimationClip",[],function(){function e(e,t){this._name=e,this._channels=t||[],this._maxTime=-1,this.updateMaxTimeIndex()}return e.prototype.update=function(e,t){for(var n=0,r=this._channels.length;n<r;++n){var i=this._channels[n],s=t.getApplyTo(i);i.updateSample(e,s)}},e.prototype.addChannel=function(e){this._channels.push(e),this.updateMaxTimeIndex()},e.prototype.removeChannel=function(e){var t=this._channels.indexOf(e);return t>=0?(this._channels.splice(t,1),this.updateMaxTimeIndex(),!0):!1},e.prototype.findChannelByName=function(e){for(var t=0,n=this._channels.length;t<n;++t){var r=this._channels[t];if(e===r._channelName)return r}return null},e.prototype.updateMaxTimeIndex=function(){this._maxTime=-1;var e;for(var t=0;t<this._channels.length;t++){var n=this._channels[t];e=n.getMaxTime(),e>this._maxTime&&(this._maxTime=e)}},e.prototype.toString=function(){return this._name+": "+this._channels.map(function(e){return e._channelName})},e}),define("goo/animationpack/clip/InterpolatedFloatChannel",["goo/animationpack/clip/AbstractAnimationChannel","goo/math/MathUtils"],function(e,t){function n(t,n,r,i){e.call(this,t,n,i),this._values=r?r.slice(0):null}return n.prototype=Object.create(e.prototype),n.prototype.createStateDataObject=function(){return[0]},n.prototype.setCurrentSample=function(e,n,r){r[0]=t.lerp(n,this._values[e],this._values[e+1])},n.prototype.getData=function(e,t){var n=t||[];return n[0]=this._values[e],n},n}),define("goo/animationpack/clip/TriggerChannel",["goo/animationpack/clip/AbstractAnimationChannel","goo/animationpack/clip/TriggerData"],function(e,t){function n(t,n,r,i){e.call(this,t,n,i),this._keys=r?r.slice(0):null,this.guarantee=!1}return n.prototype=Object.create(e.prototype),n.prototype.createStateDataObject=function(){return new t},n.prototype.setCurrentSample=function(e,t,n){var r=n._currentIndex,i=t!==1?e:e+1;if(r===i||!this.guarantee)n.arm(i,[this._keys[i]]);else{var s=[];if(r>i){for(var o=r+1;o<this._keys.length;o++)s.push(this._keys[o]);r=-1}for(var o=r+1;o<=i;o++)s.push(this._keys[o]);n.arm(i,s)}},n}),define("goo/animationpack/handlers/AnimationClipHandler",["goo/loaders/handlers/ConfigHandler","goo/animationpack/clip/AnimationClip","goo/animationpack/clip/JointChannel","goo/animationpack/clip/TransformChannel","goo/animationpack/clip/InterpolatedFloatChannel","goo/animationpack/clip/TriggerChannel","goo/util/PromiseUtil","goo/util/ArrayUtil"],function(e,t,n,r,i,s,o,u){function a(){e.apply(this,arguments)}return a.prototype=Object.create(e.prototype),a.prototype.constructor=a,e._registerClass("clip",a),a.prototype._create=function(){return new t},a.prototype._update=function(t,n,r){var i=this;return e.prototype._update.call(this,t,n,r).then(function(e){return e?i.loadObject(n.binaryRef,r).then(function(t){if(!t)throw new Error("Binary clip data was empty");return i._updateAnimationClip(n,t,e)}):e})},a.prototype._updateAnimationClip=function(e,t,o){o._channels=[];if(e.channels){var a=Object.keys(e.channels);for(var f=0;f<a.length;f++){var l=e.channels[a[f]],c=u.getTypedArray(t,l.times),h=l.blendType,p=l.type,d;switch(p){case"Joint":case"Transform":var v,m,g;v=u.getTypedArray(t,l.rotationSamples),m=u.getTypedArray(t,l.translationSamples),g=u.getTypedArray(t,l.scaleSamples),p==="Joint"?d=new n(l.jointIndex,l.name,c,v,m,g,h):d=new r(l.name,c,v,m,g,h);break;case"FloatLERP":d=new i(l.name,c,l.values,h);break;case"Trigger":d=new s(l.name,c,l.keys),d.guarantee=!!l.guarantee;break;default:console.warn("Unhandled channel type: "+l.type);continue}o.addChannel(d)}}return o},a}),define("goo/renderer/pass/RenderPass",["goo/renderer/Renderer","goo/renderer/pass/Pass","goo/math/Vector4"],function(e,t,n){function r(e,t){this.renderList=e,this.filter=t,this.clearColor=new n(0,0,0,0),this.oldClearColor=new n,this.renderToScreen=!1,this.overrideMaterial=null,this.enabled=!0,this.clear=!0,this.needsSwap=!1,this.viewportSize=undefined}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.render=function(t,n,r,i,s,o,u,a){o=o||e.mainCamera;if(!o)return;u=u||[],a&&!1&&(this.oldClearColor.setVector(t.clearColor),t.setClearColor(a[0],a[1],a[2],a[3]));var f;this.filter?f=this.renderList.filter(this.filter):f=this.renderList,this.renderToScreen?t.render(f,o,u,null,this.clear,this.overrideMaterial):t.render(f,o,u,r,this.clear,this.overrideMaterial);if(this.clearColor&&!1){var l=this.oldClearColor.data;t.setClearColor(l[0],l[1],l[2],l[3])}},r}),define("goo/passpack/ShaderLibExtra",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderBuilder","goo/renderer/Util","goo/renderer/shaders/ShaderLib","goo/entities/World"],function(e,t,n,r,i,s,o){function u(){}return u.billboard={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,viewMatrix:t.VIEW_MATRIX,worldMatrix:t.WORLD_MATRIX,diffuseMap:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(0.0, 0.0, 0.0, 1.0) + projectionMatrix * vec4(vertexPosition.x, vertexPosition.y, 0.0, 0.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},u.showDepth={attributes:{vertexPosition:e.POSITION},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,near:t.NEAR_PLANE,far:t.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform float near;","uniform float far;","void main(void)","{","float depth = gl_FragCoord.z / gl_FragCoord.w;","float d = 1.0 - smoothstep( near, far, depth );","gl_FragColor = vec4(d);","}"].join("\n")},u.bokehShader={attributes:{position:e.POSITION,uv:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tColor:t.DIFFUSE_MAP,tDepth:t.DEPTH_MAP,focus:1,aspect:1,aperture:.025,maxblur:1},vshader:["attribute vec3 position;","attribute vec2 uv;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","	vUv = uv;","	gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( position, 1.0 );","}"].join("\n"),fshader:["varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float maxblur;","uniform float aperture;","uniform float focus;","uniform float aspect;","void main() {","vec2 aspectcorrect = vec2( 1.0, aspect );","vec4 depth1 = texture2D( tDepth, vUv );","float factor = depth1.x - focus;","vec2 dofblur = vec2 ( clamp( factor * aperture, -maxblur, maxblur ) );","vec2 dofblur9 = dofblur * 0.9;","vec2 dofblur7 = dofblur * 0.7;","vec2 dofblur4 = dofblur * 0.4;","vec4 col = vec4( 0.0 );","col += texture2D( tColor, vUv.xy );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur4 );","gl_FragColor = col / 41.0;","gl_FragColor.a = 1.0;","}"].join("\n")},u.sepia={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,amount:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float amount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color = texture2D(tDiffuse, vUv );","vec3 c = color.rgb;","color.r = dot(c, vec3(1.0 - 0.607 * amount, 0.769 * amount, 0.189 * amount));","color.g = dot(c, vec3(0.349 * amount, 1.0 - 0.314 * amount, 0.168 * amount));","color.b = dot(c, vec3(0.272 * amount, 0.534 * amount, 1.0 - 0.869 * amount));","gl_FragColor = vec4(min(vec3(1.0), color.rgb), color.a);","}"].join("\n")},u.dotscreen={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,tSize:[256,256],center:[.5,.5],angle:1.57,scale:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( color.rgb * vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},u.vignette={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,offset:1,darkness:1.5},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float offset;","uniform float darkness;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );","gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );","}"].join("\n")},u.film={attributes:s.copy.attributes,uniforms:{tDiffuse:t.DIFFUSE_MAP,time:function(){return o.time},nIntensity:.5,sIntensity:.5,sCount:1024,grayscale:0,$link:s.copy.uniforms},vshader:s.copy.vshader,fshader:["uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform float sIntensity;","uniform float sCount;","uniform sampler2D tDiffuse;","varying vec2 texCoord0;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, texCoord0 );","float x = texCoord0.x * texCoord0.y * time * 1000.0;","x = mod( x, 13.0 ) * mod( x, 123.0 );","float dx = mod( x, 0.01 );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx * 100.0, 0.0, 1.0 );","vec2 sc = vec2( sin( texCoord0.y * sCount ), cos( texCoord0.y * sCount ) );","cResult += cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * sIntensity;","cResult = cTextureScreen.rgb + nIntensity * ( cResult - cTextureScreen.rgb );","if( grayscale ) {","	cResult = vec3( cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11 );","}","gl_FragColor = vec4( cResult, cTextureScreen.a );","}"].join("\n")},u.noise={attributes:s.copy.attributes,uniforms:{tDiffuse:t.DIFFUSE_MAP,time:function(){return o.time},nIntensity:.5,grayscale:0,$link:s.copy.uniforms},vshader:s.copy.vshader,fshader:["uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform sampler2D tDiffuse;","varying vec2 texCoord0;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, texCoord0);","float x = texCoord0.x * texCoord0.y * time * 1000.0;","vec3 cResult;","if ( !grayscale ) {","float y = fract(sin(dot(vec2(mod( x + 20.0, 87.0 ), mod( x + 150.0, 23.0 )), vec2(12.9898,78.233))) * 43758.5453);","float z = fract(sin(dot(vec2(mod( x + 30.0, 19.0 ), mod( x + 200.0, 103.0 )), vec2(12.9898,78.233))) * 43758.5453);","x = fract(sin(dot(vec2(mod( x, 13.0 ), mod( x + 50.0, 123.0 )), vec2(12.9898,78.233))) * 43758.5453);","cResult = vec3(x, y, z);","} else {","x = fract(sin(dot(vec2(mod( x, 13.0 ), mod( x + 50.0, 123.0 )), vec2(12.9898,78.233))) * 43758.5453);","cResult = vec3(x);","}","gl_FragColor = vec4( mix(cTextureScreen.rgb, cResult, nIntensity), cTextureScreen.a );","}"].join("\n")},u.bleachbypass={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,opacity:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 base = texture2D( tDiffuse, vUv );","vec3 lumCoeff = vec3( 0.25, 0.65, 0.1 );","float lum = dot( lumCoeff, base.rgb );","vec3 blend = vec3( lum );","float L = min( 1.0, max( 0.0, 10.0 * ( lum - 0.45 ) ) );","vec3 result1 = 2.0 * base.rgb * blend;","vec3 result2 = 1.0 - 2.0 * ( 1.0 - blend ) * ( 1.0 - base.rgb );","vec3 newColor = mix( result1, result2, L );","float A2 = opacity * base.a;","vec3 mixRGB = A2 * newColor.rgb;","mixRGB += ( ( 1.0 - A2 ) * base.rgb );","gl_FragColor = vec4( mixRGB, base.a );","}"].join("\n")},u.horizontalTiltShift={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,h:1/128,r:.5},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float h;","uniform float r;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float hh = h * abs( r - vUv.y );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * hh, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x,            vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * hh, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},u.colorify={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,color:[1,1,1],amount:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform vec3 color;","uniform float amount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( gl_FragColor.rgb, luma );","gl_FragColor.rgb = mix(gl_FragColor.rgb, v * color, amount);","}"].join("\n")},u.hatch={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,width:0,spread:10,replace:!0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float width;","uniform float spread;","uniform bool replace;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","float lum = length(gl_FragColor.rgb);","vec3 mult = vec3(1.0, 1.0, 1.0);","float halfSpread = (spread*0.5);","if (lum < 1.00) {","float diff = abs(mod(gl_FragCoord.x + gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (lum < 0.75) {","float diff = abs(mod(gl_FragCoord.x - gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (lum < 0.50) {","float diff = abs(mod(gl_FragCoord.x + halfSpread + gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (lum < 0.25) {","float diff = abs(mod(gl_FragCoord.x + halfSpread - gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (replace) {","gl_FragColor.rgb = mult;","} else {","gl_FragColor.rgb *= mult;","}","}"].join("\n")},u.ssao={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,tDepth:t.DEPTH_MAP,size:[512,512],cameraNear:t.MAIN_NEAR_PLANE,cameraFar:t.MAIN_FAR_PLANE,fogNear:t.MAIN_NEAR_PLANE,fogFar:t.MAIN_FAR_PLANE,fogEnabled:0,onlyAO:0,aoClamp:.3,lumInfluence:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float cameraNear;","uniform float cameraFar;","uniform float fogNear;","uniform float fogFar;","uniform bool fogEnabled;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","const int samples = 16;","const float radius = 2.0;","const bool useNoise = false;","const float noiseAmount = 0.0003;","const float diffArea = 0.4;","const float gDisplace = 0.4;","const vec3 onlyAOColor = vec3( 1.0, 1.0, 1.0 );","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float doFog() {","float zdepth = unpackDepth( texture2D( tDepth, vUv ) );","float depth = -cameraFar * cameraNear / ( zdepth * cameraFarMinusNear - cameraFar );","return smoothstep( fogNear, fogFar, depth );","}","float readDepth( const in vec2 coord ) {","return cameraCoef / ( cameraFarPlusNear - unpackDepth( texture2D( tDepth, coord ) ) * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 2.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw;","float ph;","float ao;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","if ( fogEnabled ) {","ao = mix( ao, 1.0, doFog() );","}","vec3 color = texture2D( tDiffuse, vUv ).rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = onlyAOColor * vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, 1.0 );","}"].join("\n")},u.skinning={defines:{JOINT_COUNT:56,WEIGHTS:4},attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0,vertexWeights:e.WEIGHTS,vertexJointIDs:e.JOINTIDS},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,diffuseMap:t.DIFFUSE_MAP,jointPalette:function(e){var t=e.meshData,n=t.currentPose;if(n){var r=n._matrixPalette,i=t.paletteMap.length*16,s=t.store;s||(s=new Float32Array(i),t.store=s);var o;for(var u=0;u<t.paletteMap.length;u++){o=r[t.paletteMap[u]];for(var a=0;a<4;a++)for(var f=0;f<4;f++)s[u*16+a*4+f]=o.data[f*4+a]}return s}}},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","attribute vec4 vertexWeights;","attribute vec4 vertexJointIDs;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 jointPalette[JOINT_COUNT];","varying vec2 texCoord0;","void main(void) {","mat4 mat = mat4(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);","mat += jointPalette[int(vertexJointIDs.x)] * vertexWeights.x;","mat += jointPalette[int(vertexJointIDs.y)] * vertexWeights.y;","mat += jointPalette[int(vertexJointIDs.z)] * vertexWeights.z;","mat += jointPalette[int(vertexJointIDs.w)] * vertexWeights.w;","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * mat * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},u.rgbshift={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,amount:.005,angle:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","}"].join("\n")},u.brightnesscontrast={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,brightness:0,contrast:0,saturation:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float brightness;","uniform float contrast;","uniform float saturation;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","gl_FragColor.rgb += brightness;","if (contrast > 0.0) {","gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - contrast) + 0.5;","} else {","gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + contrast) + 0.5;","}","vec3 gray = vec3(dot(vec3(0.2126,0.7152,0.0722), gl_FragColor.rgb));","gl_FragColor.rgb = mix(gl_FragColor.rgb, gray, -saturation);","}"].join("\n")},u.hsb={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,hue:0,saturation:0,brightness:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float hue;","uniform float saturation;","uniform float brightness;","varying vec2 vUv;",n.methods.hsv,"void main() {","gl_FragColor = texture2D(tDiffuse, vUv);","vec3 fragHSV = rgb2hsv(gl_FragColor.rgb).xyz;","fragHSV.x += hue * 0.5;","fragHSV.y *= saturation + 1.0 - max(brightness, 0.0) * 2.0;","fragHSV.z *= min(brightness + 1.0, 1.0);","fragHSV.z += max(brightness, 0.0);","fragHSV.xyz = clamp(fragHSV.xyz, vec3(-10.0, 0.0, 0.0), vec3(10.0, 1.0, 1.0));","gl_FragColor.rgb = hsv2rgb(fragHSV);","}"].join("\n")},u.luminosity={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","gl_FragColor = vec4( v, v, v, texel.w );","}"].join("\n")},u.toon={attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,cameraPosition:t.CAMERA,lightPosition:t.LIGHT0,HighlightColor:[.9,.8,.7,1],MidColor:[.65,.55,.45,1],ShadowColor:[.4,.3,.2,1],HighlightSize:.2,ShadowSize:.01,OutlineWidth:.15},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform vec3 lightPosition;","varying vec3 N;","varying vec3 V;","varying vec3 L;","void main() {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","N = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","L = lightPosition - worldPos.xyz;","V = cameraPosition - worldPos.xyz;","gl_Position = projectionMatrix * viewMatrix * worldPos;","}"].join("\n"),fshader:["uniform vec4 HighlightColor;","uniform vec4 MidColor;","uniform vec4 ShadowColor;","uniform float HighlightSize;","uniform float ShadowSize;","uniform float OutlineWidth;","varying vec3 N;","varying vec3 L;","varying vec3 V;","void main() {","vec3 n = normalize(N);","vec3 l = normalize(L);","vec3 v = normalize(V);","float lambert = dot(l,n);","vec4 color = MidColor;","if (lambert > 1.0 - HighlightSize) color = HighlightColor;","if (lambert < ShadowSize) color = ShadowColor;","if (dot(n,v) < OutlineWidth) color = vec4(0.0,0.0,0.0,1.0);","gl_FragColor = color;","}"].join("\n")},u.differenceOfGaussians={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,gaussBlurredImage1:"BLUR1",gaussBlurredImage2:"BLUR2",originalImage:"ORIGINAL",threshold:.01,edgeColor:[1,0,1,1],backgroundColor:[0,0,0,1],backgroundMix:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D gaussBlurredImage1;","uniform sampler2D gaussBlurredImage2;","uniform sampler2D originalImage;","uniform float threshold;","uniform float backgroundMix;","uniform vec4 edgeColor;","uniform vec4 backgroundColor;","varying vec2 texCoord0;","void main(void)","{","vec4 blur1 = texture2D(gaussBlurredImage1, texCoord0);","vec4 blur2 = texture2D(gaussBlurredImage2, texCoord0);","vec4 originalColor = texture2D(originalImage, texCoord0);","vec3 nonEdgeColor = mix(originalColor.rgb, backgroundColor.rgb, backgroundMix);","vec3 diffColor = abs(blur1.rgb - blur2.rgb);","float edgeValue = (diffColor.r + diffColor.g + diffColor.b) / 3.0;","edgeValue = smoothstep(0.0, threshold, edgeValue);","vec3 outputColor = mix(nonEdgeColor, edgeColor.rgb, edgeValue);","gl_FragColor = vec4(outputColor, 1.0);","}"].join("\n")},u.overlay={defines:{OVERLAY_TYPE:0},processors:[function(e,t){var n=t.material._textureMaps.OVERLAY_MAP;if(n){e.setDefine("OVERLAY_MAP",!0);var r=e.uniforms.offsetRepeat;r[0]=n.offset.data[0],r[1]=n.offset.data[1],r[2]=n.repeat.data[0],r[3]=n.repeat.data[1]}else e.removeDefine("OVERLAY_MAP")}],attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,tDiffuse2:"OVERLAY_MAP",offsetRepeat:[0,0,1,1],amount:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:[n.blendmodes,"#define Mixin(base, blend, type, a)	mix(base, type(base, blend), a);","uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform float amount;","#ifdef OVERLAY_MAP","uniform vec4 offsetRepeat;","#endif","varying vec2 vUv;","void main() {","gl_FragColor = texture2D(tDiffuse, vUv);","#ifdef OVERLAY_MAP","vec2 oUv = vUv * offsetRepeat.zw + offsetRepeat.xy;","vec4 blendTexture = texture2D(tDiffuse2, oUv);","float a = amount * blendTexture.a;","#endif","#if !defined(OVERLAY_MAP)","#elif OVERLAY_TYPE == 0","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendNormal, a);","#elif OVERLAY_TYPE == 1","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendLighten, a);","#elif OVERLAY_TYPE == 2","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendDarken, a);","#elif OVERLAY_TYPE == 3","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendMultiply, a);","#elif OVERLAY_TYPE == 4","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendAverage, a);","#elif OVERLAY_TYPE == 5","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendAdd, a);","#elif OVERLAY_TYPE == 6","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendSubstract, a);","#elif OVERLAY_TYPE == 7","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendDifference, a);","#elif OVERLAY_TYPE == 8","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendNegation, a);","#elif OVERLAY_TYPE == 9","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendExclusion, a);","#elif OVERLAY_TYPE == 10","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendScreen, a);","#elif OVERLAY_TYPE == 11","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendOverlay, a);","#elif OVERLAY_TYPE == 12","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendSoftLight, a);","#elif OVERLAY_TYPE == 13","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendHardLight, a);","#elif OVERLAY_TYPE == 14","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendColorDodge, a);","#elif OVERLAY_TYPE == 15","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendColorBurn, a);","#elif OVERLAY_TYPE == 16","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendLinearLight, a);","#elif OVERLAY_TYPE == 17","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendVividLight, a);","#elif OVERLAY_TYPE == 18","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendPinLight, a);","#elif OVERLAY_TYPE == 19","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendHardMix, a);","#elif OVERLAY_TYPE == 20","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendReflect, a);","#elif OVERLAY_TYPE == 21","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendGlow, a);","#elif OVERLAY_TYPE == 22","gl_FragColor.rgb = Mixin(gl_FragColor.rgb, blendTexture.rgb, BlendPhoenix, a);","#endif","}"].join("\n")},u.levels={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,gamma:1,minInput:0,maxInput:1,minOutput:0,maxOutput:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:[n.blendmodes,"uniform sampler2D tDiffuse;","uniform float gamma;","uniform float minInput;","uniform float maxInput;","uniform float minOutput;","uniform float maxOutput;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","gl_FragColor.rgb = LevelsControl(gl_FragColor.rgb, minInput, gamma, maxInput, minOutput, maxOutput);","}"].join("\n")},u.boxfilter={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,viewport:[128,128]},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform vec2 viewport;","varying vec2 vUv;","void main() {","vec3 result = vec3(0.0);","for(int x=-1; x<=1; x++) {","for(int y=-1; y<=1; y++) {","result += texture2D(tDiffuse, vUv + vec2(x, y) / viewport).rgb;","}","}","gl_FragColor = vec4(result / vec3(9.0), 1.0);","}"].join("\n")},u.radial={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,frameBufSize:t.RESOLUTION,offset:.5,multiplier:-0.75},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoords;","void main() {","texCoords = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform vec2 frameBufSize;","uniform float offset;","uniform float multiplier;","varying vec2 texCoords;","void main() {","vec2 uv = texCoords - 0.5;","vec3 o = texture2D(tDiffuse, 0.5 + (uv.xy *= 0.992)).rgb;","float z = 0.0;","for (float i = 0.0; i < 50.0; i++) {","vec3 T = texture2D(tDiffuse, 0.5 + (uv.xy *= 0.992)).rgb;","z += pow(max(0.0, offset + length(T) * multiplier), 2.0) * exp(-i * 0.08);","}","gl_FragColor = vec4(o*o + z, 1.0);","}"].join("\n")},u.packDepth={attributes:{vertexPosition:e.POSITION},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,farPlane:t.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 vPosition;","void main(void) {","vPosition = viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fshader:["uniform float farPlane;",n.methods.packDepth,"varying vec4 vPosition;","void main(void)","{","float linearDepth = min(length(vPosition), farPlane) / farPlane;","gl_FragColor = packDepth(linearDepth);","}"].join("\n")},u.antialias={attributes:{vertexPosition:e.POSITION,vertexUV0:e.TEXCOORD0},uniforms:{viewMatrix:t.VIEW_MATRIX,projectionMatrix:t.PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,tDiffuse:t.DIFFUSE_MAP,frameBufSize:t.RESOLUTION,FXAA_SPAN_MAX:8,FXAA_REDUCE_MUL:1/8},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoords;","void main() {","texCoords = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform vec2 frameBufSize;","uniform float FXAA_SPAN_MAX;","uniform float FXAA_REDUCE_MUL;","varying vec2 texCoords;","void main() {","float FXAA_REDUCE_MIN = 1.0/128.0;","vec3 rgbNW = texture2D(tDiffuse, texCoords + (vec2(-1.0, -1.0) / frameBufSize)).xyz;","vec3 rgbNE = texture2D(tDiffuse, texCoords + (vec2(1.0, -1.0) / frameBufSize)).xyz;","vec3 rgbSW = texture2D(tDiffuse, texCoords + (vec2(-1.0, 1.0) / frameBufSize)).xyz;","vec3 rgbSE = texture2D(tDiffuse, texCoords + (vec2(1.0, 1.0) / frameBufSize)).xyz;","vec3 rgbM = texture2D(tDiffuse, texCoords).xyz;","vec3 luma=vec3(0.299, 0.587, 0.114);","float lumaNW = dot(rgbNW, luma);","float lumaNE = dot(rgbNE, luma);","float lumaSW = dot(rgbSW, luma);","float lumaSE = dot(rgbSE, luma);","float lumaM  = dot(rgbM,  luma);","float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));","float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max(","		(lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),","		FXAA_REDUCE_MIN);","float rcpDirMin = 1.0/(min(abs(dir.x), abs(dir.y)) + dirReduce);","dir = min(vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","		  max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","		  dir * rcpDirMin)) / frameBufSize;","vec3 rgbA = (1.0/2.0) * (","		texture2D(tDiffuse, texCoords.xy + dir * (1.0/3.0 - 0.5)).xyz +","		texture2D(tDiffuse, texCoords.xy + dir * (2.0/3.0 - 0.5)).xyz);","vec3 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","		texture2D(tDiffuse, texCoords.xy + dir * (0.0/3.0 - 0.5)).xyz +","		texture2D(tDiffuse, texCoords.xy + dir * (3.0/3.0 - 0.5)).xyz);","float lumaB = dot(rgbB, luma);","if ((lumaB < lumaMin) || (lumaB > lumaMax)) {","		gl_FragColor.xyz=rgbA;","} else{","		gl_FragColor.xyz=rgbB;","}","}"].join("\n")},u}),define("goo/passpack/BloomPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/util/ObjectUtil","goo/renderer/shaders/ShaderLib","goo/passpack/ShaderLibExtra","goo/renderer/pass/Pass"],function(e,t,n,r,i,s,o){function u(n){n=n||{},this.target=n.target!==undefined?n.target:null;var o=n.strength!==undefined?n.strength:0,a=n.sigma!==undefined?n.sigma:4,f=2*Math.ceil(a*3)+1;this.downsampleAmount=n.downsampleAmount!==undefined?Math.max(n.downsampleAmount,1):4;var l=window.innerWidth||1024,c=window.innerHeight||1024;this.updateSize({x:0,y:0,width:l,height:c}),this.renderable={meshData:t.quad,materials:[]},this.copyMaterial=new e(i.copyPure),this.copyMaterial.uniforms.opacity=o,this.copyMaterial.blendState.blending="AdditiveBlending",this.convolutionShader=r.deepClone(i.convolution),this.convolutionShader.defines={KERNEL_SIZE_FLOAT:f.toFixed(1),KERNEL_SIZE_INT:f.toFixed(0)},this.convolutionMaterial=new e(this.convolutionShader),this.convolutionMaterial.uniforms.uImageIncrement=u.blurX,this.convolutionMaterial.uniforms.cKernel=this.convolutionShader.buildKernel(a),this.bcMaterial=new e(s.brightnesscontrast),this.bcMaterial.uniforms.brightness=0,this.bcMaterial.uniforms.contrast=0,this.enabled=!0,this.clear=!1,this.needsSwap=!1}return u.prototype=Object.create(o.prototype),u.prototype.constructor=u,u.prototype.destroy=function(e){this.renderTargetX&&this.renderTargetX.destroy(e.context),this.renderTargetY&&this.renderTargetY.destroy(e.context),this.convolutionMaterial.shader.destroy(),this.copyMaterial.shader.destroy(),this.bcMaterial.shader.destroy()},u.prototype.invalidateHandles=function(e){e.invalidateMaterial(this.convolutionMaterial),e.invalidateMaterial(this.copyMaterial),e.invalidateMaterial(this.convolutionMaterial),e.invalidateMaterial(this.bcMaterial),e.invalidateRenderTarget(this.renderTargetX),e.invalidateRenderTarget(this.renderTargetY),e.invalidateMeshData(this.renderable.meshData)},u.prototype.updateSize=function(e,t){var r=e.width/this.downsampleAmount,i=e.height/this.downsampleAmount;this.renderTargetX&&this.renderTargetX.destroy(t.context),this.renderTargetY&&this.renderTargetY.destroy(t.context),this.renderTargetX=new n(r,i),this.renderTargetY=new n(r,i)},u.prototype.render=function(e,n,r){this.renderable.materials[0]=this.bcMaterial,this.bcMaterial.setTexture("DIFFUSE_MAP",r),e.render(this.renderable,t.camera,[],this.renderTargetY,!0),this.renderable.materials[0]=this.convolutionMaterial,this.convolutionMaterial.setTexture("DIFFUSE_MAP",this.renderTargetY),this.convolutionMaterial.uniforms.uImageIncrement=u.blurY,e.render(this.renderable,t.camera,[],this.renderTargetX,!0),this.convolutionMaterial.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionMaterial.uniforms.uImageIncrement=u.blurX,e.render(this.renderable,t.camera,[],this.renderTargetY,!0),this.renderable.materials[0]=this.copyMaterial,this.copyMaterial.setTexture("DIFFUSE_MAP",this.renderTargetY),this.target!==null?e.render(this.renderable,t.camera,[],this.target,this.clear):e.render(this.renderable,t.camera,[],r,this.clear)},u.blurX=[.001953125,0],u.blurY=[0,.001953125],u}),define("goo/passpack/BlurPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/util/ObjectUtil","goo/renderer/shaders/ShaderLib","goo/renderer/pass/Pass"],function(e,t,n,r,i,s){function o(n){n=n||{},this.target=n.target!==undefined?n.target:null;var s=n.strength!==undefined?n.strength:1,o=n.sigma!==undefined?n.sigma:4,u=2*Math.ceil(o*3)+1;this.downsampleAmount=n.downsampleAmount!==undefined?Math.max(n.downsampleAmount,1):4,this.blurX=[.001953125,0],this.blurY=[0,.001953125];var a=window.innerWidth||1024,f=window.innerHeight||1024;this.updateSize({x:0,y:0,width:a,height:f}),this.renderable={meshData:t.quad,materials:[]},this.copyMaterial=new e(i.copyPure),this.copyMaterial.uniforms.opacity=s,this.copyMaterial.blendState.blending="CustomBlending",this.convolutionShader=r.deepClone(i.convolution),this.convolutionShader.defines={KERNEL_SIZE_FLOAT:u.toFixed(1),KERNEL_SIZE_INT:u.toFixed(0)},this.convolutionShader.uniforms.uImageIncrement=this.blurX,this.convolutionShader.uniforms.cKernel=this.convolutionShader.buildKernel(o),this.convolutionMaterial=new e(this.convolutionShader),this.enabled=!0,this.clear=!1,this.needsSwap=!1}return o.prototype=Object.create(s.prototype),o.prototype.constructor=o,o.prototype.destroy=function(e){this.renderTargetX&&this.renderTargetX.destroy(e.context),this.renderTargetY&&this.renderTargetY.destroy(e.context),this.convolutionMaterial.shader.destroy(),this.copyMaterial.shader.destroy()},o.prototype.invalidateHandles=function(e){e.invalidateMaterial(this.convolutionMaterial),e.invalidateMaterial(this.copyMaterial),e.invalidateRenderTarget(this.renderTargetX),e.invalidateRenderTarget(this.renderTargetY),e.invalidateMeshData(this.renderable.meshData)},o.prototype.updateSize=function(e,t){var r=e.width/this.downsampleAmount,i=e.height/this.downsampleAmount;this.renderTargetX&&t._deallocateRenderTarget(this.renderTargetX),this.renderTargetY&&t._deallocateRenderTarget(this.renderTargetY),this.renderTargetX=new n(r,i),this.renderTargetY=new n(r,i)},o.prototype.render=function(e,n,r){this.renderable.materials[0]=this.convolutionMaterial,this.convolutionMaterial.setTexture("DIFFUSE_MAP",r),this.convolutionMaterial.uniforms.uImageIncrement=this.blurY,e.render(this.renderable,t.camera,[],this.renderTargetX,!0),this.convolutionMaterial.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionMaterial.uniforms.uImageIncrement=this.blurX,e.render(this.renderable,t.camera,[],this.renderTargetY,!0),this.renderable.materials[0]=this.copyMaterial,this.copyMaterial.setTexture("DIFFUSE_MAP",this.renderTargetY),this.target!==null?e.render(this.renderable,t.camera,[],this.target,this.clear):e.render(this.renderable,t.camera,[],r,this.clear)},o}),define("goo/passpack/DoGPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/util/ObjectUtil","goo/renderer/shaders/ShaderLib","goo/passpack/ShaderLibExtra","goo/renderer/pass/Pass"],function(e,t,n,r,i,s,o){function u(n){n=n||{},this.target=n.target!==undefined?n.target:null;var o=n.width!==undefined?n.width:1024,u=n.height!==undefined?n.height:1024,a=n.sigma!==undefined?n.sigma:.6,f=n.threshold!==undefined?n.threshold:.005;this.downsampleAmount=n.downsampleAmount!==undefined?Math.max(n.downsampleAmount,1):2,a>2.5&&(a=2.5),this.updateSize({width:o,height:u}),this.renderable={meshData:t.quad,materials:[]},this.convolutionShader1=r.deepClone(i.convolution),this.convolutionShader2=r.deepClone(i.convolution),this.differenceShader=r.deepClone(s.differenceOfGaussians),this.differenceShader.uniforms.threshold=f,this.differenceMaterial=new e(this.differenceShader),this.updateSigma(a),this.enabled=!0,this.clear=!1,this.needsSwap=!0}return u.prototype=Object.create(o.prototype),u.prototype.constructor=u,u.prototype.destroy=function(e){var t=e.context;this.convolutionMaterial1&&this.convolutionMaterial1.shader.destroy(),this.convolutionMaterial2&&this.convolutionMaterial2.shader.destroy(),this.differenceMaterial.shader.destroy(),this.gaussian1&&this.gaussian1.destroy(t),this.gaussian2&&this.gaussian2.destroy(t),this.renderTargetX&&this.renderTargetX.destroy(t),this.target&&this.target.destroy(t)},u.prototype.updateThreshold=function(e){this.differenceMaterial.shader.uniforms.threshold=e},u.prototype.updateEdgeColor=function(e){this.differenceMaterial.shader.uniforms.edgeColor=[e[0],e[1],e[2],1]},u.prototype.updateBackgroundColor=function(e){this.differenceMaterial.shader.uniforms.backgroundColor=[e[0],e[1],e[2],1]},u.prototype.updateBackgroundMix=function(e){this.differenceMaterial.shader.uniforms.backgroundMix=e},u.prototype.updateSize=function(e){var t=e.width/this.downsampleAmount,r=e.height/this.downsampleAmount;this.renderTargetX=new n(t,r),this.gaussian1=new n(t,r),this.gaussian2=new n(t,r),this.blurX=[.5/t,0],this.blurY=[0,.5/r]},u.prototype.updateSigma=function(t){var n=this.convolutionShader1.buildKernel(t),r=this.convolutionShader2.buildKernel(1.6*t),i=n.length;this.convolutionShader1.defines={KERNEL_SIZE_FLOAT:i.toFixed(1),KERNEL_SIZE_INT:i.toFixed(0)},i=r.length,this.convolutionShader2.defines={KERNEL_SIZE_FLOAT:i.toFixed(1),KERNEL_SIZE_INT:i.toFixed(0)},this.convolutionShader1.uniforms.cKernel=n,this.convolutionShader2.uniforms.cKernel=r,this.convolutionMaterial1=new e(this.convolutionShader1),this.convolutionMaterial2=new e(this.convolutionShader2)},u.prototype.render=function(e,n,r){this.renderable.materials[0]=this.convolutionMaterial1,this.convolutionMaterial1.setTexture("DIFFUSE_MAP",r),this.convolutionShader1.uniforms.uImageIncrement=this.blurX,e.render(this.renderable,t.camera,[],this.renderTargetX,!0),this.convolutionMaterial1.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionShader1.uniforms.uImageIncrement=this.blurY,e.render(this.renderable,t.camera,[],this.gaussian1,!0),this.renderable.materials[0]=this.convolutionMaterial2,this.convolutionMaterial2.setTexture("DIFFUSE_MAP",r),this.convolutionShader2.uniforms.uImageIncrement=this.blurX,e.render(this.renderable,t.camera,[],this.renderTargetX,!0),this.convolutionMaterial2.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionShader2.uniforms.uImageIncrement=this.blurY,e.render(this.renderable,t.camera,[],this.gaussian2,!0),this.renderable.materials[0]=this.differenceMaterial,this.differenceMaterial.setTexture("BLUR1",this.gaussian1),this.differenceMaterial.setTexture("BLUR2",this.gaussian2),this.differenceMaterial.setTexture("ORIGINAL",r),this.target!==null?e.render(this.renderable,t.camera,[],this.target,this.clear):e.render(this.renderable,t.camera,[],n,this.clear)},u.prototype.invalidateHandles=function(e){e.invalidateMaterial(this.convolutionMaterial1),e.invalidateMaterial(this.convolutionMaterial2),e.invalidateMaterial(this.differenceMaterial),e.invalidateMeshData(this.renderable.meshData),e.invalidateRenderTarget(this.renderTargetX),e.invalidateRenderTarget(this.gaussian1),e.invalidateRenderTarget(this.gaussian2)},u}),define("goo/passpack/MotionBlurPass",["goo/renderer/Material","goo/renderer/Shader","goo/renderer/shaders/ShaderLib","goo/renderer/pass/FullscreenUtil","goo/renderer/MeshData","goo/renderer/pass/RenderTarget","goo/renderer/pass/FullscreenPass","goo/renderer/pass/Pass"],function(e,t,n,r,i,s,o,u){function a(){this.inPass=new o(f),this.outPass=new o(n.copyPure);var e=window.innerWidth||1024,t=window.innerHeight||1024;this.updateSize({x:0,y:0,width:e,height:t}),this.enabled=!0,this.clear=!1,this.needsSwap=!0}a.prototype=Object.create(u.prototype),a.prototype.constructor=a,a.prototype.destroy=function(e){this.inPass.destroy(e),this.outPass.destroy(e),this.targetSwap&&(this.targetSwap[0].destroy(e.context),this.targetSwap[1].destroy(e.context),this.targetSwap=undefined)},a.prototype.invalidateHandles=function(e){this.inPass.invalidateHandles(e),this.outPass.invalidateHandles(e),e.invalidateRenderTarget(this.targetSwap[0]),e.invalidateRenderTarget(this.targetSwap[1])},a.prototype.updateSize=function(e,t){var n=e.width,r=e.height;if(this.targetSwap)for(var i=0;i<this.targetSwap.length;i++)t._deallocateRenderTarget(this.targetSwap[i]);this.targetSwap=[new s(n,r),new s(n,r)]},a.prototype.render=function(e,t,n){this.inPass.material.setTexture("MOTION_MAP",this.targetSwap[1]),this.inPass.render(e,this.targetSwap[0],n),this.outPass.render(e,t,this.targetSwap[0]),this.targetSwap.reverse()};var f={defines:{},processors:[function(e,t){t.material._textureMaps.MOTION_MAP.glTexture?e.setDefine("MOTION_MAP",!0):e.removeDefine("MOTION_MAP")}],attributes:{vertexPosition:i.POSITION,vertexUV0:i.TEXCOORD0},uniforms:{viewProjectionMatrix:t.VIEW_PROJECTION_MATRIX,worldMatrix:t.WORLD_MATRIX,blend:.9,scale:1,diffuseMap:t.DIFFUSE_MAP,motionMap:"MOTION_MAP"},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform sampler2D motionMap;","uniform float blend;","uniform float scale;","varying vec2 texCoord0;","void main(void)","{","vec4 colA = texture2D(diffuseMap, texCoord0);","#ifdef MOTION_MAP","vec4 colB = texture2D(motionMap, (texCoord0 - 0.5) / scale + 0.5);","float wBlend = blend;// * length(colB) / sqrt(3.0);","gl_FragColor = mix(colA, colB, wBlend);","#else","gl_FragColor = colA;","#endif","}"].join("\n")};return a}),define("goo/passpack/PassLib",["goo/passpack/ShaderLibExtra","goo/renderer/pass/FullscreenPass","goo/passpack/BloomPass","goo/passpack/BlurPass","goo/passpack/DoGPass","goo/passpack/MotionBlurPass","goo/util/ObjectUtil"],function(e,t,n,r,i,s,o){function u(e){n.call(this),this.id=e}function a(e){i.call(this,arguments),this.id=e}function f(e){r.call(this,arguments),this.id=e}function l(n){t.call(this,o.deepClone(e.vignette)),this.id=n}function c(n){t.call(this,o.deepClone(e.sepia)),this.id=n}function h(n){t.call(this,o.deepClone(e.film)),this.id=n}function p(n){t.call(this,o.deepClone(e.noise)),this.id=n}function d(n){t.call(this,o.deepClone(e.rgbshift)),this.id=n}function v(n){t.call(this,o.deepClone(e.bleachbypass)),this.id=n}function m(n){t.call(this,o.deepClone(e.hsb)),this.id=n}function g(n){t.call(this,o.deepClone(e.colorify)),this.id=n}function y(n){t.call(this,o.deepClone(e.hatch)),this.id=n}function b(n){t.call(this,o.deepClone(e.dotscreen)),this.id=n}function w(n){t.call(this,o.deepClone(e.brightnesscontrast)),this.id=n}function E(e){s.call(this),this.id=e}function S(n){t.call(this,o.deepClone(e.antialias)),this.id=n}function x(n){t.call(this,o.deepClone(e.radial)),this.id=n}function T(n){t.call(this,o.deepClone(e.overlay)),this.id=n}function N(n){t.call(this,o.deepClone(e.levels)),this.id=n}return u.prototype=Object.create(n.prototype),u.prototype.constructor=u,u.prototype.update=function(e){var t=e.options||{};t.opacity!==undefined&&(this.copyMaterial.uniforms.opacity=t.opacity/100),t.size!==undefined&&(this.convolutionMaterial.uniforms.size=t.size),t.brightness!==undefined&&(this.bcMaterial.uniforms.brightness=t.brightness/100),t.contrast!==undefined&&(this.bcMaterial.uniforms.contrast=t.contrast/100),e.enabled!==undefined&&(this.enabled=e.enabled)},u.label="Bloom",u.options=[{key:"opacity",name:"Opacity",type:"int",control:"slider",min:0,max:100,"default":100},{key:"size",name:"Size",type:"float",control:"slider",min:0,max:10,decimals:1,"default":2},{key:"brightness",name:"Gain",type:"int",control:"slider",min:-100,max:100,"default":0},{key:"contrast",name:"Intensity",type:"int",control:"slider",min:-100,max:100,"default":0}],a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.prototype.update=function(e){var t=e.options||{};e.enabled!==undefined&&(this.enabled=e.enabled),t.sigma!==undefined&&this.updateSigma(t.sigma),t.threshold!==undefined&&this.updateThreshold(t.threshold),t.edgeColor!==undefined&&this.updateEdgeColor(t.edgeColor),t.backgroundColor!==undefined&&this.updateBackgroundColor(t.backgroundColor),t.backgroundMix!==undefined&&this.updateBackgroundMix(t.backgroundMix)},a.label="Edge detect",a.options=[{key:"sigma",name:"Gauss Sigma",type:"float",control:"slider",min:.01,max:1.7,decimals:2,"default":.6},{key:"threshold",name:"Threshold",type:"float",control:"slider",min:1e-14,max:.11,decimals:20,"default":.005},{key:"backgroundMix",name:"Background %",type:"float",control:"slider",min:0,max:1,decimals:2,"default":0},{key:"edgeColor",name:"Edge Color",type:"vec3",control:"color","default":[0,1,0]},{key:"backgroundColor",name:"Background Color",type:"vec3",control:"color","default":[0,0,0]}],f.prototype=Object.create(r.prototype),f.prototype.constructor=f,f.prototype.update=function(e){var t=e.options||{};t.opacity!==undefined&&(this.copyMaterial.uniforms.opacity=t.opacity/100),t.size!==undefined&&(this.blurX=[.001953125*t.size,0],this.blurY=[0,.001953125*t.size]),e.enabled!==undefined&&(this.enabled=e.enabled)},f.label="Blur",f.options=[{key:"opacity",name:"Amount",type:"int",control:"slider",min:0,max:100,"default":100},{key:"size",name:"Size",type:"float",control:"slider",min:0,max:5,decimals:1,"default":1}],l.prototype=Object.create(t.prototype),l.prototype.construcor=l,l.prototype.update=function(e){var t=e.options,n=this.material.shader;t.offset!==undefined&&(n.uniforms.offset=t.offset),t.darkness!==undefined&&(n.uniforms.darkness=t.darkness),e.enabled!==undefined&&(this.enabled=e.enabled)},l.label="Vignette",l.options=[{key:"offset",type:"float",control:"slider",name:"Offset",min:0,max:10,decimals:1,"default":1},{key:"darkness",type:"float",control:"slider",name:"Darkness",min:0,max:2,decimals:2,"default":1.5}],c.prototype=Object.create(t.prototype),c.prototype.constructor=c,c.prototype.update=function(e){var t=e.options;t.amount!==undefined&&(this.material.uniforms.amount=t.amount/100),e.enabled!==undefined&&(this.enabled=e.enabled)},c.label="Sepia",c.options=[{key:"amount",name:"Amount",type:"int",control:"slider",min:0,max:100,"default":100}],h.prototype=Object.create(t.prototype),h.prototype.constructor=h,h.prototype.update=function(e){var t=e.options,n=this.material.shader;t.nIntensity!==undefined&&(n.uniforms.nIntensity=t.nIntensity/100),t.sIntensity!==undefined&&(n.uniforms.sIntensity=t.sIntensity/100),t.sCount!==undefined&&(n.uniforms.sCount=t.sCount),e.enabled!==undefined&&(this.enabled=e.enabled)},h.label="Film Grain",h.options=[{key:"nIntensity",type:"int",control:"slider",name:"Noise",min:0,max:100,"default":50},{key:"sIntensity",type:"int",control:"slider",name:"Line Intensity",min:0,max:100,"default":50},{key:"sCount",type:"int",control:"slider",name:"Line Count",min:1,max:4096,"default":1024}],p.prototype=Object.create(t.prototype),p.prototype.constructor=p,p.prototype.update=function(e){var t=e.options,n=this.material.shader;t.nIntensity!==undefined&&(n.uniforms.nIntensity=t.nIntensity/100),e.enabled!==undefined&&(this.enabled=e.enabled)},p.label="Noise",p.options=[{key:"nIntensity",type:"int",control:"slider",name:"Noise",min:0,max:100,"default":50}],d.prototype=Object.create(t.prototype),d.prototype.constructor=d,d.prototype.update=function(e){var t=e.options,n=this.material.shader;t.amount!==undefined&&(n.uniforms.amount=t.amount),t.angle!==undefined&&(n.uniforms.angle=t.angle),e.enabled!==undefined&&(this.enabled=e.enabled)},d.label="RgbShift",d.options=[{key:"amount",type:"float",control:"slider",name:"Amount",min:0,max:.05,decimals:3,"default":.005},{key:"angle",type:"float",control:"slider",name:"Angle",min:0,max:6.28,decimals:1,"default":0}],v.prototype=Object.create(t.prototype),v.prototype.constructor=v,v.prototype.update=function(e){var t=e.options,n=this.material.shader;t.opacity!==undefined&&(n.uniforms.opacity=t.opacity),e.enabled!==undefined&&(this.enabled=e.enabled)},v.label="Bleach",v.options=[{key:"opacity",type:"float",control:"slider",name:"Opacity",min:0,max:1,decimals:2,"default":1}],m.prototype=Object.create(t.prototype),m.prototype.constructor=m,m.prototype.update=function(e){var t=e.options,n=this.material.shader;t.hue!==undefined&&(n.uniforms.hue=t.hue),t.saturation!==undefined&&(n.uniforms.saturation=t.saturation),t.brightness!==undefined&&(n.uniforms.brightness=t.brightness),e.enabled!==undefined&&(this.enabled=e.enabled)},m.label="HSB",m.options=[{key:"hue",type:"float",control:"slider",name:"Hue",min:-1,max:1,decimals:2,"default":0},{key:"saturation",type:"float",control:"slider",name:"Saturation",min:-1,max:1,decimals:2,"default":0},{key:"brightness",type:"float",control:"slider",name:"Brightness",min:-1,max:1,decimals:2,"default":0}],g.prototype=Object.create(t.prototype),g.prototype.constructor=g,g.prototype.update=function(e){var t=e.options,n=this.material.shader;t.color!==undefined&&(n.uniforms.color=t.color),t.amount!==undefined&&(n.uniforms.amount=t.amount),e.enabled!==undefined&&(this.enabled=e.enabled)},g.label="Tint",g.options=[{key:"color",type:"vec3",control:"color",name:"Color","default":[1,1,1]},{key:"amount",type:"float",control:"slider",name:"Amount",min:0,max:1,decimals:2,"default":1}],y.prototype=Object.create(t.prototype),y.prototype.constructor=y,y.prototype.update=function(e){var t=e.options,n=this.material.shader;t.width!==undefined&&(n.uniforms.width=t.width),t.spread!==undefined&&(n.uniforms.spread=t.spread),e.enabled!==undefined&&(this.enabled=e.enabled)},y.label="Hatch",y.options=[{key:"width",type:"float",control:"slider",name:"Width",min:0,max:10,decimals:1,"default":2},{key:"spread",type:"int",control:"slider",name:"Spread",min:1,max:50,"default":8}],b.prototype=Object.create(t.prototype),b.prototype.constructor=b,b.prototype.update=function(e){var t=e.options,n=this.material.shader;t.angle!==undefined&&(n.uniforms.angle=t.angle),t.scale!==undefined&&(n.uniforms.scale=t.scale),t.sizex!==undefined&&(n.uniforms.tSize[0]=t.sizex),t.sizey!==undefined&&(n.uniforms.tSize[1]=t.sizey),e.enabled!==undefined&&(this.enabled=e.enabled)},b.label="Dot",b.options=[{key:"angle",type:"float",control:"slider",name:"Angle",min:0,max:10,decimals:2,"default":1.57},{key:"scale",type:"float",control:"slider",name:"Scale",min:0,max:10,decimals:2,"default":1},{key:"sizex",type:"int",control:"slider",name:"SizeX",min:0,max:1024,"default":256},{key:"sizey",type:"int",control:"slider",name:"SizeY",min:0,max:1024,"default":256}],w.prototype=Object.create(t.prototype),w.prototype.constructor=w,w.prototype.update=function(e){var t=e.options,n=this.material.shader;t.brightness!==undefined&&(n.uniforms.brightness=t.brightness),t.contrast!==undefined&&(n.uniforms.contrast=t.contrast),t.saturation!==undefined&&(n.uniforms.saturation=t.saturation),e.enabled!==undefined&&(this.enabled=e.enabled)},w.label="Contrast",w.options=[{key:"brightness",type:"float",control:"slider",name:"Brightness",min:-1,max:1,decimals:2,"default":0},{key:"contrast",type:"float",control:"slider",name:"Contrast",min:0,max:1,"default":0},{key:"saturation",type:"float",control:"slider",name:"Saturation",min:-1,max:1,decimals:2,"default":0}],E.prototype=Object.create(s.prototype),E.prototype.constructor=E,E.prototype.update=function(e){var t=e.options,n=this.inPass.material.shader;t.blend!==undefined&&(n.uniforms.blend=t.blend),t.scale!==undefined&&(n.uniforms.scale=t.scale),e.enabled!==undefined&&(this.enabled=e.enabled)},E.label="Motion Blur",E.options=[{key:"blend",type:"float",control:"slider",name:"Amount",min:0,max:1,"default":.5},{key:"scale",type:"float",name:"Scale",min:.2,"default":1,scale:.01}],S.prototype=Object.create(t.prototype),S.prototype.constructor=S,S.prototype.update=function(e){var t=e.options,n=this.material.shader;t.span!==undefined&&(n.uniforms.FXAA_SPAN_MAX=t.span,n.uniforms.FXAA_REDUCE_MUL=1/t.span),e.enabled!==undefined&&(this.enabled=e.enabled)},S.label="Antialias",S.options=[{key:"span",type:"int",control:"slider",name:"Span",min:0,max:16,"default":8}],x.prototype=Object.create(t.prototype),x.prototype.constructor=x,x.prototype.update=function(e){var t=e.options,n=this.material.shader;t.offset!==undefined&&(n.uniforms.offset=t.offset),t.multiplier!==undefined&&(n.uniforms.multiplier=t.multiplier),e.enabled!==undefined&&(this.enabled=e.enabled)},x.label="Radial",x.options=[{key:"offset",type:"float",control:"slider",name:"Offset",min:-1,max:1,decimals:2,"default":-0.5},{key:"multiplier",type:"float",control:"slider",name:"Multiplier",min:-1,max:1,decimals:2,"default":.75}],T.prototype=Object.create(t.prototype),T.prototype.constructor=T,T.blendmodes=["Normal","Lighten","Darken","Multiply","Average","Add","Substract","Difference","Negation","Exclusion","Screen","Overlay","SoftLight","HardLight","ColorDodge","ColorBurn","LinearLight","VividLight","PinLight","HardMix","Reflect","Glow","Phoenix"],T.prototype.update=function(e){var t=e.options,n=this.material.shader;if(t.blendmode!==undefined){var r=T.blendmodes.indexOf(t.blendmode);r!==n.defines.OVERLAY_TYPE&&(n.setDefine("OVERLAY_TYPE",r),n.uniforms.amount=t.amount-.01)}t.amount!==undefined&&(n.uniforms.amount=t.amount),t.url!=null?this.material.setTexture("OVERLAY_MAP",t.url):this.material.removeTexture("OVERLAY_MAP"),e.enabled!==undefined&&(this.enabled=e.enabled)},T.label="Overlay",T.options=[{key:"url",name:"Texture",type:"texture","default":{enabled:!0}},{key:"blendmode",name:"Blend Mode",type:"string",control:"select",options:T.blendmodes,"default":"Normal"},{key:"amount",name:"Amount",type:"float",control:"slider",min:0,max:1,decimals:2,"default":1}],N.prototype=Object.create(t.prototype),N.prototype.constructor=N,N.prototype.update=function(e){var t=e.options,n=this.material.shader;t.gamma!==undefined&&(n.uniforms.gamma=t.gamma),t.gamma!==undefined&&(n.uniforms.gamma=t.gamma),t.minInput!==undefined&&(n.uniforms.minInput=t.minInput),t.maxInput!==undefined&&(n.uniforms.maxInput=t.maxInput),t.minOutput!==undefined&&(n.uniforms.minOutput=t.minOutput),t.maxOutput!==undefined&&(n.uniforms.maxOutput=t.maxOutput),e.enabled!==undefined&&(this.enabled=e.enabled)},N.label="Levels",N.options=[{key:"gamma",type:"float",control:"slider",name:"Gamma",min:0,max:5,decimals:2,"default":1},{key:"minInput",type:"float",control:"slider",name:"Min Input",min:0,max:1,decimals:2,"default":0},{key:"maxInput",type:"float",control:"slider",name:"Max Input",min:0,max:1,decimals:2,"default":1},{key:"minOutput",type:"float",control:"slider",name:"Min Output",min:0,max:1,decimals:2,"default":0},{key:"maxOutput",type:"float",control:"slider",name:"Max Output",min:0,max:1,decimals:2,"default":1}],{Bloom:u,Blur:f,Vignette:l,Sepia:c,Grain:h,Noise:p,RgbShift:d,Bleach:v,HSB:m,Colorify:g,Hatch:y,Dot:b,Contrast:w,DiffOfGaussians:a,MotionBlur:E,Antialias:S,Radial:x,Overlay:T,Levels:N}}),define("goo/passpack/PosteffectsHandler",["goo/loaders/handlers/ConfigHandler","goo/util/ArrayUtil","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/renderer/pass/Composer","goo/renderer/pass/RenderPass","goo/renderer/pass/FullscreenPass","goo/renderer/shaders/ShaderLib","goo/passpack/PassLib"],function(e,t,n,r,i,s,o,u,a,f){function l(){e.apply(this,arguments),this._composer=new s;var t=this.world.getSystem("RenderSystem");this._renderPass=new o(t.renderList),this._outPass=new u(i.deepClone(a.copy)),this._outPass.renderToScreen=!0}return l.prototype=Object.create(e.prototype),l.prototype.constructor=l,e._registerClass("posteffects",l),l.prototype._remove=function(e){var n=this.world.getSystem("RenderSystem");t.remove(n.composers,this._composer),this._objects.delete(e),this.world&&this._composer.destroy(this.world.gooRunner.renderer),this._composer=new s},l.prototype._create=function(){return[]},l.prototype._update=function(r,s,o){var u=this;return e.prototype._update.call(this,r,s,o).then(function(e){if(!e)return;var t=e.slice(),r=[];return i.forEach(s.posteffects,function(e){r.push(u._updateEffect(e,t,o))},null,"sortValue"),n.all(r).then(function(t){for(var n=0;n<t.length;n++)e[n]=t[n];return e.length=n,e})}).then(function(e){if(!e)return;var n=e.some(function(e){return e.enabled}),r=u.world.getSystem("RenderSystem"),i=u._composer;if(n){i.passes=[],i.addPass(u._renderPass);for(var s=0;s<e.length;s++){var o=e[s];o&&o.enabled&&i.addPass(e[s],u.world.gooRunner.renderer)}i.addPass(u._outPass),r.composers.indexOf(i)===-1&&r.composers.push(i)}else t.remove(r.composers,u._composer);return e})},l.prototype._updateEffect=function(e,t,r){function s(t,n){return i._load(n,r).then(function(n){e.options[t]=n})}var i=this,o;for(var u=0;u<t.length;u++)if(t[u].id===e.id){o=t[u];break}if(!o){if(!f[e.type])return null;o=new f[e.type](e.id)}var a=[];for(var u=0;u<f[e.type].options.length;u++){var l=f[e.type].options[u],c=l.key,h=l.type;h==="texture"?e.options[c]&&e.options[c].textureRef&&e.options[c].enabled?a.push(s(c,e.options[c].textureRef)):e.options[c]=null:h==="entity"&&(e.options[c]&&e.options[c].entityRef&&e.options[c].enabled?a.push(s(c,e.options[c].entityRef)):e.options[c]=null)}return n.all(a).then(function(){return o.update(e),o})},l}),"use strict",define("3d/GooController",["application/Settings","application/EventManager","goo/animationpack/systems/AnimationSystem","3d/GooCameraController","3d/GooEntityFactory","3d/GooEffectController","goo/entities/components/ScriptComponent","goo/entities/GooRunner","goo/renderer/Renderer","goo/math/Vector3","goo/animationpack/handlers/SkeletonHandler","goo/animationpack/handlers/AnimationComponentHandler","goo/animationpack/handlers/AnimationStateHandler","goo/animationpack/handlers/AnimationLayersHandler","goo/animationpack/handlers/AnimationClipHandler","goo/passpack/PosteffectsHandler","goo/renderer/Texture","goo/math/Vector"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=function(){this.gooCameraController=new r};h.prototype.setupGooRunner=function(){var r=new u({showStats:!1,debug:!1,manuallyStartGameLoop:!0,tpfSmoothingCount:1,useTryCatch:!1}),i=function(e){console.log("Adjust Px Scale: ",e),r.renderer.downScale=e};e.getSetting("display_pixel_scale").addOnChangeCallback(i),this.goo=r,r.renderer.setClearColor(0,.1,.2,1),r.world.world_root=r.world.createEntity("world_root"),r.world.add(new n),r.world.world_root.addToWorld(),r.world.world_root.spatial={pos:new f};var s=function(){console.log("Setup Goo Scene"),document.getElementById("game_window").appendChild(r.renderer.domElement),setTimeout(function(){t.fireEvent(t.list().ENINGE_READY,{goo:r})},30)},o=function(){};t.registerListener(t.list().LOAD_3D,s),t.registerListener(t.list().UN_LOAD_3D,o)},h.prototype.updateWorld=function(e){this.gooCameraController.updateCamera()},h.prototype.registerGooUpdateCallback=function(e){this.goo.callbacksPreRender.push(e)},h.prototype.propagateGoo=function(){i.setGoo(this.goo),s.setGoo(this.goo)};var p=function(){var e=c.prototype;c=function(e){this.data=new Float64Array(e)};var t=0,n=0,t=window.innerWidth,n=window.innerHeight,r=function(){t=window.innerWidth,n=window.innerHeight};window.addEventListener("resize",r),a.prototype.checkResize=function(e){var r=this.devicePixelRatio=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,i=t*r/this.downScale,s=n*r/this.downScale,o=i,u=s;e&&e.lockedRatio===!0&&e.aspect&&(i=s*e.aspect);var a=i/s;this.setSize(i,s,o,u),e&&e.lockedRatio===!1&&e.aspect!==a&&(e.aspect=a,e.projectionMode===0?e.setFrustumPerspective():e.setFrustum(),e.onFrameChange())}};return p(),h});var gameUtil;require.config({paths:{goo:"../../../../../../../projects/goojs/src/goo","goo/lib":"../lib",data_pipeline:"submodules/data_pipeline/src",particle_system:"submodules/particles_2/src",environment:"submodules/environment/src",terrain:"submodules/terrain/src",gui:"submodules/canvas_gui_3d/src"}}),require(["application/AnalyticsWrapper","application/Client","3d/GooController"],function(e,t,n){var r=new t;r.initiateClient(new n)}),define("Main",function(){});